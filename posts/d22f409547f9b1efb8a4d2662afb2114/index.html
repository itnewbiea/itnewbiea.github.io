<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>图形学基础|各项异性与头发渲染 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="图形学基础|各项异性与头发渲染" />
<meta property="og:description" content="图形学基础|各项异性与头发渲染 文章目录 图形学基础|各项异性与头发渲染一、前言二、各向异性光照2.1 各向异性光照现象2.2 ShadingModel扩展 三、头发光照模型3.1 Kajiya-Kay Model3.1.1 Strand based Anisotropy3.1.2 Kajiya-Kay经验模型3.1.3 基于Kajiya-Kay的卡通头发 3.2 Marschner Model3.2.1 着色模型公式3.2.2 UE头发材质和着色器代码 四、头发建模和制作技巧4.1 头发模型建模4.2 头发贴图4.3 毛发渲染的排序问题 参考博文 一、前言 在 虚幻引擎之自定义着色模型（ShadingModel） 中，笔者简要地提到了Hair（毛发）光照模型，但是并没有做深入一点的介绍和源码的阅读。
同时与头发材质渲染经常一起提到的就是各向异性（Anisotropy），这又是什么样的概念呢？
在本篇博客中，将对各向异性和头发渲染进行介绍。
二、各向异性光照 2.1 各向异性光照现象 在渲染头发、丝绸等材质时，常要用到各向异性高光（Anisotropic highlighting）。
那么，什么是各向异性高光呢？先来看个直观的对比。
下图左：各向同性金属球；右：各向异性金属球。 可以看到：
左侧各向同性（isotropic）金属球的高光，呈现为一个圆形亮光斑，比较集中；右侧各向异性（Anisotropic）金属球的高光，呈环形，在头发渲染中又称为”天使环“； 各向异性（Anisotropic）指的是在不同方向上表现出的光照效果会产生差异。
右侧的金属表面反射的高光效果和使用 BlinnPhong （或者类似算法）得到的高光效果有着明显的差异。
这可能是由于加工工艺导致的，表面并不是抛光的（一个完全被抛光的物体表面是光学平面），因此形成了大量细小沟槽。
这样类型的凹槽造成了各向异性的光照效果。由于凹槽没有小到可以被光线忽略，所以当光线到达物体表面的时候没有办法直接反射出去，而是射入了凹槽中，在凹槽内部经过多次反射，最终才反射出来。
现实生活中还有很多物体表面会产生各向异性的光照效果，比如丝绸织物， 头发，CD表面等。
在渲染中来实现各向异性光照时，我们需要在像素着色器中，根据法线扰动规则重新计算法线，这样虽然是一个平面，但它上面的像素却会因为法线扰动而形成一些纹理、凹槽的效果，从而展示出更多的细节表现，而且法线的扰动通常是有规律的，所以在不同的方向上表现出的效果可能会不一样，从而表现出所谓的光学各向异性。
2.2 ShadingModel扩展 将各向同性的shading model拓展到各向异性，需要解决两个问题：
需要引入哪些新的参数来描述各向异性？需要在原有BRDF模型的基础上修改公式的哪些部分来描述各向异性？ 对于问题1：
既然是各向异性，必须要分别定义各个方向上的差异属性，这里的属性一般是粗糙度（Roughness）。
方向一般在切平面上选取两个轴，即tangent方向和bitangent方向，他们与normal共同构成了一组正交基底（TBN坐标系）。
对于需要精细控制切平面方向的模型，比如头发，会单独提供切向贴图，指明切向方向，类似于法向贴图。其他情况一般由系统（shader）确定切向方向。
通过增加额外的一个参数，将原有的粗糙度替换成为tangent和bitangent方向的粗糙度，记作 α t , α b \alpha_{t},\alpha_{b} αt​,αb​或 α x , α y \alpha_{x},\alpha_{y} αx​,αy​。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/d22f409547f9b1efb8a4d2662afb2114/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-06-22T21:04:46+08:00" />
<meta property="article:modified_time" content="2021-06-22T21:04:46+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">图形学基础|各项异性与头发渲染</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-github-gist">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>图形学基础|各项异性与头发渲染</h2> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_0" rel="nofollow">图形学基础|各项异性与头发渲染</a></li><li><ul><li><a href="#_3" rel="nofollow">一、前言</a></li><li><a href="#_13" rel="nofollow">二、各向异性光照</a></li><li><ul><li><a href="#21__15" rel="nofollow">2.1 各向异性光照现象</a></li><li><a href="#22_ShadingModel_46" rel="nofollow">2.2 ShadingModel扩展</a></li></ul> 
   </li><li><a href="#_232" rel="nofollow">三、头发光照模型</a></li><li><ul><li><a href="#31_KajiyaKay_Model_248" rel="nofollow">3.1 Kajiya-Kay Model</a></li><li><ul><li><a href="#311_Strand_based_Anisotropy_260" rel="nofollow">3.1.1 Strand based Anisotropy</a></li><li><a href="#312_KajiyaKay_323" rel="nofollow">3.1.2 Kajiya-Kay经验模型</a></li><li><a href="#313_KajiyaKay_476" rel="nofollow">3.1.3 基于Kajiya-Kay的卡通头发</a></li></ul> 
    </li><li><a href="#32_Marschner_Model_518" rel="nofollow">3.2 Marschner Model</a></li><li><ul><li><a href="#321__544" rel="nofollow">3.2.1 着色模型公式</a></li><li><a href="#322_UE_595" rel="nofollow">3.2.2 UE头发材质和着色器代码</a></li></ul> 
   </li></ul> 
   </li><li><a href="#_787" rel="nofollow">四、头发建模和制作技巧</a></li><li><ul><li><a href="#41__795" rel="nofollow">4.1 头发模型建模</a></li><li><a href="#42__820" rel="nofollow">4.2 头发贴图</a></li><li><a href="#43__833" rel="nofollow">4.3 毛发渲染的排序问题</a></li></ul> 
   </li><li><a href="#_877" rel="nofollow">参考博文</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="_3"></a>一、前言</h3> 
<p>在 <a href="https://blog.csdn.net/qjh5606/article/details/117998757?spm=1001.2014.3001.5501">虚幻引擎之自定义着色模型（ShadingModel）</a> 中，笔者简要地提到了Hair（毛发）光照模型，但是并没有做深入一点的介绍和源码的阅读。</p> 
<p>同时与头发材质渲染经常一起提到的就是各向异性（Anisotropy），这又是什么样的概念呢？</p> 
<p>在本篇博客中，将对各向异性和头发渲染进行介绍。</p> 
<h3><a id="_13"></a>二、各向异性光照</h3> 
<h4><a id="21__15"></a>2.1 各向异性光照现象</h4> 
<p>在渲染头发、丝绸等材质时，常要用到各向异性高光（Anisotropic highlighting）。</p> 
<p>那么，什么是各向异性高光呢？先来看个直观的对比。</p> 
<ul><li>下图左：各向同性金属球；右：各向异性金属球。</li></ul> 
<p><img src="https://images2.imgbox.com/4a/51/4MoxmQqj_o.png" alt="在这里插入图片描述"></p> 
<p>可以看到：</p> 
<ul><li>左侧各向同性（isotropic）金属球的高光，呈现为一个圆形亮光斑，比较集中；</li><li>右侧各向异性（Anisotropic）金属球的高光，呈环形，在头发渲染中又称为”天使环“；</li></ul> 
<p>各向异性（Anisotropic）指的是在不同方向上表现出的光照效果会产生差异。</p> 
<p>右侧的金属表面反射的高光效果和使用 BlinnPhong （或者类似算法）得到的高光效果有着明显的差异。</p> 
<p>这可能是由于加工工艺导致的，表面并不是抛光的（一个完全被抛光的物体表面是光学平面），因此形成了大量细小沟槽。</p> 
<p>这样类型的凹槽造成了各向异性的光照效果。由于凹槽没有小到可以被光线忽略，所以当光线到达物体表面的时候没有办法直接反射出去，而是射入了凹槽中，在凹槽内部经过多次反射，最终才反射出来。</p> 
<p>现实生活中还有很多物体表面会产生各向异性的光照效果，比如丝绸织物， 头发，CD表面等。</p> 
<p><img src="https://images2.imgbox.com/de/7c/jKxJva4i_o.jpg" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/51/3a/HEKjEY0q_o.jpg" alt="在这里插入图片描述"><br> 在渲染中来实现各向异性光照时，我们需要在像素着色器中，根据<strong>法线扰动规则</strong>重新计算法线，这样虽然是一个平面，但它上面的像素却会因为法线扰动而形成一些纹理、凹槽的效果，从而展示出更多的细节表现，而且法线的扰动通常是有规律的，所以在不同的方向上表现出的效果可能会不一样，从而表现出所谓的光学各向异性。</p> 
<h4><a id="22_ShadingModel_46"></a>2.2 ShadingModel扩展</h4> 
<p>将各向同性的shading model拓展到各向异性，需要解决两个问题：</p> 
<ol><li>需要引入哪些新的参数来描述各向异性？</li><li>需要在原有BRDF模型的基础上修改公式的<strong>哪些部分</strong>来描述各向异性？</li></ol> 
<p>对于问题1：</p> 
<p>既然是各向异性，必须要分别<strong>定义各个方向上的差异属性</strong>，这里的属性一般是粗糙度（Roughness）。</p> 
<p>方向一般在切平面上选取两个轴，即tangent方向和bitangent方向，他们与normal共同构成了一组正交基底（TBN坐标系）。</p> 
<blockquote> 
 <p>对于需要精细控制切平面方向的模型，比如头发，会单独提供切向贴图，指明切向方向，类似于法向贴图。其他情况一般由系统（shader）确定切向方向。</p> 
</blockquote> 
<p>通过增加额外的一个参数，将原有的粗糙度替换成为tangent和bitangent方向的粗糙度，记作<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          α 
         
        
          t 
         
        
       
         , 
        
        
        
          α 
         
        
          b 
         
        
       
      
        \alpha_{t},\alpha_{b} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em;"><span class="" style="top: -2.55em; margin-left: -0.0037em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: -0.0037em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">b</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>或<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          α 
         
        
          x 
         
        
       
         , 
        
        
        
          α 
         
        
          y 
         
        
       
      
        \alpha_{x},\alpha_{y} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.716668em; vertical-align: -0.286108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.0037em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.0037em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em;">y</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.286108em;"><span class=""></span></span></span></span></span></span></span></span></span></span>。</p> 
<p>在实际操作中，一般是增加一个<code>anisotropy</code> 各向异性参数，</p> 
<p>然后用粗糙度<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         α 
        
       
      
        \alpha 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.43056em; vertical-align: 0em;"></span><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span></span></span></span></span>（<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         α 
        
       
         = 
        
       
         r 
        
       
         o 
        
       
         u 
        
       
         g 
        
       
         h 
        
       
         n 
        
       
         e 
        
       
         s 
        
       
         s 
        
       
         ∗ 
        
       
         r 
        
       
         o 
        
       
         u 
        
       
         g 
        
       
         h 
        
       
         n 
        
       
         e 
        
       
         s 
        
       
         s 
        
       
      
        \alpha = roughness * roughness 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.43056em; vertical-align: 0em;"></span><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.88888em; vertical-align: -0.19444em;"></span><span class="mord mathdefault" style="margin-right: 0.02778em;">r</span><span class="mord mathdefault">o</span><span class="mord mathdefault">u</span><span class="mord mathdefault" style="margin-right: 0.03588em;">g</span><span class="mord mathdefault">h</span><span class="mord mathdefault">n</span><span class="mord mathdefault">e</span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.88888em; vertical-align: -0.19444em;"></span><span class="mord mathdefault" style="margin-right: 0.02778em;">r</span><span class="mord mathdefault">o</span><span class="mord mathdefault">u</span><span class="mord mathdefault" style="margin-right: 0.03588em;">g</span><span class="mord mathdefault">h</span><span class="mord mathdefault">n</span><span class="mord mathdefault">e</span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span></span></span></span></span>）和<code>anisotropy</code> 计算Tangent和BiTangent方向的粗糙度。</p> 
<p>具体的映射方法有很多：</p> 
<p><em><strong>Neubelt and Pettine</strong></em></p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
          
           
            
             
             
               α 
              
             
               x 
              
             
            
              = 
             
            
           
          
          
           
            
             
            
              α 
             
            
           
          
         
         
          
           
            
             
             
               α 
              
             
               y 
              
             
            
              = 
             
            
           
          
          
           
            
             
            
              l 
             
            
              e 
             
            
              r 
             
            
              p 
             
            
              ( 
             
            
              0 
             
            
              , 
             
            
              α 
             
            
              , 
             
            
              1 
             
            
              − 
             
            
              a 
             
            
              n 
             
            
              i 
             
            
              s 
             
            
              o 
             
            
              t 
             
            
              r 
             
            
              o 
             
            
              p 
             
            
              y 
             
            
              ) 
             
            
           
          
         
        
       
         \begin{aligned} \alpha_x = &amp; \alpha \\ \alpha_y = &amp; lerp(0,\alpha,1-anisotropy) \end{aligned} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 3em; vertical-align: -1.25em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.75em;"><span class="" style="top: -3.91em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.0037em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span></span></span><span class="" style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.0037em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.286108em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.25em;"><span class=""></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.75em;"><span class="" style="top: -3.91em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span></span></span><span class="" style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span><span class="mord mathdefault" style="margin-right: 0.01968em;">l</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right: 0.02778em;">r</span><span class="mord mathdefault">p</span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord">1</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord mathdefault">a</span><span class="mord mathdefault">n</span><span class="mord mathdefault">i</span><span class="mord mathdefault">s</span><span class="mord mathdefault">o</span><span class="mord mathdefault">t</span><span class="mord mathdefault" style="margin-right: 0.02778em;">r</span><span class="mord mathdefault">o</span><span class="mord mathdefault">p</span><span class="mord mathdefault" style="margin-right: 0.03588em;">y</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.25em;"><span class=""></span></span></span></span></span></span></span></span></span></span></span></span></p> 
<p><em><strong>Burley</strong></em></p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
          
           
            
             
             
               α 
              
             
               x 
              
             
            
              = 
             
            
           
          
          
           
            
             
             
             
               α 
              
              
               
               
                 1 
                
               
                 − 
                
               
                 0.9 
                
               
                 × 
                
               
                 a 
                
               
                 n 
                
               
                 i 
                
               
                 s 
                
               
                 o 
                
               
                 t 
                
               
                 r 
                
               
                 o 
                
               
                 p 
                
               
                 y 
                
               
              
             
            
           
          
         
         
          
           
            
             
             
               α 
              
             
               y 
              
             
            
              = 
             
            
           
          
          
           
            
             
            
              α 
             
             
              
              
                1 
               
              
                − 
               
              
                0.9 
               
              
                × 
               
              
                a 
               
              
                n 
               
              
                i 
               
              
                s 
               
              
                o 
               
              
                t 
               
              
                r 
               
              
                o 
               
              
                p 
               
              
                y 
               
              
             
            
           
          
         
        
       
         \begin{aligned} \alpha_x = &amp; \frac{\alpha}{\sqrt{1-0.9\times anisotropy} } \\ \alpha_y = &amp; \alpha \sqrt{1-0.9\times anisotropy} \end{aligned} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 3.96397em; vertical-align: -1.73199em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.23199em;"><span class="" style="top: -4.23199em;"><span class="pstrut" style="height: 3.10756em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.0037em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span></span></span><span class="" style="top: -2.03557em;"><span class="pstrut" style="height: 3.10756em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.0037em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.286108em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.73199em;"><span class=""></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.23199em;"><span class="" style="top: -4.23199em;"><span class="pstrut" style="height: 3.10756em;"></span><span class="mord"><span class="mord"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.10756em;"><span class="" style="top: -2.29246em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.81754em;"><span class="svg-align" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord" style="padding-left: 0.833em;"><span class="mord">1</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">9</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord mathdefault">a</span><span class="mord mathdefault">n</span><span class="mord mathdefault">i</span><span class="mord mathdefault">s</span><span class="mord mathdefault">o</span><span class="mord mathdefault">t</span><span class="mord mathdefault" style="margin-right: 0.02778em;">r</span><span class="mord mathdefault">o</span><span class="mord mathdefault">p</span><span class="mord mathdefault" style="margin-right: 0.03588em;">y</span></span></span><span class="" style="top: -2.77754em;"><span class="pstrut" style="height: 3em;"></span><span class="hide-tail" style="min-width: 0.853em; height: 1.08em;"> 
                           <svg width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"> 
                            <path d="M95,702c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,
-10,-9.5,-14c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54c44.2,-33.3,65.8,
-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10s173,378,173,378c0.7,0,
35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429c69,-144,104.5,-217.7,106.5,
-221c5.3,-9.3,12,-14,20,-14H400000v40H845.2724s-225.272,467,-225.272,467
s-235,486,-235,486c-2.7,4.7,-9,7,-19,7c-6,0,-10,-1,-12,-3s-194,-422,-194,-422
s-65,47,-65,47z M834 80H400000v40H845z"></path> 
                           </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.22246em;"><span class=""></span></span></span></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.93em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span class="" style="top: -2.03557em;"><span class="pstrut" style="height: 3.10756em;"></span><span class="mord"><span class="mord"></span><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.966415em;"><span class="svg-align" style="top: -3.2em;"><span class="pstrut" style="height: 3.2em;"></span><span class="mord" style="padding-left: 1em;"><span class="mord">1</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">9</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord mathdefault">a</span><span class="mord mathdefault">n</span><span class="mord mathdefault">i</span><span class="mord mathdefault">s</span><span class="mord mathdefault">o</span><span class="mord mathdefault">t</span><span class="mord mathdefault" style="margin-right: 0.02778em;">r</span><span class="mord mathdefault">o</span><span class="mord mathdefault">p</span><span class="mord mathdefault" style="margin-right: 0.03588em;">y</span></span></span><span class="" style="top: -2.92642em;"><span class="pstrut" style="height: 3.2em;"></span><span class="hide-tail" style="min-width: 1.02em; height: 1.28em;"> 
                    <svg width="400em" height="1.28em" viewbox="0 0 400000 1296" preserveaspectratio="xMinYMin slice"> 
                     <path d="M263,681c0.7,0,18,39.7,52,119c34,79.3,68.167,
158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120c340,-704.7,510.7,-1060.3,512,-1067
c4.7,-7.3,11,-11,19,-11H40000v40H1012.3s-271.3,567,-271.3,567c-38.7,80.7,-84,
175,-136,283c-52,108,-89.167,185.3,-111.5,232c-22.3,46.7,-33.8,70.3,-34.5,71
c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1s-109,-253,-109,-253c-72.7,-168,-109.3,
-252,-110,-252c-10.7,8,-22,16.7,-34,26c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26
s76,-59,76,-59s76,-60,76,-60z M1001 80H40000v40H1012z"></path> 
                    </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.273585em;"><span class=""></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.73199em;"><span class=""></span></span></span></span></span></span></span></span></span></span></span></span></p> 
<p><em><strong>Kulla</strong></em></p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
          
           
            
             
             
               α 
              
             
               x 
              
             
            
              = 
             
            
           
          
          
           
            
             
            
              α 
             
            
              × 
             
            
              ( 
             
            
              1 
             
            
              + 
             
            
              a 
             
            
              n 
             
            
              i 
             
            
              s 
             
            
              o 
             
            
              t 
             
            
              r 
             
            
              o 
             
            
              p 
             
            
              y 
             
            
              ) 
             
            
           
          
         
         
          
           
            
             
             
               α 
              
             
               y 
              
             
            
              = 
             
            
           
          
          
           
            
             
            
              α 
             
            
              × 
             
            
              ( 
             
            
              1 
             
            
              − 
             
            
              a 
             
            
              n 
             
            
              i 
             
            
              s 
             
            
              o 
             
            
              t 
             
            
              r 
             
            
              o 
             
            
              p 
             
            
              y 
             
            
              ) 
             
            
           
          
         
        
       
         \begin{aligned} \alpha_x = &amp; \alpha \times (1+anisotropy) \\ \alpha_y = &amp; \alpha \times (1-anisotropy) \\ \end{aligned} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 3em; vertical-align: -1.25em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.75em;"><span class="" style="top: -3.91em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.0037em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span></span></span><span class="" style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.0037em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.286108em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.25em;"><span class=""></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.75em;"><span class="" style="top: -3.91em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord mathdefault">a</span><span class="mord mathdefault">n</span><span class="mord mathdefault">i</span><span class="mord mathdefault">s</span><span class="mord mathdefault">o</span><span class="mord mathdefault">t</span><span class="mord mathdefault" style="margin-right: 0.02778em;">r</span><span class="mord mathdefault">o</span><span class="mord mathdefault">p</span><span class="mord mathdefault" style="margin-right: 0.03588em;">y</span><span class="mclose">)</span></span></span><span class="" style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord mathdefault">a</span><span class="mord mathdefault">n</span><span class="mord mathdefault">i</span><span class="mord mathdefault">s</span><span class="mord mathdefault">o</span><span class="mord mathdefault">t</span><span class="mord mathdefault" style="margin-right: 0.02778em;">r</span><span class="mord mathdefault">o</span><span class="mord mathdefault">p</span><span class="mord mathdefault" style="margin-right: 0.03588em;">y</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.25em;"><span class=""></span></span></span></span></span></span></span></span></span></span></span></span></p> 
<p>对于问题2：</p> 
<p>BRDF公式取决于三个部分：法线发布函数D，遮挡项G，和菲涅尔项F。</p> 
<p>其中，F取决于材质的固有属性，是不会变的。各向异性是宏观的现象，不会影响微观表面的性质。</p> 
<p>至于D和G，由于G是从D推导而来，因此先看一下D需要如何进行修改。</p> 
<p><strong>法线分布函数</strong></p> 
<p>D(m)，法线分布函数，代表一个微平面表面法线的统计分布（概率分布）。</p> 
<p>其输入是一个法线方向，返回的是一个概率值。</p> 
<p>一般以h（半程向量）作为微表面的法线，只有<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         m 
        
       
         = 
        
       
         h 
        
       
      
        m=h 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.43056em; vertical-align: 0em;"></span><span class="mord mathdefault">m</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.69444em; vertical-align: 0em;"></span><span class="mord mathdefault">h</span></span></span></span></span>时，才会将光线<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         l 
        
       
      
        l 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.69444em; vertical-align: 0em;"></span><span class="mord mathdefault" style="margin-right: 0.01968em;">l</span></span></span></span></span>反射到<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         v 
        
       
      
        v 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.43056em; vertical-align: 0em;"></span><span class="mord mathdefault" style="margin-right: 0.03588em;">v</span></span></span></span></span>方向。</p> 
<p>对于D(m)在微平面上进行积分，可以得到微平面的面积<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ∫ 
        
       
         D 
        
       
         ( 
        
       
         m 
        
       
         ) 
        
       
         d 
        
       
         m 
        
       
      
        \int D(m)dm 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.11112em; vertical-align: -0.30612em;"></span><span class="mop op-symbol small-op" style="margin-right: 0.19445em; position: relative; top: -0.00056em;">∫</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord mathdefault" style="margin-right: 0.02778em;">D</span><span class="mopen">(</span><span class="mord mathdefault">m</span><span class="mclose">)</span><span class="mord mathdefault">d</span><span class="mord mathdefault">m</span></span></span></span></span>。</p> 
<p>投影到宏观表面平面上的微平面区域，等于宏观表面的面积，被约定为1。。</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ∫ 
         
        
          D 
         
        
          ( 
         
        
          m 
         
        
          ) 
         
        
          ( 
         
        
          n 
         
        
          ⋅ 
         
        
          m 
         
        
          ) 
         
        
          d 
         
        
          m 
         
        
          = 
         
        
          1 
         
        
       
         \int D(m) (n \cdot m) dm = 1 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 2.22225em; vertical-align: -0.86225em;"></span><span class="mop op-symbol large-op" style="margin-right: 0.44445em; position: relative; top: -0.001125em;">∫</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord mathdefault" style="margin-right: 0.02778em;">D</span><span class="mopen">(</span><span class="mord mathdefault">m</span><span class="mclose">)</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathdefault">m</span><span class="mclose">)</span><span class="mord mathdefault">d</span><span class="mord mathdefault">m</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">1</span></span></span></span></span></span></p> 
<p><img src="https://images2.imgbox.com/5a/15/rwzv5Nzq_o.png" alt="在这里插入图片描述"></p> 
<p>更一般地，微观表面（microsurface）和宏观表面（macrosurface）在垂直于任何视图方向<strong>v</strong>的平面上的投影是相等的：</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ∫ 
         
        
          D 
         
        
          ( 
         
        
          m 
         
        
          ) 
         
        
          ( 
         
        
          v 
         
        
          ⋅ 
         
        
          m 
         
        
          ) 
         
        
          d 
         
        
          m 
         
        
          = 
         
        
          v 
         
        
          ⋅ 
         
        
          n 
         
        
       
         \int D(m) (v \cdot m) dm = v \cdot n 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 2.22225em; vertical-align: -0.86225em;"></span><span class="mop op-symbol large-op" style="margin-right: 0.44445em; position: relative; top: -0.001125em;">∫</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord mathdefault" style="margin-right: 0.02778em;">D</span><span class="mopen">(</span><span class="mord mathdefault">m</span><span class="mclose">)</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.03588em;">v</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathdefault">m</span><span class="mclose">)</span><span class="mord mathdefault">d</span><span class="mord mathdefault">m</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.44445em; vertical-align: 0em;"></span><span class="mord mathdefault" style="margin-right: 0.03588em;">v</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.43056em; vertical-align: 0em;"></span><span class="mord mathdefault">n</span></span></span></span></span></span></p> 
<p><img src="https://images2.imgbox.com/33/76/RHEHZnfF_o.png" alt="在这里插入图片描述"></p> 
<p><strong>法线分布函数的形状不变性</strong></p> 
<p>法线分布函数D的形状不变性是指改变D的粗糙度，相当于对微表面进行<strong>拉伸</strong>，而<strong>不改变微表面的形状</strong>。</p> 
<p>对于形状不变的NDF，缩放粗糙度参数相当于通过倒数拉伸微观几何，如下图所示：</p> 
<ul><li>粗糙度变小，相当于对微表面进行拉伸，但形状是不变的。</li></ul> 
<p><img src="https://images2.imgbox.com/17/6c/kJ7Tomwo_o.jpg" alt="在这里插入图片描述"></p> 
<p>若一个各向同性的NDF可以改写成以下形式，则这个NDF具有形状不变性（shape-invariant）：</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          D 
         
        
          ( 
         
        
          m 
         
        
          ) 
         
        
          = 
         
         
         
           1 
          
          
           
           
             α 
            
           
             2 
            
           
          
            ( 
           
          
            n 
           
          
            ⋅ 
           
          
            m 
           
           
           
             ) 
            
           
             4 
            
           
          
         
        
          g 
         
        
          ( 
         
         
          
           
           
             1 
            
           
             − 
            
           
             ( 
            
           
             n 
            
           
             ⋅ 
            
           
             m 
            
            
            
              ) 
             
            
              2 
             
            
           
           
          
          
          
            α 
           
          
            ( 
           
          
            n 
           
          
            ⋅ 
           
          
            m 
           
          
            ) 
           
          
         
        
          ) 
         
        
       
         D(m)=\frac{1}{<!-- -->{\alpha}^2(n\cdot m)^4} g(\frac{\sqrt[]{1-(n\cdot m)^2}}{\alpha (n\cdot m)} ) 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathdefault" style="margin-right: 0.02778em;">D</span><span class="mopen">(</span><span class="mord mathdefault">m</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 2.566em; vertical-align: -0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.32144em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.740108em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord mathdefault">m</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.740108em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span></span></span></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.936em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord mathdefault" style="margin-right: 0.03588em;">g</span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.63em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord mathdefault">m</span><span class="mclose">)</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.695em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord sqrt"><span class="root"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.378em;"><span class="" style="top: -2.378em;"><span class="pstrut" style="height: 2em;"></span><span class="sizing reset-size6 size1 mtight"><span class="mord mtight"></span></span></span></span></span></span></span><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.935em;"><span class="svg-align" style="top: -3.2em;"><span class="pstrut" style="height: 3.2em;"></span><span class="mord" style="padding-left: 1em;"><span class="mord">1</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord mathdefault">m</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.740108em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span class="" style="top: -2.895em;"><span class="pstrut" style="height: 3.2em;"></span><span class="hide-tail" style="min-width: 1.02em; height: 1.28em;"> 
                   <svg width="400em" height="1.28em" viewbox="0 0 400000 1296" preserveaspectratio="xMinYMin slice"> 
                    <path d="M263,681c0.7,0,18,39.7,52,119c34,79.3,68.167,
158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120c340,-704.7,510.7,-1060.3,512,-1067
c4.7,-7.3,11,-11,19,-11H40000v40H1012.3s-271.3,567,-271.3,567c-38.7,80.7,-84,
175,-136,283c-52,108,-89.167,185.3,-111.5,232c-22.3,46.7,-33.8,70.3,-34.5,71
c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1s-109,-253,-109,-253c-72.7,-168,-109.3,
-252,-110,-252c-10.7,8,-22,16.7,-34,26c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26
s76,-59,76,-59s76,-60,76,-60z M1001 80H40000v40H1012z"></path> 
                   </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.305em;"><span class=""></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.936em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">)</span></span></span></span></span></span></p> 
<p>其中，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         g 
        
       
         ( 
        
       
         ) 
        
       
      
        g() 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathdefault" style="margin-right: 0.03588em;">g</span><span class="mopen">(</span><span class="mclose">)</span></span></span></span></span>代表一个表示了NDF形状的一维函数。</p> 
<p>具有形状不变性（shape-invariant）的法线分布函数，可以用于<strong>推导该函数的归一化的各向异性版本</strong>，并且可以很方便地推导出对应的遮蔽阴影项G。</p> 
<p>对于常见的法线分布函数的旋转不变性的分类：</p> 
<ul><li>具备形状不变性的常用法线分布函数为： 
  <ul><li>GGX</li><li>Beckmann</li></ul> </li><li>不具备形状不变性的常用法线分布函数为： 
  <ul><li>Phong</li><li>Blinn-Phong</li><li>GTR</li></ul> </li></ul> 
<p>下图显示了如何通过**拉伸表面（stretching the surface）**将各向同性的形状不变分布转换为各向异性分布。</p> 
<p>相反，任何具有各向异性分布的配置都可以转换回具有各向同性分布的配置。</p> 
<p>下图展示了：通过拉伸表面，可以将各向同性具备形状不变性的分布，转换为各向异性分布。</p> 
<p><img src="https://images2.imgbox.com/00/a8/27uSvy6a_o.jpg" alt="在这里插入图片描述"></p> 
<p>通过上述的方法，可以推导出Beckmann和GGX分布的各向异性形式。</p> 
<p>若一个各向同性（isotropic）的NDF具备形状不变性（shape-invariant），则其可以用以下形式写出：</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          D 
         
        
          ( 
         
        
          m 
         
        
          ) 
         
        
          = 
         
         
         
           1 
          
          
           
           
             α 
            
           
             2 
            
           
          
            ( 
           
          
            n 
           
          
            ⋅ 
           
          
            m 
           
           
           
             ) 
            
           
             4 
            
           
          
         
        
          g 
         
        
          ( 
         
         
          
           
           
             1 
            
           
             − 
            
           
             ( 
            
           
             n 
            
           
             ⋅ 
            
           
             m 
            
            
            
              ) 
             
            
              2 
             
            
           
           
          
          
          
            α 
           
          
            ( 
           
          
            n 
           
          
            ⋅ 
           
          
            m 
           
          
            ) 
           
          
         
        
          ) 
         
        
       
         D(m)=\frac{1}{<!-- -->{\alpha}^2(n\cdot m)^4} g(\frac{\sqrt[]{1-(n\cdot m)^2}}{\alpha (n\cdot m)} ) 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathdefault" style="margin-right: 0.02778em;">D</span><span class="mopen">(</span><span class="mord mathdefault">m</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 2.566em; vertical-align: -0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.32144em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.740108em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord mathdefault">m</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.740108em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span></span></span></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.936em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord mathdefault" style="margin-right: 0.03588em;">g</span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.63em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord mathdefault">m</span><span class="mclose">)</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.695em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord sqrt"><span class="root"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.378em;"><span class="" style="top: -2.378em;"><span class="pstrut" style="height: 2em;"></span><span class="sizing reset-size6 size1 mtight"><span class="mord mtight"></span></span></span></span></span></span></span><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.935em;"><span class="svg-align" style="top: -3.2em;"><span class="pstrut" style="height: 3.2em;"></span><span class="mord" style="padding-left: 1em;"><span class="mord">1</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord mathdefault">m</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.740108em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span class="" style="top: -2.895em;"><span class="pstrut" style="height: 3.2em;"></span><span class="hide-tail" style="min-width: 1.02em; height: 1.28em;"> 
                   <svg width="400em" height="1.28em" viewbox="0 0 400000 1296" preserveaspectratio="xMinYMin slice"> 
                    <path d="M263,681c0.7,0,18,39.7,52,119c34,79.3,68.167,
158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120c340,-704.7,510.7,-1060.3,512,-1067
c4.7,-7.3,11,-11,19,-11H40000v40H1012.3s-271.3,567,-271.3,567c-38.7,80.7,-84,
175,-136,283c-52,108,-89.167,185.3,-111.5,232c-22.3,46.7,-33.8,70.3,-34.5,71
c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1s-109,-253,-109,-253c-72.7,-168,-109.3,
-252,-110,-252c-10.7,8,-22,16.7,-34,26c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26
s76,-59,76,-59s76,-60,76,-60z M1001 80H40000v40H1012z"></path> 
                   </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.305em;"><span class=""></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.936em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">)</span></span></span></span></span></span></p> 
<p>那么，通过此形式可以可得到各向异性的（anisotropic）版本：</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          D 
         
        
          ( 
         
        
          m 
         
        
          ) 
         
        
          = 
         
         
         
           1 
          
          
           
            
            
              α 
             
            
              x 
             
            
            
            
              α 
             
            
              y 
             
            
           
          
            ( 
           
          
            n 
           
          
            ⋅ 
           
          
            m 
           
           
           
             ) 
            
           
             4 
            
           
          
         
        
          g 
         
        
          ( 
         
         
          
           
            
             
             
               ( 
              
             
               t 
              
             
               ⋅ 
              
             
               m 
              
              
              
                ) 
               
              
                2 
               
              
             
             
             
               α 
              
             
               x 
              
             
               2 
              
             
            
           
             + 
            
            
             
             
               ( 
              
             
               b 
              
             
               ⋅ 
              
             
               m 
              
              
              
                ) 
               
              
                2 
               
              
             
             
             
               α 
              
             
               y 
              
             
               2 
              
             
            
           
           
          
          
          
            ( 
           
          
            n 
           
          
            ⋅ 
           
          
            m 
           
          
            ) 
           
          
         
        
          ) 
         
        
       
         D(m)=\frac{1}{<!-- -->{\alpha_x \alpha_y}(n\cdot m)^4} g(\frac{\sqrt[]{\frac{(t\cdot m)^2}{\alpha _x^2} +\frac{(b\cdot m)^2}{\alpha _y^2} }}{(n\cdot m)} ) 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathdefault" style="margin-right: 0.02778em;">D</span><span class="mopen">(</span><span class="mord mathdefault">m</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 3.20211em; vertical-align: -0.972108em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.32144em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.0037em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.0037em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.286108em;"><span class=""></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord mathdefault">m</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.740108em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span></span></span></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.972108em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord mathdefault" style="margin-right: 0.03588em;">g</span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.23em;"><span class="" style="top: -2.48279em;"><span class="pstrut" style="height: 3.16879em;"></span><span class="mord"><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord mathdefault">m</span><span class="mclose">)</span></span></span><span class="" style="top: -3.39879em;"><span class="pstrut" style="height: 3.16879em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -4.23em;"><span class="pstrut" style="height: 3.16879em;"></span><span class="mord"><span class="mord sqrt"><span class="root"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.298548em;"><span class="" style="top: -2.29855em;"><span class="pstrut" style="height: 2em;"></span><span class="sizing reset-size6 size1 mtight"><span class="mord mtight"></span></span></span></span></span></span></span><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.16879em;"><span class="svg-align" style="top: -3.8em;"><span class="pstrut" style="height: 3.8em;"></span><span class="mord" style="padding-left: 1em;"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.01em;"><span class="" style="top: -2.655em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.746314em;"><span class="" style="top: -2.214em; margin-left: -0.0037em; margin-right: 0.0714286em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight">x</span></span></span><span class="" style="top: -2.786em; margin-right: 0.0714286em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.286em;"><span class=""></span></span></span></span></span></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.485em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathdefault mtight">t</span><span class="mbin mtight">⋅</span><span class="mord mathdefault mtight">m</span><span class="mclose mtight"><span class="mclose mtight">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.746314em;"><span class="" style="top: -2.786em; margin-right: 0.0714286em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.5452em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.01em;"><span class="" style="top: -2.655em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.746314em;"><span class="" style="top: -2.214em; margin-left: -0.0037em; margin-right: 0.0714286em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em;">y</span></span></span><span class="" style="top: -2.786em; margin-right: 0.0714286em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.424886em;"><span class=""></span></span></span></span></span></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.485em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathdefault mtight">b</span><span class="mbin mtight">⋅</span><span class="mord mathdefault mtight">m</span><span class="mclose mtight"><span class="mclose mtight">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.746314em;"><span class="" style="top: -2.786em; margin-right: 0.0714286em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.64242em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span class="" style="top: -3.12879em;"><span class="pstrut" style="height: 3.8em;"></span><span class="hide-tail" style="min-width: 1.02em; height: 1.88em;"> 
                   <svg width="400em" height="1.8800000000000001em" viewbox="0 0 400000 1944" preserveaspectratio="xMinYMin slice"> 
                    <path d="M1001,80H400000v40H1013.1s-83.4,268,-264.1,840c-180.7,
572,-277,876.3,-289,913c-4.7,4.7,-12.7,7,-24,7s-12,0,-12,0c-1.3,-3.3,-3.7,-11.7,
-7,-25c-35.3,-125.3,-106.7,-373.3,-214,-744c-10,12,-21,25,-33,39s-32,39,-32,39
c-6,-5.3,-15,-14,-27,-26s25,-30,25,-30c26.7,-32.7,52,-63,76,-91s52,-60,52,-60
s208,722,208,722c56,-175.3,126.3,-397.3,211,-666c84.7,-268.7,153.8,-488.2,207.5,
-658.5c53.7,-170.3,84.5,-266.8,92.5,-289.5c4,-6.7,10,-10,18,-10z
M1001 80H400000v40H1013z"></path> 
                   </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.67121em;"><span class=""></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.936em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">)</span></span></span></span></span></span></p> 
<p>其中，参数<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          α 
         
        
          x 
         
        
       
      
        \alpha_x 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.58056em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.0037em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>和<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          α 
         
        
          y 
         
        
       
      
        \alpha_y 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.716668em; vertical-align: -0.286108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.0037em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.286108em;"><span class=""></span></span></span></span></span></span></span></span></span></span>分别表示沿切线（tangent）方向和副切线（bitangent）方向的粗糙度。</p> 
<ul><li>若 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           α 
          
         
           x 
          
         
        
          = 
         
         
         
           α 
          
         
           y 
          
         
        
       
         \alpha_x = \alpha_y 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.58056em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.0037em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.716668em; vertical-align: -0.286108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.0037em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.286108em;"><span class=""></span></span></span></span></span></span></span></span></span></span>，则公式又缩减回各项同性的形式了。</li></ul> 
<p><em><strong>Anisotropic Beckmann Distribution</strong></em></p> 
<p>各项异性的Beckmann分布形式如下：</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           D 
          
          
          
            B 
           
          
            a 
           
          
            n 
           
          
            i 
           
          
            s 
           
          
            o 
           
          
         
        
          ( 
         
        
          m 
         
        
          ) 
         
        
          = 
         
         
         
           1 
          
          
          
            π 
           
           
           
             α 
            
           
             x 
            
           
           
           
             α 
            
           
             y 
            
           
          
            ( 
           
          
            n 
           
          
            ⋅ 
           
          
            m 
           
           
           
             ) 
            
           
             4 
            
           
          
         
        
          e 
         
        
          x 
         
        
          p 
         
        
          ( 
         
        
          − 
         
         
          
           
            
            
              ( 
             
            
              t 
             
            
              ⋅ 
             
            
              m 
             
             
             
               ) 
              
             
               2 
              
             
            
            
            
              α 
             
            
              x 
             
            
              2 
             
            
           
          
            + 
           
           
            
            
              ( 
             
            
              b 
             
            
              ⋅ 
             
            
              m 
             
             
             
               ) 
              
             
               2 
              
             
            
            
            
              α 
             
            
              y 
             
            
              2 
             
            
           
          
          
          
            ( 
           
          
            n 
           
          
            ⋅ 
           
          
            m 
           
           
           
             ) 
            
           
             2 
            
           
          
         
        
          ) 
         
        
       
         D_{Baniso}(m)= \frac{1}{\pi\alpha_x \alpha_y (n\cdot m)^4}exp(-\frac{\frac{(t \cdot m)^2}{\alpha_x^2} + \frac{(b \cdot m)^2}{\alpha_y^2}}{(n\cdot m)^2} ) 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: -0.02778em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.05017em;">B</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">s</span><span class="mord mathdefault mtight">o</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">m</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 3.11345em; vertical-align: -0.972108em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.32144em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em;">π</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.0037em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.0037em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.286108em;"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord mathdefault">m</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.740108em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span></span></span></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.972108em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord mathdefault">e</span><span class="mord mathdefault">x</span><span class="mord mathdefault">p</span><span class="mopen">(</span><span class="mord">−</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.14134em;"><span class="" style="top: -2.42292em;"><span class="pstrut" style="height: 3.10892em;"></span><span class="mord"><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord mathdefault">m</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.740108em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span class="" style="top: -3.33892em;"><span class="pstrut" style="height: 3.10892em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -4.14134em;"><span class="pstrut" style="height: 3.10892em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.10892em;"><span class="" style="top: -2.655em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.746314em;"><span class="" style="top: -2.214em; margin-left: -0.0037em; margin-right: 0.0714286em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight">x</span></span></span><span class="" style="top: -2.786em; margin-right: 0.0714286em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.286em;"><span class=""></span></span></span></span></span></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.485em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathdefault mtight">t</span><span class="mbin mtight">⋅</span><span class="mord mathdefault mtight">m</span><span class="mclose mtight"><span class="mclose mtight">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.891314em;"><span class="" style="top: -2.931em; margin-right: 0.0714286em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.5452em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.10892em;"><span class="" style="top: -2.655em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.746314em;"><span class="" style="top: -2.214em; margin-left: -0.0037em; margin-right: 0.0714286em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em;">y</span></span></span><span class="" style="top: -2.786em; margin-right: 0.0714286em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.424886em;"><span class=""></span></span></span></span></span></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.485em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathdefault mtight">b</span><span class="mbin mtight">⋅</span><span class="mord mathdefault mtight">m</span><span class="mclose mtight"><span class="mclose mtight">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.891314em;"><span class="" style="top: -2.931em; margin-right: 0.0714286em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.64242em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.936em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">)</span></span></span></span></span></span></p> 
<ul><li>其中，使用时m为微表面法线（即半程向量half vector），n为宏观表面法线，t为切线方向，b为副切线方向。</li></ul> 
<p>以下为UE4中Anisotropic Beckmann分布的Shader实现代码：</p> 
<pre><code class="prism language-c++">// Anisotropic Beckmann
float D_Beckmann_aniso( float ax, float ay, float NoH, float3 H, float3 X, float3 Y )
{
    float XoH = dot( X, H );
    float YoH = dot( Y, H );
    float d = - (XoH*XoH / (ax*ax) + YoH*YoH / (ay*ay)) / NoH*NoH;
    return exp(d) / ( PI * ax*ay * NoH * NoH * NoH * NoH );
}
</code></pre> 
<p><em><strong>Anisotropic GGX Distribution</strong></em></p> 
<p>各项异性的GGX分布形式如下：</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           D 
          
          
          
            G 
           
          
            G 
           
          
            X 
           
          
            a 
           
          
            n 
           
          
            i 
           
          
            s 
           
          
            o 
           
          
         
        
          ( 
         
        
          m 
         
        
          ) 
         
        
          = 
         
         
         
           1 
          
          
          
            π 
           
           
           
             α 
            
           
             x 
            
           
           
           
             α 
            
           
             y 
            
           
          
         
         
         
           1 
          
          
          
            ( 
           
           
            
            
              ( 
             
            
              t 
             
            
              ⋅ 
             
            
              m 
             
             
             
               ) 
              
             
               2 
              
             
            
            
            
              α 
             
            
              x 
             
            
              2 
             
            
           
          
            + 
           
           
            
            
              ( 
             
            
              b 
             
            
              ⋅ 
             
            
              m 
             
             
             
               ) 
              
             
               2 
              
             
            
            
            
              α 
             
            
              y 
             
            
              2 
             
            
           
          
            + 
           
          
            ( 
           
          
            n 
           
          
            ⋅ 
           
          
            m 
           
           
           
             ) 
            
           
             2 
            
           
           
           
             ) 
            
           
             2 
            
           
          
         
        
       
         D_{GGXaniso}(m)= \frac{1}{\pi\alpha_x \alpha_y}\frac{1}{(\frac{(t \cdot m)^2}{\alpha_x^2}+\frac{(b \cdot m)^2}{\alpha_y^2}+(n\cdot m)^2)^2} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: -0.02778em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">G</span><span class="mord mathdefault mtight">G</span><span class="mord mathdefault mtight" style="margin-right: 0.07847em;">X</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">s</span><span class="mord mathdefault mtight">o</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">m</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 2.86386em; vertical-align: -1.54242em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.32144em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em;">π</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.0037em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.0037em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.286108em;"><span class=""></span></span></span></span></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.972108em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.32144em;"><span class="" style="top: -2.11em;"><span class="pstrut" style="height: 3.01em;"></span><span class="mord"><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.01em;"><span class="" style="top: -2.655em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.746314em;"><span class="" style="top: -2.214em; margin-left: -0.0037em; margin-right: 0.0714286em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight">x</span></span></span><span class="" style="top: -2.786em; margin-right: 0.0714286em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.286em;"><span class=""></span></span></span></span></span></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.485em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathdefault mtight">t</span><span class="mbin mtight">⋅</span><span class="mord mathdefault mtight">m</span><span class="mclose mtight"><span class="mclose mtight">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.746314em;"><span class="" style="top: -2.786em; margin-right: 0.0714286em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.5452em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.01em;"><span class="" style="top: -2.655em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.746314em;"><span class="" style="top: -2.214em; margin-left: -0.0037em; margin-right: 0.0714286em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em;">y</span></span></span><span class="" style="top: -2.786em; margin-right: 0.0714286em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.424886em;"><span class=""></span></span></span></span></span></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.485em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathdefault mtight">b</span><span class="mbin mtight">⋅</span><span class="mord mathdefault mtight">m</span><span class="mclose mtight"><span class="mclose mtight">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.746314em;"><span class="" style="top: -2.786em; margin-right: 0.0714286em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.64242em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord mathdefault">m</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.740108em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.740108em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span class="" style="top: -3.24em;"><span class="pstrut" style="height: 3.01em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.687em;"><span class="pstrut" style="height: 3.01em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.54242em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></span></p> 
<p>以下为UE4中Anisotropic GGX分布的Shader实现代码：</p> 
<pre><code class="prism language-c++">// Anisotropic GGX
// [Burley 2012, "Physically-Based Shading at Disney"]
float D_GGXaniso( float ax, float ay, float NoH, float3 H, float3 X, float3 Y )
{
    float XoH = dot( X, H );
    float YoH = dot( Y, H );
    float d = XoH*XoH / (ax*ax) + YoH*YoH / (ay*ay) + NoH*NoH;
    return 1 / ( PI * ax*ay * d*d );
}
</code></pre> 
<ul><li>其中，X为tangent，t切线方向，Y为binormal，b，副法线方向。</li><li>需要注意的是，将法线贴图与各向异性BRDF组合时，重要的是要<strong>确保法线贴图扰动（perturbs）切线和副切线矢量以及法线</strong>。</li></ul> 
<h3><a id="_232"></a>三、头发光照模型</h3> 
<p>头发渲染的光照模型，从简单到复杂顺序如下：</p> 
<ul><li>Kajiya-Kay Model (1989)</li><li>Marschner Model (2003)</li><li>Scheuermann Model (2004)</li><li>d’Eon Model (2011)</li><li>Double Cylinder Model (2018)</li></ul> 
<p>目前游戏实时渲染领域处于Scheuermann Model阶段。</p> 
<p>这里我们仅介绍目前两种模型：Kajiya-Kay Model 和Marschner Model。</p> 
<h4><a id="31_KajiyaKay_Model_248"></a>3.1 Kajiya-Kay Model</h4> 
<p>一般的光照模型可以简化为：</p> 
<ul><li><strong>光照模型 = 环境光 + 漫反射 + 镜面反射（高光）</strong></li></ul> 
<p>在头发光照模型中：</p> 
<ul><li><strong>光照模型 = 环境光 + 漫反射 + 各向异性光照高光</strong></li></ul> 
<p>头发的各向异性高光会形成类似天使环，这有别于金属的椭圆形高光。</p> 
<h5><a id="311_Strand_based_Anisotropy_260"></a>3.1.1 Strand based Anisotropy</h5> 
<p>对于头发可以采用以下的方式strand based anisotropy进行建模，可以将这种微观的细丝看成直径非常小长度很长的圆柱。</p> 
<blockquote> 
 <p>摘录自 <a href="https://zhuanlan.zhihu.com/p/27313644" rel="nofollow">角色渲染技术——毛发及其他</a></p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/e5/8b/LbRQAePr_o.jpg" alt="在这里插入图片描述"></p> 
<p>那么，我们宏观看上看到的这类表面上<strong>某一点的光照</strong>实际上是<strong>一圈圆柱上的点的光照总和</strong>。</p> 
<p>这一圈点有无数个方向不同的法线，如果要计算光照总体贡献，就需要对这一圈点的入射光和BRDF的乘积进行一个半圆形的积分，并且还要考虑到相应的可见性（遮挡）函数。类似于：</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           ∫ 
          
         
           0 
          
          
          
            2 
           
          
            π 
           
          
         
        
          p 
         
        
          ( 
         
        
          l 
         
        
          , 
         
        
          v 
         
        
          , 
         
        
          v 
         
        
          ( 
         
        
          θ 
         
        
          ) 
         
        
          ) 
         
        
          ∗ 
         
        
          L 
         
        
          ∗ 
         
        
          ( 
         
        
          l 
         
        
          ⋅ 
         
        
          n 
         
        
          ( 
         
        
          θ 
         
        
          ) 
         
        
          ) 
         
        
          ∗ 
         
        
          V 
         
        
          ( 
         
        
          θ 
         
        
          ) 
         
        
          ∗ 
         
        
          r 
         
        
          ∗ 
         
        
          d 
         
        
          θ 
         
        
       
         \int_{0}^{2\pi} p(l,v,v(\theta)) \ast L \ast (l\cdot n(\theta ))\ast V(\theta ) \ast r \ast d\theta 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 2.47596em; vertical-align: -0.91195em;"></span><span class="mop"><span class="mop op-symbol large-op" style="margin-right: 0.44445em; position: relative; top: -0.001125em;">∫</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.56401em;"><span class="" style="top: -1.78805em; margin-left: -0.44445em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span><span class="" style="top: -3.8129em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathdefault mtight" style="margin-right: 0.03588em;">π</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.91195em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord mathdefault">p</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.01968em;">l</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord mathdefault" style="margin-right: 0.03588em;">v</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord mathdefault" style="margin-right: 0.03588em;">v</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.02778em;">θ</span><span class="mclose">)</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.68333em; vertical-align: 0em;"></span><span class="mord mathdefault">L</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.01968em;">l</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathdefault">n</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.02778em;">θ</span><span class="mclose">)</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathdefault" style="margin-right: 0.22222em;">V</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.02778em;">θ</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.46528em; vertical-align: 0em;"></span><span class="mord mathdefault" style="margin-right: 0.02778em;">r</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.69444em; vertical-align: 0em;"></span><span class="mord mathdefault">d</span><span class="mord mathdefault" style="margin-right: 0.02778em;">θ</span></span></span></span></span></span></p> 
<p>其中，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         p 
        
       
      
        p 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.19444em;"></span><span class="mord mathdefault">p</span></span></span></span></span>是BRDF，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         L 
        
       
      
        L 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.68333em; vertical-align: 0em;"></span><span class="mord mathdefault">L</span></span></span></span></span>是和法线方向无关的入射光强，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         V 
        
       
         ( 
        
       
         θ 
        
       
         ) 
        
       
      
        V(\theta) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathdefault" style="margin-right: 0.22222em;">V</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.02778em;">θ</span><span class="mclose">)</span></span></span></span></span>是和角度相关的可见性。</p> 
<p>而<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          ∫ 
         
        
          0 
         
         
         
           2 
          
         
           π 
          
         
        
       
         ( 
        
       
         l 
        
       
         ⋅ 
        
       
         n 
        
       
         ( 
        
       
         θ 
        
       
         ) 
        
       
         ) 
        
       
         ∗ 
        
       
         V 
        
       
         ( 
        
       
         θ 
        
       
         ) 
        
       
         ∗ 
        
       
         r 
        
       
         ∗ 
        
       
         d 
        
       
         θ 
        
       
      
        \int_{0}^{2\pi}(l\cdot n(\theta ))\ast V(\theta ) \ast r \ast d\theta 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.36483em; vertical-align: -0.35582em;"></span><span class="mop"><span class="mop op-symbol small-op" style="margin-right: 0.19445em; position: relative; top: -0.00056em;">∫</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.00901em;"><span class="" style="top: -2.34418em; margin-left: -0.19445em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span><span class="" style="top: -3.2579em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathdefault mtight" style="margin-right: 0.03588em;">π</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.35582em;"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.01968em;">l</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathdefault">n</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.02778em;">θ</span><span class="mclose">)</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathdefault" style="margin-right: 0.22222em;">V</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.02778em;">θ</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.46528em; vertical-align: 0em;"></span><span class="mord mathdefault" style="margin-right: 0.02778em;">r</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.69444em; vertical-align: 0em;"></span><span class="mord mathdefault">d</span><span class="mord mathdefault" style="margin-right: 0.02778em;">θ</span></span></span></span></span> 很像<a href="https://zhuanlan.zhihu.com/p/27014447" rel="nofollow">角色渲染技术——皮肤</a>中提到的bent normal的概念。</p> 
<p>进一步，假设可以预积分出bent normal，则上述的公式可以近似为：</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          k 
         
        
          ∗ 
         
        
          p 
         
        
          ( 
         
        
          l 
         
        
          , 
         
        
          v 
         
        
          , 
         
         
         
           n 
          
          
          
            b 
           
          
            e 
           
          
            n 
           
          
            t 
           
          
         
        
          ) 
         
        
          ∗ 
         
        
          L 
         
        
          ∗ 
         
        
          ( 
         
        
          l 
         
        
          ∗ 
         
         
         
           n 
          
          
          
            b 
           
          
            e 
           
          
            n 
           
          
            t 
           
          
         
        
          ) 
         
        
       
         k \ast p(l,v,n_{bent}) \ast L \ast (l*n_{bent}) 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.69444em; vertical-align: 0em;"></span><span class="mord mathdefault" style="margin-right: 0.03148em;">k</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathdefault">p</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.01968em;">l</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord mathdefault" style="margin-right: 0.03588em;">v</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord"><span class="mord mathdefault">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">b</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.68333em; vertical-align: 0em;"></span><span class="mord mathdefault">L</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.01968em;">l</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathdefault">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">b</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></span></p> 
<p>这个<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          n 
         
         
         
           b 
          
         
           e 
          
         
           n 
          
         
           t 
          
         
        
       
      
        n_{bent} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.58056em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathdefault">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">b</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>就是预积分出来的方向，那么这个方向到底是哪里呢？</p> 
<p><strong>由于整个半圆形都在一个法线平面上，如果假设光照方向向量投影在该平面的向量是<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           n 
          
         
           ′ 
          
         
        
       
         n' 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.751892em; vertical-align: 0em;"></span><span class="mord"><span class="mord mathdefault">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.751892em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span>，那么整个半圆上所有的法线应该对称地分布在<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           n 
          
         
           ′ 
          
         
        
       
         n' 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.751892em; vertical-align: 0em;"></span><span class="mord"><span class="mord mathdefault">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.751892em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span>两侧，所以<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           n 
          
         
           ′ 
          
         
        
       
         n' 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.751892em; vertical-align: 0em;"></span><span class="mord"><span class="mord mathdefault">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.751892em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span>和<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           n 
          
          
          
            b 
           
          
            e 
           
          
            n 
           
          
            t 
           
          
         
        
       
         n_{bent} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.58056em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathdefault">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">b</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>方向应该相同。</strong></p> 
<p>假定细丝延伸的方向为<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         t 
        
       
      
        t 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.61508em; vertical-align: 0em;"></span><span class="mord mathdefault">t</span></span></span></span></span>，那么<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         t 
        
       
         、 
        
        
        
          n 
         
         
         
           b 
          
         
           e 
          
         
           n 
          
         
           t 
          
         
        
       
         、 
        
       
         l 
        
       
      
        t、n_{bent}、l 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.84444em; vertical-align: -0.15em;"></span><span class="mord mathdefault">t</span><span class="mord cjk_fallback">、</span><span class="mord"><span class="mord mathdefault">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">b</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord cjk_fallback">、</span><span class="mord mathdefault" style="margin-right: 0.01968em;">l</span></span></span></span></span>这三个方向应该共面！并且<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          n 
         
         
         
           b 
          
         
           e 
          
         
           n 
          
         
           t 
          
         
        
       
      
        n_{bent} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.58056em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathdefault">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">b</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>和<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         l 
        
       
      
        l 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.69444em; vertical-align: 0em;"></span><span class="mord mathdefault" style="margin-right: 0.01968em;">l</span></span></span></span></span>二者弧线垂直，如下图所示。</p> 
<p><img src="https://images2.imgbox.com/03/31/HikA5rxO_o.png" alt="在这里插入图片描述"></p> 
<p>通过简单的平面三角函数有：</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          l 
         
        
          ∗ 
         
         
         
           n 
          
          
          
            b 
           
          
            e 
           
          
            n 
           
          
            t 
           
          
         
        
          = 
         
        
          c 
         
        
          o 
         
        
          s 
         
        
          θ 
         
        
          = 
         
        
          s 
         
        
          i 
         
        
          n 
         
        
          ( 
         
         
         
           π 
          
         
           2 
          
         
        
          − 
         
        
          θ 
         
        
          ) 
         
        
          = 
         
         
          
          
            1 
           
          
            − 
           
          
            ( 
           
          
            l 
           
          
            ⋅ 
           
          
            t 
           
           
           
             ) 
            
           
             2 
            
           
          
          
         
        
       
         l*n_{bent} = cos\theta = sin(\frac{\pi}{2}-\theta)=\sqrt[]{1-(l\cdot t)^2} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.69444em; vertical-align: 0em;"></span><span class="mord mathdefault" style="margin-right: 0.01968em;">l</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.58056em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathdefault">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">b</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.69444em; vertical-align: 0em;"></span><span class="mord mathdefault">c</span><span class="mord mathdefault">o</span><span class="mord mathdefault">s</span><span class="mord mathdefault" style="margin-right: 0.02778em;">θ</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 1.79356em; vertical-align: -0.686em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">i</span><span class="mord mathdefault">n</span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.10756em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">2</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em;">π</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathdefault" style="margin-right: 0.02778em;">θ</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 1.24em; vertical-align: -0.256125em;"></span><span class="mord sqrt"><span class="root"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.43665em;"><span class="" style="top: -2.43665em;"><span class="pstrut" style="height: 2em;"></span><span class="sizing reset-size6 size1 mtight"><span class="mord mtight"></span></span></span></span></span></span></span><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.983875em;"><span class="svg-align" style="top: -3.2em;"><span class="pstrut" style="height: 3.2em;"></span><span class="mord" style="padding-left: 1em;"><span class="mord">1</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.01968em;">l</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord mathdefault">t</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.740108em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span class="" style="top: -2.94388em;"><span class="pstrut" style="height: 3.2em;"></span><span class="hide-tail" style="min-width: 1.02em; height: 1.28em;"> 
            <svg width="400em" height="1.28em" viewbox="0 0 400000 1296" preserveaspectratio="xMinYMin slice"> 
             <path d="M263,681c0.7,0,18,39.7,52,119c34,79.3,68.167,
158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120c340,-704.7,510.7,-1060.3,512,-1067
c4.7,-7.3,11,-11,19,-11H40000v40H1012.3s-271.3,567,-271.3,567c-38.7,80.7,-84,
175,-136,283c-52,108,-89.167,185.3,-111.5,232c-22.3,46.7,-33.8,70.3,-34.5,71
c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1s-109,-253,-109,-253c-72.7,-168,-109.3,
-252,-110,-252c-10.7,8,-22,16.7,-34,26c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26
s76,-59,76,-59s76,-60,76,-60z M1001 80H40000v40H1012z"></path> 
            </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.256125em;"><span class=""></span></span></span></span></span></span></span></span></span></span></p> 
<p>类似有：</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          h 
         
        
          ∗ 
         
         
         
           n 
          
          
          
            b 
           
          
            e 
           
          
            n 
           
          
            t 
           
          
         
        
          = 
         
         
          
          
            1 
           
          
            − 
           
          
            ( 
           
          
            h 
           
          
            ⋅ 
           
          
            t 
           
           
           
             ) 
            
           
             2 
            
           
          
          
         
        
       
         h*n_{bent} = \sqrt[]{1-(h\cdot t)^2} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.69444em; vertical-align: 0em;"></span><span class="mord mathdefault">h</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.58056em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathdefault">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">b</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 1.24em; vertical-align: -0.256125em;"></span><span class="mord sqrt"><span class="root"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.43665em;"><span class="" style="top: -2.43665em;"><span class="pstrut" style="height: 2em;"></span><span class="sizing reset-size6 size1 mtight"><span class="mord mtight"></span></span></span></span></span></span></span><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.983875em;"><span class="svg-align" style="top: -3.2em;"><span class="pstrut" style="height: 3.2em;"></span><span class="mord" style="padding-left: 1em;"><span class="mord">1</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mopen">(</span><span class="mord mathdefault">h</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord mathdefault">t</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.740108em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span class="" style="top: -2.94388em;"><span class="pstrut" style="height: 3.2em;"></span><span class="hide-tail" style="min-width: 1.02em; height: 1.28em;"> 
            <svg width="400em" height="1.28em" viewbox="0 0 400000 1296" preserveaspectratio="xMinYMin slice"> 
             <path d="M263,681c0.7,0,18,39.7,52,119c34,79.3,68.167,
158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120c340,-704.7,510.7,-1060.3,512,-1067
c4.7,-7.3,11,-11,19,-11H40000v40H1012.3s-271.3,567,-271.3,567c-38.7,80.7,-84,
175,-136,283c-52,108,-89.167,185.3,-111.5,232c-22.3,46.7,-33.8,70.3,-34.5,71
c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1s-109,-253,-109,-253c-72.7,-168,-109.3,
-252,-110,-252c-10.7,8,-22,16.7,-34,26c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26
s76,-59,76,-59s76,-60,76,-60z M1001 80H40000v40H1012z"></path> 
            </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.256125em;"><span class=""></span></span></span></span></span></span></span></span></span></span></p> 
<p>因此，我们用<strong>细丝方向的延伸t</strong>，来代替法线方向<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          n 
         
         
         
           b 
          
         
           e 
          
         
           n 
          
         
           t 
          
         
        
       
      
        n_{bent} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.58056em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathdefault">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">b</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>来进行各向异性高光的计算。</p> 
<p>切线方向他是指头发丝的几何切线。它就是一个向量。和模型切空间的tangent不是相等关系。</p> 
<p><strong>切线是垂于法线的一条向量。</strong> 但由于有无数条，所以最终通过UV坐标的方向来确定。</p> 
<p>可以通过让美术<strong>沿着发丝生长的方向去展开模型uv坐标的u或者v的值，<strong>使得这个方向恰好就是</strong>切线空间（tangent space）中的切线方向</strong>（因为切线的方向就是uv坐标中u或者v增长的方向）。</p> 
<p>经过前文的推导，不同于常规的光照方程使用的法线进行这里的高光计算。</p> 
<p>这里采用的是切线参与高光的光照计算。下图展示了所有需要用到的向量。</p> 
<p><img src="https://images2.imgbox.com/c8/59/wxst8T7A_o.png" alt="在这里插入图片描述"></p> 
<p>在每根头发的固定点处，T总是保持不变的，N是随视线V变化而变化的。</p> 
<p>在一个被渲染的点处，<strong>其法线在各个视线（View）方向是不同的</strong>，这大概所谓就是的“各向异性“！</p> 
<p>而我们之所以要有T就是为了计算出这个隐藏在背后的法线N。当然，我们不需要计算出这个N的确切值，其蕴含在T和H的正弦值中，V蕴含在H中。</p> 
<h5><a id="312_KajiyaKay_323"></a>3.1.2 Kajiya-Kay经验模型</h5> 
<p>卡吉雅模型是一种经验模型，对头发高光的一种拟合模型。</p> 
<p>该模型解决了以下的问题：</p> 
<ul><li>头发各向异性高光，即天使环效果。</li><li>W型高光效果。</li></ul> 
<p>Kajiya-Kay模型，目前大都采用<a href="https://link.zhihu.com/?target=http%3A//developer.amd.com/wordpress/media/2012/10/Scheuermann_HairRendering.pdf" rel="nofollow">Scheuermann_HairRendering</a>的双层高光模型：</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          d 
         
        
          i 
         
        
          f 
         
        
          f 
         
        
          u 
         
        
          s 
         
        
          e 
         
        
          = 
         
         
         
           K 
          
         
           d 
          
         
        
          ∗ 
         
        
          l 
         
        
          e 
         
        
          r 
         
        
          p 
         
        
          ( 
         
        
          0.25 
         
        
          , 
         
        
          1.0 
         
        
          , 
         
        
          n 
         
        
          ⋅ 
         
        
          l 
         
        
          ) 
         
        
       
         diffuse = K_d \ast lerp(0.25,1.0,n \cdot l) 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.88888em; vertical-align: -0.19444em;"></span><span class="mord mathdefault">d</span><span class="mord mathdefault">i</span><span class="mord mathdefault" style="margin-right: 0.10764em;">f</span><span class="mord mathdefault" style="margin-right: 0.10764em;">f</span><span class="mord mathdefault">u</span><span class="mord mathdefault">s</span><span class="mord mathdefault">e</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: -0.07153em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">d</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathdefault" style="margin-right: 0.01968em;">l</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right: 0.02778em;">r</span><span class="mord mathdefault">p</span><span class="mopen">(</span><span class="mord">0</span><span class="mord">.</span><span class="mord">2</span><span class="mord">5</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord">1</span><span class="mord">.</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathdefault" style="margin-right: 0.01968em;">l</span><span class="mclose">)</span></span></span></span></span></span></p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          s 
         
        
          p 
         
        
          e 
         
        
          c 
         
        
          u 
         
        
          l 
         
        
          a 
         
        
          r 
         
        
          = 
         
         
         
           K 
          
          
          
            s 
           
          
            1 
           
          
         
        
          ∗ 
         
        
          s 
         
        
          m 
         
        
          o 
         
        
          o 
         
        
          t 
         
        
          h 
         
        
          s 
         
        
          t 
         
        
          e 
         
        
          p 
         
        
          ( 
         
        
          − 
         
        
          1 
         
        
          , 
         
        
          0 
         
        
          , 
         
        
          d 
         
        
          o 
         
        
          t 
         
        
          ( 
         
        
          t 
         
        
          1 
         
        
          , 
         
        
          h 
         
        
          ) 
         
        
          ) 
         
        
          ∗ 
         
        
          s 
         
        
          i 
         
        
          n 
         
        
          ( 
         
        
          t 
         
        
          1 
         
        
          , 
         
        
          h 
         
         
         
           ) 
          
          
          
            p 
           
          
            1 
           
          
         
        
          + 
         
         
         
           K 
          
          
          
            s 
           
          
            2 
           
          
         
        
          ∗ 
         
        
          s 
         
        
          m 
         
        
          o 
         
        
          o 
         
        
          t 
         
        
          h 
         
        
          s 
         
        
          t 
         
        
          e 
         
        
          p 
         
        
          ( 
         
        
          − 
         
        
          1 
         
        
          , 
         
        
          0 
         
        
          , 
         
        
          d 
         
        
          o 
         
        
          t 
         
        
          ( 
         
        
          t 
         
        
          2 
         
        
          , 
         
        
          h 
         
        
          ) 
         
        
          ) 
         
        
          ∗ 
         
        
          s 
         
        
          i 
         
        
          n 
         
        
          ( 
         
        
          t 
         
        
          2 
         
        
          , 
         
        
          h 
         
         
         
           ) 
          
          
          
            p 
           
          
            2 
           
          
         
        
       
         specular = K_{s1} * smoothstep(-1,0,dot(t1,h))*sin(t1,h)^{p1} + K_{s2} * smoothstep(-1,0,dot(t2,h))*sin(t2,h)^{p2} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.88888em; vertical-align: -0.19444em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">p</span><span class="mord mathdefault">e</span><span class="mord mathdefault">c</span><span class="mord mathdefault">u</span><span class="mord mathdefault" style="margin-right: 0.01968em;">l</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right: 0.02778em;">r</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: -0.07153em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">m</span><span class="mord mathdefault">o</span><span class="mord mathdefault">o</span><span class="mord mathdefault">t</span><span class="mord mathdefault">h</span><span class="mord mathdefault">s</span><span class="mord mathdefault">t</span><span class="mord mathdefault">e</span><span class="mord mathdefault">p</span><span class="mopen">(</span><span class="mord">−</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord mathdefault">d</span><span class="mord mathdefault">o</span><span class="mord mathdefault">t</span><span class="mopen">(</span><span class="mord mathdefault">t</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord mathdefault">h</span><span class="mclose">)</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1.11411em; vertical-align: -0.25em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">i</span><span class="mord mathdefault">n</span><span class="mopen">(</span><span class="mord mathdefault">t</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord mathdefault">h</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.864108em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">p</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: -0.07153em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">m</span><span class="mord mathdefault">o</span><span class="mord mathdefault">o</span><span class="mord mathdefault">t</span><span class="mord mathdefault">h</span><span class="mord mathdefault">s</span><span class="mord mathdefault">t</span><span class="mord mathdefault">e</span><span class="mord mathdefault">p</span><span class="mopen">(</span><span class="mord">−</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord mathdefault">d</span><span class="mord mathdefault">o</span><span class="mord mathdefault">t</span><span class="mopen">(</span><span class="mord mathdefault">t</span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord mathdefault">h</span><span class="mclose">)</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1.11411em; vertical-align: -0.25em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">i</span><span class="mord mathdefault">n</span><span class="mopen">(</span><span class="mord mathdefault">t</span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord mathdefault">h</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.864108em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">p</span><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></span></span></p> 
<p>这里是对原始模型的改进。</p> 
<ol><li>将diffuse改成了卡通渲染中Wrapped diffuse。这是因为传统的Kajiya-Kay的diffuse项太亮。没有考虑到头发的自阴影（即可以考虑V（θ）函数）。</li><li>高光改为了两层高光，其中一层高光是有颜色的。另一层高光是没有颜色的。且两层高光相互错开一些。这是基于实际的观察。</li></ol> 
<p>如下图所示，可以看出发白的一层是没有颜色的。另一层发黄的是有颜色的高光。</p> 
<p><img src="https://images2.imgbox.com/64/31/9wDL34xB_o.png" alt="在这里插入图片描述"></p> 
<p>若使用相同的切线，两层高光必定重合，为了让双层高光错开，使用shiftedT（对切线在法线方向去偏移）。</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           T 
          
          
          
            s 
           
          
            h 
           
          
            i 
           
          
            f 
           
          
            t 
           
          
            e 
           
          
            d 
           
          
         
        
          = 
         
        
          T 
         
        
          + 
         
        
          s 
         
        
          h 
         
        
          i 
         
        
          f 
         
        
          t 
         
        
          ∗ 
         
        
          N 
         
        
       
         T_{shifted} = T + shift * N 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.969438em; vertical-align: -0.286108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="mord mathdefault mtight">h</span><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right: 0.10764em;">f</span><span class="mord mathdefault mtight">t</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.286108em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.76666em; vertical-align: -0.08333em;"></span><span class="mord mathdefault" style="margin-right: 0.13889em;">T</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.88888em; vertical-align: -0.19444em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">h</span><span class="mord mathdefault">i</span><span class="mord mathdefault" style="margin-right: 0.10764em;">f</span><span class="mord mathdefault">t</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.68333em; vertical-align: 0em;"></span><span class="mord mathdefault" style="margin-right: 0.10903em;">N</span></span></span></span></span></span></p> 
<p><img src="https://images2.imgbox.com/0a/9d/5HeUmBQZ_o.png" alt="在这里插入图片描述"></p> 
<p>对于两层高光，shift值应该设置不同，但如果对于同一层高光来说。shift是一个固定的值，会导致头发光照区域边缘非常齐整，没有锯齿感。</p> 
<p>很多漫画中角色头发上的高光区域的边缘就有很明显地不规则状锯齿，也是对现实世界的观察。</p> 
<p><img src="https://images2.imgbox.com/d4/7e/cVcLp3gT_o.jpg" alt="在这里插入图片描述"></p> 
<p>为了要设置为不同值，因此可以使用一张切线扰动图。</p> 
<p><img src="https://images2.imgbox.com/06/18/nTx4kzHt_o.jpg" alt="在这里插入图片描述"></p> 
<p>从而对<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         s 
        
       
         h 
        
       
         f 
        
       
         i 
        
       
         t 
        
       
      
        shfit 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.88888em; vertical-align: -0.19444em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">h</span><span class="mord mathdefault" style="margin-right: 0.10764em;">f</span><span class="mord mathdefault">i</span><span class="mord mathdefault">t</span></span></span></span></span>值修改：</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          s 
         
        
          h 
         
        
          i 
         
        
          f 
         
        
          t 
         
        
          = 
         
        
          c 
         
        
          o 
         
        
          n 
         
        
          s 
         
        
          t 
         
        
          S 
         
        
          h 
         
        
          i 
         
        
          f 
         
        
          t 
         
        
          + 
         
        
          ( 
         
        
          t 
         
        
          e 
         
        
          x 
         
        
          t 
         
        
          u 
         
        
          r 
         
        
          e 
         
        
          ( 
         
        
          s 
         
        
          h 
         
        
          i 
         
        
          f 
         
        
          t 
         
        
          T 
         
        
          e 
         
        
          x 
         
        
          , 
         
        
          u 
         
        
          v 
         
        
          ) 
         
        
          − 
         
        
          0.5 
         
        
          ) 
         
        
       
         shift = constShift + (texture(shiftTex,uv)-0.5) 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.88888em; vertical-align: -0.19444em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">h</span><span class="mord mathdefault">i</span><span class="mord mathdefault" style="margin-right: 0.10764em;">f</span><span class="mord mathdefault">t</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.88888em; vertical-align: -0.19444em;"></span><span class="mord mathdefault">c</span><span class="mord mathdefault">o</span><span class="mord mathdefault">n</span><span class="mord mathdefault">s</span><span class="mord mathdefault">t</span><span class="mord mathdefault" style="margin-right: 0.05764em;">S</span><span class="mord mathdefault">h</span><span class="mord mathdefault">i</span><span class="mord mathdefault" style="margin-right: 0.10764em;">f</span><span class="mord mathdefault">t</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathdefault">t</span><span class="mord mathdefault">e</span><span class="mord mathdefault">x</span><span class="mord mathdefault">t</span><span class="mord mathdefault">u</span><span class="mord mathdefault" style="margin-right: 0.02778em;">r</span><span class="mord mathdefault">e</span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mord mathdefault">h</span><span class="mord mathdefault">i</span><span class="mord mathdefault" style="margin-right: 0.10764em;">f</span><span class="mord mathdefault">t</span><span class="mord mathdefault" style="margin-right: 0.13889em;">T</span><span class="mord mathdefault">e</span><span class="mord mathdefault">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord mathdefault">u</span><span class="mord mathdefault" style="margin-right: 0.03588em;">v</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">5</span><span class="mclose">)</span></span></span></span></span></span></p> 
<p>这里为什么要-0.5呢？</p> 
<p>因为纹理采样出的值范围为[0,1]，减去-0.5变为[-0.5,0.5]，有正有负，可以让T向N或N的反方向随机偏移。因此实现W型高光。</p> 
<p>两个主要的函数：</p> 
<pre><code class="prism language-c++">// 偏移切线
float3 ShiftTangent(float3 T, float3 N, float shift)
{
    float3 shiftedT = T + (shift * N);
    return normalize(shiftedT);
}

// 发丝高光计算函数
float StrandSpecular(float3 T, float3 V, float L, float exponent)
{
    float3 H = normalize(L + V);
    float dotTH = dot(T, H);
    float sinTH = sqrt(1.0 - dotTH*dotTH);
    float dirAtten = smoothstep(-1.0, 0.0, dot(T, H));
    return dirAtten * pow(sinTH, exponent);
}
</code></pre> 
<p>其中，对于<strong>方向衰减系数dirAtten的计算</strong>：</p> 
<pre><code class="prism language-c++">float dirAtten = smoothstep(-1., 0., dotTH);
</code></pre> 
<p>对于为什么要这样计算，<a href="https://zhuanlan.zhihu.com/p/341317623" rel="nofollow">对各向异性高光的理解</a>作出了解释：</p> 
<p><strong>方向衰减系数</strong>涉及到两个方向，一个是光源的方向L，一个是视线方向V，它们都蕴含在H中。</p> 
<p><code>smoothstep</code> 可以用来生成0到1的平滑过渡值，它也叫平滑阶梯函数。</p> 
<p><code>smoothstep</code> 的第一个参数为-1，表面dotTH<strong>小于或等于</strong>-1时候，dirAtten值为0。（dotTH最小为-1，不可能再小了）。</p> 
<p>什么时候dotTH为-1呢？</p> 
<ul><li>H的方向恰好和T的方向相反时，这时，T和H的夹角为180度。</li></ul> 
<p><code>smoothstep</code> 的第一个参数为0，表明当dotTH<strong>大于或等于</strong>0时，dirAtten值为1。</p> 
<p>注意，dotTH最大值为1，此时T和H的方向恰好相同，两者之间的夹角为0度。</p> 
<p>所以，<code>smoothstep(-1., 0., dotTH)</code>的作用：取<strong>和切线T角夹在0至180度之间的H</strong>。</p> 
<p>当T和H之间的夹角不在这个范围内时，必然出现H和对应N的点积小于0，即<strong>此时高光为0</strong> (此时光源照不到当前着色点或相机看不到当前着色点)，此时dirAtten的值就应当为0(即没有高光)。</p> 
<p><a href="https://zhuanlan.zhihu.com/p/43248692" rel="nofollow">头发效果研究笔记</a> 基于Kajiya-Kay Model通过不同贴图和参数调节调整了许多效果，可以进行查看学习。</p> 
<p><a href="https://zhuanlan.zhihu.com/p/65145287" rel="nofollow">使用Kajiya-Kay模型的头发渲染</a> 中提到了除了使用Kajiya-Kay模型。</p> 
<p>还提到，可以使用<strong>GGX各向异性法线分布函数</strong>和<strong>Ward各向异性法线分布函数</strong>。</p> 
<pre><code class="prism language-c++">float GGXAnisotropicNormalDistribution(float anisotropic, float roughness, float NdotH, float HdotX, float HdotY, float SpecularPower, float c)
{
	float aspect = sqrt(1.0 - 0.9 * anisotropic);
	float roughnessSqr = roughness * roughness;
	float NdotHSqr = NdotH * NdotH;
	float ax = roughnessSqr / aspect;
	float ay = roughnessSqr * aspect;
	float d = HdotX * HdotX / (ax * ax) + HdotY * HdotY / (ay * ay) + NdotHSqr;
	return 1 / (3.14159 * ax * ay * d * d);
}

float sqr(float x) {
	return x * x;
}

float WardAnisotropicNormalDistribution(float anisotropic, float NdotL, float NdotV, float NdotH, float HdotX, float HdotY) {
	float aspect = sqrt(1.0h - anisotropic * 0.9h);
	float roughnessSqr = (1 - 0.5);
	roughnessSqr *= roughnessSqr;
	float X = roughnessSqr / aspect;
	float Y = roughnessSqr * aspect;
	float exponent = -(sqr(HdotX / X) + sqr(HdotY / Y)) / sqr(NdotH);
	float Distribution = 1.0 / (4.0 * 3.14159265 * X * Y * sqrt(NdotL * NdotV));
	Distribution *= exp(exponent);
	return Distribution;
}
</code></pre> 
<p><a href="https://zhuanlan.zhihu.com/p/295347623" rel="nofollow">记·天刀手游角色渲染分析</a>中就拆解头发的渲染实现，采用GGX各向异性高光，分别以H、V、V的偏移三个参数分三次计算高光和漫反射并叠加。</p> 
<p><img src="https://images2.imgbox.com/e9/45/lgrrGfUO_o.jpg" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>笔者也截帧过天刀手游，发现确实如上述实现方式。</p> 
</blockquote> 
<p>小结：</p> 
<p>基于Kajiya-Kay模型的毛发渲染至今仍然在游戏中大量的使用。</p> 
<p>它的优点是计算性能也比较好，缺点是整个模型仍然是一个经验公式，并不太符合近年来基于物理渲染的概念，也无法做到能量守恒。</p> 
<h5><a id="313_KajiyaKay_476"></a>3.1.3 基于Kajiya-Kay的卡通头发</h5> 
<p>效果展示</p> 
<p><img src="https://images2.imgbox.com/2b/c1/mpAeEX9i_o.png" alt="在这里插入图片描述"></p> 
<p>基于Kajiya Kay模型：</p> 
<ul><li>Diffuse采用half lambert，避免背光面会有死黑问题；</li><li>Specular采用Kajiya-Kay模型，采用曲线控制高光带的形状；</li></ul> 
<p><em><strong>漫反射</strong></em></p> 
<pre><code class="prism language-c++">float NdotL = dot(N,L);
float halfLambert = (NotL+1)/2;
halfLambert = lerp(0.25,1,halfLambert);
float3 diffuse = albedoTexture.rgb * BaseColor * halfLambert;
</code></pre> 
<p><em><strong>各向異性高光</strong></em></p> 
<p>各向异性高光的计算和采用的就是3.1.2中介绍的两层高光模型。</p> 
<p>通过控制输入<code>StrandSpecular</code> 函数的<strong>Power值</strong>从而实现形状的控制。</p> 
<p>头发上每个点都有一个PowerOffset，来控制形状，通过以下<code>CalculatePower</code>映射成为一个Power值。</p> 
<pre><code class="prism language-c++">float CalculatePower(float PowerBegin,float PowerEnd,float PowerOffset,float PowerScale)
{
    float newPower = PowerEnd + (PowerBegin-PowerEnd) * PowerOffset;
    return PowerScale * newPower;
}
</code></pre> 
<p>同理，对切线方向的偏移值shift也可以加入这种细节控制。</p> 
<p>当然，还有Mask贴图控制高光出现的位置。</p> 
<p><img src="https://images2.imgbox.com/f2/71/JMnQbc1W_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="32_Marschner_Model_518"></a>3.2 Marschner Model</h4> 
<p>总的来说，Kajiya-Kay不是基于物理的，不是能量守恒的，仅仅是一个经验模型。</p> 
<p>Marschner是基于物理的毛发渲染模型，是Stephen R. Marschner等人共同发表的论文<a href="http://graphics.stanford.edu/papers/hair/hair-sg03final.pdf" rel="nofollow">《Light Scattering from Human Hair Fibers》</a>内的方法。</p> 
<p>其<strong>基于头发纤维的结构</strong>，进行了一个较为准确的物理分析得到的计算方法。</p> 
<p>头发纤维从微观角度来看，实际上是一个多层的结构，它的最外层像鳞片一样（很像微表面理论中看到的<strong>粗糙的表面</strong>）。</p> 
<p>光线在穿过层层头发纤维内部的过程中也会发生<strong>折射，反射</strong>等，因此我们看到的最终头发呈现的颜色实际上是多条光路综合作用的结果。</p> 
<p>基于为头发纤维的物理结构，抽象出如下图所示的光照模型：</p> 
<p><img src="https://images2.imgbox.com/d3/2c/mt4GbGtp_o.png" alt="在这里插入图片描述"></p> 
<p>其中，作者考虑了光照贡献最大的三条光路：<strong>R，TT，TRT。（R表示反射，T表示透射）</strong>。</p> 
<p>表皮鳞片的倾斜会让射线R（反）和射线TRT（透反透）稍微偏离理想镜面反射方向。二者稍稍错开，形成两个视觉上可区分的亮点。</p> 
<p>R是由于表面高光反射，因此R为白色。而TRT是由穿过头发内进过吸收反射出的，因此有纤维的颜色。这也解释了为什么Kajiya-Kay的两个反射区及颜色。</p> 
<p>TT（透透）是两次透射。</p> 
<h5><a id="321__544"></a>3.2.1 着色模型公式</h5> 
<p>具体的过程请参考 <a href="https://zhuanlan.zhihu.com/p/147768981" rel="nofollow">虚幻4渲染编程(人物篇)【第二卷：Human Hair Shading】</a>。</p> 
<p>这里直接写一下推导结果。</p> 
<p>由在三维空间处理头发光线的几何问题比较困难，将头发切成横向和纵向的。</p> 
<p><img src="https://images2.imgbox.com/8e/9a/om8Swwe1_o.jpg" alt="在这里插入图片描述"></p> 
<p>根据光路分析，又结合光路可能即包含纵向散射，又包含横向散射，因此得到头发上某一点的BSDF：</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          S 
         
        
          = 
         
         
         
           ∑ 
          
         
           p 
          
          
         
         
         
           S 
          
         
           p 
          
         
        
       
         S=\sum_{p}^{}S_p 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.68333em; vertical-align: 0em;"></span><span class="mord mathdefault" style="margin-right: 0.05764em;">S</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 2.73612em; vertical-align: -1.38611em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.35001em;"><span class="" style="top: -1.89999em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">p</span></span></span></span><span class="" style="top: -3.05001em;"><span class="pstrut" style="height: 3.05em;"></span><span class=""><span class="mop op-symbol large-op">∑</span></span></span><span class="" style="top: -4.30001em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.38611em;"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.05764em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.286108em;"><span class=""></span></span></span></span></span></span></span></span></span></span></span></p> 
<p>其中，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          S 
         
        
          p 
         
        
       
         = 
        
        
        
          M 
         
        
          p 
         
        
       
         ∗ 
        
        
        
          N 
         
        
          p 
         
        
       
      
        S_p = M_p \ast N_p 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.969438em; vertical-align: -0.286108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.05764em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.286108em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.969438em; vertical-align: -0.286108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.10903em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.286108em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.969438em; vertical-align: -0.286108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.10903em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.286108em;"><span class=""></span></span></span></span></span></span></span></span></span></span>，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         p 
        
       
         = 
        
       
         R 
        
       
         ， 
        
       
         T 
        
       
         R 
        
       
         T 
        
       
         ， 
        
       
         T 
        
       
         T 
        
       
      
        p=R，TRT，TT 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.19444em;"></span><span class="mord mathdefault">p</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.68333em; vertical-align: 0em;"></span><span class="mord mathdefault" style="margin-right: 0.00773em;">R</span><span class="mord cjk_fallback">，</span><span class="mord mathdefault" style="margin-right: 0.13889em;">T</span><span class="mord mathdefault" style="margin-right: 0.00773em;">R</span><span class="mord mathdefault" style="margin-right: 0.13889em;">T</span><span class="mord cjk_fallback">，</span><span class="mord mathdefault" style="margin-right: 0.13889em;">T</span><span class="mord mathdefault" style="margin-right: 0.13889em;">T</span></span></span></span></span>。M为纵向散射函数，N为方位散射函数。</p> 
<p><em><strong>纵向散射函数M</strong></em></p> 
<p>在实际中，使用一个标准差为<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         β 
        
       
      
        \beta 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.88888em; vertical-align: -0.19444em;"></span><span class="mord mathdefault" style="margin-right: 0.05278em;">β</span></span></span></span></span>标准高斯函数。</p> 
<p>模型参数集合如下：</p> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-c0ZzABjW-1624366548642)(images/18-Model-M-param.png)]</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          g 
         
        
          ( 
         
        
          σ 
         
        
          , 
         
        
          x 
         
        
          − 
         
        
          μ 
         
        
          ) 
         
        
          = 
         
         
         
           1 
          
          
          
            2 
           
          
            π 
           
           
           
             σ 
            
           
             2 
            
           
          
         
         
         
           e 
          
          
          
            − 
           
           
            
            
              ( 
             
            
              x 
             
            
              − 
             
            
              μ 
             
             
             
               ) 
              
             
               2 
              
             
            
            
            
              2 
             
             
             
               σ 
              
             
               2 
              
             
            
           
          
         
        
       
         g(\sigma ,x-\mu )=\frac{1}{2\pi \sigma ^2}e^{-\frac{(x-\mu)^2}{2\sigma^2} } 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathdefault" style="margin-right: 0.03588em;">g</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.03588em;">σ</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathdefault">μ</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 2.01509em; vertical-align: -0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.32144em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">2</span><span class="mord mathdefault" style="margin-right: 0.03588em;">π</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em;">σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.740108em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mord mathdefault">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 1.32909em;"><span class="" style="top: -3.45342em; margin-right: 0.05em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.25096em;"><span class="" style="top: -2.50619em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em;">σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.93844em;"><span class="" style="top: -2.93844em; margin-right: 0.1em;"><span class="pstrut" style="height: 2.64444em;"></span><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span class="" style="top: -3.2255em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line mtight" style="border-bottom-width: 0.049em;"></span></span><span class="" style="top: -3.50207em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathdefault mtight">x</span><span class="mbin mtight">−</span><span class="mord mathdefault mtight">μ</span><span class="mclose mtight"><span class="mclose mtight">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 1.04844em;"><span class="" style="top: -3.04844em; margin-right: 0.1em;"><span class="pstrut" style="height: 2.64444em;"></span><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.493814em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></p> 
<p>可以得到：</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           M 
          
         
           R 
          
         
        
          ( 
         
         
         
           θ 
          
         
           h 
          
         
        
          ) 
         
        
          = 
         
        
          g 
         
        
          ( 
         
         
         
           β 
          
         
           R 
          
         
        
          , 
         
         
         
           θ 
          
         
           h 
          
         
        
          − 
         
         
         
           α 
          
         
           R 
          
         
        
          ) 
         
        
       
         M_R(\theta _h) = g(\beta_R,\theta_h-\alpha_R) 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: -0.10903em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.00773em;">R</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: -0.02778em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">h</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathdefault" style="margin-right: 0.03588em;">g</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.05278em;">β</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: -0.05278em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.00773em;">R</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: -0.02778em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">h</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: -0.0037em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.00773em;">R</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></span></p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           M 
          
          
          
            T 
           
          
            T 
           
          
         
        
          ( 
         
         
         
           θ 
          
         
           h 
          
         
        
          ) 
         
        
          = 
         
        
          g 
         
        
          ( 
         
         
         
           β 
          
          
          
            T 
           
          
            T 
           
          
         
        
          , 
         
         
         
           θ 
          
         
           h 
          
         
        
          − 
         
         
         
           α 
          
          
          
            T 
           
          
            T 
           
          
         
        
          ) 
         
        
       
         M_{TT}(\theta _h) = g(\beta_{TT},\theta_h-\alpha_{TT}) 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: -0.10903em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.13889em;">T</span><span class="mord mathdefault mtight" style="margin-right: 0.13889em;">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: -0.02778em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">h</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathdefault" style="margin-right: 0.03588em;">g</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.05278em;">β</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: -0.05278em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.13889em;">T</span><span class="mord mathdefault mtight" style="margin-right: 0.13889em;">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: -0.02778em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">h</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: -0.0037em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.13889em;">T</span><span class="mord mathdefault mtight" style="margin-right: 0.13889em;">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></span></p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           M 
          
          
          
            T 
           
          
            R 
           
          
            T 
           
          
         
        
          ( 
         
         
         
           θ 
          
         
           h 
          
         
        
          ) 
         
        
          = 
         
        
          g 
         
        
          ( 
         
         
         
           β 
          
          
          
            T 
           
          
            R 
           
          
            T 
           
          
         
        
          , 
         
         
         
           θ 
          
         
           h 
          
         
        
          − 
         
         
         
           α 
          
          
          
            T 
           
          
            R 
           
          
            T 
           
          
         
        
          ) 
         
        
       
         M_{TRT}(\theta _h) = g(\beta_{TRT},\theta_h-\alpha_{TRT}) 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: -0.10903em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.13889em;">T</span><span class="mord mathdefault mtight" style="margin-right: 0.00773em;">R</span><span class="mord mathdefault mtight" style="margin-right: 0.13889em;">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: -0.02778em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">h</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathdefault" style="margin-right: 0.03588em;">g</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.05278em;">β</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: -0.05278em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.13889em;">T</span><span class="mord mathdefault mtight" style="margin-right: 0.00773em;">R</span><span class="mord mathdefault mtight" style="margin-right: 0.13889em;">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: -0.02778em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">h</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: -0.0037em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.13889em;">T</span><span class="mord mathdefault mtight" style="margin-right: 0.00773em;">R</span><span class="mord mathdefault mtight" style="margin-right: 0.13889em;">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></span></p> 
<p><em><strong>方位散射函数N</strong></em></p> 
<p>RR和TRT方位角散射函数分别简化为<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
         
         
           cos 
          
         
           ⁡ 
          
         
        
          2 
         
        
       
         ϕ 
        
       
      
        \cos^2 \phi 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.00855em; vertical-align: -0.19444em;"></span><span class="mop"><span class="mop">cos</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord mathdefault">ϕ</span></span></span></span></span>，TT方位角散射函数满足<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ϕ 
        
       
      
        \phi 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.88888em; vertical-align: -0.19444em;"></span><span class="mord mathdefault">ϕ</span></span></span></span></span>符合高斯分布，公式分别如下：</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           N 
          
         
           R 
          
         
        
          = 
         
        
          c 
         
        
          o 
         
         
         
           s 
          
         
           2 
          
         
        
          ϕ 
         
        
       
         N_{R}=cos^2 \phi 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: -0.10903em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.00773em;">R</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 1.05855em; vertical-align: -0.19444em;"></span><span class="mord mathdefault">c</span><span class="mord mathdefault">o</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.864108em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord mathdefault">ϕ</span></span></span></span></span></span></p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           N 
          
          
          
            T 
           
          
            T 
           
          
         
        
          = 
         
        
          g 
         
        
          ( 
         
        
          γ 
         
        
          , 
         
        
          π 
         
        
          − 
         
        
          ϕ 
         
        
          ) 
         
        
       
         N_{TT}=g(\gamma,\pi - \phi) 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: -0.10903em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.13889em;">T</span><span class="mord mathdefault mtight" style="margin-right: 0.13889em;">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathdefault" style="margin-right: 0.03588em;">g</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.05556em;">γ</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord mathdefault" style="margin-right: 0.03588em;">π</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathdefault">ϕ</span><span class="mclose">)</span></span></span></span></span></span></p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           N 
          
          
          
            T 
           
          
            R 
           
          
            T 
           
          
         
        
          = 
         
        
          c 
         
        
          o 
         
         
         
           s 
          
         
           2 
          
         
        
          ϕ 
         
        
       
         N_{TRT}=cos^2 \phi 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: -0.10903em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.13889em;">T</span><span class="mord mathdefault mtight" style="margin-right: 0.00773em;">R</span><span class="mord mathdefault mtight" style="margin-right: 0.13889em;">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 1.05855em; vertical-align: -0.19444em;"></span><span class="mord mathdefault">c</span><span class="mord mathdefault">o</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.864108em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord mathdefault">ϕ</span></span></span></span></span></span></p> 
<h5><a id="322_UE_595"></a>3.2.2 UE头发材质和着色器代码</h5> 
<p>虚幻引擎中的Hair着色模型采用的正是Marschner Model。</p> 
<p>在材质编辑器中将着色模型改为Hair。</p> 
<p><img src="https://images2.imgbox.com/6c/3d/dYAuYb2F_o.png" alt="在这里插入图片描述"></p> 
<p>Hair模式的材质输入节点与普通模式有所不同。</p> 
<p><img src="https://images2.imgbox.com/da/c9/xqKQ1zKm_o.png" alt="在这里插入图片描述"></p> 
<ul><li> <p><strong>Metallic变成了Scatter</strong>，控制着散射强度。</p> </li><li> <p><strong>Normal 变成了Tangent</strong>。这个切线是发丝的几何切线方向（指向发根）。</p> </li><li> <p><strong>Custom Data 0 变成了 Backlit</strong>。这个输入本应该是控制透光度，但是实际上并没有用到。</p> </li><li> <p>Opacity Mask，因为选了 Masked混合模式，所以有这个选项。可以使用 DitherTemporalAA 节点将半透明的部分变成网点，配合 TemporalAA 产生半透明的效果。虽然效果比真正的半透明差一点，但是不会产生排序问题。</p> </li></ul> 
<p><em><strong>UE头发材质的着色器代码</strong></em></p> 
<p>ShadingModels.ush的HairBxDF函数：</p> 
<ul><li>调用了HairShading函数</li></ul> 
<pre><code class="prism language-c++">FDirectLighting HairBxDF(FGBufferData GBuffer, half3 N, half3 V, half3 L, float Falloff, float NoL, FAreaLight AreaLight, FShadowTerms Shadow)
{
	const float3 BsdfValue = HairShading(GBuffer, L, V, N, Shadow.TransmissionShadow, Shadow.HairTransmittance, 1, 0, uint2(0, 0));

	FDirectLighting Lighting;
	Lighting.Diffuse = 0;
	Lighting.Specular = 0;
	Lighting.Transmission = AreaLight.FalloffColor * Falloff * BsdfValue;
	return Lighting;
}
</code></pre> 
<p>HairShading位于HairBsdf.ush文件。</p> 
<pre><code class="prism language-c++">// Hair BSDF
// Approximation to HairShadingRef using concepts from the following papers:
// [Marschner et al. 2003, "Light Scattering from Human Hair Fibers"]
// [Pekelis et al. 2015, "A Data-Driven Light Scattering Model for Hair"]

float3 HairShading( FGBufferData GBuffer, float3 L, float3 V, half3 N, float Shadow, FHairTransmittanceData HairTransmittance, float InBacklit, float Area, uint2 Random )
{
    // ...省略源码
}
</code></pre> 
<p>注：着色器中的N指的是实际为Tangent。<strong>// N is the vector parallel to hair pointing toward root</strong></p> 
<p>让我们具体的看下代码：</p> 
<p><strong>R、TT、TRT中的M项</strong></p> 
<p>公式中M项采用g，即标准高斯函数进行模拟。</p> 
<p><strong>期望中角度的偏移</strong>如下：</p> 
<pre><code class="prism language-c++">float Alpha[] =
{
    -Shift * 2,
    Shift,
    Shift * 4,
};	
</code></pre> 
<p>其中，R使用的是Shift，TT使用的是Alpha[1]，TRT使用的是Alpha[2]。</p> 
<p><strong>方差</strong>使用与粗糙度相关的值。</p> 
<pre><code class="prism language-c++">float ClampedRoughness = clamp(GBuffer.Roughness, 1/255.0f, 1.0f);
float B[] =
{
    Area + Pow2(ClampedRoughness),
    Area + Pow2(ClampedRoughness) / 2,
    Area + Pow2(ClampedRoughness) * 2,
};
</code></pre> 
<p>其中，R使用的是B[0]，TT使用的是B[1]，TRT使用的是B[2]。Area固定为0。roughness值越小则反射越集中强烈，值越大则越分散。</p> 
<p>三个项中的M分别计算如下：</p> 
<pre><code class="prism language-c++">// 对于R：
float Mp = Hair_g(B[0] * BScale, SinThetaL + SinThetaV - Shift);
// 对于TT：
float Mp = Hair_g( B[1], SinThetaL + SinThetaV - Alpha[1] );
// 对于TRT：
float Mp = Hair_g( B[2], SinThetaL + SinThetaV - Alpha[2] );
</code></pre> 
<p>其中，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          θ 
         
        
          h 
         
        
       
      
        \theta_h 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.84444em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: -0.02778em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">h</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>为SinThetaL + SinThetaV，该值和法平面和入射光线、摄像机方向的夹角有关。</p> 
<p><strong>R、TT、TRT中的N项</strong></p> 
<p>UE的头发对N项也是尽可能拟合。</p> 
<p>R中的N：</p> 
<pre><code class="prism language-c++">float Np = 0.25 * CosHalfPhi;
</code></pre> 
<p>CosHalfPhi，是方位角差的<strong>半角</strong>，计算如下：</p> 
<pre><code class="prism language-c++">const float CosPhi = dot(Lp,Vp) * rsqrt( dot(Lp,Lp) * dot(Vp,Vp) + 1e-4 );
const float CosHalfPhi = sqrt( saturate( 0.5 + 0.5 * CosPhi ) );
</code></pre> 
<p>TT项的N：</p> 
<pre><code class="prism language-c++">float Np = exp( -3.65 * CosPhi - 3.98 );
</code></pre> 
<p>TRT项的N：</p> 
<pre><code class="prism language-c++">float Np = exp( 17 * CosPhi - 16.78 );
</code></pre> 
<p><strong>R、TT、TRT中的其他部分</strong></p> 
<p>对于R：</p> 
<ul><li>R是直接反射，所以包含的是：普通镜面反射和菲涅尔项。因为光线没有进入发丝，所以没有头发的BaseColor。</li></ul> 
<pre><code class="prism language-c++">// Mp：纵向散射M。
float Mp = Hair_g(B[0] * BScale, SinThetaL + SinThetaV - Shift);
// Np：方位角散射N。
float Np = 0.25 * CosHalfPhi;
// Fp： 菲涅尔项。
float Fp = Hair_F(sqrt(saturate(0.5 + 0.5 * VoL)));
// GBuffer.Specular实际含义是Scatter，控制着散射强度。
S += Mp * Np * Fp * (GBuffer.Specular * 2) * lerp(1, Backlit, saturate(-VoL));
</code></pre> 
<p>对于TT：</p> 
<pre><code class="prism language-c++">S += Mp * Np * Fp * Tp * Backlit;
</code></pre> 
<ul><li>Mp：纵向散射M。</li><li>Np：方位角散射N。</li><li>Fp： 菲涅尔项。算了两次。</li><li>Tp： 相当于公式中的pow（cosθd，2）。</li><li>Backlit控制这一项的强度，即<strong>背光时头发的透光度</strong>。UE使用简单的公式拟合吸收因子。</li></ul> 
<p>对于TRT：</p> 
<pre><code class="prism language-c++">S += Mp * Np * Fp * Tp;
</code></pre> 
<ul><li>Mp：纵向散射M。</li><li>Np：方位角散射N。</li><li>Fp： 菲涅尔项。算了三次。</li><li>Tp： 也是使用了和TT项相同的拟合。</li></ul> 
<h3><a id="_787"></a>四、头发建模和制作技巧</h3> 
<p><a href="https://zhuanlan.zhihu.com/p/330259306" rel="nofollow">头发渲染的前世今生：如何在游戏中拥有一头迷人秀发？</a> 总结了一些制作技巧，对头发渲染的排序问题，Shader的优化。</p> 
<p>下面进行一部分简单的笔记记录。</p> 
<h4><a id="41__795"></a>4.1 头发模型建模</h4> 
<p>头发建模可分为两种：基于引导线、基于面片。</p> 
<p>左图为基于引导线，右图为基于面片。</p> 
<p><img src="https://images2.imgbox.com/01/54/cmO553SM_o.png" alt="在这里插入图片描述"></p> 
<p>实时基于线的头发渲染是非常困难：</p> 
<ul><li>发丝数量多，人体一般有8w-13w根头发。头发的种类繁多，形式多样，不同颜色的头发对光线的吸收不同。在角色的渲染中，复杂的头发渲染可能占用角色25%左右的渲染时间。</li></ul> 
<p>目前主流的hairwork也是将头发变成面片模型。</p> 
<p>手游制作头发主要分为2步骤：</p> 
<ol><li>Maya的XGen等工具制作头发模型和贴图（美术工作）。提升表现力上限更多的是靠模型和贴图。</li><li>应用游戏引擎的Shader来渲染（TA和程序工作）。<strong>解决的头发混叠、高光形状、动态光影及性能优化。</strong></li></ol> 
<ul><li><strong>头发的光影效果一般是以下效果的堆叠：边缘光RimLight、菲涅尔效应Fresnel、各项异性高光AnisotropicSpecularLight、全局光Global illumination。</strong></li><li>想要进一步提升，可以考虑加入环境光遮蔽AO，以及Transparency Map和Ramp Map。</li><li>后续还可以根据项目需求，定制Shader，比如添加间接光补偿indirect lighting。</li></ul> 
<h4><a id="42__820"></a>4.2 头发贴图</h4> 
<p>制作头发常用的贴图有以下几种：</p> 
<ul><li>Albedo：漫反射贴图</li><li>NormalMap：法线贴图</li><li>AO(Ambient Occlusion) Map：环境光遮蔽贴图</li><li>Shift Map：偏移贴图</li><li>Transparency Map：透明贴图</li><li>Ramp Map：渐变图</li></ul> 
<h4><a id="43__833"></a>4.3 毛发渲染的排序问题</h4> 
<p>在头发渲染中，深度排序（approximate depth sorting）是一个难题。</p> 
<p>毛发这种边缘半透明，且双面的材质是不能使用简单的alphaTest来渲染的。</p> 
<p>因此这样会使得毛发边缘看起来很粗糙。所以应该尽可能保证顺序正确使用alphaBlend（从后向前的顺序绘制才可以正确进行AlphaBlend）。</p> 
<p>优化的头发渲染排序方案如题所示，共分为4个Pass：</p> 
<p><strong>Pass1: 绘制不透明的部分</strong>（写深度）</p> 
<ul><li>开启Z-Write（深度写入），Z-Test模式为<strong>Less</strong>。</li><li>剔除背面的三角形。</li><li>使用Alpha-Test，关闭ColorBuffer写入。</li></ul> 
<p><strong>Pass2: 绘制不透明的部分</strong>（渲染前面的不透明部分）</p> 
<ul><li>关闭Z-Write，将Z-Test模式设置为<strong>Equal</strong>。</li><li>使用Alpha-Test，这次写ColorBuffer。</li></ul> 
<p><strong>Pass3：绘制半透明的背面部分</strong></p> 
<ul><li>关闭Z-Write，Z-Test模式改<strong>Less</strong>。</li><li>剔除front-face的面片。</li><li>绘制头发的背面（使用alpha blend的模式）。</li></ul> 
<p><strong>Pass4：绘制半透明的前面部分</strong></p> 
<ul><li>开启Z-Write ，Z-Test模式改Less。</li><li>剔除背面的三角形，绘制头发的正面（使用alpha blend的模式）。</li></ul> 
<p><img src="https://images2.imgbox.com/9e/33/tpam2sHr_o.png" alt="在这里插入图片描述"></p> 
<p>Pass1和Pass2原是可以合并在一起做的。之所以拆分为先写深度，再写颜色。是希望利用<strong>硬件的Early-Z Culling</strong>特性。</p> 
<ul><li><strong>如果一个Pass的话，就会修改深度，那么Early-Z就失效了！</strong></li></ul> 
<p>除此之外，<strong>关闭Color buffer的写入只修改Z buffer，会比同时写入Color buffer和Z buffer快2-4倍</strong>。</p> 
<p>这也是常说的<strong>使用Z-Prepass</strong>的前向渲染管线的原理。</p> 
<h3><a id="_877"></a>参考博文</h3> 
<ul><li> <p><a href="https://blog.csdn.net/u010281174/article/details/108963902">着色模型简介和实现（上）</a></p> </li><li> <p><a href="https://github.com/QianMo/PBR-White-Paper/blob/master/content/part%204/README.md">【基于物理的渲染（PBR）白皮书】（四）法线分布函数相关总结</a></p> </li><li> <p><a href="https://zhuanlan.zhihu.com/p/27313644" rel="nofollow">角色渲染技术——毛发及其他</a></p> </li><li> <p><a href="https://link.zhihu.com/?target=http%3A//developer.amd.com/wordpress/media/2012/10/Scheuermann_HairRendering.pdf" rel="nofollow">Scheuermann_HairRendering</a></p> </li><li> <p><a href="https://zhuanlan.zhihu.com/p/341317623" rel="nofollow">对各向异性高光的理解</a></p> </li><li> <p><a href="https://zhuanlan.zhihu.com/p/43248692" rel="nofollow">头发效果研究笔记</a></p> </li><li> <p><a href="https://zhuanlan.zhihu.com/p/295347623" rel="nofollow">记·天刀手游角色渲染分析</a></p> </li><li> <p><a href="https://www.cnblogs.com/timlly/p/11199385.html#412-marschner%E6%AF%9B%E5%8F%91%E6%B8%B2%E6%9F%93%E6%A8%A1%E5%9E%8B" rel="nofollow">剖析Unreal Engine超真实人类的渲染技术Part 3 - 毛发渲染及其它</a></p> </li><li> <p><a href="https://zhuanlan.zhihu.com/p/330259306" rel="nofollow">头发渲染的前世今生：如何在游戏中拥有一头迷人秀发？</a></p> </li><li> <p><a href="https://zhuanlan.zhihu.com/p/147768981" rel="nofollow">虚幻4渲染编程(人物篇)【第二卷：Human Hair Shading】</a></p> </li><li> <p><a href="https://www.jianshu.com/p/9a5b7fcc0300" rel="nofollow">UE4 毛发渲染参考文章</a></p> </li><li> <p><a href="https://www.jianshu.com/p/a16bfbd5cadc" rel="nofollow">UE4 Hair Shading</a></p> </li></ul>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/fc4e3fa74088acb6b132ab8ac632addd/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">kotlin之我又迷惑了</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9f911a12cedf76ed5ac205e0e38d57b8/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">用计算机怎么录音,电脑怎么录音？你知道电脑上的录音机在哪吗？</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>