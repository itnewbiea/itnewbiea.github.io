<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android Q 适配指南 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android Q 适配指南" />
<meta property="og:description" content="转载：https://blog.csdn.net/aiwusheng/article/details/103125117
Android Q 适配指南
官方文档：
https://developer.android.com/about/versions/10
在Android 10开始版本中，官方的改动较大，相应的开发者适配成本还是很高的。
这里按照2019.11.11 google android q workshop流程，大概说明一下Android Q适配需要注意的内容。虽然是大概介绍，但应该是目前最全的适配攻略了…
非SDK 接口
设备ID
外部存储
权限
新功能——夜间模式
一、非SDK接口
官方文档：针对非 SDK 接口的限制
官方从 Android 9（API 级别 28）开始，对应用使用的非 SDK 接口实施了限制。
如果你的APP通过引用非 SDK 接口或尝试使用反射或 JNI 来获取句柄，这些限制就会起作用。官方给出的解释是为了提升用户体验、降低应用崩溃风险。
1.1、非SDK接口检测工具
官方给出了一个检测工具，下载地址：veridex
veridex使用方法：
appcompat.sh --dex-file=apk.apk
1
1.2、blacklist、greylist、greylist-max-o、greylist-max-p含义
以上截图中，blacklist、greylist、greylist-max-o、greylist-max-p含义如下：
blacklist 黑名单：禁止使用的非SDK接口，运行时直接Crash（因此必须解决）
greylist 灰名单：即当前版本仍能使用的非SDK接口，但在下一版本中可能变成被限制的非SDK接口
greylist-max-o： 在targetSDK&lt;=O中能使用，但是在targetSDK&gt;=P中被禁止使用的非SDK接口
greylist-max-p： 在targetSDK&lt;=P中能使用，但是在targetSDK&gt;=Q中被禁止使用的非SDK接口
如果觉得我没有说清楚，可以看以下 2019.11.11 google android q workshop PPT 截图
1.3、Android Q 加固 与 热修复
关于加固与热修复，官方也提供了相应的API
加固
热修复
注：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/67cb151b3e2b0bed949fa0aa11a440eb/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-11-20T14:45:30+08:00" />
<meta property="article:modified_time" content="2019-11-20T14:45:30+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android Q 适配指南</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>转载：https://blog.csdn.net/aiwusheng/article/details/103125117<br> Android Q 适配指南<br> 官方文档：<br> https://developer.android.com/about/versions/10</p> 
<p>在Android 10开始版本中，官方的改动较大，相应的开发者适配成本还是很高的。<br> 这里按照2019.11.11 google android q workshop流程，大概说明一下Android Q适配需要注意的内容。虽然是大概介绍，但应该是目前最全的适配攻略了…</p> 
<p>非SDK 接口<br> 设备ID<br> 外部存储<br> 权限<br> 新功能——夜间模式<br> 一、非SDK接口<br> 官方文档：针对非 SDK 接口的限制</p> 
<p>官方从 Android 9（API 级别 28）开始，对应用使用的非 SDK 接口实施了限制。<br> 如果你的APP通过引用非 SDK 接口或尝试使用反射或 JNI 来获取句柄，这些限制就会起作用。官方给出的解释是为了提升用户体验、降低应用崩溃风险。</p> 
<p>1.1、非SDK接口检测工具<br> 官方给出了一个检测工具，下载地址：veridex</p> 
<p>veridex使用方法：</p> 
<p>appcompat.sh --dex-file=apk.apk<br> 1</p> 
<p><br> 1.2、blacklist、greylist、greylist-max-o、greylist-max-p含义<br> 以上截图中，blacklist、greylist、greylist-max-o、greylist-max-p含义如下：</p> 
<p>blacklist 黑名单：禁止使用的非SDK接口，运行时直接Crash（因此必须解决）<br> greylist 灰名单：即当前版本仍能使用的非SDK接口，但在下一版本中可能变成被限制的非SDK接口<br> greylist-max-o： 在targetSDK&lt;=O中能使用，但是在targetSDK&gt;=P中被禁止使用的非SDK接口<br> greylist-max-p： 在targetSDK&lt;=P中能使用，但是在targetSDK&gt;=Q中被禁止使用的非SDK接口<br> 如果觉得我没有说清楚，可以看以下 2019.11.11 google android q workshop PPT 截图</p> 
<p>1.3、Android Q 加固 与 热修复<br> 关于加固与热修复，官方也提供了相应的API</p> 
<p>加固</p> 
<p><br> 热修复</p> 
<p><br> 注：<br> 未适配Android Q的应用，若使用了blacklist 相关接口，在Android Q系统上打开时，会直接Crash！<br> 未适配Android Q的应用，若使用了blacklist 相关接口，在Android Q系统上打开时，会直接Crash！<br> 未适配Android Q的应用，若使用了blacklist 相关接口，在Android Q系统上打开时，会直接Crash！</p> 
<p>二、设备ID<br> 从Android 10开始已经无法完全标识一个设备，曾经用mac地址、IMEI等设备信息标识设备的方法，从Android 10开始统统失效。而且无论你的APP是否是配过Android 10。</p> 
<p>2.1、IMEI等设备信息<br> 从Android10开始普通应用不再允许请求权限android.permission.READ_PHONE_STATE。<br> 而且，无论你的App是否适配过Android Q（既targetSdkVersion是否大于等于29），均无法再获取到设备IMEI等设备信息。</p> 
<p>受影响的API如下：</p> 
<p>Build.getSerial();<br> TelephonyManager.getImei();<br> TelephonyManager.getMeid()<br> TelephonyManager.getDeviceId();<br> TelephonyManager.getSubscriberId();<br> TelephonyManager.getSimSerialNumber();<br> 1<br> 2<br> 3<br> 4<br> 5<br> 6</p> 
<p><br> targetSdkVersion&lt;29 的应用，其在获取设备ID时，会直接返回null<br> targetSdkVersion&gt;=29 的应用，其在获取设备ID时，会直接跑出异常SecurityException</p> 
<p>如果您的App希望在Android 10以下的设备中仍然获取设备IMEI等信息，可按以下方式进行适配：</p> 
<p>2.2、Mac地址随机分配<br> 从Android10开始，默认情况下，在搭载 Android 10 或更高版本的设备上，系统会传输随机分配的 MAC 地址。（既从Android 10开始，普通应用已经无法获取设备的真正mac地址，标识设备已经无法使用mac地址）</p> 
<p>2.3、如何标识设备唯一性？</p> 
<p>Google给出的解决方案是：如果您的应用有 追踪非登录用户重装 的需求，可用ANDROID_ID来标识设备。</p> 
<p>ANDROID_ID的生成规则为：签名+设备信息+设备用户<br> ANDROID_ID重置规则：设备恢复出厂设置时，ANDROID_ID将被重置<br> String androidId = Settings.Secure.getString(this.getContentResolver(), Settings.Secure.ANDROID_ID);<br> 1<br> 也就是从Android 10开始已经无法完全标识一个设备，曾经用mac地址、IMEI等设备信息标识设备的方法，从Android 10开始统统失效。而且无论你的APP是否是配过Android 10。</p> 
<p>求高手留言解答：<br> 在Android 10系统上，目前本人尚未找到标识设备唯一性的办法，如果大家有办法希望留言告知！！！</p> 
<p>三、外部存储<br> 官方文档：</p> 
<p>外部存储访问权限范围限定为应用文件和媒体<br> Manage scoped external storage access</p> 
<p>为解决截图中的问题，从Android Q开始，官方对外部存储进行了一定的限制。</p> 
<p>To give users more control over their files and to limit file clutter, apps targeting Android 10 (API level 29) and higher are given scoped access into an external storage device, or scoped storage, by default. Such apps can see only their app-specific directory—accessed using Context.getExternalFilesDir()—and specific types of media. It’s a best practice to use scoped storage unless your app needs access to a file that doesn’t reside in either the app-specific directory or the MediaStore.</p> 
<p>为了使用户更改的管理Sdcard中的文件，解决文件混乱的问题。从Android 10开始（API level 29），Android将对外部存储进行一定的限制。<br> 默认情况下，对于外部存储，App只能通过Context.getExternalFilesDir()访问自己的特定文件目录；<br> 以及系统特定的文件类型目录（例：照片、屏幕快照、视频 等）。</p> 
<p>3.1、APP专属路径<br> 对于App专属 内部存储路径与外部存储路径的访问，将不再需要 READ_EXTERNAL_STORAGE 与 WRITE_EXTERNAL_STORAGE 权限：</p> 
<p>内部存储路径 /data/data/&lt;包名&gt;/<br> 外部存储路径 /storage/Android/data/&lt;包名&gt;/<br> 3.2、手机共享路径<br> 读取其他APP创建的共享文件，例：相册、屏幕快照 等，则需要申请READ_EXTERNAL_STORAGE权限：</p> 
<p>图片：Photos、Screenshots 使用MediaStore.Images API访问<br> 视频 使用MediaStore.Video API访问<br> 音频 使用MediaStore.Audio API访问<br> 3.2、手机共享路径<br> 读取其他APP创建的共享文件，例：相册、屏幕快照 等，则需要申请READ_EXTERNAL_STORAGE权限：</p> 
<p>图片：Photos、Screenshots 使用MediaStore.Images API访问<br> 视频 使用MediaStore.Video API访问<br> 音频 使用 MediaStore.Audio API访问<br> 3.3、Downloads文件夹<br> 读取手机的Downloads文件夹，不需要任何权限，需要使用API Storage Access Framework</p> 
<p>四、权限相关<br> 主要包括：</p> 
<p>在后台运行时访问设备位置信息<br> 从后台启动 Activity 的限制<br> 屏幕录制<br> 摄像头和麦克风<br> 4.1、在后台运行时访问设备位置信息<br> Android 10 引入了 ACCESS_BACKGROUND_LOCATION 权限。<br> 若应用在后台运行时，访问手机位置，需要动态申请该权限，用户则可以选择拒绝。</p> 
<p>官方给出的数据，大部分用户对位置信息是比较敏感的。而且大部分用户是不允许应用在后台使用位置信息的。</p> 
<p><br> 4.2、从后台启动 Activity 的限制<br> 具体内容请查看官方文档</p> 
<p>4.3、屏幕录制<br> 不需要手动申请权限，但官方 API内部会向用户弹窗申请权限</p> 
<p>4.4、摄像头和麦克风<br> Android 9 摄像头和麦克风 后台权限已经移除了</p> 
<p>4.5、活动探知——新增权限</p> 
<p><br> 五、新功能——夜间模式<br> 关于夜间模式，感兴趣的同学，可以查看我的另一篇文档：</p> 
<p>Android Q 深色主题</p> 
<p>六、参考文章<br> Android 10 Scoped Storage<br> ————————————————<br> 版权声明：本文为CSDN博主「xiaxl」的原创文章，遵循 CC 4.0 BY-SA 版权协议，转载请附上原文出处链接及本声明。<br> 原文链接：https://blog.csdn.net/xiaxl/article/details/103125117</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d97c612deb277878518932287eb362ba/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">解决apt-get update更新错误</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ba6da7289930ce8508d3b3f388078def/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">antd表单设置默认值</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>