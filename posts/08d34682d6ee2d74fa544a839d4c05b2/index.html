<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>mjpeg视频传输和人脸识别 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="mjpeg视频传输和人脸识别" />
<meta property="og:description" content="最近在学习树莓派，想做一个人脸识别，并且把视频传输上去，想来想去想到一个方案，用mjpeg视频传输，传输上去在PC端用opencv进行人脸识别。
mjpeg：
mjpeg是由一系列连续的JPEG图片组成的视频流，因此是非帧间编码器，同时，由于是非帧间编码，需要算力比较小，所以比较适合嵌入式平台，缺点需要的网络带宽比较大，仅支持视频流。
安装mjpeg
pi@raspberrypi:~ $ sudo apt-get install cmake libjpeg8-dev pi@raspberrypi:~ $ git clone https://e.coding.net/fivecc/mjpg-streamer/mjpg-streamer.git pi@raspberrypi:~ $ cd mjpg-* pi@raspberrypi:~/mjpg-streamer-master $ cd mjpg-* pi@raspberrypi:~/mjpg-streamer-master/mjpg-streamer-experimental $ make pi@raspberrypi:~/mjpg-streamer-master/mjpg-streamer-experimental $ sudo make install pi@raspberrypi:~/mjpg-streamer-master/mjpg-streamer-experimental $ cd pi@raspberrypi:~ $ 一步一步执行即可。
2.启动mjpeg
命令框直接输入
pi@raspberrypi: ~ $ /usr/local/bin/mjpg_streamer -i &#34;/usr/local/lib/mjpg-streamer/input_uvc.so -n -f 30 -r 1280x720&#34; -o &#34;/usr/local/lib/mjpg-streamer/output_http.so -p 8080 -w /usr/local/share/mjpg-streamer/www&#34; 4.服务端搭建
如果只接收视频可以直接浏览器打开
http://&lt;树莓派ip&gt;:/javascript.html 本次人脸视频采用的是opencv-python,安装过程不在叙述，可以百度一下python和opencv-python版安装，
首先解析视频流，使用如下代码
url = &#34;http://192.168.43.98:8080/?action=stream&#34; rtmp_url= &#34;rtmp://58.200.131.2:1935/livetv/hunantv&#34; 上面的URL是使用mjpeg的网络视频流地址，使用时，把IP地址改成自己的地址，下面的RTMP地址本次亲测可以这样用，后面可以改成RTMP推流，
使用RTMP应该延时会更小。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/08d34682d6ee2d74fa544a839d4c05b2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-06-30T23:54:27+08:00" />
<meta property="article:modified_time" content="2021-06-30T23:54:27+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">mjpeg视频传输和人脸识别</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>最近在学习树莓派，想做一个人脸识别，并且把视频传输上去，想来想去想到一个方案，用mjpeg视频传输，传输上去在PC端用opencv进行人脸识别。<br> <strong>mjpeg：</strong><br> mjpeg是由一系列连续的JPEG图片组成的视频流，因此是非帧间编码器，同时，由于是非帧间编码，需要算力比较小，所以比较适合嵌入式平台，缺点需要的网络带宽比较大，仅支持视频流。<br> 安装mjpeg</p> 
<pre><code class="prism language-c">pi@raspberrypi<span class="token punctuation">:</span><span class="token operator">~</span> $ sudo apt<span class="token operator">-</span>get install cmake libjpeg8<span class="token operator">-</span>dev
pi@raspberrypi<span class="token punctuation">:</span><span class="token operator">~</span> $ git clone https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>e<span class="token punctuation">.</span>coding<span class="token punctuation">.</span>net<span class="token operator">/</span>fivecc<span class="token operator">/</span>mjpg<span class="token operator">-</span>streamer<span class="token operator">/</span>mjpg<span class="token operator">-</span>streamer<span class="token punctuation">.</span>git
pi@raspberrypi<span class="token punctuation">:</span><span class="token operator">~</span> $ cd mjpg<span class="token operator">-</span><span class="token operator">*</span>
pi@raspberrypi<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>mjpg<span class="token operator">-</span>streamer<span class="token operator">-</span>master $ cd mjpg<span class="token operator">-</span><span class="token operator">*</span>
pi@raspberrypi<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>mjpg<span class="token operator">-</span>streamer<span class="token operator">-</span>master<span class="token operator">/</span>mjpg<span class="token operator">-</span>streamer<span class="token operator">-</span>experimental $ make
pi@raspberrypi<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>mjpg<span class="token operator">-</span>streamer<span class="token operator">-</span>master<span class="token operator">/</span>mjpg<span class="token operator">-</span>streamer<span class="token operator">-</span>experimental $ sudo make install 
pi@raspberrypi<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>mjpg<span class="token operator">-</span>streamer<span class="token operator">-</span>master<span class="token operator">/</span>mjpg<span class="token operator">-</span>streamer<span class="token operator">-</span>experimental $ cd 
pi@raspberrypi<span class="token punctuation">:</span><span class="token operator">~</span> $
</code></pre> 
<pre><code>
 
</code></pre> 
<p>一步一步执行即可。<br> 2.启动mjpeg<br> 命令框直接输入</p> 
<pre><code class="prism language-c">pi@raspberrypi<span class="token punctuation">:</span> <span class="token operator">~</span> $ <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>bin<span class="token operator">/</span>mjpg_streamer <span class="token operator">-</span>i <span class="token string">"/usr/local/lib/mjpg-streamer/input_uvc.so -n -f 30 -r 1280x720"</span> <span class="token operator">-</span>o <span class="token string">"/usr/local/lib/mjpg-streamer/output_http.so -p 8080 -w /usr/local/share/mjpg-streamer/www"</span>
</code></pre> 
<p>4.服务端搭建<br> 如果只接收视频可以直接浏览器打开</p> 
<pre><code class="prism language-c">http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token operator">&lt;</span>树莓派ip<span class="token operator">&gt;</span><span class="token punctuation">:</span><span class="token operator">/</span>javascript<span class="token punctuation">.</span>html
</code></pre> 
<p>本次人脸视频采用的是opencv-python,安装过程不在叙述，可以百度一下python和opencv-python版安装，</p> 
<p>首先解析视频流，使用如下代码</p> 
<pre><code class="prism language-c">url <span class="token operator">=</span> <span class="token string">"http://192.168.43.98:8080/?action=stream"</span>
rtmp_url<span class="token operator">=</span> <span class="token string">"rtmp://58.200.131.2:1935/livetv/hunantv"</span>
</code></pre> 
<p>上面的URL是使用mjpeg的网络视频流地址，使用时，把IP地址改成自己的地址，下面的RTMP地址本次亲测可以这样用，后面可以改成RTMP推流，<br> 使用RTMP应该延时会更小。</p> 
<p>后面就是和普通人脸识别代码一样，下面直接贴上所有代码</p> 
<pre><code class="prism language-c">import cv2

# 导入人脸级联分类器，<span class="token string">'.xml'</span>文件里包含训练出来的人脸特征
face_engine <span class="token operator">=</span> cv2<span class="token punctuation">.</span><span class="token function">CascadeClassifier</span><span class="token punctuation">(</span>
    r<span class="token string">'C:\Users\123\Desktop\haarcascade_frontalface_default.xml'</span><span class="token punctuation">)</span>
url <span class="token operator">=</span> <span class="token string">"http://192.168.43.98:8080/?action=stream"</span>
rtmp_url<span class="token operator">=</span> <span class="token string">"rtmp://58.200.131.2:1935/livetv/hunantv"</span>
# 打开网络摄像头
cap <span class="token operator">=</span> cv2<span class="token punctuation">.</span><span class="token function">VideoCapture</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
<span class="token macro property"># cap = cv2.VideoCapture(0)</span>
def <span class="token function">face_filter</span><span class="token punctuation">(</span>faces<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>faces<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> None
    # 目前找的是画面中面积最大的人脸
    max_face <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>faces<span class="token punctuation">,</span> key<span class="token operator">=</span>lambda face<span class="token punctuation">:</span> face<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*</span> face<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">)</span> <span class="token operator">=</span> max_face
    <span class="token keyword">if</span> w <span class="token operator">&lt;</span> <span class="token number">10</span> or h <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> None
    <span class="token keyword">return</span> max_face
# 创建可以调节大小的窗口
cv2<span class="token punctuation">.</span><span class="token function">namedWindow</span><span class="token punctuation">(</span><span class="token string">"video"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    # 读取一帧<span class="token punctuation">,</span>如果有剩余帧ret为ture<span class="token punctuation">,</span>否则为false
    <span class="token macro property"># ret, frame = cap.read()</span>
    ret<span class="token punctuation">,</span> frame <span class="token operator">=</span> cap<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token macro property"># print(ret, frame)</span>
    faces <span class="token operator">=</span> face_engine<span class="token punctuation">.</span><span class="token function">detectMultiScale</span><span class="token punctuation">(</span>frame<span class="token punctuation">,</span> <span class="token number">1.1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
    img <span class="token operator">=</span> cv2<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>frame<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fx<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> fy<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>faces<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        face<span class="token operator">=</span><span class="token function">face_filter</span><span class="token punctuation">(</span>faces<span class="token punctuation">)</span>
        <span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">,</span>w<span class="token punctuation">,</span>h<span class="token punctuation">)</span><span class="token operator">=</span> face
        img <span class="token operator">=</span> cv2<span class="token punctuation">.</span><span class="token function">rectangle</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>x <span class="token operator">+</span> w<span class="token punctuation">,</span> y <span class="token operator">+</span> h<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token function">print</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span>

    # 实时展示效果画面
    cv2<span class="token punctuation">.</span><span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">'frame2'</span><span class="token punctuation">,</span> img<span class="token punctuation">)</span>
    # 每<span class="token number">5</span>毫秒监听一次键盘动作
    <span class="token keyword">if</span> cv2<span class="token punctuation">.</span><span class="token function">waitKey</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span> <span class="token operator">==</span> <span class="token function">ord</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  # 当按下“a”键时退出人脸检测
        <span class="token keyword">break</span>
cap<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
cv2<span class="token punctuation">.</span><span class="token function">destroyAllWindows</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/97fa2e2944d0cb100b609e2f39fca497/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">＜img＞ 的 title 和 alt 有什么区别？</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d1cdf0d80311596d53868a01a43020f6/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">vue 全屏 screenfull —— 整页全屏，指定元素全屏，退出全屏，全屏切换等</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>