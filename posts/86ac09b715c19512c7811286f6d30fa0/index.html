<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>如何使用STM32CubeMX配置ETH（RMII） - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="如何使用STM32CubeMX配置ETH（RMII）" />
<meta property="og:description" content="最近，刚接触STM32CubeMX，感觉功能非常强大，特别是对于ETH、USB、FAT等特别方便，不用再像以前那样去找各种移植方法（移植起来既麻烦也耽误时间）。
此处，我以自己手头上的一个板子（STM32F207VCT6）为例，记录一下以太网的配置过程，中间也走了一些弯路，希望其他同志今后在配置ETH的时候可以借鉴参考，以节省自己的开发周期。
具体配置过程：
1、打开STM32CubeMX，并选择好相应的芯片。文中的芯片为STM32F207VCT6，选择后如下图：
2、配置RCC时钟、ETH、PA8以及使能LWIP；
由于此处我们的开发板硬件上为RMII方式，因此选择ETH-RMII，若有同志的开发板为MII方式，请参考MII的配置方法，此处只针对RMII；
RCC选择外部时钟源，另外勾选MCO1，软件会自动将PA8配置为MCO1模式，该引脚对于RMII方式很重要，用于为PHY芯片提供50MHz时钟；
使能LWIP；
3、时钟树的相关配置，必须保证MCO1输出为50Mhz，如果这个频率不对会导致PHY芯片无法工作；
我这里因为芯片为207VCT6，为了使MCO1输出为50Mhz，做了PLL倍频参数的一些调整，总体如下：（同志们配置时可根据自己的芯片灵活配置，但需保证MCO1的输出为50Mhz）。下图中的时钟配置参数是一开始配置的，但后来发现网络虽然能通，但丢包严重，后通过百度找到了采用MCO1输出作为时钟的问题，解决方法如下：
/* IMPORTANT NOTE ============== This configuration is valid only when MCO pin is used as RMII clock source. To output a 50 MHz clock signal on the MCO pin, the following conditions must be respected: – 25 MHz external crystal connected to OSCIN/OSCOUT pins – RCC_PLLCFGR PLL factors configured as follows: PLLMx = 4, PLLNx = 64, PLLP = 4." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/86ac09b715c19512c7811286f6d30fa0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2016-11-23T15:38:17+08:00" />
<meta property="article:modified_time" content="2016-11-23T15:38:17+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">如何使用STM32CubeMX配置ETH（RMII）</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p><span style="white-space:pre"></span>最近，刚接触STM32CubeMX，感觉功能非常强大，特别是对于ETH、USB、FAT等特别方便，不用再像以前那样去找各种移植方法（移植起来既麻烦也耽误时间）。</p> 
<p><span style="white-space:pre"></span>此处，我以自己手头上的一个板子（STM32F207VCT6）为例，记录一下以太网的配置过程，中间也走了一些弯路，希望其他同志今后在配置ETH的时候可以借鉴参考，以节省自己的开发周期。</p> 
<p><span style="white-space:pre"></span>具体配置过程：</p> 
<p><span style="white-space:pre"></span>1、打开STM32CubeMX，并选择好相应的芯片。文中的芯片为STM32F207VCT6，选择后如下图：<img src="" alt=""></p> 
<p></p> 
<img src="https://images2.imgbox.com/04/62/oIhM4u9C_o.png" alt=""> 
<p><span style="white-space:pre"></span>2、配置RCC时钟、ETH、PA8以及使能LWIP；</p> 
<p><span style="white-space:pre"></span>      由于此处我们的开发板硬件上为RMII方式，因此选择ETH-RMII，若有同志的开发板为MII方式，请参考MII的配置方法，此处只针对RMII；</p> 
<p><span style="white-space:pre"></span>      RCC选择外部时钟源，另外勾选MCO1，软件会自动将PA8配置为MCO1模式，该引脚对于RMII方式很重要，用于为PHY芯片提供50MHz时钟；</p> 
<p><span style="white-space:pre"></span>      使能LWIP；</p> 
<p><img src="" alt=""><img src="https://images2.imgbox.com/2b/57/oryOQe8r_o.png" alt=""><br> </p> 
<p><span style="white-space:pre"></span>3、时钟树的相关配置，必须保证MCO1输出为50Mhz，如果这个频率不对会导致PHY芯片无法工作；</p> 
<p><span style="white-space:pre"></span>     我这里因为芯片为207VCT6，为了使MCO1输出为50Mhz，做了PLL倍频参数的一些调整，总体如下：（同志们配置时可根据自己的芯片灵活配置，但需保证MCO1的输出为50Mhz）。下图中的时钟配置参数是一开始配置的，但后来发现网络虽然能通，但丢包严重，后通过百度找到了采用MCO1输出作为时钟的问题，解决方法如下：</p> 
<p><span style="color:rgb(68,68,68); font-family:Tahoma,Helvetica,SimSun,sans-serif; line-height:18px; background-color:rgb(238,238,238)">  /* IMPORTANT NOTE</span><br style="word-wrap:break-word; color:rgb(68,68,68); font-family:Tahoma,Helvetica,SimSun,sans-serif; line-height:18px; background-color:rgb(238,238,238)"> <span style="color:rgb(68,68,68); font-family:Tahoma,Helvetica,SimSun,sans-serif; line-height:18px; background-color:rgb(238,238,238)">     ==============</span><br style="word-wrap:break-word; color:rgb(68,68,68); font-family:Tahoma,Helvetica,SimSun,sans-serif; line-height:18px; background-color:rgb(238,238,238)"> <span style="color:rgb(68,68,68); font-family:Tahoma,Helvetica,SimSun,sans-serif; line-height:18px; background-color:rgb(238,238,238)">       This configuration is valid only when MCO pin is used as RMII clock source.</span><br style="word-wrap:break-word; color:rgb(68,68,68); font-family:Tahoma,Helvetica,SimSun,sans-serif; line-height:18px; background-color:rgb(238,238,238)"> <span style="color:rgb(68,68,68); font-family:Tahoma,Helvetica,SimSun,sans-serif; line-height:18px; background-color:rgb(238,238,238)">       To output a 50 MHz clock signal on the MCO pin, the following conditions</span><br style="word-wrap:break-word; color:rgb(68,68,68); font-family:Tahoma,Helvetica,SimSun,sans-serif; line-height:18px; background-color:rgb(238,238,238)"> <span style="color:rgb(68,68,68); font-family:Tahoma,Helvetica,SimSun,sans-serif; line-height:18px; background-color:rgb(238,238,238)">       must be respected:</span><br style="word-wrap:break-word; color:rgb(68,68,68); font-family:Tahoma,Helvetica,SimSun,sans-serif; line-height:18px; background-color:rgb(238,238,238)"> <span style="color:rgb(68,68,68); font-family:Tahoma,Helvetica,SimSun,sans-serif; line-height:18px; background-color:rgb(238,238,238)">         – 25 MHz external crystal connected to OSCIN/OSCOUT pins</span><br style="word-wrap:break-word; color:rgb(68,68,68); font-family:Tahoma,Helvetica,SimSun,sans-serif; line-height:18px; background-color:rgb(238,238,238)"> <span style="color:rgb(68,68,68); font-family:Tahoma,Helvetica,SimSun,sans-serif; line-height:18px; background-color:rgb(238,238,238)">         – RCC_PLLCFGR PLL factors configured as follows:</span><br style="word-wrap:break-word; color:rgb(68,68,68); font-family:Tahoma,Helvetica,SimSun,sans-serif; line-height:18px; background-color:rgb(238,238,238)"> <span style="color:rgb(68,68,68); font-family:Tahoma,Helvetica,SimSun,sans-serif; line-height:18px; background-color:rgb(238,238,238)">           </span><span style="font-family:Tahoma,Helvetica,SimSun,sans-serif; line-height:18px; background-color:rgb(238,238,238)"><span style="color:#ff0000">PLLMx = 4, PLLNx = 64, PLLP = 4.</span></span><br style="word-wrap:break-word; color:rgb(68,68,68); font-family:Tahoma,Helvetica,SimSun,sans-serif; line-height:18px; background-color:rgb(238,238,238)"> <span style="color:rgb(68,68,68); font-family:Tahoma,Helvetica,SimSun,sans-serif; line-height:18px; background-color:rgb(238,238,238)">           This leads to a system clock of 100 MHz.</span><br style="word-wrap:break-word; color:rgb(68,68,68); font-family:Tahoma,Helvetica,SimSun,sans-serif; line-height:18px; background-color:rgb(238,238,238)"> <span style="color:rgb(68,68,68); font-family:Tahoma,Helvetica,SimSun,sans-serif; line-height:18px; background-color:rgb(238,238,238)">         – Then set the MCO prescaler to 2 in the RCC_CFGR register to configure</span><br style="word-wrap:break-word; color:rgb(68,68,68); font-family:Tahoma,Helvetica,SimSun,sans-serif; line-height:18px; background-color:rgb(238,238,238)"> <span style="color:rgb(68,68,68); font-family:Tahoma,Helvetica,SimSun,sans-serif; line-height:18px; background-color:rgb(238,238,238)">           the system clock to 50 MHz.</span><br style="word-wrap:break-word; color:rgb(68,68,68); font-family:Tahoma,Helvetica,SimSun,sans-serif; line-height:18px; background-color:rgb(238,238,238)"> <span style="color:rgb(68,68,68); font-family:Tahoma,Helvetica,SimSun,sans-serif; line-height:18px; background-color:rgb(238,238,238)">     */</span><br> </p> 
<p><span style="color:rgb(68,68,68); font-family:Tahoma,Helvetica,SimSun,sans-serif; line-height:18px; background-color:rgb(238,238,238)">将cubeMX生成后的工程中时钟配置的地方，分别修改<span style="color:rgb(255,0,0); font-family:Tahoma,Helvetica,SimSun,sans-serif; line-height:18px; background-color:rgb(238,238,238)">PLLMx = 4, PLLNx = 64, PLLP = 4，可以解决丢包问题！</span></span></p> 
<p><img src="" alt=""><img src="https://images2.imgbox.com/84/e6/zpGoFhHd_o.png" alt=""><br> </p> 
<p><span style="white-space:pre"></span>4、ETH、LWIP、RCC相关参数设置；</p> 
<p><span style="white-space:pre"></span>      至此，比较重要的都在前面了，但是还有一点仍需要注意，即PA8引脚输出速度，几次不成功都是因为这个引脚没注意。</p> 
<p><img src="" alt=""><img src="https://images2.imgbox.com/d1/26/GIMQvCA7_o.png" alt=""><br> </p> 
<p><span style="white-space:pre"></span>     后续的参数设置可以根据同志们自己的需求分别设置，这里给出我的设置供参考；</p> 
<p><span style="white-space:pre"></span>      ETH参数保持默认，但中断勾选一下；</p> 
<p><img src="" alt=""><img src="https://images2.imgbox.com/dc/cf/GJSpWjcI_o.png" alt=""><br> </p> 
<p><span style="white-space:pre"></span>      LWIP参数设置如下：（因为我这里是配置UDP服务器，IP选择静态分配）</p> 
<p><img src="" alt=""><img src="https://images2.imgbox.com/d7/30/FZ6YbVmD_o.png" alt=""><br> </p> 
<p><span style="white-space:pre"></span>5、生成工程，做最后的函数修改；</p> 
<p><span style="white-space:pre"></span>给生成的工程添加UDP服务器的初始化以及端口绑定等相关函数；</p> 
<p><span style="white-space:pre"></span>我这里直接将之前的官方例程中的UDP服务器文件加进来，如下：</p> 
<p><img src="https://images2.imgbox.com/7a/1e/ai5fvowj_o.png" alt=""><br> </p> 
<p><span style="white-space:pre"></span>之后将.c文件添加到用户程序，主函数添加Udp的.h头文件；如下：（udp文件的具体内容在后面给出）</p> 
<p><img src="" alt=""><img src="https://images2.imgbox.com/97/b9/wfAMwKKM_o.png" alt=""></p> 
<p><span style="white-space:pre"></span>6、主函数还需要添加一下几个函数，在这里不对函数作用及实现原理讲解，仅做添加说明。</p> 
<p><img src="" alt=""><img src="https://images2.imgbox.com/ff/7a/4xUKFo3Q_o.png" alt=""><br> </p> 
<p><br> </p> 
<p>附：udp_echoserver相关文件内容（该文件为官方的示例程序，版权归官方，此处做转载）</p> 
<p>udp_echoserver.c的内容如下：<br> </p> 
<p>/* Includes ------------------------------------------------------------------*/<br> #include "main.h"<br> #include "lwip/pbuf.h"<br> #include "lwip/udp.h"<br> #include "lwip/tcp.h"<br> #include &lt;string.h&gt;<br> #include &lt;stdio.h&gt;<br> <br> <br> /* Private typedef -----------------------------------------------------------*/<br> /* Private define ------------------------------------------------------------*/<br> #define UDP_SERVER_PORT    7   /* define the UDP local connection port */<br> #define UDP_CLIENT_PORT    7   /* define the UDP remote connection port */<br> <br> <br> /* Private macro -------------------------------------------------------------*/<br> /* Private variables ---------------------------------------------------------*/<br> /* Private function prototypes -----------------------------------------------*/<br> void udp_echoserver_receive_callback(void *arg, struct udp_pcb *upcb, struct pbuf *p, const ip_addr_t *addr, u16_t port);<br> <br> <br> /* Private functions ---------------------------------------------------------*/<br> <br> <br> /**<br>   * @brief  Initialize the server application.<br>   * @param  None<br>   * @retval None<br>   */<br> void udp_echoserver_init(void)<br> {<!-- --><br>    struct udp_pcb *upcb;<br>    err_t err;<br>    <br>    /* Create a new UDP control block  */<br>    upcb = udp_new();<br>    <br>    if (upcb)<br>    {<!-- --><br>      /* Bind the upcb to the UDP_PORT port */<br>      /* Using IP_ADDR_ANY allow the upcb to be used by any local interface */<br>       err = udp_bind(upcb, IP_ADDR_ANY, UDP_SERVER_PORT);<br>       <br>       if(err == ERR_OK)<br>       {<!-- --><br>         /* Set a receive callback for the upcb */<br>         udp_recv(upcb, udp_echoserver_receive_callback, NULL);<br>       }<br>    }<br> }<br> <br> <br> /**<br>   * @brief This function is called when an UDP datagrm has been received on the port UDP_PORT.<br>   * @param arg user supplied argument (udp_pcb.recv_arg)<br>   * @param pcb the udp_pcb which received data<br>   * @param p the packet buffer that was received<br>   * @param addr the remote IP address from which the packet was received<br>   * @param port the remote port from which the packet was received<br>   * @retval None<br>   */<br> void udp_echoserver_receive_callback(void *arg, struct udp_pcb *upcb, struct pbuf *p, const ip_addr_t *addr, u16_t port)<br> {<!-- --><br> <br> <br>   /* Connect to the remote client */<br>   udp_connect(upcb, addr, UDP_CLIENT_PORT);<br>     <br>   /* Tell the client that we have accepted it */<br>   udp_send(upcb, p);<br> <br> <br>   /* free the UDP connection, so we can accept new clients */<br>   udp_disconnect(upcb);<br> <span style="white-space:pre"></span><br>   /* Free the p buffer */<br>   pbuf_free(p);<br>    <br> }<br> </p> 
<p><br> </p> 
<p>udp_echoserver.h的内容如下：<br> </p> 
<p>#ifndef __ECHO_H__<br> #define __ECHO_H__<br> <br> void udp_echoserver_init(void);<br> <br> #endif /* __MINIMAL_ECHO_H */<br> </p> 
<p><br> </p> 
<p><span style="white-space:pre"></span>7、至此，所有的工作完成，编译工程，下载至开发板。由于udp_echoserver中绑定的端口号为7，这里我们通过测试工具测试网络的功能，如下：</p> 
<p><img src="https://images2.imgbox.com/11/f1/UgWLqoop_o.png" alt=""><br> </p> 
<p><br> </p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6bd6a5d54155788c8e447cb74226c114/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">微信登录提示48001,{&#34;errcode&#34;:48001,&#34;errmsg&#34;:&#34;api unauthorized, hints: [ req_id: 1QoCla0699ns81 ]&#34;}</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/20f7e66c6c8736cc4bad7c2cd6682866/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">NGUI-EventDelegate使用</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>