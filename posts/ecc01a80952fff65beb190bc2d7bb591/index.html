<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>CSerialPort串口类最新修正版2017-03-12 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="CSerialPort串口类最新修正版2017-03-12" />
<meta property="og:description" content="如需转载请标明出处：http://blog.csdn.net/itas109 QQ技术交流群：129518033
最新进展：
CSerialPort串口类最新修正版2017-12-16
http://blog.csdn.net/itas109/article/details/78823082
这是一份优秀的串口类文件，好多的地方值得我们学习，具体在多线程，事件，自定义消息，类的封装方面等等。
Remon提供的串口类网址为： http://codeguru.earthweb.com/network/serialport.shtml，
由于已经运行十几年了，原文的问答部分列出来这么多年来的问题，经过网友们的总结，补充和修改原来代码后，整理出一份相对比较完美的代码。
CSerialPort类地址：https://github.com/itas109/CSerialPort
2017-03-12补充说明
1.增加宏定义_AFX，用于处理MFC的必要函数Hkey2ComboBox
2.进一步去除MFC依赖，修改AfxMessageBox函数
3.增加Win32的程序，用于验证非MFC程序的适用性
CSDN下载：http://download.csdn.net/detail/itas109/9794122
历史更新：
First Version by Remon Spekreijse on 2000-02-08
http://www.codeguru.com/cpp/i-n/network/serialcommunications/article.php/c2483/A-communication-class-for-serial-port.htm
Second Version by mrlong on 2007-12-25
https://code.google.com/p/mycom/
* 增加 ClosePort
* 增加 WriteToPort 两个方法
* 增加 SendData 与 RecvData 方法
by liquanhai on 2011-11-04
http://blog.csdn.net/liquanhai/article/details/4955253
* 增加 ClosePort 中交出控制权，防止死锁问题
by liquanhai on 2011-11-06
http://blog.csdn.net/liquanhai/article/details/6941574
* 增加 ReceiveChar 中防止线程死锁
by viruscamp on 2013-12-04
https://github.com/viruscamp/CSerialPort
* 增加 IsOpen 判断是否打开" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/ecc01a80952fff65beb190bc2d7bb591/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2016-05-07T13:59:19+08:00" />
<meta property="article:modified_time" content="2016-05-07T13:59:19+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">CSerialPort串口类最新修正版2017-03-12</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>如需转载请标明出处：<a href="http://blog.csdn.net/itas109">http://blog.csdn.net/itas109 </a></p> 
<p>QQ技术交流群：129518033</p> 
<p> </p> 
<p><span style="color:#ff0000;"><strong>最新进展：</strong></span></p> 
<p><span style="color:#ff0000;"><strong>CSerialPort串口类最新修正版2017-12-16</strong></span></p> 
<p><a href="http://blog.csdn.net/itas109/article/details/78823082"><span style="color:#ff0000;"><strong>http://blog.csdn.net/itas109/article/details/78823082</strong></span></a></p> 
<p> </p> 
<p>这是一份优秀的串口类文件，好多的地方值得我们学习，具体在多线程，事件，自定义消息，类的封装方面等等。<br> Remon提供的串口类网址为：<a href="http://codeguru.earthweb.com/network/serialport.shtml" rel="nofollow"> http://codeguru.earthweb.com/network/serialport.shtml</a>，<br> 由于已经运行十几年了，原文的问答部分列出来这么多年来的问题，经过网友们的总结，补充和修改原来代码后，整理出一份相对比较完美的代码。</p> 
<p> </p> 
<p><span style="color:#ff0000;">CSerialPort类地址：</span><span style="color:#ff0000;"><a href="https://github.com/itas109/CSerialPort">https://github.com/itas109/CSerialPort</a></span></p> 
<p> </p> 
<p> </p> 
<p><span style="color:#ff0000;">2017-03-12补充说明</span></p> 
<p><span style="color:#ff0000;">1.增加宏定义_AFX，用于处理MFC的必要函数Hkey2ComboBox<br> 2.进一步去除MFC依赖，修改AfxMessageBox函数<br> 3.增加Win32的程序，用于验证非MFC程序的适用性</span></p> 
<p><span style="color:#ff0000;">CSDN下载：</span><a href="http://download.csdn.net/detail/itas109/9794122">http://download.csdn.net/detail/itas109/9794122</a></p> 
<p>历史更新：</p> 
<p>First Version by Remon Spekreijse on 2000-02-08<br><a href="http://www.codeguru.com/cpp/i-n/network/serialcommunications/article.php/c2483/A-communication-class-for-serial-port.htm" rel="nofollow">http://www.codeguru.com/cpp/i-n/network/serialcommunications/article.php/c2483/A-communication-class-for-serial-port.htm</a></p> 
<p><br> Second Version by mrlong on 2007-12-25<br><a href="https://code.google.com/p/mycom/" rel="nofollow">https://code.google.com/p/mycom/</a><br> * 增加 ClosePort<br> * 增加 WriteToPort 两个方法<br> * 增加 SendData 与 RecvData 方法</p> 
<p><br> by liquanhai on 2011-11-04<br><a href="http://blog.csdn.net/liquanhai/article/details/4955253">http://blog.csdn.net/liquanhai/article/details/4955253</a><br> * 增加 ClosePort 中交出控制权，防止死锁问题</p> 
<p><br> by liquanhai on 2011-11-06<br><a href="http://blog.csdn.net/liquanhai/article/details/6941574">http://blog.csdn.net/liquanhai/article/details/6941574</a><br> * 增加 ReceiveChar 中防止线程死锁</p> 
<p><br> by viruscamp on 2013-12-04<br><a href="https://github.com/viruscamp/CSerialPort">https://github.com/viruscamp/CSerialPort</a><br> * 增加 IsOpen 判断是否打开<br> * 修正 InitPort 中 parity Odd Even 参数取值错误<br> * 修改 InitPort 中 portnr 取值范围，portnr&gt;9 时特殊处理<br> * 取消对 MFC 的依赖，使用 HWND 替代 CWnd，使用 win32 thread 函数而不是 MFC 的<br> * 增加用户消息编号自定义，方法来自 CnComm</p> 
<p><br> by itas109 on 2014-01-10<br><a href="http://blog.csdn.net/itas109/article/details/18358297">http://blog.csdn.net/itas109/article/details/18358297</a><br> * 解决COM10以上端口无法显示的问题<br> * 扩展可选择端口，最大值MaxSerialPortNum可以自定义<br> * 添加QueryKey()和Hkey2ComboBox两个方法，用于自动查询当前有效的串口号。</p> 
<p><br> by liquanhai on 2014-12-18<br> * 增加一些处理措施，主要是对减少CPU占用率</p> 
<p> </p> 
<p>by itas109 on 2016-05-06<br> * 修复每次打开串口发送一次，当串口无应答时，需要关闭再打开或者接收完数据才能发送的问题。<br>    解决办法：在m_hEventArray中调整m_hWriteEvent的优先级高于读的优先级。CommThread(LPVOID pParam)函数中读写的位置也调换。<br>    参考：<a href="http://zhidao.baidu.com/link?url=RSrbPcfTZRULFFd2ziHZPBwnoXv1iCSu_Nmycb_yEw1mklT8gkoNZAkWpl3UDhk8L35DtRPo5VV5kEGpOx-Gea" rel="nofollow">http://zhidao.baidu.com/link?url=RSrbPcfTZRULFFd2ziHZPBwnoXv1iCSu_Nmycb_yEw1mklT8gkoNZAkWpl3UDhk8L35DtRPo5VV5kEGpOx-Gea</a><br> * 修复停止位在头文件中定义成1导致SetCommState报错的问题，应为1对应的停止位是1.5。UINT stopsbits = ONESTOPBIT<br> * switch(stopbits)和switch(parity)增加默认情况，增强程序健壮性</p> 
<p><br> by itas109 on 2016-06-22<br> * 增加ReceiveStr方法，用于接收字符串（接收缓冲区有多少字符就接收多少字符）。<br> * 解决ReceiveChar只能接收单个字符的问题。<br><br> by itas109 on 2016-06-29<br> * 解决RestartMonitoring方法和StopMonitoring方法命令不准确引起的歧义，根据实际作用。<br> * 将RestartMonitoring更改为ResumeMonitoring，将StopMonitoring更改为SuspendMonitoring。<br> * 增加IsThreadSuspend方法，用于判断线程是否挂起。<br> * 改进ClosePort方法，增加线程挂起判断，解决由于线程挂起导致串口关闭死锁的问题。<br> * 增加IsReceiveString宏定义，用于接收时采用单字节接收还是多字节接收</p> 
<p> </p> 
<p>by itas109 on 2016-08-02<br> http://blog.csdn.net/itas109<br> https://github.com/itas109<br> * 改进IsOpen方法，m_hComm增加INVALID_HANDLE_VALUE的情况，因为CreateFile方法失败返回的是INVALID_HANDLE_VALUE，不是NULL<br> * 改进ClosePort方法：增加串口句柄无效的判断(防止关闭死锁)；m_hWriteEvent不使用CloseHandle关闭<br> * 改进CommThread、ReceiveChar、ReceiveStr和WriteChar方法中异常处理的判断，增加三种判断：串口打开失败(error code:ERROR_INVALID_HANDLE)、连接过程中非法断开(error code:ERROR_BAD_COMMAND)和拒绝访问(error code:ERROR_ACCESS_DENIED)<br> * 采用安全函数sprintf_s和strcpy_s函数替换掉sprintf和strcpy<br> * 改进QueryKey方法，用于查询注册表的可用串口值，可以搜索到任意的可用串口<br> * 改进InitPort方法，串口打开失败，增加提示信息:串口不存在(error code:ERROR_FILE_NOT_FOUND)和串口拒绝访问(error code:ERROR_ACCESS_DENIED)<br> * 加入viruscamp 取消对 MFC 的依赖<br> * 改进InitPort方法，如果上次串口是打开，再次调用InitPort方法，关闭串口需要做一定的延时，否则有几率导致ERROR_ACCESS_DENIED拒绝访问，也就是串口占用问题<br> * 初始化默认波特率修改为9600<br> * 修复一些释放的BUG<br> * 规范了一些错误信息，参考winerror.h --  error code definitions for the Win32 API functions<br> * 删除SendData和RecvData方法<br><br><br> by itas109 on 2016-08-10<br> http://blog.csdn.net/itas109<br> https://github.com/itas109<br> *  改进ReceiveStr方法，comstat.cbInQue = 0xcccccccc的情况（如串口异常断开），会导致RXBuff初始化失败<br><br><br> by itas109 on 2017-02-14<br> http://blog.csdn.net/itas109<br> https://github.com/itas109<br> * 兼容ASCII和UNICODE编码<br> * ReceiveStr函数中发送函数SendMessage的第二个参数采用结构体形式，包括portNr串口号和bytesRead读取的字节数，可以处理16进制的时候0x00截断问题<br> * 精简不必要的函数SendData和RecvData<br> * 尽量的取消对 MFC 的依赖，Hkey2ComboBox函数暂时保留<br> * 其他小问题修改 </p> 
<p> </p> 
<p><span style="color:#ff0000;">觉得文章对你有帮助，可以扫描二维码捐赠给博主，谢谢！</span></p> 
<p> </p> 
<p><img alt="" class="has" height="308" src="https://images2.imgbox.com/a4/57/5NI6htKF_o.png" width="793"></p> 
<p> </p> 
<p> 如需转载请标明出处：<a href="http://blog.csdn.net/itas109">http://blog.csdn.net/itas109 </a></p> 
<p> </p> 
<p> </p> 
<p>QQ技术交流群：129518033</p> 
<p> </p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b4bf33883f03c7ac952ea93cbbb24414/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Hashcat</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/48af83a4c4d3ea045b0ca80e8b3dbbf5/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">三维形体的数据结构（1）半边数据结构</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>