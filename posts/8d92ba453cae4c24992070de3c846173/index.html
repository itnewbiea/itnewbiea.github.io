<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Watchdog源码--ownPacketDetected - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Watchdog源码--ownPacketDetected" />
<meta property="og:description" content="节点发送数据包，则将数据包缓存。
/**
* I read my own packet.
*/
void
WATCHDOG::ownPacketDetected(int32_t source_ip, int32_t destination_ip, int sourcePort, int destinationPort, int mac_dst, char * tmp_data, packet_t packet_type, double pktime) {
if (debug &gt; 2) printf(&#34;Ownpacket\n&#34;);
int data_size;
neighbour *neigh_dst;
data_size = strlen(tmp_data);
protocol = packet_type;
neigh_dst = neigs-&gt;ExistNeighbourMac(mac_dst);
if (mac_dst != 666) {
/* If the destination IP is different of the destination neighbour, means that must be forwarded */
//if (neigh_dst !" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/8d92ba453cae4c24992070de3c846173/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-07-03T05:12:34+08:00" />
<meta property="article:modified_time" content="2019-07-03T05:12:34+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Watchdog源码--ownPacketDetected</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div id="cnblogs_post_body" class="blogpost-body"> 
 <p>节点发送数据包，则将数据包缓存。</p> 
 <div class="cnblogs_code"> 
  <pre><span style="color:#008000;">/*</span><span style="color:#008000;">*<br> * I read my own packet.<br></span><span style="color:#008000;">*/</span><br><span style="color:#0000ff;">void</span><br>WATCHDOG::ownPacketDetected(int32_t source_ip, int32_t destination_ip, <span style="color:#0000ff;">int</span> sourcePort, <span style="color:#0000ff;">int</span> destinationPort, <span style="color:#0000ff;">int</span> mac_dst, <span style="color:#0000ff;">char</span> * tmp_data, packet_t packet_type, <span style="color:#0000ff;">double</span> pktime) {<!-- --><br><span style="color:#0000ff;">if</span> (debug &gt; <span style="color:#800080;">2</span>) printf(<span style="color:#800000;">"</span><span style="color:#800000;">Ownpacket\n</span><span style="color:#800000;">"</span>);<br><span style="color:#0000ff;">int</span> data_size;<br>    neighbour *neigh_dst;<br><br>    data_size = strlen(tmp_data);<br>    protocol = packet_type;<br><br>    neigh_dst = neigs-&gt;ExistNeighbourMac(mac_dst);<br><br><span style="color:#0000ff;">if</span> (mac_dst != <span style="color:#800080;">666</span>) {<!-- --><br><span style="color:#008000;">/*</span><span style="color:#008000;"> If the destination IP is different of the destination neighbour, means that must be forwarded </span><span style="color:#008000;">*/</span><br><span style="color:#008000;">//</span><span style="color:#008000;">if (neigh_dst != NULL){<!-- --></span><span style="color:#008000;"><br></span>        <span style="color:#0000ff;">if</span> (neigh_dst != NULL &amp;&amp; (neigh_dst-&gt;ip != <span style="color:#800080;">666</span>) &amp;&amp; (destination_ip != neigh_dst-&gt;ip)) {<!-- --><br><strong> waitingForwardPacket(source_ip, destination_ip, sourcePort, destinationPort, tmp_data, data_size, neigh_dst, protocol, pktime);</strong><br>            neigs-&gt;ShowAllNeighbours();<br>        }<span style="color:#0000ff;">else</span>{<!-- --><br>            neigs-&gt;ShowAllNeighbours();<br>        }<br>    }<br><br>}</pre> 
 </div> 
 <p>自己发送的数据包，则调用waitingForwardPacket</p> 
 <div class="cnblogs_code"> 
  <pre><span style="color:#008000;">/*</span><span style="color:#008000;">*<br> * A new packet has been sended, i must store it until confirmation of forward.<br></span><span style="color:#008000;">*/</span><br><span style="color:#0000ff;">void</span><br>WATCHDOG::waitingForwardPacket(int32_t source_ip, int32_t destination_ip, <span style="color:#0000ff;">int</span> sourcePort, <span style="color:#0000ff;">int</span> destinationPort, <span style="color:#0000ff;">char</span> *body, <span style="color:#0000ff;">int</span> data_size, neighbour *neigh, <span style="color:#0000ff;">int</span> protocol, <span style="color:#0000ff;">double</span> pktime) {<!-- --><br><span style="color:#0000ff;">if</span> (debug &gt; <span style="color:#800080;">2</span>) printf(<span style="color:#800000;">"</span><span style="color:#800000;">waitingForwardPacket\n</span><span style="color:#800000;">"</span>);<br><span style="color:#0000ff;">if</span> (neigh != NULL) {<!-- --><br>        neigs-&gt;<strong>AddNeighbourPacketToForward</strong>(neigh, body, destination_ip, source_ip, data_size, storing_packet_timeout, protocol, sourcePort, destinationPort, pktime);<br>        neigs-&gt;<span style="color:#993366;"><strong>AddFlow</strong></span>(source_ip, destination_ip, neigh, pktime);<br>    }<br>}</pre> 
 </div> 
 <div class="cnblogs_code"> 
  <pre><span style="color:#008000;">/*</span><span style="color:#008000;">*<br> * Add a packet to a neighbour not forwarded yet.0,918367347<br></span><span style="color:#008000;">*/</span><br><span style="color:#0000ff;">void</span><br>NEIGHBOURS::AddNeighbourPacketToForward(neighbour *neig, <span style="color:#0000ff;">char</span> *body, int32_t ip_dst, int32_t ip_src, <span style="color:#0000ff;">int</span> data_size, <span style="color:#0000ff;">int</span> storing_time, <span style="color:#0000ff;">int</span> protocol, <span style="color:#0000ff;">int</span> originPort, <span style="color:#0000ff;">int</span> destinationPort, <span style="color:#0000ff;">double</span> pktime) {<!-- --><br>    neig-&gt;time = pktime;<br>    neig-&gt;pckts-&gt;<strong>AddPacketToForward</strong>(body, ip_dst, ip_src, data_size, storing_time, protocol, originPort, destinationPort, pktime);<br>}</pre> 
 </div> 
 <div class="cnblogs_code"> 
  <pre><span style="color:#008000;">/*</span><span style="color:#008000;">*<br> *  Indicates that a new packet that must to be forwarded has been listened.<br></span><span style="color:#008000;">*/</span><br><span style="color:#0000ff;">void</span><br>PACKETS::AddPacketToForward(<span style="color:#0000ff;">char</span> *body, int32_t ip_dst, int32_t ip_src, <span style="color:#0000ff;">int</span> data_size, <span style="color:#0000ff;">int</span> storing_time, <span style="color:#0000ff;">int</span> protocol, <span style="color:#0000ff;">int</span> originPort, <span style="color:#0000ff;">int</span> destinationPort, <span style="color:#0000ff;">double</span> pktime) {<!-- --><br>    packet *pk;<br>    packet *exists;<br><br><span style="color:#008000;">/*</span><span style="color:#008000;"> Sometimes can listen a packet two or more times, we must avoid insert the same packet two times </span><span style="color:#008000;">*/</span><br>    exists = ShortExistsPacket(body, ip_dst, ip_src, data_size, storing_time, protocol, pktime);<br><span style="color:#0000ff;">if</span> (exists == NULL) {<!-- --><br><span style="color:#0000ff;">if</span> ((pk = (packet *) (malloc(<span style="color:#0000ff;">sizeof</span> (packet)))) &lt; <span style="color:#800080;">0</span>)<br>            error(<span style="color:#800000;">"</span><span style="color:#800000;">Memory assignment of packet!\n</span><span style="color:#800000;">"</span>);<br>        pk-&gt;time = pktime;<br>        pk-&gt;data = (<span style="color:#0000ff;">char</span> *)malloc(<span style="color:#0000ff;">sizeof</span> (<span style="color:#0000ff;">char</span>) * data_size);<br><span style="color:#008000;">//</span><span style="color:#008000;">memcpy(pk-&gt;data, body, data_size);</span><span style="color:#008000;"><br></span>        strcpy(pk-&gt;data, body);<br>        pk-&gt;ip_src = ip_src;<br>        pk-&gt;ip_dst = ip_dst;<br>        pk-&gt;data_size = data_size;<br>        pk-&gt;time = pktime;<br>        pk-&gt;originPort = originPort;<br>        pk-&gt;destinationPort = destinationPort;<br>        pk-&gt;protocol = protocol;<br>        pk-&gt;previous = NULL;<br>        pk-&gt;next = NULL;<br>        pk-&gt;devalue = <span style="color:#800080;">1</span>;<br><br>        pckts-&gt;received_packets[protocol]++;<br>        pckts-&gt;stored_packets++;<br>        pckts-&gt;stored_packets_protocol[protocol]++;<br><br><span style="color:#0000ff;">if</span> (pckts-&gt;stored_packets &gt; max_packets_lost) max_packets_lost = pckts-&gt;stored_packets;<br><br><span style="color:#0000ff;">if</span> (pckts-&gt;last_packet[protocol] == NULL) {<!-- --><br>            pckts-&gt;packets[protocol] = pk;<br>            pckts-&gt;last_packet[protocol] = pk;<br>            pk-&gt;previous = NULL;<br>        } <span style="color:#0000ff;">else</span> {<!-- --><br>            pckts-&gt;last_packet[protocol]-&gt;next = pk;<br>            pk-&gt;previous = pckts-&gt;last_packet[protocol];<br>            pckts-&gt;last_packet[protocol] = pk;<br>        }<br><br>    } <span style="color:#0000ff;">else</span> {<!-- --><br>    }<br>}</pre> 
 </div> 
 <p> </p> 
 <div class="cnblogs_code"> 
  <pre><span style="color:#008000;">/*</span><span style="color:#008000;">*<br> * Add a new flow definded by a IP to a neighbour.<br></span><span style="color:#008000;">*/</span><br><span style="color:#0000ff;">void</span><br><span style="color:#993366;">NEIGHBOURS::AddFlow(int32_t source, int32_t destination, neighbour *nb, double pktime) {<!-- --></span><br>    flow *f, *ant, *n;<br>    f = nb-&gt;flows;<br><br>    ant = NULL;<br><span style="color:#0000ff;">if</span> (!ExistFlow(source, destination, nb, pktime)) {<!-- --><br><span style="color:#0000ff;">while</span> (f != NULL) {<!-- --><br>            ant = f;<br>            f = f-&gt;next;<br>        }<br>        n = NewFlow(source, destination, pktime);<br>        n-&gt;previous = ant;<br><span style="color:#0000ff;">if</span> (ant != NULL) {<!-- --><br>            ant-&gt;next = n;<br>        } <span style="color:#0000ff;">else</span> {<!-- --><br>            nb-&gt;flows = n;<br>        }<br>        nb-&gt;number_flows++;<br>    }<br>}</pre> 
 </div> 
 <p><br><br><br><br><br></p> 
</div> 
<p>转载于:https://www.cnblogs.com/zhangrui/archive/2012/03/08/2385189.html</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f18e5516c2643006e1d3819fbb0d306b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Super Ugly Number</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3cad189d48ccd6f6c7c4f4916bc18312/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">iOS　　如何判断当前网络连接状态　　网络是否正常　　网络是否可用</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>