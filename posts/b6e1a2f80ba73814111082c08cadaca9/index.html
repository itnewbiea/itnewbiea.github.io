<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>K8S应用安全检测（调用分析 容器健康 审计日志） - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="K8S应用安全检测（调用分析 容器健康 审计日志）" />
<meta property="og:description" content="应用安全检测 1 应用安全检测1.1 调用分析1.1.1 sysdig基础1.1.2 命令实践 1.2 容器监控1.2.1 CAdvisor1.2.2 Falco基础1.2.3 Falco实践1.2.4 进阶实践1.2.5 可视化实践 1.3 审计日志1.3.1 日志解读1.3.2 审计日志 1 应用安全检测 1.1 调用分析 1.1.1 sysdig基础 学习目标
这一节，我们从 基础知识、简单实践、小结 三个方面来学习。
基础知识
简介
Sysdig 是一个开源系统(System)发掘(dig)工具，它汇聚了 strace、tcpdump、htop、iftop、lsof等工具的能力。常用于系统级别的监控、分析和故障排查等场景，可以把它看作一系列Linux系统工具的组合。 strace：追踪某个进程产生和接收的系统调用。 tcpdump：分析网络数据，监控原始网络通信。 lsof： list opened files, 列出打开的文件。 top：监控系统性能工具。 htop ：交互式的进程浏览器，可以用来替换 top 命令。 iftop ：主要用来显示本机网络流量情况及各相互通信的流量集合。 lua：一种嵌入式的脚本语言，从而为应用程序提供灵活的扩展和定制功能。 功能
Sysdig除了能够获取系统资源利用率、进程、网络连接、系统调用等信息，还具备了非常强的分析能力。Sysdig 不仅能分析Linux 系统的“现场”状态，也能将该状态保存为转储文件以供离线分析检查。同时还可以自定义 Sysdig 的行为，通过内建的名为chisel的小脚本增强其功能。 通过 Sysdig 可以挖掘非常多的系统信息：用户能够很方便地查看到主机上所有应用程序的cpu、文件 i/o、网络访问状况；Sysdig可以快速进行系统数据的收集和分析；提供了容器级别的信息采集命令，支持查看指定容器之间的网络流量、查看特定容器的 CPU使用情况。 项目代码: https://github.com/draios/sysdig 项目介绍: https://github.com/draios/sysdig/wiki 伴随着容器技术的大力普及和实践落地，针对容器场景的检测工具也应运而生，Sysdig就属于这里面比较典型的一套开源工具。它不仅仅能够针对传统主机进行检测，更能根据Docker软件在宿主机上落地的方式，自动发现容器内的进程，从而实现容器环境信息的采集和分析，这让我们能够即时了解客户在生产中运行云原生服务的解决方案，这也直接促使sysdig成为适用于服务器和容器的“故障定位和排除工具”。 原理解析
sysdig通过在内核的驱动模块注册系统调用的hook，这样当系统调用发生和完成的时候，它会把系统调用信息拷贝到特定的buffer，然后通过用户态组件对数据信息处理(解压、解析、过滤等)，并最终通过sysdig命令行和用户进行交互。 简单实践
Centos环境部署
导入软件源 rpm --import https://download." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/b6e1a2f80ba73814111082c08cadaca9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-10T21:13:42+08:00" />
<meta property="article:modified_time" content="2023-07-10T21:13:42+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">K8S应用安全检测（调用分析 容器健康 审计日志）</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>应用安全检测</h4> 
 <ul><li><a href="#1__1" rel="nofollow">1 应用安全检测</a></li><li><ul><li><a href="#11__3" rel="nofollow">1.1 调用分析</a></li><li><ul><li><a href="#111_sysdig_5" rel="nofollow">1.1.1 sysdig基础</a></li><li><a href="#112__115" rel="nofollow">1.1.2 命令实践</a></li></ul> 
   </li><li><a href="#12__363" rel="nofollow">1.2 容器监控</a></li><li><ul><li><a href="#121_CAdvisor_365" rel="nofollow">1.2.1 CAdvisor</a></li><li><a href="#122_Falco_503" rel="nofollow">1.2.2 Falco基础</a></li><li><a href="#123_Falco_613" rel="nofollow">1.2.3 Falco实践</a></li><li><a href="#124__761" rel="nofollow">1.2.4 进阶实践</a></li><li><a href="#125__903" rel="nofollow">1.2.5 可视化实践</a></li></ul> 
   </li><li><a href="#13__999" rel="nofollow">1.3 审计日志</a></li><li><ul><li><a href="#131__1001" rel="nofollow">1.3.1 日志解读</a></li><li><a href="#132__1274" rel="nofollow">1.3.2 审计日志</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="1__1"></a>1 应用安全检测</h2> 
<h3><a id="11__3"></a>1.1 调用分析</h3> 
<h4><a id="111_sysdig_5"></a>1.1.1 sysdig基础</h4> 
<p>学习目标</p> 
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p> 
<p><strong>基础知识</strong></p> 
<p>简介</p> 
<pre><code class="prism language-powershell">	Sysdig 是一个开源系统<span class="token punctuation">(</span>System<span class="token punctuation">)</span>发掘<span class="token punctuation">(</span>dig<span class="token punctuation">)</span>工具，它汇聚了 strace、tcpdump、htop、iftop、lsof等工具的能力。常用于系统级别的监控、分析和故障排查等场景，可以把它看作一系列Linux系统工具的组合。
	strace：追踪某个进程产生和接收的系统调用。
    tcpdump：分析网络数据，监控原始网络通信。
    lsof： list opened files<span class="token punctuation">,</span> 列出打开的文件。
    top：监控系统性能工具。
    htop ：交互式的进程浏览器，可以用来替换 top 命令。
    iftop ：主要用来显示本机网络流量情况及各相互通信的流量集合。
    lua：一种嵌入式的脚本语言，从而为应用程序提供灵活的扩展和定制功能。
</code></pre> 
<p>功能</p> 
<pre><code class="prism language-powershell">	Sysdig除了能够获取系统资源利用率、进程、网络连接、系统调用等信息，还具备了非常强的分析能力。Sysdig 不仅能分析Linux 系统的“现场”状态，也能将该状态保存为转储文件以供离线分析检查。同时还可以自定义 Sysdig 的行为，通过内建的名为chisel的小脚本增强其功能。
	通过 Sysdig 可以挖掘非常多的系统信息：用户能够很方便地查看到主机上所有应用程序的cpu、文件 i/o、网络访问状况；Sysdig可以快速进行系统数据的收集和分析；提供了容器级别的信息采集命令，支持查看指定容器之间的网络流量、查看特定容器的 CPU使用情况。
</code></pre> 
<pre><code class="prism language-powershell">项目代码: https:<span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com/draios/sysdig
项目介绍: https:<span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com/draios/sysdig/wiki
</code></pre> 
<pre><code class="prism language-powershell">	伴随着容器技术的大力普及和实践落地，针对容器场景的检测工具也应运而生，Sysdig就属于这里面比较典型的一套开源工具。它不仅仅能够针对传统主机进行检测，更能根据Docker软件在宿主机上落地的方式，自动发现容器内的进程，从而实现容器环境信息的采集和分析，这让我们能够即时了解客户在生产中运行云原生服务的解决方案，这也直接促使sysdig成为适用于服务器和容器的“故障定位和排除工具”。
</code></pre> 
<p>原理解析</p> 
<pre><code class="prism language-powershell">	sysdig通过在内核的驱动模块注册系统调用的hook，这样当系统调用发生和完成的时候，它会把系统调用信息拷贝到特定的buffer，然后通过用户态组件对数据信息处理<span class="token punctuation">(</span>解压、解析、过滤等<span class="token punctuation">)</span>，并最终通过sysdig命令行和用户进行交互。
</code></pre> 
<p><strong>简单实践</strong></p> 
<p>Centos环境部署</p> 
<pre><code class="prism language-powershell">导入软件源
rpm <span class="token operator">--</span>import https:<span class="token operator">/</span><span class="token operator">/</span>download<span class="token punctuation">.</span>sysdig<span class="token punctuation">.</span>com/DRAIOS-GPG-KEY<span class="token punctuation">.</span>public  
curl <span class="token operator">-</span>s <span class="token operator">-</span>o <span class="token operator">/</span>etc/yum<span class="token punctuation">.</span>repos<span class="token punctuation">.</span>d/draios<span class="token punctuation">.</span>repo https:<span class="token operator">/</span><span class="token operator">/</span>download<span class="token punctuation">.</span>sysdig<span class="token punctuation">.</span>com/stable/rpm/draios<span class="token punctuation">.</span>repo

安装软件
yum <span class="token operator">-</span>y install sysdig

加载驱动模块
scap-driver-loader
</code></pre> 
<p>Ubuntu环境部署</p> 
<pre><code class="prism language-powershell">curl <span class="token operator">-</span>s https:<span class="token operator">/</span><span class="token operator">/</span>s3<span class="token punctuation">.</span>amazonaws<span class="token punctuation">.</span>com/download<span class="token punctuation">.</span>draios<span class="token punctuation">.</span>com/DRAIOS-GPG-KEY<span class="token punctuation">.</span>public <span class="token punctuation">|</span> apt-key add <span class="token operator">-</span>
curl <span class="token operator">-</span>s <span class="token operator">-</span>o <span class="token operator">/</span>etc/apt/sources<span class="token punctuation">.</span>list<span class="token punctuation">.</span>d/draios<span class="token punctuation">.</span>list http:<span class="token operator">/</span><span class="token operator">/</span>download<span class="token punctuation">.</span>draios<span class="token punctuation">.</span>com/stable/deb/draios<span class="token punctuation">.</span>list
apt-get update
apt-get <span class="token operator">-</span>y install linux-headers-$<span class="token punctuation">(</span>uname <span class="token operator">-</span>r<span class="token punctuation">)</span>
apt-get <span class="token operator">-</span>y install sysdig
</code></pre> 
<p>容器方式部署</p> 
<pre><code class="prism language-powershell">安装依赖
yum <span class="token operator">-</span>y install kernel-devel-$<span class="token punctuation">(</span>uname <span class="token operator">-</span>r<span class="token punctuation">)</span>
获取容器
docker pull sysdig/sysdig

运行容器
docker run <span class="token operator">-</span>i <span class="token operator">-</span>t <span class="token operator">--</span>name sysdig <span class="token operator">--</span>privileged <span class="token operator">-</span>v <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>run/docker<span class="token punctuation">.</span>sock:<span class="token operator">/</span>host/<span class="token keyword">var</span><span class="token operator">/</span>run/docker<span class="token punctuation">.</span>sock <span class="token operator">-</span>v <span class="token operator">/</span>dev:<span class="token operator">/</span>host/dev <span class="token operator">-</span>v <span class="token operator">/</span>proc:<span class="token operator">/</span>host/proc:ro <span class="token operator">-</span>v <span class="token operator">/</span>boot:<span class="token operator">/</span>host/boot:ro <span class="token operator">-</span>v <span class="token operator">/</span>lib/modules:<span class="token operator">/</span>host/lib/modules:ro <span class="token operator">-</span>v <span class="token operator">/</span>usr:<span class="token operator">/</span>host/usr:ro sysdig/sysdig
</code></pre> 
<p>命令执行</p> 
<pre><code class="prism language-powershell">执行命令
<span class="token comment"># sysdig</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
5121660<span class="token punctuation">[</span>事件号<span class="token punctuation">]</span> 13:29:48<span class="token punctuation">.</span>626497991<span class="token punctuation">[</span>时间<span class="token punctuation">]</span> 1<span class="token namespace">[cpu号]</span> kubelet<span class="token punctuation">[</span>进程名<span class="token punctuation">]</span> <span class="token punctuation">(</span>1755<span class="token punctuation">.</span>1796<span class="token punctuation">[</span>进程id<span class="token punctuation">]</span><span class="token punctuation">)</span> &gt;<span class="token punctuation">[</span>进入事件<span class="token punctuation">]</span> <span class="token keyword">switch</span><span class="token punctuation">[</span>事件名称<span class="token punctuation">]</span> next=0 pgft_maj=0 pgft_min=18233 vm_size=1470308 vm_rss=84660 vm_swap=0<span class="token punctuation">[</span>调用参数<span class="token punctuation">]</span>
5121662 13:29:48<span class="token punctuation">.</span>626983479 1 kubelet <span class="token punctuation">(</span>1755<span class="token punctuation">.</span>1756<span class="token punctuation">)</span> &lt;<span class="token punctuation">[</span>退出事件<span class="token punctuation">]</span> futex res=<span class="token operator">-</span>110<span class="token punctuation">(</span>ETIMEDOUT<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<pre><code class="prism language-powershell">信息显示格式：
<span class="token operator">%</span>evt<span class="token punctuation">.</span>num <span class="token operator">%</span>evt<span class="token punctuation">.</span>outputtime <span class="token operator">%</span>evt<span class="token punctuation">.</span>cpu <span class="token operator">%</span>proc<span class="token punctuation">.</span>name <span class="token punctuation">(</span><span class="token operator">%</span>thread<span class="token punctuation">.</span>tid<span class="token punctuation">)</span> <span class="token operator">%</span>evt<span class="token punctuation">.</span><span class="token function">dir</span> <span class="token operator">%</span>evt<span class="token punctuation">.</span><span class="token function">type</span> <span class="token operator">%</span>evt<span class="token punctuation">.</span>info
    evt<span class="token punctuation">.</span>num： 递增的事件号
    evt<span class="token punctuation">.</span>time： 事件发生的时间
    evt<span class="token punctuation">.</span>cpu： 事件被捕获时所在的 CPU，也就是系统调用是在哪个 CPU 执行的
    proc<span class="token punctuation">.</span>name： 生成事件的进程名字
    thread<span class="token punctuation">.</span>tid： 线程的 id，如果是单线程的程序，这也是进程的 pid
    evt<span class="token punctuation">.</span><span class="token function">dir</span>： 事件的方向，&gt; 代表进入事件，&lt; 代表退出事件
    evt<span class="token punctuation">.</span><span class="token function">type</span>： 事件的名称，比如 open、stat等，一般是系统调用
    evt<span class="token punctuation">.</span>args： 事件的参数。如果是系统调用，这些对应着系统调用的参数
自定义格式输出：sysdig <span class="token operator">-</span>p "user:<span class="token operator">%</span>user<span class="token punctuation">.</span>name time:<span class="token operator">%</span>evt<span class="token punctuation">.</span>time proc_name:<span class="token operator">%</span>proc<span class="token punctuation">.</span>name

</code></pre> 
<h4><a id="112__115"></a>1.1.2 命令实践</h4> 
<p>学习目标</p> 
<p>这一节，我们从 简单实践、扩展实践、小结 三个方面来学习。</p> 
<p><strong>基础知识</strong></p> 
<p>信息检测</p> 
<pre><code class="prism language-powershell">使用sysdig的主要目的主要有两个：
	1 自己进入到容器内部调试一些具体信息
	2 检测基于开源镜像仓库镜像运行的容器是否被嵌入了木马进程
</code></pre> 
<p>命令语法</p> 
<pre><code class="prism language-powershell"><span class="token punctuation">]</span><span class="token comment"># sysdig --help</span>
sysdig version 0<span class="token punctuation">.</span>30<span class="token punctuation">.</span>0
Usage: sysdig <span class="token namespace">[options]</span> <span class="token punctuation">[</span><span class="token operator">-</span>p &lt;output_format&gt;<span class="token punctuation">]</span> <span class="token namespace">[filter]</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token operator">-</span>l<span class="token punctuation">,</span> <span class="token operator">--</span>list：列出可用于过滤和输出的字段
	<span class="token operator">-</span>M &lt;num_seconds&gt; ：信息收集持续时长
	<span class="token operator">-</span>p &lt;output_format&gt;<span class="token punctuation">,</span> <span class="token operator">--</span>print=&lt;output_format&gt; ：指定打印事件时使用的格式
		<span class="token operator">-</span>pc 是容器日志格式；<span class="token operator">-</span>pk 是kubernetes日志格式；<span class="token operator">-</span>pm 是mesos日志格式
	<span class="token operator">-</span>c &lt;chiselname&gt; &lt;chiselargs&gt;：指定内置工具，可直接完成具体的数据聚合、分析工作
	<span class="token operator">-</span>w &lt;filename&gt;：保存到文件中
	<span class="token operator">-</span>r &lt;filename&gt;：从文件中读取
	注意：
		sysdig相关的文件信息只能通过专用命令查看
</code></pre> 
<p>信息的导出导入</p> 
<pre><code class="prism language-powershell">导出信息
<span class="token namespace">[root@kubernetes-node1 ~]</span><span class="token comment"># sysdig -M 5 -w sysdig_test.txt</span>
<span class="token namespace">[root@kubernetes-node1 ~]</span><span class="token comment"># file sysdig_test.txt</span>
sysdig_test<span class="token punctuation">.</span>txt: pcap-ng capture file <span class="token operator">-</span> version 1<span class="token punctuation">.</span>2

查看信息
<span class="token namespace">[root@kubernetes-node1 ~]</span><span class="token comment"># sysdig -r sysdig_test.txt | head -n 5</span>
369 17:25:00<span class="token punctuation">.</span>989023587 0 &lt;NA&gt; <span class="token punctuation">(</span>0<span class="token punctuation">)</span> &gt; <span class="token keyword">switch</span> next=5308<span class="token punctuation">(</span>containerd-shim<span class="token punctuation">)</span> pgft_maj=0 pgft_min=0 vm_size=0 vm_rss=0 vm_swap=0
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<p>指定信息输出</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@kubernetes-node1 ~]</span><span class="token comment"># sysdig -p "user:%user.name time:%evt.time proc_name:%proc.name" | head -n 2</span>
user:root time:17:28:27<span class="token punctuation">.</span>818719900 proc_name:sysdig
user:root time:17:28:27<span class="token punctuation">.</span>819033893 proc_name:sysdig
</code></pre> 
<pre><code class="prism language-powershell">采用普通容器方式查看信息
<span class="token namespace">[root@kubernetes-node1 ~]</span><span class="token comment"># sysdig -pc | head -n 2</span>
15 17:30:33<span class="token punctuation">.</span>546129321 1 &lt;NA&gt; <span class="token punctuation">(</span>&lt;NA&gt;<span class="token punctuation">)</span> &lt;NA&gt; <span class="token punctuation">(</span>0:&lt;NA&gt;<span class="token punctuation">)</span> &gt; <span class="token keyword">switch</span> next=9 pgft_maj=0 pgft_min=0 vm_size=0 vm_rss=0 vm_swap=0
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
采用kubernetes方式查看信息
<span class="token namespace">[root@kubernetes-node1 ~]</span><span class="token comment"># sysdig -pk | head -n 2</span>
23 17:30:37<span class="token punctuation">.</span>073045020 0 &lt;NA&gt; <span class="token punctuation">(</span>&lt;NA&gt;<span class="token punctuation">)</span> &lt;NA&gt; <span class="token punctuation">(</span>0:&lt;NA&gt;<span class="token punctuation">)</span> &gt; <span class="token keyword">switch</span> next=9 pgft_maj=0 pgft_min=0 vm_size=0 vm_rss=0 vm_swap=0
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
采用mesos方式查看信息
<span class="token namespace">[root@kubernetes-node1 ~]</span><span class="token comment"># sysdig -pm | head -n 2</span>
17 17:30:40<span class="token punctuation">.</span>695954481 0 &lt;NA&gt; <span class="token punctuation">(</span>host<span class="token punctuation">)</span> sysdig <span class="token punctuation">(</span>126131:126131<span class="token punctuation">)</span> &gt; <span class="token keyword">switch</span> next=0 pgft_maj=0 pgft_min=5086 vm_size=107468 vm_rss=12004 vm_swap=0
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<p>信息过滤</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@kubernetes-node1 ~]</span><span class="token comment"># sysdig -l | grep "Field Class"</span>
Field <span class="token keyword">Class</span>:                  evt <span class="token punctuation">(</span>All event types<span class="token punctuation">)</span>
Field <span class="token keyword">Class</span>:                  <span class="token keyword">process</span>
Field <span class="token keyword">Class</span>:                  user
Field <span class="token keyword">Class</span>:                  <span class="token function">group</span>
Field <span class="token keyword">Class</span>:                  container
Field <span class="token keyword">Class</span>:                  fd
Field <span class="token keyword">Class</span>:                  syslog
Field <span class="token keyword">Class</span>:                  fdlist
Field <span class="token keyword">Class</span>:                  k8s
Field <span class="token keyword">Class</span>:                  mesos
Field <span class="token keyword">Class</span>:                  span
Field <span class="token keyword">Class</span>:                  evtin
结果显示：
	sysdig 可以支持12类信息的过滤显示
</code></pre> 
<pre><code class="prism language-powershell">语法格式
	sysdig 属性字段<span class="token punctuation">[</span>操作符号<span class="token punctuation">]</span>值
示例：
	sysdig proc<span class="token punctuation">.</span>name=kubelet
	
操作符号：
	这里的操作符号支持 =、<span class="token operator">!</span>=、&gt;=、&lt;=、&gt;、&lt;、contains、in、exists、and、or、not等
</code></pre> 
<p>信息过滤实践</p> 
<pre><code class="prism language-powershell">查看进程的系统调用
<span class="token namespace">[root@kubernetes-node1 ~]</span><span class="token comment"># sysdig proc.name=kubelet | head -n 2</span>
255 17:42:58<span class="token punctuation">.</span>846155860 0 kubelet <span class="token punctuation">(</span>1794<span class="token punctuation">)</span> &gt; futex addr=C000105148 op=129<span class="token punctuation">(</span>FUTEX_PRIVATE_FLAG<span class="token punctuation">)</span> val=1
256 17:42:58<span class="token punctuation">.</span>846174388 0 kubelet <span class="token punctuation">(</span>1794<span class="token punctuation">)</span> &lt; futex res=1
</code></pre> 
<pre><code class="prism language-powershell">查看tcp连接系统调用
<span class="token namespace">[root@kubernetes-node1 ~]</span><span class="token comment"># sysdig evt.type=accept | head -n 2</span>
10593 17:44:00<span class="token punctuation">.</span>830242006 1 dockerd <span class="token punctuation">(</span>1408<span class="token punctuation">)</span> &gt; accept flags=0
10595 17:44:00<span class="token punctuation">.</span>830248505 1 dockerd <span class="token punctuation">(</span>1408<span class="token punctuation">)</span> &lt; accept fd=80<span class="token punctuation">(</span>&lt;u&gt;ffff908149c41100-&gt;ffff908149c46e80 <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>run/docker<span class="token punctuation">.</span>sock<span class="token punctuation">)</span> tuple=ffff908149c41100-&gt;ffff908149c46e80 <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>run/docker<span class="token punctuation">.</span>sock queuepct=0 queuelen=0 queuemax=128
</code></pre> 
<pre><code class="prism language-powershell">查看指定文件查看的系统调用
<span class="token namespace">[root@kubernetes-node1 ~]</span><span class="token comment"># sysdig fd.name contains /opt | head -n 2</span>
28727 17:44:50<span class="token punctuation">.</span>118569699 1 calico <span class="token punctuation">(</span>10424<span class="token punctuation">)</span> &lt; openat fd=3<span class="token punctuation">(</span>&lt;f&gt;<span class="token operator">/</span>opt/cni/bin/calico<span class="token punctuation">)</span> dirfd=<span class="token operator">-</span>100<span class="token punctuation">(</span>AT_FDCWD<span class="token punctuation">)</span> name=<span class="token operator">/</span>opt/cni/bin/calico flags=4097<span class="token punctuation">(</span>O_RDONLY<span class="token punctuation">|</span>O_CLOEXEC<span class="token punctuation">)</span> mode=0 dev=802 ino=50410640
28736 17:44:50<span class="token punctuation">.</span>118595902 1 calico <span class="token punctuation">(</span>10424<span class="token punctuation">)</span> &gt; fstat fd=3<span class="token punctuation">(</span>&lt;f&gt;<span class="token operator">/</span>opt/cni/bin/calico<span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-powershell">查看容器的系统调用
<span class="token namespace">[root@kubernetes-node1 ~]</span><span class="token comment"># sysdig -M 10 container.name startswith 'k8s' | head -n 2</span>
4 18:03:06<span class="token punctuation">.</span>314990614 0 calico-node <span class="token punctuation">(</span>7681<span class="token punctuation">)</span> &lt; nanosleep res=0
5 18:03:06<span class="token punctuation">.</span>314995749 0 calico-node <span class="token punctuation">(</span>7681<span class="token punctuation">)</span> &gt; futex addr=49670D8 op=128 val=0
</code></pre> 
<p><strong>工具集实践</strong></p> 
<p>简介</p> 
<pre><code class="prism language-powershell">	在sysdig中，存在一系列的实用工具集 <span class="token operator">--</span> chisels，它们是一组预定义好的功能集合，我们用来分析特定场景。我们可以通过sysdig <span class="token operator">-</span>cl 的方式罗列所有可用的工具集信息。
</code></pre> 
<pre><code class="prism language-powershell">使用命令格式
	sysdig <span class="token operator">-</span>c 工具集
</code></pre> 
<pre><code class="prism language-powershell">查看能够使用的工具集场景
<span class="token namespace">[root@kubernetes-node1 ~]</span><span class="token comment"># sysdig -cl | grep Category</span>
Category: Application			<span class="token comment"># http web应用统计信息</span>
Category: CPU Usage				<span class="token comment"># CPU统计信息</span>
Category: Errors				<span class="token comment"># 错误统计信息</span>
Category: I/O					<span class="token comment"># 输入输出统计信息</span>
Category: Logs					<span class="token comment"># 日志信息</span>
Category: Misc					<span class="token comment"># 其他信息</span>
Category: Net					<span class="token comment"># 网络信息</span>
Category: Performance			<span class="token comment"># 性能信息</span>
Category: Security				<span class="token comment"># 安全信息</span>
Category: System State			<span class="token comment"># 系统状态</span>
Category: Tracers				<span class="token comment"># 跟踪信息</span>
</code></pre> 
<p>查看信息</p> 
<pre><code class="prism language-powershell">查看进程的网络信息
<span class="token namespace">[root@kubernetes-node1 ~]</span><span class="token comment"># sysdig -c topprocs_net</span>
Bytes               <span class="token keyword">Process</span>             PID
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
8<span class="token punctuation">.</span>42KB              manager             8636
64B                 sshd                39374
Bytes               <span class="token keyword">Process</span>             PID
</code></pre> 
<pre><code class="prism language-powershell">查看网络连接信息
<span class="token namespace">[root@kubernetes-node1 ~]</span><span class="token comment"># sysdig -c netstat</span>
Proto Server Address  Client Address   State          TID/PID/Program Name
tcp   10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>15:22    10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:55501   ESTABLISHED    39422/39422/sshd
tcp   10<span class="token punctuation">.</span>96<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:443   10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>15:36708  ESTABLISHED    7735/7680/calico-node
tcp   10<span class="token punctuation">.</span>96<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:443   10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>15:36708  ESTABLISHED    7719/7680/calico-node
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<pre><code class="prism language-powershell">查看容器的cpu使用率信息
<span class="token namespace">[root@kubernetes-node1 ~]</span><span class="token comment"># sysdig -pc -c topprocs_cpu container.name contains 'k8s'</span>
CPU%                <span class="token keyword">Process</span>  Host_pid  Container_pid  container<span class="token punctuation">.</span>name
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
0<span class="token punctuation">.</span>00%               runsv    7672      69             k8s_calico-node_calico-<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
0<span class="token punctuation">.</span>00%               nginx    7296      1              k8s_backend_app-svc-app-<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<pre><code class="prism language-powershell">运行一个容器
docker run <span class="token operator">-</span>d <span class="token operator">--</span>name nginx_web <span class="token operator">-</span>p 888:80 kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/nginx_web:v0<span class="token punctuation">.</span>1

开启监控
<span class="token namespace">[root@kubernetes-node1 ~]</span><span class="token comment"># sysdig -s 2000 -A -c echo_fds fd.port=80 and evt.buffer contains GET</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> Read 77B <span class="token keyword">from</span>   10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>16:51818-&gt;172<span class="token punctuation">.</span>17<span class="token punctuation">.</span>0<span class="token punctuation">.</span>2:80 <span class="token punctuation">(</span>nginx<span class="token punctuation">)</span>
GET <span class="token operator">/</span> HTTP/1<span class="token punctuation">.</span>1
User-Agent: curl/7<span class="token punctuation">.</span>29<span class="token punctuation">.</span>0
Host: 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>15:888
Accept: <span class="token operator">*</span><span class="token operator">/</span><span class="token operator">*</span>
注意：
	需要另开一个终端访问 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>15:888，然后才会有返回信息。
</code></pre> 
<pre><code class="prism language-powershell">查看文件打开的相关信息
<span class="token namespace">[root@kubernetes-node1 ~]</span><span class="token comment"># sysdig -c fdcount_by proc.name "fd.type=file"</span>
kubelet 1632
dockerd 1127
containerd-shim 504
注意：
	通过 Ctrl <span class="token operator">+</span> C 的方式才可以在最终查看效果，否则不会有信息显示
</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@kubernetes-node1 ~]</span><span class="token comment"># sysdig -c topfiles_time</span>
Time                Filename
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
91us                <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib/docker/image/overlay2/imagedb/content/sha256/221177c6<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>5
</code></pre> 
<pre><code class="prism language-powershell">查看进程收到错误信息
<span class="token namespace">[root@kubernetes-node1 ~]</span><span class="token comment"># sysdig -c topprocs_errors</span>
<span class="token comment">#Errors             Process             PID</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
31                  kubelet             1755
30                  dockerd             1225
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<pre><code class="prism language-powershell">查看和<span class="token operator">/</span>etc 目录相关的打开事件信息
<span class="token namespace">[root@kubernetes-node1 ~]</span><span class="token comment"># sysdig evt.type=open and fd.name contains /etc</span>
33987 19:03:06<span class="token punctuation">.</span>310083229 0 iptables <span class="token punctuation">(</span>92297<span class="token punctuation">.</span>92297<span class="token punctuation">)</span> &lt; open fd=3<span class="token punctuation">(</span>&lt;f&gt;<span class="token operator">/</span>etc/ld<span class="token punctuation">.</span>so<span class="token punctuation">.</span>cache<span class="token punctuation">)</span> name=<span class="token operator">/</span>etc/ld<span class="token punctuation">.</span>so<span class="token punctuation">.</span>cache flags=4097<span class="token punctuation">(</span>O_RDONLY<span class="token punctuation">|</span>O_CLOEXEC<span class="token punctuation">)</span> mode=0 dev=802 ino=17212445
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<p><strong>小结</strong></p> 
<pre><code>
</code></pre> 
<h3><a id="12__363"></a>1.2 容器监控</h3> 
<h4><a id="121_CAdvisor_365"></a>1.2.1 CAdvisor</h4> 
<p>学习目标</p> 
<p>这一节，我们从 软件简介、简单实践、小结 三个方面来学习。</p> 
<p><strong>软件简介</strong></p> 
<p>专属状态命令</p> 
<pre><code class="prism language-powershell">查看容器的专属状态信息
<span class="token namespace">[root@kubernetes-node1 ~]</span><span class="token comment"># docker stats --no-stream</span>
CONTAINER ID   NAME       CPU <span class="token operator">%</span>     MEM USAGE <span class="token operator">/</span> LIMIT     MEM <span class="token operator">%</span>     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
5a3c015d6cca   nginx_web  0<span class="token punctuation">.</span>00%     2<span class="token punctuation">.</span>27MiB <span class="token operator">/</span> 3<span class="token punctuation">.</span>682GiB    0<span class="token punctuation">.</span>06%     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
b105095db79e   k8s_m<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>6  0<span class="token punctuation">.</span>42%     39<span class="token punctuation">.</span>4MiB <span class="token operator">/</span> 512MiB      7<span class="token punctuation">.</span>70%     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
14d961970119   k8s_c<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>7  1<span class="token punctuation">.</span>71%     139<span class="token punctuation">.</span>6MiB <span class="token operator">/</span> 3<span class="token punctuation">.</span>682GiB   3<span class="token punctuation">.</span>70%     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<p>软件简介</p> 
<pre><code class="prism language-powershell">cadvisor<span class="token punctuation">(</span>Container Advisor<span class="token punctuation">)</span> 是 Google 开源的一个容器监控工具，它以守护进程方式运行，用于收集、聚合、处理和导出正在运行容器的有关信息。具体来说，该组件对每个容器都会记录其资源隔离参数、历史资源使用情况、完整历史资源使用情况的直方图和网络统计信息。它不仅可以搜集一台机器上所有运行的容器信息，还提供基础查询界面和http接口，方便其他组件如Prometheus进行数据抓取
 	cAdvisor使用Go语言开发，对Node机器上的资源及容器进行实时监控和性能数据采集，包括CPU使用情况、内存使用情况、网络吞吐量及文件系统使用情况，利用Linux的cgroups获取容器的资源使用信息，可用于对容器资源的使用情况和性能进行监控。。
 注意：
 	一个cAdvisor仅对一台主机进行监控。
</code></pre> 
<pre><code>项目主页：http://github.com/google/cadvisor。
最新版本：0.45.0
下载地址：
 	https://github.com/google/cadvisor/releases/latest
 	https://github.com/google/cadvisor/archive/refs/tags/v0.45.0.tar.gz

</code></pre> 
<p>监控原理</p> 
<pre><code class="prism language-powershell">	CAdvisor运行时挂载了宿主机根目录，docker根目录等多个目录，由此可以从中读取容器的运行时信息。docker基础技术有Linux namespace，Control <span class="token function">Group</span><span class="token punctuation">(</span>CGroup<span class="token punctuation">)</span>，AUFS等，其中CGroup用于系统资源限制和优先级控制的。
	宿主机的<span class="token operator">/</span>sys/fs/cgroup/目录下面存储的就是CGroup的内容了，CGroup包括多个子系统，如对块设备的blkio，cpu，内存，网络IO等限制。Docker在CGroup里面的各个子系统中创建了docker目录，而CAdvisor运行时挂载了宿主机根目录和 <span class="token operator">/</span>sys目录，从而CAdvisor可以读取到容器的资源使用记录。
</code></pre> 
<p><strong>简单实践</strong></p> 
<p>源代码安装cAdvisor</p> 
<pre><code class="prism language-powershell">获取软件
cd <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>softs
wget https:<span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com/google/cadvisor/archive/refs/tags/v0<span class="token punctuation">.</span>45<span class="token punctuation">.</span>0<span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz
tar xf v0<span class="token punctuation">.</span>45<span class="token punctuation">.</span>0<span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz <span class="token operator">-</span>C <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>server
ln <span class="token operator">-</span>s <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>server/cadvisor-0<span class="token punctuation">.</span>45<span class="token punctuation">.</span>0 <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>server/cadvisor
cd <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>server/cadvisor
chmod <span class="token operator">+</span>x <span class="token punctuation">.</span><span class="token operator">/</span>build/assets<span class="token punctuation">.</span>sh
注意：
	源码方式部署可以查看 <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>server/cadvisor/docs/runtime_options<span class="token punctuation">.</span>md 文件
</code></pre> 
<pre><code class="prism language-powershell">安装go环境，必须在 1<span class="token punctuation">.</span>14+ 版本
mkdir <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>softs &amp;&amp; cd <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>softs
wget https:<span class="token operator">/</span><span class="token operator">/</span>studygolang<span class="token punctuation">.</span>com/dl/golang/go1<span class="token punctuation">.</span>17<span class="token punctuation">.</span>6<span class="token punctuation">.</span>linux-amd64<span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz
<span class="token function">rm</span> <span class="token operator">-</span>rf <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>server/go &amp;&amp; tar <span class="token operator">-</span>C <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>server <span class="token operator">-</span>xf go1<span class="token punctuation">.</span>17<span class="token punctuation">.</span>6<span class="token punctuation">.</span>linux-amd64<span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz
<span class="token function">echo</span> <span class="token string">'export GOROOT=/data/server/go'</span> &gt; <span class="token operator">/</span>etc/profile<span class="token punctuation">.</span>d/go<span class="token punctuation">.</span>sh
<span class="token function">echo</span> <span class="token string">'export PATH=$PATH:$GOROOT/bin'</span> &gt;&gt; <span class="token operator">/</span>etc/profile<span class="token punctuation">.</span>d/go<span class="token punctuation">.</span>sh
source <span class="token operator">/</span>etc/profile<span class="token punctuation">.</span>d/go<span class="token punctuation">.</span>sh
go version

获取软件
go get <span class="token operator">-</span>d github<span class="token punctuation">.</span>com/google/cadvisor
go env <span class="token operator">-</span>w GOPROXY=https:<span class="token operator">/</span><span class="token operator">/</span>goproxy<span class="token punctuation">.</span>cn
apt-get install libpfm4 libpfm4-dev jq
</code></pre> 
<pre><code class="prism language-powershell">编译安装cadvisor
make build

确认效果
<span class="token function">ls</span>
</code></pre> 
<pre><code class="prism language-powershell">启动cadvisor
<span class="token punctuation">.</span><span class="token operator">/</span>cadvisor  <span class="token operator">-</span>port=8080 &amp;&gt;&gt;<span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>log/cadvisor<span class="token punctuation">.</span>log

浏览器访问 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>15:8080，可以查看cadvisor的默认ui页面的浏览器效果
</code></pre> 
<p><img src="https://images2.imgbox.com/bb/3b/h613ewTp_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-powershell">浏览器访问 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>15:8080/metrics，可以查看cadvisor的默认采集的容器指标效果
注意：
	url是 <span class="token operator">/</span>metrics 不是 <span class="token operator">/</span>metrics/
</code></pre> 
<p>docker方式安装cadvisor环境</p> 
<pre><code class="prism language-powershell">容器属性来源
	https:<span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com/google/cadvisor/releases
	
获取cadvisor的docker镜像
docker pull gcr<span class="token punctuation">.</span>io/cadvisor/cadvisor:v0<span class="token punctuation">.</span>45<span class="token punctuation">.</span>0

启动容器
docker run \
  <span class="token operator">--</span>volume=<span class="token operator">/</span>:<span class="token operator">/</span>rootfs:ro <span class="token operator">--</span>volume=<span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>run:<span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>run:ro <span class="token operator">--</span>volume=<span class="token operator">/</span>sys:<span class="token operator">/</span>sys:ro \
  <span class="token operator">--</span>volume=<span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib/docker/:<span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib/docker:ro <span class="token operator">--</span>volume=<span class="token operator">/</span>dev/disk/:<span class="token operator">/</span>dev/disk:ro \
  <span class="token operator">--</span>publish=8080:8080 <span class="token operator">--</span>detach=true <span class="token operator">--</span>name=cadvisor <span class="token operator">--</span>privileged \
  <span class="token operator">--</span>device=<span class="token operator">/</span>dev/kmsg gcr<span class="token punctuation">.</span>io/cadvisor/cadvisor:v0<span class="token punctuation">.</span>45<span class="token punctuation">.</span>0
</code></pre> 
<pre><code class="prism language-powershell">查看专属的监控指标格式
<span class="token namespace">[root@kubernetes-node1 ~]</span><span class="token comment"># curl -s 10.0.0.15:8080/metrics | head -n 3</span>
<span class="token comment"># HELP cadvisor_version_info A metric with a constant '1' value labeled by kernel version, OS version, docker version, cadvisor version &amp; cadvisor revision.</span>
<span class="token comment"># TYPE cadvisor_version_info gauge</span>
cadvisor_version_info<span class="token punctuation">{<!-- --></span>cadvisorRevision=<span class="token string">"86b11c65"</span><span class="token punctuation">,</span>cadvisorVersion=<span class="token string">"v0.45.0"</span><span class="token punctuation">,</span>dockerVersion=<span class="token string">""</span><span class="token punctuation">,</span>kernelVersion=<span class="token string">"3.10.0-1160.el7.x86_64"</span><span class="token punctuation">,</span>osVersion=<span class="token string">"Alpine Linux v3.16"</span><span class="token punctuation">}</span> 1
</code></pre> 
<p><strong>小结</strong></p> 
<pre><code>
</code></pre> 
<h4><a id="122_Falco_503"></a>1.2.2 Falco基础</h4> 
<p>学习目标</p> 
<p>这一节，我们从 软件简介、功能解读、小结 三个方面来学习。</p> 
<p><strong>软件简介</strong></p> 
<p>需求</p> 
<pre><code class="prism language-powershell">	随着容器化应用的普及，由于容器应用的变动频率过于大，据相关统计数据显示，容器寿命普遍较短，导致它非常不利于故障响应、故障定位和故障解决，可能给容器底层的主机造成安全的隐患。
	由于容器的工作模式是共享宿主机内核，所以它面临着各种安全的问题，比如 耗尽主机的进程资源、容器逃逸等带来的安全隐患。虽然我们有 gVisor 和 Kata Container 等更加安全的容器技术演进，但是使用场景还是有所局限。
</code></pre> 
<p>简介</p> 
<pre><code class="prism language-powershell">	Falco是Sysdig开源的一款为云原生平台设计的进程异常行为检测工具，它通过灵活的规则引擎来描述任何类型的主机或者容器的行为和活动，在触发策略规则后可以实时发出警报告警，从而检测传统主机上的应用程序，同时支持将告警集成到各种工作流或者告警通道，同时 Falco 可利用最新的检测规则针对恶意活动和 CVE 漏洞发出警报，而且规则可以实现动态更新和开箱即用。同时它还支持接入系统调用事件和Kubernetes审计日志，也能够检测容器环境和云平台。
</code></pre> 
<pre><code class="prism language-powershell">Falco能够检测所有涉及系统调用的进程行为。
	某容器中启动了一个shell
	某服务进程创建了一个非预期类型的子进程
	<span class="token operator">/</span>etc/shadow文件被读写
	<span class="token operator">/</span>dev目录下创建了一个非设备文件
	<span class="token function">ls</span>之类的常规系统工具向外进行了对外网络通信
	
Falco还可以检测云环境下的特有行为。例如：
	创建了带有特权容器、挂载敏感路径或使用了宿主机网络的Pod
	向用户授予大范围权限（例如cluster-admin）
	创建了带有敏感信息的configmap
</code></pre> 
<pre><code class="prism language-powershell">官方网站：https:<span class="token operator">/</span><span class="token operator">/</span>falco<span class="token punctuation">.</span>org/docs/getting-started/installation/
github地址: https:<span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com/falcosecurity/falco
最新版本：0<span class="token punctuation">.</span>33<span class="token punctuation">.</span>0
</code></pre> 
<p>特点</p> 
<pre><code class="prism language-powershell">	Falco主要依赖于底层Sysdig内核模块提供的系统调用事件流，提供的是一种连续式实时监控功能；
	Falco自身运行在用户空间，仅仅借助内核模块来获得数据，Falco的规则变更和程序起止要更为灵活；
	Falco具有非常易学的规则语法和对云环境的支持。
	Falco采用C+<span class="token operator">+</span>语言编写，但它提供了丰富的告警输出方式，因此能够非常方便地与其他工具协同工作。
</code></pre> 
<p><strong>功能解读</strong></p> 
<p>程序结构</p> 
<pre><code class="prism language-powershell">	Falco是一个基于规则的进程异常行为检测工具，它支持常见的基于Sysdig内核模块 和 Kubernetes审计日志的信息采集。而且它支持多种数据输出机制，比如 标准输出、文件、Syslog、HTTP服务、其他程序<span class="token punctuation">(</span>管道方式<span class="token punctuation">)</span>等。
</code></pre> 
<p><img src="https://images2.imgbox.com/d4/6b/afkdP3r8_o.png" alt="在这里插入图片描述"></p> 
<p>匹配流程</p> 
<pre><code class="prism language-powershell">	Falco采用规则匹配方式来检测异常，默认情况下，它自带了一份规则文件<span class="token operator">/</span>etc/falco/falco_rules<span class="token punctuation">.</span>yaml 供使用，当然我们也可以自己定义的规则文件。
	以系统调用为例：
		1 加载Sysdig内核模块，Falco程序读取并解析配置文件和规则文件、初始化规则引擎
		2 Sysdig检测进程的系统调用，然后捕获系统调用，并把详细信息传给Falco，Falco对这些信息作规则匹配，如果满足规则就通过约定好的方式输出告警。上述工作流程可以表示如下：
</code></pre> 
<p><img src="https://images2.imgbox.com/94/1c/F5UvSxPp_o.png" alt="在这里插入图片描述"></p> 
<p>规则解析</p> 
<pre><code class="prism language-powershell">Falco的规则文件使用 YAML 格式，它决定了一个事件是否应该被视作异常行为。一个规则文件包含三类元素：
	规则：一条规则是描述“在什么条件下生成什么样的告警”的规定
	宏：这里宏的意义与C语言中的基本相同，它是一些“判定条件片段”，能够在不同的规则甚至宏中复用
	列表：即元素集合，能够被规则、宏或者其他列表使用
</code></pre> 
<pre><code class="prism language-powershell">示例：
<span class="token operator">-</span> rule: &lt;rule_name&gt; 				<span class="token comment"># 规则名：必须是独一无二的名称</span>
  desc: &lt;xxx&gt;  						<span class="token comment"># 描述文字：对规则的详细说明</span>
  condition: &gt; 						<span class="token comment"># 条件：用来筛选事件的过滤表达式（Falco采用Sysdig的过滤语法）</span>
    spawned_process and container
    and shell_procs and proc<span class="token punctuation">.</span>tty <span class="token operator">!</span>= 0
    and container_entrypoint
  output: &gt; 						<span class="token comment"># 输出信息：与规则匹配的事件发生时，输出的告警信息</span>
    xxx
  priority: NOTICE 					<span class="token comment"># 优先级：表示事件严重程度，包括 'emergency', 'alert'</span>
  									<span class="token comment"># 'critical', 'error', 'warning', 'notice'</span>
  									<span class="token comment"># 'informational', 'debug'</span>
  tags: <span class="token namespace">[key1, key2 ]</span>				<span class="token comment"># 方便管理的标签</span>
</code></pre> 
<p><strong>小结</strong></p> 
<pre><code>
</code></pre> 
<h4><a id="123_Falco_613"></a>1.2.3 Falco实践</h4> 
<p>学习目标</p> 
<p>这一节，我们从 环境部署、简单实践、小结 三个方面来学习。</p> 
<p><strong>环境部署</strong></p> 
<p>Ubuntu环境</p> 
<pre><code class="prism language-powershell">软件源配置
curl <span class="token operator">-</span>s https:<span class="token operator">/</span><span class="token operator">/</span>falco<span class="token punctuation">.</span>org/repo/falcosecurity-3672BA8F<span class="token punctuation">.</span>asc <span class="token punctuation">|</span> apt-key add <span class="token operator">-</span>
<span class="token function">echo</span> <span class="token string">"deb https://download.falco.org/packages/deb stable main"</span> <span class="token punctuation">|</span> <span class="token function">tee</span> <span class="token operator">-</span>a <span class="token operator">/</span>etc/apt/sources<span class="token punctuation">.</span>list<span class="token punctuation">.</span>d/falcosecurity<span class="token punctuation">.</span>list
apt-get update <span class="token operator">-</span>y
</code></pre> 
<pre><code class="prism language-powershell">安装软件
apt-get <span class="token operator">-</span>y install linux-headers-$<span class="token punctuation">(</span>uname <span class="token operator">-</span>r<span class="token punctuation">)</span>
apt-get install <span class="token operator">-</span>y falco
</code></pre> 
<p>Centos环境</p> 
<pre><code class="prism language-powershell">软件源配置
rpm <span class="token operator">--</span>import https:<span class="token operator">/</span><span class="token operator">/</span>falco<span class="token punctuation">.</span>org/repo/falcosecurity-3672BA8F<span class="token punctuation">.</span>asc
curl <span class="token operator">-</span>s <span class="token operator">-</span>o <span class="token operator">/</span>etc/yum<span class="token punctuation">.</span>repos<span class="token punctuation">.</span>d/falcosecurity<span class="token punctuation">.</span>repo https:<span class="token operator">/</span><span class="token operator">/</span>falco<span class="token punctuation">.</span>org/repo/falcosecurity-rpm<span class="token punctuation">.</span>repo
</code></pre> 
<pre><code class="prism language-powershell">安装软件
yum <span class="token operator">-</span>y install kernel-devel-$<span class="token punctuation">(</span>uname <span class="token operator">-</span>r<span class="token punctuation">)</span>
yum <span class="token operator">-</span>y install falco
注意：
	这个软件安装完毕后，falco<span class="token punctuation">.</span>service 服务是开机自启动样式。
</code></pre> 
<p>配置文件</p> 
<pre><code class="prism language-powershell">falco 配置文件目录：<span class="token operator">/</span>etc/falco
<span class="token namespace">[root@kubernetes-node1 ~]</span><span class="token comment"># ll /etc/falco/</span>
aws_cloudtrail_rules<span class="token punctuation">.</span>yaml
falco_rules<span class="token punctuation">.</span>local<span class="token punctuation">.</span>yaml			<span class="token comment"># 自定义扩展规则文件</span>
falco_rules<span class="token punctuation">.</span>yaml				<span class="token comment"># 默认的规则文件</span>
falco<span class="token punctuation">.</span>yaml						<span class="token comment"># falco配置和告警通知方式</span>
k8s_audit_rules<span class="token punctuation">.</span>yaml			<span class="token comment"># k8s相关的日志审计规则</span>
rules<span class="token punctuation">.</span>available
rules<span class="token punctuation">.</span>d							<span class="token comment"># 扩展的规则目录</span>
</code></pre> 
<p>告警示例</p> 
<pre><code class="prism language-powershell"><span class="token punctuation">]</span><span class="token comment"># cat falco_rules.yaml</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">-</span> rule: Read environment variable <span class="token keyword">from</span> <span class="token operator">/</span>proc files
  desc: An attempt to read <span class="token keyword">process</span> environment variables <span class="token keyword">from</span> <span class="token operator">/</span>proc files
  condition: &gt;
    open_read and container and <span class="token punctuation">(</span>fd<span class="token punctuation">.</span>name glob <span class="token operator">/</span>proc/<span class="token operator">*</span><span class="token operator">/</span>environ<span class="token punctuation">)</span>
    and not proc<span class="token punctuation">.</span>name in <span class="token punctuation">(</span>known_binaries_to_read_environment_variables_from_proc_files<span class="token punctuation">)</span>
  output: &gt;
    Environment variables were retrieved <span class="token keyword">from</span> <span class="token operator">/</span>proc files <span class="token punctuation">(</span>user=<span class="token operator">%</span>user<span class="token punctuation">.</span>name user_loginuid=<span class="token operator">%</span>user<span class="token punctuation">.</span>loginuid program=<span class="token operator">%</span>proc<span class="token punctuation">.</span>name
    command=<span class="token operator">%</span>proc<span class="token punctuation">.</span>cmdline pid=<span class="token operator">%</span>proc<span class="token punctuation">.</span>pid file=<span class="token operator">%</span>fd<span class="token punctuation">.</span>name parent=<span class="token operator">%</span>proc<span class="token punctuation">.</span>pname gparent=<span class="token operator">%</span>proc<span class="token punctuation">.</span>aname<span class="token punctuation">[</span>2<span class="token punctuation">]</span> ggparent=<span class="token operator">%</span>proc<span class="token punctuation">.</span>aname<span class="token punctuation">[</span>3<span class="token punctuation">]</span> gggparent=<span class="token operator">%</span>proc<span class="token punctuation">.</span>aname<span class="token punctuation">[</span>4<span class="token punctuation">]</span> container_id=<span class="token operator">%</span>container<span class="token punctuation">.</span>id image=<span class="token operator">%</span>container<span class="token punctuation">.</span>image<span class="token punctuation">.</span>repository<span class="token punctuation">)</span>
  priority: WARNING
  tags: <span class="token namespace">[filesystem, mitre_credential_access, mitre_discovery]</span>
</code></pre> 
<p><strong>简单实践</strong></p> 
<p>实践1 - 敏感规则</p> 
<pre><code class="prism language-powershell">查看默认规则
<span class="token operator">-</span> macro: bin_dir_mkdir
  condition: &gt;
     <span class="token punctuation">(</span>evt<span class="token punctuation">.</span>arg<span class="token punctuation">.</span>path startswith <span class="token operator">/</span>bin/ or
     evt<span class="token punctuation">.</span>arg<span class="token punctuation">.</span>path startswith <span class="token operator">/</span>sbin/ or
     evt<span class="token punctuation">.</span>arg<span class="token punctuation">.</span>path startswith <span class="token operator">/</span>usr/bin/ or
     evt<span class="token punctuation">.</span>arg<span class="token punctuation">.</span>path startswith <span class="token operator">/</span>usr/sbin/<span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-powershell">在敏感目录创建文件
<span class="token namespace">[root@kubernetes-node1 ~]</span><span class="token comment"># mkdir /usr/bin/nihao</span>

查看日志信息
<span class="token namespace">[root@kubernetes-node1 ~]</span><span class="token comment"># grep nihao /var/log/messages</span>
Oct 25 22:47:41 kubernetes-node1 falco: 22:47:41<span class="token punctuation">.</span>734005457: Error Directory below known binary directory created <span class="token punctuation">(</span>user=root user_loginuid=0 command=mkdir <span class="token operator">/</span>usr/bin/nihao pid=5542 directory=<span class="token operator">/</span>usr/bin/nihao container_id=host image=&lt;NA&gt;<span class="token punctuation">)</span>
</code></pre> 
<p>实践2 - 监控根目录，禁止写</p> 
<pre><code class="prism language-powershell">查看规则文件
<span class="token operator">-</span> macro: root_dir
  condition: <span class="token punctuation">(</span>fd<span class="token punctuation">.</span>directory=<span class="token operator">/</span> or fd<span class="token punctuation">.</span>name startswith <span class="token operator">/</span>root/<span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-powershell">在敏感目录创建文件
<span class="token namespace">[root@kubernetes-node1 ~]</span><span class="token comment"># echo 'test_file' &gt; /root/root_test.txt</span>

查看日志信息
<span class="token namespace">[root@kubernetes-node1 ~]</span><span class="token comment"># grep 'root_test.txt' /var/log/messages</span>
Oct 25 22:52:32 kubernetes-node1 falco: 22:52:32<span class="token punctuation">.</span>314707668: Error File below <span class="token operator">/</span> or <span class="token operator">/</span>root opened <span class="token keyword">for</span> writing <span class="token punctuation">(</span>user=root user_loginuid=0 command=bash pid=5474 parent=sshd file=<span class="token operator">/</span>root/root_test<span class="token punctuation">.</span>txt program=bash container_id=host image=&lt;NA&gt;<span class="token punctuation">)</span>
</code></pre> 
<p>实践3 - 容器操作</p> 
<pre><code class="prism language-powershell">查看规则文件
<span class="token operator">-</span> rule: Terminal shell in container
  desc: A shell was used as the entrypoint/exec point into a container with an attached terminal<span class="token punctuation">.</span>
  condition: &gt;
    spawned_process and container
    and shell_procs and proc<span class="token punctuation">.</span>tty <span class="token operator">!</span>= 0
    and container_entrypoint
    and not user_expected_terminal_shell_in_container_conditions
    <span class="token comment"># spawned_process、container和shell_procs及container_entrypoint是四个宏</span>
  output: &gt;
    A shell was spawned in a container with an attached terminal <span class="token punctuation">(</span>user=<span class="token operator">%</span>user<span class="token punctuation">.</span>name user_loginuid=<span class="token operator">%</span>user<span class="token punctuation">.</span>loginuid <span class="token operator">%</span>container<span class="token punctuation">.</span>info
    shell=<span class="token operator">%</span>proc<span class="token punctuation">.</span>name parent=<span class="token operator">%</span>proc<span class="token punctuation">.</span>pname cmdline=<span class="token operator">%</span>proc<span class="token punctuation">.</span>cmdline pid=<span class="token operator">%</span>proc<span class="token punctuation">.</span>pid terminal=<span class="token operator">%</span>proc<span class="token punctuation">.</span>tty container_id=<span class="token operator">%</span>container<span class="token punctuation">.</span>id image=<span class="token operator">%</span>container<span class="token punctuation">.</span>image<span class="token punctuation">.</span>repository<span class="token punctuation">)</span>
  priority: NOTICE
  tags: <span class="token namespace">[container, shell, mitre_execution]</span>
</code></pre> 
<pre><code class="prism language-powershell">在A终端进入到容器内部
<span class="token namespace">[root@kubernetes-node1 ~]</span><span class="token comment"># docker exec -it nginx_web /bin/bash</span>

在B终端查看日志信息
<span class="token namespace">[root@kubernetes-node1 ~]</span><span class="token comment"># grep 'nginx_web' /var/log/messages</span>
Oct 25 22:57:10 kubernetes-node1 falco: 22:57:10<span class="token punctuation">.</span>414572554: Notice A shell was spawned in a container with an attached terminal <span class="token punctuation">(</span>user=root user_loginuid=<span class="token operator">-</span>1 nginx_web <span class="token punctuation">(</span>id=5a3c015d6cca<span class="token punctuation">)</span> shell=bash parent=runc cmdline=bash pid=8698 terminal=34816 container_id=5a3c015d6cca image=kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/nginx_web<span class="token punctuation">)</span>
</code></pre> 
<p><strong>小结</strong></p> 
<pre><code>
</code></pre> 
<h4><a id="124__761"></a>1.2.4 进阶实践</h4> 
<p>学习目标</p> 
<p>这一节，我们从 自定义规则、输出实践、小结 三个方面来学习。</p> 
<p><strong>自定义规则</strong></p> 
<p>规则条件</p> 
<pre><code class="prism language-powershell">关于规则条件的写法主要涉及到两个方面：语法和样式
语法
	condition: sysdig属性 操作符号 值
样式
	单行示例：
	condition: container<span class="token punctuation">.</span>id <span class="token operator">!</span>= host and proc<span class="token punctuation">.</span>name = bash
	多行示例：
	condition: &gt;
	  container<span class="token punctuation">.</span>id <span class="token operator">!</span>= host 
	  and proc<span class="token punctuation">.</span>name = bash
</code></pre> 
<p>规则优先级</p> 
<pre><code class="prism language-powershell">	每个 Falco 规则都有一个优先级，表明违反规则的严重程度，常见的优先级有：EMERGENCY、ALERT、CRITICAL、ERROR、WARNING、NOTICE、INFORMATIONAL、DEBUG。
</code></pre> 
<pre><code class="prism language-powershell">分配准则：
    如果规则与写入状态有关，则其优先级为 ERROR。
    如果规则与未经授权的读取状态有关，则其优先级为 WARNING。
    如果规则与意外行为有关，则其优先级为 NOTICE。
    如果规则与违反最佳实践的行为有关，则其优先级为 INFO。
    如果规则仅仅是详情信息的展示，则其优先级为DEBUG。
</code></pre> 
<p>规则标签</p> 
<pre><code class="prism language-powershell">	默认规则集有一组可选的标签，用于将规则集分类为相关规则组，常见的标签如下：
	filesystem<span class="token punctuation">(</span>与读<span class="token operator">/</span>写文件有关<span class="token punctuation">)</span>、software_mgmt<span class="token punctuation">(</span>与软件<span class="token operator">/</span>包管理工具有关<span class="token punctuation">)</span>、<span class="token keyword">process</span><span class="token punctuation">(</span>与进程的状态有关<span class="token punctuation">)</span>、database<span class="token punctuation">(</span>与数据库相关<span class="token punctuation">)</span>、host<span class="token punctuation">(</span>与宿主机有关<span class="token punctuation">)</span>、shell<span class="token punctuation">(</span>与启动 shell有关<span class="token punctuation">)</span>、container<span class="token punctuation">(</span>与容器有关<span class="token punctuation">)</span>、cis<span class="token punctuation">(</span>与CIS基准相关<span class="token punctuation">)</span>、users<span class="token punctuation">(</span>与用户身份有关<span class="token punctuation">)</span>、network<span class="token punctuation">(</span>与网络活动有关<span class="token punctuation">)</span>
</code></pre> 
<p>需求</p> 
<pre><code class="prism language-powershell">监控容器镜像来源规则，在falco_rules<span class="token punctuation">.</span>local<span class="token punctuation">.</span>yaml文件添加：
<span class="token operator">-</span> rule: django镜像未来自私有仓库
  <span class="token comment"># 成功的规则</span>
  <span class="token comment"># condition: spawned_process and container and container.image contains django and container.image not startswith kuber</span>
  <span class="token comment"># 异常的规则</span>
  condition: &gt;
    spawned_process and container
    and container<span class="token punctuation">.</span>image contains django
    and container<span class="token punctuation">.</span>image startswith kuber
  desc: 保证镜像的来源是正常的
  output: <span class="token string">"django镜像来源不正常 (user=%user.name container_name=%container.name container_id=%container.id image=%container.image.repository shell=%proc.name parent=%proc.pname cmdline=%proc.cmdline terminal=%proc.tty)"</span>
  priority: WARNING
  tags: <span class="token namespace">[process, container]</span>
</code></pre> 
<pre><code class="prism language-powershell">重启falco应用新配置文件：
systemctl restart falco
</code></pre> 
<p>检测效果</p> 
<pre><code class="prism language-powershell">在A终端创建容器
<span class="token namespace">[root@kubernetes-node1 ~]</span><span class="token comment"># docker run -d --name django_web -p 888:8000 kubernetes-register.superopsmsb.com/superopsmsb/django_web:v0.1</span>

在B终端查看日志信息
<span class="token namespace">[root@kubernetes-node1 ~]</span><span class="token comment"># grep 'django_web' /var/log/messages</span>
Oct 26 00:08:28 kubernetes-node1 falco: 00:08:28<span class="token punctuation">.</span>886341055: Warning django镜像来源不正常 <span class="token punctuation">(</span>user=root container_name=django_web container_id=74370161c95a image=kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/django_web shell=python parent=python cmdline=python <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>code/blog/manage<span class="token punctuation">.</span>py runserver 0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0:8000 terminal=0<span class="token punctuation">)</span>
</code></pre> 
<p><strong>输出实践</strong></p> 
<p>需求</p> 
<pre><code class="prism language-powershell">falco支持多种信息输出，因为没有其他环境，我们这里来演示一种文本输入。
</code></pre> 
<p>修改配置</p> 
<pre><code class="prism language-powershell"><span class="token punctuation">]</span><span class="token comment"># vim falco.yaml</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
syslog_output:
  enabled: false    <span class="token comment"># 关闭默认输出</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
file_output:        <span class="token comment"># 定制指定输出</span>
  enabled: true
  keep_alive: false
  filename: <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>log/falco<span class="token punctuation">.</span>log

stdout_output:      <span class="token comment"># 关闭默认输出</span>
  enabled: false
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<pre><code class="prism language-powershell">重启falco应用新配置文件：
systemctl restart falco
</code></pre> 
<pre><code class="prism language-powershell">重新创建异常镜像，然后查看日志
<span class="token namespace">[root@kubernetes-node1 /etc/falco]</span><span class="token comment"># tail /var/log/falco.log</span>
00:17:41<span class="token punctuation">.</span>473060750: Warning django镜像来源不正常 <span class="token punctuation">(</span>user=root container_name=django_web container_id=73b4037db442 image=kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/django_web shell=bash parent=&lt;NA&gt; cmdline=bash <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>scripts/startup<span class="token punctuation">.</span>sh terminal=0<span class="token punctuation">)</span>
</code></pre> 
<p>修改日志格式</p> 
<pre><code class="prism language-powershell"><span class="token punctuation">]</span><span class="token comment"># vim falco.yaml</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
json_output: true     <span class="token comment"># 开启json日志格式</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

重启falco应用新配置文件：
systemctl restart falco
</code></pre> 
<pre><code class="prism language-powershell">重新创建异常镜像，然后查看日志
<span class="token namespace">[root@kubernetes-node1 /etc/falco]</span><span class="token comment"># tail /var/log/falco.log</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"hostname"</span>:<span class="token string">"kubernetes-node1"</span><span class="token punctuation">,</span><span class="token string">"output"</span>:<span class="token string">"00:19:36.249135765: Warning django镜像来源不正常 (user=root container_name=django_web container_id=25d4537446cb image=kubernetes-register.superopsmsb.com/superopsmsb/django_web shell=ldconfig.real parent=python cmdline=ldconfig.real -p terminal=0)"</span><span class="token punctuation">,</span><span class="token string">"priority"</span>:<span class="token string">"Warning"</span><span class="token punctuation">,</span><span class="token string">"rule"</span>:<span class="token string">"django镜像未来自私有仓库"</span><span class="token punctuation">,</span><span class="token string">"source"</span>:<span class="token string">"syscall"</span><span class="token punctuation">,</span><span class="token string">"tags"</span>:<span class="token punctuation">[</span><span class="token string">"container"</span><span class="token punctuation">,</span><span class="token string">"process"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
</code></pre> 
<p><strong>小结</strong></p> 
<pre><code>
</code></pre> 
<h4><a id="125__903"></a>1.2.5 可视化实践</h4> 
<p>学习目标</p> 
<p>这一节，我们从 可视化环境、简单实践、小结 三个方面来学习。</p> 
<p><strong>可视化环境</strong></p> 
<p>需求</p> 
<pre><code class="prism language-powershell">	我们可以借助于falco的专属可视化界面，让所有falco的信息全部传输给可视化界面，然后通过图形的方式进行统一的效果分析。
</code></pre> 
<p>FalcoSideKick</p> 
<pre><code class="prism language-powershell">	FalcoSideKick是基于go语言研发出来的一个集中式数据采集、传输平台，我们可以借助于配套的FalcoSideKick-UI将其作为Falco专属的集中式信息展示平台，该软件还内置了大量的可视化图形页面信息。
</code></pre> 
<pre><code class="prism language-powershell">github地址: 
	https:<span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com/falcosecurity/falcosidekick
	https:<span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com/falcosecurity/falcosidekick-ui
最新版本：2<span class="token punctuation">.</span>26<span class="token punctuation">.</span>0
</code></pre> 
<p>部署环境</p> 
<pre><code class="prism language-powershell">获取镜像
docker pull falcosecurity/falcosidekick
docker pull falcosecurity/falcosidekick-ui
redis/redis-stack-server:latest
</code></pre> 
<pre><code class="prism language-powershell">部署falcosidekick软件
docker run <span class="token operator">-</span>d <span class="token operator">-</span>p 2801:2801 <span class="token operator">--</span>name falcosidekick <span class="token operator">-</span>e WEBUI_URL=http:<span class="token operator">/</span><span class="token operator">/</span>10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>15:2802 falcosecurity/falcosidekick

部署ui软件
docker run <span class="token operator">-</span>d <span class="token operator">--</span>name redis <span class="token operator">-</span>p 6379:6379 redis/redis-stack-server:latest
docker run <span class="token operator">-</span>d <span class="token operator">-</span>p 2802:2802 <span class="token operator">--</span>name falcosidekick-ui <span class="token operator">-</span>e FALCOSIDEKICK_UI_REDIS_URL=<span class="token string">'10.0.0.15:6379'</span> falcosecurity/falcosidekick-ui
</code></pre> 
<p><strong>简单实践</strong></p> 
<p>falco集成可视化平台</p> 
<pre><code class="prism language-powershell">修改配置文件 falco<span class="token punctuation">.</span>yaml
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
json_output: true
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
http_output:
  enabled: true
  url: http:<span class="token operator">/</span><span class="token operator">/</span>10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>15:2801/
  user_agent: <span class="token string">"falcosecurity/falco"</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<pre><code class="prism language-powershell">重启falco应用新配置文件：
systemctl restart falco
</code></pre> 
<p>测试效果</p> 
<pre><code class="prism language-powershell">在A终端频繁的执行
docker run <span class="token operator">-</span>d <span class="token operator">--</span>name django_web <span class="token operator">-</span>p 888:8000 kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/django_web:v0<span class="token punctuation">.</span>1
docker <span class="token function">rm</span> <span class="token operator">-</span>f django_web
</code></pre> 
<pre><code class="prism language-powershell">访问10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>15:2802<span class="token punctuation">,</span>浏览器效果如下
</code></pre> 
<p><img src="https://images2.imgbox.com/b1/fc/aU5uXfay_o.png" alt="在这里插入图片描述"></p> 
<p>环境收尾</p> 
<pre><code class="prism language-powershell">docker <span class="token function">rm</span> <span class="token operator">-</span>f falcosidekick falcosidekick-ui redis
</code></pre> 
<p><strong>小结</strong></p> 
<pre><code>
</code></pre> 
<h3><a id="13__999"></a>1.3 审计日志</h3> 
<h4><a id="131__1001"></a>1.3.1 日志解读</h4> 
<p>学习目标</p> 
<p>这一节，我们从 普通日志、审计日志、小结 三个方面来学习。</p> 
<p><strong>普通日志</strong></p> 
<p>日志作用</p> 
<pre><code class="prism language-powershell">	系统组件的日志记录集群中发生的事件，这对于调试和后续信息梳理是非常有用的。 但是由于kubernetes集群的特点，业务在运行的时候，pod和数据存储有各自的生命周期，所以默认情况下，虽然kubernetes有其自身的日志结构，但是通常不足以支撑完整的日志记录解决方案，往往需要借助于第三方的平台来实现日志方案的实现。
</code></pre> 
<p>日志架构</p> 
<pre><code class="prism language-powershell">	对于kubernetes来说，我们常见的有以下三类日志架构：
	Pod级别日志：
		<span class="token operator">-</span> 我们可以借助于logs方式来查看pod内部的业务应用日志信息。
		<span class="token operator">-</span> pod消亡后，业务应用日志自动消除。
	Node级别日志：
		<span class="token operator">-</span> 借助于重定向的机制，将容器化应用的信息存储到kubernetes工作节点上
		<span class="token operator">-</span> 日志位于 <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>log/pods/namespace_podname_containerid/podname/x<span class="token punctuation">.</span>log
		<span class="token operator">-</span> 虽然实现了日志的延续性，但是pod一旦迁移，日志数据自然消亡。
	Cluster级别日志
		<span class="token operator">-</span> 借助于第三方机制，实现集群级别的日志统一管理。
</code></pre> 
<p>日志格式</p> 
<pre><code class="prism language-powershell">	对于kubernetes来说，它的日志表现样式，主要有四种：
	原生日志格式：
		kubernetes默认情况下使用的日志格式。
	结构化日志:
		在日志消息中引入统一结构，以便以编程方式提取信息，最终以文本方式来呈现。
	上下文日志：
		建立在结构化日志之上。 帮助开发人员使用日志记录依赖环境相关的调用。
	JSON 日志格式：
		业务场景中使用频率较高的一种日志格式，可以非常轻松的获取特定字段信息。
</code></pre> 
<p><strong>审计日志</strong></p> 
<p>审计日志</p> 
<pre><code class="prism language-powershell">	kubernetes 在1<span class="token punctuation">.</span>7版本开始支持审计<span class="token punctuation">(</span>Audit<span class="token punctuation">)</span>日志功能，Kubernetes 审计功能通过记录所有对 apiserver 接口的调用，让我们能够非常清晰的知道与安全相关的按时间顺序排列的记录集，记录单个用户、管理员或系统其他组件影响系统的活动顺序。
	它能帮助集群管理员了解 发生了什么？什么时候发生的？谁触发的？为什么发生？在哪观察到的？它从哪触发的？它将产生什么后果？等等。
</code></pre> 
<p>api-server的完整流程</p> 
<pre><code class="prism language-powershell">	K8S中的审计日志是标准的JSON格式，APIServer会根据具体的日志策略将对应的审计日志保存本地，并可以设置最大保存周期、时间、轮转策略等。
</code></pre> 
<p><img src="https://images2.imgbox.com/0e/73/3gyq6wnf_o.png" alt="在这里插入图片描述"></p> 
<p>记录阶段</p> 
<pre><code class="prism language-powershell">	kube-apiserver 是负责接收及相应用户请求的一个组件，每一个请求都会有几个阶段，每个阶段都有对应的日志，审计日志根据日志策略可以选择在事件执行的某个阶段记录，目前支持的事件阶段有：
	RequestReceived 
		<span class="token operator">-</span> 一旦接收到资源操作请求立刻记录审计事件。
	ResponseStarted 
		<span class="token operator">-</span> 开始响应数据的Header，但在响应数据Body发送前记录审计事件，比如watch操作。
	ResponseComplete 
		<span class="token operator">-</span> 事件响应完毕后记录审计事件。
	Panic 
		<span class="token operator">-</span> 内部出现panic时记录审计事件。
	简单来说，apiserver 的每一个请求理论上会有三个阶段的审计日志生成。
</code></pre> 
<p><img src="https://images2.imgbox.com/98/5e/R8wz05Vh_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-powershell">Kubernetes 审计功能由 kube-apiserver 服务提供。每个请求在不同执行阶段都会生成审计事件；这些审计事件会根据特定策略被预处理并写入后端。策略确定要记录的内容，当前的后端支持日志文件和 webhook。审计能力主要是由kube-apiserver 的WithFailedAuthenticationAudit和WithAudit过滤器来实现的。
</code></pre> 
<p>日志等级</p> 
<pre><code class="prism language-powershell">	审计日志根据日志策略可以选择事件保存的等级，根据等级不同，APIServer记录日志的详细程度也不同。目前支持的事件等级有：
	None 
		<span class="token operator">-</span> 不记录日志<span class="token punctuation">.</span>
	Metadata 
		<span class="token operator">-</span> 只记录Request的一些metadata，但不记录Request或Response的body。
	Request 
		<span class="token operator">-</span> 记录Request的metadata和body。
	RequestResponse 
		<span class="token operator">-</span> 最全记录方式，会记录所有的metadata、Request和Response的Body。
</code></pre> 
<p>日志记录策略</p> 
<pre><code class="prism language-powershell">	APIServer支持对每类不同的资源设置不同的审计日志策略，包括日志记录阶段以及日志记录等级，常见的日志策略，一般都遵循以下原则：
	只记录所需要的信息
		<span class="token operator">-</span> 一个请求不要重复记录，每个请求有三个阶段，只记录其中需要的阶段
		<span class="token operator">-</span> 在收到请求后不立即记录日志，当返回体header发送后才开始记录
		<span class="token operator">-</span> 对于认证信息<span class="token punctuation">(</span>secrets，configmaps，token等<span class="token punctuation">)</span>日志仅记录metadata，不包含请求体和返回体。
	不需要的日志尽可能不记录
		<span class="token operator">-</span> 不要记录所有的资源，不要记录一个资源的所有子资源
		<span class="token operator">-</span> 对于<span class="token operator">/</span>healthz，<span class="token operator">/</span>version<span class="token punctuation">,</span> <span class="token operator">/</span>swagger*等只读url不作审计
		<span class="token operator">-</span> 对于大量冗余的请求等不做审计，比如kube-proxy watch操作，组件间的所有get请求。
</code></pre> 
<p>官方配置示例解读</p> 
<pre><code class="prism language-powershell">apiVersion: audit<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io/v1 <span class="token comment"># 这是必填项。</span>
kind: Policy
<span class="token comment"># 不要在 RequestReceived 阶段为任何请求生成审计事件。</span>
omitStages:
  <span class="token operator">-</span> <span class="token string">"RequestReceived"</span>
rules:
  <span class="token comment"># 在日志中用 RequestResponse 级别记录 Pod 变化。</span>
  <span class="token operator">-</span> level: RequestResponse
    <span class="token comment"># verbs 代表限制的动作</span>
    <span class="token comment"># verbs: ["update","patch"]</span>
    resources:
    <span class="token operator">-</span> <span class="token function">group</span>: <span class="token string">""</span> <span class="token comment"># core API 组</span>
      resources: <span class="token punctuation">[</span><span class="token string">"pods"</span><span class="token punctuation">]</span>
      
  <span class="token comment"># 在日志中记录 kube-system 命名空间中 configmap 变更的请求消息体。</span>
  <span class="token operator">-</span> level: Request
    resources:
    <span class="token operator">-</span> <span class="token function">group</span>: <span class="token string">""</span> 
      resources: <span class="token punctuation">[</span><span class="token string">"configmaps"</span><span class="token punctuation">]</span>
    namespaces: <span class="token punctuation">[</span><span class="token string">"kube-system"</span><span class="token punctuation">]</span>
      
  <span class="token comment"># 在日志中以 Request 级别记录所有其他 core 和 extensions 组中的资源操作。</span>
  <span class="token operator">-</span> level: Request
    resources:
    <span class="token operator">-</span> <span class="token function">group</span>: <span class="token string">""</span>
    <span class="token operator">-</span> <span class="token function">group</span>: <span class="token string">"extensions"</span> <span class="token comment"># 不应包括在内的组版本。</span>
</code></pre> 
<pre><code class="prism language-powershell">  <span class="token comment"># 在日志中按 Metadata 级别记录 "pods/log"、"pods/status" 请求</span>
  <span class="token operator">-</span> level: Metadata
    resources:
    <span class="token operator">-</span> <span class="token function">group</span>: <span class="token string">""</span>
      resources: <span class="token punctuation">[</span><span class="token string">"pods/log"</span><span class="token punctuation">,</span> <span class="token string">"pods/status"</span><span class="token punctuation">]</span>

  <span class="token comment"># 在日志中用 Metadata 级别记录所有其他名字空间中的 configmap 和 secret 变更。</span>
  <span class="token operator">-</span> level: Metadata
    resources:
    <span class="token operator">-</span> <span class="token function">group</span>: <span class="token string">""</span>
      resources: <span class="token punctuation">[</span><span class="token string">"secrets"</span><span class="token punctuation">,</span> <span class="token string">"configmaps"</span><span class="token punctuation">]</span>
      
  <span class="token comment"># 一个抓取所有的规则，将在日志中以 Metadata 级别记录所有其他请求。</span>
  <span class="token operator">-</span> level: Metadata
    <span class="token comment"># 审计事件不在 RequestReceived阶段生成审计事件</span>
    omitStages:
      <span class="token operator">-</span> <span class="token string">"RequestReceived"</span>
</code></pre> 
<pre><code class="prism language-powershell">  <span class="token comment"># 不要在日志中记录对名为 "controller-leader" 的 configmap 的请求。</span>
  <span class="token operator">-</span> level: None
    resources:
    <span class="token operator">-</span> <span class="token function">group</span>: <span class="token string">""</span>
      resources: <span class="token punctuation">[</span><span class="token string">"configmaps"</span><span class="token punctuation">]</span>
      resourceNames: <span class="token punctuation">[</span><span class="token string">"controller-leader"</span><span class="token punctuation">]</span>
 
  <span class="token comment"># 不要在日志中记录由 "system:kube-proxy" 发出的对端点或服务的监测请求。</span>
  <span class="token operator">-</span> level: None
    users: <span class="token punctuation">[</span><span class="token string">"system:kube-proxy"</span><span class="token punctuation">]</span>
    verbs: <span class="token punctuation">[</span><span class="token string">"watch"</span><span class="token punctuation">]</span>
    resources:
    <span class="token operator">-</span> <span class="token function">group</span>: <span class="token string">""</span> <span class="token comment"># core API 组</span>
      resources: <span class="token punctuation">[</span><span class="token string">"endpoints"</span><span class="token punctuation">,</span> <span class="token string">"services"</span><span class="token punctuation">]</span>
 
  <span class="token comment"># 不要在日志中记录对某些非资源 URL 路径的已认证请求。</span>
  <span class="token operator">-</span> level: None
    userGroups: <span class="token punctuation">[</span><span class="token string">"system:authenticated"</span><span class="token punctuation">]</span>
    nonResourceURLs:
    <span class="token operator">-</span> <span class="token string">"/api*"</span> <span class="token comment"># 通配符匹配。</span>
    <span class="token operator">-</span> <span class="token string">"/version"</span>
</code></pre> 
<pre><code class="prism language-powershell"><span class="token operator">--</span><span class="token operator">-</span>
<span class="token comment"># 在 Metadata 级别为所有请求生成日志</span>
apiVersion: audit<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io/v1beta1
kind: Policy
rules:
  <span class="token comment"># 每个level就是一个规则，如果不写规则，那么所有日志都会记录。</span>
  <span class="token operator">-</span> level: Metadata
</code></pre> 
<p>日志示例</p> 
<pre><code class="prism language-powershell"><span class="token punctuation">{<!-- --></span>
  <span class="token operator">--</span><span class="token operator">--</span> 审计日志属性信息
  <span class="token string">"kind"</span>: <span class="token string">"Event"</span><span class="token punctuation">,</span>
  <span class="token string">"apiVersion"</span>: <span class="token string">"audit.k8s.io/v1beta1"</span><span class="token punctuation">,</span>
  <span class="token string">"metadata"</span>: <span class="token punctuation">{<!-- --></span>
    <span class="token string">"creationTimestamp"</span>: <span class="token string">"xxx"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"level"</span>: <span class="token string">"Metadata"</span><span class="token punctuation">,</span>
  <span class="token string">"timestamp"</span>: <span class="token string">"xxx"</span><span class="token punctuation">,</span>
  <span class="token string">"auditID"</span>: <span class="token string">"xxx"</span><span class="token punctuation">,</span>
  <span class="token string">"stage"</span>: <span class="token string">"ResponseComplete"</span><span class="token punctuation">,</span>
  <span class="token string">"requestURI"</span>: <span class="token string">"/apis/authentication.k8s.io/v1beta1?timeout=32s"</span><span class="token punctuation">,</span>
  <span class="token string">"verb"</span>: <span class="token string">"get"</span><span class="token punctuation">,</span>
  <span class="token operator">--</span><span class="token operator">--</span> 用户信息
  <span class="token string">"user"</span>: <span class="token punctuation">{<!-- --></span>
    <span class="token string">"username"</span>: <span class="token string">"xxx"</span><span class="token punctuation">,</span>
    <span class="token string">"uid"</span>: <span class="token string">"xxx"</span><span class="token punctuation">,</span>
    <span class="token string">"groups"</span>: <span class="token punctuation">[</span>
      <span class="token string">"system:serviceaccounts"</span><span class="token punctuation">,</span>
      <span class="token string">"system:serviceaccounts:kube-system"</span><span class="token punctuation">,</span>
      <span class="token string">"system:authenticated"</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token operator">--</span><span class="token operator">--</span> 客户端IP信息
  <span class="token string">"sourceIPs"</span>: <span class="token punctuation">[</span>
    <span class="token string">"10.244.0.249"</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token operator">--</span><span class="token operator">--</span> 用户标识信息
  <span class="token string">"UserAgent"</span>: <span class="token string">"kube-scheduler/v1.12.2 (linux/amd64) kubernetes/73f3294/scheduler"</span><span class="token punctuation">,</span>
  <span class="token string">"ObjectRef"</span>: <span class="token punctuation">{<!-- --></span>
    <span class="token string">"Resource"</span>: <span class="token string">"pods"</span><span class="token punctuation">,</span>
    <span class="token string">"Namespace"</span>: <span class="token string">"default"</span><span class="token punctuation">,</span>
    <span class="token string">"Name"</span>: <span class="token string">"xxx"</span><span class="token punctuation">,</span>
    <span class="token string">"UID"</span>: <span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token string">"APIGroup"</span>: <span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token string">"APIVersion"</span>: <span class="token string">"v1"</span><span class="token punctuation">,</span>
    <span class="token string">"ResourceVersion"</span>: <span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token string">"Subresource"</span>: <span class="token string">""</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token operator">--</span><span class="token operator">--</span> 响应状态信息
  <span class="token string">"responseStatus"</span>: <span class="token punctuation">{<!-- --></span>
    <span class="token string">"metadata"</span>: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"code"</span>: 200
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token operator">--</span><span class="token operator">--</span> 时间注释信息
  <span class="token string">"requestReceivedTimestamp"</span>: <span class="token string">"xxx"</span><span class="token punctuation">,</span>
  <span class="token string">"stageTimestamp"</span>: <span class="token string">"xxx"</span><span class="token punctuation">,</span>
  <span class="token string">"annotations"</span>: <span class="token punctuation">{<!-- --></span>
    <span class="token string">"authorization.k8s.io/decision"</span>: <span class="token string">"allow"</span><span class="token punctuation">,</span>
    <span class="token string">"authorization.k8s.io/reason"</span>: <span class="token string">"RBAC: ..."</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code>
</code></pre> 
<h4><a id="132__1274"></a>1.3.2 审计日志</h4> 
<p>学习目标</p> 
<p>这一节，我们从 环境准备、简单实践、小结 三个方面来学习。</p> 
<p><strong>环境准备</strong></p> 
<p>简介</p> 
<pre><code class="prism language-powershell">	对于kuberntes的审计日志功能来说，它主要支持两种收集方式：
        Log 后端，将事件写入到文件系统
        	<span class="token operator">--</span>audit-policy-file=<span class="token operator">/</span>etc/kubernetes/audit-policy<span class="token punctuation">.</span>yaml 
        	<span class="token operator">--</span>audit-log-path=<span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>log/kube-audit 
        	<span class="token operator">--</span>audit-log-format=json
    Webhook 后端，将事件发送到外部 HTTP API
    		<span class="token operator">--</span>audit-policy-file=<span class="token operator">/</span>etc/kubernetes/audit-policy<span class="token punctuation">.</span>yaml 
    		<span class="token operator">--</span>audit-webhook-config-file=<span class="token operator">/</span>etc/kubernetes/audit-webhook-kubeconfig
</code></pre> 
<pre><code class="prism language-powershell">其他属性参数
    <span class="token operator">--</span>audit-log-maxage 定义保留旧审计日志文件的最大天数
    <span class="token operator">--</span>audit-log-maxbackup 定义要保留的审计日志文件的最大数量
    <span class="token operator">--</span>audit-log-maxsize 定义审计日志文件的最大大小（兆字节）
</code></pre> 
<p><strong>简单实践</strong></p> 
<p>创建策略文件</p> 
<pre><code class="prism language-powershell">定制资源清单文件 audit-policy<span class="token punctuation">.</span>yaml 
apiVersion: audit<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io/v1
kind: Policy
<span class="token comment"># 列表内阶段不记录审计日志</span>
omitStages:
  <span class="token operator">-</span> <span class="token string">"ResponseStarted"</span>
  <span class="token operator">-</span> <span class="token string">"RequestReceived"</span>
rules:
  <span class="token comment"># 记录用户对config、pod 和 deployment 的操作</span>
  <span class="token operator">-</span> level: RequestResponse
    resources:
    <span class="token operator">-</span> <span class="token function">group</span>: <span class="token string">""</span>
      resources: <span class="token punctuation">[</span><span class="token string">"pods"</span><span class="token punctuation">,</span> <span class="token string">"configmaps"</span><span class="token punctuation">]</span>
    <span class="token operator">-</span> <span class="token function">group</span>: <span class="token string">"apps"</span>
      resources: <span class="token punctuation">[</span><span class="token string">"deployments"</span><span class="token punctuation">]</span>
  <span class="token comment"># kube-controller-manager、kube-scheduler 等已经认证过身份的请求不需要记录</span>
  <span class="token operator">-</span> level: None
    userGroups: <span class="token punctuation">[</span><span class="token string">"system:authenticated"</span><span class="token punctuation">]</span>
    nonResourceURLs:
    <span class="token operator">-</span> <span class="token string">"/api*"</span>
    <span class="token operator">-</span> <span class="token string">"/version"</span>
  <span class="token comment"># 对 secret、token 等认证信息不记录请求体和返回体</span>
  <span class="token operator">-</span> level: Metadata
    resources:
    <span class="token operator">-</span> <span class="token function">group</span>: <span class="token string">""</span> <span class="token comment"># core API group</span>
      resources: <span class="token punctuation">[</span> <span class="token string">"secrets"</span><span class="token punctuation">]</span>
</code></pre> 
<p>集群启用审计日志</p> 
<pre><code class="prism language-powershell">定制apiserver资源清单文件 kube-apiserver<span class="token punctuation">.</span>yaml
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
spec:
  containers:
  <span class="token operator">-</span> command:
    <span class="token operator">-</span> kube-apiserver
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token operator">-</span> <span class="token operator">--</span>audit-policy-file=<span class="token operator">/</span>etc/kubernetes/audit-policy<span class="token punctuation">.</span>yaml
    <span class="token operator">-</span> <span class="token operator">--</span>audit-log-path=<span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>log/kubernetes/audit
    <span class="token operator">-</span> <span class="token operator">--</span>audit-log-format=json
    <span class="token operator">-</span> <span class="token operator">--</span>audit-log-maxage 30
    <span class="token operator">-</span> <span class="token operator">--</span>audit-log-maxbackup 10
    <span class="token operator">-</span> <span class="token operator">--</span>audit-log-maxsize 100
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  volumeMounts:
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token operator">-</span> mountPath: <span class="token operator">/</span>etc/kubernetes/audit-policy<span class="token punctuation">.</span>yaml
      name: audit
      readOnly: true
    <span class="token operator">-</span> mountPath: <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>log/kubernetes/audit/
      name: audit-log
      readOnly: false
  volumes:
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token operator">-</span> name: audit
    hostPath:
      path: <span class="token operator">/</span>etc/kubernetes/audit-policy<span class="token punctuation">.</span>yaml
      <span class="token function">type</span>: File
  <span class="token operator">-</span> name: audit-log
    hostPath:
      path: <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>log/kubernetes/audit/
      <span class="token function">type</span>: DirectoryOrCreate    
</code></pre> 
<p>同步效果</p> 
<pre><code class="prism language-powershell">同步基础配置
<span class="token keyword">for</span> i in <span class="token punctuation">{<!-- --></span>12<span class="token punctuation">.</span><span class="token punctuation">.</span>14<span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token keyword">do</span> scp audit-policy<span class="token punctuation">.</span>yaml root@10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span><span class="token variable">$i</span>:<span class="token operator">/</span>etc/kubernetes/audit-policy<span class="token punctuation">.</span>yaml <span class="token punctuation">;</span> done
</code></pre> 
<pre><code class="prism language-powershell">同步kube-apiserver
<span class="token keyword">for</span> i in 12 13 14<span class="token punctuation">;</span> <span class="token keyword">do</span> ssh root@10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span><span class="token variable">$i</span> <span class="token string">"rm -f /etc/kubernetes/manifests/kube-apiserver.yaml"</span> <span class="token punctuation">;</span> scp kube-apiserver<span class="token punctuation">.</span>yaml root@10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span><span class="token variable">$i</span>:<span class="token operator">/</span>etc/kubernetes/manifests/kube-apiserver<span class="token punctuation">.</span>yaml<span class="token punctuation">;</span> done
</code></pre> 
<p>检查效果</p> 
<pre><code class="prism language-powershell">等待所有master节点上的api-server启动后，可以看到，在<span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>logs/auth 目录下，出现了审计日志。
</code></pre>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/69f8f0d35dec77dc3f3cf3816814ba77/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">K8S应用流程安全（镜像安全 配置管理 访问安全）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/73bc795dbdd49660f9a369f21908e687/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">判断变量的数据类型(常见四种方法及解析)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>