<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Prometheus 配置详解 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Prometheus 配置详解" />
<meta property="og:description" content="1.摘要 Prometheus配置方式有两种： （1）命令行，用来配置不可变命令参数，主要是Prometheus运行参数，比如数据存储位置 （2）配置文件，用来配置Prometheus应用参数，比如数据采集，报警对接
不重启进程配置生效方式也有两种： （1）对进程发送信号SIGHUP （2）HTTP POST请求，需要开启–web.enable-lifecycle选项curl -X POST http://192.168.66.112:9091/-/reload
配置文件格式是yaml格式，说明： .yml或者.yaml 都是 yaml格式的文件， yaml格式的好处: 和json交互比较容易 python/go/java/php 有yaml格式库，方便语言之间解析,并且这种格式存储的信息量很大。
2. 命令行 命令行可用配置可通过prometheus -h来查看。
-h, --help Show context-sensitive help (also try --help-long and --help-man). --version Show application version. --config.file=&#34;prometheus.yml&#34; Prometheus configuration file path. --web.listen-address=&#34;0.0.0.0:9090&#34; Address to listen on for UI, API, and telemetry. --web.read-timeout=5m Maximum duration before timing out read of the request, and closing idle connections. --web.max-connections=512 Maximum number of simultaneous connections." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/0c0f1b50acd3c2c1e6eefa1943527c88/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-16T17:00:26+08:00" />
<meta property="article:modified_time" content="2022-08-16T17:00:26+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Prometheus 配置详解</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-github-gist">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="1_1"></a>1.摘要</h2> 
<p>Prometheus配置方式有两种： （1）命令行，用来配置不可变命令参数，主要是Prometheus运行参数，比如数据存储位置 （2）配置文件，用来配置Prometheus应用参数，比如<a href="https://cloud.tencent.com/solution/data-collect-and-label-service?from=10680" rel="nofollow">数据采集</a>，报警对接</p> 
<p>不重启进程配置生效方式也有两种： （1）对进程发送信号SIGHUP （2）HTTP POST请求，需要开启–web.enable-lifecycle选项curl -X POST <a href="https://links.jianshu.com/go?to=http%3A%2F%2F192.168.66.112%3A9091%2F-%2Freload" rel="nofollow">http://192.168.66.112:9091/-/reload</a></p> 
<p><strong>配置文件格式是yaml格式，说明：</strong> .yml或者.yaml 都是 yaml格式的文件， yaml格式的好处: 和json交互比较容易 python/go/java/php 有yaml格式库，方便语言之间解析,并且这种格式存储的信息量很大。</p> 
<h2><a id="2__9"></a>2. 命令行</h2> 
<p>命令行可用配置可通过prometheus -h来查看。</p> 
<pre><code class="prism language-javascript"><span class="token operator">-</span>h<span class="token punctuation">,</span> <span class="token operator">--</span>help                     Show context<span class="token operator">-</span>sensitive <span class="token function">help</span> <span class="token punctuation">(</span>also <span class="token keyword">try</span> <span class="token operator">--</span>help<span class="token operator">-</span>long and <span class="token operator">--</span>help<span class="token operator">-</span>man<span class="token punctuation">)</span><span class="token punctuation">.</span>
    <span class="token operator">--</span>version                  Show application version<span class="token punctuation">.</span>
    <span class="token operator">--</span>config<span class="token punctuation">.</span>file<span class="token operator">=</span><span class="token string">"prometheus.yml"</span>
                               Prometheus configuration file path<span class="token punctuation">.</span>
    <span class="token operator">--</span>web<span class="token punctuation">.</span>listen<span class="token operator">-</span>address<span class="token operator">=</span><span class="token string">"0.0.0.0:9090"</span>
                               Address to listen on <span class="token keyword">for</span> <span class="token constant">UI</span><span class="token punctuation">,</span> <span class="token constant">API</span><span class="token punctuation">,</span> and telemetry<span class="token punctuation">.</span>
    <span class="token operator">--</span>web<span class="token punctuation">.</span>read<span class="token operator">-</span>timeout<span class="token operator">=</span>5m      Maximum duration before timing out read <span class="token keyword">of</span> the request<span class="token punctuation">,</span> and closing idle
                               connections<span class="token punctuation">.</span>
    <span class="token operator">--</span>web<span class="token punctuation">.</span>max<span class="token operator">-</span>connections<span class="token operator">=</span><span class="token number">512</span>  Maximum number <span class="token keyword">of</span> simultaneous connections<span class="token punctuation">.</span>
    <span class="token operator">--</span>web<span class="token punctuation">.</span>route<span class="token operator">-</span>prefix<span class="token operator">=</span><span class="token operator">&lt;</span>path<span class="token operator">&gt;</span>  Prefix <span class="token keyword">for</span> the internal routes <span class="token keyword">of</span> web endpoints<span class="token punctuation">.</span> Defaults to path <span class="token keyword">of</span>
                               <span class="token operator">--</span>web<span class="token punctuation">.</span>external<span class="token operator">-</span>url<span class="token punctuation">.</span>
    <span class="token operator">--</span>web<span class="token punctuation">.</span>user<span class="token operator">-</span>assets<span class="token operator">=</span><span class="token operator">&lt;</span>path<span class="token operator">&gt;</span>   Path to <span class="token keyword">static</span> asset directory<span class="token punctuation">,</span> available at <span class="token operator">/</span>user<span class="token punctuation">.</span>
    <span class="token operator">--</span>web<span class="token punctuation">.</span>enable<span class="token operator">-</span>lifecycle     Enable shutdown and reload via <span class="token constant">HTTP</span> request<span class="token punctuation">.</span>
</code></pre> 
<h2><a id="3__29"></a>3. 配置文件</h2> 
<p>配置文件使用yml格式，配置文件中一级配置项如下，说明参考#备注内容。</p> 
<pre><code class="prism language-javascript">＃全局配置 （如果有内部单独设定，会覆盖这个参数）
<span class="token literal-property property">global</span><span class="token operator">:</span>

＃告警插件定义。这里会设定alertmanager这个报警插件。
<span class="token literal-property property">alerting</span><span class="token operator">:</span>

＃告警规则。 按照设定参数进行扫描加载，用于自定义报警规则，其报警媒介和route路由由alertmanager插件实现。
<span class="token literal-property property">rule_files</span><span class="token operator">:</span>

＃采集配置。配置数据源，包含分组job_name以及具体target。又分为静态配置和服务发现
<span class="token literal-property property">scrape_configs</span><span class="token operator">:</span>

＃用于远程存储写配置
<span class="token literal-property property">remote_write</span><span class="token operator">:</span>

＃用于远程读配置
<span class="token literal-property property">remote_read</span><span class="token operator">:</span>
</code></pre> 
<p>配置文件中通用字段值格式 : 布尔类型值为true和false : 协议方式包含http和https</p> 
<p>原始配置文件内容：</p> 
<pre><code class="prism language-javascript"># my global config
<span class="token literal-property property">global</span><span class="token operator">:</span>
  <span class="token literal-property property">scrape_interval</span><span class="token operator">:</span>     15s # Set the scrape interval to every <span class="token number">15</span> seconds<span class="token punctuation">.</span> Default is every <span class="token number">1</span> minute<span class="token punctuation">.</span>
  <span class="token literal-property property">evaluation_interval</span><span class="token operator">:</span> 15s # Evaluate rules every <span class="token number">15</span> seconds<span class="token punctuation">.</span> The <span class="token keyword">default</span> is every <span class="token number">1</span> minute<span class="token punctuation">.</span>
  # scrape_timeout is <span class="token keyword">set</span> to the global <span class="token keyword">default</span> <span class="token punctuation">(</span>10s<span class="token punctuation">)</span><span class="token punctuation">.</span>
 
# Alertmanager configuration
<span class="token literal-property property">alerting</span><span class="token operator">:</span>
  <span class="token literal-property property">alertmanagers</span><span class="token operator">:</span>
  <span class="token operator">-</span> static_configs<span class="token operator">:</span>
    <span class="token operator">-</span> targets<span class="token operator">:</span>
      # <span class="token operator">-</span> alertmanager<span class="token operator">:</span><span class="token number">9093</span>
 
# Load rules once and periodically evaluate them according to the global <span class="token string">'evaluation_interval'</span><span class="token punctuation">.</span>
<span class="token literal-property property">rule_files</span><span class="token operator">:</span>
  # <span class="token operator">-</span> <span class="token string">"first_rules.yml"</span>
  # <span class="token operator">-</span> <span class="token string">"second_rules.yml"</span>
 
# <span class="token constant">A</span> scrape configuration containing exactly one endpoint to scrape<span class="token operator">:</span>
# Here it's Prometheus itself<span class="token punctuation">.</span>
<span class="token literal-property property">scrape_configs</span><span class="token operator">:</span>
  # The job name is added <span class="token keyword">as</span> a label <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">job=</span><span class="token template-punctuation string">`</span></span> to any timeseries scraped from <span class="token keyword">this</span> config<span class="token punctuation">.</span>
  <span class="token operator">-</span> job_name<span class="token operator">:</span> <span class="token string">'prometheus'</span>
 
    # metrics_path defaults to <span class="token string">'/metrics'</span>
    # scheme defaults to <span class="token string">'http'</span><span class="token punctuation">.</span>
 
    <span class="token literal-property property">static_configs</span><span class="token operator">:</span>
    <span class="token operator">-</span> targets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'localhost:9090'</span><span class="token punctuation">]</span>
</code></pre> 
<h3><a id="31_global_89"></a>3.1 global字段</h3> 
<h6><a id="scrape_interval_91"></a>scrape_interval</h6> 
<p>全局默认的数据拉取间隔</p> 
<pre><code class="prism language-javascript"><span class="token punctuation">[</span> scrape_interval<span class="token operator">:</span> <span class="token operator">&lt;</span>duration<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">default</span> <span class="token operator">=</span> 1m <span class="token punctuation">]</span>
</code></pre> 
<h6><a id="scrape_timeout_99"></a>scrape_timeout</h6> 
<p>全局默认的单次数据拉取超时，当报context deadline exceeded错误时需要在特定的job下配置该字段。</p> 
<pre><code class="prism language-javascript"><span class="token punctuation">[</span> scrape_timeout<span class="token operator">:</span> <span class="token operator">&lt;</span>duration<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">default</span> <span class="token operator">=</span> 10s <span class="token punctuation">]</span>
</code></pre> 
<h6><a id="evaluation_interval_107"></a>evaluation_interval</h6> 
<p>全局默认的规则(主要是报警规则)拉取间隔</p> 
<pre><code class="prism language-javascript"><span class="token punctuation">[</span> evaluation_interval<span class="token operator">:</span> <span class="token operator">&lt;</span>duration<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">default</span> <span class="token operator">=</span> 1m <span class="token punctuation">]</span>
</code></pre> 
<h6><a id="external_labels_115"></a>external_labels</h6> 
<p>该服务端在与其他系统对接所携带的标签</p> 
<pre><code class="prism language-javascript"><span class="token punctuation">[</span> <span class="token operator">&lt;</span>labelname<span class="token operator">&gt;</span><span class="token operator">:</span> <span class="token operator">&lt;</span>labelvalue<span class="token operator">&gt;</span> <span class="token operator">...</span> <span class="token punctuation">]</span>
</code></pre> 
<h3><a id="32_alerting__123"></a>3.2 alerting 字段</h3> 
<p>该字段配置与Alertmanager进行对接的配置 样例：</p> 
<pre><code class="prism language-javascript"><span class="token literal-property property">alerting</span><span class="token operator">:</span>
  <span class="token literal-property property">alert_relabel_configs</span><span class="token operator">:</span> # 动态修改 alert 属性的规则配置。
    <span class="token operator">-</span> source_labels<span class="token operator">:</span> <span class="token punctuation">[</span>dc<span class="token punctuation">]</span> 
      <span class="token literal-property property">regex</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">+</span><span class="token punctuation">)</span>\d<span class="token operator">+</span>
      <span class="token literal-property property">target_label</span><span class="token operator">:</span> dc1
  <span class="token literal-property property">alertmanagers</span><span class="token operator">:</span>
    <span class="token operator">-</span> static_configs<span class="token operator">:</span>
        <span class="token operator">-</span> targets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'127.0.0.1:9093'</span><span class="token punctuation">]</span> # 单实例配置
        #<span class="token operator">-</span> targets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'172.31.10.167:19093'</span><span class="token punctuation">,</span><span class="token string">'172.31.10.167:29093'</span><span class="token punctuation">,</span><span class="token string">'172.31.10.167:39093'</span><span class="token punctuation">]</span> # 集群配置
    <span class="token operator">-</span> job_name<span class="token operator">:</span> <span class="token string">'Alertmanager'</span>
    # metrics_path defaults to <span class="token string">'/metrics'</span>
    # scheme defaults to <span class="token string">'http'</span><span class="token punctuation">.</span>
    <span class="token operator">-</span> static_configs<span class="token operator">:</span>
      <span class="token operator">-</span> targets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'localhost:19093'</span><span class="token punctuation">]</span>
</code></pre> 
<p>上面的配置中的 <code>alert_relabel_configs</code>是指警报重新标记在发送到Alertmanager之前应用于警报。 它具有与目标重新标记相同的配置格式和操作，外部标签标记后应用警报重新标记，主要是针对集群配置。</p> 
<p>这个设置的用途是确保具有不同外部label的HA对Prometheus服务端发送相同的警报信息。</p> 
<p>Alertmanager 可以通过 <code>static_configs</code> 参数静态配置，也可以使用其中一种支持的服务发现机制动态发现，我们上面的配置是静态的单实例。</p> 
<p>此外，<code>relabel_configs</code> 允许从发现的实体中选择 Alertmanager，并对使用的API路径提供高级修改，该路径通过 <code>__alerts_path__</code> 标签公开。</p> 
<p>完成以上配置后，重启Prometheus服务，用以加载生效，也可以使用热加载功能，使其配置生效。然后通过浏览器，访问 <a href="https://links.jianshu.com/go?to=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttp%3A%2F%2F192.168.1.220%3A19090%2Falerts" rel="nofollow">http://192.168.1.220:19090/alerts</a> 就可以看 <code>inactive</code> <code>pending</code> <code>firing</code> 三个状态，没有警报信息是因为我们还没有配置警报规则 <code>rules</code>。</p> 
<p>这里定义和prometheus集成的alertmanager插件，用于监控报警。后续会单独进行alertmanger插件的配置、配置说明、报警媒介以及route路由规则记录。</p> 
<h5><a id="321_alert_relabel_configs_156"></a>3.2.1 alert_relabel_configs</h5> 
<p>此项配置和<code>scrape_configs</code>字段中<code>relabel_configs</code>配置一样，用于对需要报警的数据进行过滤后发向<code>Alertmanager</code></p> 
<p><strong>说明</strong> relabel-configs的配置允许你选择你想抓取的目标和这些目标的标签是什么。所以说如果你想要抓取这种类型的<a href="https://cloud.tencent.com/product/cvm?from=10680" rel="nofollow">服务器</a>而不是那种，可以使用relabel_configs</p> 
<p>相比之下，metric_relabel_configs是发生在抓取之后，但在数据被插入存储系统之前使用。因此如果有些你想过滤的指标，或者来自抓取本身的指标（比如来自/metrics页面）你就可以使用metric_relabel_configs来处理。</p> 
<h5><a id="322_alertmanagers_164"></a>3.2.2 alertmanagers</h5> 
<p>该项目主要用来配置不同的<code>alertmanagers</code>服务，以及Prometheus服务和他们的链接参数。<code>alertmanagers</code>服务可以静态配置也可以使用服务发现配置。Prometheus以pushing 的方式向alertmanager传递数据。</p> 
<p>alertmanager 服务配置和target配置一样，可用字段如下</p> 
<pre><code class="prism language-javascript"><span class="token punctuation">[</span> timeout<span class="token operator">:</span> <span class="token operator">&lt;</span>duration<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">default</span> <span class="token operator">=</span> 10s <span class="token punctuation">]</span>
<span class="token punctuation">[</span> path_prefix<span class="token operator">:</span> <span class="token operator">&lt;</span>path<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">default</span> <span class="token operator">=</span> <span class="token operator">/</span> <span class="token punctuation">]</span>
<span class="token punctuation">[</span> scheme<span class="token operator">:</span> <span class="token operator">&lt;</span>scheme<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">default</span> <span class="token operator">=</span> http <span class="token punctuation">]</span>
<span class="token literal-property property">basic_auth</span><span class="token operator">:</span>
  <span class="token punctuation">[</span> username<span class="token operator">:</span> <span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token punctuation">]</span>
  <span class="token punctuation">[</span> password<span class="token operator">:</span> <span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token punctuation">]</span>
  <span class="token punctuation">[</span> password_file<span class="token operator">:</span> <span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token punctuation">]</span>
<span class="token punctuation">[</span> bearer_token<span class="token operator">:</span> <span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token punctuation">]</span>
<span class="token punctuation">[</span> bearer_token_file<span class="token operator">:</span> <span class="token operator">/</span>path<span class="token operator">/</span>to<span class="token operator">/</span>bearer<span class="token operator">/</span>token<span class="token operator">/</span>file <span class="token punctuation">]</span>
<span class="token literal-property property">tls_config</span><span class="token operator">:</span>
  <span class="token punctuation">[</span> <span class="token operator">&lt;</span>tls_config<span class="token operator">&gt;</span> <span class="token punctuation">]</span>
<span class="token punctuation">[</span> proxy_url<span class="token operator">:</span> <span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token punctuation">]</span>
<span class="token literal-property property">azure_sd_configs</span><span class="token operator">:</span>
  <span class="token punctuation">[</span> <span class="token operator">-</span> <span class="token operator">&lt;</span>azure_sd_config<span class="token operator">&gt;</span> <span class="token operator">...</span> <span class="token punctuation">]</span>
<span class="token literal-property property">consul_sd_configs</span><span class="token operator">:</span>
  <span class="token punctuation">[</span> <span class="token operator">-</span> <span class="token operator">&lt;</span>consul_sd_config<span class="token operator">&gt;</span> <span class="token operator">...</span> <span class="token punctuation">]</span>
<span class="token literal-property property">dns_sd_configs</span><span class="token operator">:</span>
  <span class="token punctuation">[</span> <span class="token operator">-</span> <span class="token operator">&lt;</span>dns_sd_config<span class="token operator">&gt;</span> <span class="token operator">...</span> <span class="token punctuation">]</span>
<span class="token literal-property property">ec2_sd_configs</span><span class="token operator">:</span>
  <span class="token punctuation">[</span> <span class="token operator">-</span> <span class="token operator">&lt;</span>ec2_sd_config<span class="token operator">&gt;</span> <span class="token operator">...</span> <span class="token punctuation">]</span>
<span class="token literal-property property">file_sd_configs</span><span class="token operator">:</span>
  <span class="token punctuation">[</span> <span class="token operator">-</span> <span class="token operator">&lt;</span>file_sd_config<span class="token operator">&gt;</span> <span class="token operator">...</span> <span class="token punctuation">]</span>
<span class="token literal-property property">gce_sd_configs</span><span class="token operator">:</span>
  <span class="token punctuation">[</span> <span class="token operator">-</span> <span class="token operator">&lt;</span>gce_sd_config<span class="token operator">&gt;</span> <span class="token operator">...</span> <span class="token punctuation">]</span>
<span class="token literal-property property">kubernetes_sd_configs</span><span class="token operator">:</span>
  <span class="token punctuation">[</span> <span class="token operator">-</span> <span class="token operator">&lt;</span>kubernetes_sd_config<span class="token operator">&gt;</span> <span class="token operator">...</span> <span class="token punctuation">]</span>
<span class="token literal-property property">marathon_sd_configs</span><span class="token operator">:</span>
  <span class="token punctuation">[</span> <span class="token operator">-</span> <span class="token operator">&lt;</span>marathon_sd_config<span class="token operator">&gt;</span> <span class="token operator">...</span> <span class="token punctuation">]</span>
<span class="token literal-property property">nerve_sd_configs</span><span class="token operator">:</span>
  <span class="token punctuation">[</span> <span class="token operator">-</span> <span class="token operator">&lt;</span>nerve_sd_config<span class="token operator">&gt;</span> <span class="token operator">...</span> <span class="token punctuation">]</span>
<span class="token literal-property property">serverset_sd_configs</span><span class="token operator">:</span>
  <span class="token punctuation">[</span> <span class="token operator">-</span> <span class="token operator">&lt;</span>serverset_sd_config<span class="token operator">&gt;</span> <span class="token operator">...</span> <span class="token punctuation">]</span>
<span class="token literal-property property">triton_sd_configs</span><span class="token operator">:</span>
  <span class="token punctuation">[</span> <span class="token operator">-</span> <span class="token operator">&lt;</span>triton_sd_config<span class="token operator">&gt;</span> <span class="token operator">...</span> <span class="token punctuation">]</span>
<span class="token literal-property property">static_configs</span><span class="token operator">:</span>
  <span class="token punctuation">[</span> <span class="token operator">-</span> <span class="token operator">&lt;</span>static_config<span class="token operator">&gt;</span> <span class="token operator">...</span> <span class="token punctuation">]</span>
<span class="token literal-property property">relabel_configs</span><span class="token operator">:</span>
  <span class="token punctuation">[</span> <span class="token operator">-</span> <span class="token operator">&lt;</span>relabel_config<span class="token operator">&gt;</span> <span class="token operator">...</span> <span class="token punctuation">]</span>
</code></pre> 
<h3><a id="33_rule_files_211"></a>3.3 rule_files</h3> 
<p>这个主要是用来设置告警规则，基于设定什么指标进行报警（类似触发器trigger）。这里设定好规则以后，prometheus会根据全局global设定的evaluation_interval参数进行扫描加载，规则改动后会自动加载。其报警媒介和route路由由alertmanager插件实现。 样例：</p> 
<pre><code class="prism language-javascript"># Load rules once and periodically evaluate them according to the global <span class="token string">'evaluation_interval'</span><span class="token punctuation">.</span>
<span class="token literal-property property">rule_files</span><span class="token operator">:</span>
  # <span class="token operator">-</span> <span class="token string">"first_rules.yml"</span>
  # <span class="token operator">-</span> <span class="token string">"second_rules.yml"</span> 
</code></pre> 
<p>"first_rules.yml"样例：</p> 
<pre><code class="prism language-javascript"><span class="token literal-property property">groups</span><span class="token operator">:</span>
 <span class="token operator">-</span> name<span class="token operator">:</span> test<span class="token operator">-</span>rules
   <span class="token literal-property property">rules</span><span class="token operator">:</span>
   <span class="token operator">-</span> alert<span class="token operator">:</span> InstanceDown # 告警名称
     <span class="token literal-property property">expr</span><span class="token operator">:</span> up <span class="token operator">==</span> <span class="token number">0</span> # 告警的判定条件，参考Prometheus高级查询来设定
     <span class="token keyword">for</span><span class="token operator">:</span> 10s # 满足告警条件持续时间多久后，才会发送告警
     <span class="token literal-property property">labels</span><span class="token operator">:</span> #标签项
      <span class="token literal-property property">severity</span><span class="token operator">:</span> error
     <span class="token literal-property property">annotations</span><span class="token operator">:</span> # 解析项，详细解释告警信息
      <span class="token literal-property property">summary</span><span class="token operator">:</span> <span class="token string">"{<!-- -->{$labels.instance}}: has been down"</span>
      <span class="token literal-property property">description</span><span class="token operator">:</span> <span class="token string">"{<!-- -->{$labels.instance}}: job {<!-- -->{$labels.job}} has been down "</span>
</code></pre> 
<p>Prometheus 支持两种类型的 Rules ，可以对其进行配置，然后定期进行运算：recording rules 记录规则 与 alerting rules 警报规则，规则文件的计算频率与警报规则计算频率一致，都是通过全局配置中的 evaluation_interval 定义。</p> 
<h6><a id="rule_group_240"></a>规则分组rule_group</h6> 
<p>不论是recording rules还是alerting rules都要在组里面。</p> 
<pre><code class="prism language-javascript"><span class="token literal-property property">groups</span><span class="token operator">:</span>
  
  <span class="token operator">-</span> name<span class="token operator">:</span> example
    #该组下的规则
    <span class="token literal-property property">rules</span><span class="token operator">:</span>
      <span class="token punctuation">[</span> <span class="token operator">-</span> <span class="token operator">&lt;</span>rule<span class="token operator">&gt;</span> <span class="token operator">...</span> <span class="token punctuation">]</span>
</code></pre> 
<h6><a id="alerting_rules_253"></a>alerting rules</h6> 
<p>要在Prometheus中使用Rules规则，就必须创建一个包含必要规则语句的文件，并让Prometheus通过Prometheus配置中的rule_files字段加载该文件，前面我们已经讲过了。 其实语法都一样，除了 recording rules 中的收集的指标名称 record: 字段配置方式略有不同，其他都是一样的。</p> 
<p>配置范例：</p> 
<pre><code class="prism language-javascript"><span class="token operator">-</span> alert<span class="token operator">:</span> ServiceDown
  <span class="token literal-property property">expr</span><span class="token operator">:</span> <span class="token function">avg_over_time</span><span class="token punctuation">(</span>up<span class="token punctuation">[</span>5m<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span> <span class="token operator">&lt;</span> <span class="token number">50</span>
  <span class="token literal-property property">annotations</span><span class="token operator">:</span>
      <span class="token literal-property property">description</span><span class="token operator">:</span> The service <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> $labels<span class="token punctuation">.</span>job <span class="token punctuation">}</span><span class="token punctuation">}</span> instance <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> $labels<span class="token punctuation">.</span>instance <span class="token punctuation">}</span><span class="token punctuation">}</span> is
        not responding <span class="token keyword">for</span> more than <span class="token number">50</span><span class="token operator">%</span> <span class="token keyword">of</span> the time <span class="token keyword">for</span> <span class="token number">5</span> minutes<span class="token punctuation">.</span>
      <span class="token literal-property property">summary</span><span class="token operator">:</span> The service <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> $labels<span class="token punctuation">.</span>job <span class="token punctuation">}</span><span class="token punctuation">}</span> is not responding
<span class="token operator">-</span> alert<span class="token operator">:</span> RedisDown
  <span class="token literal-property property">expr</span><span class="token operator">:</span> <span class="token function">avg_over_time</span><span class="token punctuation">(</span>redis_up<span class="token punctuation">[</span>5m<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span> <span class="token operator">&lt;</span> <span class="token number">50</span>
  <span class="token literal-property property">annotations</span><span class="token operator">:</span>
      <span class="token literal-property property">description</span><span class="token operator">:</span> The Redis service <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> $labels<span class="token punctuation">.</span>job <span class="token punctuation">}</span><span class="token punctuation">}</span> instance <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> $labels<span class="token punctuation">.</span>instance
        <span class="token punctuation">}</span><span class="token punctuation">}</span> is not responding <span class="token keyword">for</span> more than <span class="token number">50</span><span class="token operator">%</span> <span class="token keyword">of</span> the time <span class="token keyword">for</span> <span class="token number">5</span> minutes<span class="token punctuation">.</span>
      <span class="token literal-property property">summary</span><span class="token operator">:</span> The Redis service <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> $labels<span class="token punctuation">.</span>job <span class="token punctuation">}</span><span class="token punctuation">}</span> is not responding
<span class="token operator">-</span> alert<span class="token operator">:</span> PostgresDown
  <span class="token literal-property property">expr</span><span class="token operator">:</span> <span class="token function">avg_over_time</span><span class="token punctuation">(</span>pg_up<span class="token punctuation">[</span>5m<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span> <span class="token operator">&lt;</span> <span class="token number">50</span>
  <span class="token literal-property property">annotations</span><span class="token operator">:</span>
      <span class="token literal-property property">description</span><span class="token operator">:</span> The Postgres service <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> $labels<span class="token punctuation">.</span>job <span class="token punctuation">}</span><span class="token punctuation">}</span> instance <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> $labels<span class="token punctuation">.</span>instance
        <span class="token punctuation">}</span><span class="token punctuation">}</span> is not responding <span class="token keyword">for</span> more than <span class="token number">50</span><span class="token operator">%</span> <span class="token keyword">of</span> the time <span class="token keyword">for</span> <span class="token number">5</span> minutes<span class="token punctuation">.</span>
      <span class="token literal-property property">summary</span><span class="token operator">:</span> The Postgres service <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> $labels<span class="token punctuation">.</span>job <span class="token punctuation">}</span><span class="token punctuation">}</span> is not responding
</code></pre> 
<h6><a id="Recording_rules_280"></a>定义Recording rules</h6> 
<p>recording rules 是提前设置好一个比较花费大量时间运算或经常运算的表达式，其结果保存成一组新的时间序列数据。当需要查询的时候直接会返回已经计算好的结果，这样会比直接查询快，同时也减轻了PromQl的计算压力，同时对可视化查询的时候也很有用，可视化展示每次只需要刷新重复查询相同的表达式即可。</p> 
<p>在配置的时候，除却 record: 需要注意，其他的基本上是一样的，一个 groups 下可以包含多条规则 rules ，Recording 和 Rules 保存在 group 内，Group 中的规则以规则的配置时间间隔顺序运算，也就是全局中的 evaluation_interval 设置。</p> 
<p>配置范例：</p> 
<pre><code class="prism language-javascript"><span class="token literal-property property">groups</span><span class="token operator">:</span>
<span class="token operator">-</span> name<span class="token operator">:</span> http_requests_total
  <span class="token literal-property property">rules</span><span class="token operator">:</span>
  <span class="token operator">-</span> record<span class="token operator">:</span> job<span class="token operator">:</span>http_requests_total<span class="token operator">:</span>rate10m
    <span class="token literal-property property">expr</span><span class="token operator">:</span> sum <span class="token function">by</span> <span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">rate</span><span class="token punctuation">(</span>http_requests_total<span class="token punctuation">[</span>10m<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token literal-property property">lables</span><span class="token operator">:</span>
      <span class="token literal-property property">team</span><span class="token operator">:</span> operations
  <span class="token operator">-</span> record<span class="token operator">:</span> job<span class="token operator">:</span>http_requests_total<span class="token operator">:</span>rate30m
    <span class="token literal-property property">expr</span><span class="token operator">:</span> sum <span class="token function">by</span> <span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">rate</span><span class="token punctuation">(</span>http_requests_total<span class="token punctuation">[</span>30m<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token literal-property property">lables</span><span class="token operator">:</span>
      <span class="token literal-property property">team</span><span class="token operator">:</span> operations
</code></pre> 
<p>上面的规则其实就是根据 record 规则中的定义，Prometheus 会在后台完成 expr 中定义的 PromQL 表达式周期性运算，以 job 为维度使用 sum 聚合运算符 计算 函数rate 对http_requests_total 指标区间 10m 内的增长率，并且将计算结果保存到新的时间序列 job:http_requests_total:rate10m 中， 同时还可以通过 labels 为样本数据添加额外的自定义标签，但是要注意的是这个 lables 一定存在当前表达式 Metrics 中。</p> 
<h6><a id="_304"></a>使用模板</h6> 
<p>模板是在警报中使用时间序列标签和值展示的一种方法，可以用于警报规则中的注释（annotation）与标签（lable）。模板其实使用的go语言的标准模板语法，并公开一些包含时间序列标签和值的变量。这样查询的时候，更具有可读性，也可以执行其他PromQL查询 来向警报添加额外内容，ALertmanager Web UI中会根据标签值显示器警报信息。</p> 
<p>{<!-- -->{ $lable.}} 可以获取当前警报实例中的指定标签值</p> 
<p>{<!-- -->{ $value }} 变量可以获取当前PromQL表达式的计算样本值。</p> 
<pre><code class="prism language-javascript"><span class="token literal-property property">groups</span><span class="token operator">:</span>
<span class="token operator">-</span> name<span class="token operator">:</span> operations
  <span class="token literal-property property">rules</span><span class="token operator">:</span>
# monitor node memory usage
  <span class="token operator">-</span> alert<span class="token operator">:</span> node<span class="token operator">-</span>memory<span class="token operator">-</span>usage
    <span class="token literal-property property">expr</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> <span class="token punctuation">(</span>node_memory_MemAvailable_bytes<span class="token punctuation">{<!-- --></span>env<span class="token operator">=</span><span class="token string">"operations"</span><span class="token punctuation">,</span>job<span class="token operator">!=</span><span class="token string">'atlassian'</span><span class="token punctuation">}</span> <span class="token operator">/</span> <span class="token punctuation">(</span>node_memory_MemTotal_bytes<span class="token punctuation">{<!-- --></span>env<span class="token operator">=</span><span class="token string">"operations"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">*</span> <span class="token number">100</span> <span class="token operator">&gt;</span> <span class="token number">90</span>
    <span class="token keyword">for</span><span class="token operator">:</span> 1m
    <span class="token literal-property property">labels</span><span class="token operator">:</span>
      <span class="token literal-property property">status</span><span class="token operator">:</span> Warning
      <span class="token literal-property property">team</span><span class="token operator">:</span> operations
    <span class="token literal-property property">annotations</span><span class="token operator">:</span>
      <span class="token literal-property property">description</span><span class="token operator">:</span> <span class="token string">"Environment: {<!-- -->{ $labels.env }} Instance: {<!-- -->{ $labels.instance }} memory usage above {<!-- -->{ $value }} ! ! !"</span>
      <span class="token literal-property property">summary</span><span class="token operator">:</span>  <span class="token string">"node os memory usage status"</span>
</code></pre> 
<p>调整好rules以后，我们可以使用 curl -XPOST <a href="https://links.jianshu.com/go?to=http%3A%2F%2Flocalhost%3A9090%2F-%2Freload" rel="nofollow">http://localhost:9090/-/reload</a> 或者 对Prometheus服务重启，让警报规则生效。</p> 
<p>这个时候，我们可以把阈值调整为 50 来进行故障模拟操作，这时在去访问UI的时候，当持续1分钟满足警报条件，实际警报状态已转换为 Firing，可以在 Annotations中看到模板信息 summary 与 description 已经成功显示。</p> 
<p><strong>规则检查</strong></p> 
<pre><code class="prism language-javascript">#打镜像后使用
<span class="token constant">FROM</span> <span class="token literal-property property">golang</span><span class="token operator">:</span><span class="token number">1.10</span>

<span class="token constant">RUN</span> <span class="token constant">GOOS</span><span class="token operator">=</span>linux <span class="token constant">GOARCH</span><span class="token operator">=</span>amd64 <span class="token constant">CGO_ENABLED</span><span class="token operator">=</span><span class="token number">0</span> go get <span class="token operator">-</span>u github<span class="token punctuation">.</span>com<span class="token operator">/</span>prometheus<span class="token operator">/</span>prometheus<span class="token operator">/</span>cmd<span class="token operator">/</span>promtool

<span class="token constant">FROM</span> <span class="token literal-property property">alpine</span><span class="token operator">:</span>latest  

<span class="token constant">COPY</span> <span class="token operator">--</span>from<span class="token operator">=</span><span class="token number">0</span> <span class="token operator">/</span>go<span class="token operator">/</span>bin<span class="token operator">/</span>promtool <span class="token operator">/</span>bin
<span class="token constant">ENTRYPOINT</span> <span class="token punctuation">[</span><span class="token string">"/bin/promtool"</span><span class="token punctuation">]</span>  

# 编译
docker build <span class="token operator">-</span>t promtool<span class="token operator">:</span><span class="token number">0.1</span> <span class="token punctuation">.</span>
#使用
docker run <span class="token operator">--</span>rm <span class="token operator">-</span>v <span class="token operator">/</span>root<span class="token operator">/</span>test<span class="token operator">/</span>prom<span class="token operator">:</span><span class="token operator">/</span>opt promtool<span class="token operator">:</span><span class="token number">0.1</span> check rules <span class="token operator">/</span>opt<span class="token operator">/</span>rule<span class="token punctuation">.</span>yml
#返回
Checking <span class="token operator">/</span>opt<span class="token operator">/</span>rule<span class="token punctuation">.</span>yml
  <span class="token constant">SUCCESS</span><span class="token operator">:</span> <span class="token number">1</span> rules found
</code></pre> 
<h3><a id="34_scrape_configs_354"></a>3.4 scrape_configs字段</h3> 
<p>拉取数据配置，在配置字段内可以配置拉取数据的对象(Targets)，job以及实例</p> 
<h6><a id="job_name_358"></a>job_name</h6> 
<p>定义job名称，是一个拉取单元。每个job_name都会自动引入默认配置如</p> 
<ul><li>scrape_interval 依赖全局配置</li><li>scrape_timeout 依赖全局配置</li><li>metrics_path 默认为’/metrics’</li><li>scheme 默认为’http’</li></ul> 
<p>这些也可以在单独的job中自定义</p> 
<pre><code class="prism language-javascript"><span class="token punctuation">[</span> scrape_interval<span class="token operator">:</span> <span class="token operator">&lt;</span>duration<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">default</span> <span class="token operator">=</span> <span class="token operator">&lt;</span>global_config<span class="token punctuation">.</span>scrape_interval<span class="token operator">&gt;</span> <span class="token punctuation">]</span>
<span class="token punctuation">[</span> scrape_timeout<span class="token operator">:</span> <span class="token operator">&lt;</span>duration<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">default</span> <span class="token operator">=</span> <span class="token operator">&lt;</span>global_config<span class="token punctuation">.</span>scrape_timeout<span class="token operator">&gt;</span> <span class="token punctuation">]</span>
<span class="token punctuation">[</span> metrics_path<span class="token operator">:</span> <span class="token operator">&lt;</span>path<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">default</span> <span class="token operator">=</span> <span class="token operator">/</span>metrics <span class="token punctuation">]</span>
</code></pre> 
<h6><a id="honor_labels_375"></a>honor_labels</h6> 
<p>服务端拉取过来的数据也会存在标签，配置文件中也会有标签，这样就可能发生冲突。</p> 
<p>true就是以抓取数据中的标签为准 false就会重新命名抓取数据中的标签为“exported”形式，然后添加配置文件中的标签</p> 
<pre><code class="prism language-javascript"><span class="token punctuation">[</span> honor_labels<span class="token operator">:</span> <span class="token operator">&lt;</span>boolean<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">default</span> <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token punctuation">]</span>
</code></pre> 
<h6><a id="scheme_385"></a>scheme</h6> 
<p>切换抓取数据所用的协议</p> 
<pre><code class="prism language-javascript"><span class="token punctuation">[</span> scheme<span class="token operator">:</span> <span class="token operator">&lt;</span>scheme<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">default</span> <span class="token operator">=</span> http <span class="token punctuation">]</span>
</code></pre> 
<h6><a id="params_393"></a>params</h6> 
<p>定义可选的url参数</p> 
<pre><code class="prism language-javascript"><span class="token punctuation">[</span> <span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">]</span> <span class="token punctuation">]</span>
</code></pre> 
<h5><a id="_401"></a>抓取认证类</h5> 
<p>每次抓取数据请求的认证信息</p> 
<h6><a id="basic_auth_405"></a>basic_auth</h6> 
<p>password和password_file互斥只可以选择其一</p> 
<pre><code class="prism language-javascript"><span class="token literal-property property">basic_auth</span><span class="token operator">:</span>
  <span class="token punctuation">[</span> username<span class="token operator">:</span> <span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token punctuation">]</span>
  <span class="token punctuation">[</span> password<span class="token operator">:</span> <span class="token operator">&lt;</span>secret<span class="token operator">&gt;</span> <span class="token punctuation">]</span>
  <span class="token punctuation">[</span> password_file<span class="token operator">:</span> <span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token punctuation">]</span>
</code></pre> 
<h6><a id="bearer_token_416"></a>bearer_token</h6> 
<p>bearer_token和bearer_token_file互斥只可以选择其一</p> 
<pre><code class="prism language-javascript"><span class="token punctuation">[</span> bearer_token<span class="token operator">:</span> <span class="token operator">&lt;</span>secret<span class="token operator">&gt;</span> <span class="token punctuation">]</span>
<span class="token punctuation">[</span> bearer_token_file<span class="token operator">:</span> <span class="token operator">/</span>path<span class="token operator">/</span>to<span class="token operator">/</span>bearer<span class="token operator">/</span>token<span class="token operator">/</span>file <span class="token punctuation">]</span>
</code></pre> 
<h6><a id="tls_config_425"></a>tls_config</h6> 
<p>抓取ssl请求时证书配置</p> 
<pre><code class="prism language-javascript"><span class="token literal-property property">tls_config</span><span class="token operator">:</span>
  <span class="token punctuation">[</span> ca_file<span class="token operator">:</span> <span class="token operator">&lt;</span>filename<span class="token operator">&gt;</span> <span class="token punctuation">]</span>
  <span class="token punctuation">[</span> cert_file<span class="token operator">:</span> <span class="token operator">&lt;</span>filename<span class="token operator">&gt;</span> <span class="token punctuation">]</span>
  <span class="token punctuation">[</span> key_file<span class="token operator">:</span> <span class="token operator">&lt;</span>filename<span class="token operator">&gt;</span> <span class="token punctuation">]</span>
  <span class="token punctuation">[</span> server_name<span class="token operator">:</span> <span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token punctuation">]</span>
  #禁用证书验证
  <span class="token punctuation">[</span> insecure_skip_verify<span class="token operator">:</span> <span class="token operator">&lt;</span>boolean<span class="token operator">&gt;</span> <span class="token punctuation">]</span>
</code></pre> 
<h6><a id="proxy_url_439"></a>proxy_url</h6> 
<p>通过代理去主去数据</p> 
<pre><code class="prism language-javascript"><span class="token punctuation">[</span> proxy_url<span class="token operator">:</span> <span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token punctuation">]</span>
</code></pre> 
<h5><a id="_447"></a>服务发现类</h5> 
<p>Prometheus支持多种服务现工具，详细配置这里不再展开</p> 
<pre><code class="prism language-javascript">#sd就是service discovery的缩写
<span class="token literal-property property">azure_sd_configs</span><span class="token operator">:</span> 
<span class="token literal-property property">consul_sd_configs</span><span class="token operator">:</span>
<span class="token literal-property property">dns_sd_configs</span><span class="token operator">:</span>
<span class="token literal-property property">ec2_sd_configs</span><span class="token operator">:</span>
<span class="token literal-property property">openstack_sd_configs</span><span class="token operator">:</span>
<span class="token literal-property property">file_sd_configs</span><span class="token operator">:</span>
<span class="token literal-property property">gce_sd_configs</span><span class="token operator">:</span>
<span class="token literal-property property">kubernetes_sd_configs</span><span class="token operator">:</span>
<span class="token literal-property property">marathon_sd_configs</span><span class="token operator">:</span>
<span class="token literal-property property">nerve_sd_configs</span><span class="token operator">:</span>
<span class="token literal-property property">serverset_sd_configs</span><span class="token operator">:</span>
<span class="token literal-property property">triton_sd_configs</span><span class="token operator">:</span>
</code></pre> 
<p>更多参考官网：<a href="https://links.jianshu.com/go?to=https%3A%2F%2Fprometheus.io%2Fdocs%2Fprometheus%2Flatest%2Fconfiguratio" rel="nofollow">https://prometheus.io/docs/prometheus/latest/configuratio</a> n/configuration/</p> 
<h5><a id="static_configs_469"></a>static_configs</h5> 
<p>服务发现来获取抓取目标为动态配置，这个配置项目为静态配置，静态配置为典型的targets配置，在改配置字段可以直接添加标签</p> 
<pre><code class="prism language-javascript"><span class="token operator">-</span> targets<span class="token operator">:</span>
    <span class="token punctuation">[</span> <span class="token operator">-</span> <span class="token string">'&lt;host&gt;'</span> <span class="token punctuation">]</span>
  <span class="token literal-property property">labels</span><span class="token operator">:</span>
    <span class="token punctuation">[</span> <span class="token operator">&lt;</span>labelname<span class="token operator">&gt;</span><span class="token operator">:</span> <span class="token operator">&lt;</span>labelvalue<span class="token operator">&gt;</span> <span class="token operator">...</span> <span class="token punctuation">]</span>
</code></pre> 
<p>采集器所采集的数据都会带有label，当使用服务发现时，比如consul所携带的label如下:</p> 
<pre><code class="prism language-javascript"><span class="token literal-property property">__meta_consul_address</span><span class="token operator">:</span> consul地址
<span class="token literal-property property">__meta_consul_dc</span><span class="token operator">:</span> consul中服务所在的数据中心
<span class="token literal-property property">__meta_consul_metadata_</span><span class="token operator">:</span> 服务的metadata
<span class="token literal-property property">__meta_consul_node</span><span class="token operator">:</span> 服务所在consul节点的信息
<span class="token literal-property property">__meta_consul_service_address</span><span class="token operator">:</span> 服务访问地址
<span class="token literal-property property">__meta_consul_service_id</span><span class="token operator">:</span> 服务<span class="token constant">ID</span>
<span class="token literal-property property">__meta_consul_service_port</span><span class="token operator">:</span> 服务端口
<span class="token literal-property property">__meta_consul_service</span><span class="token operator">:</span> 服务名称
<span class="token literal-property property">__meta_consul_tags</span><span class="token operator">:</span> 服务包含的标签信息
</code></pre> 
<p>这些lable是数据筛选与聚合计算的基础。</p> 
<h5><a id="_496"></a>数据过滤类</h5> 
<p>抓取数据很繁杂，尤其是通过服务发现添加的target。所以过滤就显得尤为重要，我们知道抓取数据就是抓取target的一些列metrics，Prometheus过滤是通过对标签操作操现的，在字段relabel_configs和metric_relabel_configs里面配置，两者的配置都需要relabel_config字段。该字段需要配置项如下</p> 
<pre><code class="prism language-javascript"><span class="token punctuation">[</span> source_labels<span class="token operator">:</span> <span class="token string">'['</span> <span class="token operator">&lt;</span>labelname<span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">]</span> <span class="token string">']'</span> <span class="token punctuation">]</span>

<span class="token punctuation">[</span> separator<span class="token operator">:</span> <span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">default</span> <span class="token operator">=</span> <span class="token punctuation">;</span> <span class="token punctuation">]</span>

<span class="token punctuation">[</span> target_label<span class="token operator">:</span> <span class="token operator">&lt;</span>labelname<span class="token operator">&gt;</span> <span class="token punctuation">]</span>

<span class="token punctuation">[</span> regex<span class="token operator">:</span> <span class="token operator">&lt;</span>regex<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">default</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">]</span>

<span class="token punctuation">[</span> modulus<span class="token operator">:</span> <span class="token operator">&lt;</span>uint64<span class="token operator">&gt;</span> <span class="token punctuation">]</span>

<span class="token punctuation">[</span> replacement<span class="token operator">:</span> <span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">default</span> <span class="token operator">=</span> $1 <span class="token punctuation">]</span>

#action除了默认动作还有keep、drop、hashmod、labelmap、labeldrop、labelkeep
<span class="token punctuation">[</span> action<span class="token operator">:</span> <span class="token operator">&lt;</span>relabel_action<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">default</span> <span class="token operator">=</span> replace <span class="token punctuation">]</span>
</code></pre> 
<p><strong>target配置示例</strong></p> 
<pre><code class="prism language-javascript"><span class="token literal-property property">relabel_configs</span><span class="token operator">:</span>
  <span class="token operator">-</span> source_labels<span class="token operator">:</span> <span class="token punctuation">[</span>job<span class="token punctuation">]</span>
    <span class="token literal-property property">regex</span><span class="token operator">:</span>         <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">)</span>some<span class="token operator">-</span><span class="token punctuation">[</span>regex<span class="token punctuation">]</span>
    <span class="token literal-property property">action</span><span class="token operator">:</span>        drop
  <span class="token operator">-</span> source_labels<span class="token operator">:</span> <span class="token punctuation">[</span>__address__<span class="token punctuation">]</span>
    <span class="token literal-property property">modulus</span><span class="token operator">:</span>       <span class="token number">8</span>
    <span class="token literal-property property">target_label</span><span class="token operator">:</span>  __tmp_hash
    <span class="token literal-property property">action</span><span class="token operator">:</span>        hashmod
</code></pre> 
<p>target中metric示例</p> 
<pre><code class="prism language-javascript"><span class="token operator">-</span> job_name<span class="token operator">:</span> cadvisor
  <span class="token operator">...</span>
  <span class="token literal-property property">metric_relabel_configs</span><span class="token operator">:</span>
  <span class="token operator">-</span> source_labels<span class="token operator">:</span> <span class="token punctuation">[</span>id<span class="token punctuation">]</span>
    <span class="token literal-property property">regex</span><span class="token operator">:</span> <span class="token string">'/system.slice/var-lib-docker-containers.*-shm.mount'</span>
    <span class="token literal-property property">action</span><span class="token operator">:</span> drop
  <span class="token operator">-</span> source_labels<span class="token operator">:</span> <span class="token punctuation">[</span>container_label_JenkinsId<span class="token punctuation">]</span>
    <span class="token literal-property property">regex</span><span class="token operator">:</span> <span class="token string">'.+'</span>
    <span class="token literal-property property">action</span><span class="token operator">:</span> drop
</code></pre> 
<p><strong>target中metric示例</strong></p> 
<pre><code class="prism language-javascript"><span class="token operator">-</span> job_name<span class="token operator">:</span> cadvisor
  <span class="token operator">...</span>
  <span class="token literal-property property">metric_relabel_configs</span><span class="token operator">:</span>
  <span class="token operator">-</span> source_labels<span class="token operator">:</span> <span class="token punctuation">[</span>id<span class="token punctuation">]</span>
    <span class="token literal-property property">regex</span><span class="token operator">:</span> <span class="token string">'/system.slice/var-lib-docker-containers.*-shm.mount'</span>
    <span class="token literal-property property">action</span><span class="token operator">:</span> drop
  <span class="token operator">-</span> source_labels<span class="token operator">:</span> <span class="token punctuation">[</span>container_label_JenkinsId<span class="token punctuation">]</span>
    <span class="token literal-property property">regex</span><span class="token operator">:</span> <span class="token string">'.+'</span>
    <span class="token literal-property property">action</span><span class="token operator">:</span> drop
</code></pre> 
<p><strong>使用示例</strong> 由以上可知当使用服务发现consul会带入标签__meta_consul_dc，现在为了表示方便需要将该标签变为dc</p> 
<p>需要做如下配置，这里面action使用的replacement</p> 
<pre><code class="prism language-javascript"><span class="token literal-property property">scrape_configs</span><span class="token operator">:</span>
  <span class="token operator">-</span> job_name<span class="token operator">:</span> consul_sd
    <span class="token literal-property property">relabel_configs</span><span class="token operator">:</span>
    <span class="token operator">-</span> source_labels<span class="token operator">:</span>  <span class="token punctuation">[</span><span class="token string">"__meta_consul_dc"</span><span class="token punctuation">]</span>
      <span class="token literal-property property">regex</span><span class="token operator">:</span> <span class="token string">"(.*)"</span>
      <span class="token literal-property property">replacement</span><span class="token operator">:</span> $1
      <span class="token literal-property property">action</span><span class="token operator">:</span> replace
      <span class="token literal-property property">target_label</span><span class="token operator">:</span> <span class="token string">"dc"</span>

#或者
<span class="token operator">-</span> source_labels<span class="token operator">:</span>  <span class="token punctuation">[</span><span class="token string">"__meta_consul_dc"</span><span class="token punctuation">]</span>
  <span class="token literal-property property">target_label</span><span class="token operator">:</span> <span class="token string">"dc"</span>
</code></pre> 
<p>过滤采集target</p> 
<pre><code class="prism language-javascript"><span class="token literal-property property">relabel_configs</span><span class="token operator">:</span>
<span class="token operator">-</span> source_labels<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"__meta_consul_tags"</span><span class="token punctuation">]</span>
  <span class="token literal-property property">regex</span><span class="token operator">:</span> <span class="token string">".*,development,.*"</span>
  <span class="token literal-property property">action</span><span class="token operator">:</span> keep
</code></pre> 
<h6><a id="sample_limit_586"></a>sample_limit</h6> 
<p>为了防止Prometheus服务过载，使用该字段限制经过relabel之后的数据采集数量，超过该数字拉取的数据就会被忽略</p> 
<pre><code class="prism language-javascript"><span class="token punctuation">[</span> sample_limit<span class="token operator">:</span> <span class="token operator">&lt;</span>int<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">default</span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">]</span>
</code></pre> 
<h3><a id="38__594"></a>3.8 远程读写</h3> 
<p>Prometheus可以进行远程读/写数据。字段remote_read和remote_write</p> 
<h6><a id="remote_read_598"></a>remote_read</h6> 
<pre><code class="prism language-javascript">#远程读取的url
<span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token operator">&lt;</span>string<span class="token operator">&gt;</span>

#通过标签来过滤读取的数据
<span class="token literal-property property">required_matchers</span><span class="token operator">:</span>
  <span class="token punctuation">[</span> <span class="token operator">&lt;</span>labelname<span class="token operator">&gt;</span><span class="token operator">:</span> <span class="token operator">&lt;</span>labelvalue<span class="token operator">&gt;</span> <span class="token operator">...</span> <span class="token punctuation">]</span>

<span class="token punctuation">[</span> remote_timeout<span class="token operator">:</span> <span class="token operator">&lt;</span>duration<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">default</span> <span class="token operator">=</span> 1m <span class="token punctuation">]</span>

#当远端不是存储的时候激活该项
<span class="token punctuation">[</span> read_recent<span class="token operator">:</span> <span class="token operator">&lt;</span>boolean<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">default</span> <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token punctuation">]</span>

<span class="token literal-property property">basic_auth</span><span class="token operator">:</span>
  <span class="token punctuation">[</span> username<span class="token operator">:</span> <span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token punctuation">]</span>
  <span class="token punctuation">[</span> password<span class="token operator">:</span> <span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token punctuation">]</span>
  <span class="token punctuation">[</span> password_file<span class="token operator">:</span> <span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token punctuation">]</span>
<span class="token punctuation">[</span> bearer_token<span class="token operator">:</span> <span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token punctuation">]</span>
<span class="token punctuation">[</span> bearer_token_file<span class="token operator">:</span> <span class="token operator">/</span>path<span class="token operator">/</span>to<span class="token operator">/</span>bearer<span class="token operator">/</span>token<span class="token operator">/</span>file <span class="token punctuation">]</span>
<span class="token literal-property property">tls_config</span><span class="token operator">:</span>
  <span class="token punctuation">[</span> <span class="token operator">&lt;</span>tls_config<span class="token operator">&gt;</span> <span class="token punctuation">]</span>
<span class="token punctuation">[</span> proxy_url<span class="token operator">:</span> <span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token punctuation">]</span>
</code></pre> 
<h6><a id="remote_write_624"></a>remote_write</h6> 
<pre><code class="prism language-javascript"><span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token operator">&lt;</span>string<span class="token operator">&gt;</span>

<span class="token punctuation">[</span> remote_timeout<span class="token operator">:</span> <span class="token operator">&lt;</span>duration<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">default</span> <span class="token operator">=</span> 30s <span class="token punctuation">]</span>

#写入数据时候进行标签过滤
<span class="token literal-property property">write_relabel_configs</span><span class="token operator">:</span>
  <span class="token punctuation">[</span> <span class="token operator">-</span> <span class="token operator">&lt;</span>relabel_config<span class="token operator">&gt;</span> <span class="token operator">...</span> <span class="token punctuation">]</span>

<span class="token literal-property property">basic_auth</span><span class="token operator">:</span>
  <span class="token punctuation">[</span> username<span class="token operator">:</span> <span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token punctuation">]</span>
  <span class="token punctuation">[</span> password<span class="token operator">:</span> <span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token punctuation">]</span>
  <span class="token punctuation">[</span> password_file<span class="token operator">:</span> <span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token punctuation">]</span>

<span class="token punctuation">[</span> bearer_token<span class="token operator">:</span> <span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token punctuation">]</span>

<span class="token punctuation">[</span> bearer_token_file<span class="token operator">:</span> <span class="token operator">/</span>path<span class="token operator">/</span>to<span class="token operator">/</span>bearer<span class="token operator">/</span>token<span class="token operator">/</span>file <span class="token punctuation">]</span>

<span class="token literal-property property">tls_config</span><span class="token operator">:</span>
  <span class="token punctuation">[</span> <span class="token operator">&lt;</span>tls_config<span class="token operator">&gt;</span> <span class="token punctuation">]</span>

<span class="token punctuation">[</span> proxy_url<span class="token operator">:</span> <span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token punctuation">]</span>

#远端写细粒度配置，这里暂时仅仅列出官方注释
<span class="token literal-property property">queue_config</span><span class="token operator">:</span>
  # Number <span class="token keyword">of</span> samples to buffer per shard before we start dropping them<span class="token punctuation">.</span>
  <span class="token punctuation">[</span> capacity<span class="token operator">:</span> <span class="token operator">&lt;</span>int<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">default</span> <span class="token operator">=</span> <span class="token number">10000</span> <span class="token punctuation">]</span>
  # Maximum number <span class="token keyword">of</span> shards<span class="token punctuation">,</span> i<span class="token punctuation">.</span>e<span class="token punctuation">.</span> amount <span class="token keyword">of</span> concurrency<span class="token punctuation">.</span>
  <span class="token punctuation">[</span> max_shards<span class="token operator">:</span> <span class="token operator">&lt;</span>int<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">default</span> <span class="token operator">=</span> <span class="token number">1000</span> <span class="token punctuation">]</span>
  # Maximum number <span class="token keyword">of</span> samples per send<span class="token punctuation">.</span>
  <span class="token punctuation">[</span> max_samples_per_send<span class="token operator">:</span> <span class="token operator">&lt;</span>int<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">default</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">]</span>
  # Maximum time a sample will wait <span class="token keyword">in</span> buffer<span class="token punctuation">.</span>
  <span class="token punctuation">[</span> batch_send_deadline<span class="token operator">:</span> <span class="token operator">&lt;</span>duration<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">default</span> <span class="token operator">=</span> 5s <span class="token punctuation">]</span>
  # Maximum number <span class="token keyword">of</span> times to retry a batch on recoverable errors<span class="token punctuation">.</span>
  <span class="token punctuation">[</span> max_retries<span class="token operator">:</span> <span class="token operator">&lt;</span>int<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">default</span> <span class="token operator">=</span> <span class="token number">3</span> <span class="token punctuation">]</span>
  # Initial retry delay<span class="token punctuation">.</span> Gets doubled <span class="token keyword">for</span> every retry<span class="token punctuation">.</span>
  <span class="token punctuation">[</span> min_backoff<span class="token operator">:</span> <span class="token operator">&lt;</span>duration<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">default</span> <span class="token operator">=</span> 30ms <span class="token punctuation">]</span>
  # Maximum retry delay<span class="token punctuation">.</span>
  <span class="token punctuation">[</span> max_backoff<span class="token operator">:</span> <span class="token operator">&lt;</span>duration<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">default</span> <span class="token operator">=</span> 100ms <span class="token punctuation">]</span>
</code></pre> 
<h2><a id="3__667"></a>3. 参考</h2> 
<p>（1）Prometheus 配置详解 <a href="https://links.jianshu.com/go?to=https%3A%2F%2Fwww.dazhuanlan.com%2F2019%2F12%2F12%2F5df11ada207ce%2F" rel="nofollow">https://www.dazhuanlan.com/2019/12/12/5df11ada207ce/</a></p> 
<p>（2）Prometheus配置文件prometheus.yml 四个模块详解 <a href="https://links.jianshu.com/go?to=http%3A%2F%2Fwww.21yunwei.com%2Farchives%2F7321" rel="nofollow">http://www.21yunwei.com/archives/7321</a></p> 
<p>（3）官方文档说明 <a href="https://links.jianshu.com/go?to=https%3A%2F%2Fprometheus.io%2Fdocs%2Fprometheus%2Flatest%2Fconfiguration%2Fconfiguration%2F" rel="nofollow">https://prometheus.io/docs/prometheus/latest/configuration/configuration/</a></p> 
<p>（4）Prometheus监控神器-Rules篇 <a href="https://links.jianshu.com/go?to=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F179295676" rel="nofollow">https://zhuanlan.zhihu.com/p/179295676</a></p> 
<p>（5）Prometheus监控神器-Alertmanager篇(1) <a href="https://links.jianshu.com/go?to=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F179292686" rel="nofollow">https://zhuanlan.zhihu.com/p/179292686</a></p> 
<p>（6）Prometheus监控神器-Alertmanager篇(2) <a href="https://links.jianshu.com/go?to=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F179294441" rel="nofollow">https://zhuanlan.zhihu.com/p/179294441</a></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/354f89b2ae9a6f06a6b681fe53b87fca/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">在vue中使用event事件</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/fbf1c8e1b0e2992b5beb59fa3eeae227/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">牛客网——扫雷</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>