<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>从零开始的图像语义分割：FCN快速复现教程（Pytorch&#43;CityScapes数据集） - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="从零开始的图像语义分割：FCN快速复现教程（Pytorch&#43;CityScapes数据集）" />
<meta property="og:description" content="从零开始的图像语义分割：FCN复现教程（Pytorch&#43;CityScapes数据集） 前言一、图像分割开山之作FCN二、代码及数据集获取1.源项目代码2.CityScapes数据集 三、代码复现1.数据预处理2.代码修改3.运行结果 总结参考网站 前言 摆了两周，突然觉得不能一直再颓废下去了，应该利用好时间，并且上个月就读了一些经典的图像分割论文比如FCN、UNet和Mask R-CNN，但仅仅只是读了论文并且大概了解了图像分割是在做什么任务的，于是今天就拉动手复现一下，因为只有代码运行起来了，才能进行接下来的代码阅读以及其他改进迁移等后续工作。
本文着重在于代码的复现，其他相关知识会涉及得较少，需要读者自行了解。
看完这篇文章，您将收获一个完整的图像分割项目（一个通用的图像分割数据集及一份可正常执行的代码）。
一、图像分割开山之作FCN 图来自FCN,Jonathan Long,Evan Shelhamer,Trevor Darrell CVPR2015
图像分割可以大致为实例分割、语义分割，其中语义分割(Semantic Segmentation)是对图像中每一个像素点进行分类，确定每个点的类别（如属于背景、人或车等），从而进行区域划分。目前，语义分割已经被广泛应用于自动驾驶、无人机落点判定等场景中。
FCN全程Fully Convolutional Networks，最早发表于CVPR2015，原论文链接如下：
FCN论文链接：https://arxiv.org/abs/1411.4038
正如其名称全卷积网络，实则是将早年的网络比如VGG的全连接层代替为卷积层，这样做的目的是让模型可以输入不同尺寸的图像，因为全连接层一旦被创建输入输出维度都是固定的，追根溯源就是输入图片的尺寸固定，并且语义分割是像素级别操作，替换为卷积层也更加合理（卷积操作就是像素级别，这些都是后话了）。
更具体的学习视频可以跳转到b站FCN网络结构详解(语义分割)
二、代码及数据集获取 1.源项目代码 进入FCN论文链接，点击Code&amp;Data再进入Community Code跳转到paperwithcode网站。
很神奇地是会发现有两个FCN的检索链接，本文所需要的pytorch项目代码在红框这个链接中
Star最高的就是本文所需项目，这个大佬还有自己的个人网页，而且号称是FCN最简单的实现，我可以作证此言不虚，的确是众多代码中最简洁明朗的。
2.CityScapes数据集 CityScapes数据集官方下载链接：CityScapes Download
然而下载这个数据集需要注册账号，而且需要的是教育邮箱，可能是按照是否带edu.cn域名判断的吧，本人使用学校邮箱成功注册下载了数据集。读者若有不便可以上网其他途径获取或淘宝买个账号。
只需下载前3个数据集即可，gtFine_trainvaltest是精确标注（最主要最关键部分），gtCoarse是粗略标注，leftimg8bit_trainvaltest是原图。虽然模型训练的时候只需要用到gtFine但是因为接下来还需要预处理数据集，因此要将三个数据集下载好，才能执行官方给的预处理代码。
重构数据集
将三个zip解压然后新建一个文件夹命名为CityScapes，然后将三个解压文件里的内容按上图目录放置好，为数据集预处理做准备。
三、代码复现 1.数据预处理 这里需要先下载官方的脚本：cityscapesScripts
接下来对其中的一些地方进行修改，最重要的两个文件为项目下cityscapesscripts\helpers\labels.py和cityscapesscripts\preparation\createTrainIdLabelImgs.py。
蓝色框为原本的代码，直接注释掉添加红框处代码，即指定自己本地的数据集目录，比如我就将CityScapes放到了E盘的dataset目录下。
然后是在label.py文件里按照训练的需要更改trainid，255为不被模型所需要的id，因为FCN中为19类&#43;背景板，所以为20类，刚好符合所以不需要更改label文件中任何内容。
最后运行createTrainIdLabelImgs.py，如果报错的话大概率是因为缺少上图蓝框所示的库，将其直接注释掉就可以了。
2.代码修改 之所以需要修改是因为原本的代码里面数据预处理那块太慢了，Cityscapes_utils.py要将trainId写入npy文件，运行速度极慢，这也是先前用官方预处理脚本cityscapesScripts来预处理的原因，预处理的目的其实也只是生成TrainIds的mask图片，和labelIds的png图片是同理的，只是每个像素所对应类别按照label.py里面的label表进行改变。
其实pytorch官方有给出加载CityScapes的数据集代码，但其直接拿来用并不能满足我们要求，所以需要修改一下，就原项目代码的Cityscapes_loader.py和torchvision.datasets.Cityscapes的代码结合，得到如下可执行代码。读者只需用其替换train.py文件即可。
# -*- coding: utf-8 -*- # Author: Reganzhx from __future__ import print_function import random from tqdm import tqdm # 由于训练缓慢，添加进度条方便观察 import imageio import torch import torch." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/dc93dafe48053482e3650e62253d0f1c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-11-23T14:43:38+08:00" />
<meta property="article:modified_time" content="2022-11-23T14:43:38+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">从零开始的图像语义分割：FCN快速复现教程（Pytorch&#43;CityScapes数据集）</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>从零开始的图像语义分割：FCN复现教程（Pytorch+CityScapes数据集）</h4> 
 <ul><li><a href="#_6" rel="nofollow">前言</a></li><li><a href="#FCN_10" rel="nofollow">一、图像分割开山之作FCN</a></li><li><a href="#_21" rel="nofollow">二、代码及数据集获取</a></li><li><ul><li><a href="#1_22" rel="nofollow">1.源项目代码</a></li><li><a href="#2CityScapes_29" rel="nofollow">2.CityScapes数据集</a></li></ul> 
  </li><li><a href="#_39" rel="nofollow">三、代码复现</a></li><li><ul><li><a href="#1_40" rel="nofollow">1.数据预处理</a></li><li><a href="#2_49" rel="nofollow">2.代码修改</a></li><li><a href="#3_295" rel="nofollow">3.运行结果</a></li></ul> 
  </li><li><a href="#_326" rel="nofollow">总结</a></li><li><a href="#_330" rel="nofollow">参考网站</a></li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="_6"></a>前言</h2> 
<p>摆了两周，突然觉得不能一直再颓废下去了，应该利用好时间，并且上个月就读了一些经典的图像分割论文比如FCN、UNet和Mask R-CNN，但仅仅只是读了论文并且大概了解了图像分割是在做什么任务的，于是今天就拉动手复现一下，因为只有代码运行起来了，才能进行接下来的代码阅读以及其他改进迁移等后续工作。<br> 本文着重在于代码的复现，其他相关知识会涉及得较少，需要读者自行了解。<br> <strong>看完这篇文章，您将收获一个完整的图像分割项目（一个通用的图像分割数据集及一份可正常执行的代码）。</strong></p> 
<h2><a id="FCN_10"></a>一、图像分割开山之作FCN</h2> 
<p><img src="https://images2.imgbox.com/7d/e1/NbIohTAe_o.png" alt=""><br> 图来自FCN,Jonathan Long,Evan Shelhamer,Trevor Darrell CVPR2015</p> 
<p><strong>图像分割可以大致为实例分割、语义分割，其中语义分割(Semantic Segmentation)是对图像中每一个像素点进行分类，确定每个点的类别（如属于背景、人或车等），从而进行区域划分。目前，语义分割已经被广泛应用于自动驾驶、无人机落点判定等场景中。<br> FCN全程Fully Convolutional Networks，最早发表于CVPR2015，原论文链接如下：<br> <a href="https://arxiv.org/abs/1411.4038" rel="nofollow">FCN论文链接：https://arxiv.org/abs/1411.4038</a><br> 正如其名称全卷积网络，实则是将早年的网络比如VGG的全连接层代替为卷积层，这样做的目的是让模型可以输入不同尺寸的图像，因为全连接层一旦被创建输入输出维度都是固定的，追根溯源就是输入图片的尺寸固定，并且语义分割是像素级别操作，替换为卷积层也更加合理（卷积操作就是像素级别，这些都是后话了）。<br> 更具体的学习视频可以跳转到b站<a href="https://www.bilibili.com/video/BV1J3411C7zd/?spm_id_from=333.788" rel="nofollow">FCN网络结构详解(语义分割)</a></strong></p> 
<hr> 
<h2><a id="_21"></a>二、代码及数据集获取</h2> 
<h3><a id="1_22"></a>1.源项目代码</h3> 
<p><img src="https://images2.imgbox.com/01/b4/8XHTcRmL_o.png" alt="在这里插入图片描述"><br> <strong>进入FCN论文链接，点击Code&amp;Data再进入Community Code跳转到paperwithcode网站。</strong><br> <img src="https://images2.imgbox.com/79/bb/ioO3bAwI_o.png" alt="在这里插入图片描述"><br> <strong>很神奇地是会发现有两个FCN的检索链接，本文所需要的pytorch项目代码在红框这个链接中</strong><br> <img src="https://images2.imgbox.com/33/d1/jmkp08kg_o.png" alt="在这里插入图片描述"><br> <strong>Star最高的就是本文所需项目，这个大佬还有自己的个人网页，而且号称是FCN最简单的实现，我可以作证此言不虚，的确是众多代码中最简洁明朗的。</strong></p> 
<h3><a id="2CityScapes_29"></a>2.CityScapes数据集</h3> 
<p><strong>CityScapes数据集官方下载链接：<a href="https://www.cityscapes-dataset.com/downloads/" rel="nofollow">CityScapes Download</a><br> 然而下载这个数据集需要注册账号，而且需要的是教育邮箱，可能是按照是否带edu.cn域名判断的吧，本人使用学校邮箱成功注册下载了数据集。读者若有不便可以上网其他途径获取或淘宝买个账号。</strong><br> <img src="https://images2.imgbox.com/45/27/I21rB0Hm_o.png" alt="在这里插入图片描述"><br> <strong>只需下载前3个数据集即可，gtFine_trainvaltest是精确标注（最主要最关键部分），gtCoarse是粗略标注，leftimg8bit_trainvaltest是原图。虽然模型训练的时候只需要用到gtFine但是因为接下来还需要预处理数据集，因此要将三个数据集下载好，才能执行官方给的预处理代码。</strong><br> <em><strong>重构数据集</strong></em><br> <img src="https://images2.imgbox.com/80/40/pTkYcvpq_o.png" alt="在这里插入图片描述"><br> <strong>将三个zip解压然后新建一个文件夹命名为CityScapes，然后将三个解压文件里的内容按上图目录放置好，为数据集预处理做准备。</strong></p> 
<hr> 
<h2><a id="_39"></a>三、代码复现</h2> 
<h3><a id="1_40"></a>1.数据预处理</h3> 
<p><strong>这里需要先下载官方的脚本：<a href="https://github.com/mcordts/cityscapesScripts">cityscapesScripts</a><br> 接下来对其中的一些地方进行修改，最重要的两个文件为项目下cityscapesscripts\helpers\labels.py和cityscapesscripts\preparation\createTrainIdLabelImgs.py。</strong><br> <img src="https://images2.imgbox.com/f5/9b/O72LlxK4_o.png" alt="在这里插入图片描述"><br> <strong>蓝色框为原本的代码，直接注释掉添加红框处代码，即指定自己本地的数据集目录，比如我就将CityScapes放到了E盘的dataset目录下。</strong><br> <img src="https://images2.imgbox.com/97/41/pIs233tZ_o.png" alt="在这里插入图片描述"><br> <strong>然后是在label.py文件里按照训练的需要更改trainid，255为不被模型所需要的id，因为FCN中为19类+背景板，所以为20类，刚好符合所以不需要更改label文件中任何内容。</strong><br> <img src="https://images2.imgbox.com/67/d2/YU2cK2fm_o.png" alt="在这里插入图片描述"><br> <strong>最后运行createTrainIdLabelImgs.py，如果报错的话大概率是因为缺少上图蓝框所示的库，将其直接注释掉就可以了。</strong></p> 
<h3><a id="2_49"></a>2.代码修改</h3> 
<p><strong>之所以需要修改是因为原本的代码里面数据预处理那块太慢了，Cityscapes_utils.py要将trainId写入npy文件，运行速度极慢，这也是先前用官方预处理脚本cityscapesScripts来预处理的原因，预处理的目的其实也只是生成TrainIds的mask图片，和labelIds的png图片是同理的，只是每个像素所对应类别按照label.py里面的label表进行改变。<br> 其实pytorch官方有给出加载CityScapes的数据集代码，但其直接拿来用并不能满足我们要求，所以需要修改一下，就原项目代码的Cityscapes_loader.py和torchvision.datasets.Cityscapes的代码结合，得到如下可执行代码。读者只需用其替换train.py文件即可。</strong></p> 
<pre><code class="prism language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token comment"># Author: Reganzhx</span>

<span class="token keyword">from</span> __future__ <span class="token keyword">import</span> print_function

<span class="token keyword">import</span> random
<span class="token keyword">from</span> tqdm <span class="token keyword">import</span> tqdm <span class="token comment"># 由于训练缓慢，添加进度条方便观察</span>
<span class="token keyword">import</span> imageio
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>optim <span class="token keyword">as</span> optim
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>optim <span class="token keyword">import</span> lr_scheduler
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>autograd <span class="token keyword">import</span> Variable
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">import</span> DataLoader

<span class="token keyword">from</span> fcn <span class="token keyword">import</span> VGGNet<span class="token punctuation">,</span> FCN32s<span class="token punctuation">,</span> FCN16s<span class="token punctuation">,</span> FCN8s<span class="token punctuation">,</span> FCNs
<span class="token comment"># from Cityscapes_loader import CityScapesDataset</span>
<span class="token keyword">from</span> CamVid_loader <span class="token keyword">import</span> CamVidDataset
<span class="token keyword">from</span> torchvision<span class="token punctuation">.</span>datasets <span class="token keyword">import</span> Cityscapes
<span class="token keyword">from</span> matplotlib <span class="token keyword">import</span> pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> time
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> os
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image


<span class="token keyword">class</span> <span class="token class-name">CityScapesDataset</span><span class="token punctuation">(</span>Cityscapes<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> root<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
                 split<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"train"</span><span class="token punctuation">,</span>
                 mode<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"fine"</span><span class="token punctuation">,</span>
                 target_type<span class="token operator">=</span><span class="token string">"semantic"</span><span class="token punctuation">,</span>
                 transform<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 target_transform<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 transforms<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>CityScapesDataset<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>root<span class="token punctuation">,</span>
                                                split<span class="token punctuation">,</span>
                                                mode<span class="token punctuation">,</span>
                                                target_type<span class="token punctuation">,</span>
                                                transform<span class="token punctuation">,</span>
                                                target_transform<span class="token punctuation">,</span>
                                                transforms<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>means <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">103.939</span><span class="token punctuation">,</span> <span class="token number">116.779</span><span class="token punctuation">,</span> <span class="token number">123.68</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">255.</span>
        self<span class="token punctuation">.</span>n_class <span class="token operator">=</span> <span class="token number">20</span>
        self<span class="token punctuation">.</span>new_h <span class="token operator">=</span> <span class="token number">512</span> <span class="token comment"># 数据集图片过大，需要剪裁</span>
        self<span class="token punctuation">.</span>new_w <span class="token operator">=</span> <span class="token number">1024</span>

    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">:</span>
        img <span class="token operator">=</span> imageio<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>self<span class="token punctuation">.</span>images<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">,</span> pilmode<span class="token operator">=</span><span class="token string">'RGB'</span><span class="token punctuation">)</span>
        targets <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> i<span class="token punctuation">,</span> t <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>target_type<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> t <span class="token operator">==</span> <span class="token string">"polygon"</span><span class="token punctuation">:</span>
                target <span class="token operator">=</span> self<span class="token punctuation">.</span>_load_json<span class="token punctuation">(</span>self<span class="token punctuation">.</span>targets<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                target <span class="token operator">=</span> imageio<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>self<span class="token punctuation">.</span>targets<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
            targets<span class="token punctuation">.</span>append<span class="token punctuation">(</span>target<span class="token punctuation">)</span>

        target <span class="token operator">=</span> <span class="token builtin">tuple</span><span class="token punctuation">(</span>targets<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>targets<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token keyword">else</span> targets<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment"># 针对多目标 可不关注</span>
        h<span class="token punctuation">,</span> w<span class="token punctuation">,</span> _ <span class="token operator">=</span> img<span class="token punctuation">.</span>shape
        top <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> h <span class="token operator">-</span> self<span class="token punctuation">.</span>new_h<span class="token punctuation">)</span>
        left <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> w <span class="token operator">-</span> self<span class="token punctuation">.</span>new_w<span class="token punctuation">)</span>
        img <span class="token operator">=</span> img<span class="token punctuation">[</span>top<span class="token punctuation">:</span>top <span class="token operator">+</span> self<span class="token punctuation">.</span>new_h<span class="token punctuation">,</span> left<span class="token punctuation">:</span>left <span class="token operator">+</span> self<span class="token punctuation">.</span>new_w<span class="token punctuation">]</span>
        label <span class="token operator">=</span> target<span class="token punctuation">[</span>top<span class="token punctuation">:</span>top <span class="token operator">+</span> self<span class="token punctuation">.</span>new_h<span class="token punctuation">,</span> left<span class="token punctuation">:</span>left <span class="token operator">+</span> self<span class="token punctuation">.</span>new_w<span class="token punctuation">]</span>

        <span class="token comment"># reduce mean</span>
        img <span class="token operator">=</span> img<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token comment"># switch to BGR</span>
        img <span class="token operator">=</span> np<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">255.</span>
        img<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-=</span> self<span class="token punctuation">.</span>means<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        img<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-=</span> self<span class="token punctuation">.</span>means<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        img<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-=</span> self<span class="token punctuation">.</span>means<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>

        <span class="token comment"># convert to tensor</span>
        img <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>img<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        label <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>label<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># create one-hot encoding</span>
        h<span class="token punctuation">,</span> w <span class="token operator">=</span> label<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span>
        target <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>self<span class="token punctuation">.</span>n_class<span class="token punctuation">,</span> h<span class="token punctuation">,</span> w<span class="token punctuation">)</span>
        <span class="token keyword">for</span> c <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>n_class<span class="token punctuation">)</span><span class="token punctuation">:</span>
            target<span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">[</span>label <span class="token operator">==</span> c<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>

        sample <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'X'</span><span class="token punctuation">:</span> img<span class="token punctuation">,</span> <span class="token string">'Y'</span><span class="token punctuation">:</span> target<span class="token punctuation">,</span> <span class="token string">'l'</span><span class="token punctuation">:</span> label<span class="token punctuation">}</span>

        <span class="token keyword">return</span> sample

    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">int</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>images<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">_get_target_suffix</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> mode<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> target_type<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> target_type <span class="token operator">==</span> <span class="token string">"instance"</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>mode<span class="token punctuation">}</span></span><span class="token string">_instanceIds.png"</span></span>
        <span class="token keyword">elif</span> target_type <span class="token operator">==</span> <span class="token string">"semantic"</span><span class="token punctuation">:</span> <span class="token comment"># 让其指向预处理好的target图片</span>
            <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>mode<span class="token punctuation">}</span></span><span class="token string">_labelTrainIds.png"</span></span>
        <span class="token keyword">elif</span> target_type <span class="token operator">==</span> <span class="token string">"color"</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>mode<span class="token punctuation">}</span></span><span class="token string">_color.png"</span></span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>mode<span class="token punctuation">}</span></span><span class="token string">_polygons.json"</span></span>


n_class <span class="token operator">=</span> <span class="token number">20</span>
batch_size <span class="token operator">=</span> <span class="token number">2</span> <span class="token comment"># 根据测试，1batch需要2G显存，请按实际设置</span>
epochs <span class="token operator">=</span> <span class="token number">500</span>
lr <span class="token operator">=</span> <span class="token number">1e-4</span>
momentum <span class="token operator">=</span> <span class="token number">0</span>
w_decay <span class="token operator">=</span> <span class="token number">1e-5</span>
step_size <span class="token operator">=</span> <span class="token number">50</span>
gamma <span class="token operator">=</span> <span class="token number">0.5</span>
configs <span class="token operator">=</span> <span class="token string">"FCNs-BCEWithLogits_batch{}_epoch{}_RMSprop_scheduler-step{}-gamma{}_lr{}_momentum{}_w_decay{}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
    batch_size<span class="token punctuation">,</span> epochs<span class="token punctuation">,</span> step_size<span class="token punctuation">,</span> gamma<span class="token punctuation">,</span> lr<span class="token punctuation">,</span> momentum<span class="token punctuation">,</span> w_decay<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Configs:"</span><span class="token punctuation">,</span> configs<span class="token punctuation">)</span>

<span class="token comment"># create dir for model</span>
model_dir <span class="token operator">=</span> <span class="token string">"models"</span>
<span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>model_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>
    os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>model_dir<span class="token punctuation">)</span>
model_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>model_dir<span class="token punctuation">,</span> configs<span class="token punctuation">)</span>

use_gpu <span class="token operator">=</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span>
num_gpu <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>device_count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 自行更改root</span>
train_data <span class="token operator">=</span> CityScapesDataset<span class="token punctuation">(</span>root<span class="token operator">=</span><span class="token string">'E:/datasets/CityScapes'</span><span class="token punctuation">,</span> split<span class="token operator">=</span><span class="token string">'train'</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'fine'</span><span class="token punctuation">,</span>
                               target_type<span class="token operator">=</span><span class="token string">'semantic'</span><span class="token punctuation">)</span>

train_loader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>train_data<span class="token punctuation">,</span> batch_size<span class="token operator">=</span>batch_size<span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

val_data <span class="token operator">=</span> CityScapesDataset<span class="token punctuation">(</span>root<span class="token operator">=</span><span class="token string">'E:/datasets/CityScapes'</span><span class="token punctuation">,</span> split<span class="token operator">=</span><span class="token string">'val'</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'fine'</span><span class="token punctuation">,</span>
                             target_type<span class="token operator">=</span><span class="token string">'semantic'</span><span class="token punctuation">)</span>

val_loader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>val_data<span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

vgg_model <span class="token operator">=</span> VGGNet<span class="token punctuation">(</span>requires_grad<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> remove_fc<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
fcn_model <span class="token operator">=</span> FCNs<span class="token punctuation">(</span>pretrained_net<span class="token operator">=</span>vgg_model<span class="token punctuation">,</span> n_class<span class="token operator">=</span>n_class<span class="token punctuation">)</span>

<span class="token keyword">if</span> use_gpu<span class="token punctuation">:</span>
    ts <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    vgg_model <span class="token operator">=</span> vgg_model<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>
    fcn_model <span class="token operator">=</span> fcn_model<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>
    fcn_model <span class="token operator">=</span> nn<span class="token punctuation">.</span>DataParallel<span class="token punctuation">(</span>fcn_model<span class="token punctuation">,</span> device_ids<span class="token operator">=</span>num_gpu<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Finish cuda loading, time elapsed {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> ts<span class="token punctuation">)</span><span class="token punctuation">)</span>

criterion <span class="token operator">=</span> nn<span class="token punctuation">.</span>BCEWithLogitsLoss<span class="token punctuation">(</span><span class="token punctuation">)</span>
optimizer <span class="token operator">=</span> optim<span class="token punctuation">.</span>RMSprop<span class="token punctuation">(</span>fcn_model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span>lr<span class="token punctuation">,</span> momentum<span class="token operator">=</span>momentum<span class="token punctuation">,</span> weight_decay<span class="token operator">=</span>w_decay<span class="token punctuation">)</span>
scheduler <span class="token operator">=</span> lr_scheduler<span class="token punctuation">.</span>StepLR<span class="token punctuation">(</span>optimizer<span class="token punctuation">,</span> step_size<span class="token operator">=</span>step_size<span class="token punctuation">,</span>
                                gamma<span class="token operator">=</span>gamma<span class="token punctuation">)</span>  <span class="token comment"># decay LR by a factor of 0.5 every 30 epochs</span>

<span class="token comment"># create dir for score</span>
score_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">"scores"</span><span class="token punctuation">,</span> configs<span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>score_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>
    os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>score_dir<span class="token punctuation">)</span>
IU_scores <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>epochs<span class="token punctuation">,</span> n_class<span class="token punctuation">)</span><span class="token punctuation">)</span>
pixel_scores <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>epochs<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        scheduler<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>

        ts <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> <span class="token builtin">iter</span><span class="token punctuation">,</span> batch <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>tqdm<span class="token punctuation">(</span>train_loader<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token keyword">if</span> use_gpu<span class="token punctuation">:</span>
                inputs <span class="token operator">=</span> Variable<span class="token punctuation">(</span>batch<span class="token punctuation">[</span><span class="token string">'X'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                labels <span class="token operator">=</span> Variable<span class="token punctuation">(</span>batch<span class="token punctuation">[</span><span class="token string">'Y'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                inputs<span class="token punctuation">,</span> labels <span class="token operator">=</span> Variable<span class="token punctuation">(</span>batch<span class="token punctuation">[</span><span class="token string">'X'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Variable<span class="token punctuation">(</span>batch<span class="token punctuation">[</span><span class="token string">'Y'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

            outputs <span class="token operator">=</span> fcn_model<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span>
            loss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> labels<span class="token punctuation">)</span>
            loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
            optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token keyword">if</span> <span class="token builtin">iter</span> <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"epoch{}, iter{}, loss: {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>epoch<span class="token punctuation">,</span> <span class="token builtin">iter</span><span class="token punctuation">,</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Finish epoch {}, time elapsed {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>epoch<span class="token punctuation">,</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> ts<span class="token punctuation">)</span><span class="token punctuation">)</span>
        torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>fcn_model<span class="token punctuation">,</span> model_path<span class="token punctuation">)</span>
        val<span class="token punctuation">(</span>epoch<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">val</span><span class="token punctuation">(</span>epoch<span class="token punctuation">)</span><span class="token punctuation">:</span>
    fcn_model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    total_ious <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    pixel_accs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> <span class="token builtin">iter</span><span class="token punctuation">,</span> batch <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>val_loader<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> use_gpu<span class="token punctuation">:</span>
            inputs <span class="token operator">=</span> Variable<span class="token punctuation">(</span>batch<span class="token punctuation">[</span><span class="token string">'X'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            inputs <span class="token operator">=</span> Variable<span class="token punctuation">(</span>batch<span class="token punctuation">[</span><span class="token string">'X'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        output <span class="token operator">=</span> fcn_model<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span>
        output <span class="token operator">=</span> output<span class="token punctuation">.</span>data<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>

        N<span class="token punctuation">,</span> _<span class="token punctuation">,</span> h<span class="token punctuation">,</span> w <span class="token operator">=</span> output<span class="token punctuation">.</span>shape
        pred <span class="token operator">=</span> output<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> n_class<span class="token punctuation">)</span><span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>N<span class="token punctuation">,</span> h<span class="token punctuation">,</span> w<span class="token punctuation">)</span>

        target <span class="token operator">=</span> batch<span class="token punctuation">[</span><span class="token string">'l'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>N<span class="token punctuation">,</span> h<span class="token punctuation">,</span> w<span class="token punctuation">)</span>
        <span class="token keyword">for</span> p<span class="token punctuation">,</span> t <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">:</span>
            total_ious<span class="token punctuation">.</span>append<span class="token punctuation">(</span>iou<span class="token punctuation">(</span>p<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">)</span>
            pixel_accs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>pixel_acc<span class="token punctuation">(</span>p<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># Calculate average IoU</span>
    total_ious <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>total_ious<span class="token punctuation">)</span><span class="token punctuation">.</span>T  <span class="token comment"># n_class * val_len</span>
    ious <span class="token operator">=</span> np<span class="token punctuation">.</span>nanmean<span class="token punctuation">(</span>total_ious<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    pixel_accs <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>pixel_accs<span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"epoch{}, pix_acc: {}, meanIoU: {}, IoUs: {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>epoch<span class="token punctuation">,</span> pixel_accs<span class="token punctuation">,</span> np<span class="token punctuation">.</span>nanmean<span class="token punctuation">(</span>ious<span class="token punctuation">)</span><span class="token punctuation">,</span> ious<span class="token punctuation">)</span><span class="token punctuation">)</span>
    IU_scores<span class="token punctuation">[</span>epoch<span class="token punctuation">]</span> <span class="token operator">=</span> ious
    np<span class="token punctuation">.</span>save<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>score_dir<span class="token punctuation">,</span> <span class="token string">"meanIU"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> IU_scores<span class="token punctuation">)</span>
    pixel_scores<span class="token punctuation">[</span>epoch<span class="token punctuation">]</span> <span class="token operator">=</span> pixel_accs
    np<span class="token punctuation">.</span>save<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>score_dir<span class="token punctuation">,</span> <span class="token string">"meanPixel"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pixel_scores<span class="token punctuation">)</span>


<span class="token comment"># borrow functions and modify it from https://github.com/Kaixhin/FCN-semantic-segmentation/blob/master/main.py</span>
<span class="token comment"># Calculates class intersections over unions</span>
<span class="token keyword">def</span> <span class="token function">iou</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ious <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> cls <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n_class<span class="token punctuation">)</span><span class="token punctuation">:</span>
        pred_inds <span class="token operator">=</span> pred <span class="token operator">==</span> cls
        target_inds <span class="token operator">=</span> target <span class="token operator">==</span> cls
        intersection <span class="token operator">=</span> pred_inds<span class="token punctuation">[</span>target_inds<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        union <span class="token operator">=</span> pred_inds<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> target_inds<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> intersection
        <span class="token keyword">if</span> union <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            ious<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">'nan'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># if there is no ground truth, do not include in evaluation</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            ious<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">(</span>intersection<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">max</span><span class="token punctuation">(</span>union<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># print("cls", cls, pred_inds.sum(), target_inds.sum(), intersection, float(intersection) / max(union, 1))</span>
    <span class="token keyword">return</span> ious


<span class="token keyword">def</span> <span class="token function">pixel_acc</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">:</span>
    correct <span class="token operator">=</span> <span class="token punctuation">(</span>pred <span class="token operator">==</span> target<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    total <span class="token operator">=</span> <span class="token punctuation">(</span>target <span class="token operator">==</span> target<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> correct <span class="token operator">/</span> total


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    val<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># show the accuracy before training</span>
    train<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<h3><a id="3_295"></a>3.运行结果</h3> 
<p><strong>分别在自己办公电脑1030显卡（显存4G）和3060显卡（显存12G）上测试，根据两台电脑运行上看每增加1batch就需要消耗2G显存，因为3060上最大只能将batch size设置为6。3060显卡上1个epoch需要8min，也就是说训练完500epoch需要三天时间，可见图像分割真的是极其消耗资源。而1030上1代竟然耗时2h20min，所以按照时间来看首选设备是3090，这样才可能在一天之内进行完一次完整500epoch训练。</strong><br> <img src="https://images2.imgbox.com/27/e0/lYGt7SYY_o.png" alt="在这里插入图片描述"><br> <strong>第1轮迭代后pixel accuracy就有75%，目前到第25轮pixel accuracy达到85%，随着epoch数增加，pixel acc也越来越高，希望其最终能突破90%，原论文中可是达到96%pixel准确率。</strong><br> <img src="https://images2.imgbox.com/61/56/upxIWbmm_o.png" alt="在这里插入图片描述"><br> <strong>下图为3060上训练150epoch的结果，每5epoch进行一次val评估。最后使用matplotlib绘制如下曲线，pixel_acc和meanIoU的获取请读者自行额外编写代码获得，此处仅提供绘图代码。<br> 第135epoch取得最高pixel accuracy=0.8766716842651368，meanIoU=0.3268041800950261</strong><br> <img src="https://images2.imgbox.com/b1/5b/edfAZVzu_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> matplotlib <span class="token keyword">import</span> pyplot <span class="token keyword">as</span> plt

x<span class="token operator">=</span><span class="token punctuation">[</span>i <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">151</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token comment">#横坐标</span>
<span class="token comment"># 此处给出我的数据，浮点数都用round函数取到小数点后7位</span>
pix_acc_list<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.7520696</span><span class="token punctuation">,</span><span class="token number">0.7918097</span><span class="token punctuation">,</span><span class="token number">0.6557526</span><span class="token punctuation">,</span><span class="token number">0.8310604</span><span class="token punctuation">,</span><span class="token number">0.8453417</span><span class="token punctuation">,</span><span class="token number">0.8509236</span><span class="token punctuation">,</span><span class="token number">0.8534471</span><span class="token punctuation">,</span><span class="token number">0.8378322</span><span class="token punctuation">,</span><span class="token number">0.8489639</span><span class="token punctuation">,</span><span class="token number">0.8563263</span><span class="token punctuation">,</span><span class="token number">0.8538324</span><span class="token punctuation">,</span><span class="token number">0.8572157</span><span class="token punctuation">,</span><span class="token number">0.860767</span><span class="token punctuation">,</span><span class="token number">0.8660216</span><span class="token punctuation">,</span><span class="token number">0.8631711</span><span class="token punctuation">,</span><span class="token number">0.8631837</span><span class="token punctuation">,</span><span class="token number">0.8670352</span><span class="token punctuation">,</span><span class="token number">0.8597714</span><span class="token punctuation">,</span><span class="token number">0.8689239</span><span class="token punctuation">,</span><span class="token number">0.8647407</span><span class="token punctuation">,</span><span class="token number">0.8698506</span><span class="token punctuation">,</span><span class="token number">0.8712046</span><span class="token punctuation">,</span><span class="token number">0.8719427</span><span class="token punctuation">,</span><span class="token number">0.8722804</span><span class="token punctuation">,</span><span class="token number">0.8732114</span><span class="token punctuation">,</span><span class="token number">0.871852</span><span class="token punctuation">,</span><span class="token number">0.8714358</span><span class="token punctuation">,</span><span class="token number">0.8766717</span><span class="token punctuation">,</span><span class="token number">0.86854</span><span class="token punctuation">,</span><span class="token number">0.8661136</span><span class="token punctuation">,</span><span class="token number">0.8761132</span><span class="token punctuation">]</span>
meanIoU_list<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.1333057</span><span class="token punctuation">,</span><span class="token number">0.185366</span><span class="token punctuation">,</span><span class="token number">0.1383637</span><span class="token punctuation">,</span><span class="token number">0.2432535</span><span class="token punctuation">,</span><span class="token number">0.2634509</span><span class="token punctuation">,</span><span class="token number">0.2799635</span><span class="token punctuation">,</span><span class="token number">0.2831553</span><span class="token punctuation">,</span><span class="token number">0.2642947</span><span class="token punctuation">,</span><span class="token number">0.2924905</span><span class="token punctuation">,</span><span class="token number">0.3027259</span><span class="token punctuation">,</span><span class="token number">0.3123738</span><span class="token punctuation">,</span><span class="token number">0.2976701</span><span class="token punctuation">,</span><span class="token number">0.3113799</span><span class="token punctuation">,</span><span class="token number">0.3239229</span><span class="token punctuation">,</span><span class="token number">0.3163488</span><span class="token punctuation">,</span><span class="token number">0.3170467</span><span class="token punctuation">,</span><span class="token number">0.3246953</span><span class="token punctuation">,</span><span class="token number">0.3236825</span><span class="token punctuation">,</span><span class="token number">0.3242375</span><span class="token punctuation">,</span><span class="token number">0.3262411</span><span class="token punctuation">,</span><span class="token number">0.3355112</span><span class="token punctuation">,</span><span class="token number">0.3285704</span><span class="token punctuation">,</span><span class="token number">0.3388148</span><span class="token punctuation">,</span><span class="token number">0.328427</span><span class="token punctuation">,</span><span class="token number">0.3378653</span><span class="token punctuation">,</span><span class="token number">0.3385619</span><span class="token punctuation">,</span><span class="token number">0.3358321</span><span class="token punctuation">,</span><span class="token number">0.3268042</span><span class="token punctuation">,</span><span class="token number">0.3297385</span><span class="token punctuation">,</span><span class="token number">0.3347885</span><span class="token punctuation">,</span><span class="token number">0.3379351</span><span class="token punctuation">]</span>
plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span>pix_acc_list<span class="token punctuation">,</span>color<span class="token operator">=</span><span class="token string">'blue'</span><span class="token punctuation">,</span>label<span class="token operator">=</span><span class="token string">'pixel acc'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span>meanIoU_list<span class="token punctuation">,</span>color<span class="token operator">=</span><span class="token string">'red'</span><span class="token punctuation">,</span>label<span class="token operator">=</span><span class="token string">'meanIoU'</span><span class="token punctuation">)</span>

plt<span class="token punctuation">.</span>xticks<span class="token punctuation">(</span>fontsize<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>yticks<span class="token punctuation">(</span>fontsize<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">)</span>

plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">'Epoch'</span><span class="token punctuation">,</span>fontsize<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">'Score'</span><span class="token punctuation">,</span>fontsize<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span>fontsize<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<hr> 
<h2><a id="_326"></a>总结</h2> 
<p>希望您读到这里能有所收获，本文所参考资料也在文末给出，大家可以查阅获取更多知识细节，后续还将不断完善本文内容，敬请期待……</p> 
<hr> 
<h2><a id="_330"></a>参考网站</h2> 
<p>https://bbs.huaweicloud.com/blogs/306716<br> https://developer.aliyun.com/article/797607<br> https://www.cnblogs.com/dotman/p/cityscapes_dataset_tips.html<br> https://zhuanlan.zhihu.com/p/147195575<br> https://codeantenna.com/a/uD5sJceaS1<br> https://blog.csdn.net/zz2230633069/article/details/84591532<br> https://www.zhihu.com/question/276325769/answer/2418207657<br> https://blog.csdn.net/zz2230633069/article/details/84668984<br> https://blog.csdn.net/yumaomi/article/details/124847721</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/554a16c685a3740772c73b3a467817df/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">弹出框移动、放大、缩小、最大化处理</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/dc8babaed68d39ba943b1d224f89a578/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">三，Git 分支</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>