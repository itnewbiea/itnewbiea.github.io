<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>MyBatis二级缓存 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="MyBatis二级缓存" />
<meta property="og:description" content="Mybatis中一级缓存 和 二级缓存的区别 两者区别：一级缓存的作用域是在SqlSession中，二级缓存的作用域是针对mapper做缓存。
一级缓存(本地缓存) 一级缓存是框架默认为我们开启的，我们不需要做任何配置。
例如我们首次查询id为1的用户，mybatis会将该用户的对象存储在一级缓存中；
如果在此中间 sqlSession 执行了commit操作(增删改) ，则mybatis会清空一级缓存的数据 ，这样就能让我们的数据是最新的，避免产生脏读。
当我们再次查 id 为 1 的用户时，mybatis就会去缓存中查找，就不需要再从数据库中去查询。
mybatis一级缓存是默认开启的，是SqlSession级别的缓存，在操作数据库的时候需要创建一个SqlSession，其中有一个HashMap，用于存储缓存数据。不同的SqlSession之间，其缓存数据的HashMap是不同的；
所以当我们多次调用同一个Mapper和同一个方法的同一个参数，只会进行一次数据库查询，然后把数据缓存到缓冲中，以后直接先从缓存中取出数据，不会直接去查数据库。但是不同的SqlSession对象，因为不同的SqlSession都是相互隔离的，所以相同的Mapper、参数和方法，他还是会再次发送到SQL到数据库去执行，返回结果。所以我们需要根据需求开启二级缓存
二级缓存(全局缓存) 二级缓存是 mapper 级别的缓存，多个sqlSession去操作同一个Mapper的sql，不管Sqlsession 是否相同，只要 mapper 的 namespace相同就能共享数据。也可以称之为 namespace 级别的缓存 。
sqlSession 关闭后(close) ，一级缓存的数据会保存到二级缓存中，新的相同的查询语句就会去二级缓存中去查询。
二级缓存是Mapper级别的缓存，多个SqlSession去操作同一个Mapper中的SQL语句，则这些SqlSession可以共享二级缓存，即二级缓存是跨SqlSession的。
二级缓存开启 1，xml 配置中开启 二级缓存
&lt;settings&gt; &lt;!-- 开启二级缓存（默认是开的，这里写出来是为了方便代码维护） --&gt; &lt;setting name=&#34;cacheEnabled&#34; value=&#34;true&#34; /&gt; &lt;/settings&gt; 2，去mapper映射文件中使用二级缓存
&lt;!-- 开启本mapper所在namespace的二级缓存 --&gt; &lt;cache /&gt; 3，需要将要存储数据的 pojo 实现 Serializable接口，为了将数据取出做反序列化操作， 因为二级的缓存的存储方式多种多样，有可能存储在内存中，也可能储存到磁盘中。如果我们要再取这个缓存的话，就需要反序列化了。所以建议mybatis中的pojo都去实现Serializable接口。
mybatis解读 1、开启缓存的弊端是数据没有实时性，当数据库中的数据一旦修改，查询的数据还是缓存中的数据没有实时性，对于某些需要实时性显示数据的接口我们可以设置 useCache=“false” ,设置该属性后，该接口每次查询出来都是去执行sql查询出实时性数据。如：
&lt;select id=&#34;findArtPageview&#34; parameterType=&#34;com.Article&#34; resultType=&#34;int&#34; useCache=&#34;false&#34;&gt; select pageview from article where aid=#{aid} &lt;/select&gt; 设置useCache=false可以禁用当前select语句的二级缓存，即每次查询都会发出sql去查询，默认情况是true，即该sql使用二级缓存。所以：针对每次查询都需要最新的数据sql，要设置成useCache=false，禁用二级缓存。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/cbe71a0b6d0f4e5d10ce4050b5c81944/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-07T11:59:34+08:00" />
<meta property="article:modified_time" content="2023-05-07T11:59:34+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">MyBatis二级缓存</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="Mybatis___1"></a>Mybatis中一级缓存 和 二级缓存的区别</h3> 
<p>两者区别：一级缓存的作用域是在SqlSession中，二级缓存的作用域是针对mapper做缓存。</p> 
<h4><a id="_5"></a>一级缓存(本地缓存)</h4> 
<p>一级缓存是框架默认为我们开启的，我们不需要做任何配置。<br> 例如我们首次查询id为1的用户，mybatis会将该用户的对象存储在一级缓存中；<br> 如果在此中间 sqlSession 执行了commit操作(增删改) ，则mybatis会清空一级缓存的数据 ，这样就能让我们的数据是最新的，避免产生脏读。<br> 当我们再次查 id 为 1 的用户时，mybatis就会去缓存中查找，就不需要再从数据库中去查询。</p> 
<p>mybatis一级缓存是默认开启的，是SqlSession级别的缓存，在操作数据库的时候需要创建一个SqlSession，其中有一个HashMap，用于存储缓存数据。不同的SqlSession之间，其缓存数据的HashMap是不同的；</p> 
<p>所以当我们多次调用同一个Mapper和同一个方法的同一个参数，只会进行一次数据库查询，然后把数据缓存到缓冲中，以后直接先从缓存中取出数据，不会直接去查数据库。但是不同的SqlSession对象，因为不同的SqlSession都是相互隔离的，所以相同的Mapper、参数和方法，他还是会再次发送到SQL到数据库去执行，返回结果。所以我们需要根据需求开启二级缓存</p> 
<h4><a id="_16"></a>二级缓存(全局缓存)</h4> 
<p>二级缓存是 mapper 级别的缓存，多个sqlSession去操作同一个Mapper的sql，不管Sqlsession 是否相同，只要 mapper 的 namespace相同就能共享数据。也可以称之为 namespace 级别的缓存 。</p> 
<p>sqlSession 关闭后(close) ，一级缓存的数据会保存到二级缓存中，新的相同的查询语句就会去二级缓存中去查询。</p> 
<p>二级缓存是Mapper级别的缓存，多个SqlSession去操作同一个Mapper中的SQL语句，则这些SqlSession可以共享二级缓存，即二级缓存是跨SqlSession的。</p> 
<h3><a id="_24"></a>二级缓存开启</h3> 
<p>1，xml 配置中开启 二级缓存</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>settings</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 开启二级缓存（默认是开的，这里写出来是为了方便代码维护） --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>setting</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cacheEnabled<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>settings</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>2，去mapper映射文件中使用二级缓存</p> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!-- 开启本mapper所在namespace的二级缓存 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>cache</span> <span class="token punctuation">/&gt;</span></span>
</code></pre> 
<p>3，需要将要存储数据的 pojo 实现 Serializable接口，为了将数据取出做反序列化操作， 因为二级的缓存的存储方式多种多样，有可能存储在内存中，也可能储存到磁盘中。如果我们要再取这个缓存的话，就需要反序列化了。所以建议mybatis中的pojo都去实现Serializable接口。</p> 
<h2><a id="mybatis_44"></a>mybatis解读</h2> 
<p>1、开启缓存的弊端是数据没有实时性，当数据库中的数据一旦修改，查询的数据还是缓存中的数据没有实时性，对于某些需要实时性显示数据的接口我们可以设置 useCache=“false” ,设置该属性后，该接口每次查询出来都是去执行sql查询出实时性数据。如：</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>findArtPageview<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.Article<span class="token punctuation">"</span></span> <span class="token attr-name">resultType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>int<span class="token punctuation">"</span></span> <span class="token attr-name">useCache</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
select pageview from article where aid=#{aid}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>设置useCache=false可以禁用当前select语句的二级缓存，即每次查询都会发出sql去查询，默认情况是true，即该sql使用二级缓存。所以：针对每次查询都需要最新的数据sql，要设置成useCache=false，禁用二级缓存。</p> 
<p>2、清空缓存，一般下执行完commit操作都需要刷新缓存，flushCache=true表示刷新缓存，这样可以避免数据库脏读。但是如果你不想刷新缓存只需要这么做：</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>update</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>pageviewAdd<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.Goods<span class="token punctuation">"</span></span> <span class="token attr-name">flushCache</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  update goods set pageview=#{pageview} where gid=#{gid}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>update</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>将flushCache=true改为flushCache=false就不用刷新了</p> 
<h3><a id="_66"></a>总结</h3> 
<p>1、当为select语句时：<br> flushCache默认为false，表示任何时候语句被调用，都不会去清空本地缓存和二级缓存。<br> useCache默认为true，表示会将本条语句的结果进行二级缓存。</p> 
<p>2、当为insert、update、delete语句时：<br> flushCache默认为true，表示任何时候语句被调用，都会导致本地缓存和二级缓存被清空。<br> useCache属性在该情况下没有。</p> 
<p>当为select语句的时候，如果没有去配置flushCache、useCache，那么默认是启用缓存的，所以，如果有必要，那么就需要人工修改配置。</p> 
<hr> 
<hr> 
<hr> 
<h3><a id="1_84"></a>1、二级缓存</h3> 
<p>​ 二级缓存的原理和一级缓存原理一样，第一次查询，会将数据放入缓存中，然后第二次查询则会直接去缓存中取。但是一级缓存是基于sqlSession的，而二级缓存是基于mapper文件的namespace的，也就是说多个sqlSession可以共享一个mapper中的二级缓存区域，并且如果两个mapper的namespace 相同，即使是两个mapper,那么这两个mapper中执行sql查询到的数据也将存在相同的二级缓存区域中。</p> 
<p><img src="https://images2.imgbox.com/6e/ce/pcaUkNq5_o.png" alt="img"></p> 
<p>如何使用二级缓存</p> 
<h4><a id="11_92"></a>1.1、开启二级缓存</h4> 
<p>​ 和一级缓存默认开启不一样，二级缓存需要我们手动开启首先在全局配置文件sqlMapConfig.xml文件中加入如下代码</p> 
<pre><code class="prism language-c"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>开启二级缓存<span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>settings<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>setting name<span class="token operator">=</span><span class="token string">"cacheEnabled"</span> value<span class="token operator">=</span><span class="token string">"true"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>settings<span class="token operator">&gt;</span>
</code></pre> 
<p>​ 其次在UserMapper.xml文件中开启缓存（如果我们是基于注解形式进行查询，可以在mapper查询接口上添加**@CacheNamespace**注解开启二级缓存）</p> 
<pre><code class="prism language-c">方式一：在xml文件中配置
 <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>开启二级缓存<span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>cache<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>cache<span class="token operator">&gt;</span>

方式二：在mapper接口上添加上
@CacheNamespace

后面可以带参数指定加载自定义的缓存实现类
@<span class="token function">CacheNamespace</span><span class="token punctuation">(</span>implementation <span class="token operator">=</span> RedisCache<span class="token punctuation">.</span>class<span class="token punctuation">)</span><span class="token comment">//开启二级缓存</span>
</code></pre> 
<p>​ 我们可以看到mapper.xml文件中就这么一个空标签，其实这里可以配置,PerpetualCache这个类是mybatis默认实现缓存功能的类。我们不写type就使用mybatis默认的缓存，也可以去实现Cache接口来自定义缓存。</p> 
<p><img src="https://images2.imgbox.com/42/df/t5okuXoo_o.png" alt="img"></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PerpetualCache</span> <span class="token keyword">implements</span> <span class="token class-name">Cache</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">MapcObject</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token operator">&gt;</span> cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMapC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">PerpetualCache</span><span class="token punctuation">(</span><span class="token class-name">St</span> ring id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>我们可以看到二级缓存底层还是HashMap结构</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span><span class="token punctuation">(</span>
    <span class="token comment">//⽤户ID</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> id<span class="token punctuation">;</span>
    <span class="token comment">//⽤户姓名</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span>
    <span class="token comment">//⽤户性别</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> sex<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>注意：</strong></p> 
<p>​ 开启了二级缓存后，还需要将要缓存的pojo实现<strong>Serializable</strong>接口，为了将缓存数据取出执行反序列化操作，因为二级缓存数据存储介质多种多样，不一定只存在内存中，有可能存在硬盘中，如果我们要再取这个缓存的话，就需要反序列化了。所以mybatis中的pojo都去实现Serializable接口。</p> 
<h4><a id="12_146"></a>1.2、测试</h4> 
<p><strong>1.2.1、测试?级缓存和sqlSession无关</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testTwoCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">//根据 sqlSessionFactory 产⽣ session</span>
    <span class="token class-name">SqlSession</span> sqlSession1 <span class="token operator">=</span> sessionFactory<span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SqlSession</span> sqlSession2 <span class="token operator">=</span> sessionFactory<span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">UserMapper</span> userMapper1 <span class="token operator">=</span> sqlSession1<span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span><span class="token class-name">UserMapper</span><span class="token punctuation">.</span> <span class="token keyword">class</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">UserMapper</span> userMapper2 <span class="token operator">=</span> sqlSession2<span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span><span class="token class-name">UserMapper</span><span class="token punctuation">.</span> <span class="token keyword">class</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//第⼀次查询，发出sql语句，并将查询的结果放⼊缓存中</span>
    <span class="token class-name">User</span> u1 <span class="token operator">=</span> userMapper1<span class="token punctuation">.</span><span class="token function">selectUserByUserId</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>u1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sqlSession1<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//第⼀次查询完后关闭 sqlSession ,sqlsession关闭后就会清除一级缓存</span>
    <span class="token comment">//第⼆次查询，即使sqlSession1已经关闭了，这次查询依然不发出sql语句</span>
    <span class="token class-name">User</span> u2 <span class="token operator">=</span> userMapper2<span class="token punctuation">.</span><span class="token function">selectUserByUserId</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>u2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sqlSession2<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>可以看出上面两个不同的sqlSession,第一个关闭了，第二次查询依然不发出sql查询语句<br> <strong>1.2.2、测试执行*<em>commit*</em>()操作，二级缓存数据清空</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testTwoCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">//根据 sqlSessionFactory 产⽣ session</span>
    <span class="token class-name">SqlSession</span> sqlSession1 <span class="token operator">=</span> sessionFactory<span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SqlSession</span> sqlSession2 <span class="token operator">=</span> sessionFactory<span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SqlSession</span> sqlSession3 <span class="token operator">=</span> sessionFactory<span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> statement <span class="token operator">=</span> <span class="token string">"com.lagou.pojo.UserMapper.selectUserByUserld"</span> <span class="token punctuation">;</span>
    <span class="token class-name">UserMapper</span> userMapper1 <span class="token operator">=</span> sqlSession1<span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span><span class="token class-name">UserMapper</span><span class="token punctuation">.</span> <span class="token keyword">class</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">UserMapper</span> userMapper2 <span class="token operator">=</span> sqlSession2<span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span><span class="token class-name">UserMapper</span><span class="token punctuation">.</span> <span class="token keyword">class</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">UserMapper</span> userMapper3 <span class="token operator">=</span> sqlSession2<span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span><span class="token class-name">UserMapper</span><span class="token punctuation">.</span> <span class="token keyword">class</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//第⼀次查询，发出sql语句，并将查询的结果放⼊缓存中</span>
    <span class="token class-name">User</span> u1 <span class="token operator">=</span> userMapperl<span class="token punctuation">.</span><span class="token function">selectUserByUserId</span><span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>u1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sqlSessionl <span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//第⼀次查询完后关闭sqlSession</span>
    <span class="token comment">//执⾏更新操作，commit()</span>
    u1<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span> <span class="token string">"aaa"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    userMapper3<span class="token punctuation">.</span><span class="token function">updateUserByUserId</span><span class="token punctuation">(</span>u1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sqlSession3<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token comment">//第⼆次查询，由于上次更新操作，缓存数据已经清空(防⽌数据脏读)，这⾥必须再次发出sql语</span>
    <span class="token class-name">User</span> u2 <span class="token operator">=</span> userMapper2<span class="token punctuation">.</span><span class="token function">selectUserByUserId</span><span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>u2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sqlSession2<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>查看控制台情况：</p> 
<p><img src="https://images2.imgbox.com/a2/01/hd3FLzjP_o.png" alt="img"></p> 
<h4><a id="13useCacheflushCache_203"></a><strong>1.3、useCache和flushCache</strong></h4> 
<p>​ mybatis中还可以配置<strong>userCache</strong>和<strong>flushCache</strong>等配置项，userCache是用来设置是否禁用二级缓 存的，在statement中设置<strong>useCache=false</strong>可以<strong>禁?当前select语句的二级缓存</strong>，即每次查询都会发出sql去查询，默认情况是true,即该sql使用二级缓存，还可以使用注解方式禁用@Options(useCache=false),flushCache的注解配置方法同上 。</p> 
<blockquote> 
 <p><strong>方法一：</strong></p> 
 <p>&lt;select id=“selectUserByUserId” <strong>useCache=“false”</strong><br> resultType=“com.lagou.pojo.User” parameterType=“int”&gt;<br> select * from user where id=#{id}<br> </p> 
 <p><strong>方法二：</strong></p> 
 <p><strong>@Options(useCache = false)</strong><br> @Select({“select * from user where id = #{id}”})<br> public User findUserById(Integer id);</p> 
</blockquote> 
<ul><li>这种情况是针对每次查询都需要最新的数据sql,要设置成<strong>useCache=false</strong>，禁用二级缓存，直接从数 据库中获取。</li><li>在mapper的同一个namespace中，如果有其它insert、update, delete操作数据后需要刷新缓 存，如果不执行刷新缓存会出现脏读。</li><li>设置statement配置中的**flushCache="true”**属性，默认情况下为true,即刷新缓存，如果改成false则 不会刷新。使用缓存时如果?动修改数据库表中的查询数据会出现脏读。</li></ul> 
<blockquote> 
 <p><strong>方法一：</strong></p> 
 <p>&lt;select id=“selectUserByUserId” <strong>flushCache=“true”</strong> useCache=“false”<br> resultType=“com.lagou.pojo.User” parameterType=“int”&gt;<br> select * from user where id=#{id}<br> </p> 
 <p><strong>方法二：</strong></p> 
 <p><strong>@Options({useCache = false,</strong> <strong>flushCache=“true”****})</strong><br> @Select({“select * from user where id = #{id}”})<br> public User findUserById(Integer id);</p> 
</blockquote> 
<p>​ 一般下执行完commit操作都需要刷新缓存，<strong>flushCache=true</strong>表示刷新缓存，这样可以避免数据库脏读。所以我们不用设置，<strong>默认即可</strong></p> 
<h3><a id="2redis_245"></a>2、二级缓存整合redis</h3> 
<p>​ 上面我们介绍了 mybatis自带的二级缓存，但是这个缓存是单服务器工作，无法实现分布式缓存。 那么什么是分布式缓存呢？假设现在有两个服务器1和2,用户访问的时候访问了 1服务器，查询后的缓存就会放在1服务器上，假设现在有个用户访问的是2服务器，那么他在2服务器上就无法获取刚刚那个缓存，如下图所示：</p> 
<p><img src="https://images2.imgbox.com/4f/54/nSlAmZHL_o.png" alt="img"></p> 
<p>​ 为了解决这个问题，就得找一个分布式的缓存，专门用来存储缓存数据的，这样不同的服务器要缓存数据都往它那里存，取缓存数据也从它那里取，如下图所示：</p> 
<p><img src="https://images2.imgbox.com/7f/6a/Fgv0ZTRr_o.png" alt="img"></p> 
<p>​ 如上图所示，在几个不同的服务器之间，我们使用第三方缓存框架，将缓存都放在这个第三方框架中,然后无论有多少台服务器，我们都能从缓存中获取数据。</p> 
<p>这里我们介绍mybatis与redis的整合。<br> 刚刚提到过，mybatis提供了一个eache接口，如果要实现自己的缓存逻辑，实现cache接口开发即可。mybatis本身默认实现了一个，但是这个缓存的实现无法实现分布式缓存，所以我们要自己来实现。redis分布式缓存就可以，mybatis提供了一个针对cache接口的redis实现类，该类存在mybatis-redis包中。</p> 
<p>实现：</p> 
<h4><a id="21pom_262"></a>2.1、pom文件</h4> 
<pre><code class="prism language-c"><span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>caches<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>mybatis<span class="token operator">-</span>redis<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token number">1.0</span><span class="token number">.0</span><span class="token operator">-</span>beta2<span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
</code></pre> 
<h4><a id="22_272"></a>2.2、配置文件</h4> 
<p>Mapper.xml</p> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">mapper</span> <span class="token name">PUBLIC</span> <span class="token string">"-//mybatis.org//DTD Mapper 3.0//EN"</span>
<span class="token string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span><span class="token punctuation">&gt;</span></span>
 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">namespace</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.lagou.mapper.IUserMapper<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>cache</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.mybatis.caches.redis.RedisCache<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span> 二级缓存类地址
 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>findAll<span class="token punctuation">"</span></span> <span class="token attr-name">resultType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.lagou.pojo.User<span class="token punctuation">"</span></span> <span class="token attr-name">useCache</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    select * from user
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span> 
</code></pre> 
<h4><a id="23redisproperties__290"></a>2.3、redis.properties （名字必须叫这个，不然无法获取到里面的数据）</h4> 
<blockquote> 
 <p>redis.host=localhost<br> redis.port=6379<br> redis.connectionTimeout=5000<br> redis.password=<br> redis.database=0</p> 
</blockquote> 
<h4><a id="24_298"></a>2.4、测试</h4> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name">SecondLevelCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">SqlSession</span> sqlSession1 <span class="token operator">=</span> sqlSessionFactory<span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SqlSession</span> sqlSession2 <span class="token operator">=</span> sqlSessionFactory<span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SqlSession</span> sqlSession3 <span class="token operator">=</span> sqlSessionFactory<span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">IUserMapper</span> mapper1 <span class="token operator">=</span> sqlSession1<span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span><span class="token class-name">IUserMapper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lUserMapper mapper2 <span class="token operator">=</span> sqlSession2<span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span>lUserMapper<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lUserMapper mapper3 <span class="token operator">=</span> sqlSession3<span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span><span class="token class-name">IUserMapper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">User</span> user1 <span class="token operator">=</span> mapper1<span class="token punctuation">.</span><span class="token function">findUserById</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sqlSession1<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//清空⼀级缓存</span>
    <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">"lisi"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mapper3<span class="token punctuation">.</span><span class="token function">updateUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sqlSession3<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">User</span> user2 <span class="token operator">=</span> mapper2<span class="token punctuation">.</span><span class="token function">findUserById</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>user1<span class="token operator">==</span>user2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="25_321"></a>2.5、源码分析</h4> 
<p>​ RedisCache和大家普遍实现Mybatis的缓存方案大同小异，无非是实现Cache接口，并使用jedis操作缓存；不过该项目在设计细节上有一些区别；</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">RedisCache</span> <span class="token keyword">implements</span> <span class="token class-name">Cache</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span> <span class="token class-name">RedisCache</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Cache instances require anID"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
    <span class="token class-name">RedisConfig</span> redisConfig <span class="token operator">=</span>
    <span class="token class-name">RedisConfigurationBuilder</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parseConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JedisPool</span><span class="token punctuation">(</span>redisConfig<span class="token punctuation">,</span> redisConfig<span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    redisConfig<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    redisConfig<span class="token punctuation">.</span><span class="token function">getConnectionTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    redisConfig<span class="token punctuation">.</span><span class="token function">getSoTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> redisConfig<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    redisConfig<span class="token punctuation">.</span><span class="token function">getDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> redisConfig<span class="token punctuation">.</span><span class="token function">getClientName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>​ RedisCache在mybatis启动的时候，由MyBatis的CacheBuilder创建，创建的方式很简单，就是调用RedisCache的带有String参数的构造方法，即RedisCache(String id)；而在RedisCache的构造方法中，调用了 RedisConfigu rationBuilder 来创建 RedisConfig 对象，并使用 RedisConfig 来创建JedisPool。</p> 
<p>RedisConfig类继承了 JedisPoolConfig，并提供了 host,port等属性的包装，简单看?下RedisConfig的属性：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisConfig</span> <span class="token keyword">extends</span> <span class="token class-name">JedisPoolConfig</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">private</span> <span class="token class-name">String</span> host <span class="token operator">=</span> <span class="token class-name">Protocol</span><span class="token punctuation">.</span>DEFAULT_HOST<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> port <span class="token operator">=</span> <span class="token class-name">Protocol</span><span class="token punctuation">.</span>DEFAULT_PORT<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> connectionTimeout <span class="token operator">=</span> <span class="token class-name">Protocol</span><span class="token punctuation">.</span>DEFAULT_TIMEOUT<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> soTimeout <span class="token operator">=</span> <span class="token class-name">Protocol</span><span class="token punctuation">.</span>DEFAULT_TIMEOUT<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> database <span class="token operator">=</span> <span class="token class-name">Protocol</span><span class="token punctuation">.</span>DEFAULT_DATABASE<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> clientName<span class="token punctuation">;</span>
</code></pre> 
<p>RedisConfig对象是由RedisConfigurationBuilder创建的，简单看下这个类的主要方法：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">RedisConfig</span> <span class="token function">parseConfiguration</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> classLoader<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Properties</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">InputStream</span> input <span class="token operator">=</span> classLoader<span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span>redisPropertiesFilename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>input <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            config<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
                 <span class="token string">"An error occurred while reading classpath property '"</span>
                  <span class="token operator">+</span> redisPropertiesFilename
                  <span class="token operator">+</span> <span class="token string">"', see nested exceptions"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            input<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// close quietly</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">RedisConfig</span> jedisConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setConfigProperties</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> jedisConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> jedisConfig<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>核心的方法就是parseConfiguration方法，该方法从classpath中读取一个redis.properties?件:</p> 
<pre><code class="prism language-cobol">host<span class="token operator">=</span>localhost
port<span class="token operator">=</span><span class="token number">6379</span>
connectionTimeout<span class="token operator">=</span><span class="token number">5000</span>
soTimeout<span class="token operator">=</span><span class="token number">5000</span>
password<span class="token operator">=</span> database<span class="token operator">=</span><span class="token number">0</span> clientName<span class="token operator">=</span>
</code></pre> 
<p>​ 并将该配置文件中的内容设置到RedisConfig对象中，并返回；接下来，就是RedisCache使用RedisConfig类创建完成edisPool；在RedisCache中实现了一个简单的模板方法，用来操作Redis：</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token class-name">Object</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">RedisCallback</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> callback<span class="token punctuation">.</span><span class="token function">doWithRedis</span><span class="token punctuation">(</span>jedis<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
    jedis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>模板接口为RedisCallback，这个接口中就只需要实现了一个doWithRedis方法而已：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">RedisCallback</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Object</span> <span class="token function">doWithRedis</span><span class="token punctuation">(</span><span class="token class-name">Jedis</span> jedis<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>​ 接下来看看Cache中最重要的两个方法：putObject和getObject，通过这两个方法来查看mybatis-redis储存数据的格式：</p> 
<pre><code class="prism language-java"> <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">putObject</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Object</span> key<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RedisCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">doWithRedis</span><span class="token punctuation">(</span><span class="token class-name">Jedis</span> jedis<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    jedis<span class="token punctuation">.</span><span class="token function">hset</span><span class="token punctuation">(</span>id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token class-name">SerializeUtil</span><span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RedisCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">doWithRedis</span><span class="token punctuation">(</span><span class="token class-name">Jedis</span> jedis<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> <span class="token class-name">SerializeUtil</span><span class="token punctuation">.</span><span class="token function">unserialize</span><span class="token punctuation">(</span>jedis<span class="token punctuation">.</span><span class="token function">hget</span><span class="token punctuation">(</span>id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            key<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

</code></pre> 
<p>​ 可以很清楚的看到，mybatis-redis在存储数据的时候，是使用的hash结构，把cache的id作为这个hash的key (cache的id在mybatis中就是mapper的namespace)；这个mapper中的查询缓存数据作为 hash的field,需要缓存的内容直接使用SerializeUtil存储，SerializeUtil和其他的序列化类差不多，负责对象的序列化和反序列化；</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6ddc06095ff919ee6a5ada1c6922db8b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">node项目连接mongodb删除多条数据</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/30dd7133b9289c505bc7dd45f180ac6b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【已解决】解锁小米6的时候,卡在当前未连接手机怎么办?</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>