<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>springboot整合mongodb批量修改和添加索引，与设置mongodb保存更新超时时间 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="springboot整合mongodb批量修改和添加索引，与设置mongodb保存更新超时时间" />
<meta property="og:description" content="1：创建字段索引 collection 是集合名称，keys 是一个包含一个或多个字段名，options是排序方向，1正序，-1倒叙 db.collection.createIndex(keys, options) #单字段 db.collection.createIndex(name: 1) #多字段 db.collection.createIndex{name: 1, age: -1} 2：mongodb批量修改 BulkOperations bulkOperations = mongoTemplate.bulkOps(BulkMode.UNORDERED, RealtimeEntity.class); updateList.forEach(realtimeEntity -&gt; { Query query = new Query(Criteria.where(&#34;pn&#34;).is(realtimeEntity.getPn())); Update update = new Update() .set(&#34;pnVal&#34;, realtimeEntity.getPnVal()) .set(&#34;tm&#34;, realtimeEntity.getTm()) .set(&#34;rm&#34;, realtimeEntity.getRm()); bulkOperations.updateOne(query, update); }); bulkOperations.execute(); 注意：必须创建索引这样更新的效率快 3：mongodb保存的时候最好设置一个保存超时时间，因为mongodb本身没有设置保存或者更新超时抛出异常 public void saveWithTimeout(Object objectToSave, String collectionName) { CompletableFuture&lt;Void&gt; completableFuture = new CompletableFuture&lt;&gt;(); mongoTemplate.insert(objectToSave, collectionName).addCallback( result -&gt; completableFuture.complete(null), ex -&gt; completableFuture.completeExceptionally(ex) ); try { completableFuture.get(10, TimeUnit." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/8e3bb6319517b2390b0c3de468d722c0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-05T21:32:01+08:00" />
<meta property="article:modified_time" content="2024-01-05T21:32:01+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">springboot整合mongodb批量修改和添加索引，与设置mongodb保存更新超时时间</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="font_colorred_1_0"></a><font color="red"> 1：创建字段索引</font></h3> 
<h4><a id="font_colorredcollection_keys_options11_1"></a><font color="red">collection 是集合名称，keys 是一个包含一个或多个字段名，options是排序方向，1正序，-1倒叙</font></h4> 
<pre><code class="prism language-sql">db<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>createIndex<span class="token punctuation">(</span><span class="token keyword">keys</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-sql"><span class="token comment">#单字段</span>
db<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>createIndex<span class="token punctuation">(</span>name: <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-sql"><span class="token comment">#多字段</span>
db<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>createIndex{name: <span class="token number">1</span><span class="token punctuation">,</span> age: <span class="token operator">-</span><span class="token number">1</span>}
</code></pre> 
<h3><a id="font_colorred_2mongodb_13"></a><font color="red"> 2：mongodb批量修改</font></h3> 
<pre><code class="prism language-java"><span class="token class-name">BulkOperations</span> bulkOperations <span class="token operator">=</span> mongoTemplate<span class="token punctuation">.</span><span class="token function">bulkOps</span><span class="token punctuation">(</span><span class="token class-name">BulkMode</span><span class="token punctuation">.</span><span class="token constant">UNORDERED</span><span class="token punctuation">,</span> <span class="token class-name">RealtimeEntity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

updateList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>realtimeEntity <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Query</span> query <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Query</span><span class="token punctuation">(</span><span class="token class-name">Criteria</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">"pn"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span>realtimeEntity<span class="token punctuation">.</span><span class="token function">getPn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Update</span> update <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"pnVal"</span><span class="token punctuation">,</span> realtimeEntity<span class="token punctuation">.</span><span class="token function">getPnVal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"tm"</span><span class="token punctuation">,</span> realtimeEntity<span class="token punctuation">.</span><span class="token function">getTm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"rm"</span><span class="token punctuation">,</span> realtimeEntity<span class="token punctuation">.</span><span class="token function">getRm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    bulkOperations<span class="token punctuation">.</span><span class="token function">updateOne</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
bulkOperations<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="font_colorred__29"></a><font color="red"> 注意：必须创建索引这样更新的效率快</font></h3> 
<h3><a id="font_colorred_3mongodbmongodb_31"></a><font color="red"> 3：mongodb保存的时候最好设置一个保存超时时间，因为mongodb本身没有设置保存或者更新超时抛出异常</font></h3> 
<pre><code class="prism language-java">	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveWithTimeout</span><span class="token punctuation">(</span><span class="token class-name">Object</span> objectToSave<span class="token punctuation">,</span> <span class="token class-name">String</span> collectionName<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> completableFuture <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        mongoTemplate<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>objectToSave<span class="token punctuation">,</span> collectionName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addCallback</span><span class="token punctuation">(</span>
            result <span class="token operator">-&gt;</span> completableFuture<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            ex <span class="token operator">-&gt;</span> completableFuture<span class="token punctuation">.</span><span class="token function">completeExceptionally</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            completableFuture<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TimeoutException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 超时处理逻辑，例如抛出异常或记录日志</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"保存超时"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> <span class="token operator">|</span> <span class="token class-name">ExecutionException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 异常处理逻辑</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"保存失败："</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="font_colorred_4Spring_BootapplicationymlapplicationpropertiesMongoDB_55"></a><font color="red"> 4：在Spring Boot中，你可以通过在application.yml或application.properties文件中设置相关属性来配置MongoDB的保存和更新操作的超时时间。</font></h3> 
<h4><a id="font_colorredapplicationymlMongoDB_57"></a><font color="red">下面是在application.yml文件中配置MongoDB超时时间的示例：</font></h4> 
<pre><code class="prism language-yml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">data</span><span class="token punctuation">:</span>
    <span class="token key atrule">mongodb</span><span class="token punctuation">:</span>
      <span class="token key atrule">write-concern</span><span class="token punctuation">:</span>
        <span class="token key atrule">w</span><span class="token punctuation">:</span> majority
        <span class="token key atrule">wtimeout</span><span class="token punctuation">:</span> <span class="token number">10000</span>
</code></pre> 
<h4><a id="font_colorredw_majoritywtimeout_1000010_66"></a><font color="red">在上述示例中，w: majority表示写操作需要大多数节点确认，wtimeout: 10000表示写操作的超时时间为10秒。</font></h4> 
<h4><a id="font_colorred_68"></a><font color="red">如果你只想设置保存操作的超时时间，可以使用以下配置：</font></h4> 
<pre><code class="prism language-yml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">data</span><span class="token punctuation">:</span>
    <span class="token key atrule">mongodb</span><span class="token punctuation">:</span>
      <span class="token key atrule">write-concern</span><span class="token punctuation">:</span>
        <span class="token key atrule">wtimeout</span><span class="token punctuation">:</span> <span class="token number">10000</span>
</code></pre> 
<h4><a id="font_colorred_77"></a><font color="red">同样地，如果你只想设置更新操作的超时时间，可以使用以下配置：</font></h4> 
<pre><code class="prism language-yml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">data</span><span class="token punctuation">:</span>
    <span class="token key atrule">mongodb</span><span class="token punctuation">:</span>
      <span class="token key atrule">update-timeout</span><span class="token punctuation">:</span> <span class="token number">10000</span>
</code></pre> 
<h4><a id="font_colorred_85"></a><font color="red">请根据你的具体需求选择合适的配置方式，并根据实际情况调整超时时间。</font></h4>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/38843a6406ff5f7f668f1e140177aae5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Mac 安装Nginx教程</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7c463961f690c7c8e52d2871e58b3095/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">krpano官网文档翻译-------krpano动作/脚本参考【krpano Actions / Scripting Reference】</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>