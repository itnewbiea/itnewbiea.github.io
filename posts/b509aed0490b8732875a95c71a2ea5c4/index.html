<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>MMDetection 系列之（自定义数据管道处理增强管道） - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="MMDetection 系列之（自定义数据管道处理增强管道）" />
<meta property="og:description" content="数据管道设计 遵循典型约定，我们使用Dataset和DataLoader对多个worker进行数据加载。数据集返回与模型的forward方法的参数相对应的数据项字典。由于目标检测中的数据可能不相同大小(图像大小，gt box大小等)，我们在MMCV中引入了一个新的DataContainer类型，以帮助收集和分发不同大小的数据。查看这里了解更多细节。
对数据准备管道和数据集进行分解。数据集通常定义如何处理注释，数据管道定义准备数据字典的所有步骤。管道由一系列操作组成。每个操作都接受一个字典作为输入，并输出一个字典用于下一个转换。
我们在下图中展示了一个经典的管道。蓝色的块是管道操作。随着管道的运行，每个操作符都可以向结果字典添加新的键(标记为绿色)或更新现有的键(标记为橙色)。
1、pipeline example for Faster R-CNN. img_norm_cfg = dict( mean=[123.675, 116.28, 103.53], std=[58.395, 57.12, 57.375], to_rgb=True) train_pipeline = [ dict(type=&#39;LoadImageFromFile&#39;), dict(type=&#39;LoadAnnotations&#39;, with_bbox=True), dict(type=&#39;Resize&#39;, img_scale=(1333, 800), keep_ratio=True), dict(type=&#39;RandomFlip&#39;, flip_ratio=0.5), dict(type=&#39;Normalize&#39;, **img_norm_cfg), dict(type=&#39;Pad&#39;, size_divisor=32), dict(type=&#39;DefaultFormatBundle&#39;), dict(type=&#39;Collect&#39;, keys=[&#39;img&#39;, &#39;gt_bboxes&#39;, &#39;gt_labels&#39;]), ] test_pipeline = [ dict(type=&#39;LoadImageFromFile&#39;), dict( type=&#39;MultiScaleFlipAug&#39;, img_scale=(1333, 800), flip=False, transforms=[ dict(type=&#39;Resize&#39;, keep_ratio=True), dict(type=&#39;RandomFlip&#39;), dict(type=&#39;Normalize&#39;, **img_norm_cfg), dict(type=&#39;Pad&#39;, size_divisor=32), dict(type=&#39;ImageToTensor&#39;, keys=[&#39;img&#39;]), dict(type=&#39;Collect&#39;, keys=[&#39;img&#39;]), ]) ] 对于每个操作，我们列出了添加/更新/删除的相关dict字段。
预处理
Resize
添加：scale，scale_idx，pad_shape，scale_factor，keep_ratio" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/b509aed0490b8732875a95c71a2ea5c4/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-05-31T11:10:55+08:00" />
<meta property="article:modified_time" content="2022-05-31T11:10:55+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">MMDetection 系列之（自定义数据管道处理增强管道）</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>数据管道设计</h3> 
<p>遵循典型约定，我们使用Dataset和DataLoader对多个worker进行数据加载。数据集返回与模型的forward方法的参数相对应的数据项字典。由于目标检测中的数据可能不相同大小(图像大小，gt box大小等)，我们在MMCV中引入了一个新的DataContainer类型，以帮助收集和分发不同大小的数据。查看这里了解更多细节。</p> 
<p>对数据准备管道和数据集进行分解。数据集通常定义如何处理注释，数据管道定义准备数据字典的所有步骤。管道由一系列操作组成。每个操作都接受一个字典作为输入，并输出一个字典用于下一个转换。<br> 我们在下图中展示了一个经典的管道。蓝色的块是管道操作。随着管道的运行，每个操作符都可以向结果字典添加新的键(标记为绿色)或更新现有的键(标记为橙色)。<br> <img src="https://images2.imgbox.com/10/f7/sEJ6GN3g_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="1pipeline_example_for_Faster_RCNN_7"></a>1、pipeline example for Faster R-CNN.</h4> 
<pre><code class="prism language-bash">img_norm_cfg <span class="token operator">=</span> dict<span class="token punctuation">(</span>
    <span class="token assign-left variable">mean</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">123.675</span>, <span class="token number">116.28</span>, <span class="token number">103.53</span><span class="token punctuation">]</span>, <span class="token assign-left variable">std</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">58.395</span>, <span class="token number">57.12</span>, <span class="token number">57.375</span><span class="token punctuation">]</span>, <span class="token assign-left variable">to_rgb</span><span class="token operator">=</span>True<span class="token punctuation">)</span>
train_pipeline <span class="token operator">=</span> <span class="token punctuation">[</span>
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'LoadImageFromFile'</span><span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'LoadAnnotations'</span>, <span class="token assign-left variable">with_bbox</span><span class="token operator">=</span>True<span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Resize'</span>, <span class="token assign-left variable">img_scale</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1333</span>, <span class="token number">800</span><span class="token punctuation">)</span>, <span class="token assign-left variable">keep_ratio</span><span class="token operator">=</span>True<span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'RandomFlip'</span>, <span class="token assign-left variable">flip_ratio</span><span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Normalize'</span>, **img_norm_cfg<span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Pad'</span>, <span class="token assign-left variable">size_divisor</span><span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'DefaultFormatBundle'</span><span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Collect'</span>, <span class="token assign-left variable">keys</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'img'</span>, <span class="token string">'gt_bboxes'</span>, <span class="token string">'gt_labels'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>,
<span class="token punctuation">]</span>
test_pipeline <span class="token operator">=</span> <span class="token punctuation">[</span>
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'LoadImageFromFile'</span><span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>
        <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'MultiScaleFlipAug'</span>,
        <span class="token assign-left variable">img_scale</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1333</span>, <span class="token number">800</span><span class="token punctuation">)</span>,
        <span class="token assign-left variable">flip</span><span class="token operator">=</span>False,
        <span class="token assign-left variable">transforms</span><span class="token operator">=</span><span class="token punctuation">[</span>
            dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Resize'</span>, <span class="token assign-left variable">keep_ratio</span><span class="token operator">=</span>True<span class="token punctuation">)</span>,
            dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'RandomFlip'</span><span class="token punctuation">)</span>,
            dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Normalize'</span>, **img_norm_cfg<span class="token punctuation">)</span>,
            dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Pad'</span>, <span class="token assign-left variable">size_divisor</span><span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span>,
            dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'ImageToTensor'</span>, <span class="token assign-left variable">keys</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>,
            dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Collect'</span>, <span class="token assign-left variable">keys</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>,
        <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>
</code></pre> 
<p>对于每个操作，我们列出了添加/更新/删除的相关dict字段。</p> 
<p>预处理</p> 
<p>Resize<br> 添加：scale，scale_idx，pad_shape，scale_factor，keep_ratio<br> 更新：img，img_shape，* bbox_fields，* mask_fields，* seg_fields</p> 
<p>RandomFlip<br> 添加：翻转<br> 更新：img，* bbox_fields，* mask_fields，* seg_fields</p> 
<p>Pad<br> 添加：pad_fixed_size，pad_size_divisor<br> 更新：img，pad_shape，* mask_fields，* seg_fields</p> 
<p>RandomCrop<br> 更新：img，pad_shape，gt_bboxes，gt_labels，gt_masks，* bbox_fields</p> 
<p>Normalize<br> 添加：img_norm_cfg<br> 更新：img</p> 
<p>SegRescale<br> 更新：gt_semantic_seg</p> 
<p>PhotoMetricDistortion<br> 更新：img</p> 
<p>Expand<br> 更新：img，gt_bboxes</p> 
<p>MinIoURandomCrop<br> 更新：img，gt_bboxes，gt_labels</p> 
<p>Corrupt<br> 更新：img</p> 
<p>格式化<br> ToTensor</p> 
<p>更新：由指定keys。<br> ImageToTensor</p> 
<p>更新：由指定keys。<br> Transpose</p> 
<p>更新：由指定keys。<br> ToDataContainer</p> 
<p>更新：由指定fields。<br> DefaultFormatBundle</p> 
<p>更新：img，投标，gt_bboxes，gt_bboxes_ignore，gt_labels，gt_masks，gt_semantic_seg<br> Collect</p> 
<p>添加：img_meta（img_meta的键由指定meta_keys）<br> 删除：除由所指定的键外的所有其他键 keys<br> 测试时间增加<br> MultiScaleFlipAug</p> 
<h3><a id="_97"></a>数据加载</h3> 
<p>数据加载<br> LoadImageFromFile<br> 添加：img，img_shape，ori_shape</p> 
<p>LoadAnnotations<br> 添加：gt_bboxes，gt_bboxes_ignore，gt_labels，gt_masks，gt_semantic_seg，bbox_fields，mask_fields</p> 
<p>LoadProposals<br> 添加：建议</p> 
<h3><a id="_107"></a>预处理</h3> 
<p>Resize（缩放）<br> add: scale, scale_idx, pad_shape, scale_factor, keep_ratio<br> update: img, img_shape, *bbox_fields, *mask_fields, *seg_fields</p> 
<p>RandomFlip（随机镜像）<br> add: flip<br> update: img, *bbox_fields, *mask_fields, *seg_fields</p> 
<p>Pad（填充）<br> add: pad_fixed_size, pad_size_divisor<br> update: img, pad_shape, *mask_fields, *seg_fields</p> 
<p>RandomCrop（随机裁剪）<br> update: img, pad_shape, gt_bboxes, gt_labels, gt_masks, *bbox_fields</p> 
<p>Normalize（归一化）<br> add: img_norm_cfg<br> update: img</p> 
<p>SegRescale<br> update: gt_semantic_seg</p> 
<p>PhotoMetricDistortion<br> update: img</p> 
<p>Expand<br> update: img, gt_bboxes</p> 
<p>MinIoURandomCrop<br> update: img, gt_bboxes, gt_labels</p> 
<p>Corrupt<br> update: img</p> 
<h3><a id="_141"></a>格式化</h3> 
<p>ToTensor<br> update: specified by keys.</p> 
<p>ImageToTensor<br> update: specified by keys.</p> 
<p>Transpose<br> update: specified by keys.</p> 
<p>ToDataContainer<br> update: specified by fields.</p> 
<p>DefaultFormatBundle<br> update: img, proposals, gt_bboxes, gt_bboxes_ignore, gt_labels, gt_masks, gt_semantic_seg</p> 
<p>Collect<br> add: img_meta (the keys of img_meta is specified by meta_keys)<br> remove: all other keys except for those specified by keys</p> 
<h3><a id="_162"></a>扩展和使用自定义管道</h3> 
<h4><a id="1my_pipelinepy_163"></a>1、"在文件中写入一个新的管道，例如my_pipeline.py。它接受一个字典作为输入并返回一个字典。</h4> 
<pre><code class="prism language-bash"><span class="token function">import</span> random
from mmdet.datasets <span class="token function">import</span> PIPELINES


@PIPELINES.register_module<span class="token punctuation">(</span><span class="token punctuation">)</span>
class MyTransform:
    <span class="token string">""</span>"Add your transform

    Args:
        p <span class="token punctuation">(</span>float<span class="token punctuation">)</span>: Probability of shifts. Default <span class="token number">0.5</span>.
    <span class="token string">""</span>"

    def __init__<span class="token punctuation">(</span>self, <span class="token assign-left variable">p</span><span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span>:
        self.p <span class="token operator">=</span> p

    def __call__<span class="token punctuation">(</span>self, results<span class="token punctuation">)</span>:
        <span class="token keyword">if</span> random.random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> self.p:
            results<span class="token punctuation">[</span><span class="token string">'dummy'</span><span class="token punctuation">]</span> <span class="token operator">=</span> True
        <span class="token builtin class-name">return</span> results
</code></pre> 
<h4><a id="2_train_188"></a>2. 在配置文件中导入并使用管道。确保导入是相对于train脚本所在的位置。</h4> 
<pre><code class="prism language-bash">custom_imports <span class="token operator">=</span> dict<span class="token punctuation">(</span>imports<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'path.to.my_pipeline'</span><span class="token punctuation">]</span>, <span class="token assign-left variable">allow_failed_imports</span><span class="token operator">=</span>False<span class="token punctuation">)</span>

img_norm_cfg <span class="token operator">=</span> dict<span class="token punctuation">(</span>
    <span class="token assign-left variable">mean</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">123.675</span>, <span class="token number">116.28</span>, <span class="token number">103.53</span><span class="token punctuation">]</span>, <span class="token assign-left variable">std</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">58.395</span>, <span class="token number">57.12</span>, <span class="token number">57.375</span><span class="token punctuation">]</span>, <span class="token assign-left variable">to_rgb</span><span class="token operator">=</span>True<span class="token punctuation">)</span>
train_pipeline <span class="token operator">=</span> <span class="token punctuation">[</span>
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'LoadImageFromFile'</span><span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'LoadAnnotations'</span>, <span class="token assign-left variable">with_bbox</span><span class="token operator">=</span>True<span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Resize'</span>, <span class="token assign-left variable">img_scale</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1333</span>, <span class="token number">800</span><span class="token punctuation">)</span>, <span class="token assign-left variable">keep_ratio</span><span class="token operator">=</span>True<span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'RandomFlip'</span>, <span class="token assign-left variable">flip_ratio</span><span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Normalize'</span>, **img_norm_cfg<span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Pad'</span>, <span class="token assign-left variable">size_divisor</span><span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'MyTransform'</span>, <span class="token assign-left variable">p</span><span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'DefaultFormatBundle'</span><span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Collect'</span>, <span class="token assign-left variable">keys</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'img'</span>, <span class="token string">'gt_bboxes'</span>, <span class="token string">'gt_labels'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>,
<span class="token punctuation">]</span>
</code></pre> 
<h4><a id="3_207"></a>3.可视化您的增强管道的输出</h4> 
<p>要可视化您的agementpipeline的输出，tools/misc/browse_data .py可以帮助用户可视化地浏览检测数据集(包括图像和边界框注释)，或者将图像保存到指定目录。更多细节可以参考useful_tools</p> 
<h3><a id="Bbox_209"></a>为什么图像和Bbox需要进行数据增强</h3> 
<p>答：因为数据多了就可以尽可能多的学习到图像中的不变性，学习到的不变性越多那么模型的泛化能力越强。</p> 
<p>但是输入到CNN中的图像为什么不具有平移不变性？如何去解决？下面链接有专门的解析：<br> <a href="https://zhuanlan.zhihu.com/p/103342289" rel="nofollow">输入到CNN中的图像为什么不具有平移不变性？如何去解决？</a></p> 
<h3><a id="MMdetection__214"></a>MMdetection 数据增强</h3> 
<p>MMDetection中，数据增强包括两部分：（源码解析）</p> 
<p>新版MMDetection新添加用Albu数据库对图像进行增强的代码，位置在mmdetection/configs/albu_example/mask_rcnn_r50_fpn_1x.py，是基于图像分割的，用于目标检测的代码更新如下</p> 
<h4><a id="1albumentations_219"></a>1、引入albumentations数据增强库进行增强</h4> 
<p><a href="https://zhuanlan.zhihu.com/p/125036517" rel="nofollow">目标检测tricks：Ablu数据库增强</a></p> 
<h5><a id="_222"></a>重点部分代码：</h5> 
<pre><code class="prism language-bash">albu_train_transforms <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token comment"># dict(</span>
    <span class="token comment">#     type='HorizontalFlip',</span>
    <span class="token comment">#     p=0.5),</span>
    <span class="token comment"># dict(</span>
    <span class="token comment">#     type='VerticalFlip',</span>
    <span class="token comment">#     p=0.5),</span>

    dict<span class="token punctuation">(</span>
        <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'ShiftScaleRotate'</span>,
        <span class="token assign-left variable">shift_limit</span><span class="token operator">=</span><span class="token number">0.0625</span>,
        <span class="token assign-left variable">scale_limit</span><span class="token operator">=</span><span class="token number">0.0</span>,
        <span class="token assign-left variable">rotate_limit</span><span class="token operator">=</span><span class="token number">180</span>,
        <span class="token assign-left variable">interpolation</span><span class="token operator">=</span><span class="token number">1</span>,
        <span class="token assign-left variable">p</span><span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span>,
    <span class="token comment"># dict(</span>
    <span class="token comment">#     type='RandomBrightnessContrast',</span>
    <span class="token comment">#     brightness_limit=[0.1, 0.3],</span>
    <span class="token comment">#     contrast_limit=[0.1, 0.3],</span>
    <span class="token comment">#     p=0.2),</span>
    <span class="token comment"># dict(</span>
    <span class="token comment">#     type='OneOf',</span>
    <span class="token comment">#     transforms=[</span>
    <span class="token comment">#         dict(</span>
    <span class="token comment">#             type='RGBShift',</span>
    <span class="token comment">#             r_shift_limit=10,</span>
    <span class="token comment">#             g_shift_limit=10,</span>
    <span class="token comment">#             b_shift_limit=10,</span>
    <span class="token comment">#             p=1.0),</span>
    <span class="token comment">#         dict(</span>
    <span class="token comment">#             type='HueSaturationValue',</span>
    <span class="token comment">#             hue_shift_limit=20,</span>
    <span class="token comment">#             sat_shift_limit=30,</span>
    <span class="token comment">#             val_shift_limit=20,</span>
    <span class="token comment">#             p=1.0)</span>
    <span class="token comment">#     ],</span>
    <span class="token comment">#     p=0.1),</span>
    <span class="token comment"># # dict(type='JpegCompression', quality_lower=85, quality_upper=95, p=0.2),</span>
    <span class="token comment">#</span>
    <span class="token comment"># dict(type='ChannelShuffle', p=0.1),</span>
    <span class="token comment"># dict(</span>
    <span class="token comment">#     type='OneOf',</span>
    <span class="token comment">#     transforms=[</span>
    <span class="token comment">#         dict(type='Blur', blur_limit=3, p=1.0),</span>
    <span class="token comment">#         dict(type='MedianBlur', blur_limit=3, p=1.0)</span>
    <span class="token comment">#     ],</span>
    <span class="token comment">#     p=0.1),</span>
<span class="token punctuation">]</span>

train_pipeline <span class="token operator">=</span> <span class="token punctuation">[</span>
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'LoadImageFromFile'</span><span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'LoadAnnotations'</span>, <span class="token assign-left variable">with_bbox</span><span class="token operator">=</span>True<span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Resize'</span>, <span class="token assign-left variable">img_scale</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">4096</span>, <span class="token number">800</span><span class="token punctuation">)</span>, <span class="token punctuation">(</span><span class="token number">4096</span>, <span class="token number">1200</span><span class="token punctuation">)</span><span class="token punctuation">]</span>, <span class="token assign-left variable">keep_ratio</span><span class="token operator">=</span>True<span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'RandomFlip'</span>, <span class="token assign-left variable">flip_ratio</span><span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span>,

    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Pad'</span>, <span class="token assign-left variable">size_divisor</span><span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span>,
    <span class="token string">''</span>'
    Args:
        transforms <span class="token punctuation">(</span>list<span class="token punctuation">[</span>dict<span class="token punctuation">]</span><span class="token punctuation">)</span>: A list of albu transformations , albu transformations 列表
        bbox_params <span class="token punctuation">(</span>dict<span class="token punctuation">)</span>: Bbox_params <span class="token keyword">for</span> albumentation <span class="token variable"><span class="token variable">`</span>Compose<span class="token variable">`</span></span>
        keymap <span class="token punctuation">(</span>dict<span class="token punctuation">)</span>: Contains <span class="token punctuation">{<!-- --></span><span class="token string">'input key'</span><span class="token builtin class-name">:</span><span class="token string">'albumentation-style key'</span><span class="token punctuation">}</span>
        skip_img_without_anno <span class="token punctuation">(</span>bool<span class="token punctuation">)</span>: Whether to skip the image <span class="token keyword">if</span> no ann left
            after aug 是否跳过图像，如果没有ann离开后aug
    <span class="token string">''</span>'
    dict<span class="token punctuation">(</span>
        <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'Albu'</span>,
        <span class="token assign-left variable">transforms</span><span class="token operator">=</span>albu_train_transforms,
        <span class="token assign-left variable">bbox_params</span><span class="token operator">=</span>dict<span class="token punctuation">(</span>
            <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'BboxParams'</span>,
            <span class="token assign-left variable">format</span><span class="token operator">=</span><span class="token string">'pascal_voc'</span>,
            <span class="token assign-left variable">label_fields</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'gt_labels'</span><span class="token punctuation">]</span>,
            <span class="token assign-left variable">min_visibility</span><span class="token operator">=</span><span class="token number">0.0</span>,
            <span class="token assign-left variable">filter_lost_elements</span><span class="token operator">=</span>True<span class="token punctuation">)</span>,
        <span class="token assign-left variable">keymap</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
            <span class="token string">'img'</span><span class="token builtin class-name">:</span> <span class="token string">'image'</span>,
            <span class="token string">'gt_bboxes'</span><span class="token builtin class-name">:</span> <span class="token string">'bboxes'</span>
        <span class="token punctuation">}</span>,
        <span class="token assign-left variable">update_pad_shape</span><span class="token operator">=</span>False,
        <span class="token assign-left variable">skip_img_without_anno</span><span class="token operator">=</span>True<span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Normalize'</span>, **img_norm_cfg<span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'DefaultFormatBundle'</span><span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>
        <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'Collect'</span>,
        <span class="token assign-left variable">keys</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'img'</span>, <span class="token string">'gt_bboxes'</span>, <span class="token string">'gt_labels'</span><span class="token punctuation">]</span>,
        <span class="token assign-left variable">meta_keys</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">'filename'</span>, <span class="token string">'ori_shape'</span>, <span class="token string">'img_shape'</span>, <span class="token string">'img_norm_cfg'</span>,
                   <span class="token string">'pad_shape'</span>, <span class="token string">'scale_factor'</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">]</span>

</code></pre> 
<h5><a id="_315"></a>全部代码</h5> 
<pre><code class="prism language-bash"><span class="token comment"># model settings</span>
model <span class="token operator">=</span> dict<span class="token punctuation">(</span>
    <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'CascadeRCNN'</span>,
    <span class="token assign-left variable">num_stages</span><span class="token operator">=</span><span class="token number">3</span>,
    <span class="token assign-left variable">pretrained</span><span class="token operator">=</span><span class="token string">'torchvision://resnet50'</span>,
    <span class="token assign-left variable">backbone</span><span class="token operator">=</span>dict<span class="token punctuation">(</span>
        <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'ResNet'</span>,
        <span class="token assign-left variable">depth</span><span class="token operator">=</span><span class="token number">50</span>,
        <span class="token assign-left variable">num_stages</span><span class="token operator">=</span><span class="token number">4</span>,
        <span class="token assign-left variable">out_indices</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span>, <span class="token number">1</span>, <span class="token number">2</span>, <span class="token number">3</span><span class="token punctuation">)</span>,
        <span class="token assign-left variable">frozen_stages</span><span class="token operator">=</span><span class="token number">1</span>,
        <span class="token assign-left variable">style</span><span class="token operator">=</span><span class="token string">'pytorch'</span><span class="token punctuation">)</span>,
    <span class="token assign-left variable">neck</span><span class="token operator">=</span>dict<span class="token punctuation">(</span>
        <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'FPN'</span>,
        <span class="token assign-left variable">in_channels</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">256</span>, <span class="token number">512</span>, <span class="token number">1024</span>, <span class="token number">2048</span><span class="token punctuation">]</span>,
        <span class="token assign-left variable">out_channels</span><span class="token operator">=</span><span class="token number">256</span>,
        <span class="token assign-left variable">num_outs</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>,
    <span class="token assign-left variable">rpn_head</span><span class="token operator">=</span>dict<span class="token punctuation">(</span>
        <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'RPNHead'</span>,
        <span class="token assign-left variable">in_channels</span><span class="token operator">=</span><span class="token number">256</span>,
        <span class="token assign-left variable">feat_channels</span><span class="token operator">=</span><span class="token number">256</span>,
        <span class="token assign-left variable">anchor_scales</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span>,
        <span class="token assign-left variable">anchor_ratios</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.5</span>, <span class="token number">1.0</span>, <span class="token number">2.0</span><span class="token punctuation">]</span>,
        <span class="token assign-left variable">anchor_strides</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">4</span>, <span class="token number">8</span>, <span class="token number">16</span>, <span class="token number">32</span>, <span class="token number">64</span><span class="token punctuation">]</span>,
        <span class="token assign-left variable">target_means</span><span class="token operator">=</span><span class="token punctuation">[</span>.0, .0, .0, .0<span class="token punctuation">]</span>,
        <span class="token assign-left variable">target_stds</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1.0</span>, <span class="token number">1.0</span>, <span class="token number">1.0</span>, <span class="token number">1.0</span><span class="token punctuation">]</span>,
        <span class="token assign-left variable">loss_cls</span><span class="token operator">=</span>dict<span class="token punctuation">(</span>
            <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'CrossEntropyLoss'</span>, <span class="token assign-left variable">use_sigmoid</span><span class="token operator">=</span>True, <span class="token assign-left variable">loss_weight</span><span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span>, <span class="token comment"># CrossEntropyLoss/FocalLoss</span>
        <span class="token assign-left variable">loss_bbox</span><span class="token operator">=</span>dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'SmoothL1Loss'</span>, <span class="token assign-left variable">beta</span><span class="token operator">=</span><span class="token number">1.0</span> / <span class="token number">9.0</span>, <span class="token assign-left variable">loss_weight</span><span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">))</span>,
    <span class="token assign-left variable">bbox_roi_extractor</span><span class="token operator">=</span>dict<span class="token punctuation">(</span>
        <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'SingleRoIExtractor'</span>,
        <span class="token assign-left variable">roi_layer</span><span class="token operator">=</span>dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'RoIAlign'</span>, <span class="token assign-left variable">out_size</span><span class="token operator">=</span><span class="token number">7</span>, <span class="token assign-left variable">sample_num</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>,
        <span class="token assign-left variable">out_channels</span><span class="token operator">=</span><span class="token number">256</span>,
        <span class="token assign-left variable">featmap_strides</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">4</span>, <span class="token number">8</span>, <span class="token number">16</span>, <span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">)</span>,
    <span class="token assign-left variable">bbox_head</span><span class="token operator">=</span><span class="token punctuation">[</span>
        dict<span class="token punctuation">(</span>
            <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'SharedFCBBoxHead'</span>,
            <span class="token assign-left variable">num_fcs</span><span class="token operator">=</span><span class="token number">2</span>,
            <span class="token assign-left variable">in_channels</span><span class="token operator">=</span><span class="token number">256</span>,
            <span class="token assign-left variable">fc_out_channels</span><span class="token operator">=</span><span class="token number">1024</span>,
            <span class="token assign-left variable">roi_feat_size</span><span class="token operator">=</span><span class="token number">7</span>,
            <span class="token assign-left variable">num_classes</span><span class="token operator">=</span><span class="token number">8</span>,
            <span class="token assign-left variable">target_means</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0</span>., <span class="token number">0</span>., <span class="token number">0</span>., <span class="token number">0</span>.<span class="token punctuation">]</span>,
            <span class="token assign-left variable">target_stds</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.1</span>, <span class="token number">0.1</span>, <span class="token number">0.2</span>, <span class="token number">0.2</span><span class="token punctuation">]</span>,
            <span class="token assign-left variable">reg_class_agnostic</span><span class="token operator">=</span>True,
            <span class="token assign-left variable">loss_cls</span><span class="token operator">=</span>dict<span class="token punctuation">(</span>
                <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'CrossEntropyLoss'</span>, <span class="token assign-left variable">use_sigmoid</span><span class="token operator">=</span>False, <span class="token assign-left variable">loss_weight</span><span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span>,
            <span class="token assign-left variable">loss_bbox</span><span class="token operator">=</span>dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'SmoothL1Loss'</span>, <span class="token assign-left variable">beta</span><span class="token operator">=</span><span class="token number">1.0</span>, <span class="token assign-left variable">loss_weight</span><span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">))</span>,
        dict<span class="token punctuation">(</span>
            <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'SharedFCBBoxHead'</span>,
            <span class="token assign-left variable">num_fcs</span><span class="token operator">=</span><span class="token number">2</span>,
            <span class="token assign-left variable">in_channels</span><span class="token operator">=</span><span class="token number">256</span>,
            <span class="token assign-left variable">fc_out_channels</span><span class="token operator">=</span><span class="token number">1024</span>,
            <span class="token assign-left variable">roi_feat_size</span><span class="token operator">=</span><span class="token number">7</span>,
            <span class="token assign-left variable">num_classes</span><span class="token operator">=</span><span class="token number">8</span>,
            <span class="token assign-left variable">target_means</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0</span>., <span class="token number">0</span>., <span class="token number">0</span>., <span class="token number">0</span>.<span class="token punctuation">]</span>,
            <span class="token assign-left variable">target_stds</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.05</span>, <span class="token number">0.05</span>, <span class="token number">0.1</span>, <span class="token number">0.1</span><span class="token punctuation">]</span>,
            <span class="token assign-left variable">reg_class_agnostic</span><span class="token operator">=</span>True,
            <span class="token assign-left variable">loss_cls</span><span class="token operator">=</span>dict<span class="token punctuation">(</span>
                <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'CrossEntropyLoss'</span>, <span class="token assign-left variable">use_sigmoid</span><span class="token operator">=</span>False, <span class="token assign-left variable">loss_weight</span><span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span>,
            <span class="token assign-left variable">loss_bbox</span><span class="token operator">=</span>dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'SmoothL1Loss'</span>, <span class="token assign-left variable">beta</span><span class="token operator">=</span><span class="token number">1.0</span>, <span class="token assign-left variable">loss_weight</span><span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">))</span>,
        dict<span class="token punctuation">(</span>
            <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'SharedFCBBoxHead'</span>,
            <span class="token assign-left variable">num_fcs</span><span class="token operator">=</span><span class="token number">2</span>,
            <span class="token assign-left variable">in_channels</span><span class="token operator">=</span><span class="token number">256</span>,
            <span class="token assign-left variable">fc_out_channels</span><span class="token operator">=</span><span class="token number">1024</span>,
            <span class="token assign-left variable">roi_feat_size</span><span class="token operator">=</span><span class="token number">7</span>,
            <span class="token assign-left variable">num_classes</span><span class="token operator">=</span><span class="token number">8</span>,
            <span class="token assign-left variable">target_means</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0</span>., <span class="token number">0</span>., <span class="token number">0</span>., <span class="token number">0</span>.<span class="token punctuation">]</span>,
            <span class="token assign-left variable">target_stds</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.033</span>, <span class="token number">0.033</span>, <span class="token number">0.067</span>, <span class="token number">0.067</span><span class="token punctuation">]</span>,
            <span class="token assign-left variable">reg_class_agnostic</span><span class="token operator">=</span>True,
            <span class="token assign-left variable">loss_cls</span><span class="token operator">=</span>dict<span class="token punctuation">(</span>
                <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'CrossEntropyLoss'</span>, <span class="token assign-left variable">use_sigmoid</span><span class="token operator">=</span>False, <span class="token assign-left variable">loss_weight</span><span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span>,
            <span class="token assign-left variable">loss_bbox</span><span class="token operator">=</span>dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'SmoothL1Loss'</span>, <span class="token assign-left variable">beta</span><span class="token operator">=</span><span class="token number">1.0</span>, <span class="token assign-left variable">loss_weight</span><span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">))</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># model training and testing settings</span>
train_cfg <span class="token operator">=</span> dict<span class="token punctuation">(</span>
    <span class="token assign-left variable">rpn</span><span class="token operator">=</span>dict<span class="token punctuation">(</span>
        <span class="token assign-left variable">assigner</span><span class="token operator">=</span>dict<span class="token punctuation">(</span>
            <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'MaxIoUAssigner'</span>,
            <span class="token assign-left variable">pos_iou_thr</span><span class="token operator">=</span><span class="token number">0.7</span>,
            <span class="token assign-left variable">neg_iou_thr</span><span class="token operator">=</span><span class="token number">0.3</span>,
            <span class="token assign-left variable">min_pos_iou</span><span class="token operator">=</span><span class="token number">0.3</span>,
            <span class="token assign-left variable">ignore_iof_thr</span><span class="token operator">=</span>-1<span class="token punctuation">)</span>,
        <span class="token assign-left variable">sampler</span><span class="token operator">=</span>dict<span class="token punctuation">(</span>
            <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'RandomSampler'</span>,
            <span class="token assign-left variable">num</span><span class="token operator">=</span><span class="token number">256</span>,
            <span class="token assign-left variable">pos_fraction</span><span class="token operator">=</span><span class="token number">0.5</span>,
            <span class="token assign-left variable">neg_pos_ub</span><span class="token operator">=</span>-1,
            <span class="token assign-left variable">add_gt_as_proposals</span><span class="token operator">=</span>False<span class="token punctuation">)</span>,
        <span class="token assign-left variable">allowed_border</span><span class="token operator">=</span><span class="token number">0</span>,
        <span class="token assign-left variable">pos_weight</span><span class="token operator">=</span>-1,
        <span class="token assign-left variable">debug</span><span class="token operator">=</span>False<span class="token punctuation">)</span>,
    <span class="token assign-left variable">rpn_proposal</span><span class="token operator">=</span>dict<span class="token punctuation">(</span>
        <span class="token assign-left variable">nms_across_levels</span><span class="token operator">=</span>False,
        <span class="token assign-left variable">nms_pre</span><span class="token operator">=</span><span class="token number">2000</span>,
        <span class="token assign-left variable">nms_post</span><span class="token operator">=</span><span class="token number">2000</span>,
        <span class="token assign-left variable">max_num</span><span class="token operator">=</span><span class="token number">2000</span>,
        <span class="token assign-left variable">nms_thr</span><span class="token operator">=</span><span class="token number">0.7</span>,
        <span class="token assign-left variable">min_bbox_size</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>,
    <span class="token assign-left variable">rcnn</span><span class="token operator">=</span><span class="token punctuation">[</span>
        dict<span class="token punctuation">(</span>
            <span class="token assign-left variable">assigner</span><span class="token operator">=</span>dict<span class="token punctuation">(</span>
                <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'MaxIoUAssigner'</span>,
                <span class="token assign-left variable">pos_iou_thr</span><span class="token operator">=</span><span class="token number">0.5</span>,
                <span class="token assign-left variable">neg_iou_thr</span><span class="token operator">=</span><span class="token number">0.5</span>,
                <span class="token assign-left variable">min_pos_iou</span><span class="token operator">=</span><span class="token number">0.5</span>,
                <span class="token assign-left variable">ignore_iof_thr</span><span class="token operator">=</span>-1<span class="token punctuation">)</span>,
            <span class="token assign-left variable">sampler</span><span class="token operator">=</span>dict<span class="token punctuation">(</span>
                <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'RandomSampler'</span>,
                <span class="token assign-left variable">num</span><span class="token operator">=</span><span class="token number">512</span>,
                <span class="token assign-left variable">pos_fraction</span><span class="token operator">=</span><span class="token number">0.25</span>,
                <span class="token assign-left variable">neg_pos_ub</span><span class="token operator">=</span>-1,
                <span class="token assign-left variable">add_gt_as_proposals</span><span class="token operator">=</span>True<span class="token punctuation">)</span>,
            <span class="token assign-left variable">pos_weight</span><span class="token operator">=</span>-1,
            <span class="token assign-left variable">debug</span><span class="token operator">=</span>False<span class="token punctuation">)</span>,
        dict<span class="token punctuation">(</span>
            <span class="token assign-left variable">assigner</span><span class="token operator">=</span>dict<span class="token punctuation">(</span>
                <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'MaxIoUAssigner'</span>,
                <span class="token assign-left variable">pos_iou_thr</span><span class="token operator">=</span><span class="token number">0.6</span>,
                <span class="token assign-left variable">neg_iou_thr</span><span class="token operator">=</span><span class="token number">0.6</span>,
                <span class="token assign-left variable">min_pos_iou</span><span class="token operator">=</span><span class="token number">0.6</span>,
                <span class="token assign-left variable">ignore_iof_thr</span><span class="token operator">=</span>-1<span class="token punctuation">)</span>,
            <span class="token assign-left variable">sampler</span><span class="token operator">=</span>dict<span class="token punctuation">(</span>
                <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'RandomSampler'</span>,
                <span class="token assign-left variable">num</span><span class="token operator">=</span><span class="token number">512</span>,
                <span class="token assign-left variable">pos_fraction</span><span class="token operator">=</span><span class="token number">0.25</span>,
                <span class="token assign-left variable">neg_pos_ub</span><span class="token operator">=</span>-1,
                <span class="token assign-left variable">add_gt_as_proposals</span><span class="token operator">=</span>True<span class="token punctuation">)</span>,
            <span class="token assign-left variable">pos_weight</span><span class="token operator">=</span>-1,
            <span class="token assign-left variable">debug</span><span class="token operator">=</span>False<span class="token punctuation">)</span>,
        dict<span class="token punctuation">(</span>
            <span class="token assign-left variable">assigner</span><span class="token operator">=</span>dict<span class="token punctuation">(</span>
                <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'MaxIoUAssigner'</span>,
                <span class="token assign-left variable">pos_iou_thr</span><span class="token operator">=</span><span class="token number">0.7</span>,
                <span class="token assign-left variable">neg_iou_thr</span><span class="token operator">=</span><span class="token number">0.7</span>,
                <span class="token assign-left variable">min_pos_iou</span><span class="token operator">=</span><span class="token number">0.7</span>,
                <span class="token assign-left variable">ignore_iof_thr</span><span class="token operator">=</span>-1<span class="token punctuation">)</span>,
            <span class="token assign-left variable">sampler</span><span class="token operator">=</span>dict<span class="token punctuation">(</span>
                <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'RandomSampler'</span>,
                <span class="token assign-left variable">num</span><span class="token operator">=</span><span class="token number">512</span>,
                <span class="token assign-left variable">pos_fraction</span><span class="token operator">=</span><span class="token number">0.25</span>,
                <span class="token assign-left variable">neg_pos_ub</span><span class="token operator">=</span>-1,
                <span class="token assign-left variable">add_gt_as_proposals</span><span class="token operator">=</span>True<span class="token punctuation">)</span>,
            <span class="token assign-left variable">pos_weight</span><span class="token operator">=</span>-1,
            <span class="token assign-left variable">debug</span><span class="token operator">=</span>False<span class="token punctuation">)</span>
    <span class="token punctuation">]</span>,
    <span class="token assign-left variable">stage_loss_weights</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span>, <span class="token number">0.5</span>, <span class="token number">0.25</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
test_cfg <span class="token operator">=</span> dict<span class="token punctuation">(</span>
    <span class="token assign-left variable">rpn</span><span class="token operator">=</span>dict<span class="token punctuation">(</span>
        <span class="token assign-left variable">nms_across_levels</span><span class="token operator">=</span>False,
        <span class="token assign-left variable">nms_pre</span><span class="token operator">=</span><span class="token number">1000</span>,
        <span class="token assign-left variable">nms_post</span><span class="token operator">=</span><span class="token number">1000</span>,
        <span class="token assign-left variable">max_num</span><span class="token operator">=</span><span class="token number">1000</span>,
        <span class="token assign-left variable">nms_thr</span><span class="token operator">=</span><span class="token number">0.7</span>,
        <span class="token assign-left variable">min_bbox_size</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>,
    <span class="token assign-left variable">rcnn</span><span class="token operator">=</span>dict<span class="token punctuation">(</span>
        <span class="token assign-left variable">score_thr</span><span class="token operator">=</span><span class="token number">0.01</span>,
        <span class="token assign-left variable">nms</span><span class="token operator">=</span>dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'nms'</span>, <span class="token assign-left variable">iou_thr</span><span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span>, <span class="token assign-left variable">max_per_img</span><span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span>,
    <span class="token assign-left variable">keep_all_stages</span><span class="token operator">=</span>False<span class="token punctuation">)</span>
<span class="token comment"># dataset</span>
dataset_type <span class="token operator">=</span> <span class="token string">'CocoDataset'</span>
data_root <span class="token operator">=</span> <span class="token string">'./data/coco/'</span>
img_norm_cfg <span class="token operator">=</span> dict<span class="token punctuation">(</span>
    <span class="token assign-left variable">mean</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">123.675</span>, <span class="token number">116.28</span>, <span class="token number">103.53</span><span class="token punctuation">]</span>, <span class="token assign-left variable">std</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">58.395</span>, <span class="token number">57.12</span>, <span class="token number">57.375</span><span class="token punctuation">]</span>, <span class="token assign-left variable">to_rgb</span><span class="token operator">=</span>True<span class="token punctuation">)</span>

albu_train_transforms <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token comment"># dict(</span>
    <span class="token comment">#     type='HorizontalFlip',</span>
    <span class="token comment">#     p=0.5),</span>
    <span class="token comment"># dict(</span>
    <span class="token comment">#     type='VerticalFlip',</span>
    <span class="token comment">#     p=0.5),</span>

    dict<span class="token punctuation">(</span>
        <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'ShiftScaleRotate'</span>,
        <span class="token assign-left variable">shift_limit</span><span class="token operator">=</span><span class="token number">0.0625</span>,
        <span class="token assign-left variable">scale_limit</span><span class="token operator">=</span><span class="token number">0.0</span>,
        <span class="token assign-left variable">rotate_limit</span><span class="token operator">=</span><span class="token number">180</span>,
        <span class="token assign-left variable">interpolation</span><span class="token operator">=</span><span class="token number">1</span>,
        <span class="token assign-left variable">p</span><span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span>,
    <span class="token comment"># dict(</span>
    <span class="token comment">#     type='RandomBrightnessContrast',</span>
    <span class="token comment">#     brightness_limit=[0.1, 0.3],</span>
    <span class="token comment">#     contrast_limit=[0.1, 0.3],</span>
    <span class="token comment">#     p=0.2),</span>
    <span class="token comment"># dict(</span>
    <span class="token comment">#     type='OneOf',</span>
    <span class="token comment">#     transforms=[</span>
    <span class="token comment">#         dict(</span>
    <span class="token comment">#             type='RGBShift',</span>
    <span class="token comment">#             r_shift_limit=10,</span>
    <span class="token comment">#             g_shift_limit=10,</span>
    <span class="token comment">#             b_shift_limit=10,</span>
    <span class="token comment">#             p=1.0),</span>
    <span class="token comment">#         dict(</span>
    <span class="token comment">#             type='HueSaturationValue',</span>
    <span class="token comment">#             hue_shift_limit=20,</span>
    <span class="token comment">#             sat_shift_limit=30,</span>
    <span class="token comment">#             val_shift_limit=20,</span>
    <span class="token comment">#             p=1.0)</span>
    <span class="token comment">#     ],</span>
    <span class="token comment">#     p=0.1),</span>
    <span class="token comment"># # dict(type='JpegCompression', quality_lower=85, quality_upper=95, p=0.2),</span>
    <span class="token comment">#</span>
    <span class="token comment"># dict(type='ChannelShuffle', p=0.1),</span>
    <span class="token comment"># dict(</span>
    <span class="token comment">#     type='OneOf',</span>
    <span class="token comment">#     transforms=[</span>
    <span class="token comment">#         dict(type='Blur', blur_limit=3, p=1.0),</span>
    <span class="token comment">#         dict(type='MedianBlur', blur_limit=3, p=1.0)</span>
    <span class="token comment">#     ],</span>
    <span class="token comment">#     p=0.1),</span>
<span class="token punctuation">]</span>

train_pipeline <span class="token operator">=</span> <span class="token punctuation">[</span>
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'LoadImageFromFile'</span><span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'LoadAnnotations'</span>, <span class="token assign-left variable">with_bbox</span><span class="token operator">=</span>True<span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Resize'</span>, <span class="token assign-left variable">img_scale</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">4096</span>, <span class="token number">800</span><span class="token punctuation">)</span>, <span class="token punctuation">(</span><span class="token number">4096</span>, <span class="token number">1200</span><span class="token punctuation">)</span><span class="token punctuation">]</span>, <span class="token assign-left variable">keep_ratio</span><span class="token operator">=</span>True<span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'RandomFlip'</span>, <span class="token assign-left variable">flip_ratio</span><span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span>,

    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Pad'</span>, <span class="token assign-left variable">size_divisor</span><span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>
        <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'Albu'</span>,
        <span class="token assign-left variable">transforms</span><span class="token operator">=</span>albu_train_transforms,
        <span class="token assign-left variable">bbox_params</span><span class="token operator">=</span>dict<span class="token punctuation">(</span>
            <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'BboxParams'</span>,
            <span class="token assign-left variable">format</span><span class="token operator">=</span><span class="token string">'pascal_voc'</span>,
            <span class="token assign-left variable">label_fields</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'gt_labels'</span><span class="token punctuation">]</span>,
            <span class="token assign-left variable">min_visibility</span><span class="token operator">=</span><span class="token number">0.0</span>,
            <span class="token assign-left variable">filter_lost_elements</span><span class="token operator">=</span>True<span class="token punctuation">)</span>,
        <span class="token assign-left variable">keymap</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
            <span class="token string">'img'</span><span class="token builtin class-name">:</span> <span class="token string">'image'</span>,
            <span class="token string">'gt_bboxes'</span><span class="token builtin class-name">:</span> <span class="token string">'bboxes'</span>
        <span class="token punctuation">}</span>,
        <span class="token assign-left variable">update_pad_shape</span><span class="token operator">=</span>False,
        <span class="token assign-left variable">skip_img_without_anno</span><span class="token operator">=</span>True<span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Normalize'</span>, **img_norm_cfg<span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'DefaultFormatBundle'</span><span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>
        <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'Collect'</span>,
        <span class="token assign-left variable">keys</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'img'</span>, <span class="token string">'gt_bboxes'</span>, <span class="token string">'gt_labels'</span><span class="token punctuation">]</span>,
        <span class="token assign-left variable">meta_keys</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">'filename'</span>, <span class="token string">'ori_shape'</span>, <span class="token string">'img_shape'</span>, <span class="token string">'img_norm_cfg'</span>,
                   <span class="token string">'pad_shape'</span>, <span class="token string">'scale_factor'</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">]</span>

test_pipeline <span class="token operator">=</span> <span class="token punctuation">[</span>
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'LoadImageFromFile'</span><span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>
        <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'MultiScaleFlipAug'</span>,
        img_scale <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">4096</span>, <span class="token number">1000</span><span class="token punctuation">)</span>,
        <span class="token assign-left variable">flip</span><span class="token operator">=</span>False,
        <span class="token assign-left variable">transforms</span><span class="token operator">=</span><span class="token punctuation">[</span>
            dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Resize'</span>, <span class="token assign-left variable">keep_ratio</span><span class="token operator">=</span>True<span class="token punctuation">)</span>,
            dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'RandomFlip'</span><span class="token punctuation">)</span>,
            dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Normalize'</span>, **img_norm_cfg<span class="token punctuation">)</span>,
            dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Pad'</span>, <span class="token assign-left variable">size_divisor</span><span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span>,
            dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'ImageToTensor'</span>, <span class="token assign-left variable">keys</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>,
            dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Collect'</span>, <span class="token assign-left variable">keys</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>,
        <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>
data <span class="token operator">=</span> dict<span class="token punctuation">(</span>
    <span class="token assign-left variable">imgs_per_gpu</span><span class="token operator">=</span><span class="token number">2</span>,
    <span class="token assign-left variable">workers_per_gpu</span><span class="token operator">=</span><span class="token number">3</span>,
    <span class="token assign-left variable">train</span><span class="token operator">=</span>dict<span class="token punctuation">(</span>
        <span class="token assign-left variable">type</span><span class="token operator">=</span>dataset_type,
        <span class="token assign-left variable">ann_file</span><span class="token operator">=</span>data_root + <span class="token string">'first_pinggai/bottle/annotations/instances_train2017.json'</span>,
        <span class="token assign-left variable">img_prefix</span><span class="token operator">=</span>data_root + <span class="token string">'first_pinggai/bottle/images/train2017/'</span>,
        <span class="token assign-left variable">pipeline</span><span class="token operator">=</span>train_pipeline<span class="token punctuation">)</span>,
    <span class="token assign-left variable">val</span><span class="token operator">=</span>dict<span class="token punctuation">(</span>
        <span class="token assign-left variable">type</span><span class="token operator">=</span>dataset_type,
        <span class="token assign-left variable">ann_file</span><span class="token operator">=</span>data_root + <span class="token string">'first_pinggai/bottle/annotations/instances_val2017.json'</span>,
        <span class="token assign-left variable">img_prefix</span><span class="token operator">=</span>data_root + <span class="token string">'first_pinggai/bottle/images/val2017/'</span>,
        <span class="token assign-left variable">pipeline</span><span class="token operator">=</span>test_pipeline<span class="token punctuation">)</span>,
    <span class="token assign-left variable">test</span><span class="token operator">=</span>dict<span class="token punctuation">(</span>
        <span class="token assign-left variable">type</span><span class="token operator">=</span>dataset_type,
        <span class="token assign-left variable">ann_file</span><span class="token operator">=</span>data_root + <span class="token string">'first_pinggai/bottle/annotations/instances_val2017.json'</span>,
        <span class="token assign-left variable">img_prefix</span><span class="token operator">=</span>data_root + <span class="token string">'first_pinggai/bottle/images/val2017/'</span>,
        <span class="token assign-left variable">pipeline</span><span class="token operator">=</span>test_pipeline<span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
<span class="token comment"># optimizer</span>
optimizer <span class="token operator">=</span> dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'SGD'</span>, <span class="token assign-left variable">lr</span><span class="token operator">=</span> <span class="token number">0.005</span>, <span class="token assign-left variable">momentum</span><span class="token operator">=</span><span class="token number">0.9</span>, <span class="token assign-left variable">weight_decay</span><span class="token operator">=</span><span class="token number">0.0001</span><span class="token punctuation">)</span>
optimizer_config <span class="token operator">=</span> dict<span class="token punctuation">(</span>grad_clip<span class="token operator">=</span>dict<span class="token punctuation">(</span>max_norm<span class="token operator">=</span><span class="token number">35</span>, <span class="token assign-left variable">norm_type</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">))</span>
<span class="token comment"># learning policy</span>
lr_config <span class="token operator">=</span> dict<span class="token punctuation">(</span>
    <span class="token assign-left variable">policy</span><span class="token operator">=</span><span class="token string">'step'</span>,
    <span class="token assign-left variable">warmup</span><span class="token operator">=</span><span class="token string">'linear'</span>,
    <span class="token assign-left variable">warmup_iters</span><span class="token operator">=</span><span class="token number">500</span>,
    <span class="token assign-left variable">warmup_ratio</span><span class="token operator">=</span><span class="token number">1.0</span> / <span class="token number">3</span>,
    <span class="token assign-left variable">step</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">8</span>, <span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
checkpoint_config <span class="token operator">=</span> dict<span class="token punctuation">(</span>interval<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment"># yapf:disable</span>
log_config <span class="token operator">=</span> dict<span class="token punctuation">(</span>
    <span class="token assign-left variable">interval</span><span class="token operator">=</span><span class="token number">50</span>,
    <span class="token assign-left variable">hooks</span><span class="token operator">=</span><span class="token punctuation">[</span>
        dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'TextLoggerHook'</span><span class="token punctuation">)</span>,
        <span class="token comment"># dict(type='TensorboardL0oggerHook')</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># yapf:enable</span>
<span class="token comment"># runtime settings</span>
total_epochs <span class="token operator">=</span> <span class="token number">50</span>
dist_params <span class="token operator">=</span> dict<span class="token punctuation">(</span>backend<span class="token operator">=</span><span class="token string">'nccl'</span><span class="token punctuation">)</span>
log_level <span class="token operator">=</span> <span class="token string">'INFO'</span>
work_dir <span class="token operator">=</span> <span class="token string">'./work_dirs/HRo_cascade50_pinggai_1400'</span>
load_from <span class="token operator">=</span> <span class="token string">'./checkpoints/cascade_rcnn_r50_fpn_1x_20190501-3b6211ab.pth'</span>
resume_from <span class="token operator">=</span> None
workflow <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'train'</span>, <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre> 
<p>这部分代码需要看开头"注意"部分解析，防止修改代码后运行报错。<br> 需要修改两个部分代码：</p> 
<h5><a id="mmdetdatasetspipelinestransformspy_628"></a>mmdet/datasets/pipelines/transforms.py，修改后的源码如下：</h5> 
<p><a href="https://zhuanlan.zhihu.com/p/107922611" rel="nofollow">transforms.py</a></p> 
<pre><code class="prism language-bash"><span class="token function">import</span> inspect
<span class="token function">import</span> albumentations
<span class="token function">import</span> mmcv
<span class="token function">import</span> numpy as np
from albumentations <span class="token function">import</span> Compose
from imagecorruptions <span class="token function">import</span> corrupt
from numpy <span class="token function">import</span> random

from mmdet.core.evaluation.bbox_overlaps <span class="token function">import</span> bbox_overlaps
from <span class="token punctuation">..</span>registry <span class="token function">import</span> PIPELINES


@PIPELINES.register_module
class Resize<span class="token punctuation">(</span>object<span class="token punctuation">)</span>:
    <span class="token string">""</span>"Resize images <span class="token operator">&amp;</span> bbox <span class="token operator">&amp;</span> mask.

    This transform resizes the input image to some scale. Bboxes and masks are
    <span class="token keyword">then</span> resized with the same scale factor. If the input dict contains the key
    <span class="token string">"scale"</span>, <span class="token keyword">then</span> the scale <span class="token keyword">in</span> the input dict is used, otherwise the specified
    scale <span class="token keyword">in</span> the init method is used.

    <span class="token variable"><span class="token variable">`</span>img_scale<span class="token variable">`</span></span> can either be a tuple <span class="token punctuation">(</span>single-scale<span class="token punctuation">)</span> or a list of tuple
    <span class="token punctuation">(</span>multi-scale<span class="token punctuation">)</span>. There are <span class="token number">3</span> multiscale modes:
    - <span class="token variable"><span class="token variable">`</span>ratio_range<span class="token variable">`</span></span> is not None: randomly sample a ratio from the ratio range
        and multiply it with the image scale.
    - <span class="token variable"><span class="token variable">`</span>ratio_range<span class="token variable">`</span></span> is None and <span class="token variable"><span class="token variable">`</span>multiscale_mode<span class="token variable">`</span></span> <span class="token operator">==</span> <span class="token string">"range"</span><span class="token builtin class-name">:</span> randomly sample a
        scale from the a range.
    - <span class="token variable"><span class="token variable">`</span>ratio_range<span class="token variable">`</span></span> is None and <span class="token variable"><span class="token variable">`</span>multiscale_mode<span class="token variable">`</span></span> <span class="token operator">==</span> <span class="token string">"value"</span><span class="token builtin class-name">:</span> randomly sample a
        scale from multiple scales.

    Args:
        img_scale <span class="token punctuation">(</span>tuple or list<span class="token punctuation">[</span>tuple<span class="token punctuation">]</span><span class="token punctuation">)</span>: Images scales <span class="token keyword">for</span> resizing.
        multiscale_mode <span class="token punctuation">(</span>str<span class="token punctuation">)</span>: Either <span class="token string">"range"</span> or <span class="token string">"value"</span><span class="token builtin class-name">.</span>
        ratio_range <span class="token punctuation">(</span>tuple<span class="token punctuation">[</span>float<span class="token punctuation">]</span><span class="token punctuation">)</span>: <span class="token punctuation">(</span>min_ratio, max_ratio<span class="token punctuation">)</span>
        keep_ratio <span class="token punctuation">(</span>bool<span class="token punctuation">)</span>: Whether to keep the aspect ratio when resizing the
            image.
    <span class="token string">""</span>"

    def __init__<span class="token punctuation">(</span>self,
                 <span class="token assign-left variable">img_scale</span><span class="token operator">=</span>None,
                 <span class="token assign-left variable">multiscale_mode</span><span class="token operator">=</span><span class="token string">'range'</span>,
                 <span class="token assign-left variable">ratio_range</span><span class="token operator">=</span>None,
                 <span class="token assign-left variable">keep_ratio</span><span class="token operator">=</span>True<span class="token punctuation">)</span>:
        <span class="token keyword">if</span> img_scale is None:
            self.img_scale <span class="token operator">=</span> None
        else:
            <span class="token keyword">if</span> isinstance<span class="token punctuation">(</span>img_scale, list<span class="token punctuation">)</span>:
                self.img_scale <span class="token operator">=</span> img_scale
            else:
                self.img_scale <span class="token operator">=</span> <span class="token punctuation">[</span>img_scale<span class="token punctuation">]</span>
            assert mmcv.is_list_of<span class="token punctuation">(</span>self.img_scale, tuple<span class="token punctuation">)</span>

        <span class="token keyword">if</span> ratio_range is not None:
            <span class="token comment"># mode 1: given a scale and a range of image ratio</span>
            assert len<span class="token punctuation">(</span>self.img_scale<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span>
        else:
            <span class="token comment"># mode 2: given multiple scales or a range of scales</span>
            assert multiscale_mode <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">'value'</span>, <span class="token string">'range'</span><span class="token punctuation">]</span>

        self.multiscale_mode <span class="token operator">=</span> multiscale_mode
        self.ratio_range <span class="token operator">=</span> ratio_range
        self.keep_ratio <span class="token operator">=</span> keep_ratio

    @staticmethod
    def random_select<span class="token punctuation">(</span>img_scales<span class="token punctuation">)</span>:
        assert mmcv.is_list_of<span class="token punctuation">(</span>img_scales, tuple<span class="token punctuation">)</span>
        scale_idx <span class="token operator">=</span> np.random.randint<span class="token punctuation">(</span>len<span class="token punctuation">(</span>img_scales<span class="token punctuation">))</span>
        img_scale <span class="token operator">=</span> img_scales<span class="token punctuation">[</span>scale_idx<span class="token punctuation">]</span>
        <span class="token builtin class-name">return</span> img_scale, scale_idx

    @staticmethod
    def random_sample<span class="token punctuation">(</span>img_scales<span class="token punctuation">)</span>:
        assert mmcv.is_list_of<span class="token punctuation">(</span>img_scales, tuple<span class="token punctuation">)</span> and len<span class="token punctuation">(</span>img_scales<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span>
        img_scale_long <span class="token operator">=</span> <span class="token punctuation">[</span>max<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token keyword">for</span> <span class="token for-or-select variable">s</span> <span class="token keyword">in</span> img_scales<span class="token punctuation">]</span>
        img_scale_short <span class="token operator">=</span> <span class="token punctuation">[</span>min<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token keyword">for</span> <span class="token for-or-select variable">s</span> <span class="token keyword">in</span> img_scales<span class="token punctuation">]</span>
        long_edge <span class="token operator">=</span> np.random.randint<span class="token punctuation">(</span>
            min<span class="token punctuation">(</span>img_scale_long<span class="token punctuation">)</span>,
            max<span class="token punctuation">(</span>img_scale_long<span class="token punctuation">)</span> + <span class="token number">1</span><span class="token punctuation">)</span>
        short_edge <span class="token operator">=</span> np.random.randint<span class="token punctuation">(</span>
            min<span class="token punctuation">(</span>img_scale_short<span class="token punctuation">)</span>,
            max<span class="token punctuation">(</span>img_scale_short<span class="token punctuation">)</span> + <span class="token number">1</span><span class="token punctuation">)</span>
        img_scale <span class="token operator">=</span> <span class="token punctuation">(</span>long_edge, short_edge<span class="token punctuation">)</span>
        <span class="token builtin class-name">return</span> img_scale, None

    @staticmethod
    def random_sample_ratio<span class="token punctuation">(</span>img_scale, ratio_range<span class="token punctuation">)</span>:
        assert isinstance<span class="token punctuation">(</span>img_scale, tuple<span class="token punctuation">)</span> and len<span class="token punctuation">(</span>img_scale<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span>
        min_ratio, max_ratio <span class="token operator">=</span> ratio_range
        assert min_ratio <span class="token operator">&lt;=</span> max_ratio
        ratio <span class="token operator">=</span> np.random.random_sample<span class="token punctuation">(</span><span class="token punctuation">)</span> * <span class="token punctuation">(</span>max_ratio - min_ratio<span class="token punctuation">)</span> + min_ratio
        scale <span class="token operator">=</span> int<span class="token punctuation">(</span>img_scale<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> * ratio<span class="token punctuation">)</span>, int<span class="token punctuation">(</span>img_scale<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> * ratio<span class="token punctuation">)</span>
        <span class="token builtin class-name">return</span> scale, None

    def _random_scale<span class="token punctuation">(</span>self, results<span class="token punctuation">)</span>:
        <span class="token keyword">if</span> self.ratio_range is not None:
            scale, scale_idx <span class="token operator">=</span> self.random_sample_ratio<span class="token punctuation">(</span>
                self.img_scale<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>, self.ratio_range<span class="token punctuation">)</span>
        <span class="token keyword">elif</span> len<span class="token punctuation">(</span>self.img_scale<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span>:
            scale, scale_idx <span class="token operator">=</span> self.img_scale<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>, <span class="token number">0</span>
        <span class="token keyword">elif</span> self.multiscale_mode <span class="token operator">==</span> <span class="token string">'range'</span><span class="token builtin class-name">:</span>
            scale, scale_idx <span class="token operator">=</span> self.random_sample<span class="token punctuation">(</span>self.img_scale<span class="token punctuation">)</span>
        <span class="token keyword">elif</span> self.multiscale_mode <span class="token operator">==</span> <span class="token string">'value'</span><span class="token builtin class-name">:</span>
            scale, scale_idx <span class="token operator">=</span> self.random_select<span class="token punctuation">(</span>self.img_scale<span class="token punctuation">)</span>
        else:
            raise NotImplementedError

        results<span class="token punctuation">[</span><span class="token string">'scale'</span><span class="token punctuation">]</span> <span class="token operator">=</span> scale
        results<span class="token punctuation">[</span><span class="token string">'scale_idx'</span><span class="token punctuation">]</span> <span class="token operator">=</span> scale_idx

    def _resize_img<span class="token punctuation">(</span>self, results<span class="token punctuation">)</span>:
        <span class="token keyword">if</span> results<span class="token punctuation">[</span><span class="token string">'concat'</span><span class="token punctuation">]</span>:
            img_raw, img_temp <span class="token operator">=</span> results<span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>:, :, :3<span class="token punctuation">]</span>, results<span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>:, :, <span class="token number">3</span>:<span class="token punctuation">]</span>
            <span class="token keyword">if</span> self.keep_ratio:
                img_raw, scale_factor <span class="token operator">=</span> mmcv.imrescale<span class="token punctuation">(</span>
                    img_raw, results<span class="token punctuation">[</span><span class="token string">'scale'</span><span class="token punctuation">]</span>, <span class="token assign-left variable">return_scale</span><span class="token operator">=</span>True<span class="token punctuation">)</span>
                img_temp, scale_factor <span class="token operator">=</span> mmcv.imrescale<span class="token punctuation">(</span>
                    img_temp, results<span class="token punctuation">[</span><span class="token string">'scale'</span><span class="token punctuation">]</span>, <span class="token assign-left variable">return_scale</span><span class="token operator">=</span>True<span class="token punctuation">)</span>
            else:
                img_raw, w_scale, h_scale <span class="token operator">=</span> mmcv.imresize<span class="token punctuation">(</span>
                    img_raw, results<span class="token punctuation">[</span><span class="token string">'scale'</span><span class="token punctuation">]</span>, <span class="token assign-left variable">return_scale</span><span class="token operator">=</span>True<span class="token punctuation">)</span>
                img_temp, w_scale, h_scale <span class="token operator">=</span> mmcv.imresize<span class="token punctuation">(</span>
                    img_temp, results<span class="token punctuation">[</span><span class="token string">'scale'</span><span class="token punctuation">]</span>, <span class="token assign-left variable">return_scale</span><span class="token operator">=</span>True<span class="token punctuation">)</span>
                scale_factor <span class="token operator">=</span> np.array<span class="token punctuation">(</span><span class="token punctuation">[</span>w_scale, h_scale, w_scale, h_scale<span class="token punctuation">]</span>,
                                        <span class="token assign-left variable">dtype</span><span class="token operator">=</span>np.float32<span class="token punctuation">)</span>
            results<span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span> <span class="token operator">=</span> np.concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span>img_raw, img_temp<span class="token punctuation">]</span>, <span class="token assign-left variable">axis</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
            results<span class="token punctuation">[</span><span class="token string">'img_shape'</span><span class="token punctuation">]</span> <span class="token operator">=</span> img_raw.shape
            results<span class="token punctuation">[</span><span class="token string">'pad_shape'</span><span class="token punctuation">]</span> <span class="token operator">=</span> img_raw.shape  <span class="token comment"># in case that there is no padding</span>
            results<span class="token punctuation">[</span><span class="token string">'scale_factor'</span><span class="token punctuation">]</span> <span class="token operator">=</span> scale_factor
            results<span class="token punctuation">[</span><span class="token string">'keep_ratio'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self.keep_ratio
        else:
            <span class="token keyword">if</span> self.keep_ratio:
                img, scale_factor <span class="token operator">=</span> mmcv.imrescale<span class="token punctuation">(</span>
                    results<span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span>, results<span class="token punctuation">[</span><span class="token string">'scale'</span><span class="token punctuation">]</span>, <span class="token assign-left variable">return_scale</span><span class="token operator">=</span>True<span class="token punctuation">)</span>
            else:
                img, w_scale, h_scale <span class="token operator">=</span> mmcv.imresize<span class="token punctuation">(</span>
                    results<span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span>, results<span class="token punctuation">[</span><span class="token string">'scale'</span><span class="token punctuation">]</span>, <span class="token assign-left variable">return_scale</span><span class="token operator">=</span>True<span class="token punctuation">)</span>
                scale_factor <span class="token operator">=</span> np.array<span class="token punctuation">(</span><span class="token punctuation">[</span>w_scale, h_scale, w_scale, h_scale<span class="token punctuation">]</span>,
                                        <span class="token assign-left variable">dtype</span><span class="token operator">=</span>np.float32<span class="token punctuation">)</span>
            results<span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span> <span class="token operator">=</span> img
            results<span class="token punctuation">[</span><span class="token string">'img_shape'</span><span class="token punctuation">]</span> <span class="token operator">=</span> img.shape
            results<span class="token punctuation">[</span><span class="token string">'pad_shape'</span><span class="token punctuation">]</span> <span class="token operator">=</span> img.shape  <span class="token comment"># in case that there is no padding</span>
            results<span class="token punctuation">[</span><span class="token string">'scale_factor'</span><span class="token punctuation">]</span> <span class="token operator">=</span> scale_factor
            results<span class="token punctuation">[</span><span class="token string">'keep_ratio'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self.keep_ratio

    def _resize_bboxes<span class="token punctuation">(</span>self, results<span class="token punctuation">)</span>:
        img_shape <span class="token operator">=</span> results<span class="token punctuation">[</span><span class="token string">'img_shape'</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> <span class="token for-or-select variable">key</span> <span class="token keyword">in</span> results.get<span class="token punctuation">(</span><span class="token string">'bbox_fields'</span>, <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>:
            bboxes <span class="token operator">=</span> results<span class="token punctuation">[</span>key<span class="token punctuation">]</span> * results<span class="token punctuation">[</span><span class="token string">'scale_factor'</span><span class="token punctuation">]</span>
            bboxes<span class="token punctuation">[</span>:, <span class="token number">0</span>::2<span class="token punctuation">]</span> <span class="token operator">=</span> np.clip<span class="token punctuation">(</span>bboxes<span class="token punctuation">[</span>:, <span class="token number">0</span>::2<span class="token punctuation">]</span>, <span class="token number">0</span>, img_shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> - <span class="token number">1</span><span class="token punctuation">)</span>
            bboxes<span class="token punctuation">[</span>:, <span class="token number">1</span>::2<span class="token punctuation">]</span> <span class="token operator">=</span> np.clip<span class="token punctuation">(</span>bboxes<span class="token punctuation">[</span>:, <span class="token number">1</span>::2<span class="token punctuation">]</span>, <span class="token number">0</span>, img_shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> - <span class="token number">1</span><span class="token punctuation">)</span>
            results<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> bboxes

    def _resize_masks<span class="token punctuation">(</span>self, results<span class="token punctuation">)</span>:
        <span class="token keyword">for</span> <span class="token for-or-select variable">key</span> <span class="token keyword">in</span> results.get<span class="token punctuation">(</span><span class="token string">'mask_fields'</span>, <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>:
            <span class="token keyword">if</span> results<span class="token punctuation">[</span>key<span class="token punctuation">]</span> is None:
                <span class="token builtin class-name">continue</span>
            <span class="token keyword">if</span> self.keep_ratio:
                masks <span class="token operator">=</span> <span class="token punctuation">[</span>
                    mmcv.imrescale<span class="token punctuation">(</span>
                        mask, results<span class="token punctuation">[</span><span class="token string">'scale_factor'</span><span class="token punctuation">]</span>, <span class="token assign-left variable">interpolation</span><span class="token operator">=</span><span class="token string">'nearest'</span><span class="token punctuation">)</span>
                    <span class="token keyword">for</span> <span class="token for-or-select variable">mask</span> <span class="token keyword">in</span> results<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
                <span class="token punctuation">]</span>
            else:
                mask_size <span class="token operator">=</span> <span class="token punctuation">(</span>results<span class="token punctuation">[</span><span class="token string">'img_shape'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>, results<span class="token punctuation">[</span><span class="token string">'img_shape'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                masks <span class="token operator">=</span> <span class="token punctuation">[</span>
                    mmcv.imresize<span class="token punctuation">(</span>mask, mask_size, <span class="token assign-left variable">interpolation</span><span class="token operator">=</span><span class="token string">'nearest'</span><span class="token punctuation">)</span>
                    <span class="token keyword">for</span> <span class="token for-or-select variable">mask</span> <span class="token keyword">in</span> results<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
                <span class="token punctuation">]</span>
            results<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> masks

    def _resize_seg<span class="token punctuation">(</span>self, results<span class="token punctuation">)</span>:
        <span class="token keyword">for</span> <span class="token for-or-select variable">key</span> <span class="token keyword">in</span> results.get<span class="token punctuation">(</span><span class="token string">'seg_fields'</span>, <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>:
            <span class="token keyword">if</span> self.keep_ratio:
                gt_seg <span class="token operator">=</span> mmcv.imrescale<span class="token punctuation">(</span>
                    results<span class="token punctuation">[</span>key<span class="token punctuation">]</span>, results<span class="token punctuation">[</span><span class="token string">'scale'</span><span class="token punctuation">]</span>, <span class="token assign-left variable">interpolation</span><span class="token operator">=</span><span class="token string">'nearest'</span><span class="token punctuation">)</span>
            else:
                gt_seg <span class="token operator">=</span> mmcv.imresize<span class="token punctuation">(</span>
                    results<span class="token punctuation">[</span>key<span class="token punctuation">]</span>, results<span class="token punctuation">[</span><span class="token string">'scale'</span><span class="token punctuation">]</span>, <span class="token assign-left variable">interpolation</span><span class="token operator">=</span><span class="token string">'nearest'</span><span class="token punctuation">)</span>
            results<span class="token punctuation">[</span><span class="token string">'gt_semantic_seg'</span><span class="token punctuation">]</span> <span class="token operator">=</span> gt_seg

    def __call__<span class="token punctuation">(</span>self, results<span class="token punctuation">)</span>:
        <span class="token keyword">if</span> <span class="token string">'scale'</span> not <span class="token keyword">in</span> results:
            self._random_scale<span class="token punctuation">(</span>results<span class="token punctuation">)</span>
        self._resize_img<span class="token punctuation">(</span>results<span class="token punctuation">)</span>
        self._resize_bboxes<span class="token punctuation">(</span>results<span class="token punctuation">)</span>
        self._resize_masks<span class="token punctuation">(</span>results<span class="token punctuation">)</span>
        self._resize_seg<span class="token punctuation">(</span>results<span class="token punctuation">)</span>
        <span class="token builtin class-name">return</span> results

    def __repr__<span class="token punctuation">(</span>self<span class="token punctuation">)</span>:
        repr_str <span class="token operator">=</span> self.__class__.__name__
        repr_str <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token string">'(img_scale={}, multiscale_mode={}, ratio_range={}, '</span>
                     <span class="token string">'keep_ratio={})'</span><span class="token punctuation">)</span>.format<span class="token punctuation">(</span>self.img_scale,
                                              self.multiscale_mode,
                                              self.ratio_range,
                                              self.keep_ratio<span class="token punctuation">)</span>
        <span class="token builtin class-name">return</span> repr_str


@PIPELINES.register_module
class RandomFlip<span class="token punctuation">(</span>object<span class="token punctuation">)</span>:
    <span class="token string">""</span>"Flip the image <span class="token operator">&amp;</span> bbox <span class="token operator">&amp;</span> mask.

    If the input dict contains the key <span class="token string">"flip"</span>, <span class="token keyword">then</span> the flag will be used,
    otherwise it will be randomly decided by a ratio specified <span class="token keyword">in</span> the init
    method.

    Args:
        flip_ratio <span class="token punctuation">(</span>float, optional<span class="token punctuation">)</span>: The flipping probability.
    <span class="token string">""</span>"

    def __init__<span class="token punctuation">(</span>self, <span class="token assign-left variable">flip_ratio</span><span class="token operator">=</span>None, <span class="token assign-left variable">direction</span><span class="token operator">=</span><span class="token string">'horizontal'</span><span class="token punctuation">)</span>:
        self.flip_ratio <span class="token operator">=</span> flip_ratio
        self.direction <span class="token operator">=</span> direction
        <span class="token keyword">if</span> flip_ratio is not None:
            assert flip_ratio <span class="token operator">&gt;=</span> <span class="token number">0</span> and flip_ratio <span class="token operator">&lt;=</span> <span class="token number">1</span>
        assert direction <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">'horizontal'</span>, <span class="token string">'vertical'</span><span class="token punctuation">]</span>

    def bbox_flip<span class="token punctuation">(</span>self, bboxes, img_shape, direction<span class="token punctuation">)</span>:
        <span class="token string">""</span>"Flip bboxes horizontally.

        Args:
            bboxes<span class="token punctuation">(</span>ndarray<span class="token punctuation">)</span>: shape <span class="token punctuation">(</span><span class="token punctuation">..</span>., <span class="token number">4</span>*k<span class="token punctuation">)</span>
            img_shape<span class="token punctuation">(</span>tuple<span class="token punctuation">)</span>: <span class="token punctuation">(</span>height, width<span class="token punctuation">)</span>
        <span class="token string">""</span>"
        assert bboxes.shape<span class="token punctuation">[</span>-1<span class="token punctuation">]</span> % <span class="token number">4</span> <span class="token operator">==</span> <span class="token number">0</span>
        flipped <span class="token operator">=</span> bboxes.copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> direction <span class="token operator">==</span> <span class="token string">'horizontal'</span><span class="token builtin class-name">:</span>
            w <span class="token operator">=</span> img_shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
            flipped<span class="token punctuation">[</span><span class="token punctuation">..</span>., <span class="token number">0</span>::4<span class="token punctuation">]</span> <span class="token operator">=</span> w - bboxes<span class="token punctuation">[</span><span class="token punctuation">..</span>., <span class="token number">2</span>::4<span class="token punctuation">]</span> - <span class="token number">1</span>
            flipped<span class="token punctuation">[</span><span class="token punctuation">..</span>., <span class="token number">2</span>::4<span class="token punctuation">]</span> <span class="token operator">=</span> w - bboxes<span class="token punctuation">[</span><span class="token punctuation">..</span>., <span class="token number">0</span>::4<span class="token punctuation">]</span> - <span class="token number">1</span>
        <span class="token keyword">elif</span> direction <span class="token operator">==</span> <span class="token string">'vertical'</span><span class="token builtin class-name">:</span>
            h <span class="token operator">=</span> img_shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            flipped<span class="token punctuation">[</span><span class="token punctuation">..</span>., <span class="token number">1</span>::4<span class="token punctuation">]</span> <span class="token operator">=</span> h - bboxes<span class="token punctuation">[</span><span class="token punctuation">..</span>., <span class="token number">3</span>::4<span class="token punctuation">]</span> - <span class="token number">1</span>
            flipped<span class="token punctuation">[</span><span class="token punctuation">..</span>., <span class="token number">3</span>::4<span class="token punctuation">]</span> <span class="token operator">=</span> h - bboxes<span class="token punctuation">[</span><span class="token punctuation">..</span>., <span class="token number">1</span>::4<span class="token punctuation">]</span> - <span class="token number">1</span>
        else:
            raise ValueError<span class="token punctuation">(</span>
                <span class="token string">'Invalid flipping direction "{}"'</span>.format<span class="token punctuation">(</span>direction<span class="token punctuation">))</span>
        <span class="token builtin class-name">return</span> flipped

    def __call__<span class="token punctuation">(</span>self, results<span class="token punctuation">)</span>:
        <span class="token keyword">if</span> <span class="token string">'flip'</span> not <span class="token keyword">in</span> results:
            flip <span class="token operator">=</span> True <span class="token keyword">if</span> np.random.rand<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> self.flip_ratio <span class="token keyword">else</span> False
            results<span class="token punctuation">[</span><span class="token string">'flip'</span><span class="token punctuation">]</span> <span class="token operator">=</span> flip
        <span class="token keyword">if</span> <span class="token string">'flip_direction'</span> not <span class="token keyword">in</span> results:
            results<span class="token punctuation">[</span><span class="token string">'flip_direction'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self.direction
        <span class="token keyword">if</span> results<span class="token punctuation">[</span><span class="token string">'flip'</span><span class="token punctuation">]</span>:
            <span class="token comment"># flip image</span>
            results<span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span> <span class="token operator">=</span> mmcv.imflip<span class="token punctuation">(</span>
                results<span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span>, <span class="token assign-left variable">direction</span><span class="token operator">=</span>results<span class="token punctuation">[</span><span class="token string">'flip_direction'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token comment"># flip bboxes</span>
            <span class="token keyword">for</span> <span class="token for-or-select variable">key</span> <span class="token keyword">in</span> results.get<span class="token punctuation">(</span><span class="token string">'bbox_fields'</span>, <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>:
                results<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> self.bbox_flip<span class="token punctuation">(</span>results<span class="token punctuation">[</span>key<span class="token punctuation">]</span>,
                                              results<span class="token punctuation">[</span><span class="token string">'img_shape'</span><span class="token punctuation">]</span>,
                                              results<span class="token punctuation">[</span><span class="token string">'flip_direction'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token comment"># flip masks</span>
            <span class="token keyword">for</span> <span class="token for-or-select variable">key</span> <span class="token keyword">in</span> results.get<span class="token punctuation">(</span><span class="token string">'mask_fields'</span>, <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>:
                results<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
                    mmcv.imflip<span class="token punctuation">(</span>mask, <span class="token assign-left variable">direction</span><span class="token operator">=</span>results<span class="token punctuation">[</span><span class="token string">'flip_direction'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                    <span class="token keyword">for</span> <span class="token for-or-select variable">mask</span> <span class="token keyword">in</span> results<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
                <span class="token punctuation">]</span>

            <span class="token comment"># flip segs</span>
            <span class="token keyword">for</span> <span class="token for-or-select variable">key</span> <span class="token keyword">in</span> results.get<span class="token punctuation">(</span><span class="token string">'seg_fields'</span>, <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>:
                results<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> mmcv.imflip<span class="token punctuation">(</span>
                    results<span class="token punctuation">[</span>key<span class="token punctuation">]</span>, <span class="token assign-left variable">direction</span><span class="token operator">=</span>results<span class="token punctuation">[</span><span class="token string">'flip_direction'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token builtin class-name">return</span> results

    def __repr__<span class="token punctuation">(</span>self<span class="token punctuation">)</span>:
        <span class="token builtin class-name">return</span> self.__class__.__name__ + <span class="token string">'(flip_ratio={})'</span>.format<span class="token punctuation">(</span>
            self.flip_ratio<span class="token punctuation">)</span>


@PIPELINES.register_module
class Pad<span class="token punctuation">(</span>object<span class="token punctuation">)</span>:
    <span class="token string">""</span>"Pad the image <span class="token operator">&amp;</span> mask.

    There are two padding modes: <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> pad to a fixed size and <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> pad to the
    minimum size that is divisible by some number.

    Args:
        size <span class="token punctuation">(</span>tuple, optional<span class="token punctuation">)</span>: Fixed padding size.
        size_divisor <span class="token punctuation">(</span>int, optional<span class="token punctuation">)</span>: The divisor of padded size.
        pad_val <span class="token punctuation">(</span>float, optional<span class="token punctuation">)</span>: Padding value, <span class="token number">0</span> by default.
    <span class="token string">""</span>"

    def __init__<span class="token punctuation">(</span>self, <span class="token assign-left variable">size</span><span class="token operator">=</span>None, <span class="token assign-left variable">size_divisor</span><span class="token operator">=</span>None, <span class="token assign-left variable">pad_val</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>:
        self.size <span class="token operator">=</span> size
        self.size_divisor <span class="token operator">=</span> size_divisor
        self.pad_val <span class="token operator">=</span> pad_val
        <span class="token comment"># only one of size and size_divisor should be valid</span>
        assert size is not None or size_divisor is not None
        assert size is None or size_divisor is None

    def _pad_img<span class="token punctuation">(</span>self, results<span class="token punctuation">)</span>:
        <span class="token keyword">if</span> results<span class="token punctuation">[</span><span class="token string">'concat'</span><span class="token punctuation">]</span>:
            img_raw, img_temp <span class="token operator">=</span> results<span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>:, :, :3<span class="token punctuation">]</span>, results<span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>:, :, <span class="token number">3</span>:<span class="token punctuation">]</span>
            <span class="token keyword">if</span> self.size is not None:
                padded_img_raw <span class="token operator">=</span> mmcv.impad<span class="token punctuation">(</span>img_raw, self.size<span class="token punctuation">)</span>
                padded_img_temp <span class="token operator">=</span> mmcv.impad<span class="token punctuation">(</span>img_temp, self.size<span class="token punctuation">)</span>
            <span class="token keyword">elif</span> self.size_divisor is not None:
                padded_img_raw <span class="token operator">=</span> mmcv.impad_to_multiple<span class="token punctuation">(</span>
                    img_raw, self.size_divisor, <span class="token assign-left variable">pad_val</span><span class="token operator">=</span>self.pad_val<span class="token punctuation">)</span>
                padded_img_temp <span class="token operator">=</span> mmcv.impad_to_multiple<span class="token punctuation">(</span>
                    img_temp, self.size_divisor, <span class="token assign-left variable">pad_val</span><span class="token operator">=</span>self.pad_val<span class="token punctuation">)</span>
            results<span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span> <span class="token operator">=</span> np.concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span>padded_img_raw, padded_img_temp<span class="token punctuation">]</span>, <span class="token assign-left variable">axis</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
            results<span class="token punctuation">[</span><span class="token string">'pad_shape'</span><span class="token punctuation">]</span> <span class="token operator">=</span> padded_img_raw.shape
            results<span class="token punctuation">[</span><span class="token string">'pad_fixed_size'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self.size
            results<span class="token punctuation">[</span><span class="token string">'pad_size_divisor'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self.size_divisor
        else:
            <span class="token keyword">if</span> self.size is not None:
                padded_img <span class="token operator">=</span> mmcv.impad<span class="token punctuation">(</span>results<span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span>, self.size<span class="token punctuation">)</span>
            <span class="token keyword">elif</span> self.size_divisor is not None:
                padded_img <span class="token operator">=</span> mmcv.impad_to_multiple<span class="token punctuation">(</span>
                    results<span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span>, self.size_divisor, <span class="token assign-left variable">pad_val</span><span class="token operator">=</span>self.pad_val<span class="token punctuation">)</span>
            results<span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span> <span class="token operator">=</span> padded_img
            results<span class="token punctuation">[</span><span class="token string">'pad_shape'</span><span class="token punctuation">]</span> <span class="token operator">=</span> padded_img.shape
            results<span class="token punctuation">[</span><span class="token string">'pad_fixed_size'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self.size
            results<span class="token punctuation">[</span><span class="token string">'pad_size_divisor'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self.size_divisor

    def _pad_masks<span class="token punctuation">(</span>self, results<span class="token punctuation">)</span>:
        pad_shape <span class="token operator">=</span> results<span class="token punctuation">[</span><span class="token string">'pad_shape'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>:2<span class="token punctuation">]</span>
        <span class="token keyword">for</span> <span class="token for-or-select variable">key</span> <span class="token keyword">in</span> results.get<span class="token punctuation">(</span><span class="token string">'mask_fields'</span>, <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>:
            padded_masks <span class="token operator">=</span> <span class="token punctuation">[</span>
                mmcv.impad<span class="token punctuation">(</span>mask, pad_shape, <span class="token assign-left variable">pad_val</span><span class="token operator">=</span>self.pad_val<span class="token punctuation">)</span>
                <span class="token keyword">for</span> <span class="token for-or-select variable">mask</span> <span class="token keyword">in</span> results<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
            <span class="token punctuation">]</span>
            <span class="token keyword">if</span> padded_masks:
                results<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> np.stack<span class="token punctuation">(</span>padded_masks, <span class="token assign-left variable">axis</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            else:
                results<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> np.empty<span class="token variable"><span class="token punctuation">((</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">)</span> <span class="token operator">+</span> pad_shape<span class="token punctuation">,</span> dtype<span class="token operator">=</span>np.uint8<span class="token punctuation">)</span>

    def _pad_seg<span class="token punctuation">(</span>self<span class="token punctuation">,</span> results<span class="token punctuation">)</span><span class="token operator">:</span>
        for key in results.get<span class="token punctuation">(</span>'seg_fields'<span class="token punctuation">,</span> []<span class="token punctuation">)</span><span class="token operator">:</span>
            results[key] <span class="token operator">=</span> mmcv.impad<span class="token punctuation">(</span>results[key]<span class="token punctuation">,</span> results['pad_shape'][<span class="token operator">:</span><span class="token number">2</span>]<span class="token punctuation">)</span>

    def __call__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> results<span class="token punctuation">)</span><span class="token operator">:</span>
        self._pad_img<span class="token punctuation">(</span>results<span class="token punctuation">)</span>
        self._pad_masks<span class="token punctuation">(</span>results<span class="token punctuation">)</span>
        self._pad_seg<span class="token punctuation">(</span>results<span class="token punctuation">)</span>
        return results

    def __repr__<span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token operator">:</span>
        repr_str <span class="token operator">=</span> self.__class__.__name__
        repr_str <span class="token operator">+=</span> '<span class="token punctuation">(</span>size<span class="token operator">=</span>{}<span class="token punctuation">,</span> size_divisor<span class="token operator">=</span>{}<span class="token punctuation">,</span> pad_val<span class="token operator">=</span>{}<span class="token punctuation">)</span>'.format<span class="token punctuation">(</span>
            self.size<span class="token punctuation">,</span> self.size_divisor<span class="token punctuation">,</span> self.pad_val<span class="token punctuation">)</span>
        return repr_str


@PIPELINES.register_module
class Normalize<span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token operator">:</span>
    """Normalize the image.

    Args<span class="token operator">:</span>
        mean <span class="token punctuation">(</span>sequence<span class="token punctuation">)</span><span class="token operator">:</span> Mean values of <span class="token number">3</span> channels.
        std <span class="token punctuation">(</span>sequence<span class="token punctuation">)</span><span class="token operator">:</span> Std values of <span class="token number">3</span> channels.
        to_rgb <span class="token punctuation">(</span>bool<span class="token punctuation">)</span><span class="token operator">:</span> Whether to convert the image from BGR to RGB<span class="token punctuation">,</span>
            default is true.
    """

    def __init__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> mean<span class="token punctuation">,</span> std<span class="token punctuation">,</span> to_rgb<span class="token operator">=</span>True<span class="token punctuation">)</span><span class="token operator">:</span>
        self.mean <span class="token operator">=</span> np.array<span class="token punctuation">(</span>mean<span class="token punctuation">,</span> dtype<span class="token operator">=</span>np.float32<span class="token punctuation">)</span>
        self.std <span class="token operator">=</span> np.array<span class="token punctuation">(</span>std<span class="token punctuation">,</span> dtype<span class="token operator">=</span>np.float32<span class="token punctuation">)</span>
        self.to_rgb <span class="token operator">=</span> to_rgb

    def __call__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> results<span class="token punctuation">)</span><span class="token operator">:</span>
        if results['concat']<span class="token operator">:</span>
            img_raw<span class="token punctuation">,</span> img_temp <span class="token operator">=</span> results['img'][<span class="token operator">:</span><span class="token punctuation">,</span> <span class="token operator">:</span><span class="token punctuation">,</span> <span class="token operator">:</span><span class="token number">3</span>]<span class="token punctuation">,</span> results['img'][<span class="token operator">:</span><span class="token punctuation">,</span> <span class="token operator">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token operator">:</span>]
            img_raw <span class="token operator">=</span> mmcv.imnormalize<span class="token punctuation">(</span>img_raw<span class="token punctuation">,</span> self.mean<span class="token punctuation">,</span> self.std<span class="token punctuation">,</span>
                                       self.to_rgb<span class="token punctuation">)</span>
            img_temp <span class="token operator">=</span> mmcv.imnormalize<span class="token punctuation">(</span>img_temp<span class="token punctuation">,</span> self.mean<span class="token punctuation">,</span> self.std<span class="token punctuation">,</span>
                                        self.to_rgb<span class="token punctuation">)</span>
            results['img'] <span class="token operator">=</span> np.concatenate<span class="token punctuation">(</span>[img_raw<span class="token punctuation">,</span> img_temp]<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
            results['img_norm_cfg'] <span class="token operator">=</span> dict<span class="token punctuation">(</span>
                mean<span class="token operator">=</span>self.mean<span class="token punctuation">,</span> std<span class="token operator">=</span>self.std<span class="token punctuation">,</span> to_rgb<span class="token operator">=</span>self.to_rgb<span class="token punctuation">)</span>
        else<span class="token operator">:</span>
            results['img'] <span class="token operator">=</span> mmcv.imnormalize<span class="token punctuation">(</span>results['img']<span class="token punctuation">,</span> self.mean<span class="token punctuation">,</span> self.std<span class="token punctuation">,</span>
                                              self.to_rgb<span class="token punctuation">)</span>
            results['img_norm_cfg'] <span class="token operator">=</span> dict<span class="token punctuation">(</span>
                mean<span class="token operator">=</span>self.mean<span class="token punctuation">,</span> std<span class="token operator">=</span>self.std<span class="token punctuation">,</span> to_rgb<span class="token operator">=</span>self.to_rgb<span class="token punctuation">)</span>
        return results

    def __repr__<span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token operator">:</span>
        repr_str <span class="token operator">=</span> self.__class__.__name__
        repr_str <span class="token operator">+=</span> '<span class="token punctuation">(</span>mean<span class="token operator">=</span>{}<span class="token punctuation">,</span> std<span class="token operator">=</span>{}<span class="token punctuation">,</span> to_rgb<span class="token operator">=</span>{}<span class="token punctuation">)</span>'.format<span class="token punctuation">(</span>
            self.mean<span class="token punctuation">,</span> self.std<span class="token punctuation">,</span> self.to_rgb<span class="token punctuation">)</span>
        return repr_str


@PIPELINES.register_module
class RandomCrop<span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token operator">:</span>
    """Random crop the image <span class="token operator">&amp;</span> bboxes <span class="token operator">&amp;</span> masks.

    Args<span class="token operator">:</span>
        crop_size <span class="token punctuation">(</span>tuple<span class="token punctuation">)</span><span class="token operator">:</span> Expected size after cropping<span class="token punctuation">,</span> <span class="token punctuation">(</span>h<span class="token punctuation">,</span> w<span class="token punctuation">)</span>.
    """

    def __init__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> crop_size<span class="token punctuation">)</span><span class="token operator">:</span>
        self.crop_size <span class="token operator">=</span> crop_size

    def __call__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> results<span class="token punctuation">)</span><span class="token operator">:</span>
        img <span class="token operator">=</span> results['img']
        margin_h <span class="token operator">=</span> max<span class="token punctuation">(</span>img.shape[<span class="token number">0</span>] <span class="token operator">-</span> self.crop_size[<span class="token number">0</span>]<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        margin_w <span class="token operator">=</span> max<span class="token punctuation">(</span>img.shape[<span class="token number">1</span>] <span class="token operator">-</span> self.crop_size[<span class="token number">1</span>]<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        offset_h <span class="token operator">=</span> np.random.randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> margin_h <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
        offset_w <span class="token operator">=</span> np.random.randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> margin_w <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
        crop_y1<span class="token punctuation">,</span> crop_y2 <span class="token operator">=</span> offset_h<span class="token punctuation">,</span> offset_h <span class="token operator">+</span> self.crop_size[<span class="token number">0</span>]
        crop_x1<span class="token punctuation">,</span> crop_x2 <span class="token operator">=</span> offset_w<span class="token punctuation">,</span> offset_w <span class="token operator">+</span> self.crop_size[<span class="token number">1</span>]

        # crop the image
        img <span class="token operator">=</span> img[crop_y1<span class="token operator">:</span>crop_y2<span class="token punctuation">,</span> crop_x1<span class="token operator">:</span>crop_x2<span class="token punctuation">,</span> <span class="token operator">:</span>]
        img_shape <span class="token operator">=</span> img.shape
        results['img'] <span class="token operator">=</span> img
        results['img_shape'] <span class="token operator">=</span> img_shape

        # crop bboxes accordingly and clip to the image boundary
        for key in results.get<span class="token punctuation">(</span>'bbox_fields'<span class="token punctuation">,</span> []<span class="token punctuation">)</span><span class="token operator">:</span>
            bbox_offset <span class="token operator">=</span> np.array<span class="token punctuation">(</span>[offset_w<span class="token punctuation">,</span> offset_h<span class="token punctuation">,</span> offset_w<span class="token punctuation">,</span> offset_h]<span class="token punctuation">,</span>
                                   dtype<span class="token operator">=</span>np.float32<span class="token punctuation">)</span>
            bboxes <span class="token operator">=</span> results[key] <span class="token operator">-</span> bbox_offset
            bboxes[<span class="token operator">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token operator">:</span><span class="token operator">:</span><span class="token number">2</span>] <span class="token operator">=</span> np.clip<span class="token punctuation">(</span>bboxes[<span class="token operator">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token operator">:</span><span class="token operator">:</span><span class="token number">2</span>]<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> img_shape[<span class="token number">1</span>] <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
            bboxes[<span class="token operator">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token operator">:</span><span class="token operator">:</span><span class="token number">2</span>] <span class="token operator">=</span> np.clip<span class="token punctuation">(</span>bboxes[<span class="token operator">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token operator">:</span><span class="token operator">:</span><span class="token number">2</span>]<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> img_shape[<span class="token number">0</span>] <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
            results[key] <span class="token operator">=</span> bboxes

        # crop semantic seg
        for key in results.get<span class="token punctuation">(</span>'seg_fields'<span class="token punctuation">,</span> []<span class="token punctuation">)</span><span class="token operator">:</span>
            results[key] <span class="token operator">=</span> results[key][crop_y1<span class="token operator">:</span>crop_y2<span class="token punctuation">,</span> crop_x1<span class="token operator">:</span>crop_x2]

        # filter out the gt bboxes that are completely cropped
        if 'gt_bboxes' in results<span class="token operator">:</span>
            gt_bboxes <span class="token operator">=</span> results['gt_bboxes']
            valid_inds <span class="token operator">=</span> <span class="token punctuation">(</span>gt_bboxes[<span class="token operator">:</span><span class="token punctuation">,</span> <span class="token number">2</span>] <span class="token operator">&gt;</span> gt_bboxes[<span class="token operator">:</span><span class="token punctuation">,</span> <span class="token number">0</span>]<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>
                gt_bboxes[<span class="token operator">:</span><span class="token punctuation">,</span> <span class="token number">3</span>] <span class="token operator">&gt;</span> gt_bboxes[<span class="token operator">:</span><span class="token punctuation">,</span> <span class="token number">1</span>]<span class="token punctuation">)</span>
            # if no gt bbox remains after cropping<span class="token punctuation">,</span> just skip this image
            if not np.any<span class="token punctuation">(</span>valid_inds<span class="token punctuation">)</span><span class="token operator">:</span>
                return None
            results['gt_bboxes'] <span class="token operator">=</span> gt_bboxes[valid_inds<span class="token punctuation">,</span> <span class="token operator">:</span>]
            if 'gt_labels' in results<span class="token operator">:</span>
                results['gt_labels'] <span class="token operator">=</span> results['gt_labels'][valid_inds]

            # filter and crop the masks
            if 'gt_masks' in results<span class="token operator">:</span>
                valid_gt_masks <span class="token operator">=</span> []
                for i in np.where<span class="token punctuation">(</span>valid_inds<span class="token punctuation">)</span>[<span class="token number">0</span>]<span class="token operator">:</span>
                    gt_mask <span class="token operator">=</span> results['gt_masks'][i][crop_y1<span class="token operator">:</span>crop_y2<span class="token punctuation">,</span>
                                                     crop_x1<span class="token operator">:</span>crop_x2]
                    valid_gt_masks.append<span class="token punctuation">(</span>gt_mask<span class="token punctuation">)</span>
                results['gt_masks'] <span class="token operator">=</span> valid_gt_masks

        return results

    def __repr__<span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token operator">:</span>
        return self.__class__.__name__ <span class="token operator">+</span> '<span class="token punctuation">(</span>crop_size<span class="token operator">=</span>{}<span class="token punctuation">)</span>'.format<span class="token punctuation">(</span>
            self.crop_size<span class="token punctuation">)</span>


@PIPELINES.register_module
class SegRescale<span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token operator">:</span>
    """Rescale semantic segmentation maps.

    Args<span class="token operator">:</span>
        scale_factor <span class="token punctuation">(</span>float<span class="token punctuation">)</span><span class="token operator">:</span> The scale factor of the final output.
    """

    def __init__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> scale_factor<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">:</span>
        self.scale_factor <span class="token operator">=</span> scale_factor

    def __call__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> results<span class="token punctuation">)</span><span class="token operator">:</span>
        for key in results.get<span class="token punctuation">(</span>'seg_fields'<span class="token punctuation">,</span> []<span class="token punctuation">)</span><span class="token operator">:</span>
            if self.scale_factor <span class="token operator">!=</span> <span class="token number">1</span><span class="token operator">:</span>
                results[key] <span class="token operator">=</span> mmcv.imrescale<span class="token punctuation">(</span>
                    results[key]<span class="token punctuation">,</span> self.scale_factor<span class="token punctuation">,</span> interpolation<span class="token operator">=</span>'nearest'<span class="token punctuation">)</span>
        return results

    def __repr__<span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token operator">:</span>
        return self.__class__.__name__ <span class="token operator">+</span> '<span class="token punctuation">(</span>scale_factor<span class="token operator">=</span>{}<span class="token punctuation">)</span>'.format<span class="token punctuation">(</span>
            self.scale_factor<span class="token punctuation">)</span>


@PIPELINES.register_module
class PhotoMetricDistortion<span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token operator">:</span>
    """Apply photometric distortion to image sequentially<span class="token punctuation">,</span> every transformation
    is applied with a probability of <span class="token number">0.5</span>. The position of random contrast is in
    second or second to last.

    <span class="token number">1.</span> random brightness
    <span class="token number">2.</span> random contrast <span class="token punctuation">(</span>mode <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token number">3.</span> convert color from BGR to HSV
    <span class="token number">4.</span> random saturation
    <span class="token number">5.</span> random hue
    <span class="token number">6.</span> convert color from HSV to BGR
    <span class="token number">7.</span> random contrast <span class="token punctuation">(</span>mode <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token number">8.</span> randomly swap channels

    Args<span class="token operator">:</span>
        brightness_delta <span class="token punctuation">(</span>int<span class="token punctuation">)</span><span class="token operator">:</span> delta of brightness.
        contrast_range <span class="token punctuation">(</span>tuple<span class="token punctuation">)</span><span class="token operator">:</span> range of contrast.
        saturation_range <span class="token punctuation">(</span>tuple<span class="token punctuation">)</span><span class="token operator">:</span> range of saturation.
        hue_delta <span class="token punctuation">(</span>int<span class="token punctuation">)</span><span class="token operator">:</span> delta of hue.
    """

    def __init__<span class="token punctuation">(</span>self<span class="token punctuation">,</span>
                 brightness_delta<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span>
                 contrast_range<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 saturation_range<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 hue_delta<span class="token operator">=</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token operator">:</span>
        self.brightness_delta <span class="token operator">=</span> brightness_delta
        self.contrast_lower<span class="token punctuation">,</span> self.contrast_upper <span class="token operator">=</span> contrast_range
        self.saturation_lower<span class="token punctuation">,</span> self.saturation_upper <span class="token operator">=</span> saturation_range
        self.hue_delta <span class="token operator">=</span> hue_delta

    def __call__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> results<span class="token punctuation">)</span><span class="token operator">:</span>
        img <span class="token operator">=</span> results['img']
        # random brightness
        if random.randint<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">:</span>
            delta <span class="token operator">=</span> random.uniform<span class="token punctuation">(</span><span class="token operator">-</span>self.brightness_delta<span class="token punctuation">,</span>
                                   self.brightness_delta<span class="token punctuation">)</span>
            img <span class="token operator">+=</span> delta

        # mode <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">--</span><span class="token operator">&gt;</span> do random contrast first
        # mode <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">--</span><span class="token operator">&gt;</span> do random contrast last
        mode <span class="token operator">=</span> random.randint<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
        if mode <span class="token operator">==</span> <span class="token number">1</span><span class="token operator">:</span>
            if random.randint<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">:</span>
                alpha <span class="token operator">=</span> random.uniform<span class="token punctuation">(</span>self.contrast_lower<span class="token punctuation">,</span>
                                       self.contrast_upper<span class="token punctuation">)</span>
                img <span class="token operator">*=</span> alpha

        # convert color from BGR to HSV
        img <span class="token operator">=</span> mmcv.bgr2hsv<span class="token punctuation">(</span>img<span class="token punctuation">)</span>

        # random saturation
        if random.randint<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">:</span>
            img[...<span class="token punctuation">,</span> <span class="token number">1</span>] <span class="token operator">*=</span> random.uniform<span class="token punctuation">(</span>self.saturation_lower<span class="token punctuation">,</span>
                                          self.saturation_upper<span class="token punctuation">)</span>

        # random hue
        if random.randint<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">:</span>
            img[...<span class="token punctuation">,</span> <span class="token number">0</span>] <span class="token operator">+=</span> random.uniform<span class="token punctuation">(</span><span class="token operator">-</span>self.hue_delta<span class="token punctuation">,</span> self.hue_delta<span class="token punctuation">)</span>
            img[...<span class="token punctuation">,</span> <span class="token number">0</span>][img[...<span class="token punctuation">,</span> <span class="token number">0</span>] <span class="token operator">&gt;</span> <span class="token number">360</span>] <span class="token operator">-=</span> <span class="token number">360</span>
            img[...<span class="token punctuation">,</span> <span class="token number">0</span>][img[...<span class="token punctuation">,</span> <span class="token number">0</span>] <span class="token operator">&lt;</span> <span class="token number">0</span>] <span class="token operator">+=</span> <span class="token number">360</span>

        # convert color from HSV to BGR
        img <span class="token operator">=</span> mmcv.hsv2bgr<span class="token punctuation">(</span>img<span class="token punctuation">)</span>

        # random contrast
        if mode <span class="token operator">==</span> <span class="token number">0</span><span class="token operator">:</span>
            if random.randint<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">:</span>
                alpha <span class="token operator">=</span> random.uniform<span class="token punctuation">(</span>self.contrast_lower<span class="token punctuation">,</span>
                                       self.contrast_upper<span class="token punctuation">)</span>
                img <span class="token operator">*=</span> alpha

        # randomly swap channels
        if random.randint<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">:</span>
            img <span class="token operator">=</span> img[...<span class="token punctuation">,</span> random.permutation<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>]

        results['img'] <span class="token operator">=</span> img
        return results

    def __repr__<span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token operator">:</span>
        repr_str <span class="token operator">=</span> self.__class__.__name__
        repr_str <span class="token operator">+=</span> <span class="token punctuation">(</span>'<span class="token punctuation">(</span>brightness_delta<span class="token operator">=</span>{}<span class="token punctuation">,</span> contrast_range<span class="token operator">=</span>{}<span class="token punctuation">,</span> '
                     'saturation_range<span class="token operator">=</span>{}<span class="token punctuation">,</span> hue_delta<span class="token operator">=</span>{}<span class="token punctuation">)</span>'<span class="token punctuation">)</span>.format<span class="token punctuation">(</span>
                         self.brightness_delta<span class="token punctuation">,</span> self.contrast_range<span class="token punctuation">,</span>
                         self.saturation_range<span class="token punctuation">,</span> self.hue_delta<span class="token punctuation">)</span>
        return repr_str


@PIPELINES.register_module
class Expand<span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token operator">:</span>
    """Random expand the image <span class="token operator">&amp;</span> bboxes.

    Randomly place the original image on a canvas of 'ratio' x original image
    size filled with mean values. The ratio is in the range of ratio_range.

    Args<span class="token operator">:</span>
        mean <span class="token punctuation">(</span>tuple<span class="token punctuation">)</span><span class="token operator">:</span> mean value of dataset.
        to_rgb <span class="token punctuation">(</span>bool<span class="token punctuation">)</span><span class="token operator">:</span> if need to convert the order of mean to align with RGB.
        ratio_range <span class="token punctuation">(</span>tuple<span class="token punctuation">)</span><span class="token operator">:</span> range of expand ratio.
        prob <span class="token punctuation">(</span>float<span class="token punctuation">)</span><span class="token operator">:</span> probability of applying this transformation
    """

    def __init__<span class="token punctuation">(</span>self<span class="token punctuation">,</span>
                 mean<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 to_rgb<span class="token operator">=</span>True<span class="token punctuation">,</span>
                 ratio_range<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 seg_ignore_label<span class="token operator">=</span>None<span class="token punctuation">,</span>
                 prob<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token operator">:</span>
        self.to_rgb <span class="token operator">=</span> to_rgb
        self.ratio_range <span class="token operator">=</span> ratio_range
        if to_rgb<span class="token operator">:</span>
            self.mean <span class="token operator">=</span> mean[<span class="token operator">:</span><span class="token operator">:</span><span class="token operator">-</span><span class="token number">1</span>]
        else<span class="token operator">:</span>
            self.mean <span class="token operator">=</span> mean
        self.min_ratio<span class="token punctuation">,</span> self.max_ratio <span class="token operator">=</span> ratio_range
        self.seg_ignore_label <span class="token operator">=</span> seg_ignore_label
        self.prob <span class="token operator">=</span> prob

    def __call__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> results<span class="token punctuation">)</span><span class="token operator">:</span>
        if random.uniform<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> self.prob<span class="token operator">:</span>
            return results

        img<span class="token punctuation">,</span> boxes <span class="token operator">=</span> [results[k] for k in <span class="token punctuation">(</span>'img'<span class="token punctuation">,</span> 'gt_bboxes'<span class="token punctuation">)</span>]

        h<span class="token punctuation">,</span> w<span class="token punctuation">,</span> c <span class="token operator">=</span> img.shape
        ratio <span class="token operator">=</span> random.uniform<span class="token punctuation">(</span>self.min_ratio<span class="token punctuation">,</span> self.max_ratio<span class="token punctuation">)</span>
        expand_img <span class="token operator">=</span> np.full<span class="token punctuation">((</span>int<span class="token punctuation">(</span>h <span class="token operator">*</span> ratio<span class="token punctuation">)</span><span class="token punctuation">,</span> int<span class="token punctuation">(</span>w <span class="token operator">*</span> ratio<span class="token punctuation">)</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">,</span>
                             self.mean<span class="token punctuation">)</span>.astype<span class="token punctuation">(</span>img.dtype<span class="token punctuation">)</span>
        left <span class="token operator">=</span> int<span class="token punctuation">(</span>random.uniform<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> w <span class="token operator">*</span> ratio <span class="token operator">-</span> w<span class="token punctuation">))</span></span>
        <span class="token function">top</span> <span class="token operator">=</span> int<span class="token punctuation">(</span>random.uniform<span class="token punctuation">(</span><span class="token number">0</span>, h * ratio - h<span class="token punctuation">))</span>
        expand_img<span class="token punctuation">[</span>top:top + h, left:left + w<span class="token punctuation">]</span> <span class="token operator">=</span> img
        boxes <span class="token operator">=</span> boxes + np.tile<span class="token variable"><span class="token punctuation">((</span>left<span class="token punctuation">,</span> top<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>.astype<span class="token punctuation">(</span>boxes.dtype<span class="token punctuation">)</span>

        results['img'] <span class="token operator">=</span> expand_img
        results['gt_bboxes'] <span class="token operator">=</span> boxes

        if 'gt_masks' in results<span class="token operator">:</span>
            expand_gt_masks <span class="token operator">=</span> []
            for mask in results['gt_masks']<span class="token operator">:</span>
                expand_mask <span class="token operator">=</span> np.full<span class="token punctuation">((</span>int<span class="token punctuation">(</span>h <span class="token operator">*</span> ratio<span class="token punctuation">)</span><span class="token punctuation">,</span> int<span class="token punctuation">(</span>w <span class="token operator">*</span> ratio<span class="token punctuation">))</span></span>,
                                      <span class="token number">0</span><span class="token punctuation">)</span>.astype<span class="token punctuation">(</span>mask.dtype<span class="token punctuation">)</span>
                expand_mask<span class="token punctuation">[</span>top:top + h, left:left + w<span class="token punctuation">]</span> <span class="token operator">=</span> mask
                expand_gt_masks.append<span class="token punctuation">(</span>expand_mask<span class="token punctuation">)</span>
            results<span class="token punctuation">[</span><span class="token string">'gt_masks'</span><span class="token punctuation">]</span> <span class="token operator">=</span> expand_gt_masks

        <span class="token comment"># not tested</span>
        <span class="token keyword">if</span> <span class="token string">'gt_semantic_seg'</span> <span class="token keyword">in</span> results:
            assert self.seg_ignore_label is not None
            gt_seg <span class="token operator">=</span> results<span class="token punctuation">[</span><span class="token string">'gt_semantic_seg'</span><span class="token punctuation">]</span>
            expand_gt_seg <span class="token operator">=</span> np.full<span class="token variable"><span class="token punctuation">((</span>int<span class="token punctuation">(</span>h <span class="token operator">*</span> ratio<span class="token punctuation">)</span><span class="token punctuation">,</span> int<span class="token punctuation">(</span>w <span class="token operator">*</span> ratio<span class="token punctuation">))</span></span>,
                                    self.seg_ignore_label<span class="token punctuation">)</span>.astype<span class="token punctuation">(</span>gt_seg.dtype<span class="token punctuation">)</span>
            expand_gt_seg<span class="token punctuation">[</span>top:top + h, left:left + w<span class="token punctuation">]</span> <span class="token operator">=</span> gt_seg
            results<span class="token punctuation">[</span><span class="token string">'gt_semantic_seg'</span><span class="token punctuation">]</span> <span class="token operator">=</span> expand_gt_seg
        <span class="token builtin class-name">return</span> results

    def __repr__<span class="token punctuation">(</span>self<span class="token punctuation">)</span>:
        repr_str <span class="token operator">=</span> self.__class__.__name__
        repr_str <span class="token operator">+=</span> <span class="token string">'(mean={}, to_rgb={}, ratio_range={}, '</span> <span class="token punctuation">\</span>
                    <span class="token string">'seg_ignore_label={})'</span>.format<span class="token punctuation">(</span>
                        self.mean, self.to_rgb, self.ratio_range,
                        self.seg_ignore_label<span class="token punctuation">)</span>
        <span class="token builtin class-name">return</span> repr_str


@PIPELINES.register_module
class MinIoURandomCrop<span class="token punctuation">(</span>object<span class="token punctuation">)</span>:
    <span class="token string">""</span>"Random crop the image <span class="token operator">&amp;</span> bboxes, the cropped patches have minimum IoU
    requirement with original image <span class="token operator">&amp;</span> bboxes, the IoU threshold is randomly
    selected from min_ious.

    Args:
        min_ious <span class="token punctuation">(</span>tuple<span class="token punctuation">)</span>: minimum IoU threshold <span class="token keyword">for</span> all intersections with
        bounding boxes
        min_crop_size <span class="token punctuation">(</span>float<span class="token punctuation">)</span>: minimum crop<span class="token string">'s size (i.e. h,w := a*h, a*w,
        where a &gt;= min_crop_size).
    """

    def __init__(self, min_ious=(0.1, 0.3, 0.5, 0.7, 0.9), min_crop_size=0.3):
        # 1: return ori img
        self.sample_mode = (1, *min_ious, 0)
        self.min_crop_size = min_crop_size

    def __call__(self, results):
        img, boxes, labels = [
            results[k] for k in ('</span>img<span class="token string">', '</span>gt_bboxes<span class="token string">', '</span>gt_labels<span class="token string">')
        ]
        h, w, c = img.shape
        while True:
            mode = random.choice(self.sample_mode)
            if mode == 1:
                return results

            min_iou = mode
            for i in range(50):
                new_w = random.uniform(self.min_crop_size * w, w)
                new_h = random.uniform(self.min_crop_size * h, h)

                # h / w in [0.5, 2]
                if new_h / new_w &lt; 0.5 or new_h / new_w &gt; 2:
                    continue

                left = random.uniform(w - new_w)
                top = random.uniform(h - new_h)

                patch = np.array(
                    (int(left), int(top), int(left + new_w), int(top + new_h)))
                overlaps = bbox_overlaps(
                    patch.reshape(-1, 4), boxes.reshape(-1, 4)).reshape(-1)
                if overlaps.min() &lt; min_iou:
                    continue

                # center of boxes should inside the crop img
                center = (boxes[:, :2] + boxes[:, 2:]) / 2
                mask = ((center[:, 0] &gt; patch[0]) * (center[:, 1] &gt; patch[1]) *
                        (center[:, 0] &lt; patch[2]) * (center[:, 1] &lt; patch[3]))
                if not mask.any():
                    continue
                boxes = boxes[mask]
                labels = labels[mask]

                # adjust boxes
                img = img[patch[1]:patch[3], patch[0]:patch[2]]
                boxes[:, 2:] = boxes[:, 2:].clip(max=patch[2:])
                boxes[:, :2] = boxes[:, :2].clip(min=patch[:2])
                boxes -= np.tile(patch[:2], 2)

                results['</span>img<span class="token string">'] = img
                results['</span>gt_bboxes<span class="token string">'] = boxes
                results['</span>gt_labels<span class="token string">'] = labels

                if '</span>gt_masks<span class="token string">' in results:
                    valid_masks = [
                        results['</span>gt_masks<span class="token string">'][i] for i in range(len(mask))
                        if mask[i]
                    ]
                    results['</span>gt_masks<span class="token string">'] = [
                        gt_mask[patch[1]:patch[3], patch[0]:patch[2]]
                        for gt_mask in valid_masks
                    ]

                # not tested
                if '</span>gt_semantic_seg<span class="token string">' in results:
                    results['</span>gt_semantic_seg<span class="token string">'] = results['</span>gt_semantic_seg<span class="token string">'][
                        patch[1]:patch[3], patch[0]:patch[2]]
                return results

    def __repr__(self):
        repr_str = self.__class__.__name__
        repr_str += '</span><span class="token punctuation">(</span>min_ious<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>, <span class="token assign-left variable">min_crop_size</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token string">'.format(
            self.min_ious, self.min_crop_size)
        return repr_str


@PIPELINES.register_module
class Corrupt(object):

    def __init__(self, corruption, severity=1):
        self.corruption = corruption
        self.severity = severity

    def __call__(self, results):
        results['</span>img<span class="token string">'] = corrupt(
            results['</span>img<span class="token string">'].astype(np.uint8),
            corruption_name=self.corruption,
            severity=self.severity)
        return results

    def __repr__(self):
        repr_str = self.__class__.__name__
        repr_str += '</span><span class="token punctuation">(</span>corruption<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>, <span class="token assign-left variable">severity</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token string">'.format(
            self.corruption, self.severity)
        return repr_str


@PIPELINES.register_module
class Albu(object):

    def __init__(self,
                 transforms,
                 bbox_params=None,
                 keymap=None,
                 update_pad_shape=False,
                 skip_img_without_anno=False):
        """
        Adds custom transformations from Albumentations lib.
        Please, visit `https://albumentations.readthedocs.io`
        to get more information.

        transforms (list): list of albu transformations
        bbox_params (dict): bbox_params for albumentation `Compose`
        keymap (dict): contains {'</span>input key<span class="token string">':'</span>albumentation-style key<span class="token string">'}
        skip_img_without_anno (bool): whether to skip the image
                                      if no ann left after aug
        """

        self.transforms = transforms
        self.filter_lost_elements = False
        self.update_pad_shape = update_pad_shape
        self.skip_img_without_anno = skip_img_without_anno

        # A simple workaround to remove masks without boxes
        if (isinstance(bbox_params, dict) and '</span>label_fields<span class="token string">' in bbox_params
                and '</span>filter_lost_elements<span class="token string">' in bbox_params):
            self.filter_lost_elements = True
            self.origin_label_fields = bbox_params['</span>label_fields<span class="token string">']
            bbox_params['</span>label_fields<span class="token string">'] = ['</span>idx_mapper<span class="token string">']
            del bbox_params['</span>filter_lost_elements<span class="token string">']

        self.bbox_params = (
            self.albu_builder(bbox_params) if bbox_params else None)
        self.aug = Compose([self.albu_builder(t) for t in self.transforms],
                           bbox_params=self.bbox_params)

        if not keymap:
            self.keymap_to_albu = {
                '</span>img<span class="token string">': '</span>image<span class="token string">',
                '</span>gt_masks<span class="token string">': '</span>masks<span class="token string">',
                '</span>gt_bboxes<span class="token string">': '</span>bboxes<span class="token string">'
            }
        else:
            self.keymap_to_albu = keymap
        self.keymap_back = {v: k for k, v in self.keymap_to_albu.items()}

    def albu_builder(self, cfg):
        """Import a module from albumentations.
        Inherits some of `build_from_cfg` logic.

        Args:
            cfg (dict): Config dict. It should at least contain the key "type".
        Returns:
            obj: The constructed object.
        """
        assert isinstance(cfg, dict) and "type" in cfg
        args = cfg.copy()

        obj_type = args.pop("type")
        if mmcv.is_str(obj_type):
            obj_cls = getattr(albumentations, obj_type)
        elif inspect.isclass(obj_type):
            obj_cls = obj_type
        else:
            raise TypeError(
                '</span><span class="token builtin class-name">type</span> must be a str or valid type, but got <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token string">'.format(
                    type(obj_type)))

        if '</span>transforms<span class="token string">' in args:
            args['</span>transforms<span class="token string">'] = [
                self.albu_builder(transform)
                for transform in args['</span>transforms<span class="token string">']
            ]

        return obj_cls(**args)

    @staticmethod
    def mapper(d, keymap):
        """
        Dictionary mapper.
        Renames keys according to keymap provided.

        Args:
            d (dict): old dict
            keymap (dict): {'</span>old_key<span class="token string">':'</span>new_key<span class="token string">'}
        Returns:
            dict: new dict.
        """
        updated_dict = {}
        for k, v in zip(d.keys(), d.values()):
            new_k = keymap.get(k, k)
            updated_dict[new_k] = d[k]
        return updated_dict

    def __call__(self, results):
        # dict to albumentations format
        results = self.mapper(results, self.keymap_to_albu)

        if '</span>bboxes<span class="token string">' in results:
            # to list of boxes
            if isinstance(results['</span>bboxes<span class="token string">'], np.ndarray):
                results['</span>bboxes<span class="token string">'] = [x for x in results['</span>bboxes<span class="token string">']]
            # add pseudo-field for filtration
            if self.filter_lost_elements:
                results['</span>idx_mapper<span class="token string">'] = np.arange(len(results['</span>bboxes<span class="token string">']))

        results = self.aug(**results)

        if '</span>bboxes<span class="token string">' in results:
            if isinstance(results['</span>bboxes<span class="token string">'], list):
                results['</span>bboxes<span class="token string">'] = np.array(
                    results['</span>bboxes<span class="token string">'], dtype=np.float32)

            # filter label_fields
            if self.filter_lost_elements:

                results['</span>idx_mapper<span class="token string">'] = np.arange(len(results['</span>bboxes<span class="token string">']))

                for label in self.origin_label_fields:
                    results[label] = np.array(
                        [results[label][i] for i in results['</span>idx_mapper<span class="token string">']])
                if '</span>masks<span class="token string">' in results:
                    results['</span>masks<span class="token string">'] = [
                        results['</span>masks<span class="token string">'][i] for i in results['</span>idx_mapper<span class="token string">']
                    ]

                if (not len(results['</span>idx_mapper<span class="token string">'])
                        and self.skip_img_without_anno):
                    return None

        if '</span>gt_labels<span class="token string">' in results:
            if isinstance(results['</span>gt_labels<span class="token string">'], list):
                results['</span>gt_labels<span class="token string">'] = np.array(results['</span>gt_labels<span class="token string">'])

        # back to the original format
        results = self.mapper(results, self.keymap_back)

        # update final shape
        if self.update_pad_shape:
            results['</span>pad_shape<span class="token string">'] = results['</span>img<span class="token string">'].shape

        return results

    def __repr__(self):
        repr_str = self.__class__.__name__
        repr_str += '</span><span class="token punctuation">(</span>transformations<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span>'.format<span class="token punctuation">(</span>self.transformations<span class="token punctuation">)</span>
        <span class="token builtin class-name">return</span> repr_str
</code></pre> 
<h5><a id="mmdetdatasetspipelines__init__py_1538"></a>mmdet/datasets/pipelines/<strong>init</strong>.py，修改后的源码如下：</h5> 
<p><a href="https://zhuanlan.zhihu.com/p/107922962" rel="nofollow"><strong>init</strong>.py</a></p> 
<h6><a id="albumentations_1540"></a>此代码为引入albumentations数据增强库进行增强</h6> 
<p>具体修改方式如下：添加dict(type=‘Albu’, transforms = [{“type”: ‘RandomRotate90’}])，其他的类似。</p> 
<pre><code class="prism language-bash">from .compose <span class="token function">import</span> Compose
from .formating <span class="token function">import</span> <span class="token punctuation">(</span>Collect, ImageToTensor, ToDataContainer, ToTensor,
                        Transpose, to_tensor<span class="token punctuation">)</span>
from .loading <span class="token function">import</span> LoadAnnotations, LoadImageFromFile, LoadProposals
from .test_aug <span class="token function">import</span> MultiScaleFlipAug
from .transforms <span class="token function">import</span> <span class="token punctuation">(</span>Albu, Expand, MinIoURandomCrop, Normalize, Pad,
                         PhotoMetricDistortion, RandomCrop, RandomFlip, Resize,
                         SegRescale<span class="token punctuation">)</span>


__all__ <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'Compose'</span>, <span class="token string">'to_tensor'</span>, <span class="token string">'ToTensor'</span>, <span class="token string">'ImageToTensor'</span>, <span class="token string">'ToDataContainer'</span>,
    <span class="token string">'Transpose'</span>, <span class="token string">'Collect'</span>, <span class="token string">'LoadAnnotations'</span>, <span class="token string">'LoadImageFromFile'</span>,
    <span class="token string">'LoadProposals'</span>, <span class="token string">'MultiScaleFlipAug'</span>, <span class="token string">'Resize'</span>, <span class="token string">'RandomFlip'</span>, <span class="token string">'Pad'</span>,
    <span class="token string">'RandomCrop'</span>, <span class="token string">'Normalize'</span>, <span class="token string">'SegRescale'</span>, <span class="token string">'MinIoURandomCrop'</span>, <span class="token string">'Expand'</span>,
    <span class="token string">'PhotoMetricDistortion'</span>, <span class="token string">'Albu'</span>
<span class="token punctuation">]</span>
</code></pre> 
<p>具体修改方式如下：添加dict(type=‘Albu’, transforms = [{“type”: ‘RandomRotate90’}])，其他的类似。</p> 
<pre><code class="prism language-bash">train_pipeline <span class="token operator">=</span> <span class="token punctuation">[</span>
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'LoadImageFromFile'</span><span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'LoadAnnotations'</span>, <span class="token assign-left variable">with_bbox</span><span class="token operator">=</span>True<span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Albu'</span>, transforms <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">'RandomRotate90'</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>,<span class="token comment"># 数据增强</span>
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Resize'</span>, <span class="token assign-left variable">img_scale</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1333</span>, <span class="token number">800</span><span class="token punctuation">)</span>, <span class="token assign-left variable">keep_ratio</span><span class="token operator">=</span>True<span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'RandomFlip'</span>, <span class="token assign-left variable">flip_ratio</span><span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Normalize'</span>, **img_norm_cfg<span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Pad'</span>, <span class="token assign-left variable">size_divisor</span><span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'DefaultFormatBundle'</span><span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Collect'</span>, <span class="token assign-left variable">keys</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'img'</span>, <span class="token string">'gt_bboxes'</span>, <span class="token string">'gt_labels'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>,
<span class="token punctuation">]</span>
</code></pre> 
<h6><a id="transform_v2_1579"></a>目前的transform v2</h6> 
<pre><code class="prism language-bash">from .auto_augment <span class="token function">import</span> <span class="token punctuation">(</span>AutoAugment, BrightnessTransform, ColorTransform,
                           ContrastTransform, EqualizeTransform, Rotate, Shear,
                           Translate<span class="token punctuation">)</span>
from .compose <span class="token function">import</span> Compose
from .formating <span class="token function">import</span> <span class="token punctuation">(</span>Collect, DefaultFormatBundle, ImageToTensor,
                        ToDataContainer, ToTensor, Transpose, to_tensor<span class="token punctuation">)</span>
from .instaboost <span class="token function">import</span> InstaBoost
from .loading <span class="token function">import</span> <span class="token punctuation">(</span>LoadAnnotations, LoadImageFromFile, LoadImageFromWebcam,
                      LoadMultiChannelImageFromFiles, LoadProposals<span class="token punctuation">)</span>
from .test_time_aug <span class="token function">import</span> MultiScaleFlipAug
from .transforms <span class="token function">import</span> <span class="token punctuation">(</span>Albu, CutOut, Expand, MinIoURandomCrop, Normalize,
                         Pad, PhotoMetricDistortion, RandomCenterCropPad,
                         RandomCrop, RandomFlip, Resize, SegRescale<span class="token punctuation">)</span>

__all__ <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'Compose'</span>, <span class="token string">'to_tensor'</span>, <span class="token string">'ToTensor'</span>, <span class="token string">'ImageToTensor'</span>, <span class="token string">'ToDataContainer'</span>,
    <span class="token string">'Transpose'</span>, <span class="token string">'Collect'</span>, <span class="token string">'DefaultFormatBundle'</span>, <span class="token string">'LoadAnnotations'</span>,
    <span class="token string">'LoadImageFromFile'</span>, <span class="token string">'LoadImageFromWebcam'</span>,
    <span class="token string">'LoadMultiChannelImageFromFiles'</span>, <span class="token string">'LoadProposals'</span>, <span class="token string">'MultiScaleFlipAug'</span>,
    <span class="token string">'Resize'</span>, <span class="token string">'RandomFlip'</span>, <span class="token string">'Pad'</span>, <span class="token string">'RandomCrop'</span>, <span class="token string">'Normalize'</span>, <span class="token string">'SegRescale'</span>,
    <span class="token string">'MinIoURandomCrop'</span>, <span class="token string">'Expand'</span>, <span class="token string">'PhotoMetricDistortion'</span>, <span class="token string">'Albu'</span>,
    <span class="token string">'InstaBoost'</span>, <span class="token string">'RandomCenterCropPad'</span>, <span class="token string">'AutoAugment'</span>, <span class="token string">'CutOut'</span>, <span class="token string">'Shear'</span>,
    <span class="token string">'Rotate'</span>, <span class="token string">'ColorTransform'</span>, <span class="token string">'EqualizeTransform'</span>, <span class="token string">'BrightnessTransform'</span>,
    <span class="token string">'ContrastTransform'</span>, <span class="token string">'Translate'</span>
<span class="token punctuation">]</span>
</code></pre> 
<h4><a id="2MMDetection_1608"></a>2、MMDetection自带数据增强</h4> 
<p>源码在mmdet/datasets/extra_aug.py里面，包括RandomCrop、brightness、contrast、saturation、ExtraAugmentation等等图像增强方法。<br> 添加config位置是train_pipeline或test_pipeline这个地方（一般train进行增强而test不需要），例如数据增强RandomFlip，flip_ratio代表随机翻转的概率：</p> 
<pre><code class="prism language-bash">train_pipeline <span class="token operator">=</span> <span class="token punctuation">[</span>
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'LoadImageFromFile'</span><span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'LoadAnnotations'</span>, <span class="token assign-left variable">with_bbox</span><span class="token operator">=</span>True<span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Resize'</span>, <span class="token assign-left variable">img_scale</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1333</span>, <span class="token number">800</span><span class="token punctuation">)</span>, <span class="token assign-left variable">keep_ratio</span><span class="token operator">=</span>True<span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'RandomFlip'</span>, <span class="token assign-left variable">flip_ratio</span><span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Normalize'</span>, **img_norm_cfg<span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Pad'</span>, <span class="token assign-left variable">size_divisor</span><span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'DefaultFormatBundle'</span><span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Collect'</span>, <span class="token assign-left variable">keys</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'img'</span>, <span class="token string">'gt_bboxes'</span>, <span class="token string">'gt_labels'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>,
<span class="token punctuation">]</span>
test_pipeline <span class="token operator">=</span> <span class="token punctuation">[</span>
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'LoadImageFromFile'</span><span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>
        <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'MultiScaleFlipAug'</span>,
        <span class="token assign-left variable">img_scale</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1333</span>, <span class="token number">800</span><span class="token punctuation">)</span>,
        <span class="token assign-left variable">flip</span><span class="token operator">=</span>False,
        <span class="token assign-left variable">transforms</span><span class="token operator">=</span><span class="token punctuation">[</span>
            dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Resize'</span>, <span class="token assign-left variable">keep_ratio</span><span class="token operator">=</span>True<span class="token punctuation">)</span>,
            dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'RandomFlip'</span><span class="token punctuation">)</span>,
            dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Normalize'</span>, **img_norm_cfg<span class="token punctuation">)</span>,
            dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Pad'</span>, <span class="token assign-left variable">size_divisor</span><span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span>,
            dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'ImageToTensor'</span>, <span class="token assign-left variable">keys</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>,
            dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Collect'</span>, <span class="token assign-left variable">keys</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>,
        <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>
</code></pre> 
<h4><a id="3Bbox_1639"></a>3、Bbox增强</h4> 
<p>albumentations数据增强（同上）<br> 源码在mmdet/datasets/custom.py里面，增强源码为</p> 
<pre><code class="prism language-bash">def pre_pipeline<span class="token punctuation">(</span>self, results<span class="token punctuation">)</span>:
        results<span class="token punctuation">[</span><span class="token string">'img_prefix'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self.img_prefix
        results<span class="token punctuation">[</span><span class="token string">'seg_prefix'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self.seg_prefix
        results<span class="token punctuation">[</span><span class="token string">'proposal_file'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self.proposal_file
        results<span class="token punctuation">[</span><span class="token string">'bbox_fields'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        results<span class="token punctuation">[</span><span class="token string">'mask_fields'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</code></pre> 
<h3><a id="_1651"></a>配置文件增加的数据增强</h3> 
<p>configs/<em>base</em>/datasets/coco_detection.py 在train pipeline修改Data Augmentation在train</p> 
<pre><code class="prism language-bash">dataset_type <span class="token operator">=</span> <span class="token string">'CocoDataset'</span>
data_root <span class="token operator">=</span> <span class="token string">'data/coco/'</span>
img_norm_cfg <span class="token operator">=</span> dict<span class="token punctuation">(</span>
    <span class="token assign-left variable">mean</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">123.675</span>, <span class="token number">116.28</span>, <span class="token number">103.53</span><span class="token punctuation">]</span>, <span class="token assign-left variable">std</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">58.395</span>, <span class="token number">57.12</span>, <span class="token number">57.375</span><span class="token punctuation">]</span>, <span class="token assign-left variable">to_rgb</span><span class="token operator">=</span>True<span class="token punctuation">)</span>
<span class="token comment"># 在这里加albumentation的aug</span>
albu_train_transforms <span class="token operator">=</span> <span class="token punctuation">[</span>
    dict<span class="token punctuation">(</span>
        <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'ShiftScaleRotate'</span>,
        <span class="token assign-left variable">shift_limit</span><span class="token operator">=</span><span class="token number">0.0625</span>,
        <span class="token assign-left variable">scale_limit</span><span class="token operator">=</span><span class="token number">0.0</span>,
        <span class="token assign-left variable">rotate_limit</span><span class="token operator">=</span><span class="token number">0</span>,
        <span class="token assign-left variable">interpolation</span><span class="token operator">=</span><span class="token number">1</span>,
        <span class="token assign-left variable">p</span><span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>
        <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'RandomBrightnessContrast'</span>,
        <span class="token assign-left variable">brightness_limit</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.1</span>, <span class="token number">0.3</span><span class="token punctuation">]</span>,
        <span class="token assign-left variable">contrast_limit</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.1</span>, <span class="token number">0.3</span><span class="token punctuation">]</span>,
        <span class="token assign-left variable">p</span><span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>
        <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'OneOf'</span>,
        <span class="token assign-left variable">transforms</span><span class="token operator">=</span><span class="token punctuation">[</span>
            dict<span class="token punctuation">(</span>
                <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'RGBShift'</span>,
                <span class="token assign-left variable">r_shift_limit</span><span class="token operator">=</span><span class="token number">10</span>,
                <span class="token assign-left variable">g_shift_limit</span><span class="token operator">=</span><span class="token number">10</span>,
                <span class="token assign-left variable">b_shift_limit</span><span class="token operator">=</span><span class="token number">10</span>,
                <span class="token assign-left variable">p</span><span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span>,
            dict<span class="token punctuation">(</span>
                <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'HueSaturationValue'</span>,
                <span class="token assign-left variable">hue_shift_limit</span><span class="token operator">=</span><span class="token number">20</span>,
                <span class="token assign-left variable">sat_shift_limit</span><span class="token operator">=</span><span class="token number">30</span>,
                <span class="token assign-left variable">val_shift_limit</span><span class="token operator">=</span><span class="token number">20</span>,
                <span class="token assign-left variable">p</span><span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span>,
        <span class="token assign-left variable">p</span><span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'JpegCompression'</span>, <span class="token assign-left variable">quality_lower</span><span class="token operator">=</span><span class="token number">85</span>, <span class="token assign-left variable">quality_upper</span><span class="token operator">=</span><span class="token number">95</span>, <span class="token assign-left variable">p</span><span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'ChannelShuffle'</span>, <span class="token assign-left variable">p</span><span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>
        <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'OneOf'</span>,
        <span class="token assign-left variable">transforms</span><span class="token operator">=</span><span class="token punctuation">[</span>
            dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Blur'</span>, <span class="token assign-left variable">blur_limit</span><span class="token operator">=</span><span class="token number">3</span>, <span class="token assign-left variable">p</span><span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span>,
            dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'MedianBlur'</span>, <span class="token assign-left variable">blur_limit</span><span class="token operator">=</span><span class="token number">3</span>, <span class="token assign-left variable">p</span><span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span>,
        <span class="token assign-left variable">p</span><span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span>,
<span class="token punctuation">]</span>
train_pipeline <span class="token operator">=</span> <span class="token punctuation">[</span>
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'LoadImageFromFile'</span><span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'LoadAnnotations'</span>, <span class="token assign-left variable">with_bbox</span><span class="token operator">=</span>True, <span class="token assign-left variable">with_mask</span><span class="token operator">=</span>True<span class="token punctuation">)</span>,
    <span class="token comment">#据说这里改img_scale即可多尺度训练，但是实际运行报错。</span>
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Resize'</span>, <span class="token assign-left variable">img_scale</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1333</span>, <span class="token number">800</span><span class="token punctuation">)</span>, <span class="token assign-left variable">keep_ratio</span><span class="token operator">=</span>True<span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Pad'</span>, <span class="token assign-left variable">size_divisor</span><span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>
        <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'Albu'</span>,
        <span class="token assign-left variable">transforms</span><span class="token operator">=</span>albu_train_transforms,
        <span class="token assign-left variable">bbox_params</span><span class="token operator">=</span>dict<span class="token punctuation">(</span>
            <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'BboxParams'</span>,
            <span class="token assign-left variable">format</span><span class="token operator">=</span><span class="token string">'pascal_voc'</span>,
            <span class="token assign-left variable">label_fields</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'gt_labels'</span><span class="token punctuation">]</span>,
            <span class="token assign-left variable">min_visibility</span><span class="token operator">=</span><span class="token number">0.0</span>,
            <span class="token assign-left variable">filter_lost_elements</span><span class="token operator">=</span>True<span class="token punctuation">)</span>,
        <span class="token assign-left variable">keymap</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
            <span class="token string">'img'</span><span class="token builtin class-name">:</span> <span class="token string">'image'</span>,
            <span class="token string">'gt_masks'</span><span class="token builtin class-name">:</span> <span class="token string">'masks'</span>,
            <span class="token string">'gt_bboxes'</span><span class="token builtin class-name">:</span> <span class="token string">'bboxes'</span>
        <span class="token punctuation">}</span>,
<span class="token punctuation">]</span>
<span class="token comment"># 测试的pipeline</span>
test_pipeline <span class="token operator">=</span> <span class="token punctuation">[</span>
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'LoadImageFromFile'</span><span class="token punctuation">)</span>,
    dict<span class="token punctuation">(</span>
        <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'MultiScaleFlipAug'</span>,
        <span class="token comment"># 多尺度测试 TTA在这里修改，注意有些模型不支持多尺度TTA，比如cascade_mask_rcnn，若不支持会提示</span>
        <span class="token comment"># Unimplemented Error</span>
        <span class="token assign-left variable">img_scale</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1333</span>, <span class="token number">800</span><span class="token punctuation">)</span>,
        <span class="token assign-left variable">flip</span><span class="token operator">=</span>False,
        <span class="token assign-left variable">transforms</span><span class="token operator">=</span><span class="token punctuation">[</span>
            dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Resize'</span>, <span class="token assign-left variable">keep_ratio</span><span class="token operator">=</span>True<span class="token punctuation">)</span>,
            dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'RandomFlip'</span><span class="token punctuation">)</span>,
            dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Normalize'</span>, **img_norm_cfg<span class="token punctuation">)</span>,
            dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Pad'</span>, <span class="token assign-left variable">size_divisor</span><span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span>,
            dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'ImageToTensor'</span>, <span class="token assign-left variable">keys</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>,
            dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Collect'</span>, <span class="token assign-left variable">keys</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>,
        <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>
<span class="token comment"># 包含batch_size, workers和路径。</span>
<span class="token comment"># 路径如果按照上面的设置好就不需要更改</span>
data <span class="token operator">=</span> dict<span class="token punctuation">(</span>
    <span class="token assign-left variable">samples_per_gpu</span><span class="token operator">=</span><span class="token number">2</span>,
    <span class="token assign-left variable">workers_per_gpu</span><span class="token operator">=</span><span class="token number">2</span>,
    <span class="token assign-left variable">train</span><span class="token operator">=</span>dict<span class="token punctuation">(</span>
        <span class="token assign-left variable">type</span><span class="token operator">=</span>dataset_type,
        <span class="token assign-left variable">ann_file</span><span class="token operator">=</span>data_root + <span class="token string">'annotations/instances_train2017.json'</span>,
        <span class="token assign-left variable">img_prefix</span><span class="token operator">=</span>data_root + <span class="token string">'train2017/'</span>,
        <span class="token assign-left variable">pipeline</span><span class="token operator">=</span>train_pipeline<span class="token punctuation">)</span>,
    <span class="token assign-left variable">val</span><span class="token operator">=</span>dict<span class="token punctuation">(</span>
        <span class="token assign-left variable">type</span><span class="token operator">=</span>dataset_type,
        <span class="token assign-left variable">ann_file</span><span class="token operator">=</span>data_root + <span class="token string">'annotations/instances_val2017.json'</span>,
        <span class="token assign-left variable">img_prefix</span><span class="token operator">=</span>data_root + <span class="token string">'val2017/'</span>,
        <span class="token assign-left variable">pipeline</span><span class="token operator">=</span>test_pipeline<span class="token punctuation">)</span>,
    <span class="token assign-left variable">test</span><span class="token operator">=</span>dict<span class="token punctuation">(</span>
        <span class="token assign-left variable">type</span><span class="token operator">=</span>dataset_type,
        <span class="token assign-left variable">ann_file</span><span class="token operator">=</span>data_root + <span class="token string">'annotations/instances_val2017.json'</span>,
        <span class="token assign-left variable">img_prefix</span><span class="token operator">=</span>data_root + <span class="token string">'val2017/'</span>,
        <span class="token assign-left variable">pipeline</span><span class="token operator">=</span>test_pipeline<span class="token punctuation">))</span>
evaluation <span class="token operator">=</span> dict<span class="token punctuation">(</span>interval<span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">metric</span><span class="token operator">=</span><span class="token string">'bbox'</span><span class="token punctuation">)</span>
</code></pre>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/61c17f095f11aadc1e7a97cea893540a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">威联通NAS配置阿里云域名和SSL证书</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/262dfe44c9c82d9fd3273501188c0005/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Qnap NAS &#43; Emby Server &#43; Kodi</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>