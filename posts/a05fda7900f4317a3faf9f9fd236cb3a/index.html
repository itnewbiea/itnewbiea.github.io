<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android FDE 加密过程 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android FDE 加密过程" />
<meta property="og:description" content="Android Full Disk EncryptionSettings中加密入口调用关系加密实现参考 Vold propertiesinit propertiesinit actions Android Full Disk Encryption FDE是android设备全盘加密的简称；主要用于对Android设备userdata分区数据的加密，以实现数据保护的目的
FDE是什么 FDE是Full Disk Encrypt的缩写 保护/data 分区数据参考google的官方介绍(需要访问google网络） encryption一种保护user data的机制。例如：联系人，图片，视频等等截止当前，Android支持加密userdata分区的数据以及不可移除sdcard的数据不支持其他分区的加密FDE如何工作 基于android kernel的dm-crypt feature 实现128 Advanced Encryption Standard(AES) with cipher-block chaining(CBD)and ESSIV:SHA256Android5.0之后，首次开机会加密加密之后，将/data挂在到dm的虚拟节点上首次启动 fstab.qcom 标志 encryptable manually encryptfoeceencrypted encrypt in fist boot使用默认的密码获得master key 默认密码是”default_password”Keymaster(HW/SW) general key blob,存储在footer中default_password_salt(random)–&gt;scrypt–&gt;derived keyDerived&#43;keypair–&gt;sign–&gt;intermedia key(ikey)salt,keybob,derived key stored in footerset ikey to TZHardware Crypto TZ generates an encrypt key derived from new password,set to crypto engineeSoftware Crypto Call APU to set key with ikey(security_hw." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/a05fda7900f4317a3faf9f9fd236cb3a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2017-04-13T11:24:56+08:00" />
<meta property="article:modified_time" content="2017-04-13T11:24:56+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android FDE 加密过程</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <div class="toc"> 
  <ul><li><a href="#android-full-disk-encryption" rel="nofollow">Android Full Disk Encryption</a></li><li><a href="#settings%E4%B8%AD%E5%8A%A0%E5%AF%86%E5%85%A5%E5%8F%A3" rel="nofollow">Settings中加密入口</a></li><li><a href="#%E8%B0%83%E7%94%A8%E5%85%B3%E7%B3%BB" rel="nofollow">调用关系</a></li><li><a href="#%E5%8A%A0%E5%AF%86%E5%AE%9E%E7%8E%B0" rel="nofollow">加密实现</a></li><li><a href="#%E5%8F%82%E8%80%83" rel="nofollow">参考</a> 
    <ul><li><a href="#vold-properties" rel="nofollow">Vold properties</a></li><li><a href="#init-properties" rel="nofollow">init properties</a></li><li><a href="#init-actions" rel="nofollow">init actions</a></li></ul> </li></ul> 
 </div> 
</div> 
<p></p> 
<h2 id="android-full-disk-encryption">Android Full Disk Encryption</h2> 
<p>FDE是android设备全盘加密的简称；主要用于对Android设备userdata分区数据的加密，以实现数据保护的目的</p> 
<ol><li>FDE是什么 <br> 
  <ul><li>FDE是Full Disk Encrypt的缩写 <br> 
    <ul><li>保护/data 分区数据</li><li>参考google的官方介绍(需要访问google网络） <a href="https://source.android.com/security/encryption/" rel="nofollow">encryption</a></li><li>一种保护user data的机制。例如：联系人，图片，视频等等</li><li>截止当前，Android支持加密userdata分区的数据以及不可移除sdcard的数据</li><li>不支持其他分区的加密</li></ul></li><li>FDE如何工作 <br> 
    <ul><li>基于android kernel的dm-crypt feature 实现</li><li>128 Advanced Encryption Standard(AES) with cipher-block chaining(CBD)and ESSIV:SHA256</li><li>Android5.0之后，首次开机会加密</li><li>加密之后，将/data挂在到dm的虚拟节点上</li></ul></li></ul></li><li>首次启动 <br> 
  <ul><li>fstab.qcom 标志 <br> 
    <ul><li>encryptable manually encrypt</li><li>foeceencrypted encrypt in fist boot</li></ul></li><li>使用默认的密码获得master key <br> 
    <ul><li>默认密码是”default_password”</li><li>Keymaster(HW/SW) general key blob,存储在footer中</li><li>default_password_salt(random)–&gt;scrypt–&gt;derived key</li><li>Derived+keypair–&gt;sign–&gt;intermedia key(ikey)</li><li>salt,keybob,derived key stored in footer</li><li>set ikey to TZ</li></ul></li><li>Hardware Crypto <br> 
    <ul><li>TZ generates an encrypt key derived from new password,set to crypto enginee</li></ul></li><li>Software Crypto <br> 
    <ul><li>Call APU to set key with ikey(security_hw.c)</li></ul></li></ul></li><li>非首次开机 <br> 
  <ul><li>如果用户设置了pin/或者密码 <br> 
    <ul><li>弹出提示用于输入密码</li></ul></li><li>使用默认的密码获得master key <br> 
    <ul><li>从footer中读取salt,keyblob,derived key</li><li>从输入或者salt中获得derivedkey，并进行比较</li><li>Derived+keypair–&gt;sign–&gt;intermedia key(ikey)</li><li>salt,keybob,derived key stored in footer</li><li>set ikey to TZ</li></ul></li><li>升级相关 <br> 
    <ul><li>如果使用了软件加密，可以直接软件升级</li><li>如果使用了硬件加密，不可以直接软件升级</li></ul></li></ul></li><li>init.rc <br> 
  <ul><li>on property:vold.decrypt=trigger_default_encryption <br> 
    <ul><li>start defaultcrypto</li></ul></li><li>service defaultcrypto /system/bin/vdc –wait cryptfs mountdefaultencrypted <br> 
    <ul><li>disable</li><li>oneshot</li><li>#vold will set vold.decrypt to trigger_restart_framework(default encryption) or trigger_restart_min_framework(other encryption)</li></ul></li></ul></li><li>FDE 启动总结 <br> 
  <ul><li>init 进程读取fstab中，并依据fstab中的配置进行挂载</li><li>在挂载过程中发现该分区标记了encrypted，使用property触发一个属性</li><li>vdc服务传递命令给cryptd socket</li><li>监听器接收到该socket，然后触发encrypt/decrypt 动作</li><li>重要的函数 <br> 
    <ul><li>CryptCommandListener::CryptfsCmd::runCommand</li><li>get_keymaster_hw_fde_password</li><li>set_hw_device_encryption_key</li><li>create_crypto_blk_dev</li><li>update_hw_device_encryption_key</li></ul></li></ul></li></ol> 
<h2 id="settings中加密入口">Settings中加密入口</h2> 
<pre class="prettyprint"><code class=" hljs avrasm">//package/apps/Settings
CryptKeeper<span class="hljs-preprocessor">.java</span>
CryptKeeperSettings<span class="hljs-preprocessor">.java</span>
CryptKeeperConfirm<span class="hljs-preprocessor">.java</span></code></pre> 
<p>调试加密过程显示的UI</p> 
<pre class="prettyprint"><code class=" hljs avrasm">//正常显示进度条
adb shell pm enable <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.settings</span>/<span class="hljs-preprocessor">.CryptKeeper</span>
adb shell am start  -e <span class="hljs-string">"com.android.settings.CryptKeeper.DEBUG_FORCE_VIEW"</span> <span class="hljs-string">"progress"</span>  -n <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.settings</span>/<span class="hljs-preprocessor">.CryptKeeper</span>
//提示输入密码
adb shell am start  -e <span class="hljs-string">"com.android.settings.CryptKeeper.DEBUG_FORCE_VIEW"</span> <span class="hljs-string">"password"</span>  -n <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.settings</span>/<span class="hljs-preprocessor">.CryptKeeper</span>
//出现错误
adb shell am start  -e <span class="hljs-string">"com.android.settings.CryptKeeper.DEBUG_FORCE_VIEW"</span> <span class="hljs-string">"error"</span>  -n <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.settings</span>/<span class="hljs-preprocessor">.CryptKeeper</span>
</code></pre> 
<h2 id="调用关系">调用关系</h2> 
<p><img src="https://images2.imgbox.com/2f/2d/WZaII4AH_o.png" alt="mountservice" title=""> <br> MountService 启动后，会创建两个Thread 一个用于处理同底层vold的交互的、一个用于处理加密 。启动NativeDaemonConnector Thread 之后，对socket进行监听 <br> 调用流程：</p> 
<pre class="prettyprint"><code class=" hljs ocaml">NativeDaemonConnector.run() 
public <span class="hljs-built_in">int</span> encryptStorage(<span class="hljs-built_in">int</span> <span class="hljs-class"><span class="hljs-keyword">type</span>, <span class="hljs-title">String</span> <span class="hljs-title">password</span>) </span>
--&gt;mCryptConnector.execute(<span class="hljs-string">"cryptfs"</span>, <span class="hljs-string">"enablecrypto"</span>, <span class="hljs-string">"inplace"</span>, …);
    --&gt; CryptCommandListener::CryptfsCmd::runCommand(SocketClient*, argc, **argv)
        --&gt;cryptfs_enable_default(<span class="hljs-built_in">char</span> *howarg, <span class="hljs-built_in">int</span> allow_reboot)
            --&gt;cryptfs_enable_internal(<span class="hljs-built_in">char</span>*,<span class="hljs-built_in">int</span>,<span class="hljs-built_in">char</span>*,<span class="hljs-built_in">int</span>)</code></pre> 
<div class="sequence-diagram"> 
 <svg height="266" version="1.1" width="1075.390625" xmlns="http://www.w3.org/2000/svg" style="overflow: hidden; position: relative; left: -0.5px; top: 0.1875px;"> 
  <desc style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
    Created with Raphaël 2.1.0 
  </desc> 
  <defs style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"> 
   <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path> 
   <marker id="raphael-marker-endblock55" markerheight="5" markerwidth="5" orient="auto" refx="2.5" refy="2.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"> 
    <use transform="rotate(180 2.5 2.5) scale(1,1)" stroke-width="1.0000" fill="#000" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use> 
   </marker> 
  </defs> 
  <rect x="10" y="20" width="117.28125" height="39" r="0" rx="0" ry="0" fill="none" stroke="#000000" stroke-width="2" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect> 
  <rect x="20.265625" y="30" width="97.28125" height="19" r="0" rx="0" ry="0" fill="#ffffff" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect> 
  <text x="68.640625" y="39.5" text-anchor="middle" stroke="none" fill="#000000" style='-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: middle; font-style: normal; font-variant: normal; font-weight: normal; font-stretch: normal; font-size: 16px; line-height: normal; font-family: "Andale Mono", monospace;' font-size="16px"> 
   <tspan dy="5.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     encryptStorage 
   </tspan> 
  </text> 
  <rect x="10" y="207" width="117.28125" height="39" r="0" rx="0" ry="0" fill="none" stroke="#000000" stroke-width="2" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect> 
  <rect x="20.265625" y="217" width="97.28125" height="19" r="0" rx="0" ry="0" fill="#ffffff" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect> 
  <text x="68.640625" y="226.5" text-anchor="middle" stroke="none" fill="#000000" style='-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: middle; font-style: normal; font-variant: normal; font-weight: normal; font-stretch: normal; font-size: 16px; line-height: normal; font-family: "Andale Mono", monospace;' font-size="16px"> 
   <tspan dy="5.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     encryptStorage 
   </tspan> 
  </text> 
  <path fill="none" stroke="#000000" d="M68.640625,59L68.640625,207" stroke-width="2" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path> 
  <rect x="409.515625" y="20" width="184.40625" height="39" r="0" rx="0" ry="0" fill="none" stroke="#000000" stroke-width="2" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect> 
  <rect x="419.78125" y="30" width="164.40625" height="19" r="0" rx="0" ry="0" fill="#ffffff" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect> 
  <text x="501.71875" y="39.5" text-anchor="middle" stroke="none" fill="#000000" style='-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: middle; font-style: normal; font-variant: normal; font-weight: normal; font-stretch: normal; font-size: 16px; line-height: normal; font-family: "Andale Mono", monospace;' font-size="16px"> 
   <tspan dy="5.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     mCryptConnector.execute 
   </tspan> 
  </text> 
  <rect x="409.515625" y="207" width="184.40625" height="39" r="0" rx="0" ry="0" fill="none" stroke="#000000" stroke-width="2" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect> 
  <rect x="419.78125" y="217" width="164.40625" height="19" r="0" rx="0" ry="0" fill="#ffffff" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect> 
  <text x="501.71875" y="226.5" text-anchor="middle" stroke="none" fill="#000000" style='-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: middle; font-style: normal; font-variant: normal; font-weight: normal; font-stretch: normal; font-size: 16px; line-height: normal; font-family: "Andale Mono", monospace;' font-size="16px"> 
   <tspan dy="5.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     mCryptConnector.execute 
   </tspan> 
  </text> 
  <path fill="none" stroke="#000000" d="M501.71875,59L501.71875,207" stroke-width="2" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path> 
  <rect x="613.921875" y="20" width="347.421875" height="39" r="0" rx="0" ry="0" fill="none" stroke="#000000" stroke-width="2" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect> 
  <rect x="623.90625" y="30" width="327.421875" height="19" r="0" rx="0" ry="0" fill="#ffffff" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect> 
  <text x="787.6328125" y="39.5" text-anchor="middle" stroke="none" fill="#000000" style='-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: middle; font-style: normal; font-variant: normal; font-weight: normal; font-stretch: normal; font-size: 16px; line-height: normal; font-family: "Andale Mono", monospace;' font-size="16px"> 
   <tspan dy="5.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     CryptCommandListener_CryptfsCmd_runCommand 
   </tspan> 
  </text> 
  <rect x="613.921875" y="207" width="347.421875" height="39" r="0" rx="0" ry="0" fill="none" stroke="#000000" stroke-width="2" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect> 
  <rect x="623.90625" y="217" width="327.421875" height="19" r="0" rx="0" ry="0" fill="#ffffff" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect> 
  <text x="787.6328125" y="226.5" text-anchor="middle" stroke="none" fill="#000000" style='-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: middle; font-style: normal; font-variant: normal; font-weight: normal; font-stretch: normal; font-size: 16px; line-height: normal; font-family: "Andale Mono", monospace;' font-size="16px"> 
   <tspan dy="5.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     CryptCommandListener_CryptfsCmd_runCommand 
   </tspan> 
  </text> 
  <path fill="none" stroke="#000000" d="M787.6328125,59L787.6328125,207" stroke-width="2" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path> 
  <rect x="981.34375" y="20" width="64.046875" height="39" r="0" rx="0" ry="0" fill="none" stroke="#000000" stroke-width="2" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect> 
  <rect x="991.6875" y="30" width="44.046875" height="19" r="0" rx="0" ry="0" fill="#ffffff" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect> 
  <text x="1013.3671875" y="39.5" text-anchor="middle" stroke="none" fill="#000000" style='-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: middle; font-style: normal; font-variant: normal; font-weight: normal; font-stretch: normal; font-size: 16px; line-height: normal; font-family: "Andale Mono", monospace;' font-size="16px"> 
   <tspan dy="5.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     cryptfs 
   </tspan> 
  </text> 
  <rect x="981.34375" y="207" width="64.046875" height="39" r="0" rx="0" ry="0" fill="none" stroke="#000000" stroke-width="2" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect> 
  <rect x="991.6875" y="217" width="44.046875" height="19" r="0" rx="0" ry="0" fill="#ffffff" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect> 
  <text x="1013.3671875" y="226.5" text-anchor="middle" stroke="none" fill="#000000" style='-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: middle; font-style: normal; font-variant: normal; font-weight: normal; font-stretch: normal; font-size: 16px; line-height: normal; font-family: "Andale Mono", monospace;' font-size="16px"> 
   <tspan dy="5.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     cryptfs 
   </tspan> 
  </text> 
  <path fill="none" stroke="#000000" d="M1013.3671875,59L1013.3671875,207" stroke-width="2" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path> 
  <rect x="269.171875" y="74.5" width="31" height="19" r="0" rx="0" ry="0" fill="#ffffff" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect> 
  <text x="285.1796875" y="84" text-anchor="middle" stroke="none" fill="#000000" style='-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: middle; font-style: normal; font-variant: normal; font-weight: normal; font-stretch: normal; font-size: 16px; line-height: normal; font-family: "Andale Mono", monospace;' font-size="16px"> 
   <tspan dy="5.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     加密 
   </tspan> 
  </text> 
  <path fill="none" stroke="#000000" d="M68.640625,98C68.640625,98,448.5821460012812,98,496.7241502492463,98" stroke-width="2" marker-end="url(#raphael-marker-endblock55)" stroke-dasharray="0" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path> 
  <rect x="88.640625" y="118" width="393.078125" height="29" r="0" rx="0" ry="0" fill="none" stroke="#000000" stroke-width="2" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect> 
  <rect x="93.625" y="123" width="383.078125" height="19" r="0" rx="0" ry="0" fill="#ffffff" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect> 
  <text x="285.1796875" y="132.5" text-anchor="middle" stroke="none" fill="#000000" style='-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: middle; font-style: normal; font-variant: normal; font-weight: normal; font-stretch: normal; font-size: 16px; line-height: normal; font-family: "Andale Mono", monospace;' font-size="16px"> 
   <tspan dy="5.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     socket：CryptCommandListener::CryptfsCmd::runCommand 
   </tspan> 
  </text> 
  <rect x="0" y="0" width="0" height="0" r="0" rx="0" ry="0" fill="#ffffff" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect> 
  <text x="644.67578125" y="172" text-anchor="middle" stroke="none" fill="#000000" style='-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: middle; font-style: normal; font-variant: normal; font-weight: normal; font-stretch: normal; font-size: 16px; line-height: normal; font-family: "Andale Mono", monospace;' font-size="16px"> 
   <tspan dy="172" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></tspan> 
  </text> 
  <path fill="none" stroke="#000000" d="M501.71875,167C501.71875,167,744.5751385041513,167,782.6400314288742,167" stroke-width="2" marker-end="url(#raphael-marker-endblock55)" stroke-dasharray="0" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path> 
  <rect x="0" y="0" width="0" height="0" r="0" rx="0" ry="0" fill="#ffffff" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect> 
  <text x="900.5" y="192" text-anchor="middle" stroke="none" fill="#000000" style='-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: middle; font-style: normal; font-variant: normal; font-weight: normal; font-stretch: normal; font-size: 16px; line-height: normal; font-family: "Andale Mono", monospace;' font-size="16px"> 
   <tspan dy="192" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></tspan> 
  </text> 
  <path fill="none" stroke="#000000" d="M787.6328125,187C787.6328125,187,975.129579118453,187,1008.3626485923292,187" stroke-width="2" marker-end="url(#raphael-marker-endblock55)" stroke-dasharray="0" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path> 
 </svg> 
</div> 
<pre class="prettyprint"><code class=" hljs ocaml">主要代码解释
<span class="hljs-built_in">int</span> CryptCommandListener::CryptfsCmd::runCommand(SocketClient *cli,
                                             <span class="hljs-built_in">int</span> argc, <span class="hljs-built_in">char</span> **argv) {
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!strcmp(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"cryptocomplete"</span>)) {
        <span class="hljs-built_in">int</span> <span class="hljs-class"><span class="hljs-keyword">type</span> =</span> getType(argv[<span class="hljs-number">3</span>]);
        <span class="hljs-keyword">if</span> (<span class="hljs-class"><span class="hljs-keyword">type</span> =</span>= -<span class="hljs-number">1</span>) {
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-class"><span class="hljs-keyword">type</span> =</span>= CRYPT_TYPE_DEFAULT) {
          rc = cryptfs_enable_default(argv[<span class="hljs-number">2</span>],<span class="hljs-comment">/*allow_reboot*/</span><span class="hljs-keyword">false</span>);
        } <span class="hljs-keyword">else</span> {
            rc = cryptfs_enable(argv[<span class="hljs-number">2</span>], <span class="hljs-class"><span class="hljs-keyword">type</span>, <span class="hljs-title">argv</span>[4],</span>
                                <span class="hljs-comment">/*allow_reboot*/</span><span class="hljs-keyword">false</span>);
        }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!strcmp(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"changepw"</span>)) {
}</code></pre> 
<pre class="prettyprint"><code class=" hljs cs"><span class="hljs-comment">//比较文件系统的和分区的大小</span>
<span class="hljs-keyword">int</span> cryptfs_enable_internal(<span class="hljs-keyword">char</span> *howarg, <span class="hljs-keyword">int</span> crypt_type, <span class="hljs-keyword">char</span> *passwd,
                            <span class="hljs-keyword">int</span> allow_reboot)
    <span class="hljs-comment">/* Get the size of the real block device */</span>
    <span class="hljs-keyword">int</span> fd = open(real_blkdev, O_RDONLY|O_CLOEXEC);
    get_blkdev_size(fd, &amp;nr_sec);
        fs_size_sec = get_fs_size(real_blkdev);
        <span class="hljs-keyword">if</span> (fs_size_sec &gt; max_fs_size_sec) {
            SLOGE(<span class="hljs-string">"Orig filesystem overlaps crypto footer region.  Cannot encrypt in place."</span>);</code></pre> 
<pre class="prettyprint"><code class=" hljs objectivec"><span class="hljs-comment">/*获得一个随机的密钥对和盐，作为加密的密码。
将密钥对和盐存储在data 分区的footer中*/</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> create_encrypted_random_key(<span class="hljs-keyword">char</span> *passwd, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> *master_key, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> *salt,crypt_mnt_ftr *crypt_ftr) {
    <span class="hljs-comment">/* Get some random bits for a key */</span>
    fd = open(<span class="hljs-string">"/dev/urandom"</span>, O_RDONLY|O_CLOEXEC);
    read(fd, key_buf, <span class="hljs-keyword">sizeof</span>(key_buf));
    read(fd, salt, SALT_LEN);
    close(fd);
    <span class="hljs-comment">/* Now encrypt it with the password */</span>
    <span class="hljs-keyword">return</span> encrypt_master_key(passwd, salt, key_buf, master_key, crypt_ftr);
}</code></pre> 
<pre class="prettyprint"><code class=" hljs applescript">/* Create mapped block device /dev/dm-<span class="hljs-number">0</span> <span class="hljs-keyword">with</span> key_index which retrieved <span class="hljs-keyword">from</span> set_hw_device_encryption_key
*/
decrypt_master_key(passwd, decrypted_master_key, &amp;crypt_ftr, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
create_crypto_blk_dev(&amp;crypt_ftr, decrypted_master_key, real_blkdev, crypto_blkdev, <span class="hljs-string">"userdata"</span>);
rc = cryptfs_enable_all_volumes(&amp;crypt_ftr, how, crypto_blkdev, real_blkdev, previously_encrypted_upto);
cryptfs_enable_all_volumes
<span class="hljs-comment">---&gt;cryptfs_enable_inplace </span>
<span class="hljs-comment">------&gt; cryptfs_enable_inplace_ext4</span></code></pre> 
<pre class="prettyprint"><code class=" hljs cs"><span class="hljs-comment">//加密进程从真实的设备节点读取数据并将其写入到mapper的设备节点中</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> cryptfs_enable_inplace_ext4(<span class="hljs-keyword">char</span> *crypto_blkdev,
                                       <span class="hljs-keyword">char</span> *real_blkdev,
                                       off64_t size,
                                       off64_t *size_already_done,
                                       off64_t tot_size,
                                       off64_t previously_encrypted_upto)
{    encrypt_groups(&amp;data);}
</code></pre> 
<h2 id="加密实现">加密实现</h2> 
<pre class="prettyprint"><code class=" hljs cs"><span class="hljs-comment">//判定当前设备是否正在被加密或者曾经加密过程被中断了。</span>
<span class="hljs-keyword">if</span> (how == CRYPTO_ENABLE_INPLACE
      &amp;&amp; get_crypt_ftr_and_key(&amp;crypt_ftr) == <span class="hljs-number">0</span>
      &amp;&amp; (crypt_ftr.flags &amp; CRYPT_ENCRYPTION_IN_PROGRESS)) {
    previously_encrypted_upto = crypt_ftr.encrypted_upto;
    crypt_ftr.encrypted_upto = <span class="hljs-number">0</span>;
    crypt_ftr.flags &amp;= ~CRYPT_ENCRYPTION_IN_PROGRESS;
    <span class="hljs-comment">//加密的状态是一直不确定的。直到加密完成，然后重启。所以，这里首先将flag设置为CRYPT_INCONSISTENT_STATE。</span>
    <span class="hljs-comment">//待加密完成之后，将CRYPT_INCONSISTENT_STATE标志移除</span>
    crypt_ftr.flags |= CRYPT_INCONSISTENT_STATE;
    put_crypt_ftr_and_key(&amp;crypt_ftr);
}
<span class="hljs-comment">//判断当前加密状态,通过ro.crypto.state属性来感知</span>
<span class="hljs-comment">//计算real block device的大小</span>
<span class="hljs-comment">//申请一个wakelock，这里可以根据需求申请partial或者full wake lock</span>
snprintf(lockid, <span class="hljs-keyword">sizeof</span>(lockid), <span class="hljs-string">"enablecrypto%d"</span>, (<span class="hljs-keyword">int</span>) getpid());
acquire_wake_lock(PARTIAL_WAKE_LOCK, lockid);
<span class="hljs-comment">/* The init files are setup to stop the class main and late start when
 * vold sets trigger_shutdown_framework.
 */</span>
<span class="hljs-comment">//设置vold.decrypt属性的值为trigger_shutdown_framework，触发init进程shutdown class main</span>
property_set(<span class="hljs-string">"vold.decrypt"</span>, <span class="hljs-string">"trigger_shutdown_framework"</span>);
SLOGD(<span class="hljs-string">"Just asked init to shut down class main\n"</span>);
<span class="hljs-comment">/* Ask vold to unmount all devices that it manages */</span>
<span class="hljs-comment">//unmount 被管理的所有设备</span>
<span class="hljs-keyword">if</span> (vold_unmountAll()) {
    SLOGE(<span class="hljs-string">"Failed to unmount all vold managed devices"</span>);
}

<span class="hljs-comment">/* Now unmount the /data partition. */</span>
<span class="hljs-comment">//挂在data分区</span>
<span class="hljs-keyword">if</span> (wait_and_unmount(DATA_MNT_POINT, <span class="hljs-keyword">false</span>)) {
    <span class="hljs-keyword">if</span> (allow_reboot) {
        <span class="hljs-keyword">goto</span> error_shutting_down;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">goto</span> error_unencrypted;
    }
}

<span class="hljs-comment">//为了提升体验，这里所做的一些额外工作</span>
<span class="hljs-comment">/* Do extra work for a better UX when doing the long inplace encryption */</span>
<span class="hljs-keyword">if</span> (how == CRYPTO_ENABLE_INPLACE) {
    <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span>data分区已经被卸载了，这里需要将tmpfs挂在到/data并且设置一个系统属性告诉系统，我们要开始加密啦。。</span>
    <span class="hljs-keyword">if</span> (fs_mgr_do_tmpfs_mount(DATA_MNT_POINT)) {
        <span class="hljs-keyword">goto</span> error_shutting_down;
    }<span class="hljs-keyword">else</span> {
         SLOGD(<span class="hljs-string">"Successful: mount tmpfs for '%s'\n"</span>, DATA_MNT_POINT);
         <span class="hljs-comment">//..</span>
    }
    <span class="hljs-comment">//告诉framework，我们要开始加密啦。framework</span>
    property_set(<span class="hljs-string">"vold.encrypt_progress"</span>, <span class="hljs-string">"0"</span>);

<span class="hljs-comment">//在/data上座一些必要的准备。</span>
<span class="hljs-comment">//设置vold.decryp=trigger_post_fs_data来触发系列动作。</span>
    <span class="hljs-comment">//动作完成之后，会将vold.post_fs_data_done设置为1，这里等待50s</span>
    <span class="hljs-comment">/*
     *property_set("vold.post_fs_data_done", "0");
     *property_set("vold.decrypt", "trigger_post_fs_data");
     *SLOGD("Just triggered post_fs_data\n");
    */</span>
    <span class="hljs-keyword">if</span> (prep_data_fs()) {
        <span class="hljs-keyword">goto</span> error_shutting_down;
    }
     <span class="hljs-comment">//等待2s，shutting down framework并不是同步进行。</span>
<span class="hljs-comment">//故，需要等待一段时间。否则在某些设备上，图形相关的服务有有问题。</span>
    sleep(<span class="hljs-number">2</span>);
}

<span class="hljs-comment">/* Start the actual work of making an encrypted filesystem */</span>
<span class="hljs-comment">/* Initialize a crypt_mnt_ftr for the partition */</span>
<span class="hljs-comment">//开始真正的加密前的初始化。首先初始化得到crypt_mnt_ftr.</span>
<span class="hljs-keyword">if</span> (previously_encrypted_upto == <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">if</span> (cryptfs_init_crypt_mnt_ftr(&amp;crypt_ftr)) {
        <span class="hljs-keyword">goto</span> error_shutting_down;
    }

    <span class="hljs-keyword">if</span> (!strcmp(key_loc, KEY_IN_FOOTER)) {
        crypt_ftr.fs_size = nr_sec
          - (CRYPT_FOOTER_OFFSET / CRYPT_SECTOR_SIZE);
    } <span class="hljs-keyword">else</span> {
        crypt_ftr.fs_size = nr_sec;
    }

    <span class="hljs-comment">//加密的状态是一直不确定的。直到加密完成，然后重启。所以，这里首先将flag设置为CRYPT_INCONSISTENT_STATE。</span>
    <span class="hljs-comment">//待加密完成之后，将CRYPT_INCONSISTENT_STATE标志移除</span>
    crypt_ftr.flags |= CRYPT_INCONSISTENT_STATE;
    crypt_ftr.crypt_type = crypt_type;
    <span class="hljs-comment">//选择不同的加密方式 "aes-xts"(使用软件加密） "aes-cbc-essiv:sha256"(使用硬件加密)</span>
    <span class="hljs-comment">//设置秘钥，将秘钥存储在分区的尾部。</span>
<span class="hljs-preprocessor">#ifndef CONFIG_HW_DISK_ENCRYPTION</span>
    strlcpy((<span class="hljs-keyword">char</span> *)crypt_ftr.crypto_type_name, <span class="hljs-string">"aes-cbc-essiv:sha256"</span>, MAX_CRYPTO_TYPE_NAME_LEN);
<span class="hljs-preprocessor">#<span class="hljs-keyword">else</span></span>
    strlcpy((<span class="hljs-keyword">char</span> *)crypt_ftr.crypto_type_name, <span class="hljs-string">"aes-xts"</span>, MAX_CRYPTO_TYPE_NAME_LEN);
    rc = clear_hw_device_encryption_key();
    rc = set_hw_device_encryption_key(passwd,

<span class="hljs-preprocessor">#<span class="hljs-keyword">endif</span></span>

    <span class="hljs-comment">/* Make an encrypted master key */</span>
    <span class="hljs-keyword">if</span> (create_encrypted_random_key(passwd, crypt_ftr.master_key, crypt_ftr.salt, &amp;crypt_ftr)) {
        SLOGE(<span class="hljs-string">"Cannot create encrypted master key\n"</span>);
        <span class="hljs-keyword">goto</span> error_shutting_down;
    }

    <span class="hljs-comment">//将key写入到分区结尾</span>
    put_crypt_ftr_and_key(&amp;crypt_ftr);

}

<span class="hljs-keyword">if</span> (how == CRYPTO_ENABLE_INPLACE) {
    <span class="hljs-comment">/* startup service classes main and late_start */</span>
    <span class="hljs-comment">//启动services class main以及late_start</span>
    property_set(<span class="hljs-string">"vold.decrypt"</span>, <span class="hljs-string">"trigger_restart_min_framework"</span>);
    SLOGD(<span class="hljs-string">"Just triggered restart_min_framework\n"</span>);
    <span class="hljs-comment">//framework正在重启。稍等就可以看到进度条的显示了。</span>
    <span class="hljs-comment">//进度条显示的含义是：正在加密的进度或者加密映射的文件进度</span>
}

<span class="hljs-comment">//创建master key</span>
<span class="hljs-comment">//将‘userdata’映射到加密节点上</span>
decrypt_master_key(passwd, decrypted_master_key, &amp;crypt_ftr, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
create_crypto_blk_dev(&amp;crypt_ftr, decrypted_master_key, real_blkdev, crypto_blkdev,
                      <span class="hljs-string">"userdata"</span>);

<span class="hljs-comment">/* If we are continuing, check checksums match */</span>
<span class="hljs-comment">//读取的sha256值，同计算得到的sha256值进行比较</span>
rc = <span class="hljs-number">0</span>;
<span class="hljs-keyword">if</span> (previously_encrypted_upto) {
    __le8 hash_first_block[SHA256_DIGEST_LENGTH];
    rc = cryptfs_SHA256_fileblock(crypto_blkdev, hash_first_block);

    <span class="hljs-keyword">if</span> (!rc &amp;&amp; memcmp(hash_first_block, crypt_ftr.hash_first_block,
                      <span class="hljs-keyword">sizeof</span>(hash_first_block)) != <span class="hljs-number">0</span>) {
        SLOGE(<span class="hljs-string">"Checksums do not match - trigger wipe"</span>);
        rc = -<span class="hljs-number">1</span>;
    }
}

<span class="hljs-keyword">if</span> (!rc) {
    rc = cryptfs_enable_all_volumes(&amp;crypt_ftr, how,
                                    crypto_blkdev, real_blkdev,
                                    previously_encrypted_upto);
}

<span class="hljs-comment">/* Calculate checksum if we are not finished */</span>
<span class="hljs-keyword">if</span> (!rc &amp;&amp; how == CRYPTO_ENABLE_INPLACE
        &amp;&amp; crypt_ftr.encrypted_upto != crypt_ftr.fs_size) {
    rc = cryptfs_SHA256_fileblock(crypto_blkdev,
                                  crypt_ftr.hash_first_block);
    <span class="hljs-keyword">if</span> (rc) {
        SLOGE(<span class="hljs-string">"Error calculating checksum for continuing encryption"</span>);
        rc = -<span class="hljs-number">1</span>;
    }
}

<span class="hljs-comment">/* Undo the dm-crypt mapping whether we succeed or not */</span>
delete_crypto_blk_dev(<span class="hljs-string">"userdata"</span>);

<span class="hljs-keyword">if</span> (! rc) {<!-- --><span class="hljs-comment">//条件判断ok</span>
    <span class="hljs-comment">/* Success */</span>
    crypt_ftr.flags &amp;= ~CRYPT_INCONSISTENT_STATE;

    <span class="hljs-keyword">if</span> (how == CRYPTO_ENABLE_INPLACE
          &amp;&amp; crypt_ftr.encrypted_upto != crypt_ftr.fs_size) {
        SLOGD(<span class="hljs-string">"Encrypted up to sector %lld - will continue after reboot"</span>,
              crypt_ftr.encrypted_upto);
        crypt_ftr.flags |= CRYPT_ENCRYPTION_IN_PROGRESS;
    }

    put_crypt_ftr_and_key(&amp;crypt_ftr);

<span class="hljs-preprocessor">#ifdef MTK_EMMC_SUPPORT</span>
    {
        <span class="hljs-keyword">struct</span> phone_encrypt_state ps;
        ps.state = PHONE_ENCRYPTED;
        <span class="hljs-keyword">if</span> (misc_set_phone_encrypt_state(&amp;ps, fstab) &lt; <span class="hljs-number">0</span>) {
            SLOGE(<span class="hljs-string">"Failed to set encrypted status to 0x%x in MISC\n"</span>, ps.state);
        }
        <span class="hljs-keyword">else</span> {
            SLOGD(<span class="hljs-string">"Success: Set encrypted status to 0x%x in MISC\n"</span>, ps.state);
        }
    }
<span class="hljs-preprocessor">#<span class="hljs-keyword">endif</span></span>

    <span class="hljs-comment">//判断ro.crypted.state的值是否为encrypted(代表加密成功)</span>
    <span class="hljs-keyword">if</span> (how == CRYPTO_ENABLE_WIPE
          || crypt_ftr.encrypted_upto == crypt_ftr.fs_size) {
      <span class="hljs-keyword">char</span> <span class="hljs-keyword">value</span>[PROPERTY_VALUE_MAX];
      property_get(<span class="hljs-string">"ro.crypto.state"</span>, <span class="hljs-keyword">value</span>, <span class="hljs-string">""</span>);
      <span class="hljs-keyword">if</span> (!strcmp(<span class="hljs-keyword">value</span>, <span class="hljs-string">""</span>)) {
        <span class="hljs-comment">/* default encryption - continue first boot sequence */</span>
        property_set(<span class="hljs-string">"ro.crypto.state"</span>, <span class="hljs-string">"encrypted"</span>);
        release_wake_lock(lockid);
        cryptfs_check_passwd(DEFAULT_PASSWORD);
        property_set(<span class="hljs-string">"vold.encrypt_progress"</span>, <span class="hljs-string">""</span>);
        cryptfs_restart_internal(<span class="hljs-number">1</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
      } <span class="hljs-keyword">else</span> {
        sleep(<span class="hljs-number">2</span>); <span class="hljs-comment">/* Give the UI a chance to show 100% progress */</span>
        cryptfs_reboot(reboot);
      }
    } <span class="hljs-keyword">else</span> {
        sleep(<span class="hljs-number">2</span>); <span class="hljs-comment">/* Partially encrypted, ensure writes flushed to ssd */</span>
        cryptfs_reboot(shutdown);
    }
} <span class="hljs-keyword">else</span> {<!-- --><span class="hljs-comment">//初始条件判断失败。</span>
    <span class="hljs-keyword">char</span> <span class="hljs-keyword">value</span>[PROPERTY_VALUE_MAX];

    property_get(<span class="hljs-string">"ro.vold.wipe_on_crypt_fail"</span>, <span class="hljs-keyword">value</span>, <span class="hljs-string">"0"</span>);
    <span class="hljs-keyword">if</span> (!strcmp(<span class="hljs-keyword">value</span>, <span class="hljs-string">"1"</span>)) {
        <span class="hljs-comment">/* wipe data if encryption failed */</span>
        SLOGE(<span class="hljs-string">"encryption failed - rebooting into recovery to wipe data\n"</span>);
        mkdir(<span class="hljs-string">"/cache/recovery"</span>, <span class="hljs-number">0700</span>);
        <span class="hljs-keyword">int</span> fd = open(<span class="hljs-string">"/cache/recovery/command"</span>, O_RDWR|O_CREAT|O_TRUNC|O_CLOEXEC, <span class="hljs-number">0600</span>);
        <span class="hljs-keyword">if</span> (fd &gt;= <span class="hljs-number">0</span>) {
            write(fd, <span class="hljs-string">"--wipe_data\n"</span>, strlen(<span class="hljs-string">"--wipe_data\n"</span>) + <span class="hljs-number">1</span>);
            write(fd, <span class="hljs-string">"--reason=cryptfs_enable_internal\n"</span>, strlen(<span class="hljs-string">"--reason=cryptfs_enable_internal\n"</span>) + <span class="hljs-number">1</span>);
            close(fd);
        } <span class="hljs-keyword">else</span> {
            SLOGE(<span class="hljs-string">"could not open /cache/recovery/command\n"</span>);
        }
        cryptfs_reboot(recovery);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">/* set property to trigger dialog */</span>
        property_set(<span class="hljs-string">"vold.encrypt_progress"</span>, <span class="hljs-string">"error_partially_encrypted"</span>);
        release_wake_lock(lockid);
    }
    <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
}
</code></pre> 
<h2 id="参考">参考</h2> 
<h3 id="vold-properties">Vold properties</h3> 
<hr> 
<table><thead><tr><th>Property</th><th>Description</th></tr></thead><tbody><tr><td>vold.decrypt=trigger_encryption</td><td>Encrypt the drive with no password.</td></tr><tr><td>vold.decrypt=trigger_default_encryption</td><td>Check the drive to see if it is encrypted with no password. If it is,decrypt and mount it, else setvold.decrypt to trigger_restart_min_framework.</td></tr><tr><td>vold.decrypt=trigger_reset_main</td><td>Set by vold to shutdown the UI asking for the disk password.</td></tr><tr><td>vold.decrypt=trigger_post_fs_data</td><td>Set by vold to prep /data with necessary directories, et al.</td></tr><tr><td>vold.decrypt=trigger_restart_framework</td><td>Set by vold to start the real framework and all services.</td></tr><tr><td>vold.decrypt=trigger_shutdown_framework</td><td>Set by vold to shutdown the full framework to start encryption.</td></tr><tr><td>vold.decrypt=trigger_restart_min_framework</td><td>Set by vold to start the progress bar UI for encryption or prompt for password, depending on the value of ro.crypto.state.</td></tr><tr><td>vold.encrypt_progress</td><td>When the framework starts up, if this property is set, enter the progress bar UI mode.</td></tr><tr><td>vold.encrypt_progress</td><td>0 to 100 The progress bar UI should display the percentage value set.</td></tr><tr><td>vold.encrypt_progress=error_partially_encrypted</td><td>The progress bar UI should display a message that the encryption failed, and give the user an option to factory reset the device.</td></tr><tr><td>vold.encrypt_progress=error_reboot_failed</td><td>The progress bar UI should display a message saying encryption completed, and give the user a button to reboot the device. This error is not expected to happen.</td></tr><tr><td>vold.encrypt_progress=error_not_encrypted</td><td>The progress bar UI should display a message saying an error occurred, no data was encrypted or lost, and give the user a button to reboot the system.</td></tr><tr><td>vold.encrypt_progress=error_shutting_down</td><td>The progress bar UI is not running, so it is unclear who will respond to this error. And it should never happen anyway.</td></tr><tr><td>vold.post_fs_data_done</td><td>0 Set by vold just before setting vold.decrypt to trigger_post_fs_data.</td></tr><tr><td>vold.post_fs_data_done</td><td>1 Set by init.rc or init.rc just after finishing the task post-fs-data.</td></tr></tbody></table> 
<hr> 
<h3 id="init-properties">init properties</h3> 
<table><thead><tr><th>Property</th><th>Description</th></tr></thead><tbody><tr><td>ro.crypto.fs_crypto_blkdev</td><td>Set by the vold command checkpw for later use by the vold command restart.</td></tr><tr><td>ro.crypto.state unencrypted</td><td>Set by init to say this system is running with an unencrypted /data ro.crypto.state encrypted. Set by init to say this system is running with an encrypted /data.</td></tr><tr><td>ro.crypto.fs_type</td><td></td></tr><tr><td>ro.crypto.fs_real_blkdev</td><td></td></tr><tr><td>ro.crypto.fs_mnt_point</td><td></td></tr><tr><td>ro.crypto.fs_options</td><td></td></tr><tr><td>ro.crypto.fs_flags</td><td>These five properties are set by init when it tries to mount /data with parameters passed in from init.rc. vold uses these to setup the crypto mapping.</td></tr><tr><td>ro.crypto.tmpfs_options</td><td>Set by init.rc with the options init should use when mounting the tmpfs /data filesystem</td></tr></tbody></table> 
<hr> 
<h3 id="init-actions">init actions</h3> 
<p>on post-fs-data <br> on nonencrypted <br> on property:vold.decrypt=trigger_reset_main <br> on property:vold.decrypt=trigger_post_fs_data <br> on property:vold.decrypt=trigger_restart_min_framework <br> on property:vold.decrypt=trigger_restart_framework <br> on property:vold.decrypt=trigger_shutdown_framework <br> on property:vold.decrypt=trigger_encryption <br> on property:vold.decrypt=trigger_default_encryption</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b4cb98783b57c989aa0b22910bf80fb5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">几张图轻松理解String.intern()</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8fd10007f4bdf23f2a7a70614e1c7d45/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">java.lang.UnsatisfiedLinkError: dalvik.system.PathClassLoader[DexPathList[[zip file &#34;/data/app/com</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>