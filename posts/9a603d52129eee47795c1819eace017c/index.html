<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>FLV格式分析 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="FLV格式分析" />
<meta property="og:description" content="1.FLV封装格式简介 FLV(Flash Video)是Adobe公司推出的⼀种流媒体格式，由于其封装后的⾳视频⽂件体积小、封装简单等特点，⾮常适合于互联⽹上使⽤。⽬前主流的视频⽹站基本都⽀持FLV。采⽤ FLV格式封装的⽂件后缀为.flv。
2.FLV封装格式分析 FLV封装格式是由**⼀个⽂件头(file header)**和 **⽂件体(file Body)**组成：
FLV body由⼀对对的(Previous Tag Size字段 &#43; tag)组成，Previous Tag Size字段排列在Tag之前，占⽤ 4个字节。**Previous Tag Size记录了前⾯⼀个Tag的大小，⽤于逆向读取处理。**FLV header 后的第⼀个Pervious Tag Size的值为0。
Tag⼀般可以分为3种类型：
脚本(帧)数据类型⾳频数据类型视频数据 FLV数据以⼤端序进⾏存储，在解析时需要注意。
⼀个标准FLV⽂件结构如下图：
FLV⽂件的详细内容结构如下图：
3.FLV封装格式详细解析 3.1.FLV解析流程 3.2.FLV header FLV头的结构如下：
FieldTypeComment签名UI8F’(0x46)签名UI8‘L’(0x4C)签名UI8‘V’(0x56)版本UI8FLV的版本。0x01表示FLV版本为1保留字段UB5前五位都为0⾳频流标识UB1是否存在⾳频流保留字段UB1为0视频流标识UB1是否存在视频流⽂件头⼤⼩UI32FLV版本1时填写9，表明的是FLV头的⼤小 数据type中，UI表示⽆符号整形，后⾯跟的数字表示其⻓度是多少位，比如：UI8，表示⽆符号整形，⻓度⼀个字节UI24是三个字节,UI[8*n]表示多个字节。UB表示位域，UB5表示⼀个字节的5位。可以参考c中的位域结构体。
FLV头占9个字节，⽤来标识⽂件为FLV类型，以及后续存储的⾳视频流，⼀个FLV⽂件，每种类型的tag都属于⼀个流，也就是⼀个flv⽂件最多只有⼀个⾳频流，⼀个视频流，不存在多个 独立的音视频流在⼀个文件的情况。
3.3.FLV Body FLV Header之后，就是FLV File Body。FLV File Body是由⼀连串的back-pointers &#43; tags构成。 Back-pointer表示Previous Tag Size(前⼀个tag的字节数据⻓度)，占4个字节。
3.4.FLV Tag tag header 每⼀个Tag也是由两部分组成:tag header和tag data。Tag Header⾥存放的是当前tag的类型、数据区(tag data)的⻓度等信息。
tag header⼀般占11个字节的内存空间。FLV tag header结构如下：
FieldTypeCommentTag类型 TypeUI88:audio 9:video 18:Script data(脚本数据) all Others:reserved 其他所有值未使⽤数据区⼤小UI24当前tag的数据域的⼤⼩，不包含tag header。 Length of the data in the Data field时间戳TimestampUI24当前帧时戳，单位是毫秒。相对值，第⼀个tag的时戳总是为0时戳扩展字段 TimestampExtendedUI8如果时戳⼤于0xFFFFFF，将会使⽤这个字节。这个字节是 时戳的⾼8位，上⾯的三个字节是低24位。StreamIDUI24总是为0数据域UI[8*n]数据域数据 １．flv⽂件中Timestamp和TimestampExtended拼出来的是dts。也就是解码时间。 Timestamp和TimestampExtended拼出来dts单位为ms。(如果不存在B帧，当然dts等于 pts)" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/9a603d52129eee47795c1819eace017c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-01-06T22:15:47+08:00" />
<meta property="article:modified_time" content="2023-01-06T22:15:47+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">FLV格式分析</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h5><a id="1FLV_0"></a>1.FLV封装格式简介</h5> 
<p>FLV(Flash Video)是Adobe公司推出的⼀种流媒体格式，由于其封装后的⾳视频⽂件体积小、封装简单等特点，⾮常适合于互联⽹上使⽤。⽬前主流的视频⽹站基本都⽀持FLV。采⽤ FLV格式封装的⽂件后缀为.flv。</p> 
<h5><a id="2FLV_4"></a>2.FLV封装格式分析</h5> 
<p>FLV封装格式是由**⼀个⽂件头(file header)**和 **⽂件体(file Body)**组成：</p> 
<p>FLV body由⼀对对的(Previous Tag Size字段 + tag)组成，Previous Tag Size字段排列在Tag之前，占⽤ 4个字节。**Previous Tag Size记录了前⾯⼀个Tag的大小，⽤于逆向读取处理。**FLV header 后的第⼀个Pervious Tag Size的值为0。</p> 
<p>Tag⼀般可以分为3种类型：</p> 
<ul><li>脚本(帧)数据类型</li><li>⾳频数据类型</li><li>视频数据</li></ul> 
<p>FLV数据以⼤端序进⾏存储，在解析时需要注意。</p> 
<p><strong>⼀个标准FLV⽂件结构如下图：</strong></p> 
<p><img src="https://images2.imgbox.com/8b/0f/p1wQBqfC_o.png" alt="在这里插入图片描述"></p> 
<p><strong>FLV⽂件的详细内容结构如下图：</strong></p> 
<p><img src="https://images2.imgbox.com/f1/c4/do0oI57h_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="3FLV_31"></a>3.FLV封装格式详细解析</h5> 
<h6><a id="31FLV_33"></a>3.1.FLV解析流程</h6> 
<p><img src="https://images2.imgbox.com/3e/ed/jE30MQw6_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="32FLV_header_38"></a>3.2.FLV header</h6> 
<p>FLV头的结构如下：</p> 
<table><thead><tr><th>Field</th><th>Type</th><th>Comment</th></tr></thead><tbody><tr><td>签名</td><td>UI8</td><td>F’(0x46)</td></tr><tr><td>签名</td><td>UI8</td><td>‘L’(0x4C)</td></tr><tr><td>签名</td><td>UI8</td><td>‘V’(0x56)</td></tr><tr><td>版本</td><td>UI8</td><td>FLV的版本。0x01表示FLV版本为1</td></tr><tr><td>保留字段</td><td>UB5</td><td>前五位都为0</td></tr><tr><td>⾳频流标识</td><td>UB1</td><td>是否存在⾳频流</td></tr><tr><td>保留字段</td><td>UB1</td><td>为0</td></tr><tr><td>视频流标识</td><td>UB1</td><td>是否存在视频流</td></tr><tr><td>⽂件头⼤⼩</td><td>UI32</td><td>FLV版本1时填写9，表明的是FLV头的⼤小</td></tr></tbody></table> 
<p>数据type中，UI表示⽆符号整形，后⾯跟的数字表示其⻓度是多少位，比如：<strong>UI8，表示⽆符号整形，⻓度⼀个字节</strong>UI24是三个字节,UI[8*n]表示多个字节。<strong>UB表示位域</strong>，UB5表示⼀个字节的5位。可以参考c中的位域结构体。</p> 
<p>FLV头占9个字节，⽤来标识⽂件为FLV类型，以及后续存储的⾳视频流，⼀个FLV⽂件，每种类型的tag都属于⼀个流，也就是⼀个flv⽂件<strong>最多只有⼀个⾳频流，⼀个视频流，不存在多个 独立的音视频流在⼀个文件的情况</strong>。</p> 
<h6><a id="33FLV_Body_60"></a>3.3.FLV Body</h6> 
<p><img src="https://images2.imgbox.com/d5/ae/D9ZKtaLO_o.png" alt="在这里插入图片描述"></p> 
<p>FLV Header之后，就是FLV File Body。FLV File Body是由⼀连串的back-pointers + tags构成。 Back-pointer表示Previous Tag Size(前⼀个tag的字节数据⻓度)，占4个字节。</p> 
<h6><a id="34FLV_Tag__tag_header_67"></a>3.4.FLV Tag tag header</h6> 
<p>每⼀个Tag也是由两部分组成:tag header和tag data。Tag Header⾥存放的是当前tag的类型、数据区(tag data)的⻓度等信息。</p> 
<p>tag header⼀般占11个字节的内存空间。FLV tag header结构如下：</p> 
<table><thead><tr><th>Field</th><th>Type</th><th>Comment</th></tr></thead><tbody><tr><td>Tag类型 Type</td><td>UI8</td><td>8:audio 9:video 18:Script data(脚本数据) all Others:reserved 其他所有值未使⽤</td></tr><tr><td>数据区⼤小</td><td>UI24</td><td>当前tag的数据域的⼤⼩，不包含tag header。 Length of the data in the Data field</td></tr><tr><td>时间戳Timestamp</td><td>UI24</td><td>当前帧时戳，单位是毫秒。相对值，第⼀个tag的时戳总是为0</td></tr><tr><td>时戳扩展字段 TimestampExtended</td><td>UI8</td><td>如果时戳⼤于0xFFFFFF，将会使⽤这个字节。这个字节是 时戳的⾼8位，上⾯的三个字节是低24位。</td></tr><tr><td>StreamID</td><td>UI24</td><td>总是为0</td></tr><tr><td>数据域</td><td>UI[8*n]</td><td>数据域数据</td></tr></tbody></table> 
<p>１．flv⽂件中Timestamp和TimestampExtended拼出来的是dts。也就是解码时间。 Timestamp和TimestampExtended拼出来dts单位为ms。(如果不存在B帧，当然dts等于 pts)</p> 
<p>２．CompositionTime 表示PTS相对于DTS的偏移值， 在每个视频tag的第14~16字节 。 显示时间(pts) = 解码时间（tag的第5~8字节） + CompositionTime CompositionTime的单位也是ms 。</p> 
<p>３．Script data脚本数据就是描述视频或⾳频的信息的数据，如宽度、⾼度、时间等等，⼀个⽂ 件中通常只有⼀个元数据，⾳频tag和视频tag就是⾳视频信息了，采样、声道、频率，编码等 信息。</p> 
<h5><a id="35FLV_Tag_data_88"></a>3.5.FLV Tag data</h5> 
<p>FLV Tag data，在FLV Tag Header之后，分为MetaData Tag、Audio Tag、Video Tag。</p> 
<h6><a id="351MetaData_Tag_92"></a>3.5.1.MetaData Tag</h6> 
<p>MetaData Tag存放⼀些关于FLV视频和⾳频的元信息，⽐如：duration、width、 height等，<strong>通常该类型Tag会作为FLV⽂件的第⼀个tag，并且只有⼀个，跟在File Header后</strong>。</p> 
<p><img src="https://images2.imgbox.com/3d/b3/tu2C1h3o_o.png" alt="在这里插入图片描述"></p> 
<p>从上图可以得到：</p> 
<ul><li>第一个PreviousTagSize值是0</li><li>MetaData Tag 的类型是12</li><li>记录的信息有duration（5.12秒）、width（768）、height（320）、videodatarate（码率207.260）、framerate（帧率25）</li></ul> 
<h6><a id="352Audio_Tag_105"></a>3.5.2.Audio Tag</h6> 
<p>⾳频Tag Data区域开始的：</p> 
<ul><li>第⼀个字节包含了⾳频数据的参数信息</li><li>第⼆个字节开始为⾳频流数据</li></ul> 
<p>注意：这两个字节属于tag的data部分，不是header部分。</p> 
<p>第⼀个字节为⾳频的信息格式如下：</p> 
<table><thead><tr><th>Field</th><th>Type</th><th>Comment</th></tr></thead><tbody><tr><td>⾳频格式 SoundFormat</td><td>UB4</td><td>0 = Linear PCM, platform endian 2 = MP3 10 = AAC</td></tr><tr><td>采样率 SoundRate</td><td>UB2</td><td>对于AAC总是3(这个参数对于AAC意义不⼤)</td></tr><tr><td>采样精度 SoundSize</td><td>UB1</td><td>0 = snd8Bit 1 = snd16Bit 此参数仅适⽤于未压缩的格式，压缩后的格式都是将其设为1</td></tr><tr><td>⾳频声道 SoundType</td><td>UB1</td><td>0 = sndMono 单声道 1 = sndStereo ⽴体声，双声道 (对于AAC总是1)</td></tr></tbody></table> 
<p>第⼆个字节开始为⾳频数据（需要判断该数据是真正的⾳频数据，还是⾳频config信息）</p> 
<h6><a id="353Video_Tag_127"></a>3.5.3.Video Tag</h6> 
<p>视频Tag Data开始的：</p> 
<ul><li> <p>第⼀个字节包含视频数据的参数信息</p> </li><li> <p>第⼆个字节开始为视频流数据</p> </li></ul> 
<p>第⼀个字节包含视频信息，格式如下:</p> 
<p><img src="https://images2.imgbox.com/5d/b6/wqf8ozX6_o.png" alt="在这里插入图片描述"></p> 
<p>第⼆个字节开始为视频数据 :</p> 
<p><img src="https://images2.imgbox.com/e5/5e/H7ORx3mk_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5423fcb2dee1a3f0954969e00317c69e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">20.04安装carla0.9.13记录</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/829754059df714cdd62af495b89c8bf7/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">相机标定中的战斗机--张氏标定法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>