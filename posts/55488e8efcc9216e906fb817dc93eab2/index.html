<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android 源码分析 - 输入 - Java层 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android 源码分析 - 输入 - Java层" />
<meta property="og:description" content="输入框架层包含一个服务（位于services目录），一个接口（位于core目录），一个工具（位于cmds目录）。
android.view libinput中的C&#43;&#43;类，在jni层都有一个对应的Native开头的类，封装libinput中的对象的指针。在java层有一个类对应，其Ptr成员保存Native类的指针。
java源代码位于：frameworks/base/core/java/android/view。
jni源代码位于：frameworks/base/core/jni。
java
jni
C&#43;&#43;
InputChannel
NativeInputChannel
InputChannel
KeyCharacterMap
NativeKeyCharacterMap
KeyCharacterMap
InputDevice
InputDeviceInfo
KeyEvent
KeyEvent
MotionEvent
MotionEvent
InputEventSender
NativeInputEventSender
InputPublisher
InputEventReceiver
NativeInputEventReceiver
InputConsumer
InputChannel（java）的静态native方法nativeOpenInputChannelPair()创建一对InputChannel。NativeInputChannel支持序列化Parcel，是跨进程传递UNIX域套接字句柄的关键。
InputEventReceiver 的jni层对象NativeInputEventReceiver通过MessageQueue处理InputChannel文件描述符上的数据到达，通过InputConsumer读取输入事件，回调java层对象方法。这些都在上层Looper线程中执行。另一方面，将应答写入InputChannel。
InputEventSender的jni层对象NativeInputEventSender通过InputPublisher向InputChannel写入输入事件，并通过MessageQueue等待应答，然后读取应答并回调java层。
ViewRootImpl是应用层接收并处理输入事件的关键。其setView方法中创建了一个然后通过IWindowSession（com.android.server.wm.Session实现）注册该窗口，最终由WindowManagerService打开一对InputChannel，并将读取端返回给ViewRootImpl。
ViewRootImpl通过嵌套类WindowInputEventReceiver（继承InputEventReceiver）读取输入事件，事件在队列中排队处理。
类型说明：
类名
说明
InputChannel
KeyCharacterMap
InputDevice
KeyEvent
MotionEvent
InputEventReceiver
InputEventSender
ViewRootImpl
窗口，管理输入事件，调用会话接口使用窗口服务
InputQueue
提供由应用处理输入事件的机制，在native层使用
InputStage
分发策略，如果没有处理（包括丢弃），本地丢弃或者本地处理（onProcess），然后向前转发（onDeliverToNext）
AsyncInputStage
异步分发，保持顺序向前转发。
ViewRootImpl.WindowInputEventReceiver
继承InputEventReceiver，将收到的输入事件排队处理
FallbackEventHandler
输入事件处理器策略基类，在EarlyPostIme、ViewPostIme阶段被调用
android.hardware.input 源代码位于：frameworks/base/core/java/android/hardware/input。
InputManager转发调用到input服务，分发设备增加、删除、改变事件到注册的InputDeviceListener。
com.android.internal.view 源代码位于：frameworks/base/core/java/com/android/internal/view。
内部实现类：
类名
说明
IInputContext
输入法回调应用的接口方法定义，接口是异步的，通过IInputContextCallback返回Get结果
IInputContextCallback
应用响应输入法返回Get请求的信息。
InputBindResult
输入法管理服务成功绑定了一个输入法后返回的信息
IInputConnectionWrapper" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/55488e8efcc9216e906fb817dc93eab2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-10-23T22:32:16+08:00" />
<meta property="article:modified_time" content="2021-10-23T22:32:16+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android 源码分析 - 输入 - Java层</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p style="margin-left:0;text-align:justify;">        输入框架层包含一个服务（位于services目录），一个接口（位于core目录），一个工具（位于cmds目录）。</p> 
<h3 style="margin-left:0px;text-align:justify;">android.view</h3> 
<p style="margin-left:0;text-align:justify;">        libinput中的C++类，在jni层都有一个对应的Native开头的类，封装libinput中的对象的指针。在java层有一个类对应，其Ptr成员保存Native类的指针。</p> 
<p style="margin-left:0;text-align:justify;">        java源代码位于：frameworks/base/core/java/android/view。</p> 
<p style="margin-left:0;text-align:justify;">        jni源代码位于：frameworks/base/core/jni。</p> 
<table border="1" cellspacing="0"><tbody><tr><td style="background-color:#808080;border-color:#000000;width:105.3pt;"> <p style="margin-left:0;text-align:center;"><strong>java</strong></p> </td><td style="background-color:#808080;border-color:#000000;width:146.25pt;"> <p style="margin-left:0;text-align:center;"><strong><span style="color:#000000;">jni</span></strong></p> </td><td style="background-color:#808080;border-color:#000000;width:163.25pt;"> <p style="margin-left:0;text-align:center;"><strong><span style="color:#000000;">C++</span></strong></p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:105.3pt;"> <p style="margin-left:0;text-align:justify;">InputChannel</p> </td><td style="vertical-align:top;width:146.25pt;"> <p style="margin-left:0;text-align:justify;">NativeInputChannel</p> </td><td style="vertical-align:top;width:163.25pt;"> <p style="margin-left:0;text-align:justify;">InputChannel</p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:105.3pt;"> <p style="margin-left:0;text-align:justify;">KeyCharacterMap</p> </td><td style="vertical-align:top;width:146.25pt;"> <p style="margin-left:0;text-align:justify;">NativeKeyCharacterMap</p> </td><td style="vertical-align:top;width:163.25pt;"> <p style="margin-left:0;text-align:justify;">KeyCharacterMap</p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:105.3pt;"> <p style="margin-left:0;text-align:justify;">InputDevice</p> </td><td style="vertical-align:top;width:146.25pt;"> <p style="margin-left:0;text-align:justify;"></p> </td><td style="vertical-align:top;width:163.25pt;"> <p style="margin-left:0;text-align:justify;">InputDeviceInfo</p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:105.3pt;"> <p style="margin-left:0;text-align:justify;">KeyEvent</p> </td><td style="vertical-align:top;width:146.25pt;"> <p style="margin-left:0;text-align:justify;"></p> </td><td style="vertical-align:top;width:163.25pt;"> <p style="margin-left:0;text-align:justify;">KeyEvent</p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:105.3pt;"> <p style="margin-left:0;text-align:justify;">MotionEvent</p> </td><td style="vertical-align:top;width:146.25pt;"> <p style="margin-left:0;text-align:justify;"></p> </td><td style="vertical-align:top;width:163.25pt;"> <p style="margin-left:0;text-align:justify;">MotionEvent</p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:105.3pt;"> <p style="margin-left:0;text-align:justify;">InputEventSender</p> </td><td style="vertical-align:top;width:146.25pt;"> <p style="margin-left:0;text-align:justify;">NativeInputEventSender</p> </td><td style="vertical-align:top;width:163.25pt;"> <p style="margin-left:0;text-align:justify;">InputPublisher</p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:105.3pt;"> <p style="margin-left:0;text-align:justify;">InputEventReceiver</p> </td><td style="vertical-align:top;width:146.25pt;"> <p style="margin-left:0;text-align:justify;">NativeInputEventReceiver</p> </td><td style="vertical-align:top;width:163.25pt;"> <p style="margin-left:0;text-align:justify;">InputConsumer</p> </td></tr></tbody></table> 
<p style="margin-left:0;text-align:justify;">        InputChannel（java）的静态native方法nativeOpenInputChannelPair()创建一对InputChannel。NativeInputChannel支持序列化Parcel，是跨进程传递UNIX域套接字句柄的关键。</p> 
<p style="margin-left:0;text-align:justify;">        InputEventReceiver 的jni层对象NativeInputEventReceiver通过MessageQueue处理InputChannel文件描述符上的数据到达，通过InputConsumer读取输入事件，回调java层对象方法。这些都在上层Looper线程中执行。另一方面，将应答写入InputChannel。</p> 
<p style="margin-left:0;text-align:justify;">        InputEventSender的jni层对象NativeInputEventSender通过InputPublisher向InputChannel写入输入事件，并通过MessageQueue等待应答，然后读取应答并回调java层。</p> 
<p style="margin-left:0;text-align:justify;">        ViewRootImpl是应用层接收并处理输入事件的关键。其setView方法中创建了一个然后通过IWindowSession（com.android.server.wm.Session实现）注册该窗口，最终由WindowManagerService打开一对InputChannel，并将读取端返回给ViewRootImpl。</p> 
<p style="margin-left:0;text-align:justify;">        ViewRootImpl通过嵌套类WindowInputEventReceiver（继承InputEventReceiver）读取输入事件，事件在队列中排队处理。</p> 
<p style="margin-left:0;text-align:justify;"><a name="_Toc399237435" title="类型说明：">类型说明：</a></p> 
<table border="1" cellspacing="0" style="width:557px;"><tbody><tr><td style="border-color:#000000;vertical-align:top;width:120.25pt;"> <p style="margin-left:0;text-align:center;"><strong>类名</strong></p> </td><td style="border-color:#000000;vertical-align:top;width:297.7pt;"> <p style="margin-left:0;text-align:center;"><strong>说明</strong></p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:120.25pt;"> <p style="margin-left:0;text-align:justify;">InputChannel</p> </td><td style="vertical-align:top;width:297.7pt;"> <p style="margin-left:0;text-align:justify;"></p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:120.25pt;"> <p style="margin-left:0;text-align:justify;">KeyCharacterMap</p> </td><td style="vertical-align:top;width:297.7pt;"> <p style="margin-left:0;text-align:justify;"></p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:120.25pt;"> <p style="margin-left:0;text-align:justify;">InputDevice</p> </td><td style="vertical-align:top;width:297.7pt;"> <p style="margin-left:0;text-align:justify;"></p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:120.25pt;"> <p style="margin-left:0;text-align:justify;">KeyEvent</p> </td><td style="vertical-align:top;width:297.7pt;"> <p style="margin-left:0;text-align:justify;"></p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:120.25pt;"> <p style="margin-left:0;text-align:justify;">MotionEvent</p> </td><td style="vertical-align:top;width:297.7pt;"> <p style="margin-left:0;text-align:justify;"></p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:120.25pt;"> <p style="margin-left:0;text-align:justify;">InputEventReceiver</p> </td><td style="vertical-align:top;width:297.7pt;"> <p style="margin-left:0;text-align:justify;"></p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:120.25pt;"> <p style="margin-left:0;text-align:justify;">InputEventSender</p> </td><td style="vertical-align:top;width:297.7pt;"> <p style="margin-left:0;text-align:justify;"></p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:120.25pt;"> <p style="margin-left:0;text-align:justify;">ViewRootImpl</p> </td><td style="vertical-align:top;width:297.7pt;"> <p style="margin-left:0;text-align:justify;">窗口，管理输入事件，调用会话接口使用窗口服务</p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:120.25pt;"> <p style="margin-left:0;text-align:justify;">InputQueue</p> </td><td style="vertical-align:top;width:297.7pt;"> <p style="margin-left:0;text-align:justify;">提供由应用处理输入事件的机制，在native层使用</p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:120.25pt;"> <p style="margin-left:0;text-align:justify;">InputStage</p> </td><td style="vertical-align:top;width:297.7pt;"> <p style="margin-left:0;text-align:justify;">分发策略，如果没有处理（包括丢弃），本地丢弃或者本地处理（onProcess），然后向前转发（onDeliverToNext）</p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:120.25pt;"> <p style="margin-left:0;text-align:justify;">AsyncInputStage</p> </td><td style="vertical-align:top;width:297.7pt;"> <p style="margin-left:0;text-align:justify;">异步分发，保持顺序向前转发。</p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:120.25pt;"> <p style="margin-left:0;text-align:justify;">ViewRootImpl.WindowInputEventReceiver</p> </td><td style="vertical-align:top;width:297.7pt;"> <p style="margin-left:0;text-align:justify;">继承InputEventReceiver，将收到的输入事件排队处理</p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:120.25pt;"> <p style="margin-left:0;text-align:justify;">FallbackEventHandler</p> </td><td style="vertical-align:top;width:297.7pt;"> <p style="margin-left:0;text-align:justify;">输入事件处理器策略基类，在EarlyPostIme、ViewPostIme阶段被调用</p> </td></tr></tbody></table> 
<h3>android.hardware.input</h3> 
<p style="margin-left:0;text-align:justify;">        源代码位于：frameworks/base/core/java/android/hardware/input。</p> 
<p style="margin-left:0;text-align:justify;">        InputManager转发调用到input服务，分发设备增加、删除、改变事件到注册的InputDeviceListener。</p> 
<h3 style="margin-left:0px;text-align:justify;">com.android.internal.view</h3> 
<p style="margin-left:0;text-align:justify;">        源代码位于：frameworks/base/core/java/com/android/internal/view。</p> 
<p style="margin-left:0;text-align:justify;">        内部实现类：</p> 
<table border="1" cellspacing="0" style="width:557px;"><tbody><tr><td style="border-color:#000000;vertical-align:top;width:120.25pt;"> <p style="margin-left:0;text-align:center;"><strong>类名</strong></p> </td><td style="border-color:#000000;vertical-align:top;width:297.7pt;"> <p style="margin-left:0;text-align:center;"><strong>说明</strong></p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:120.25pt;"> <p style="margin-left:0;text-align:justify;">IInputContext</p> </td><td style="vertical-align:top;width:297.7pt;"> <p style="margin-left:0;text-align:justify;">输入法回调应用的接口方法定义，接口是异步的，通过IInputContextCallback返回Get结果</p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:120.25pt;"> <p style="margin-left:0;text-align:justify;">IInputContextCallback</p> </td><td style="vertical-align:top;width:297.7pt;"> <p style="margin-left:0;text-align:justify;">应用响应输入法返回Get请求的信息。</p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:120.25pt;"> <p style="margin-left:0;text-align:justify;">InputBindResult</p> </td><td style="vertical-align:top;width:297.7pt;"> <p style="margin-left:0;text-align:justify;">输入法管理服务成功绑定了一个输入法后返回的信息</p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:120.25pt;"> <p style="margin-left:0;text-align:justify;">IInputConnectionWrapper</p> </td><td style="vertical-align:top;width:297.7pt;"> <p style="margin-left:0;text-align:justify;">通过InputConnection实现IInputContext，使用异步消息机制转发到Looper线程执行，执行时检查InputConnection失效或者禁用</p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:120.25pt;"> <p style="margin-left:0;text-align:justify;">InputConnectionWrapper</p> </td><td style="vertical-align:top;width:297.7pt;"> <p style="margin-left:0;text-align:justify;">通过IInputContext实现InputConnection接口，异步Get转换为同步</p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:120.25pt;"> <p style="margin-left:0;text-align:justify;">IInputMethod</p> </td><td style="vertical-align:top;width:297.7pt;"> <p style="margin-left:0;text-align:justify;">输入法接口</p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:120.25pt;"> <p style="margin-left:0;text-align:justify;">IInputMethodClient</p> </td><td style="vertical-align:top;width:297.7pt;"> <p style="margin-left:0;text-align:justify;">输入法管理服务回调客户端的接口</p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:120.25pt;"> <p style="margin-left:0;text-align:justify;">IInputMethodManager</p> </td><td style="vertical-align:top;width:297.7pt;"> <p style="margin-left:0;text-align:justify;">输入法管理服务的接口定义</p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:120.25pt;"> <p style="margin-left:0;text-align:justify;">IInputMethodSession</p> </td><td style="vertical-align:top;width:297.7pt;"> <p style="margin-left:0;text-align:justify;">输入法会话接口，startInput返回</p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:120.25pt;"> <p style="margin-left:0;text-align:justify;">IInputSessionCallback</p> </td><td style="vertical-align:top;width:297.7pt;"> <p style="margin-left:0;text-align:justify;">输入法通知应用会话创建成功的接口</p> </td></tr></tbody></table> 
<h3>android.view.inputmethod</h3> 
<p style="margin-left:0;text-align:justify;">        提供应用访问接口，与服务通信。</p> 
<p style="margin-left:0;text-align:justify;">        源代码位于：frameworks/base/core/java/android/view/inputmethod。</p> 
<p style="margin-left:0;text-align:justify;">        类型说明：</p> 
<table border="1" cellspacing="0" style="width:557px;"><tbody><tr><td style="border-color:#000000;vertical-align:top;width:120.25pt;"> <p style="margin-left:0;text-align:center;"><strong>类名</strong></p> </td><td style="border-color:#000000;vertical-align:top;width:297.7pt;"> <p style="margin-left:0;text-align:center;"><strong>说明</strong></p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:120.25pt;"> <p style="margin-left:0;text-align:justify;">InputMethodManager</p> </td><td style="vertical-align:top;width:297.7pt;"> <p style="margin-left:0;text-align:justify;">输入法管理服务的本地代理</p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:120.25pt;"> <p style="margin-left:0;text-align:justify;">InputMethod</p> </td><td style="vertical-align:top;width:297.7pt;"> <p style="margin-left:0;text-align:justify;">进程内输入法接口，相对于IInputMethod，使用InputConnection，不处理InputChannel</p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:120.25pt;"> <p style="margin-left:0;text-align:justify;">InputMethodSession</p> </td><td style="vertical-align:top;width:297.7pt;"> <p style="margin-left:0;text-align:justify;">进程内输入法会话接口，相对于IInputMethodSession，多了几个dispatch*Event接口</p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:120.25pt;"> <p style="margin-left:0;text-align:justify;">InputMethodInfo</p> </td><td style="vertical-align:top;width:297.7pt;"> <p style="margin-left:0;text-align:justify;">输入法描述信息</p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:120.25pt;"> <p style="margin-left:0;text-align:justify;">InputConnection</p> </td><td style="vertical-align:top;width:297.7pt;"> <p style="margin-left:0;text-align:justify;">输入法回调应用的接口方法定义</p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:120.25pt;"> <p style="margin-left:0;text-align:justify;">BaseInputConnection</p> </td><td style="vertical-align:top;width:297.7pt;"> <p style="margin-left:0;text-align:justify;">实现InputConnection接口，与Editable绑定</p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:120.25pt;"> <p style="margin-left:0;text-align:justify;">SuggestionSpan</p> </td><td style="vertical-align:top;width:297.7pt;"> <p style="margin-left:0;text-align:justify;">文字替换建议</p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:120.25pt;"> <p style="margin-left:0;text-align:justify;">EditorInfo</p> </td><td style="vertical-align:top;width:297.7pt;"> <p style="margin-left:0;text-align:justify;"></p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:120.25pt;"> <p style="margin-left:0;text-align:justify;">CompletionInfo</p> </td><td style="vertical-align:top;width:297.7pt;"> <p style="margin-left:0;text-align:justify;"></p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:120.25pt;"> <p style="margin-left:0;text-align:justify;">InputBinding</p> </td><td style="vertical-align:top;width:297.7pt;"> <p style="margin-left:0;text-align:justify;">绑定一个InputConnection和一个Token，传给输入法</p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:120.25pt;"> <p style="margin-left:0;text-align:justify;">InputMethodSubtype</p> </td><td style="vertical-align:top;width:297.7pt;"> <p style="margin-left:0;text-align:justify;">输入法子类型描述，Locale、Mode（键盘，语音）</p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:120.25pt;"> <p style="margin-left:0;text-align:justify;">InputConnectionWrapper</p> </td><td style="vertical-align:top;width:297.7pt;"> <p style="margin-left:0;text-align:justify;">包装另一个InputConnection接口</p> </td></tr></tbody></table> 
<p style="margin-left:0;text-align:justify;">InputMethodManager辅助类型（嵌套类）说明：</p> 
<table border="1" cellspacing="0" style="width:557px;"><tbody><tr><td style="border-color:#000000;vertical-align:top;width:184.05pt;"> <p style="margin-left:0;text-align:center;"><strong>类名</strong></p> </td><td style="border-color:#000000;vertical-align:top;width:233.9pt;"> <p style="margin-left:0;text-align:center;"><strong>说明</strong></p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:184.05pt;"> <p style="margin-left:0;text-align:justify;">ImeInputEventSender</p> </td><td style="vertical-align:top;width:233.9pt;"> <p style="margin-left:0;text-align:justify;">继承InputEventSender，与输入法通信也是通过InputChannel实现</p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:184.05pt;"> <p style="margin-left:0;text-align:justify;">FinishedInputEventCallback</p> </td><td style="vertical-align:top;width:233.9pt;"> <p style="margin-left:0;text-align:justify;">输入事件应答接口，一般由ViewRoot实现</p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:184.05pt;"> <p style="margin-left:0;text-align:justify;">ControlledInputConnectionWrapper</p> </td><td style="vertical-align:top;width:233.9pt;"> <p style="margin-left:0;text-align:justify;">继承IInputConnectionWrapper，控制active</p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:184.05pt;"> <p style="margin-left:0;text-align:justify;">PendingEvent</p> </td><td style="vertical-align:top;width:233.9pt;"> <p style="margin-left:0;text-align:justify;">等待应答的输入事件</p> </td></tr></tbody></table> 
<p style="margin-left:0;text-align:justify;">        InputMethodManager通过IInputConnectionWrapper适配InputConnection到IInputContext。应用通过InputMethodManager转发调用IInputMethodSession的接口。</p> 
<h3 style="margin-left:0px;text-align:justify;">com.android.internal.inputmethod</h3> 
<p style="margin-left:0;text-align:justify;">        辅助类型：</p> 
<table border="1" cellspacing="0" style="width:557px;"><tbody><tr><td style="border-color:#000000;vertical-align:top;width:184.05pt;"> <p style="margin-left:0;text-align:center;"><strong>类名</strong></p> </td><td style="border-color:#000000;vertical-align:top;width:233.9pt;"> <p style="margin-left:0;text-align:center;"><strong>说明</strong></p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:184.05pt;"> <p style="margin-left:0;text-align:justify;">InputMethodUtils</p> </td><td style="vertical-align:top;width:233.9pt;"> <p style="margin-left:0;text-align:justify;"></p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:184.05pt;"> <p style="margin-left:0;text-align:justify;">InputMethodUtils.</p> <p style="margin-left:0;text-align:justify;">InputMethodSettings</p> </td><td style="vertical-align:top;width:233.9pt;"> <p style="margin-left:0;text-align:justify;"></p> </td></tr></tbody></table> 
<ul><li style="text-align:justify;">系统输入法：isSystemIme，FLAG_SYSTEM</li><li style="text-align:justify;">辅助输入法：isAuxiliaryIme</li><li style="text-align:justify;">子类型：语言 + 模式（键盘或者语音）</li><li style="text-align:justify;">自动子类型：包含至少一个默认激活的子类型</li><li style="text-align:justify;">默认激活：isDefaultEnabledIme，必须满足：</li></ul> 
<ol><li style="text-align:justify;">系统输入法</li><li style="text-align:justify;">满足下面一组： 
  <ol><li style="text-align:justify;">组1 
    <ol><li style="text-align:justify;">声明一个boolean类型资源，其值为true</li><li style="text-align:justify;">包含当前语言设置的子类型</li></ol></li><li style="text-align:justify;">组2: 
    <ol><li style="text-align:justify;">包含英语键盘子类型</li></ol></li></ol></li></ol> 
<ul><li style="text-align:justify;">选择满足Locale的隐性可用子类型：</li></ul> 
<ol><li style="text-align:justify;">对于所有默认激活子类型 
  <ol><li style="text-align:justify;">每个模式选择第一个</li></ol></li><li style="text-align:justify;">有可用的，返回列表</li><li style="text-align:justify;">对于所有子类型 
  <ol><li style="text-align:justify;">每个模式选择一个，满足（优先级） 
    <ol><li style="text-align:justify;">Locale相等</li><li style="text-align:justify;">Locale更通用的第一个</li></ol></li></ol></li><li style="text-align:justify;">如果键盘类型不支持TAG_ASCII_CAPABLE 
  <ol><li style="text-align:justify;">增加定义了TAG_ENABLED_WHEN_DEFAULT_IS_NOT_ASCII_CAPABLE的键盘子类型</li></ol></li><li style="text-align:justify;">如果没有键盘类型 
  <ol><li style="text-align:justify;">寻找语言匹配，或者第一个</li><li style="text-align:justify;">增加的返回列表中</li></ol></li><li style="text-align:justify;">返回列表</li></ol> 
<ul><li style="text-align:justify;">输入法设置</li></ul> 
<ol><li style="text-align:justify;">激活的输入法 
  <ol><li style="text-align:justify;">设置名：Settings.Secure.ENABLED_INPUT_METHODS</li><li style="text-align:justify;">设置格式：ime0;subtype0;subtype1;subtype2:ime1:ime2;subtype0</li></ol></li><li style="text-align:justify;">子类型历史 
  <ol><li style="text-align:justify;">设置名：Settings.Secure.INPUT_METHODS_SUBTYPE_HISTORY</li><li style="text-align:justify;">设置格式：ime0;subtype:ime1:subtype</li></ol></li><li style="text-align:justify;">默认输入法 
  <ol><li style="text-align:justify;">设置名：Settings.Secure.DEFAULT_INPUT_METHOD</li></ol></li><li style="text-align:justify;">默认输入法子类型 
  <ol><li style="text-align:justify;">设置名：Settings.Secure.SELECTED_INPUT_METHOD_SUBTYPE</li></ol></li><li style="text-align:justify;">禁用的系统输入法 
  <ol><li style="text-align:justify;">设置名：Settings.Secure.DISABLED_SYSTEM_INPUT_METHODS</li></ol></li></ol> 
<ul><li style="text-align:justify;">获取激活的子类型</li></ul> 
<ol><li style="text-align:justify;">根据输入法设置获取激活的子类型</li><li style="text-align:justify;">如果允许隐性可用，且上面获取的集合为空 
  <ol><li style="text-align:justify;">选择满足Locale的隐性可用子类型【见第六项】</li></ol></li></ol> 
<h3 style="text-align:justify;">android.inputmethodservice</h3> 
<p style="margin-left:0;text-align:justify;">        源代码位于：frameworks/base/core/java/android/view/inputmethod。</p> 
<p style="margin-left:0;text-align:justify;">        类型说明：</p> 
<table border="1" cellspacing="0" style="width:557px;"><tbody><tr><td style="border-color:#000000;vertical-align:top;width:120.25pt;"> <p style="margin-left:0;text-align:center;"><strong>类名</strong></p> </td><td style="border-color:#000000;vertical-align:top;width:297.7pt;"> <p style="margin-left:0;text-align:center;"><strong>说明</strong></p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:120.25pt;"> <p style="margin-left:0;text-align:justify;">IInputMethodWrapper</p> </td><td style="vertical-align:top;width:297.7pt;"> <p style="margin-left:0;text-align:justify;">包装一个IInputMethod实例，使用异步消息机制转发到Looper线程执行，创建的会话通过IInputMethodSessionWrapper包装</p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:120.25pt;"> <p style="margin-left:0;text-align:justify;">IInputMethodSessionWrapper</p> </td><td style="vertical-align:top;width:297.7pt;"> <p style="margin-left:0;text-align:justify;">包装一个IInputMethodSession实例，使用异步消息机制转发到Looper线程执行</p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:120.25pt;"> <p style="margin-left:0;text-align:justify;">AbstractInputMethodService</p> </td><td style="vertical-align:top;width:297.7pt;"> <p style="margin-left:0;text-align:justify;">一个输入法服务的抽象，通过Bind返回InputMethod实例返回的输入法使用IInputMethodWrapper包装。派生类通过继承AbstractInputMethodImpl抽象接口实现输入法，通过继承AbstractInputMethodSessionImpl实现输入法会话。</p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:120.25pt;"> <p style="margin-left:0;text-align:justify;">InputMethodService</p> </td><td style="vertical-align:top;width:297.7pt;"> <p style="margin-left:0;text-align:justify;">基本实现一个输入法服务</p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:120.25pt;"> <p style="margin-left:0;text-align:justify;">SoftInputWindow</p> </td><td style="vertical-align:top;width:297.7pt;"> <p style="margin-left:0;text-align:justify;">输入法窗口</p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:120.25pt;"> <p style="margin-left:0;text-align:justify;">KeyboardView</p> </td><td style="vertical-align:top;width:297.7pt;"> <p style="margin-left:0;text-align:justify;">软键盘UI</p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:120.25pt;"> <p style="margin-left:0;text-align:justify;">Keyboard</p> </td><td style="vertical-align:top;width:297.7pt;"> <p style="margin-left:0;text-align:justify;">软键盘布局定义</p> </td></tr></tbody></table> 
<h3>com.android.server.input</h3> 
<p style="margin-left:0;text-align:justify;">        源代码位于：frameworks/base/services/java/android/server/input。</p> 
<p style="margin-left:0;text-align:justify;">        input服务运行在SystemServer进程，是一个binder服务，可以跨进程访问。其java代码存在于services.jar中，jni层代码属于libandroid_servers库。</p> 
<table border="1" cellspacing="0"><tbody><tr><td style="background-color:#808080;border-color:#000000;width:126.3pt;"> <p style="margin-left:0;text-align:center;"><strong>java</strong></p> </td><td style="background-color:#808080;border-color:#000000;width:157.8pt;"> <p style="margin-left:0;text-align:center;"><strong><span style="color:#000000;">jni</span></strong></p> </td><td style="background-color:#808080;border-color:#000000;width:130.7pt;"> <p style="margin-left:0;text-align:center;"><strong><span style="color:#000000;">C++</span></strong></p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:126.3pt;"> <p style="margin-left:0;text-align:justify;">InputManagerService</p> </td><td style="vertical-align:top;width:157.8pt;"> <p style="margin-left:0;text-align:justify;">NativeInputManager</p> </td><td style="vertical-align:top;width:130.7pt;"> <p style="margin-left:0;text-align:justify;">InputManager</p> <p style="margin-left:0;text-align:justify;">InputReader</p> <p style="margin-left:0;text-align:justify;">InputDispatcher</p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:126.3pt;"> <p style="margin-left:0;text-align:justify;">InputApplicationHandle</p> </td><td style="vertical-align:top;width:157.8pt;"> <p style="margin-left:0;text-align:justify;">NativeInputApplicationHandle</p> </td><td style="vertical-align:top;width:130.7pt;"> <p style="margin-left:0;text-align:justify;">InputApplicationHandle</p> <p style="margin-left:0;text-align:justify;">InputApplicationInfo</p> </td></tr><tr><td style="border-color:#000000;vertical-align:top;width:126.3pt;"> <p style="margin-left:0;text-align:justify;">InputWindowHandle</p> </td><td style="vertical-align:top;width:157.8pt;"> <p style="margin-left:0;text-align:justify;">NativeInputWindowHandle</p> </td><td style="vertical-align:top;width:130.7pt;"> <p style="margin-left:0;text-align:justify;">InputWindowHandle</p> <p style="margin-left:0;text-align:justify;">InputWindowInfo</p> <p style="margin-left:0;text-align:justify;"></p> </td></tr></tbody></table> 
<h4>jni</h4> 
<p style="margin-left:0;text-align:justify;">        源代码位于：frameworks/base/services/jni。</p> 
<p style="margin-left:0;text-align:justify;">        NativeInputManager实现了下列接口：</p> 
<ol><li style="text-align:justify;">InputReaderPolicyInterface</li><li style="text-align:justify;">InputDispatcherPolicyInterface</li><li style="text-align:justify;">PointerControllerPolicyInterface</li></ol> 
<p style="margin-left:0;text-align:justify;">        NativeInputManager创建了libinputservice 中定义的EventHub、InputManager，负责分派java调用到InputManager内的InputReader、InputDispatcher，转发接口方法回调到java层。</p> 
<p style="margin-left:0;text-align:justify;">        NativeInputApplicationHandle继承InputApplicationHandle，其updateInfo，获取java成员的信息，转换为C++类型。</p> 
<p style="margin-left:0;text-align:justify;">        NativeInputWindowHandle继承InputWindowHandle，实现了updateInfo，获取java成员的信息，转换为C++类型。</p> 
<h4 style="margin-left:0px;text-align:justify;">java</h4> 
<p style="margin-left:0;text-align:justify;">        源代码位于：frameworks/base/services/java/com/android/server/input。</p> 
<p style="margin-left:0;text-align:justify;">        InputManagerService实现IInputManager接口，转发NativeInputManager的回调到WindowManagerCallbacks，后者由WindowManagerService中的InputMonitor实现，最终调用到PhoneWindowManager。InputMonitor也封装InputManagerService的部分方法，供WindowManagerService调用。</p> 
<p style="margin-left:0;text-align:justify;">        InputManagerService由SystemServer启动，其jni库libandroid_servers静态绑定libinputservice，因此input没有native层的服务。</p> 
<h3 style="margin-left:0px;text-align:justify;">com.android.server</h3> 
<p style="margin-left:0;text-align:justify;">        源代码位于：frameworks/base/services/java/com/android/server。</p> 
<p style="margin-left:0;text-align:justify;">        InputMethodManagerService,input_method服务由SystemServer启动，实现IInputMethodManager接口，是Binder类型的接口，可以跨进程访问。</p> 
<h3 style="margin-left:0px;text-align:justify;">input</h3> 
<p style="margin-left:0;text-align:justify;">        Input是framework提供的一个输入工具，可以模拟输入键盘、鼠标等设备的事件。</p> 
<p style="margin-left:0;text-align:justify;">        Input利用InputManager（java）提供的injectInputEvent方法向framework层直接插入输入事件。</p> 
<p style="margin-left:0;text-align:justify;">        源代码位于frameworks/base/cmds/input。</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/3b69fab9fc5e9c0234b48cfe390341b8/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">ICCV 2021 Workshop 盘点</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7d7ef4131736e622b982a40bc6f5099c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">AndroidMP4视频文件推送rtmp</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>