<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Elasticsearch使用篇 - 管道聚合 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Elasticsearch使用篇 - 管道聚合" />
<meta property="og:description" content="管道聚合 基于前一次聚合的结果，进行二次聚合统计。
从结构上可以分为兄弟级（Sibling）管道聚合和父级（Parent）管道聚合两种方式。
兄弟级管道聚合：在同一聚合级别上可以产生新的聚合。 GET kibana_sample_data_logs/_search { &#34;size&#34;: 0, &#34;aggs&#34;: { &#34;count_per_day&#34;: { &#34;date_histogram&#34;: { &#34;field&#34;: &#34;@timestamp&#34;, &#34;calendar_interval&#34;: &#34;day&#34; } }, &#34;total_bytes_of_download&#34;: { &#34;sum&#34;: { &#34;field&#34;: &#34;bytes&#34; } } } } 父级管道聚合：由父聚合提供输出，子聚合能够产生新的桶，然后可以添加到父桶中。 GET kibana_sample_data_logs/_search { &#34;size&#34;: 0, &#34;aggs&#34;: { &#34;count_per_day&#34;: { &#34;date_histogram&#34;: { &#34;field&#34;: &#34;@timestamp&#34;, &#34;calendar_interval&#34;: &#34;day&#34; }, &#34;aggs&#34;: { &#34;total_bytes_per_day&#34;: { &#34;sum&#34;: { &#34;field&#34;: &#34;bytes&#34; } } } } } } max_bucket、min_bucket、avg_bucket、sum_bucket 基于兄弟级管道聚合的方式，从多个分桶中获取指定数值指标的聚合结果（最大值 / 最小值 / 平均值 / 和）。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/ed1827b77fa1215d53f287200a94a82b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-20T22:05:49+08:00" />
<meta property="article:modified_time" content="2023-06-20T22:05:49+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Elasticsearch使用篇 - 管道聚合</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atelier-sulphurpool-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_2"></a>管道聚合</h2> 
<p>基于前一次聚合的结果，进行二次聚合统计。</p> 
<p>从结构上可以分为兄弟级（Sibling）管道聚合和父级（Parent）管道聚合两种方式。</p> 
<ul><li>兄弟级管道聚合：在同一聚合级别上可以产生新的聚合。</li></ul> 
<pre><code class="prism language-json"><span class="token constant">GET</span> kibana_sample_data_logs<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"count_per_day"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"date_histogram"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"@timestamp"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"calendar_interval"</span><span class="token operator">:</span> <span class="token string">"day"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"total_bytes_of_download"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"sum"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"bytes"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>父级管道聚合：由父聚合提供输出，子聚合能够产生新的桶，然后可以添加到父桶中。</li></ul> 
<pre><code class="prism language-json"><span class="token constant">GET</span>  kibana_sample_data_logs<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"count_per_day"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"date_histogram"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"@timestamp"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"calendar_interval"</span><span class="token operator">:</span> <span class="token string">"day"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"total_bytes_per_day"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"sum"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"bytes"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="max_bucketmin_bucketavg_bucketsum_bucket_58"></a>max_bucket、min_bucket、avg_bucket、sum_bucket</h3> 
<p>基于<font color="orange">兄弟级管道聚合</font>的方式，从多个分桶中获取指定<font color="orange">数值指标</font>的聚合结果（最大值 / 最小值 / 平均值 / 和）。</p> 
<ul><li>buckets_path：（必须）目标桶的路径指向。</li><li>gap_policy：分桶数据出现空值或者缺失值的处理策略，默认 skip。<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.14/search-aggregations-pipeline.html#gap-policy" rel="nofollow">gap_policy 详细说明</a> 
  <ul><li>skip：跳过空值或者缺失值，不参与聚合计算。</li><li>insert_zeros：将空值或者缺失值当作 0 来参与聚合计算。</li><li>keep_values：如果提供的指标值是一个空值或者缺失值（null、NAN）则跳过，不参与聚合计算；否则使用该指标值参与聚合计算。</li></ul> </li><li>format：指定数值的输出格式，比如 #、#0.00。默认 null。</li></ul> 
<p>1、统计每个出发地国家的最长的航班飞行时间，并且获取航班飞行时间最长的国家以及对应的航班飞行时间。</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> kibana_sample_data_flights<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string-property property">"track_total_hits"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"terms_OriginCountry"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"OriginCountry"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">20</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"max_FlightTimeMin"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"max"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"FlightTimeMin"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"pipeline-max-bucket"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"max_bucket"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"buckets_path"</span><span class="token operator">:</span> <span class="token string">"terms_OriginCountry&gt;max_FlightTimeMin"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>截取部分的聚合结果如下：</p> 
<pre><code class="prism language-json"><span class="token string-property property">"pipeline-max-bucket"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">1902.9019775390625</span><span class="token punctuation">,</span>
  <span class="token string-property property">"keys"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"AR"</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>2、获取出发地国家中各个出发地城市的航班飞行时间的最大值，然后统计出发地城市中航班飞行时间最长的飞行时长以及对应的出发地城市名称。</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> kibana_sample_data_flights<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string-property property">"track_total_hits"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"terms_OriginCountry"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"OriginCountry"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">20</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"terms_OriginCityName"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"OriginCityName"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">20</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"max_FlightTimeMin"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
              <span class="token string-property property">"max"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"FlightTimeMin"</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"Max_Bucket_OriginCityName_FlightTimeMin"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"max_bucket"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"buckets_path"</span><span class="token operator">:</span> <span class="token string">"terms_OriginCityName&gt;max_FlightTimeMin"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>截取以出发地国家维度的第一个分桶中的管道聚合的结果。</p> 
<pre><code class="prism language-json"><span class="token string-property property">"Max_Bucket_OriginCityName_FlightTimeMin"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">1559.6236572265625</span><span class="token punctuation">,</span>
  <span class="token string-property property">"keys"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"Rome"</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>3、在 2 的基础上获取出发地国家中航班最长的飞行时间以及对应的出发地国家名称。</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> kibana_sample_data_flights<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string-property property">"track_total_hits"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"terms_OriginCountry"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"OriginCountry"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">20</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"terms_OriginCityName"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"OriginCityName"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">20</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"max_FlightTimeMin"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
              <span class="token string-property property">"max"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"FlightTimeMin"</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"Max_Bucket_OriginCityName_FlightTimeMin"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"max_bucket"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"buckets_path"</span><span class="token operator">:</span> <span class="token string">"terms_OriginCityName&gt;max_FlightTimeMin"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"Max_Bucket_OriginCountry_FlightTimeMin"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"max_bucket"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"buckets_path"</span><span class="token operator">:</span> <span class="token string">"terms_OriginCountry&gt;Max_Bucket_OriginCityName_FlightTimeMin"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在 2 的基础上额外输出出发地国家纬度的管道聚合结果。</p> 
<pre><code class="prism language-json"><span class="token string-property property">"Max_Bucket_OriginCountry_FlightTimeMin"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">1902.9019775390625</span><span class="token punctuation">,</span>
  <span class="token string-property property">"keys"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"AR"</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="stats_bucket_217"></a>stats_bucket</h3> 
<p>基于<font color="orange">兄弟级管道聚合</font>的方式，从多个分桶中获取指定<font color="orange">数值指标</font>的统计聚合结果。</p> 
<ul><li>buckets_path：（必须）目标桶的路径指向。</li><li>gap_policy：分桶数据出现空值或者缺失值的处理策略，默认 skip。<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.14/search-aggregations-pipeline.html#gap-policy" rel="nofollow">gap_policy 详细说明</a> 
  <ul><li>skip：跳过空值或者缺失值，不参与聚合计算。</li><li>insert_zeros：将空值或者缺失值当作 0 来参与聚合计算。</li><li>keep_values：如果提供的指标值是一个空值或者缺失值（null、NAN）则跳过，不参与聚合计算；否则使用该指标值参与聚合计算。</li></ul> </li><li>format：指定数值的输出格式，比如 #、#0.00。默认 null。</li><li>sigma：标准差的倍数，默认 2。用于确定一个数据点是否属于异常值。</li></ul> 
<p>1、统计出发地国家中各个出发地城市的航班飞行时间的平均时长，然后统计这些平均时长在出发地国家纬度下的各项指标。</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> kibana_sample_data_flights<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string-property property">"track_total_hits"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"terms_OriginCountry"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"OriginCountry"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">20</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"terms_OriginCityName"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"OriginCityName"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">20</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"avg_FlightTimeMin"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
              <span class="token string-property property">"avg"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"FlightTimeMin"</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"Stats_Bucket_OriginCityName_FlightTimeMin"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"stats_bucket"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"buckets_path"</span><span class="token operator">:</span> <span class="token string">"terms_OriginCityName&gt;avg_FlightTimeMin"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>截取部分的聚合结果如下：</p> 
<pre><code class="prism language-json"><span class="token string-property property">"Stats_Bucket_OriginCityName_FlightTimeMin"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"count"</span> <span class="token operator">:</span> <span class="token number">15</span><span class="token punctuation">,</span>
  <span class="token string-property property">"min"</span> <span class="token operator">:</span> <span class="token number">226.4979310909907</span><span class="token punctuation">,</span>
  <span class="token string-property property">"max"</span> <span class="token operator">:</span> <span class="token number">472.0975369329038</span><span class="token punctuation">,</span>
  <span class="token string-property property">"avg"</span> <span class="token operator">:</span> <span class="token number">378.1233526619374</span><span class="token punctuation">,</span>
  <span class="token string-property property">"sum"</span> <span class="token operator">:</span> <span class="token number">5671.850289929062</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="extended_stats_bucket_283"></a>extended_stats_bucket</h3> 
<p>基于<font color="orange">兄弟级管道聚合</font>的方式，从多个分桶中获取指定<font color="orange">数值指标</font>的拓展统计聚合结果。</p> 
<ul><li>buckets_path：（必须）目标桶的路径指向。</li><li>gap_policy：分桶数据出现空值或者缺失值的处理策略，默认 skip。<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.14/search-aggregations-pipeline.html#gap-policy" rel="nofollow">gap_policy 详细说明</a> 
  <ul><li>skip：跳过空值或者缺失值，不参与聚合计算。</li><li>insert_zeros：将空值或者缺失值当作 0 来参与聚合计算。</li><li>keep_values：如果提供的指标值是一个空值或者缺失值（null、NAN）则跳过，不参与聚合计算；否则使用该指标值参与聚合计算。</li></ul> </li><li>format：指定数值的输出格式，比如 #、#0.00。默认 null。</li><li>sigma：标准差的倍数，默认 2。用于确定一个数据点是否属于异常值。</li></ul> 
<p>1、统计出发地国家中各个出发地城市的航班飞行时间的平均时长，然后统计这些平均时长在出发地城市纬度下的各项指标。</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> kibana_sample_data_flights<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string-property property">"track_total_hits"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"terms_OriginCountry"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"OriginCountry"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">20</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"terms_OriginCityName"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"OriginCityName"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">20</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"avg_FlightTimeMin"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
              <span class="token string-property property">"avg"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"FlightTimeMin"</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"Extended_Stats_Bucket_OriginCityName_FlightTimeMin"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"extended_stats_bucket"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"buckets_path"</span><span class="token operator">:</span> <span class="token string">"terms_OriginCityName&gt;avg_FlightTimeMin"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>截取部分的聚合结果如下：</p> 
<pre><code class="prism language-json"><span class="token string-property property">"Extended_Stats_Bucket_OriginCityName_FlightTimeMin"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"count"</span> <span class="token operator">:</span> <span class="token number">15</span><span class="token punctuation">,</span>
  <span class="token string-property property">"min"</span> <span class="token operator">:</span> <span class="token number">226.4979310909907</span><span class="token punctuation">,</span>
  <span class="token string-property property">"max"</span> <span class="token operator">:</span> <span class="token number">472.0975369329038</span><span class="token punctuation">,</span>
  <span class="token string-property property">"avg"</span> <span class="token operator">:</span> <span class="token number">378.1233526619374</span><span class="token punctuation">,</span>
  <span class="token string-property property">"sum"</span> <span class="token operator">:</span> <span class="token number">5671.850289929062</span><span class="token punctuation">,</span>
  <span class="token string-property property">"sum_of_squares"</span> <span class="token operator">:</span> <span class="token number">2264926.8781446246</span><span class="token punctuation">,</span>
  <span class="token string-property property">"variance"</span> <span class="token operator">:</span> <span class="token number">8017.855381337739</span><span class="token punctuation">,</span>
  <span class="token string-property property">"variance_population"</span> <span class="token operator">:</span> <span class="token number">8017.855381337739</span><span class="token punctuation">,</span>
  <span class="token string-property property">"variance_sampling"</span> <span class="token operator">:</span> <span class="token number">8590.559337147579</span><span class="token punctuation">,</span>
  <span class="token string-property property">"std_deviation"</span> <span class="token operator">:</span> <span class="token number">89.54247808352045</span><span class="token punctuation">,</span>
  <span class="token string-property property">"std_deviation_population"</span> <span class="token operator">:</span> <span class="token number">89.54247808352045</span><span class="token punctuation">,</span>
  <span class="token string-property property">"std_deviation_sampling"</span> <span class="token operator">:</span> <span class="token number">92.68527033540755</span><span class="token punctuation">,</span>
  <span class="token string-property property">"std_deviation_bounds"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"upper"</span> <span class="token operator">:</span> <span class="token number">557.2083088289783</span><span class="token punctuation">,</span>
    <span class="token string-property property">"lower"</span> <span class="token operator">:</span> <span class="token number">199.03839649489652</span><span class="token punctuation">,</span>
    <span class="token string-property property">"upper_population"</span> <span class="token operator">:</span> <span class="token number">557.2083088289783</span><span class="token punctuation">,</span>
    <span class="token string-property property">"lower_population"</span> <span class="token operator">:</span> <span class="token number">199.03839649489652</span><span class="token punctuation">,</span>
    <span class="token string-property property">"upper_sampling"</span> <span class="token operator">:</span> <span class="token number">563.4938933327526</span><span class="token punctuation">,</span>
    <span class="token string-property property">"lower_sampling"</span> <span class="token operator">:</span> <span class="token number">192.75281199112231</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="cumulative_sum_364"></a>cumulative_sum</h3> 
<p>[ˈkjuːmjəleɪtɪv]，累计的；累积的</p> 
<p>基于父级管道聚合的方式，对直方图聚合、日期直方图聚合中的相关数值指标进行<font color="orange">累积聚合统计</font>。</p> 
<p><font color="999aaa">外层的直方图聚合、日期直方图聚合的 min_doc_count 必须设置为 0。</font></p> 
<ul><li>buckets_path：（必须）目标桶的路径指向。</li><li>format：指定数值的输出格式，比如 #、#0.00。默认 null。</li></ul> 
<p>1、统计用户每天的订单消费总额以及每天增长的累计消费金额。</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> kibana_sample_data_ecommerce<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string-property property">"track_total_hits"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"date_histogram_order_date"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"date_histogram"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"order_date"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"calendar_interval"</span><span class="token operator">:</span> <span class="token string">"day"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"format"</span><span class="token operator">:</span> <span class="token string">"yyyy-MM-dd"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"stats_taxful_total_price"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"stats"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"taxful_total_price"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"pipeline_cumulative_sum"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"cumulative_sum"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"buckets_path"</span><span class="token operator">:</span> <span class="token string">"stats_taxful_total_price.sum"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>截取部分的聚合结果如下：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"key_as_string"</span> <span class="token operator">:</span> <span class="token string">"2022-07-14"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"key"</span> <span class="token operator">:</span> <span class="token number">1657756800000</span><span class="token punctuation">,</span>
  <span class="token string-property property">"doc_count"</span> <span class="token operator">:</span> <span class="token number">146</span><span class="token punctuation">,</span>
  <span class="token string-property property">"stats_taxful_total_price"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"count"</span> <span class="token operator">:</span> <span class="token number">146</span><span class="token punctuation">,</span>
    <span class="token string-property property">"min"</span> <span class="token operator">:</span> <span class="token number">18.984375</span><span class="token punctuation">,</span>
    <span class="token string-property property">"max"</span> <span class="token operator">:</span> <span class="token number">230.0</span><span class="token punctuation">,</span>
    <span class="token string-property property">"avg"</span> <span class="token operator">:</span> <span class="token number">72.45569349315069</span><span class="token punctuation">,</span>
    <span class="token string-property property">"sum"</span> <span class="token operator">:</span> <span class="token number">10578.53125</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"pipeline_cumulative_sum"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">10578.53125</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"key_as_string"</span> <span class="token operator">:</span> <span class="token string">"2022-07-15"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"key"</span> <span class="token operator">:</span> <span class="token number">1657843200000</span><span class="token punctuation">,</span>
  <span class="token string-property property">"doc_count"</span> <span class="token operator">:</span> <span class="token number">153</span><span class="token punctuation">,</span>
  <span class="token string-property property">"stats_taxful_total_price"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"count"</span> <span class="token operator">:</span> <span class="token number">153</span><span class="token punctuation">,</span>
    <span class="token string-property property">"min"</span> <span class="token operator">:</span> <span class="token number">22.984375</span><span class="token punctuation">,</span>
    <span class="token string-property property">"max"</span> <span class="token operator">:</span> <span class="token number">220.0</span><span class="token punctuation">,</span>
    <span class="token string-property property">"avg"</span> <span class="token operator">:</span> <span class="token number">68.2875816993464</span><span class="token punctuation">,</span>
    <span class="token string-property property">"sum"</span> <span class="token operator">:</span> <span class="token number">10448.0</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"pipeline_cumulative_sum"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">21026.53125</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"key_as_string"</span> <span class="token operator">:</span> <span class="token string">"2022-07-16"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"key"</span> <span class="token operator">:</span> <span class="token number">1657929600000</span><span class="token punctuation">,</span>
  <span class="token string-property property">"doc_count"</span> <span class="token operator">:</span> <span class="token number">143</span><span class="token punctuation">,</span>
  <span class="token string-property property">"stats_taxful_total_price"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"count"</span> <span class="token operator">:</span> <span class="token number">143</span><span class="token punctuation">,</span>
    <span class="token string-property property">"min"</span> <span class="token operator">:</span> <span class="token number">18.984375</span><span class="token punctuation">,</span>
    <span class="token string-property property">"max"</span> <span class="token operator">:</span> <span class="token number">250.0</span><span class="token punctuation">,</span>
    <span class="token string-property property">"avg"</span> <span class="token operator">:</span> <span class="token number">71.91247814685315</span><span class="token punctuation">,</span>
    <span class="token string-property property">"sum"</span> <span class="token operator">:</span> <span class="token number">10283.484375</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"pipeline_cumulative_sum"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">31310.015625</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="cumulative_cardinality_460"></a>cumulative_cardinality</h3> 
<p>[kɑːdɪ’nælɪtɪ]，基数</p> 
<p>基于父级管道聚合的方式，对直方图聚合、日期直方图聚合中的相关数值指标进行<font color="orange">累积基数聚合统计</font>。</p> 
<p><font color="999aaa">外层的直方图聚合、日期直方图聚合的 min_doc_count 必须设置为 0。</font></p> 
<ul><li>buckets_path：（必须）目标桶的路径指向。</li><li>format：指定数值的输出格式，比如 #、#0.00。默认 null。</li></ul> 
<p>1、统计每天下单的用户数以及累计的用户数。</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> kibana_sample_data_ecommerce<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string-property property">"track_total_hits"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"date_histogram_order_date"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"date_histogram"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"order_date"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"calendar_interval"</span><span class="token operator">:</span> <span class="token string">"day"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"format"</span><span class="token operator">:</span> <span class="token string">"yyyy-MM-dd"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"cardinality_customer_id"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"cardinality"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"customer_id"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"pipeline_cumulative_cardinality"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"cumulative_cardinality"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"buckets_path"</span><span class="token operator">:</span> <span class="token string">"cardinality_customer_id"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>截取部分的聚合结果如下：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"key_as_string"</span> <span class="token operator">:</span> <span class="token string">"2022-07-14"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"key"</span> <span class="token operator">:</span> <span class="token number">1657756800000</span><span class="token punctuation">,</span>
  <span class="token string-property property">"doc_count"</span> <span class="token operator">:</span> <span class="token number">146</span><span class="token punctuation">,</span>
  <span class="token string-property property">"cardinality_customer_id"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">42</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"pipeline_cumulative_cardinality"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">42</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"key_as_string"</span> <span class="token operator">:</span> <span class="token string">"2022-07-15"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"key"</span> <span class="token operator">:</span> <span class="token number">1657843200000</span><span class="token punctuation">,</span>
  <span class="token string-property property">"doc_count"</span> <span class="token operator">:</span> <span class="token number">153</span><span class="token punctuation">,</span>
  <span class="token string-property property">"cardinality_customer_id"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">44</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"pipeline_cumulative_cardinality"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">46</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"key_as_string"</span> <span class="token operator">:</span> <span class="token string">"2022-07-16"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"key"</span> <span class="token operator">:</span> <span class="token number">1657929600000</span><span class="token punctuation">,</span>
  <span class="token string-property property">"doc_count"</span> <span class="token operator">:</span> <span class="token number">143</span><span class="token punctuation">,</span>
  <span class="token string-property property">"cardinality_customer_id"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">45</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"pipeline_cumulative_cardinality"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">46</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="moving_avg_544"></a>moving_avg</h3> 
<p>移动平均值聚合。基于父级管道聚合的方式，在指定的数据序列中滑动一个窗口，<font color="orange">统计窗口内部的平均值</font>。</p> 
<ul><li> <p>buckets_path：（必须）目标桶的路径指向。</p> </li><li> <p>window：滑动窗口的大小。默认 5。</p> </li><li> <p>gap_policy：分桶数据出现空值或者缺失值的处理策略，默认 skip。<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.14/search-aggregations-pipeline.html#gap-policy" rel="nofollow">gap_policy 详细说明</a></p> 
  <ul><li>skip：跳过空值或者缺失值，不参与聚合计算。</li><li>insert_zeros：将空值或者缺失值当作 0 来参与聚合计算。</li><li>keep_values：如果提供的指标值是一个空值或者缺失值（null、NAN）则跳过，不参与聚合计算；否则使用该指标值参与聚合计算。</li></ul> </li><li> <p>model：指定移动平均值聚合的模型，默认 simple。每个模型对于窗口内部的值的加权方式不同。</p> 
  <ul><li>simple：简单模型。它会计算窗口内部的所有值的和，然后除以窗口大小。简单模型不执行随时间变化的加权，这意味着该模型下的移动平均值往往滞后于真实数据。</li><li>linear：线性模型。它会对旧的数据点分配线性权重，以此来减少数据平均值的滞后性。</li><li>ewma：单指数模型。它会对旧的数据点分配指数权重。权重衰减的速度可以通过 alpha 参数控制。默认 0.3。alpha 参数支持 0 到 1 之间的浮点数，值越小可以使权重缓慢衰减，提供了更好的平滑效果；值越大可以使权重快速衰减，减少了旧值对于移动平均值的影响，虽然平滑度较低，但是使移动平均值更紧密地跟踪数据。该模型可以最小化。</li><li>holt：双指数模型。模型内部计算两个值：<font color="orange">水平</font>、<font color="orange">趋势</font>。基于数据的趋势，可以预测未来走向。alpha 参数对应水平衰减值，默认 0.3。beta 参数对应趋势衰减值，默认 0.1。alpha 参数、beta 参数都支持 0 到 1 之间的浮点数。该模型可以最小化</li><li>holt_winters：三指数模型。模型内部计算三个值：<font color="orange">水平</font>、<font color="orange">趋势</font>、<font color="orange">季节性</font>。基于数据的季节性变化，可以预测未来走向。alpha 参数对应水平衰减值，默认 0.3。beta 参数对应趋势衰减值，默认 0.1。gamma 参数对应季节衰减值，默认 0.3。alpha 参数、beta 参数、gamma 参数都支持 0 到 1 之间的浮点数。period 参数对应周期，默认 1。type 参数控制季节变化如何作用于数据，支持 add、mult。该模型可以最小化。</li></ul> </li><li> <p>settings：指定模型的相关参数。</p> </li><li> <p>predict：指定预测的数量（会添加到序列的末尾）。每个移动平均值模型都支持预测模式，基于当前平滑的移动平均值推测未来数据。根据模型和参数的不同，预测结果的准确性也会有所不同。比如：predict: 10。</p> </li><li> <p>minimize：指定模型是否开启最小化。最小化是一个调整参数的过程，直到模型生成的预测与输出数据紧密匹配。对于 ewma、holt 模型，该参数默认 false，并且用处不大；对于 holt_winters 模型，该参数默认 true，有助于提高预测的准确性。比如：minimize: true。</p> </li></ul> 
<p>对 simple 模型采用窗口大小为 3，进行举例说明。</p> 
<pre><code>分桶序号		分桶值			移动平均值
	1		 10
	2		 20				 10
	3		 30				(10 + 20) / 2
	4		 40				(10 + 20 + 30) / 3
	5		 50				(20 + 30 + 40) / 3
</code></pre> 
<p>1、统计用户每天的订单消费金额，以及连续三天的平均消费金额。</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> kibana_sample_data_ecommerce<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string-property property">"track_total_hits"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"date_histogram_order_date"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"date_histogram"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"order_date"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"calendar_interval"</span><span class="token operator">:</span> <span class="token string">"day"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"format"</span><span class="token operator">:</span> <span class="token string">"yyyy-MM-dd"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"stats_taxful_total_price"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"stats"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"taxful_total_price"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"pipeline_moving_avg"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"moving_avg"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"buckets_path"</span><span class="token operator">:</span> <span class="token string">"stats_taxful_total_price.sum"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"window"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
            <span class="token string-property property">"model"</span><span class="token operator">:</span> <span class="token string">"simple"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>截取部分的聚合结果如下：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"key_as_string"</span> <span class="token operator">:</span> <span class="token string">"2022-07-14"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"key"</span> <span class="token operator">:</span> <span class="token number">1657756800000</span><span class="token punctuation">,</span>
  <span class="token string-property property">"doc_count"</span> <span class="token operator">:</span> <span class="token number">146</span><span class="token punctuation">,</span>
  <span class="token string-property property">"stats_taxful_total_price"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"count"</span> <span class="token operator">:</span> <span class="token number">146</span><span class="token punctuation">,</span>
    <span class="token string-property property">"min"</span> <span class="token operator">:</span> <span class="token number">18.984375</span><span class="token punctuation">,</span>
    <span class="token string-property property">"max"</span> <span class="token operator">:</span> <span class="token number">230.0</span><span class="token punctuation">,</span>
    <span class="token string-property property">"avg"</span> <span class="token operator">:</span> <span class="token number">72.45569349315069</span><span class="token punctuation">,</span>
    <span class="token string-property property">"sum"</span> <span class="token operator">:</span> <span class="token number">10578.53125</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"key_as_string"</span> <span class="token operator">:</span> <span class="token string">"2022-07-15"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"key"</span> <span class="token operator">:</span> <span class="token number">1657843200000</span><span class="token punctuation">,</span>
  <span class="token string-property property">"doc_count"</span> <span class="token operator">:</span> <span class="token number">153</span><span class="token punctuation">,</span>
  <span class="token string-property property">"stats_taxful_total_price"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"count"</span> <span class="token operator">:</span> <span class="token number">153</span><span class="token punctuation">,</span>
    <span class="token string-property property">"min"</span> <span class="token operator">:</span> <span class="token number">22.984375</span><span class="token punctuation">,</span>
    <span class="token string-property property">"max"</span> <span class="token operator">:</span> <span class="token number">220.0</span><span class="token punctuation">,</span>
    <span class="token string-property property">"avg"</span> <span class="token operator">:</span> <span class="token number">68.2875816993464</span><span class="token punctuation">,</span>
    <span class="token string-property property">"sum"</span> <span class="token operator">:</span> <span class="token number">10448.0</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"pipeline_moving_avg"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">10578.53125</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"key_as_string"</span> <span class="token operator">:</span> <span class="token string">"2022-07-16"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"key"</span> <span class="token operator">:</span> <span class="token number">1657929600000</span><span class="token punctuation">,</span>
  <span class="token string-property property">"doc_count"</span> <span class="token operator">:</span> <span class="token number">143</span><span class="token punctuation">,</span>
  <span class="token string-property property">"stats_taxful_total_price"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"count"</span> <span class="token operator">:</span> <span class="token number">143</span><span class="token punctuation">,</span>
    <span class="token string-property property">"min"</span> <span class="token operator">:</span> <span class="token number">18.984375</span><span class="token punctuation">,</span>
    <span class="token string-property property">"max"</span> <span class="token operator">:</span> <span class="token number">250.0</span><span class="token punctuation">,</span>
    <span class="token string-property property">"avg"</span> <span class="token operator">:</span> <span class="token number">71.91247814685315</span><span class="token punctuation">,</span>
    <span class="token string-property property">"sum"</span> <span class="token operator">:</span> <span class="token number">10283.484375</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"pipeline_moving_avg"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">10513.265625</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>换成 ewma 模型看下效果。</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> kibana_sample_data_ecommerce<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string-property property">"track_total_hits"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"order_date_histogram"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"date_histogram"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"order_date"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"calendar_interval"</span><span class="token operator">:</span> <span class="token string">"day"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"format"</span><span class="token operator">:</span> <span class="token string">"yyyy-MM-dd"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"taxful_total_price_sum"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"sum"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"taxful_total_price"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"pipeline_moving_avg"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"moving_avg"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"buckets_path"</span><span class="token operator">:</span> <span class="token string">"taxful_total_price_sum"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"window"</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
            <span class="token string-property property">"model"</span><span class="token operator">:</span> <span class="token string">"ewma"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
              <span class="token string-property property">"alpha"</span><span class="token operator">:</span> <span class="token number">0.5</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span> 
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h3><a id="moving_fn_699"></a>moving_fn</h3> 
<p>移动函数聚合。基于父级管道聚合的方式，在指定的数据序列中滑动一个窗口，使用<font color="orange">自定义脚本</font>的方式计算出窗口内部的值。移动函数聚合内置了一些常见的函数。</p> 
<ul><li> <p>buckets_path：（必须）目标桶的路径指向。</p> </li><li> <p>window：（必须）滑动窗口的大小。</p> </li><li> <p>script：（必须）对每个窗口内部的数据执行的脚本。</p> </li><li> <p>gap_policy：分桶数据出现空值或者缺失值的处理策略，默认 skip。<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.14/search-aggregations-pipeline.html#gap-policy" rel="nofollow">gap_policy 详细说明</a></p> 
  <ul><li>skip：跳过空值或者缺失值，不参与聚合计算。</li><li>insert_zeros：将空值或者缺失值当作 0 来参与聚合计算。</li><li>keep_values：如果提供的指标值是一个空值或者缺失值（null、NAN）则跳过，不参与聚合计算；否则使用该指标值参与聚合计算。</li></ul> </li><li> <p>shift：指定窗口的起始位置向右移动多少位。默认 0，即窗口内部的聚合计算不包括当前桶。该值每增加一，则窗口的起始位置向右移动一位。如果指定窗口内部的聚合计算包括当前桶，则可以将 shift 设置为 1。</p> </li></ul> 
<p>移动函数聚合内置了一些常见函数，如下：</p> 
<ul><li>MovingFunctions.max(values)：获取最大值（忽略 null、NaN 值，如果窗口为空或者窗口内部的值都是 null、NaN，则返回 NaN ）。</li><li>MovingFunctions.min(values)：获取最小值（忽略 null、NaN 值，如果窗口为空或者窗口内部的值都是 null、NaN，则返回 NaN ）。</li><li>MovingFunctions.sum(values)：获取总和（忽略 null、NaN 值，如果窗口为空或者窗口内部的值都是 null、NaN，则返回 0.0 ）。</li><li>MovingFunctions.stdDev(values, 平均值)：获取标准差（忽略 null、NaN 值，如果窗口为空或者窗口内部的值都是 null、NaN，则返回 0.0 ）。</li><li>MovingFunctions.unweightedAvg(values)：使用 simple 模型获取平均值。</li><li>MovingFunctions.linearWeightedAvg(values)：使用 linear 模型获取平均值。</li><li>MovingFunctions.ewma(values, alpha)：使用 ewma 模型获取平均值。</li><li>MovingFunctions.holt(values, alpha, beta)：使用 holt 模型获取平均值。</li><li>MovingFunctions.holtWinters(values, alpha, beta, gamma, period, multiplicative)：使用 holt_winters 模型获取平均值。<font color="999aaa">multiplicative：布尔值，true 表示使用乘法计算；false 表示使用加法计算</font></li></ul> 
<p>1、统计每天的订单消费金额，以及连续五天的消费金额总和。</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> kibana_sample_data_ecommerce<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string-property property">"track_total_hits"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"date_histogram_order_date"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"date_histogram"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"order_date"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"calendar_interval"</span><span class="token operator">:</span> <span class="token string">"day"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"format"</span><span class="token operator">:</span> <span class="token string">"yyyy-MM-dd"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"stats_taxful_total_price"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"stats"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"taxful_total_price"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"pipeline_moving_fn"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"moving_fn"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"buckets_path"</span><span class="token operator">:</span> <span class="token string">"stats_taxful_total_price.sum"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"window"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
            <span class="token string-property property">"script"</span><span class="token operator">:</span> <span class="token string">""</span>"
              MovingFunctions<span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span>
            <span class="token string">""</span>"<span class="token punctuation">,</span>
            <span class="token string-property property">"shift"</span><span class="token operator">:</span> <span class="token number">1</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>截取部分的聚合结果如下：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"key_as_string"</span> <span class="token operator">:</span> <span class="token string">"2022-07-14"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"key"</span> <span class="token operator">:</span> <span class="token number">1657756800000</span><span class="token punctuation">,</span>
  <span class="token string-property property">"doc_count"</span> <span class="token operator">:</span> <span class="token number">146</span><span class="token punctuation">,</span>
  <span class="token string-property property">"stats_taxful_total_price"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"count"</span> <span class="token operator">:</span> <span class="token number">146</span><span class="token punctuation">,</span>
    <span class="token string-property property">"min"</span> <span class="token operator">:</span> <span class="token number">18.984375</span><span class="token punctuation">,</span>
    <span class="token string-property property">"max"</span> <span class="token operator">:</span> <span class="token number">230.0</span><span class="token punctuation">,</span>
    <span class="token string-property property">"avg"</span> <span class="token operator">:</span> <span class="token number">72.45569349315069</span><span class="token punctuation">,</span>
    <span class="token string-property property">"sum"</span> <span class="token operator">:</span> <span class="token number">10578.53125</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"pipeline_moving_fn"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">10578.53125</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"key_as_string"</span> <span class="token operator">:</span> <span class="token string">"2022-07-15"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"key"</span> <span class="token operator">:</span> <span class="token number">1657843200000</span><span class="token punctuation">,</span>
  <span class="token string-property property">"doc_count"</span> <span class="token operator">:</span> <span class="token number">153</span><span class="token punctuation">,</span>
  <span class="token string-property property">"stats_taxful_total_price"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"count"</span> <span class="token operator">:</span> <span class="token number">153</span><span class="token punctuation">,</span>
    <span class="token string-property property">"min"</span> <span class="token operator">:</span> <span class="token number">22.984375</span><span class="token punctuation">,</span>
    <span class="token string-property property">"max"</span> <span class="token operator">:</span> <span class="token number">220.0</span><span class="token punctuation">,</span>
    <span class="token string-property property">"avg"</span> <span class="token operator">:</span> <span class="token number">68.2875816993464</span><span class="token punctuation">,</span>
    <span class="token string-property property">"sum"</span> <span class="token operator">:</span> <span class="token number">10448.0</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"pipeline_moving_fn"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">21026.53125</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"key_as_string"</span> <span class="token operator">:</span> <span class="token string">"2022-07-16"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"key"</span> <span class="token operator">:</span> <span class="token number">1657929600000</span><span class="token punctuation">,</span>
  <span class="token string-property property">"doc_count"</span> <span class="token operator">:</span> <span class="token number">143</span><span class="token punctuation">,</span>
  <span class="token string-property property">"stats_taxful_total_price"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"count"</span> <span class="token operator">:</span> <span class="token number">143</span><span class="token punctuation">,</span>
    <span class="token string-property property">"min"</span> <span class="token operator">:</span> <span class="token number">18.984375</span><span class="token punctuation">,</span>
    <span class="token string-property property">"max"</span> <span class="token operator">:</span> <span class="token number">250.0</span><span class="token punctuation">,</span>
    <span class="token string-property property">"avg"</span> <span class="token operator">:</span> <span class="token number">71.91247814685315</span><span class="token punctuation">,</span>
    <span class="token string-property property">"sum"</span> <span class="token operator">:</span> <span class="token number">10283.484375</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"pipeline_moving_fn"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">31310.015625</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="bucket_script_817"></a>bucket_script</h3> 
<p>分桶脚本聚合。基于父级管道聚合的方式，对多个分桶的<font color="orange">数值类型</font>的指标使用<font color="orange">脚本方式</font>进行聚合统计。</p> 
<ul><li>buckets_path：（必须）目标桶的路径指向。</li><li>script：（必须）自定义脚本。</li><li>gap_policy：分桶数据出现空值或者缺失值的处理策略，默认 skip。<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.14/search-aggregations-pipeline.html#gap-policy" rel="nofollow">gap_policy 详细说明</a> 
  <ul><li>skip：跳过空值或者缺失值，不参与聚合计算。</li><li>insert_zeros：将空值或者缺失值当作 0 来参与聚合计算。</li><li>keep_values：如果提供的指标值是一个空值或者缺失值（null、NAN）则跳过，不参与聚合计算；否则使用该指标值参与聚合计算。</li></ul> </li><li>format：指定数值的输出格式，比如 #、#0.00。默认 null。</li></ul> 
<p>1、统计每天的订单消费总额以及商品的总数，然后统计平均每件商品的消费金额。</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> kibana_sample_data_ecommerce<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string-property property">"track_total_hits"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"date_histogram_order_date"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"date_histogram"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"order_date"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"calendar_interval"</span><span class="token operator">:</span> <span class="token string">"day"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"format"</span><span class="token operator">:</span> <span class="token string">"yyyy-MM-dd"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"stats_taxful_total_price"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"stats"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"taxful_total_price"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"stats_total_quantity"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"stats"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"total_quantity"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"pipeline-script"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"bucket_script"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"buckets_path"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
              <span class="token string-property property">"total_price"</span><span class="token operator">:</span> <span class="token string">"stats_taxful_total_price.sum"</span><span class="token punctuation">,</span>
              <span class="token string-property property">"total_quantity"</span><span class="token operator">:</span> <span class="token string">"stats_total_quantity.sum"</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string-property property">"script"</span><span class="token operator">:</span> <span class="token string">""</span>"
              params<span class="token punctuation">.</span>total_price <span class="token operator">/</span> params<span class="token punctuation">.</span>total_quantity
            <span class="token string">""</span>"
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>截取部分的聚合如下：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"key_as_string"</span> <span class="token operator">:</span> <span class="token string">"2022-07-14"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"key"</span> <span class="token operator">:</span> <span class="token number">1657756800000</span><span class="token punctuation">,</span>
  <span class="token string-property property">"doc_count"</span> <span class="token operator">:</span> <span class="token number">146</span><span class="token punctuation">,</span>
  <span class="token string-property property">"stats_taxful_total_price"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"count"</span> <span class="token operator">:</span> <span class="token number">146</span><span class="token punctuation">,</span>
    <span class="token string-property property">"min"</span> <span class="token operator">:</span> <span class="token number">18.984375</span><span class="token punctuation">,</span>
    <span class="token string-property property">"max"</span> <span class="token operator">:</span> <span class="token number">230.0</span><span class="token punctuation">,</span>
    <span class="token string-property property">"avg"</span> <span class="token operator">:</span> <span class="token number">72.45569349315069</span><span class="token punctuation">,</span>
    <span class="token string-property property">"sum"</span> <span class="token operator">:</span> <span class="token number">10578.53125</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"stats_total_quantity"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"count"</span> <span class="token operator">:</span> <span class="token number">146</span><span class="token punctuation">,</span>
    <span class="token string-property property">"min"</span> <span class="token operator">:</span> <span class="token number">2.0</span><span class="token punctuation">,</span>
    <span class="token string-property property">"max"</span> <span class="token operator">:</span> <span class="token number">4.0</span><span class="token punctuation">,</span>
    <span class="token string-property property">"avg"</span> <span class="token operator">:</span> <span class="token number">2.1780821917808217</span><span class="token punctuation">,</span>
    <span class="token string-property property">"sum"</span> <span class="token operator">:</span> <span class="token number">318.0</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"pipeline-script"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">33.2658215408805</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="bucket_selector_902"></a>bucket_selector</h3> 
<p>分桶过滤器聚合。基于父级管道聚合的方式，使用<font color="orange">脚本方式过滤出符合条件的数值类型</font>的分桶数据参与聚合统计。脚本需要返回布尔值。如果脚本语言是 expression，则脚本可以返回数值，0 被视为 false，其它值被视为 true。</p> 
<ul><li>buckets_path：（必须）目标桶的路径指向。</li><li>script：（必须）自定义脚本。</li><li>gap_policy：分桶数据出现空值或者缺失值的处理策略，默认 skip。<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.14/search-aggregations-pipeline.html#gap-policy" rel="nofollow">gap_policy 详细说明</a> 
  <ul><li>skip：跳过空值或者缺失值，不参与聚合计算。</li><li>insert_zeros：将空值或者缺失值当作 0 来参与聚合计算。</li><li>keep_values：如果提供的指标值是一个空值或者缺失值（null、NAN）则跳过，不参与聚合计算；否则使用该指标值参与聚合计算。</li></ul> </li><li>format：指定数值的输出格式，比如 #、#0.00。默认 null。</li></ul> 
<p>1、统计每天的订单消费金额的相关指标，并筛选出总金额大于13000的日期。</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> kibana_sample_data_ecommerce<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string-property property">"track_total_hits"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"date_histogram_order_date"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"date_histogram"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"order_date"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"calendar_interval"</span><span class="token operator">:</span> <span class="token string">"day"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"format"</span><span class="token operator">:</span> <span class="token string">"yyyy-MM-dd"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"stats_taxful_total_price"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"stats"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"taxful_total_price"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"pipeline-script"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"bucket_selector"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"buckets_path"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
              <span class="token string-property property">"total_price"</span><span class="token operator">:</span> <span class="token string">"stats_taxful_total_price.sum"</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string-property property">"script"</span><span class="token operator">:</span> <span class="token string">""</span>"
              params<span class="token punctuation">.</span>total_price <span class="token operator">&gt;</span> <span class="token number">13000</span>
            <span class="token string">""</span>"
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>截取部分的聚合结果如下：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"key_as_string"</span> <span class="token operator">:</span> <span class="token string">"2022-07-22"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"key"</span> <span class="token operator">:</span> <span class="token number">1658448000000</span><span class="token punctuation">,</span>
  <span class="token string-property property">"doc_count"</span> <span class="token operator">:</span> <span class="token number">163</span><span class="token punctuation">,</span>
  <span class="token string-property property">"stats_taxful_total_price"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"count"</span> <span class="token operator">:</span> <span class="token number">163</span><span class="token punctuation">,</span>
    <span class="token string-property property">"min"</span> <span class="token operator">:</span> <span class="token number">18.984375</span><span class="token punctuation">,</span>
    <span class="token string-property property">"max"</span> <span class="token operator">:</span> <span class="token number">393.0</span><span class="token punctuation">,</span>
    <span class="token string-property property">"avg"</span> <span class="token operator">:</span> <span class="token number">83.1910467791411</span><span class="token punctuation">,</span>
    <span class="token string-property property">"sum"</span> <span class="token operator">:</span> <span class="token number">13560.140625</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="bucket_sort_971"></a>bucket_sort</h3> 
<p>分桶排序聚合。使用父级管道聚合的方式，对多个分桶进行<font color="orange">排序</font>。可以不指定字段或者指定多个字段进行排序。分桶之间可以根据 <code>_key</code>、<code>_count</code> 或者子聚合的方式进行排序。</p> 
<ul><li> <p>sort：指定用于排序的字段列表。</p> </li><li> <p>from：指定从第几个开始截断。默认 0。</p> </li><li> <p>size：指定返回多少个桶。默认返回所有桶。</p> </li><li> <p>gap_policy：分桶数据出现空值或者缺失值的处理策略，默认 skip。<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.14/search-aggregations-pipeline.html#gap-policy" rel="nofollow">gap_policy 详细说明</a></p> 
  <ul><li> <p>skip：跳过空值或者缺失值，不参与聚合计算。</p> </li><li> <p>insert_zeros：将空值或者缺失值当作 0 来参与聚合计算。</p> </li><li> <p>keep_values：如果提供的指标值是一个空值或者缺失值（null、NAN）则跳过，不参与聚合计算；否则使用该指标值参与聚合计算。</p> </li></ul> </li></ul> 
<p>1、统计每天订单的消费金额中最高的两天的消费金额的相关指标。</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> kibana_sample_data_ecommerce<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string-property property">"track_total_hits"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"date_histogram_order_date"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"date_histogram"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"order_date"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"calendar_interval"</span><span class="token operator">:</span> <span class="token string">"day"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"format"</span><span class="token operator">:</span> <span class="token string">"yyyy-MM-dd"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"stats_taxful_total_price"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"stats"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"taxful_total_price"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"pipeline-sort"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"bucket_sort"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"sort"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
              <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"stats_taxful_total_price.sum"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                  <span class="token string-property property">"order"</span><span class="token operator">:</span> <span class="token string">"desc"</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">2</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>截取部分的聚合结果如下：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"key_as_string"</span> <span class="token operator">:</span> <span class="token string">"2022-07-22"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"key"</span> <span class="token operator">:</span> <span class="token number">1658448000000</span><span class="token punctuation">,</span>
  <span class="token string-property property">"doc_count"</span> <span class="token operator">:</span> <span class="token number">163</span><span class="token punctuation">,</span>
  <span class="token string-property property">"stats_taxful_total_price"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"count"</span> <span class="token operator">:</span> <span class="token number">163</span><span class="token punctuation">,</span>
    <span class="token string-property property">"min"</span> <span class="token operator">:</span> <span class="token number">18.984375</span><span class="token punctuation">,</span>
    <span class="token string-property property">"max"</span> <span class="token operator">:</span> <span class="token number">393.0</span><span class="token punctuation">,</span>
    <span class="token string-property property">"avg"</span> <span class="token operator">:</span> <span class="token number">83.1910467791411</span><span class="token punctuation">,</span>
    <span class="token string-property property">"sum"</span> <span class="token operator">:</span> <span class="token number">13560.140625</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"key_as_string"</span> <span class="token operator">:</span> <span class="token string">"2022-08-07"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"key"</span> <span class="token operator">:</span> <span class="token number">1659830400000</span><span class="token punctuation">,</span>
  <span class="token string-property property">"doc_count"</span> <span class="token operator">:</span> <span class="token number">165</span><span class="token punctuation">,</span>
  <span class="token string-property property">"stats_taxful_total_price"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"count"</span> <span class="token operator">:</span> <span class="token number">165</span><span class="token punctuation">,</span>
    <span class="token string-property property">"min"</span> <span class="token operator">:</span> <span class="token number">18.984375</span><span class="token punctuation">,</span>
    <span class="token string-property property">"max"</span> <span class="token operator">:</span> <span class="token number">225.0</span><span class="token punctuation">,</span>
    <span class="token string-property property">"avg"</span> <span class="token operator">:</span> <span class="token number">79.36732954545455</span><span class="token punctuation">,</span>
    <span class="token string-property property">"sum"</span> <span class="token operator">:</span> <span class="token number">13095.609375</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>2、统计前三天的消费金额的相关指标。</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> kibana_sample_data_ecommerce<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string-property property">"track_total_hits"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"date_histogram_order_date"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"date_histogram"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"order_date"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"calendar_interval"</span><span class="token operator">:</span> <span class="token string">"day"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"format"</span><span class="token operator">:</span> <span class="token string">"yyyy-MM-dd"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"stats_taxful_total_price"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"stats"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"taxful_total_price"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"pipeline-sort"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"bucket_sort"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"sort"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
              <span class="token string">"_key"</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">3</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>截取部分的聚合结果如下：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"key_as_string"</span> <span class="token operator">:</span> <span class="token string">"2022-07-14"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"key"</span> <span class="token operator">:</span> <span class="token number">1657756800000</span><span class="token punctuation">,</span>
  <span class="token string-property property">"doc_count"</span> <span class="token operator">:</span> <span class="token number">146</span><span class="token punctuation">,</span>
  <span class="token string-property property">"stats_taxful_total_price"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"count"</span> <span class="token operator">:</span> <span class="token number">146</span><span class="token punctuation">,</span>
    <span class="token string-property property">"min"</span> <span class="token operator">:</span> <span class="token number">18.984375</span><span class="token punctuation">,</span>
    <span class="token string-property property">"max"</span> <span class="token operator">:</span> <span class="token number">230.0</span><span class="token punctuation">,</span>
    <span class="token string-property property">"avg"</span> <span class="token operator">:</span> <span class="token number">72.45569349315069</span><span class="token punctuation">,</span>
    <span class="token string-property property">"sum"</span> <span class="token operator">:</span> <span class="token number">10578.53125</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"key_as_string"</span> <span class="token operator">:</span> <span class="token string">"2022-07-15"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"key"</span> <span class="token operator">:</span> <span class="token number">1657843200000</span><span class="token punctuation">,</span>
  <span class="token string-property property">"doc_count"</span> <span class="token operator">:</span> <span class="token number">153</span><span class="token punctuation">,</span>
  <span class="token string-property property">"stats_taxful_total_price"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"count"</span> <span class="token operator">:</span> <span class="token number">153</span><span class="token punctuation">,</span>
    <span class="token string-property property">"min"</span> <span class="token operator">:</span> <span class="token number">22.984375</span><span class="token punctuation">,</span>
    <span class="token string-property property">"max"</span> <span class="token operator">:</span> <span class="token number">220.0</span><span class="token punctuation">,</span>
    <span class="token string-property property">"avg"</span> <span class="token operator">:</span> <span class="token number">68.2875816993464</span><span class="token punctuation">,</span>
    <span class="token string-property property">"sum"</span> <span class="token operator">:</span> <span class="token number">10448.0</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"key_as_string"</span> <span class="token operator">:</span> <span class="token string">"2022-07-16"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"key"</span> <span class="token operator">:</span> <span class="token number">1657929600000</span><span class="token punctuation">,</span>
  <span class="token string-property property">"doc_count"</span> <span class="token operator">:</span> <span class="token number">143</span><span class="token punctuation">,</span>
  <span class="token string-property property">"stats_taxful_total_price"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"count"</span> <span class="token operator">:</span> <span class="token number">143</span><span class="token punctuation">,</span>
    <span class="token string-property property">"min"</span> <span class="token operator">:</span> <span class="token number">18.984375</span><span class="token punctuation">,</span>
    <span class="token string-property property">"max"</span> <span class="token operator">:</span> <span class="token number">250.0</span><span class="token punctuation">,</span>
    <span class="token string-property property">"avg"</span> <span class="token operator">:</span> <span class="token number">71.91247814685315</span><span class="token punctuation">,</span>
    <span class="token string-property property">"sum"</span> <span class="token operator">:</span> <span class="token number">10283.484375</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="deriative_1135"></a>deriative</h3> 
<p>[dɪ’rɪvətɪv]，导数</p> 
<p>使用<font color="orange">父级管道聚合</font>的方式，从父级的<font color="orange">直方图</font>或者<font color="orange">日期直方图</font>聚合中获取指定<font color="orange">数值指标</font>并计算出导数。</p> 
<p>父级的直方图或者日期直方图聚合的 min_doc_count 参数必须设置为 0。</p> 
<p><font color="999aaa">可以用来获取后一个桶相较于前一个桶在相关数值指标上的变化情况。</font></p> 
<ul><li>buckets_path：（必须）目标桶的路径指向。</li><li>gap_policy：分桶数据出现空值或者缺失值的处理策略，默认 skip。 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.14/search-aggregations-pipeline.html#gap-policy" rel="nofollow">gap_policy详细说明</a> 
  <ul><li>skip：跳过空值或者缺失值，不参与聚合计算。</li><li>insert_zeros：将空值或者缺失值当作 0 来参与聚合计算。</li><li>keep_values：如果提供的指标值是一个空值或者缺失值则跳过，不参与聚合计算；否则使用该指标值参与聚合计算。</li></ul> </li><li>format：指定数值的输出格式，比如 #、#0.00。默认 null。</li><li>unit：指定导数值的单位。<font color="999aaa">具体使用参考例子3。</font></li></ul> 
<p>1、统计每天的订单销售总额以及每天的增长情况。</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> kibana_sample_data_ecommerce<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string-property property">"track_total_hits"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"date_histogram_order_date"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"date_histogram"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"order_date"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"calendar_interval"</span><span class="token operator">:</span> <span class="token string">"day"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"format"</span><span class="token operator">:</span> <span class="token string">"yyyy-MM-dd"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"sum_taxful_total_price"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"sum"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"taxful_total_price"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"deriative_sum_taxful_total_price"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"derivative"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"buckets_path"</span><span class="token operator">:</span> <span class="token string">"sum_taxful_total_price"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>截取部分的聚合结果如下：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"key_as_string"</span> <span class="token operator">:</span> <span class="token string">"2022-07-14"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"key"</span> <span class="token operator">:</span> <span class="token number">1657756800000</span><span class="token punctuation">,</span>
  <span class="token string-property property">"doc_count"</span> <span class="token operator">:</span> <span class="token number">146</span><span class="token punctuation">,</span>
  <span class="token string-property property">"sum_taxful_total_price"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">10578.53125</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"key_as_string"</span> <span class="token operator">:</span> <span class="token string">"2022-07-15"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"key"</span> <span class="token operator">:</span> <span class="token number">1657843200000</span><span class="token punctuation">,</span>
  <span class="token string-property property">"doc_count"</span> <span class="token operator">:</span> <span class="token number">153</span><span class="token punctuation">,</span>
  <span class="token string-property property">"sum_taxful_total_price"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">10448.0</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"deriative_sum_taxful_total_price"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">130.53125</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"key_as_string"</span> <span class="token operator">:</span> <span class="token string">"2022-07-16"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"key"</span> <span class="token operator">:</span> <span class="token number">1657929600000</span><span class="token punctuation">,</span>
  <span class="token string-property property">"doc_count"</span> <span class="token operator">:</span> <span class="token number">143</span><span class="token punctuation">,</span>
  <span class="token string-property property">"sum_taxful_total_price"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">10283.484375</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"deriative_sum_taxful_total_price"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">164.515625</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>2、基于 1 的结果，统计每天增长情况的趋势。</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> kibana_sample_data_ecommerce<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string-property property">"track_total_hits"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"date_histogram_order_date"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"date_histogram"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"order_date"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"calendar_interval"</span><span class="token operator">:</span> <span class="token string">"day"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"format"</span><span class="token operator">:</span> <span class="token string">"yyyy-MM-dd"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"sum_taxful_total_price"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"sum"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"taxful_total_price"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"deriative_sum_taxful_total_price"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"derivative"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"buckets_path"</span><span class="token operator">:</span> <span class="token string">"sum_taxful_total_price"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"second_deriative_sum_taxful_total_price"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"derivative"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"buckets_path"</span><span class="token operator">:</span> <span class="token string">"deriative_sum_taxful_total_price"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>截取部分的聚合如下：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"key_as_string"</span> <span class="token operator">:</span> <span class="token string">"2022-07-14"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"key"</span> <span class="token operator">:</span> <span class="token number">1657756800000</span><span class="token punctuation">,</span>
  <span class="token string-property property">"doc_count"</span> <span class="token operator">:</span> <span class="token number">146</span><span class="token punctuation">,</span>
  <span class="token string-property property">"sum_taxful_total_price"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">10578.53125</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"key_as_string"</span> <span class="token operator">:</span> <span class="token string">"2022-07-15"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"key"</span> <span class="token operator">:</span> <span class="token number">1657843200000</span><span class="token punctuation">,</span>
  <span class="token string-property property">"doc_count"</span> <span class="token operator">:</span> <span class="token number">153</span><span class="token punctuation">,</span>
  <span class="token string-property property">"sum_taxful_total_price"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">10448.0</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"deriative_sum_taxful_total_price"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">130.53125</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"key_as_string"</span> <span class="token operator">:</span> <span class="token string">"2022-07-16"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"key"</span> <span class="token operator">:</span> <span class="token number">1657929600000</span><span class="token punctuation">,</span>
  <span class="token string-property property">"doc_count"</span> <span class="token operator">:</span> <span class="token number">143</span><span class="token punctuation">,</span>
  <span class="token string-property property">"sum_taxful_total_price"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">10283.484375</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"deriative_sum_taxful_total_price"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">164.515625</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"second_deriative_sum_taxful_total_price"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">33.984375</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>3、统计每月的订单销售总额以及每月的增长情况（包括平均每天的增长情况）。</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> kibana_sample_data_ecommerce<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string-property property">"track_total_hits"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"date_histogram_order_date"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"date_histogram"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"order_date"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"calendar_interval"</span><span class="token operator">:</span> <span class="token string">"month"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"format"</span><span class="token operator">:</span> <span class="token string">"yyyy-MM-dd"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"sum_taxful_total_price"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"sum"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"taxful_total_price"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"deriative_sum_taxful_total_price"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"derivative"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"buckets_path"</span><span class="token operator">:</span> <span class="token string">"sum_taxful_total_price"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"unit"</span><span class="token operator">:</span> <span class="token string">"day"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>截取部分的聚合结果如下：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"key_as_string"</span> <span class="token operator">:</span> <span class="token string">"2022-07-01"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"key"</span> <span class="token operator">:</span> <span class="token number">1656633600000</span><span class="token punctuation">,</span>
  <span class="token string-property property">"doc_count"</span> <span class="token operator">:</span> <span class="token number">2678</span><span class="token punctuation">,</span>
  <span class="token string-property property">"sum_taxful_total_price"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">199112.57421875</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"key_as_string"</span> <span class="token operator">:</span> <span class="token string">"2022-08-01"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"key"</span> <span class="token operator">:</span> <span class="token number">1659312000000</span><span class="token punctuation">,</span>
  <span class="token string-property property">"doc_count"</span> <span class="token operator">:</span> <span class="token number">1997</span><span class="token punctuation">,</span>
  <span class="token string-property property">"sum_taxful_total_price"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">151771.5546875</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"deriative_sum_taxful_total_price"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">47341.01953125</span><span class="token punctuation">,</span>
    <span class="token string-property property">"normalized_value"</span> <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1527.129662298387</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="serial_diff_1353"></a>serial_diff</h3> 
<p>使用<font color="orange">父级管道聚合</font>的方式，从父级的<font color="orange">直方图</font>或者<font color="orange">日期直方图</font>聚合中获取指定<font color="orange">数值指标</font>并计算出指定时间段的差异。</p> 
<p><font color="999aaa">可以用来获取后一个桶相较于前一个桶在相关数值指标上在指定时间段的变化情况。</font></p> 
<ul><li>buckets_path：（必须）目标桶的路径指向。</li><li>gap_policy：分桶数据出现空值或者缺失值的处理策略，默认 skip。 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.14/search-aggregations-pipeline.html#gap-policy" rel="nofollow">gap_policy详细说明</a> 
  <ul><li>skip：跳过空值或者缺失值，不参与聚合计算。</li><li>insert_zeros：将空值或者缺失值当作 0 来参与聚合计算。</li><li>keep_values：如果提供的指标值是一个空值或者缺失值则跳过，不参与聚合计算；否则使用该指标值参与聚合计算。</li></ul> </li><li>format：指定数值的输出格式，比如 #、#0.00。默认 null。</li><li>lag：间隔多少个桶统计一次差异。默认 1。必须是一个正整数。</li></ul> 
<p>1、统计每天订单的消费总额以及每周的变化情况。</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> kibana_sample_data_ecommerce<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string-property property">"track_total_hits"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"date_histogram_order_date"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"date_histogram"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"order_date"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"calendar_interval"</span><span class="token operator">:</span> <span class="token string">"day"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"format"</span><span class="token operator">:</span> <span class="token string">"yyyy-MM-dd"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"sum_taxful_total_price"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"sum"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"taxful_total_price"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"serial_diff_sum_taxful_total_price"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"serial_diff"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"buckets_path"</span><span class="token operator">:</span> <span class="token string">"sum_taxful_total_price"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"lag"</span><span class="token operator">:</span> <span class="token number">7</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>截取部分的聚合结果如下：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"key_as_string"</span> <span class="token operator">:</span> <span class="token string">"2022-07-14"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"key"</span> <span class="token operator">:</span> <span class="token number">1657756800000</span><span class="token punctuation">,</span>
  <span class="token string-property property">"doc_count"</span> <span class="token operator">:</span> <span class="token number">146</span><span class="token punctuation">,</span>
  <span class="token string-property property">"sum_taxful_total_price"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">10578.53125</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token operator">...</span><span class="token operator">...</span>（省略中间的聚合结果）
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"key_as_string"</span> <span class="token operator">:</span> <span class="token string">"2022-07-21"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"key"</span> <span class="token operator">:</span> <span class="token number">1658361600000</span><span class="token punctuation">,</span>
  <span class="token string-property property">"doc_count"</span> <span class="token operator">:</span> <span class="token number">152</span><span class="token punctuation">,</span>
  <span class="token string-property property">"sum_taxful_total_price"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">11185.3671875</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"serial_diff_sum_taxful_total_price"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">606.8359375</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9808215e5cf78a4f4260bd0b7fb7107a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">redis 数据导出及导入</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3cc14bdeeeef2dc3a6735e815c468ae6/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Vue Springboot前后端交互</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>