<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>3步实现用Python防止微信消息撤回功能！ - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="3步实现用Python防止微信消息撤回功能！" />
<meta property="og:description" content="我们在使用微信时，如果发错消息，可以撤回，但你有没有想过在某些特殊情况下，防止对方撤回消息呢？
今天我们就使用Python实现一下查看好友撤回的微信消息的功能。运行程序，手机端微信扫描弹出的二维码即可登录网页版微信，程序会将网页版微信收到的所有消息都缓存下来，当检测到有消息（语音、文字、图片等）撤回时，将撤回消息的缓存版本通过文件传输助手发送到自己的手机上，如下图所示。
实现微信消息防撤回功能主要通过Python内置的os模块、re模块、time模块、platform模块，以及第三方模块itchat实现。具体步骤如下：
（1）由于使用了第三方模块itchat，所以需要先安装该模块。使用pip命令安装模块的命令如下：
pip install itchat （2）导入程序中需要使用的模块，具体代码如下：
import re import os import time import itchat import platform from itchat.content import * （3）实现逻辑。首先使用platform模块获取操作系统底层的数据，根据不同的操作系统传入不同的登录参数，登陆成功后，缓存接收到的所有信息并监听是否有消息撤回。代码如下：
import re import os import time import itchat import platform from itchat.content import * msg_info = {} face_package = None # 处理接收到的信息 @itchat.msg_register([TEXT, PICTURE, FRIENDS, CARD, MAP, SHARING, RECORDING, ATTACHMENT, VIDEO], isFriendChat=True, isMpChat=True) def handle_rsg(msg): global face_package # 接收消息的时间 msg_time_receive = time.strftime(&#34;%Y-%m-%d %H:%M:%S&#34;, time.localtime()) # 发信人 try: msg_from = itchat." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/560f17cd3354dc5a604fea96dba0f305/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-23T16:09:20+08:00" />
<meta property="article:modified_time" content="2023-12-23T16:09:20+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">3步实现用Python防止微信消息撤回功能！</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>我们在使用微信时，如果发错消息，可以撤回，但你有没有想过在某些特殊情况下，防止对方撤回消息呢？</p> 
<p><strong>今天我们就使用Python实现一下查看好友撤回的微信消息的功能</strong>。运行程序，手机端微信扫描弹出的二维码即可登录网页版微信，程序会将网页版微信收到的所有消息都缓存下来，当检测到有消息（语音、文字、图片等）撤回时，将撤回消息的缓存版本通过文件传输助手发送到自己的手机上，如下图所示。</p> 
<p><img src="https://images2.imgbox.com/24/6d/8aq4i1gd_o.png" alt=""></p> 
<p>实现微信消息防撤回功能主要通过Python内置的os模块、re模块、time模块、platform模块，以及第三方模块itchat实现。具体步骤如下：</p> 
<p>（1）由于使用了第三方模块itchat，所以需要先安装该模块。使用pip命令安装模块的命令如下：</p> 
<pre><code class="prism language-bash">pip <span class="token function">install</span> itchat
</code></pre> 
<p>（2）导入程序中需要使用的模块，具体代码如下：</p> 
<pre><code class="prism language-bash"><span class="token function">import</span> re

<span class="token function">import</span> os

<span class="token function">import</span> <span class="token function">time</span>

<span class="token function">import</span> itchat

<span class="token function">import</span> platform

from itchat.content <span class="token function">import</span> *
</code></pre> 
<p>（3）实现逻辑。首先使用platform模块获取操作系统底层的数据，根据不同的操作系统传入不同的登录参数，登陆成功后，缓存接收到的所有信息并监听是否有消息撤回。代码如下：</p> 
<pre><code class="prism language-bash"><span class="token function">import</span> re

<span class="token function">import</span> os

<span class="token function">import</span> <span class="token function">time</span>

<span class="token function">import</span> itchat

<span class="token function">import</span> platform

from itchat.content <span class="token function">import</span> *

 

msg_info <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

face_package <span class="token operator">=</span> None

 

<span class="token comment"># 处理接收到的信息</span>

@itchat.msg_register<span class="token punctuation">(</span><span class="token punctuation">[</span>TEXT, PICTURE, FRIENDS, CARD, MAP, SHARING, RECORDING, ATTACHMENT, VIDEO<span class="token punctuation">]</span>, <span class="token assign-left variable">isFriendChat</span><span class="token operator">=</span>True, <span class="token assign-left variable">isMpChat</span><span class="token operator">=</span>True<span class="token punctuation">)</span>

def handle_rsg<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>:

    global face_package

    <span class="token comment"># 接收消息的时间</span>

    msg_time_receive <span class="token operator">=</span> time.strftime<span class="token punctuation">(</span><span class="token string">"%Y-%m-%d %H:%M:%S"</span>, time.localtime<span class="token punctuation">(</span><span class="token punctuation">))</span>

    <span class="token comment"># 发信人</span>

    try:

        msg_from <span class="token operator">=</span> itchat.search_friends<span class="token punctuation">(</span>userName<span class="token operator">=</span>msg<span class="token punctuation">[</span><span class="token string">'FromUserName'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'NickName'</span><span class="token punctuation">]</span>

    except:

        msg_from <span class="token operator">=</span> <span class="token string">'WeChat Official Accounts'</span>

    <span class="token comment"># 发信时间</span>

    msg_time_send <span class="token operator">=</span> msg<span class="token punctuation">[</span><span class="token string">'CreateTime'</span><span class="token punctuation">]</span>

    <span class="token comment"># 信息ID</span>

    msg_id <span class="token operator">=</span> msg<span class="token punctuation">[</span><span class="token string">'MsgId'</span><span class="token punctuation">]</span>

    msg_content <span class="token operator">=</span> None

    msg_link <span class="token operator">=</span> None

    <span class="token comment"># 文本或者好友推荐</span>

    <span class="token keyword">if</span> msg<span class="token punctuation">[</span><span class="token string">'Type'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'Text'</span> or msg<span class="token punctuation">[</span><span class="token string">'Type'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'Friends'</span><span class="token builtin class-name">:</span>

        msg_content <span class="token operator">=</span> msg<span class="token punctuation">[</span><span class="token string">'Text'</span><span class="token punctuation">]</span>

        print<span class="token punctuation">(</span><span class="token string">'[Text/Friends]: %s'</span> % msg_content<span class="token punctuation">)</span>

    <span class="token comment"># 附件/视频/图片/语音</span>

    <span class="token keyword">elif</span> msg<span class="token punctuation">[</span><span class="token string">'Type'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'Attachment'</span> or msg<span class="token punctuation">[</span><span class="token string">'Type'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"Video"</span> or msg<span class="token punctuation">[</span><span class="token string">'Type'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'Picture'</span> or msg<span class="token punctuation">[</span><span class="token string">'Type'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'Recording'</span><span class="token builtin class-name">:</span>

        msg_content <span class="token operator">=</span> msg<span class="token punctuation">[</span><span class="token string">'FileName'</span><span class="token punctuation">]</span>

        msg<span class="token punctuation">[</span><span class="token string">'Text'</span><span class="token punctuation">]</span><span class="token punctuation">(</span>str<span class="token punctuation">(</span>msg_content<span class="token punctuation">))</span>

        print<span class="token punctuation">(</span><span class="token string">'[Attachment/Video/Picture/Recording]: %s'</span> % msg_content<span class="token punctuation">)</span>

    <span class="token comment"># 举一反三代码</span>

    <span class="token comment"># 位置信息</span>

    <span class="token keyword">elif</span> msg<span class="token punctuation">[</span><span class="token string">'Type'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'Map'</span><span class="token builtin class-name">:</span>

        x, y, location <span class="token operator">=</span> re.search<span class="token punctuation">(</span><span class="token string">"&lt;location x=<span class="token entity" title='\"'>\"</span>(.*?)<span class="token entity" title='\"'>\"</span> y=<span class="token entity" title='\"'>\"</span>(.*?)<span class="token entity" title='\"'>\"</span>.*label=<span class="token entity" title='\"'>\"</span>(.*?)<span class="token entity" title='\"'>\"</span>.*"</span>, msg<span class="token punctuation">[</span><span class="token string">'OriContent'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>.group<span class="token punctuation">(</span><span class="token number">1</span>, <span class="token number">2</span>, <span class="token number">3</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> location is None:

            msg_content <span class="token operator">=</span> r<span class="token string">"纬度:"</span> + x.__str__<span class="token punctuation">(</span><span class="token punctuation">)</span> + <span class="token string">", 经度:"</span> + y.__str__<span class="token punctuation">(</span><span class="token punctuation">)</span>

        else:

            msg_content <span class="token operator">=</span> r<span class="token string">""</span> + location

        print<span class="token punctuation">(</span><span class="token string">'[Map]: %s'</span> % msg_content<span class="token punctuation">)</span>

    <span class="token comment"># 分享的音乐/文章</span>

    <span class="token keyword">elif</span> msg<span class="token punctuation">[</span><span class="token string">'Type'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'Sharing'</span><span class="token builtin class-name">:</span>

        msg_content <span class="token operator">=</span> msg<span class="token punctuation">[</span><span class="token string">'Text'</span><span class="token punctuation">]</span>

        msg_link <span class="token operator">=</span> msg<span class="token punctuation">[</span><span class="token string">'Url'</span><span class="token punctuation">]</span>

        print<span class="token punctuation">(</span><span class="token string">'[Sharing]: %s'</span> % msg_content<span class="token punctuation">)</span>

    msg_info.update<span class="token punctuation">(</span>

            <span class="token punctuation">{<!-- --></span>

                msg_id: <span class="token punctuation">{<!-- --></span>

                    <span class="token string">"msg_from"</span><span class="token builtin class-name">:</span> msg_from,

                    <span class="token string">"msg_time_send"</span><span class="token builtin class-name">:</span> msg_time_send,

                    <span class="token string">"msg_time_receive"</span><span class="token builtin class-name">:</span> msg_time_receive,

                    <span class="token string">"msg_type"</span><span class="token builtin class-name">:</span> msg<span class="token punctuation">[</span><span class="token string">"Type"</span><span class="token punctuation">]</span>,

                    <span class="token string">"msg_content"</span><span class="token builtin class-name">:</span> msg_content,

                    <span class="token string">"msg_link"</span><span class="token builtin class-name">:</span> msg_link

                <span class="token punctuation">}</span>

            <span class="token punctuation">}</span>

        <span class="token punctuation">)</span>

    face_package <span class="token operator">=</span> msg_content

 

<span class="token comment"># 监听是否有消息撤回</span>

@itchat.msg_register<span class="token punctuation">(</span>NOTE, <span class="token assign-left variable">isFriendChat</span><span class="token operator">=</span>True, <span class="token assign-left variable">isGroupChat</span><span class="token operator">=</span>True, <span class="token assign-left variable">isMpChat</span><span class="token operator">=</span>True<span class="token punctuation">)</span>

def monitor<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>:

    <span class="token keyword">if</span> <span class="token string">'撤回了一条消息'</span> <span class="token keyword">in</span> msg<span class="token punctuation">[</span><span class="token string">'Content'</span><span class="token punctuation">]</span>:

        recall_msg_id <span class="token operator">=</span> re.search<span class="token punctuation">(</span><span class="token string">"\&lt;msgid\&gt;(.*?)\&lt;\/msgid\&gt;"</span>, msg<span class="token punctuation">[</span><span class="token string">'Content'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>.group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

        recall_msg <span class="token operator">=</span> msg_info.get<span class="token punctuation">(</span>recall_msg_id<span class="token punctuation">)</span>

        print<span class="token punctuation">(</span><span class="token string">'[Recall]: %s'</span> % recall_msg<span class="token punctuation">)</span>

        <span class="token comment"># 表情包</span>

        <span class="token keyword">if</span> len<span class="token punctuation">(</span>recall_msg_id<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">11</span>:

            itchat.send_file<span class="token punctuation">(</span>face_package, <span class="token assign-left variable">toUserName</span><span class="token operator">=</span><span class="token string">'filehelper'</span><span class="token punctuation">)</span>

        else:

            msg_prime <span class="token operator">=</span> <span class="token string">'---'</span> + recall_msg.get<span class="token punctuation">(</span><span class="token string">'msg_from'</span><span class="token punctuation">)</span> + <span class="token string">'撤回了一条消息---\n'</span> <span class="token punctuation">\</span>

                        <span class="token string">'消息类型：'</span> + recall_msg.get<span class="token punctuation">(</span><span class="token string">'msg_type'</span><span class="token punctuation">)</span> + <span class="token string">'\n'</span> <span class="token punctuation">\</span>

                        <span class="token string">'时间：'</span> + recall_msg.get<span class="token punctuation">(</span><span class="token string">'msg_time_receive'</span><span class="token punctuation">)</span> + <span class="token string">'\n'</span> <span class="token punctuation">\</span>

                        <span class="token string">'内容：'</span> + recall_msg.get<span class="token punctuation">(</span><span class="token string">'msg_content'</span><span class="token punctuation">)</span>

            <span class="token keyword">if</span> recall_msg<span class="token punctuation">[</span><span class="token string">'msg_type'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'Sharing'</span><span class="token builtin class-name">:</span>

                msg_prime <span class="token operator">+=</span> <span class="token string">'\n链接：'</span> + recall_msg.get<span class="token punctuation">(</span><span class="token string">'msg_link'</span><span class="token punctuation">)</span>

            itchat.send_msg<span class="token punctuation">(</span>msg_prime, <span class="token assign-left variable">toUserName</span><span class="token operator">=</span><span class="token string">'filehelper'</span><span class="token punctuation">)</span>

            <span class="token keyword">if</span> recall_msg<span class="token punctuation">[</span><span class="token string">'msg_type'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'Attachment'</span> or recall_msg<span class="token punctuation">[</span><span class="token string">'msg_type'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"Video"</span> or recall_msg<span class="token punctuation">[</span><span class="token string">'msg_type'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'Picture'</span> or recall_msg<span class="token punctuation">[</span><span class="token string">'msg_type'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'Recording'</span><span class="token builtin class-name">:</span>

                <span class="token function">file</span> <span class="token operator">=</span> <span class="token string">'@fil@%s'</span> % <span class="token punctuation">(</span>recall_msg<span class="token punctuation">[</span><span class="token string">'msg_content'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

                itchat.send<span class="token punctuation">(</span>msg<span class="token operator">=</span>file, <span class="token assign-left variable">toUserName</span><span class="token operator">=</span><span class="token string">'filehelper'</span><span class="token punctuation">)</span>

                os.remove<span class="token punctuation">(</span>recall_msg<span class="token punctuation">[</span><span class="token string">'msg_content'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

            msg_info.pop<span class="token punctuation">(</span>recall_msg_id<span class="token punctuation">)</span>

 

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token builtin class-name">:</span>

    <span class="token keyword">if</span> platform.platform<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>:7<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'Windows'</span><span class="token builtin class-name">:</span>

        itchat.auto_login<span class="token punctuation">(</span>enableCmdQR<span class="token operator">=</span>False, <span class="token assign-left variable">hotReload</span><span class="token operator">=</span>True<span class="token punctuation">)</span>

    else:

        itchat.auto_login<span class="token punctuation">(</span>enableCmdQR<span class="token operator">=</span>True, <span class="token assign-left variable">hotReload</span><span class="token operator">=</span>True<span class="token punctuation">)</span>

    itchat.run<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><font face="幼圆" size="4" color="red">感兴趣的小伙伴，赠送全套Python学习资料，包含面试题、简历资料等具体看下方。<br> </font><br> <img src="https://images2.imgbox.com/69/8a/r7ISfbSn_o.png"></p> 
<p><strong>一、Python所有方向的学习路线</strong></p> 
<p>Python所有方向的技术点做的整理，形成各个领域的知识点汇总，它的用处就在于，你可以按照下面的知识点去找对应的学习资源，保证自己学得较为全面。</p> 
<p><img src="https://images2.imgbox.com/21/6f/uHsEIQzD_o.png" alt="img"><br> <img src="https://images2.imgbox.com/aa/c0/VjN4NxqA_o.png" alt="img"></p> 
<p><strong>二、Python必备开发工具</strong></p> 
<p>工具都帮大家整理好了，安装就可直接上手！<img src="https://images2.imgbox.com/af/e0/KHZNCcJZ_o.gif" alt="img"></p> 
<p><strong>三、最新Python学习笔记</strong></p> 
<p>当我学到一定基础，有自己的理解能力的时候，会去阅读一些前辈整理的书籍或者手写的笔记资料，这些笔记详细记载了他们对一些技术点的理解，这些理解是比较独到，可以学到不一样的思路。</p> 
<p><img src="https://images2.imgbox.com/ef/61/C1mRIaTh_o.png" alt="img"></p> 
<p><strong>四、Python视频合集</strong></p> 
<p>观看全面零基础学习视频，看视频学习是最快捷也是最有效果的方式，跟着视频中老师的思路，从基础到深入，还是很容易入门的。</p> 
<p><img src="https://images2.imgbox.com/90/c2/uwlXCLDW_o.png" alt="img"></p> 
<p><strong>五、实战案例</strong></p> 
<p>纸上得来终觉浅，要学会跟着视频一起敲，要动手实操，才能将自己的所学运用到实际当中去，这时候可以搞点实战案例来学习。</p> 
<p><img src="https://images2.imgbox.com/04/82/mW8u1LEq_o.png" alt="img"></p> 
<p><strong>六、面试宝典</strong></p> 
<p><img src="https://images2.imgbox.com/7e/f3/51g7g2mG_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/6a/dc/m6y5qLlQ_o.png" alt="在这里插入图片描述"></p> 
<p><strong>简历模板</strong><img src="https://images2.imgbox.com/4a/2d/eGf8sVLI_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/a3/3c/4gWWtJFf_o.png"><br> 若有侵权，请联系删除</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/10e14b338d14383feb7780c450fd6e4c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">[215]BloomFilter布隆过滤器</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/0c1f6e64a14cc798a7a47ed22524524d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">中心性算法归纳</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>