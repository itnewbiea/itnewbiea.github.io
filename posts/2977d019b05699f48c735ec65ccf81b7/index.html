<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>[MGeo应用]使用Python&#43;AI模型准确拆分Excel中地址的省市区街道 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="[MGeo应用]使用Python&#43;AI模型准确拆分Excel中地址的省市区街道" />
<meta property="og:description" content="作者：Geo地址匠（转载请注明出处）
在处理人员登记信息或者收货地址管理时，常常需要把地址里的省市区镇拆分出来方便后续分类管理。
例如对于地址“上海市静安区乌鲁木齐中路12号”，单独拆分出“上海市/静安区”。
目前一些基于规则的方法无法覆盖到所有情况，比如：
通过“xx省”“xx市”后缀来找省市区的，当缺少该后缀便无法工作。例如：上海静安华山医院，按照后缀是找不到上海和静安的。通过字符长度来切割的，例如设置省的长度为3，当遇到长度不同的省市区名称变会出错。例如：内蒙古自治区，按照长度切割，内蒙古会被识别为省，自治区会被识别为市。 我们开源了一个地址AI预训练底座以及一系列下游应用模型MGeo（ModelScope 魔搭社区），可以用来识别地址里面的省市区。
首先需要安装python3.7的环境，没有anaconda的可以直接下载安装python3.7：
conda create -n py37testmaas python=3.7 conda activate py37testmaas 安装相关依赖：
cpu机器：pip install cryptography==3.4.8 tensorflow==1.15.5 torch==1.11.0 torchvision==0.12.0 torchaudio==0.11.0 openpyxl gpu机器：pip install cryptography==3.4.8 tensorflow-gpu==1.15.5 torch==1.11.0 torchvision==0.12.0 torchaudio==0.11.0 openpyxl 安装modelscope：
pip install &#34;modelscope[nlp]&#34; -f https://modelscope.oss-cn-beijing.aliyuncs.com/releases/repo.html 确认下modelscope版本大于等于1.2.0：
pip freeze | grep modelscope 测试下模型是否可用：
from modelscope.pipelines import pipeline from modelscope.utils.constant import Tasks task = Tasks.token_classification model = &#39;damo/mgeo_geographic_elements_tagging_chinese_base&#39; inputs = &#39;浙江省杭州市余杭区阿里巴巴西溪园区&#39; pipeline_ins = pipeline(task=task, model=model) print(pipeline_ins(input=inputs)) #输出 {&#39;output&#39;: [{&#39;type&#39;: &#39;prov&#39;, &#39;start&#39;: 0, &#39;end&#39;: 3, &#39;span&#39;: &#39;浙江省&#39;}, {&#39;type&#39;: &#39;city&#39;, &#39;start&#39;: 3, &#39;end&#39;: 6, &#39;span&#39;: &#39;杭州市&#39;},{&#39;type&#39;: &#39;district&#39;, &#39;start&#39;: 6, &#39;end&#39;: 9, &#39;span&#39;: &#39;余杭区&#39;}, {&#39;type&#39;: &#39;poi&#39;, &#39;start&#39;: 9, &#39;end&#39;: 17, &#39;span&#39;: &#39;阿里巴巴西溪园区&#39;}]} 可以看到这个模型能将地址里面的省市区街道都拆分出来。剩下的工作便是读取excel内容、识别省市区街道、保存识别结果了。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/2977d019b05699f48c735ec65ccf81b7/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-03T14:21:38+08:00" />
<meta property="article:modified_time" content="2023-02-03T14:21:38+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">[MGeo应用]使用Python&#43;AI模型准确拆分Excel中地址的省市区街道</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p></p> 
<p id="u49c9a1fb">作者：Geo地址匠（转载请注明出处）</p> 
<p id="u3ca6ae62">在处理人员登记信息或者收货地址管理时，常常需要把地址里的省市区镇拆分出来方便后续分类管理。</p> 
<p id="u95f388ba"></p> 
<p id="ub6aa9613">例如对于地址“上海市静安区乌鲁木齐中路12号”，单独拆分出“上海市/静安区”。</p> 
<p id="uf652b9d1"></p> 
<p id="u839d8c3b">目前一些基于规则的方法无法覆盖到所有情况，比如：</p> 
<ul><li id="u44ef74f8">通过“xx省”“xx市”后缀来找省市区的，当缺少该后缀便无法工作。例如：上海静安华山医院，按照后缀是找不到上海和静安的。</li><li id="uafab1889">通过字符长度来切割的，例如设置省的长度为3，当遇到长度不同的省市区名称变会出错。例如：内蒙古自治区，按照长度切割，内蒙古会被识别为省，自治区会被识别为市。</li></ul> 
<p id="ub008a8a8"></p> 
<p id="ua6852f75">我们开源了一个地址AI预训练底座以及一系列下游应用模型MGeo（<a href="https://modelscope.cn/models/damo/mgeo_backbone_chinese_base/summary" rel="nofollow" title="ModelScope 魔搭社区">ModelScope 魔搭社区</a>），可以用来识别地址里面的省市区。</p> 
<p id="u7ae452d4"></p> 
<p id="u4268ec00">首先需要安装python3.7的环境，没有anaconda的可以直接下载安装python3.7：</p> 
<pre><code class="language-python">conda create -n py37testmaas python=3.7

conda activate py37testmaas</code></pre> 
<p id="u37703dcb"></p> 
<p id="u06d57335">安装相关依赖：</p> 
<pre><code class="language-bash">cpu机器：pip install cryptography==3.4.8 tensorflow==1.15.5 torch==1.11.0 torchvision==0.12.0 torchaudio==0.11.0 openpyxl

gpu机器：pip install cryptography==3.4.8 tensorflow-gpu==1.15.5 torch==1.11.0 torchvision==0.12.0 torchaudio==0.11.0 openpyxl</code></pre> 
<p id="u870be0f3"></p> 
<p id="ubbe1e1c1">安装modelscope：</p> 
<pre><code class="language-bash">pip install "modelscope[nlp]" -f https://modelscope.oss-cn-beijing.aliyuncs.com/releases/repo.html</code></pre> 
<p id="u890ba084"></p> 
<p id="u3beb30a5">确认下modelscope版本大于等于1.2.0：</p> 
<pre><code class="language-bash">pip freeze | grep modelscope</code></pre> 
<p id="uf993a19d">测试下模型是否可用：</p> 
<pre><code class="language-python">from modelscope.pipelines import pipeline
from modelscope.utils.constant import Tasks

task = Tasks.token_classification
model = 'damo/mgeo_geographic_elements_tagging_chinese_base'
inputs = '浙江省杭州市余杭区阿里巴巴西溪园区'
pipeline_ins = pipeline(task=task, model=model)
print(pipeline_ins(input=inputs))

#输出 {'output': [{'type': 'prov', 'start': 0, 'end': 3, 'span': '浙江省'}, {'type': 'city', 'start': 3, 'end': 6, 'span': '杭州市'},{'type': 'district', 'start': 6, 'end': 9, 'span': '余杭区'}, {'type': 'poi', 'start': 9, 'end': 17, 'span': '阿里巴巴西溪园区'}]}</code></pre> 
<p id="u25e352fc"></p> 
<p id="u7f83d41b">可以看到这个模型能将地址里面的省市区街道都拆分出来。剩下的工作便是读取excel内容、识别省市区街道、保存识别结果了。</p> 
<p id="u7d92e71a"></p> 
<p id="u4740559b">我们将需要处理的文件保存在test.xlsx里面：</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/90/d0/2IoEB3Yj_o.png"></p> 
<p id="ue55922f9"></p> 
<p id="ub52a87b8">创建并保存自动处理脚本process.py：</p> 
<pre><code class="language-python">from modelscope.pipelines import pipeline

from modelscope.utils.constant import Tasks

import pandas as pd



def get_pcdt(inputs):

task = Tasks.token_classification

model = 'damo/mgeo_geographic_elements_tagging_chinese_base'

pipeline_ins = pipeline(task=task, model=model)

res = pipeline_ins(input=inputs)

pcdt = {'prov': '', 'city': '', 'district': '', 'town': ''}

for r in res['output']:

if r['type'] in pcdt:

pcdt[r['type']] = r['span']

return pcdt



df = pd.read_excel('test.xlsx')

total_pcdt = {'prov': [], 'city': [], 'district': [], 'town': []}

for line in df['address']:

res = get_pcdt(line)

for k in res:

total_pcdt[k].append(res[k])

for k in total_pcdt:

df[k] = total_pcdt[k]

df.to_excel('test_out.xlsx', index=False, header=True)</code></pre> 
<p id="u1c6d3336"></p> 
<p id="u2793f3ea">运行process.py：</p> 
<pre><code class="language-bash">python process.py</code></pre> 
<p id="uc7b55ee6"></p> 
<p id="u9c7946af">程序自动运行结束后我们从test_out.xlsx可以得到省市区街道的抽取结果：</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/1a/7f/vDh46rpb_o.png"></p> 
<p id="ue2a504ec"></p> 
<p id="u5158c792">使用测试数据与源代码可以访问<a href="https://github.com/PhantomGrapes/MGeoExample/tree/main/%E6%8B%86%E5%88%86Excel%E4%B8%AD%E5%9C%B0%E5%9D%80%E7%9A%84%E7%9C%81%E5%B8%82%E5%8C%BA%E8%A1%97%E9%81%93" title="MGeoExample/拆分Excel中地址的省市区街道 at main · PhantomGrapes/MGeoExample · GitHub">MGeoExample/拆分Excel中地址的省市区街道 at main · PhantomGrapes/MGeoExample · GitHub</a></p> 
<p>更多地址信息处理AI模型可以在 <a href="https://modelscope.cn/models/damo/mgeo_backbone_chinese_base/summary" rel="nofollow" title="ModelScope 魔搭社区">ModelScope 魔搭社区</a>找到。</p> 
<p></p> 
<p id="u710ee6d5">作者：Geo地址匠（转载请注明出处）</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/180aa888046478b92b7d6584ff719b89/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">audio或video标签 autoplay无效 或 .play()报错问题 解决方案</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b9510c27ca451750a4959e483879ecb3/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Vue3自定义指令实现拖拽</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>