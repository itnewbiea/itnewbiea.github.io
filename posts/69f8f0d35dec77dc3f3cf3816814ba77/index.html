<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>K8S应用流程安全（镜像安全 配置管理 访问安全） - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="K8S应用流程安全（镜像安全 配置管理 访问安全）" />
<meta property="og:description" content="应用流程安全 1 应用流程安全1.1 镜像安全1.1.1 构建原则1.1.2 Dockerfile实践1.1.3 构建进阶1.1.4 镜像检测1.1.5 仓库升级1.1.6 高可用仓库1.1.7 镜像策略 1.2 配置管理1.2.1 配置基础1.2.2 YAML安全1.2.3 kustomize1.2.4 基础实践1.2.5 功能复用1.2.6 配置定制1.2.7 补丁实践 1.3 访问安全1.3.1 安全检测1.3.3 简单实践1.3.3 虚拟主机1.3.4 四层实践1.3.5 策略实践 1 应用流程安全 1.1 镜像安全 1.1.1 构建原则 学习目标
这一节，我们从 基础知识、原则解读、小结 三个方面来学习。
基础知识
k8s平台使用业务环境
生产中使用k8s操作业务环境的基本原则 1 保证容器应用是正常运行的 2 创建专属的资源对象文件 3 基于资源对象文件创建业务环境 4 测试业务环境，如果不满足则进行后续动作，否则不做任何改变 - 调整容器的镜像文件 - 重新调整资源对象文件 - 基于新资源对象文件创建并测试新的环境	需求
镜像是容器运行的基础，容器引擎服务可使用不同的镜像启动相应的容器。在容器出现错误后，能迅速通过 删除容器、启动新的容器来恢复服务，这都需要以容器镜像作为支撑技术。 而Kubernetes作为一种容器任务编排平台，它对于应用的管理都是基于镜像文件创建出来的。 镜像的使用流程
Docker镜像加载
对于Docker镜像文件整体来说，它是一个只读的文件，但是根据我们对构建过程的理解，我们发现，对于Docker镜像还有很多更深层的东西： 1 镜像文件是基于分层机制实现的 - Docker 镜像的最底层是 bootfs(boot file system), bootfs主要包含 bootloader 和 Kernel ， bootloader加载kernel信息到内存中，然后内存使用权交给内核，接着内核卸载bootfs。 - 在 bootfs之上是rootfs(root file system)，它包含了不同Linux发行版(Ubuntu|Centos)文件系统中的标准目录和文件，比如/dev,/proc,/bin,/etc等。它由内核挂载为只读模式，而后通过&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/69f8f0d35dec77dc3f3cf3816814ba77/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-10T21:10:22+08:00" />
<meta property="article:modified_time" content="2023-07-10T21:10:22+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">K8S应用流程安全（镜像安全 配置管理 访问安全）</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>应用流程安全</h4> 
 <ul><li><a href="#1__2" rel="nofollow">1 应用流程安全</a></li><li><ul><li><a href="#11__4" rel="nofollow">1.1 镜像安全</a></li><li><ul><li><a href="#111__6" rel="nofollow">1.1.1 构建原则</a></li><li><a href="#112_Dockerfile_114" rel="nofollow">1.1.2 Dockerfile实践</a></li><li><a href="#113__220" rel="nofollow">1.1.3 构建进阶</a></li><li><a href="#114__382" rel="nofollow">1.1.4 镜像检测</a></li><li><a href="#115__529" rel="nofollow">1.1.5 仓库升级</a></li><li><a href="#116__710" rel="nofollow">1.1.6 高可用仓库</a></li><li><a href="#117__874" rel="nofollow">1.1.7 镜像策略</a></li></ul> 
   </li><li><a href="#12__1310" rel="nofollow">1.2 配置管理</a></li><li><ul><li><a href="#121__1312" rel="nofollow">1.2.1 配置基础</a></li><li><a href="#122_YAML_1390" rel="nofollow">1.2.2 YAML安全</a></li><li><a href="#123_kustomize_1541" rel="nofollow">1.2.3 kustomize</a></li><li><a href="#124__1731" rel="nofollow">1.2.4 基础实践</a></li><li><a href="#125__1926" rel="nofollow">1.2.5 功能复用</a></li><li><a href="#126__2032" rel="nofollow">1.2.6 配置定制</a></li><li><a href="#127__2157" rel="nofollow">1.2.7 补丁实践</a></li></ul> 
   </li><li><a href="#13__2413" rel="nofollow">1.3 访问安全</a></li><li><ul><li><a href="#131__2415" rel="nofollow">1.3.1 安全检测</a></li><li><a href="#133__2607" rel="nofollow">1.3.3 简单实践</a></li><li><a href="#133__2925" rel="nofollow">1.3.3 虚拟主机</a></li><li><a href="#134__3273" rel="nofollow">1.3.4 四层实践</a></li><li><a href="#135__3440" rel="nofollow">1.3.5 策略实践</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="1__2"></a>1 应用流程安全</h2> 
<h3><a id="11__4"></a>1.1 镜像安全</h3> 
<h4><a id="111__6"></a>1.1.1 构建原则</h4> 
<p>学习目标</p> 
<p>这一节，我们从 基础知识、原则解读、小结 三个方面来学习。</p> 
<p><strong>基础知识</strong></p> 
<p>k8s平台使用业务环境</p> 
<pre><code class="prism language-powershell">生产中使用k8s操作业务环境的基本原则
	1 保证容器应用是正常运行的
	2 创建专属的资源对象文件
	3 基于资源对象文件创建业务环境
	4 测试业务环境，如果不满足则进行后续动作，否则不做任何改变
		<span class="token operator">-</span> 调整容器的镜像文件
		<span class="token operator">-</span> 重新调整资源对象文件
		<span class="token operator">-</span> 基于新资源对象文件创建并测试新的环境	
</code></pre> 
<p>需求</p> 
<pre><code class="prism language-powershell">	镜像是容器运行的基础，容器引擎服务可使用不同的镜像启动相应的容器。在容器出现错误后，能迅速通过 删除容器、启动新的容器来恢复服务，这都需要以容器镜像作为支撑技术。
	而Kubernetes作为一种容器任务编排平台，它对于应用的管理都是基于镜像文件创建出来的。
</code></pre> 
<p>镜像的使用流程</p> 
<p><img src="https://images2.imgbox.com/63/dc/CdNg0w8J_o.png" alt="在这里插入图片描述"></p> 
<p>Docker镜像加载</p> 
<pre><code class="prism language-powershell">	对于Docker镜像文件整体来说，它是一个只读的文件，但是根据我们对构建过程的理解，我们发现，对于Docker镜像还有很多更深层的东西：
1 镜像文件是基于分层机制实现的
	<span class="token operator">-</span> Docker 镜像的最底层是 bootfs<span class="token punctuation">(</span>boot file system<span class="token punctuation">)</span><span class="token punctuation">,</span> bootfs主要包含 bootloader 和 Kernel ， bootloader加载kernel信息到内存中，然后内存使用权交给内核，接着内核卸载bootfs。
	<span class="token operator">-</span> 在 bootfs之上是rootfs<span class="token punctuation">(</span>root file system<span class="token punctuation">)</span>，它包含了不同Linux发行版<span class="token punctuation">(</span>Ubuntu<span class="token punctuation">|</span>Centos<span class="token punctuation">)</span>文件系统中的标准目录和文件，比如<span class="token operator">/</span>dev<span class="token punctuation">,</span><span class="token operator">/</span>proc<span class="token punctuation">,</span><span class="token operator">/</span>bin<span class="token punctuation">,</span><span class="token operator">/</span>etc等。它由内核挂载为只读模式，而后通过<span class="token string">"联合挂载"</span>在其基础上挂载一个<span class="token string">"可写层"</span>。
2 下层镜像是上层镜像的父镜像，最底层的称为基础镜像
	<span class="token operator">-</span> 最上层的是可写的，其他各层都是只读的。
</code></pre> 
<pre><code class="prism language-powershell">	总的来说，镜像文件包含运行某个应用软件所需的所有内容，包括代码、运行时、库、环境变量和配置文件。
</code></pre> 
<p>UnionFS</p> 
<pre><code class="prism language-powershell">	UnionFS<span class="token punctuation">(</span>联合文件系统<span class="token punctuation">)</span>：Union文件系统是一种分层、轻量级并且高性能的文件系统，它支持对文件系统的修改作为一次提交来一层层的叠加，同时可以将存在不同物理位置的不同目录挂载到同一个虚拟文件系统下，从外面看起来，只能看到一个包含所有底层的文件和目录的文件系统。UnionFS可以把只读和可读写文件系统合并在一起，具有写时复制功能，允许只读文件系统的修改可以保存到可写文件系统当中。
</code></pre> 
<pre><code class="prism language-powershell">	Union文件系统是 Docker 镜像的基础。镜像可以通过分层来进行继承，基于基础镜像（没有父镜像），可以制作各种具体的应用镜像。
	Docker镜像使用分层最大的好处就是 共享资源。许多镜像基于相同的base镜像构建而来，宿主机只需在磁盘上保存一份base镜像，同时内存中也只需加载一份base镜像，就可以为所有容器服务了，而且镜像的每一层都可以被共享。
</code></pre> 
<p><strong>原则解读</strong></p> 
<p>构建样式</p> 
<p><img src="https://images2.imgbox.com/8e/47/exV9llaE_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-powershell">	我们将中间只读的 rootfs 的集合称为 Docker 镜像，Docker 镜像构建时，会一层层构建，前一层是后一层的基础。每一层构建完就不会再发生改变，后一层上的任何改变只发生在自己这一层。UnionFS 使得镜像的复用、定制变得更为容易。甚至可以用之前构建好的镜像作为基础层，然后进一步添加新的层，以定制自己所需的内容，构建新的镜像。
	当用docker run启动这个容器时，实际上在镜像的顶部添加了一个新的可写层。这个可写层也叫容器层。容器启动后，其内的应用所有对容器的改动，文件的增删改操作都只会发生在容器层中，根据容器镜像的写时拷贝<span class="token punctuation">(</span><span class="token function">Copy-on</span><span class="token operator">-</span><span class="token function">Write</span><span class="token punctuation">)</span>技术，某个容器对基础镜像的修改会被限制在单个容器内<span class="token punctuation">,</span>对容器层下面的所有只读镜像层没有影响。
</code></pre> 
<p>构建原则</p> 
<pre><code class="prism language-powershell">1、镜像最小化原则；需要选择最精简的基础镜像、清理镜像构建的中间产物、减少镜像的层数。
2、构建速度最快化原则；充分利用镜像构建缓存，再利用构建的缓存来加快镜像构建速度。
3、注意优化网络请求。
</code></pre> 
<p>实践原则</p> 
<pre><code class="prism language-powershell">镜像构建实践的最佳实践原则
	1 按照项目功能定制镜像构建目录结构
	2 按照角色定制不同镜像
	3 基于嵌套方式分层构建镜像
</code></pre> 
<p>分层效果</p> 
<p><img src="https://images2.imgbox.com/ca/4c/N8RXLexZ_o.png" alt="在这里插入图片描述"></p> 
<p>功能效果</p> 
<p><img src="https://images2.imgbox.com/5e/fe/QH8odeeu_o.png" alt="在这里插入图片描述"></p> 
<p><strong>小结</strong></p> 
<pre><code>
</code></pre> 
<h4><a id="112_Dockerfile_114"></a>1.1.2 Dockerfile实践</h4> 
<p>学习目标</p> 
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p> 
<p><strong>基础知识</strong></p> 
<p>镜像构建过程</p> 
<pre><code class="prism language-powershell">1）从基础镜像1创建一个容器A
2）遇到一条Dockerfile指令，都对容器A做一次修改操作
3）执行完一条指令，提交生成一个新镜像2
4）再基于新的镜像2运行一个容器B
5）遇到一条Dockerfile指令，都对容器B做一次修改操作
6）执行完一条指令，提交生成一个新镜像3
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<p>Dockerfile</p> 
<pre><code class="prism language-powershell">	在工作中，我们经常会因为业务需求，而定制各种各样的Doker镜像，由于Dockerfile的便捷性，所以我们经常会基于Dockerfile来创建我们业务场景中所需要的各种镜像。

根据我自己的工作经验，我们在使用Dockerfile的过程中，一般只需要关注三个方面即可：
	1 Dockerfile在使用的过程中，构建的指令越少越好，能合并的就合并。
	2 基于Docker镜像的分层特性，我们最好按照项目的架构级别来定制不同层的镜像
	3 Dockerfile构建的过程中，功能越简单越好，最好只有一个
</code></pre> 
<p><strong>简单实践</strong></p> 
<p>准备工作</p> 
<pre><code class="prism language-powershell">创建Dockerfile专用目录
mkdir <span class="token operator">/</span>docker/images/ssh <span class="token operator">-</span>p
cd <span class="token operator">/</span>docker/images/ssh

创建秘钥认证
ssh-keygen <span class="token operator">-</span>t rsa
<span class="token function">cat</span> ~<span class="token operator">/</span><span class="token punctuation">.</span>ssh/id_rsa<span class="token punctuation">.</span>pub &gt; authorized_keys
</code></pre> 
<p>最初的Dockerfile</p> 
<pre><code class="prism language-powershell"><span class="token comment"># 构建一个基于ubuntu的ssh定制镜像</span>
<span class="token comment"># 基础镜像</span>
<span class="token keyword">FROM</span> ubuntu
<span class="token comment"># 镜像作者</span>
MAINTAINER shuji@superopsmsb<span class="token punctuation">.</span>com

<span class="token comment"># 安装 ssh 服务</span>
RUN apt-get update 
RUN apt-get install <span class="token operator">-</span>y openssh-server curl vim net-tools git dnsutils jq
RUN mkdir <span class="token operator">-</span>p <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>run/sshd 
RUN mkdir <span class="token operator">-</span>p <span class="token operator">/</span>root/<span class="token punctuation">.</span>ssh 
RUN sed <span class="token operator">-</span>i <span class="token string">"s/.*pam_loginuid.so/#&amp;/"</span> <span class="token operator">/</span>etc/pam<span class="token punctuation">.</span>d/sshd 
RUN apt-get autoclean 
RUN apt-get clean 
RUN apt-get autoremove
<span class="token comment"># 复制配置文件到相应位置,并赋予脚本可执行权限</span>
ADD authorized_keys <span class="token operator">/</span>root/<span class="token punctuation">.</span>ssh/authorized_keys

<span class="token comment"># 对外端口</span>
EXPOSE 22

<span class="token comment"># 启动ssh</span>
CMD <span class="token punctuation">[</span><span class="token string">"/usr/sbin/sshd"</span><span class="token punctuation">,</span><span class="token string">"-D"</span><span class="token punctuation">]</span>
</code></pre> 
<p>优化后Dockerfile</p> 
<pre><code class="prism language-powershell"><span class="token comment"># 构建一个基于ubuntu的ssh定制镜像</span>
<span class="token comment"># 基础镜像</span>
<span class="token keyword">FROM</span> ubuntu
<span class="token comment"># 镜像作者</span>
MAINTAINER shuji@superopsmsb<span class="token punctuation">.</span>com

<span class="token comment"># 安装 ssh 服务</span>
RUN apt-get update &amp;&amp; apt-get install <span class="token operator">-</span>y openssh-server curl vim net-tools git dnsutils jq &amp;&amp; mkdir <span class="token operator">-</span>p <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>run/sshd &amp;&amp; mkdir <span class="token operator">-</span>p <span class="token operator">/</span>root/<span class="token punctuation">.</span>ssh &amp;&amp; sed <span class="token operator">-</span>i <span class="token string">"s/.*pam_loginuid.so/#&amp;/"</span> <span class="token operator">/</span>etc/pam<span class="token punctuation">.</span>d/sshd &amp;&amp; apt-get autoclean &amp;&amp; apt-get clean &amp;&amp; apt-get autoremove
<span class="token comment"># 复制配置文件到相应位置,并赋予脚本可执行权限</span>
ADD authorized_keys <span class="token operator">/</span>root/<span class="token punctuation">.</span>ssh/authorized_keys

<span class="token comment"># 对外端口</span>
EXPOSE 22

<span class="token comment"># 启动ssh</span>
CMD <span class="token punctuation">[</span><span class="token string">"/usr/sbin/sshd"</span><span class="token punctuation">,</span><span class="token string">"-D"</span><span class="token punctuation">]</span>
</code></pre> 
<p><strong>小结</strong></p> 
<pre><code>
</code></pre> 
<h4><a id="113__220"></a>1.1.3 构建进阶</h4> 
<p>学习目标</p> 
<p>这一节，我们从 多阶段构建、触发器、小结 三个方面来学习。</p> 
<p><strong>多阶段构建</strong></p> 
<p>需求</p> 
<pre><code class="prism language-powershell">	对于一些大型微服务项目的研发来说，研发阶段会是多个团队来进行项目的研发，如果每个研发人员都是基于使用Docker容器来做项目的部署，这个时候后，因为几个项目组件可能包含公用文件<span class="token punctuation">,</span>从而导致大量的Docker镜像使用的重复冗余资源<span class="token punctuation">,</span>所以我们有必要为团队的提供一个更加丰富的Base镜像，以满足所有研发人员的需求的前提下，极大的节省资源的消耗。
</code></pre> 
<p>多阶段构建</p> 
<pre><code class="prism language-powershell">	旧版本的Docker软件仅仅支持1个<span class="token keyword">FROM</span>，从1<span class="token punctuation">.</span>17版本之后开始支持多阶段构建的能力 <span class="token operator">--</span> 也就是说多个<span class="token keyword">FROM</span>指令，也就是说我们可以使用多个base image和中间层image来构建镜像层。这里主要用到的指令是 <span class="token keyword">FROM</span> 和 AS。也就是说，它可以让我在前一个image层上创建多个image层，
	示例：
		<span class="token keyword">FROM</span> image as layer_name
</code></pre> 
<pre><code class="prism language-powershell">	同时Dockerfile在构建的时候，可以借助于<span class="token function">COPY</span> 指令的 <span class="token operator">--</span><span class="token keyword">from</span> 参数，docker镜像中直接获取相关文件：
		<span class="token function">COPY</span> <span class="token operator">--</span><span class="token keyword">from</span>=0 <span class="token operator">/</span>require/file <span class="token operator">/</span>dest/ 
			从前一个镜像层中获取文件到当前镜像层面指定位置
		<span class="token function">COPY</span> <span class="token operator">--</span><span class="token keyword">from</span>=layer_name <span class="token operator">/</span>require/file <span class="token operator">/</span>dest/
			从前指定镜像层中获取文件到当前镜像层面指定位置
		<span class="token function">COPY</span> <span class="token operator">--</span><span class="token keyword">from</span>=docker<span class="token punctuation">.</span>io/nginx <span class="token operator">/</span>require/file <span class="token operator">/</span>dest/
			从前现有的镜像中获取文件到当前镜像层面指定位置
</code></pre> 
<p>构建实践</p> 
<pre><code class="prism language-powershell"><span class="token comment"># 基于基础镜像构建普通功能软件，将其作为ubuntu环境使用</span>
<span class="token keyword">FROM</span> python:3 AS base
MAINTAINER shuji@superopsmsb<span class="token punctuation">.</span>com
RUN apt-get update &amp;&amp; apt-get install <span class="token operator">-</span>y vim 

<span class="token comment"># 创建一个专属的镜像层来安装Python依赖软件</span>
<span class="token keyword">FROM</span> base AS requirements
RUN pip3 install django==3<span class="token punctuation">.</span>1<span class="token punctuation">.</span>2

<span class="token comment"># 使用Python镜像层创建专属的项目环境</span>
<span class="token keyword">FROM</span> requirements as django
ADD blog <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>code/blog
ADD scripts/startup<span class="token punctuation">.</span>sh <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>scripts/startup<span class="token punctuation">.</span>sh
EXPOSE 8000

<span class="token comment"># 定制容器的启动命令</span>
CMD <span class="token punctuation">[</span><span class="token string">"/bin/bash"</span><span class="token punctuation">,</span> <span class="token string">"/data/scripts/startup.sh"</span><span class="token punctuation">]</span>
</code></pre> 
<pre><code class="prism language-powershell">构建镜像
docker build <span class="token operator">-</span>t simple-test <span class="token punctuation">.</span>

测试效果
docker run <span class="token operator">-</span>d <span class="token operator">--</span>name django-test <span class="token operator">-</span>p 666:8000 simple-test
curl localhost:666
docker <span class="token function">rm</span> <span class="token operator">-</span>f django-test 
</code></pre> 
<pre><code class="prism language-powershell">结果显示：
	我们使用<span class="token keyword">FROM</span>和AS指令组合帮助我们为所有项目创建唯一的层次结构。从而让我们一次完成所有任务docker文件，这样不仅简化了版本管理<span class="token punctuation">,</span> 还可以更好地了解整个项目<span class="token punctuation">,</span> 尤其是通过消除在不同镜像中的相同文件，并实现了最终镜像文件容量缩容。
</code></pre> 
<p><strong>触发器</strong></p> 
<p>需求</p> 
<pre><code class="prism language-powershell">	工作中我们在做大量Docker镜像的时候，因为分层的优势，我们一般先把基础镜像做出来，然后在它的基础上进行上层镜像的构建。结合我们刚才的实践，如果将多个团队需求的文件都进行初始化构建的话，导致基础镜像容量太大，而且很多功能对于上层镜像无用。
	所以我们就可以借助于触发器的能力，提前将上层镜像需要的环境定制出来，但是不执行，只有当上层镜像需要的时候，我们再进行针对性环境的构建，这样可以让我们的容量更加高效。
</code></pre> 
<p>指令</p> 
<pre><code class="prism language-powershell">	Dockerfile 用于 build 镜像文件，A镜像和B镜像分别需要不同的Dockerfile文件来进行构建，如果B镜像依赖于A镜像，我们可以借助于ONBUILD指令，在构建B镜像的时候，自动触发A镜像内部的构建步骤，当A镜像构建完毕后，再开始B镜像构建。
</code></pre> 
<p>构建实践</p> 
<pre><code class="prism language-powershell">定制两个目录
mkdir father child
</code></pre> 
<pre><code class="prism language-powershell">定制father项目的Dockerfile文件
<span class="token keyword">FROM</span> python:3
MAINTAINER father-image
RUN <span class="token function">echo</span> <span class="token string">"father image"</span>
ONBUILD RUN <span class="token function">echo</span> <span class="token string">"child image"</span>
</code></pre> 
<pre><code class="prism language-powershell">定制child项目的Dockerfile文件
<span class="token keyword">FROM</span> father-image
MAINTAINER child-image
RUN <span class="token function">echo</span> <span class="token string">"this is my cmd"</span>
</code></pre> 
<pre><code class="prism language-powershell">构建父级镜像
<span class="token comment"># docker build -t father-image father/</span>
Sending build context to Docker daemon  2<span class="token punctuation">.</span>048kB
Step 1/4 : <span class="token keyword">FROM</span> python:3
 <span class="token operator">--</span><span class="token operator">-</span>&gt; f05c8762fe15
Step 2/4 : MAINTAINER father-image
 <span class="token operator">--</span><span class="token operator">-</span>&gt; Running in 90bb60b129c3
Removing intermediate container 90bb60b129c3
 <span class="token operator">--</span><span class="token operator">-</span>&gt; 39be4d0f1254
Step 3/4 : RUN <span class="token function">echo</span> <span class="token string">"father image"</span>
 <span class="token operator">--</span><span class="token operator">-</span>&gt; Running in 1ec695c98bfb
father image
Removing intermediate container 1ec695c98bfb
 <span class="token operator">--</span><span class="token operator">-</span>&gt; dcde17f6a0dc
Step 4/4 : ONBUILD RUN <span class="token function">echo</span> <span class="token string">"child image"</span>
 <span class="token operator">--</span><span class="token operator">-</span>&gt; Running in c41f441091a7
Removing intermediate container c41f441091a7		<span class="token comment"># 结果显示：命令没有执行</span>
 <span class="token operator">--</span><span class="token operator">-</span>&gt; 5dcb262c76e6
Successfully built 5dcb262c76e6
Successfully tagged father-image:latest
</code></pre> 
<pre><code class="prism language-powershell">构建子镜像
<span class="token comment"># docker build -t child-image child/</span>
Sending build context to Docker daemon  2<span class="token punctuation">.</span>048kB
Step 1/3 : <span class="token keyword">FROM</span> father-image
<span class="token comment"># Executing 1 build trigger				</span>
 <span class="token operator">--</span><span class="token operator">-</span>&gt; Running in 3e26148923b1
child image								<span class="token comment"># 结果显示：子镜像构建的时候，自动执行父镜像的</span>
Removing intermediate container 3e26148923b1
 <span class="token operator">--</span><span class="token operator">-</span>&gt; ccbcc3569240
Step 2/3 : MAINTAINER child-image
 <span class="token operator">--</span><span class="token operator">-</span>&gt; Running in a622eba55824
Removing intermediate container a622eba55824
 <span class="token operator">--</span><span class="token operator">-</span>&gt; bbaee5a9ea61
Step 3/3 : RUN <span class="token function">echo</span> <span class="token string">"this is my cmd"</span>
 <span class="token operator">--</span><span class="token operator">-</span>&gt; Running in ee716a0392aa
this is my cmd
Removing intermediate container ee716a0392aa
 <span class="token operator">--</span><span class="token operator">-</span>&gt; 229bcbf7c314
Successfully built 229bcbf7c314
Successfully tagged child-image:latest
</code></pre> 
<p><strong>小结</strong></p> 
<pre><code>
</code></pre> 
<h4><a id="114__382"></a>1.1.4 镜像检测</h4> 
<p>学习目标</p> 
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p> 
<p><strong>基础知识</strong></p> 
<p>需求</p> 
<pre><code class="prism language-powershell">	在基于kubernetes平台上的云原生应用，基本上都是基于Docker镜像的方式来运行起来的，如果镜像的来源就是有问题的，那么我们建立该环境上的应用就会存在所谓0day的现象。虽然可以通过Dockerfile的方式来控制镜像的构建过程，但是这只是我们能够控制的一部分，还有大量第三方应用的镜像我们无法进行强有力的安全控制，如果第三方的平台镜像存在安全漏洞，我们是无法处理的。
</code></pre> 
<pre><code class="prism language-powershell">	在互联网中有很多组织和社区，为了实现某些场景的镜像安全，自发或者其他因素影响下，开始从事镜像安全漏洞的工作，他们研发了一系列镜像级别的安全检测工具，可以帮助我们进行镜像安全的控制，Trivy就是其中的佼佼者。
</code></pre> 
<pre><code class="prism language-powershell">	根据2022年&lt;&lt;sysdig云原生和使用报告&gt;&gt;的统计数据显示：在生产环境中运行的 85% 的镜像至少包含一个可修补漏洞。此外，75% 的镜像包含“高危”或“严重”的可修补漏洞。使用公共仓库可能会带来风险，因为它们很少会被验证或检查漏洞。但是在某些情况下，使用公共库的便利性大于风险，所以很多企业宁可面对风险也要用公共镜像仓库，并且将其作为最佳实践。
</code></pre> 
<p>trivy</p> 
<pre><code class="prism language-powershell">	Trivy是一个简单而全面的漏洞<span class="token operator">/</span>错误配置扫描器，常被应用于容器级别的业务安全场景。它主要的工作对象是 容器镜像、文件系统、Git存储库等。
	Trivy提供了大量用于检测操作系统和程序语言的检测工具包。它无论是部署还是使用都是非常简单的。尤其是它对于其他平台环境的集成非常轻松，常常应用在以DevSecOps为代表的CI环境中。
</code></pre> 
<pre><code class="prism language-powershell">官方网站：https:<span class="token operator">/</span><span class="token operator">/</span>trivy<span class="token punctuation">.</span>dev/
github: https:<span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com/aquasecurity/trivy
最新版本: 0<span class="token punctuation">.</span>32<span class="token punctuation">.</span>1
</code></pre> 
<p>软件部署</p> 
<pre><code class="prism language-powershell">Centos定制软件源
<span class="token comment"># vim /etc/yum.repos.d/trivy.repo </span>
<span class="token namespace">[trivy]</span>
name=Trivy repository
baseurl=https:<span class="token operator">/</span><span class="token operator">/</span>aquasecurity<span class="token punctuation">.</span>github<span class="token punctuation">.</span>io/trivy-repo/rpm/releases/<span class="token variable">$releasever</span><span class="token operator">/</span><span class="token variable">$basearch</span><span class="token operator">/</span>
gpgcheck=0
enabled=1

安装软件
yum makecache fast
yum <span class="token operator">-</span>y install trivy
</code></pre> 
<pre><code class="prism language-powershell">Ubuntu定制软件源
apt-get install wget apt-transport-https gnupg lsb-release
wget <span class="token operator">-</span>qO <span class="token operator">-</span> https:<span class="token operator">/</span><span class="token operator">/</span>aquasecurity<span class="token punctuation">.</span>github<span class="token punctuation">.</span>io/trivy-repo/deb/public<span class="token punctuation">.</span>key <span class="token punctuation">|</span> sudo apt-key add <span class="token operator">-</span>
<span class="token function">echo</span> deb https:<span class="token operator">/</span><span class="token operator">/</span>aquasecurity<span class="token punctuation">.</span>github<span class="token punctuation">.</span>io/trivy-repo/deb $<span class="token punctuation">(</span>lsb_release <span class="token operator">-</span><span class="token function">sc</span><span class="token punctuation">)</span> main <span class="token punctuation">|</span> sudo <span class="token function">tee</span> <span class="token operator">-</span>a <span class="token operator">/</span>etc/apt/sources<span class="token punctuation">.</span>list<span class="token punctuation">.</span>d/trivy<span class="token punctuation">.</span>list

安装软件
apt-get update
apt-get <span class="token operator">-</span>y install trivy
</code></pre> 
<p><strong>简单实践</strong></p> 
<p>命令解析</p> 
<pre><code class="prism language-powershell">镜像扫描
	trivy image <span class="token namespace">[YOUR_IMAGE_NAME]</span>
漏洞检测
	trivy image <span class="token operator">--</span>severity HIGH<span class="token punctuation">,</span>CRITICAL <span class="token namespace">[YOUR_IMAGE_NAME]</span>
信息输出
	trivy image <span class="token operator">-</span>f json <span class="token operator">-</span>o results<span class="token punctuation">.</span>json <span class="token namespace">[YOUR_IMAGE_NAME]</span>
仓库检测
	trivy repo https:<span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com/knqyf263/trivy-ci-test
容器内检测
	curl <span class="token operator">-</span>sfL https:<span class="token operator">/</span><span class="token operator">/</span>raw<span class="token punctuation">.</span>githubusercontent<span class="token punctuation">.</span>com/aquasecurity/trivy/main/contrib/install<span class="token punctuation">.</span>sh <span class="token punctuation">|</span> sh <span class="token operator">-</span>s <span class="token operator">--</span> <span class="token operator">-</span>b <span class="token operator">/</span>usr/local/bin
	trivy fs <span class="token operator">/</span>
</code></pre> 
<p>简单实践</p> 
<pre><code class="prism language-powershell">下载漏洞数据库
trivy image <span class="token operator">--</span>download-db-only

清理检测缓存
trivy image <span class="token operator">--</span><span class="token function">clear-cache</span>

清理所有检测数据库
trivy image <span class="token operator">--</span>reset
</code></pre> 
<pre><code class="prism language-powershell">镜像检测
	trivy image nginx:latest
注意
	在title部分有该漏洞的一些信息https:<span class="token operator">/</span><span class="token operator">/</span>avd<span class="token punctuation">.</span>aquasec<span class="token punctuation">.</span>com/nvd/2011/cve-2011-3374/
	CVSS:Common Vulnerability Scoring System，即通用漏洞评分系统，是一个行业公开标准，其被设计用来评测漏洞的严重程度，并帮助确定所需反应的紧急度和重要度。
</code></pre> 
<p><img src="https://images2.imgbox.com/3a/25/BrQZAhYF_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-powershell">指定检测级别测试
trivy image <span class="token operator">--</span>severity HIGH<span class="token punctuation">,</span>CRITICAL nginx:latest
</code></pre> 
<pre><code class="prism language-powershell">文件系统扫描
trivy fs <span class="token operator">/</span>tmp/
</code></pre> 
<pre><code class="prism language-powershell">仓库扫描
trivy repo https:<span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com/kubernetes/kubernetes<span class="token punctuation">.</span>git
</code></pre> 
<pre><code class="prism language-powershell">信息输出
trivy image <span class="token operator">-</span>f json <span class="token operator">-</span>o results<span class="token punctuation">.</span>json nginx:latest
</code></pre> 
<p>harbor实践</p> 
<pre><code class="prism language-powershell">我们可以在harbor部署的时候，指定一个参数来启用trivy能力。
	<span class="token punctuation">.</span><span class="token operator">/</span>install<span class="token punctuation">.</span>sh <span class="token operator">--</span>with-trivy
这样的话，我们的镜像后面就会多出检测的能力条，只需要我们配置检测的规则，它就会自动检测
</code></pre> 
<p><img src="https://images2.imgbox.com/36/54/PJJLgdXE_o.png" alt="在这里插入图片描述"></p> 
<p><strong>小结</strong></p> 
<pre><code>
</code></pre> 
<h4><a id="115__529"></a>1.1.5 仓库升级</h4> 
<p>学习目标</p> 
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p> 
<p><strong>基础知识</strong></p> 
<p>需求</p> 
<pre><code class="prism language-powershell">	对于docker镜像仓库来说，默认使用的级别是https的，如果是非https的话，需要将其设置到一个非安全的仓库范围中，无论是对于containerd还是docker来说，这都不是一个很好的现象。
	harbor本身是支持https能力的，我们只需要按部就班的实施就可以了。
</code></pre> 
<p>修改harbor配置</p> 
<pre><code class="prism language-powershell">修改配置 <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>server/harbor/harbor<span class="token punctuation">.</span>yml
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
hostname: kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com
http:
  port: 80

https:  注释ssl相关的部分
  port: 443
  certificate: <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>server/harbor/certs/kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com<span class="token punctuation">.</span>crt
  private_key: <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>server/harbor/certs/kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com<span class="token punctuation">.</span>key

harbor_admin_password: 123456
data_volume: <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>harbor/<span class="token keyword">data</span>
</code></pre> 
<p>准备证书信息</p> 
<pre><code class="prism language-powershell">生成CA证书私钥
mkdir <span class="token operator">-</span>p <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>server/harbor/ssl
cd <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>server/harbor/ssl
openssl genrsa <span class="token operator">-</span>out ca<span class="token punctuation">.</span>key 4096
</code></pre> 
<pre><code class="prism language-powershell">生成CA证书
openssl req <span class="token operator">-</span>x509 <span class="token operator">-</span>new <span class="token operator">-</span>nodes <span class="token operator">-</span>sha512 <span class="token operator">-</span>days 3650 \
 <span class="token operator">-</span>subj <span class="token string">"/C=CN/ST=Beijing/L=Beijing/O=example/OU=Personal/CN=kubernetes-register.superopsmsb.com"</span> \
 <span class="token operator">-</span>key ca<span class="token punctuation">.</span>key \
 <span class="token operator">-</span>out ca<span class="token punctuation">.</span>crt
注意：如果使用IP地址，需要在执行以上命令前执行以下操作：
    cd <span class="token operator">/</span>root
    openssl rand <span class="token operator">-</span>writerand <span class="token punctuation">.</span>rnd
    cd <span class="token operator">-</span>
</code></pre> 
<pre><code class="prism language-powershell">生成服务器证书私钥
openssl genrsa <span class="token operator">-</span>out kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com<span class="token punctuation">.</span>key 4096

生成证书签名请求（CSR）
openssl req <span class="token operator">-</span>sha512 <span class="token operator">-</span>new \
    <span class="token operator">-</span>subj <span class="token string">"/C=CN/ST=Beijing/L=Beijing/O=example/OU=Personal/CN=kubernetes-register.superopsmsb.com"</span> \
    <span class="token operator">-</span>key kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com<span class="token punctuation">.</span>key \
    <span class="token operator">-</span>out kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com<span class="token punctuation">.</span>csr
</code></pre> 
<pre><code class="prism language-powershell">生成一个x509 v3扩展文件
	无论您使用FQDN还是IP地址连接到Harbor主机，都必须创建此文件，以便可以为您的Harbor主机生成符合主题备用名称（SAN）和x509 v3的证书扩展要求。替换DNS条目以反映您的域。
<span class="token function">cat</span> &gt; v3<span class="token punctuation">.</span>ext &lt;&lt;<span class="token operator">-</span>EOF
authorityKeyIdentifier=keyid<span class="token punctuation">,</span>issuer
basicConstraints=CA:FALSE
keyUsage = digitalSignature<span class="token punctuation">,</span> nonRepudiation<span class="token punctuation">,</span> keyEncipherment<span class="token punctuation">,</span> dataEncipherment
extendedKeyUsage = serverAuth
subjectAltName = @alt_names

<span class="token namespace">[alt_names]</span>
DNS<span class="token punctuation">.</span>1=kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com
DNS<span class="token punctuation">.</span>2=kubernetes-register<span class="token punctuation">.</span>superopsmsb
DNS<span class="token punctuation">.</span>3=kubernetes-register
EOF
</code></pre> 
<pre><code class="prism language-powershell">使用该v3<span class="token punctuation">.</span>ext文件为您的Harbor主机生成证书
openssl x509 <span class="token operator">-</span>req <span class="token operator">-</span>sha512 <span class="token operator">-</span>days 3650 \
    <span class="token operator">-</span>extfile v3<span class="token punctuation">.</span>ext \
    <span class="token operator">-</span>CA ca<span class="token punctuation">.</span>crt <span class="token operator">-</span>CAkey ca<span class="token punctuation">.</span>key <span class="token operator">-</span>CAcreateserial \
    <span class="token operator">-in</span> kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com<span class="token punctuation">.</span>csr \
    <span class="token operator">-</span>out kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com<span class="token punctuation">.</span>crt
</code></pre> 
<p>提供证书给harbor和docker</p> 
<pre><code class="prism language-powershell">将服务器证书和密钥复制到Harbor主机上的certficates文件夹中
mkdir <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>server/harbor/certs/kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com <span class="token operator">-</span>p
<span class="token function">cp</span> kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com<span class="token punctuation">.</span>crt <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>server/harbor/certs/kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/
<span class="token function">cp</span> kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com<span class="token punctuation">.</span>key <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>server/harbor/certs/kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/
</code></pre> 
<pre><code class="prism language-powershell">Docker守护程序将<span class="token punctuation">.</span>crt文件解释为CA证书，并将<span class="token punctuation">.</span>cert文件解释为客户端证书
openssl x509 <span class="token operator">-</span>inform PEM <span class="token operator">-in</span> kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com<span class="token punctuation">.</span>crt <span class="token operator">-</span>out kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com<span class="token punctuation">.</span>cert
</code></pre> 
<pre><code class="prism language-powershell">将服务器证书，密钥和CA文件复制到Harbor主机上的Docker证书文件夹中。您必须首先创建适当的文件夹
mkdir <span class="token operator">-</span>p <span class="token operator">/</span>etc/docker/certs<span class="token punctuation">.</span>d/kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/
<span class="token function">cp</span> kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com<span class="token punctuation">.</span>cert <span class="token operator">/</span>etc/docker/certs<span class="token punctuation">.</span>d/kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/
<span class="token function">cp</span> kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com<span class="token punctuation">.</span>key <span class="token operator">/</span>etc/docker/certs<span class="token punctuation">.</span>d/kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/
<span class="token function">cp</span> ca<span class="token punctuation">.</span>crt <span class="token operator">/</span>etc/docker/certs<span class="token punctuation">.</span>d/kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/

注意：
	如果将默认nginx端口443映射到其他端口，请创建文件夹
		<span class="token operator">/</span>etc/docker/certs<span class="token punctuation">.</span>d/yourdomain<span class="token punctuation">.</span>com:port
		或<span class="token operator">/</span>etc/docker/certs<span class="token punctuation">.</span>d/harbor_IP:port
	这一步，对于新版的docker来说可以省略，即使不做这一步，影响不大。
</code></pre> 
<pre><code class="prism language-powershell">重新启动Docker Engine
systemctl restart docker
</code></pre> 
<p>harbor启动</p> 
<pre><code class="prism language-powershell">进入工作目录
cd <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>server/harbor

重新应用harbor配置
<span class="token punctuation">.</span><span class="token operator">/</span>prepare
<span class="token punctuation">.</span><span class="token operator">/</span>install<span class="token punctuation">.</span>sh

检查效果
docker-compose <span class="token function">ps</span>
</code></pre> 
<p><strong>简单实践</strong></p> 
<p>浏览器测试</p> 
<pre><code>修改windows的hosts文件  C:\Windows\System32\drivers\etc\hosts 
10.0.0.20 kubernetes-register.superopsmsb.com

浏览器访问  https://kubernetes-register.superopsmsb.com
这个时候，就会使用https方式了，如果需要让浏览器不提示不安全，需要下载ca.crt到本地电脑安装证书，在Windows环境下双击，安装选择受信任的根证书即可。

</code></pre> 
<p>docker测试</p> 
<pre><code class="prism language-powershell">删除之前的docker认证信息
<span class="token function">rm</span> <span class="token operator">-</span>f <span class="token operator">/</span>root/<span class="token punctuation">.</span>docker/config<span class="token punctuation">.</span>json
</code></pre> 
<pre><code class="prism language-powershell">修改docker的私服配置 <span class="token operator">/</span>etc/docker/daemon<span class="token punctuation">.</span>json
<span class="token string">"insecure-registries"</span>: <span class="token punctuation">[</span><span class="token string">"kubernetes-register.superopsmsb.com"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</code></pre> 
<pre><code class="prism language-powershell">重启docker服务
systemctl restart docker
</code></pre> 
<pre><code class="prism language-powershell">测试效果
docker login https:<span class="token operator">/</span><span class="token operator">/</span>kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com
</code></pre> 
<p><strong>小结</strong></p> 
<pre><code>
</code></pre> 
<h4><a id="116__710"></a>1.1.6 高可用仓库</h4> 
<p>学习目标</p> 
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p> 
<p><strong>基础知识</strong></p> 
<p>需求</p> 
<pre><code class="prism language-powershell">	docker镜像很重要，如果harbor仓库存在单点现象的话，会导致所有镜像无法在项目更新的时候进行使用。所以，我们有必要对于harbor进行高可用环境的定制。
	Harbor 提供了很好的性能和安全<span class="token punctuation">,</span> 它支持安装在多个 Registry 节点的镜像资源复制，从而实现镜像数据的一致性需求，比较适合于负载均衡、高可用、混合云和多云的场景。
</code></pre> 
<p>方案</p> 
<pre><code class="prism language-powershell">	我们选择的高可用方案是比较简单的Harbor的双主复制，搭建两个Harbor节点，节点之间能够互相复制，然后通过haproxy代理Harbor节点提供外部访问。
	高可用节点
		<span class="token operator">-</span> 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>18<span class="token punctuation">|</span>19
		<span class="token operator">-</span> keepalived+haproxy
	harbor节点
		<span class="token operator">-</span> 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>20<span class="token punctuation">|</span>21
		<span class="token operator">-</span> harbor
</code></pre> 
<pre><code class="prism language-powershell">注意:
	基于离线安装包安装的高可用方案需要保证以下文件在多个实例之间的一致性。同时，由于这些文件是在各个 Harbor 实例的安装过程中默认生成的，所以需要用户手动复制这些文件来保证一致性。
	再一个Harbor主要是给公司内部的开发人员使用的，由于业务使用量不是那么大，所以我们对于数据的一致性能够保证分钟级别也就可以了。
</code></pre> 
<p>从节点部署</p> 
<pre><code class="prism language-powershell">我们在 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>21节点上部署harbor
	参考 前一节的 仓库升级内容，关于证书相关的信息使用复制即可。
	
注意：
	修改两个harbor节点的hostname为 各自的ip地址
	然后执行 <span class="token punctuation">.</span><span class="token operator">/</span>prepare 和 <span class="token punctuation">.</span><span class="token operator">/</span>install<span class="token punctuation">.</span>sh
	如果需要启动时候，添加镜像检测功能，我们可以使用如下命令
		<span class="token punctuation">.</span><span class="token operator">/</span>install<span class="token punctuation">.</span>sh <span class="token operator">--</span>with-trivy
</code></pre> 
<p>keepalived配置</p> 
<pre><code class="prism language-powershell">主keepalived配置
vrrp_instance VI_2 <span class="token punctuation">{<!-- --></span>
    state MASTER
    interface eth0
    virtual_router_id 52
    priority 100
    advert_int 1
    authentication <span class="token punctuation">{<!-- --></span>
        auth_type PASS
        auth_pass 1111
    <span class="token punctuation">}</span>
    virtual_ipaddress <span class="token punctuation">{<!-- --></span>
        10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>201 dev eth0 label eth0:2
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-powershell">从keepalived配置
vrrp_instance VI_2 <span class="token punctuation">{<!-- --></span>
    state BACKUP
    interface eth0
    virtual_router_id 52
    priority 90
    advert_int 1
    authentication <span class="token punctuation">{<!-- --></span>
        auth_type PASS
        auth_pass 1111
    <span class="token punctuation">}</span>
    virtual_ipaddress <span class="token punctuation">{<!-- --></span>
        10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>201 dev eth0 label eth0:2
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-powershell">重启keepalived
systemctl restart keepalived
</code></pre> 
<p>haproxy配置</p> 
<pre><code class="prism language-powershell">修改haproxy的配置文件
listen harbor-80
    bind 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>201:80
    mode tcp
    server harbor1 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>20:80 check inter 3s fall 3 rise 5
    server harbor2 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>21:80 check inter 3s fall 3 rise 5
</code></pre> 
<p><strong>简单实践</strong></p> 
<p>配置主从</p> 
<pre><code class="prism language-powershell">我们暂时访问 http:<span class="token operator">/</span><span class="token operator">/</span>10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>20，登陆配置一个主从角色，将20相关的配置同步到21主机。点击仓库管理后，创建harbor从角色的信息：
	目标名：可以随意定义
	目标url: 是从harbor节点的http链接地址
	访问id: admin
	访问密码: 123456
注意：当我们点击确定后，就会出现图中下面的仓库列表样式
</code></pre> 
<p><img src="https://images2.imgbox.com/ca/8f/mYCAJyie_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-powershell">点击复制管理后，创建主从同步规则信息：
	名称和描述：自定义
	资源过滤器：定制同步仓库即可
	目标仓库：从列表中选择即可
	触发模式：选择手动模式
注意：当我们点击确定后，就会出现图中下面的规则列表样式
</code></pre> 
<p><img src="https://images2.imgbox.com/1b/3f/FBEvWFC4_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-powershell">触发复制并验证结果
	1 勾选复制规则
	2 点击复制
	3 确认复制
	4 查看复制任务
</code></pre> 
<p><img src="https://images2.imgbox.com/23/74/evmEsoG2_o.png" alt="在这里插入图片描述"></p> 
<pre><code>harbor2确认复制效果

</code></pre> 
<p><img src="https://images2.imgbox.com/72/ae/e4ErbHKG_o.png" alt="在这里插入图片描述"></p> 
<p>测试效果</p> 
<pre><code class="prism language-powershell">对于master节点来说，我们只需要修改<span class="token operator">/</span>etc/hosts 文件的主机名解析记录即可
10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>201 kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com  kubernetes-register
</code></pre> 
<p><strong>小结</strong></p> 
<pre><code class="prism language-powershell">
</code></pre> 
<h4><a id="117__874"></a>1.1.7 镜像策略</h4> 
<p>学习目标</p> 
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p> 
<p><strong>基础知识</strong></p> 
<p>简介</p> 
<pre><code class="prism language-powershell">	Kubernetes 对 API 访问提供了三种安全访问控制措施：认证、授权和 Admission Control。认证解决用户合法性的问题，授权解决用户能做什么的问题，Admission Control 则是资源管理方面的作用。通过合规的用户、合理的权限管理以及合适的准入控制机制，能够保证系统的安全可靠。
	注意：关于插件化的准入控制是1<span class="token punctuation">.</span>9版本之后的能力，之前是需要编译才可以实现。
</code></pre> 
<pre><code class="prism language-powershell">	k8s在很多方面都具备可扩展性，比如通过cni实现多种网络模型，通过csi实现多种存储引擎，通过cri实现多种容器运行时等等。而AdmissionWebhook就是准入层面的一种可扩展的手段。 它可以已默认的Admission插件外，还有自定义的Admission插件，在api-server运行时指定资源对象的时候，通过webhook进行操作的请求控制。
</code></pre> 
<pre><code class="prism language-powershell">	Admission webhooks是基于HTTP回调机制运行的，当它接收Admission请求并对它们做一些事情的时候。Admission webhook对k8s的请求资源对象进行深层次准入控制，Admission webhook有两种控制机制，MutatingAdmissionWebhook<span class="token punctuation">(</span>对请求对象的修改<span class="token punctuation">)</span>和ValidatingAdmissionWebhook<span class="token punctuation">(</span>对请求的合法性进行检查<span class="token punctuation">)</span>。
</code></pre> 
<p>webhook解析</p> 
<pre><code class="prism language-powershell">Admission Webhook 本质是 api-server 的一个 webhook 调用，下面是 api-server 的处理流程：
	api-server 通过读取 mutatingwebhookconfiguration 和 validatingwebhookconfiguration 的 CRD 文件的目标地址，然后回调用户自定义的服务。
</code></pre> 
<p><img src="https://images2.imgbox.com/f6/c8/WJbZTONs_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-powershell">参考资料：
	https:<span class="token operator">/</span><span class="token operator">/</span>kubernetes<span class="token punctuation">.</span>io/docs/reference/access-authn-authz/extensible-admission-controllers/
</code></pre> 
<p>部署注意事项</p> 
<pre><code class="prism language-powershell">1 webhook 的本质是 http server，因此，需要用代码实现这么一个 server，供 apiserver 调用
2 mutating webhook 和 validating webhook 没有直接联系，分别实现了不同的功能，本质上说，如果修改<span class="token operator">/</span>验证都需要，我们需要编写两个 http server
3 编写好的 webhook，建议使用 k8s deployment 部署，同时使用 service 来暴露能力
4 apiserver 通过MutatingWebhookConfiguration/ValidatingWebhookConfiguration 调用 webhook
5 apiserver 和 webhook 通信时的身份认证和权限控制必须合理控制	
</code></pre> 
<p>案例需求</p> 
<pre><code class="prism language-powershell">	ImagePolicyWebhook是专门用于镜像获取的准入控制器策略，它主要通过验证镜像字段来判断，资源在创建时候是否满足创建的条件。我们可以在k8s的资源对象创建的时候，保证镜像来源仓库的可靠。但是该实践需要配置涉及到的很多文档内容，包括认证、配置、环境等。

参考资料：
	https:<span class="token operator">/</span><span class="token operator">/</span>kubernetes<span class="token punctuation">.</span>io/docs/reference/access-authn-authz/admission-controllers/<span class="token comment">#configuration-file-format</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/4b/64/Fci8gM0B_o.png" alt="在这里插入图片描述"></p> 
<p>操作步骤</p> 
<pre><code class="prism language-powershell">1 准备https专用的证书文件
2 构建webhook服务器
3 kubernetes集成镜像webhook服务
4 综合测试
5 收尾动作
</code></pre> 
<p><strong>简单实践</strong></p> 
<p>准备https专用的证书文件</p> 
<pre><code class="prism language-powershell">准备证书工具环境
mkdir <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>kubernetes/process_secure/ <span class="token punctuation">;</span> cd <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>kubernetes/process_secure/ 
<span class="token keyword">for</span> i in cfssl cfssljson
<span class="token keyword">do</span>
  wget https:<span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com/cloudflare/cfssl/releases/download/v1<span class="token punctuation">.</span>6<span class="token punctuation">.</span>1/<span class="token variable">$i_1</span><span class="token punctuation">.</span>6<span class="token punctuation">.</span>1_linux_amd64
  chmod <span class="token operator">+</span>x <span class="token variable">$i_1</span><span class="token punctuation">.</span>6<span class="token punctuation">.</span>1_linux_amd64
  <span class="token function">cp</span> <span class="token variable">$i_1</span><span class="token punctuation">.</span>6<span class="token punctuation">.</span>1_linux_amd64 <span class="token operator">/</span>usr/local/bin/<span class="token variable">$i</span>
done
</code></pre> 
<pre><code class="prism language-powershell">准备专用证书目录
mkdir <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>kubernetes/process_secure/cert <span class="token operator">-</span>p
cd <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>kubernetes/process_secure/cert/
</code></pre> 
<pre><code class="prism language-powershell">准备CA配置信息，参考 cfssl print-defaults config 命令
<span class="token function">cat</span> &gt; ca-config<span class="token punctuation">.</span>json &lt;&lt;EOF
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"signing"</span>: <span class="token punctuation">{<!-- --></span>
    <span class="token string">"default"</span>: <span class="token punctuation">{<!-- --></span>
      <span class="token string">"expiry"</span>: <span class="token string">"87600h"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"profiles"</span>: <span class="token punctuation">{<!-- --></span>
      <span class="token string">"kubernetes"</span>: <span class="token punctuation">{<!-- --></span>
         <span class="token string">"expiry"</span>: <span class="token string">"87600h"</span><span class="token punctuation">,</span>
         <span class="token string">"usages"</span>: <span class="token punctuation">[</span>
            <span class="token string">"signing"</span><span class="token punctuation">,</span>
            <span class="token string">"key encipherment"</span><span class="token punctuation">,</span>
            <span class="token string">"server auth"</span><span class="token punctuation">,</span>
            <span class="token string">"client auth"</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
EOF
</code></pre> 
<pre><code class="prism language-powershell">准备签名请求信息参考 cfssl print-defaults csr 命令
<span class="token function">cat</span> &gt; ca-csr<span class="token punctuation">.</span>json &lt;&lt;EOF
<span class="token punctuation">{<!-- --></span>
    <span class="token string">"CN"</span>: <span class="token string">"kubernetes"</span><span class="token punctuation">,</span>
    <span class="token string">"key"</span>: <span class="token punctuation">{<!-- --></span>
        <span class="token string">"algo"</span>: <span class="token string">"rsa"</span><span class="token punctuation">,</span>
        <span class="token string">"size"</span>: 2048
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"names"</span>: <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token string">"C"</span>: <span class="token string">"CN"</span><span class="token punctuation">,</span>
            <span class="token string">"L"</span>: <span class="token string">"Beijing"</span><span class="token punctuation">,</span>
            <span class="token string">"ST"</span>: <span class="token string">"Beijing"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
EOF
</code></pre> 
<pre><code class="prism language-powershell">准备image专属的webhook请求信息
<span class="token function">cat</span> &gt; webhook-csr<span class="token punctuation">.</span>json &lt;&lt;EOF
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"CN"</span>: <span class="token string">"webhook"</span><span class="token punctuation">,</span>
  <span class="token string">"hosts"</span>: <span class="token punctuation">[</span>
   <span class="token string">"10.0.0.12"</span><span class="token punctuation">,</span>
   <span class="token string">"10.0.0.13"</span><span class="token punctuation">,</span>
   <span class="token string">"10.0.0.14"</span><span class="token punctuation">,</span>
   <span class="token string">"127.0.0.1"</span>
   <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string">"key"</span>: <span class="token punctuation">{<!-- --></span>
    <span class="token string">"algo"</span>: <span class="token string">"rsa"</span><span class="token punctuation">,</span>
    <span class="token string">"size"</span>: 2048
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"names"</span>: <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string">"C"</span>: <span class="token string">"CN"</span><span class="token punctuation">,</span>
      <span class="token string">"L"</span>: <span class="token string">"BeiJing"</span><span class="token punctuation">,</span>
      <span class="token string">"ST"</span>: <span class="token string">"BeiJing"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
EOF
</code></pre> 
<pre><code class="prism language-powershell">准备webhook和apiserver的认证信息
<span class="token function">cat</span> &gt; apiserver-client-csr<span class="token punctuation">.</span>json &lt;&lt;EOF
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"CN"</span>: <span class="token string">"apiserver"</span><span class="token punctuation">,</span>
  <span class="token string">"hosts"</span>: <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string">"key"</span>: <span class="token punctuation">{<!-- --></span>
    <span class="token string">"algo"</span>: <span class="token string">"rsa"</span><span class="token punctuation">,</span>
    <span class="token string">"size"</span>: 2048
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"names"</span>: <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string">"C"</span>: <span class="token string">"CN"</span><span class="token punctuation">,</span>
      <span class="token string">"L"</span>: <span class="token string">"BeiJing"</span><span class="token punctuation">,</span>
      <span class="token string">"ST"</span>: <span class="token string">"BeiJing"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
EOF
</code></pre> 
<pre><code class="prism language-powershell">生成私钥和证书
cfssl gencert <span class="token operator">-</span>initca ca-csr<span class="token punctuation">.</span>json <span class="token punctuation">|</span> cfssljson <span class="token operator">-</span>bare ca <span class="token operator">-</span>

生成webhook证书
cfssl gencert <span class="token operator">-</span>ca=ca<span class="token punctuation">.</span>pem <span class="token operator">-</span>ca-key=ca-key<span class="token punctuation">.</span>pem <span class="token operator">-</span>config=ca-config<span class="token punctuation">.</span>json <span class="token operator">-</span>profile=kubernetes webhook-csr<span class="token punctuation">.</span>json <span class="token punctuation">|</span> cfssljson <span class="token operator">-</span>bare webhook

生成apiserver证书
cfssl gencert <span class="token operator">-</span>ca=ca<span class="token punctuation">.</span>pem <span class="token operator">-</span>ca-key=ca-key<span class="token punctuation">.</span>pem <span class="token operator">-</span>config=ca-config<span class="token punctuation">.</span>json <span class="token operator">-</span>profile=kubernetes apiserver-client-csr<span class="token punctuation">.</span>json <span class="token punctuation">|</span> cfssljson <span class="token operator">-</span>bare apiserver-client
</code></pre> 
<p>构建webhook服务器</p> 
<pre><code class="prism language-powershell">定制镜像专属目录结构
mkdir <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>images/web/flask/conf
cd <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>images/web/flask
</code></pre> 
<pre><code class="prism language-powershell">定制webhook的核心代码<span class="token punctuation">(</span>Flask<span class="token punctuation">)</span> main<span class="token punctuation">.</span>conf
<span class="token keyword">from</span> flask import Flask<span class="token punctuation">,</span>request
import json

<span class="token comment"># 创建app应用</span>
app = Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

<span class="token comment"># 定制测试url</span>
@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">"/index"</span><span class="token punctuation">)</span>
def index<span class="token punctuation">(</span><span class="token punctuation">)</span>:
  <span class="token keyword">return</span> <span class="token string">"flask web ok\n"</span>

@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/image_check'</span><span class="token punctuation">,</span> methods=<span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
def image_policy<span class="token punctuation">(</span><span class="token punctuation">)</span>:
  <span class="token comment"># 获取用户提交数据并进行数据反序列化</span>
  post_data = request<span class="token punctuation">.</span>get_data<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
  print<span class="token punctuation">(</span><span class="token string">"--- POST数据: {}"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>post_data<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">data</span> = json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>post_data<span class="token punctuation">)</span>
  <span class="token comment"># 定制容器镜像格式的检测规则 -- 必须携带标签</span>
  <span class="token keyword">for</span> container in <span class="token keyword">data</span><span class="token punctuation">[</span><span class="token string">'spec'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'containers'</span><span class="token punctuation">]</span>:
    <span class="token keyword">if</span> <span class="token string">":"</span> not in container<span class="token punctuation">[</span><span class="token string">'image'</span><span class="token punctuation">]</span> or <span class="token string">":latest"</span> in container<span class="token punctuation">[</span><span class="token string">'image'</span><span class="token punctuation">]</span>:
      msg=<span class="token string">"镜像格式检测失败! 镜像名称必须携带标签，同时禁用默认标签."</span>
      allowed<span class="token punctuation">,</span> reason = False<span class="token punctuation">,</span> msg
      <span class="token keyword">break</span>
    <span class="token keyword">else</span>:
      msg=<span class="token string">"镜像格式检测成功!"</span>
      allowed<span class="token punctuation">,</span> reason = True<span class="token punctuation">,</span> msg
  print<span class="token punctuation">(</span><span class="token string">"--- 检查结果: {}"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment"># 定制返回信息</span>
  obj_api=<span class="token keyword">data</span><span class="token punctuation">[</span><span class="token string">'apiVersion'</span><span class="token punctuation">]</span>
  obj_kind=<span class="token keyword">data</span><span class="token punctuation">[</span><span class="token string">'kind'</span><span class="token punctuation">]</span>
  obj_image=<span class="token keyword">data</span><span class="token punctuation">[</span><span class="token string">'spec'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'containers'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>0<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'image'</span><span class="token punctuation">]</span>

  result = <span class="token punctuation">{<!-- --></span><span class="token string">"apiVersion"</span>: obj_api<span class="token punctuation">,</span> <span class="token string">"kind"</span>: obj_kind<span class="token punctuation">,</span> <span class="token string">"image_name"</span>: obj_image <span class="token punctuation">,</span> <span class="token string">"status"</span>: <span class="token punctuation">{<!-- --></span><span class="token string">"allowed"</span>: allowed<span class="token punctuation">,</span> <span class="token string">"reason"</span>: reason<span class="token punctuation">}</span><span class="token punctuation">}</span>
  print<span class="token punctuation">(</span><span class="token string">"--- 响应数据: {}"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment"># 对响应数据进行序列化操作，ensure_ascii=False，表示返回信息包含中文</span>
  <span class="token keyword">return</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>result<span class="token punctuation">,</span> ensure_ascii=False<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ == <span class="token string">"__main__"</span>:
  app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host=<span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span> port=8080<span class="token punctuation">,</span> ssl_context=<span class="token punctuation">(</span><span class="token string">'/data/server/image_check/webhook.pem'</span><span class="token punctuation">,</span> <span class="token string">'/data/server/image_check/webhook-key.pem'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-powershell">定制专属的Dockerfile文件
<span class="token comment"># 构建一个基于flask的定制镜像</span>
<span class="token comment"># 基础镜像</span>
<span class="token keyword">FROM</span> kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/python
<span class="token comment"># 镜像作者</span>
MAINTAINER shuji@superopsmsb<span class="token punctuation">.</span>com

<span class="token comment"># 拷贝文件</span>
ADD conf/main<span class="token punctuation">.</span>py <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>server/image_check/main<span class="token punctuation">.</span>py

<span class="token comment"># 创建flask环境</span>
RUN pip install flask &amp;&amp; useradd python &amp;&amp; chown <span class="token operator">-</span>R python <span class="token operator">/</span><span class="token keyword">data</span>

<span class="token comment"># 暴露django端口</span>
EXPOSE 8080
USER python

<span class="token comment"># 定制容器的启动命令</span>
CMD <span class="token punctuation">[</span><span class="token string">"python"</span><span class="token punctuation">,</span> <span class="token string">"/data/server/image_check/main.py"</span><span class="token punctuation">]</span>

注意：
	这里使用普通用户主要后期运行时候的缓存信息及时显示的原因
</code></pre> 
<pre><code class="prism language-powershell">定制镜像文件
docker build <span class="token operator">-</span>t kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/image-webhook:v0<span class="token punctuation">.</span>1 <span class="token punctuation">.</span>
</code></pre> 
<pre><code class="prism language-powershell">在生成证书的节点上运行镜像文件
export cert_dir=<span class="token string">'/data/kubernetes/process_secure/cert/'</span>
export cont_dir=<span class="token string">'/data/server/image_check'</span>
docker run <span class="token operator">-</span>d <span class="token operator">--</span>name=image-webhook <span class="token operator">-</span>u root <span class="token operator">-</span>e PYTHONUNBUFFERED=1 <span class="token operator">-</span>v <span class="token variable">$cert_dir</span><span class="token operator">/</span>webhook<span class="token punctuation">.</span>pem:<span class="token variable">$cont_dir</span><span class="token operator">/</span>webhook<span class="token punctuation">.</span>pem <span class="token operator">-</span>v <span class="token variable">$cert_dir</span><span class="token operator">/</span>webhook-key<span class="token punctuation">.</span>pem:<span class="token variable">$cont_dir</span><span class="token operator">/</span>webhook-key<span class="token punctuation">.</span>pem <span class="token operator">-</span>p 8080:8080 kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/image-webhook:v0<span class="token punctuation">.</span>1
注意：
	<span class="token operator">-</span>u root <span class="token operator">-</span>e PYTHONUNBUFFERED=1 的作用是将请求相关的数据即时输出
</code></pre> 
<pre><code class="prism language-powershell">检查效果
<span class="token punctuation">]</span><span class="token comment"># docker ps | grep image</span>
77bf356ce83e   kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/image-webhook:v0<span class="token punctuation">.</span>1   <span class="token string">"python /data/server…"</span>   9 seconds ago    Up 9 seconds    0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0:8080-&gt;8080/tcp<span class="token punctuation">,</span> :::8080-&gt;8080/tcp   image-webhook

<span class="token punctuation">]</span><span class="token comment"># curl -k https://10.0.0.12:8080/index</span>
flask web ok
结果显示：
	webhook服务器已经部署完毕了
</code></pre> 
<p>kubernetes集成镜像webhook服务</p> 
<pre><code class="prism language-powershell">检查kubernetes集群是否启用了准入注册 API
<span class="token punctuation">]</span><span class="token comment"># kubectl api-versions |grep admission</span>
admissionregistration<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io/v1

查看kubernetes集群的准入控制现状
<span class="token punctuation">]</span><span class="token comment"># grep admission /etc/kubernetes/manifests/kube-apiserver.yaml</span>
    <span class="token operator">-</span> <span class="token operator">--</span><span class="token function">enable-admission</span><span class="token operator">-</span>plugins=NodeRestriction
    
准备专属的目录
mkdir <span class="token operator">-</span>p <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>kubernetes/process_secure/api_conf
cd <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>kubernetes/process_secure/api_conf
</code></pre> 
<pre><code class="prism language-powershell">准备准入控制的策略文件 admission_configuration<span class="token punctuation">.</span>yaml
apiVersion: apiserver<span class="token punctuation">.</span>config<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io/v1
kind: AdmissionConfiguration
plugins:
<span class="token operator">-</span> name: ImagePolicyWebhook
  configuration:
    imagePolicy:
      <span class="token comment"># 指定image策略专属连接和认证文件</span>
      kubeConfigFile: <span class="token operator">/</span>etc/kubernetes/image-policy/connect_webhook<span class="token punctuation">.</span>yaml
      allowTTL: 50
      denyTTL: 50
      retryBackoff: 500
      defaultAllow: true
</code></pre> 
<pre><code class="prism language-powershell">定制image策略专属连接和认证文件 connect_webhook<span class="token punctuation">.</span>yaml
apiVersion: v1
kind: Config
clusters:
  <span class="token operator">-</span> cluster:
      certificate-authority: <span class="token operator">/</span>etc/kubernetes/image-policy/webhook<span class="token punctuation">.</span>pem
      <span class="token comment"># 定制</span>
      server: https:<span class="token operator">/</span><span class="token operator">/</span>10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12:8080/image_check
    name: webhook
contexts:
  <span class="token operator">-</span> context:
      cluster: webhook
      user: apiserver
    name: webhook
current-context: webhook 
preferences: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
users:
  <span class="token operator">-</span> name: apiserver
    user:
      client-certificate: <span class="token operator">/</span>etc/kubernetes/image-policy/apiserver-client<span class="token punctuation">.</span>pem
      client-key: <span class="token operator">/</span>etc/kubernetes/image-policy/apiserver-client-key<span class="token punctuation">.</span>pem
</code></pre> 
<pre><code class="prism language-powershell">同步证书相关信息
cd <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>kubernetes/process_secure/cert/
<span class="token keyword">for</span> i in 12 13 14
<span class="token keyword">do</span>
  ssh root@10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span><span class="token variable">$i</span> mkdir <span class="token operator">/</span>etc/kubernetes/image-policy <span class="token operator">-</span>p
  scp webhook<span class="token punctuation">.</span>pem apiserver-client<span class="token punctuation">.</span>pem apiserver-client-key<span class="token punctuation">.</span>pem root@10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span><span class="token variable">$i</span>:<span class="token operator">/</span>etc/kubernetes/image-policy/
  scp <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">/</span>api_conf/<span class="token punctuation">{<!-- --></span>admission_configuration<span class="token punctuation">.</span>yaml<span class="token punctuation">,</span>connect_webhook<span class="token punctuation">.</span>yaml<span class="token punctuation">}</span> root@10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span><span class="token variable">$i</span>:<span class="token operator">/</span>etc/kubernetes/image-policy/
done
</code></pre> 
<pre><code class="prism language-powershell">修改kube-apiserver的配置文件与webhook集成
<span class="token punctuation">]</span><span class="token comment"># cp /etc/kubernetes/manifests/kube-apiserver.yaml{，.bak}</span>
<span class="token punctuation">]</span><span class="token comment"># vim /etc/kubernetes/manifests/kube-apiserver.yaml</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
spec:
  containers:
  <span class="token operator">-</span> command:
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token operator">-</span> <span class="token operator">--</span><span class="token function">enable-admission</span><span class="token operator">-</span>plugins=NodeRestriction<span class="token punctuation">,</span>ImagePolicyWebhook
    <span class="token operator">-</span> <span class="token operator">--</span>admission-control-config-file=<span class="token operator">/</span>etc/kubernetes/image-policy/admission_configuration<span class="token punctuation">.</span>yaml
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    volumeMounts:
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token operator">-</span> mountPath: <span class="token operator">/</span>etc/kubernetes/image-policy
      name: image-policy
      readOnly: true
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  volumes:
  <span class="token operator">-</span> hostPath:
      path: <span class="token operator">/</span>etc/kubernetes/image-policy
      <span class="token function">type</span>: DirectoryOrCreate
    name: image-policy
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
配置解读：
	因为涉及到专属证书信息，所以需要hostPath方式进行挂载操作
</code></pre> 
<pre><code class="prism language-powershell">注意：
	因为kube-apiserver是静态pod，所以文件修改完毕后，就可以重启了
</code></pre> 
<p>综合测试</p> 
<pre><code class="prism language-powershell">在master节点上创建两个deployment
kubectl create deployment web1 <span class="token operator">--</span>image=kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/nginx_web
kubectl create deployment web2 <span class="token operator">--</span>image=kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/nginx_web:v0<span class="token punctuation">.</span>1

查看docker容器日志
docker logs <span class="token operator">-</span>f image-webhook
</code></pre> 
<p><img src="https://images2.imgbox.com/af/98/wyt7022w_o.png" alt="在这里插入图片描述"></p> 
<p>环境收尾</p> 
<pre><code class="prism language-powershell">删除docker容器
docker <span class="token function">rm</span> <span class="token operator">-</span>f image-webhook

清理deployment
kubectl delete deployments<span class="token punctuation">.</span>apps web1 web2
</code></pre> 
<pre><code class="prism language-powershell">还原kube-apiserver环境
<span class="token keyword">for</span> i in 12 13 14
<span class="token keyword">do</span>
  ssh root@10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span><span class="token variable">$i</span> <span class="token string">"mv /etc/kubernetes/manifests/kube-apiserver.yaml.bak /etc/kubernetes/manifests/kube-apiserver.yaml; rm -rf /etc/kubernetes/image-policy"</span>
done
</code></pre> 
<p><strong>小结</strong></p> 
<pre><code>
</code></pre> 
<h3><a id="12__1310"></a>1.2 配置管理</h3> 
<h4><a id="121__1312"></a>1.2.1 配置基础</h4> 
<p>学习目标</p> 
<p>这一节，我们从 基础知识、资源清单、小结 三个方面来学习。</p> 
<p><strong>基础知识</strong></p> 
<p>场景需求</p> 
<pre><code class="prism language-powershell">	生产中所有的应用程序中，都涉及到配置文件，而配置文件经常会有变更，比如数据库连接、代码版本号等，最典型场景就是：
	项目经历开发环境、测试环境、预发布环境、线上环境才能完成发布，而每个环境都有定义其独立的各种配置，这些配置手工操作很繁杂，所以好多大公司专门开发了专用配置管理中心，如百度的disconf等。
</code></pre> 
<p>如何为容器化应用提供配置信息？</p> 
<pre><code class="prism language-powershell">1 启动容器时，直接向应用程序传递参数，args: <span class="token punctuation">[</span><span class="token punctuation">]</span>
2 将定义好的配置文件焙进镜像之中；
3 通过环境变量向容器传递配置数据：有个前提要求，应用得支持从环境变量加载配置信息； 
4 制作镜像时，使用entrypoint脚本来预处理变量，常见的做法就是使用非交互式编辑工具，将环境变量的值替换到应用的配置文件中； 
5 基于存储卷向容器传递配置文件； 
注意：
	对于运行容器中的配置改变，需要通过应用程序重载相关配置
</code></pre> 
<p>k8s的配置管理</p> 
<pre><code class="prism language-powershell">	kubernetes作为分布式容器调度平台，肯定会遇到同样的问题，那么遇到这种问题后，我们不可能把资源删除后，重新修改一下，然后在启动生成，这种方法就太繁琐的。kubernetes提供了对pod中容器应用的集中配置管理组件：ConfigMap、Secret、downwardAPI。通过这些组件来实现向pod中的容器中注入配置信息的机制。
</code></pre> 
<p><img src="https://images2.imgbox.com/ce/10/FODxxZhO_o.png" alt="在这里插入图片描述"></p> 
<p><strong>资源清单</strong></p> 
<p>对象形式</p> 
<pre><code class="prism language-powershell">在kubernetes中，资源对象有两种形态：
	文件形态 <span class="token operator">-</span> 编写出来的资源对象文件，有大量属性组成。
	对象形态 <span class="token operator">-</span> 基于资源对象文件初始化后出来的应用对象。
</code></pre> 
<p>对象初始化</p> 
<pre><code class="prism language-powershell">资源对象初始化的方法主要有两大类：
	命令行工具<span class="token punctuation">(</span>kubectl<span class="token punctuation">)</span>
		<span class="token operator">-</span> 通过纯粹的 <span class="token string">"k8s命令及其选项"</span> 来实现资源的创建
	文件方式<span class="token punctuation">(</span>API<span class="token punctuation">)</span>
		<span class="token operator">-</span> 基于 <span class="token string">"k8s命令 + 配置文件"</span> 来实现资源的创建
		<span class="token operator">-</span> 基于 <span class="token string">"声明式的配置文件 + kubectl"</span> 来实现资源的创建
</code></pre> 
<p>使用资源对象</p> 
<pre><code class="prism language-powershell">生产中使用k8s操作业务环境
	1 保证容器应用是正常运行的
	2 创建专属的资源对象文件
	3 基于资源对象文件创建业务环境
	4 测试业务环境，如果不满足则进行后续动作，否则不做任何改变
		<span class="token operator">-</span> 调整容器的镜像文件
		<span class="token operator">-</span> 重新调整资源对象文件
		<span class="token operator">-</span> 基于新资源对象文件创建并测试新的环境
</code></pre> 
<p><strong>小结</strong></p> 
<pre><code>
</code></pre> 
<h4><a id="122_YAML_1390"></a>1.2.2 YAML安全</h4> 
<p>学习目标</p> 
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p> 
<p><strong>基础知识</strong></p> 
<p>需求</p> 
<pre><code class="prism language-powershell">	资源清单的最大的好处是，让我们手工繁琐操作流程变成一个一个的资源对象属性，通过一个简单的kubectl apply <span class="token operator">-</span>f的方式，基于资源清单文件，实现业务环境的高度定制化、自动化的操作。
	大量的资源清单文件在大规模使用的时候，往往会因为场景的不同，需要对于同一个配置文件进行修整。如果我们对于资源清单文件的目录结构、内容样式、适用场景非常了解的前提下，我们可以随意的操作这些海量的资源清单文件。
</code></pre> 
<pre><code class="prism language-powershell">	但是我们知道，无论操作人员的能力多么的高，在面对海量数据的时候，总会有懈怠的时候，再加上yaml操作的高速度，一旦yaml文件出现安全问题，那会导致非常严重的业务环境问题。尤其是当我们的能力不足以撑起yaml的优势的时候，导致的问题会更大。
	所以，我们需要一种yaml文件的安全检测机制，来保证yaml文件的安全性。这里的安全性主要体现在三个层面：
		1 yaml文件自身的结构 <span class="token operator">-</span> explain
		2 yaml文件本身的安全 <span class="token operator">-</span> kubesec
		3 yaml文件项目的安全 <span class="token operator">-</span> kustomize
</code></pre> 
<p>安全机制</p> 
<pre><code class="prism language-powershell">yaml文件自身的结构 <span class="token operator">-</span> explain
	所谓文件自身的结构，就是结合explain的资源对象属性体系，然后根据业务场景的功能，选择合适的对象属性组合在一起即可。
	<span class="token operator">-</span> 它是kubeadm的一个子命令
</code></pre> 
<pre><code class="prism language-powershell">yaml文件本身的安全 <span class="token operator">-</span> kubesec
	所谓文件本身的安全，是借助于专用的资源清单的安全配置评估的工具，根据生产的最佳实践来验证资源清单文件的安全性并适时给出建议。Kubesec 可以作为 Web 服务或准入控制器的样式存在，接收 Kubernetes资源作为输入，并进程检测分析，如果不合格，则禁止执行。
	<span class="token operator">-</span> 参考地址：https:<span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com/controlplaneio/kubesec
</code></pre> 
<pre><code class="prism language-powershell">yaml文件项目的安全 <span class="token operator">-</span> kustomize
	所谓的文件项目的安全，是站在项目的角度，对所有场景中的资源清单文件，按照版本管理的方式进行统一安全质量控制。kustomize 是 kubernetes 原生的配置管理，以无模板方式来定制应用的配置。通过功能复用、补丁等方式实现项目级别的yaml结构安全。
	<span class="token operator">-</span> 参考地址；https:<span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com/kubernetes-sigs/kustomize
</code></pre> 
<p><strong>简单实践</strong></p> 
<p>普通方式实践kubeasc</p> 
<pre><code class="prism language-powershell">Kubesec 可以作为二进制包、容器镜像、准入控制器甚至 kubectl 插件安装
cd <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>softs
wget https:<span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com/controlplaneio/kubesec/releases/download/v2<span class="token punctuation">.</span>12<span class="token punctuation">.</span>0/kubesec_linux_amd64<span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz
</code></pre> 
<pre><code class="prism language-powershell">部署kubesec
tar <span class="token operator">-</span>xvf kubesec_linux_amd64<span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz
<span class="token function">mv</span> kubesec <span class="token operator">/</span>usr/local/bin/
</code></pre> 
<pre><code class="prism language-powershell">注意：
	命令格式 kubesec scan <span class="token operator">/</span>path/to/file<span class="token punctuation">.</span>yaml
	该命令在第一次检测的时候，需要到github中获取检测文件
</code></pre> 
<pre><code class="prism language-powershell">简单实践
<span class="token punctuation">]</span><span class="token comment"># kubesec scan /data/kubernetes/app_secure/01_kubernetes_application_secure_secret_data.yaml</span>
<span class="token punctuation">[</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token string">"object"</span>: <span class="token string">"Secret/superopsmsb-secret.default"</span><span class="token punctuation">,</span>
    <span class="token string">"valid"</span>: true<span class="token punctuation">,</span>
    <span class="token string">"fileName"</span>: <span class="token string">"/data/kubernetes/app_secure/01_kubernetes_application_secure_secret_data.yaml"</span><span class="token punctuation">,</span>
    <span class="token string">"message"</span>: <span class="token string">"This resource kind is not supported by kubesec"</span><span class="token punctuation">,</span>
    <span class="token string">"score"</span>: 0<span class="token punctuation">,</span>
    <span class="token string">"scoring"</span>: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> 
<pre><code class="prism language-powershell"><span class="token punctuation">]</span><span class="token comment"># kubesec scan /data/kubernetes/server_secure/01_kubernetes_server_secure_pod_test.yaml</span>
<span class="token punctuation">[</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token string">"object"</span>: <span class="token string">"Pod/nginx-web.default"</span><span class="token punctuation">,</span>
    <span class="token string">"valid"</span>: true<span class="token punctuation">,</span>
    <span class="token string">"fileName"</span>: <span class="token string">"/data/kubernetes/server_secure/01_kubernetes_server_secure_pod_test.yaml"</span><span class="token punctuation">,</span>
    <span class="token string">"message"</span>: <span class="token string">"Passed with a score of 0 points"</span><span class="token punctuation">,</span>
    <span class="token string">"score"</span>: 0<span class="token punctuation">,</span>
    <span class="token string">"scoring"</span>: <span class="token punctuation">{<!-- --></span>
      <span class="token string">"advise"</span>: <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span>
          <span class="token string">"id"</span>: <span class="token string">"ApparmorAny"</span><span class="token punctuation">,</span>
          <span class="token string">"selector"</span>: <span class="token string">".metadata .annotations .\"</span>container<span class="token punctuation">.</span>apparmor<span class="token punctuation">.</span>security<span class="token punctuation">.</span>beta<span class="token punctuation">.</span>kubernetes<span class="token punctuation">.</span>io/nginx\<span class="token string">""</span><span class="token punctuation">,</span>
          <span class="token string">"reason"</span>: <span class="token string">"Well defined AppArmor policies may provide greater protection from unknown threats. WARNING: NOT PRODUCTION READY"</span><span class="token punctuation">,</span>
          <span class="token string">"points"</span>: 3
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<p>web服务方式</p> 
<pre><code class="prism language-powershell">部署web服务方式1 <span class="token operator">-</span> 依赖于gitlab的访问获取配置文件
kubesec http 8080 &amp;

部署web服务方式2 <span class="token operator">-</span> 容器内部的自带配置文件
docker pull kubesec/kubesec
docker run <span class="token operator">-</span>d <span class="token operator">--</span>name kubesec <span class="token operator">-</span>p 8080:8080 kubesec/kubesec http 8080
</code></pre> 
<pre><code class="prism language-powershell">使用方式
curl <span class="token operator">-</span>sSX POST <span class="token operator">--</span><span class="token keyword">data</span><span class="token operator">-</span>binary @<span class="token operator">/</span>path/to/file<span class="token punctuation">.</span>yaml http:<span class="token operator">/</span><span class="token operator">/</span>localhost:8080/scan
</code></pre> 
<pre><code class="prism language-powershell">检测方式
<span class="token punctuation">]</span><span class="token comment"># curl -sSX POST --data-binary @/data/kubernetes/server_secure/01_kubernetes_server_secure_pod_test.yaml http://10.0.0.12:8080/scan</span>
<span class="token punctuation">[</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token string">"object"</span>: <span class="token string">"Pod/nginx-web.default"</span><span class="token punctuation">,</span>
    <span class="token string">"valid"</span>: true<span class="token punctuation">,</span>
    <span class="token string">"fileName"</span>: <span class="token string">"API"</span><span class="token punctuation">,</span>
    <span class="token string">"message"</span>: <span class="token string">"Passed with a score of 0 points"</span><span class="token punctuation">,</span>
    <span class="token string">"score"</span>: 0<span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<p>其他检测方式</p> 
<pre><code class="prism language-powershell">变种方式
docker run <span class="token operator">-</span>i kubesec/kubesec scan <span class="token operator">/</span>dev/stdin &lt; <span class="token operator">/</span>path/to/file<span class="token punctuation">.</span>yaml
注意：
	不推荐
</code></pre> 
<pre><code class="prism language-powershell">webhook方式
	参考资料： https:<span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com/controlplaneio/kubesec-webhook
</code></pre> 
<p><strong>小结</strong></p> 
<pre><code>
</code></pre> 
<h4><a id="123_kustomize_1541"></a>1.2.3 kustomize</h4> 
<p>学习目标</p> 
<p>这一节，我们从 基础知识、应用管理、小结 三个方面来学习。</p> 
<p><strong>基础知识</strong></p> 
<p>实际现状</p> 
<pre><code class="prism language-powershell">	根据我们之前对 k8s的学习，尤其是对各种状态应用的管理，比如statsfulset资源对象，redis集群、alertmanager部署等具体的实践。当我们需要在kubernetes环境运行一个完整的业务项目的时候，我们需要根据业务需求提前梳理功能，进而编写大量的资源清单文件的YAML文件，通过这些文件来定制项目的预期目标<span class="token punctuation">(</span>副本，存储空间，内存和CPU等信息<span class="token punctuation">)</span>，我们就会遇到两种问题：
	1 一大堆的部署配置资源清单就是工作量非常大的一件事情。
		对于这些复杂的应用，在k8s之上，我们不建议使用独立的部署清单来进行配置
	2 部署清单本身就有相当大的限制约束，导致部署清单的任务量成倍增加
		如果我们要部署多套prometheus集群，我们可以将所有的资源配置清单部署到不同的namespace中
			<span class="token operator">-</span> 这就导致，两套不同的部署清单文件结构
</code></pre> 
<pre><code class="prism language-powershell">	根据我们之前说的，持续交付的解决方案，为了实现成功的项目交付，我们要在不同的环境中测试该业务是否满足我们的预期，所以项目交付的过程中，会涉及到多种环境。所以实际的情况中，我们需要通过复制<span class="token operator">+</span>定制的方式，为不同的环境配置独有的一套配置。
	我们可以想象得到，一旦我们针对这么来进行管理的话，那当我们的业务环境达到一定量级的时候，我们就有多套仅存在细微差别的配置，对于后期的方案维护相当的不友好。
</code></pre> 
<p>方案规整</p> 
<pre><code class="prism language-powershell">所以，为了便于k8s来管理这些同业务的多版本场景，尤其是云原生的时代，我们应该使用一个 git版本控制系统来对所有的资源配置清单进行统一的管控。同时为了方便后续技术支持团队的管理维护，开发人员应该做如下的三件事情：
	1 编写业务项目相关的部署清单文件，并提交到代码管理仓库
		<span class="token operator">-</span> 方便后续团队，根据业务需求，准备相关的资源	
	2 提供项目持续维护的jenkinsfile、Dockerfile文件。
		<span class="token operator">-</span> 方便后续团队，根据业务的实际情况，以流水线的方式实现功能的迭代更新。
	3 不同环境的资源文件，都应该有独有的一份。
		<span class="token operator">-</span> 以k8s环境为例，方便后续团队在多个ns中分别创建资源对象。
</code></pre> 
<pre><code class="prism language-powershell">	由于k8s上还有一种根据监控指标实现自动扩缩容的功能，所以，一旦我们将持续交付流水线做完毕后，结合提前做好的资源清单文件，与项目交付相关的所有操作，都不需要我们人工干预了。
</code></pre> 
<p><img src="https://images2.imgbox.com/ac/fb/ji9ppv14_o.png" alt="在这里插入图片描述"></p> 
<p><strong>应用管理</strong></p> 
<p>简介</p> 
<pre><code class="prism language-powershell">根据我们刚才所描述的信息内容，我们可以了解到，越是复杂的业务运行环境，越需要有一套业务部署管理工具
	<span class="token operator">-</span> 将业务相关的功能解决方案，将多个云原生的软件以组件方式整合在一起，然后统一的进行管理
对于k8s来说，它就提供了这样的一种工具：kustomize。
</code></pre> 
<p>官网介绍</p> 
<pre><code class="prism language-powershell">Kubernetes native configuration management<span class="token punctuation">.</span> Kustomize introduces a template-free way to customize application configuration that simplifies the use of off-the-shelf applications<span class="token punctuation">.</span> 
</code></pre> 
<pre><code class="prism language-powershell">kustomize 是 kubernetes 原生的配置管理，以无模板方式来定制应用的配置。
也就是说，kustomize 使用 k8s 原生概念帮助创建并复用资源配置<span class="token punctuation">(</span>YAML<span class="token punctuation">)</span>，允许用户以一个应用描述文件<span class="token punctuation">(</span>YAML 文件<span class="token punctuation">)</span>为基础<span class="token punctuation">(</span>Base YAML<span class="token punctuation">)</span>，然后通过 Overlay 的方式生成最终部署应用所需的描述文件。
</code></pre> 
<p>工具简介</p> 
<pre><code class="prism language-powershell">	kustomize允许用户将不同环境所共享的配置放在一个文件目录下，而将其他不同的配置放在另外的目录下。通过这种通用<span class="token operator">+</span>特有的组合方式，让我们的多业务环境更轻松的来解决适配性的问题。

	kustomize是sig-<span class="token function">cli</span>的一个子项目，它的设计目的是给kubernetes的用户提供一种可以重复使用同一套配置的声明式应用管理，从而在配置工作中用户只需要管理和维护kubernetes的API对象，而不需要学习或安装其它的配置管理工具，也不需要通过复制粘贴来得到新的环境的配置。
	
	Kustomize 是一个用来定制 Kubernetes 配置的工具。它提供以下功能特性来管理 应用配置文件：
        从其他来源生成资源
        为资源设置贯穿性（Cross-Cutting）字段
        组织和定制资源集合
</code></pre> 
<pre><code class="prism language-powershell">github地址：https:<span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com/kubernetes-sigs/kustomize
最新版本：v4<span class="token punctuation">.</span>5<span class="token punctuation">.</span>7 <span class="token punctuation">|</span> 20220803
</code></pre> 
<p>概念解析</p> 
<table><thead><tr><th>组件</th><th>解析</th></tr></thead><tbody><tr><td>kustomization</td><td>该文件所在的目录下可以运行 kustomize build，自动生成配套文件</td></tr><tr><td>base</td><td>kustomization.yaml文件所在目录，项目的根目录</td></tr><tr><td>resource</td><td>kubernetes API资源对象文件</td></tr><tr><td>patch</td><td>kubernetes API资源对象文件特有的patch属性信息文件，符合yaml格式。</td></tr><tr><td>variant</td><td>base下的多个不同业务场景的kustomization</td></tr><tr><td>overlay</td><td>声明了与 base 之间的差异。通过 overlay 来维护基于 base 的不同 variants(变体)</td></tr></tbody></table> 
<p>入口配置</p> 
<pre><code class="prism language-powershell">apiVersion: kustomize<span class="token punctuation">.</span>config<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io/v1beta1
kind: Kustomization
bases &lt;<span class="token punctuation">[</span><span class="token punctuation">]</span>string&gt;						<span class="token comment"># 基础通用配置信息所在目录</span>
resources &lt;<span class="token punctuation">[</span><span class="token punctuation">]</span>string&gt;   					<span class="token comment"># 待定制的原始资源配置文件列表，按顺序处理</span>
namespace &lt;string&gt;     					<span class="token comment"># 资源对象归属目标名称空间</span>
commonLabels &lt;map<span class="token namespace">[string]</span>string&gt;  		<span class="token comment"># 资源对象的通用标签</span>
commonAnnotations &lt;map<span class="token namespace">[string]</span>string&gt;   <span class="token comment"># 资源对象的通用注解</span>
namePrefix &lt;string&gt;   					<span class="token comment"># 资源对象添加的名称前缀</span>
nameSuffix &lt;string&gt;   					<span class="token comment"># 资源对象添加的名称后缀</span>
images &lt;<span class="token punctuation">[</span><span class="token punctuation">]</span>Image&gt;   						<span class="token comment"># 模板中定制的镜像文件</span>
<span class="token operator">-</span> name &lt;String&gt;    						<span class="token comment"># 待替换的镜像名称</span>
  nameName &lt;String&gt;   					<span class="token comment"># 要使用的新镜像名称</span>
  newTag &lt;String&gt;     					<span class="token comment"># 要使用的新镜像的标签</span>
  digest &lt;String&gt;     					<span class="token comment"># 要使用的新镜像的sha256校验码</span>
vars &lt;<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">Var</span>&gt;          					<span class="token comment"># 可替换的变量列表</span>
<span class="token operator">-</span> name &lt;String&gt;      					<span class="token comment"># 变量的名称，支持以“$(name)”格式进行引用</span>
  objref &lt;String&gt;     					<span class="token comment"># 包含了要引用的目标字段的对象的名称</span>
  fieldref &lt;String&gt;     				<span class="token comment"># 引用的字段名称，默认为metadata.name</span>
</code></pre> 
<p>配置生成器</p> 
<pre><code class="prism language-powershell">ConfigMap生成器：
configMapGenerator &lt;<span class="token punctuation">[</span><span class="token punctuation">]</span>ConfigMapGeneratorArgs&gt;  <span class="token comment"># ConfigMap资源生成器列表</span>
<span class="token operator">-</span> name &lt;String&gt;   					<span class="token comment"># 资源对象名称</span>
  namespace &lt;String&gt;  				<span class="token comment"># 命名空间</span>
  behavior &lt;String&gt;   				<span class="token comment"># 合并策略，可为create/replace/merge；</span>
  files &lt;<span class="token punctuation">[</span><span class="token punctuation">]</span>String&gt;   				<span class="token comment"># ConfigMap文件相对当前项目的路径</span>
  literals &lt;<span class="token punctuation">[</span><span class="token punctuation">]</span>String&gt;   			<span class="token comment"># 以“key=value”格式的生成ConfigMap</span>
  env &lt;String&gt;  				 	<span class="token comment"># 以环境变量文件格式生成ConfigMap</span>
</code></pre> 
<pre><code class="prism language-powershell">Secret生成器：
secretGenerator &lt;<span class="token punctuation">[</span><span class="token punctuation">]</span>secretGeneratorArgs&gt;  <span class="token comment"># Secret资源生成器列表</span>
<span class="token operator">-</span> name &lt;String&gt;  					<span class="token comment"># 资源对象名称</span>
  namespace &lt;String&gt;  				<span class="token comment"># 命名空间</span>
  behavior &lt;String&gt;    				<span class="token comment"># 合并策略，可为create/replace/merge；</span>
  files &lt;<span class="token punctuation">[</span><span class="token punctuation">]</span>String&gt;   				<span class="token comment"># Secret文件相对当前项目的路径</span>
  literals &lt;<span class="token punctuation">[</span><span class="token punctuation">]</span>String&gt;   			<span class="token comment"># 以“key=value”格式的生成Secret</span>
  <span class="token function">type</span> &lt;String&gt;   					<span class="token comment"># 选择Secret资源类型</span>
</code></pre> 
<pre><code class="prism language-powershell">生成器选项：
generatorOptions &lt;GeneratorOptions&gt;   	<span class="token comment"># 生成器额外属性，为上面两项的补充内容</span>
  labels &lt;map<span class="token namespace">[String]</span>String&gt;   			<span class="token comment"># 扩展的标签</span>
  annotations &lt;map<span class="token namespace">[String]</span>String&gt;   	<span class="token comment"># 扩展的注解</span>
  disableNameSuffixHash &lt;Boolean&gt;  		<span class="token comment"># 是否禁用hash名称后缀，默认为启用</span>
</code></pre> 
<pre><code class="prism language-powershell">资源补丁
patchesJson6902 &lt;<span class="token punctuation">[</span><span class="token punctuation">]</span>Json6902&gt;   			<span class="token comment"># 待补对象列表</span>
  path &lt;String&gt;   						<span class="token comment"># 补丁文件路径，支持json或yaml格式</span>
  target &lt;Target&gt;   					<span class="token comment"># 待补资源对象</span>
    <span class="token function">group</span> &lt;String&gt;  					<span class="token comment"># 资源所属的群组</span>
    version &lt;String&gt;   					<span class="token comment"># API版本</span>
    kind &lt;String&gt;   					<span class="token comment"># 资源类型</span>
    name &lt;String&gt;   					<span class="token comment"># 资源对象的名称</span>
    namespace &lt;string&gt;   				<span class="token comment"># 资源对象所属的名称空间</span>
patchesStrategicMerge &lt;<span class="token punctuation">[</span><span class="token punctuation">]</span>string&gt;   		<span class="token comment"># 将补丁补到匹配的资源之上，匹配的方式是根据资源</span>
                                        <span class="token comment"># Group/Version/Kind + Name/Namespace判断</span>
</code></pre> 
<p>配置示例</p> 
<pre><code class="prism language-powershell">资源清单文件：kustomization<span class="token punctuation">.</span>yaml
apiVersion: kustomize<span class="token punctuation">.</span>config<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io/v1beta1
kind: Kustomization
bases:
  <span class="token operator">-</span> <span class="token operator">/</span>config/app1/base
  <span class="token operator">-</span> <span class="token operator">/</span>config/app2/base
  <span class="token operator">-</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
resources:
  <span class="token operator">-</span> service<span class="token punctuation">.</span>yaml
  <span class="token operator">-</span> deployment<span class="token punctuation">.</span>yaml
patches:
  <span class="token operator">-</span> patch<span class="token punctuation">.</span>yaml
namePrefix: my-
</code></pre> 
<pre><code class="prism language-powershell">Kustomize的核心目标在于为管理的应用生成资源配置，而这些资源配置中定义了资源的期望状态
</code></pre> 
<p><strong>小结</strong></p> 
<pre><code>
</code></pre> 
<h4><a id="124__1731"></a>1.2.4 基础实践</h4> 
<p>学习目标</p> 
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p> 
<p><strong>环境准备</strong></p> 
<p>简介</p> 
<pre><code class="prism language-powershell">我们可以通过如下两种不同方式来安装kustomize
	二进制方式：将软件包解压到系统命令路径即可，我们推荐
	go方式：go get github<span class="token punctuation">.</span>com/kubernetes-sigs/kustomize
	k8s方法：从 1<span class="token punctuation">.</span>14 版本开始，kubectl 也开始支持使用 kustomization 文件来管理 Kubernetes 对象。 要查看包含 kustomization 文件的目录中的资源，执行下面的命令：
</code></pre> 
<p>软件安装</p> 
<pre><code class="prism language-powershell">下载软件
mkdir <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>softs &amp;&amp; cd <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>softs
wget https:<span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com/kubernetes-sigs/kustomize/releases/download/kustomize%2Fv4<span class="token punctuation">.</span>5<span class="token punctuation">.</span>7/kustomize_v4<span class="token punctuation">.</span>5<span class="token punctuation">.</span>7_linux_amd64<span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz

解压文件
mkdir <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>server/kustomize/bin
tar xf kustomize_v4<span class="token punctuation">.</span>5<span class="token punctuation">.</span>7_linux_amd64<span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz <span class="token operator">-</span>C <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>server/kustomize/bin/
</code></pre> 
<pre><code class="prism language-powershell">环境变量定制
<span class="token comment"># vim /etc/profile.d/kustomize.sh</span>
<span class="token comment">#!/bin/bash</span>
<span class="token comment"># set kustomize env path</span>
export KUSTOMIZE_HOME=<span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>server/kustomize   
export PATH=$<span class="token punctuation">{<!-- --></span>KUSTOMIZE_HOME<span class="token punctuation">}</span><span class="token operator">/</span>bin:<span class="token variable">$PATH</span> 

加载环境变量
chmod <span class="token operator">+</span>x <span class="token operator">/</span>etc/profile<span class="token punctuation">.</span>d/kustomize<span class="token punctuation">.</span>sh
source <span class="token operator">/</span>etc/profile<span class="token punctuation">.</span>d/kustomize<span class="token punctuation">.</span>sh
</code></pre> 
<pre><code class="prism language-powershell">查看命令帮助
<span class="token punctuation">]</span><span class="token comment"># kustomize --help</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
Available Commands:
  build                     Build a kustomization target <span class="token keyword">from</span> a directory or URL<span class="token punctuation">.</span>
  cfg                       Commands <span class="token keyword">for</span> reading and writing configuration<span class="token punctuation">.</span>
  completion                Generate shell completion script
  create                    Create a new kustomization in the current directory
  edit                      Edits a kustomization file
  fn                        Commands <span class="token keyword">for</span> running functions against configuration<span class="token punctuation">.</span>
  help                      Help about any command
  version                   Prints the kustomize version

Flags:
  <span class="token operator">-</span>h<span class="token punctuation">,</span> <span class="token operator">--</span>help          help <span class="token keyword">for</span> kustomize
      <span class="token operator">--</span>stack-trace   print a stack-trace on error

Additional help topics:
  kustomize docs-fn                   <span class="token namespace">[Alpha]</span> 开发和调用配置函数的文档
  kustomize docs-fn-spec              <span class="token namespace">[Alpha]</span> 配置函数规范文档<span class="token punctuation">.</span>
  kustomize docs-io-annotations       <span class="token namespace">[Alpha]</span> io使用的注释文档
  kustomize docs-merge                <span class="token namespace">[Alpha]</span> 合并资源的文档<span class="token punctuation">.</span>
  kustomize docs-merge3               <span class="token namespace">[Alpha]</span> 合并资源的文档<span class="token punctuation">.</span>
  kustomize tutorials-command-basics  <span class="token namespace">[Alpha]</span> 使用基本配置命令的教程<span class="token punctuation">.</span>
  kustomize tutorials-<span class="token keyword">function</span><span class="token operator">-</span>basics <span class="token namespace">[Alpha]</span> 使用函数的教程<span class="token punctuation">.</span>

Use <span class="token string">"kustomize [command] --help"</span> <span class="token keyword">for</span> more information about a command<span class="token punctuation">.</span>
</code></pre> 
<p>安装方式2 - k8s子命令</p> 
<pre><code class="prism language-powershell">	从 1<span class="token punctuation">.</span>14 版本开始，kubectl 也开始支持使用 kustomization 文件来管理 Kubernetes 对象。 要查看包含 kustomization 文件的目录中的资源，执行下面的命令：
	kubectl kustomize &lt;kustomization_directory&gt;

要应用这些资源，使用参数 <span class="token operator">--</span>kustomize 或 <span class="token operator">-</span>k 标志来执行 kubectl apply：
	kubectl apply <span class="token operator">-</span>k &lt;kustomization_directory&gt;
</code></pre> 
<p><strong>简单实践</strong></p> 
<p>简单实践</p> 
<pre><code class="prism language-powershell">创建测试目录
mkdir <span class="token operator">-</span>p <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>kubernetes/process_secure/kustomize/kustomize-test <span class="token operator">-</span>p
</code></pre> 
<pre><code class="prism language-powershell">创建核心的kustomization<span class="token punctuation">.</span>yaml文件，用于核心流程处理
apiVersion: kustomize<span class="token punctuation">.</span>config<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io/v1beta1
kind: Kustomization

resources:
<span class="token operator">-</span> kustomiz-deployment-test<span class="token punctuation">.</span>yaml
<span class="token operator">-</span> kustomiz-service-test<span class="token punctuation">.</span>yaml

commonLabels:
  generated-by: kustomize
</code></pre> 
<pre><code class="prism language-powershell">创建依赖的 kustomiz-deployment-test<span class="token punctuation">.</span>yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deployment-nginx-web
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nginx-web
  template:
    metadata:
      labels:
        app: nginx-web
    spec:
      containers:
      <span class="token operator">-</span> name: nginx
        image: kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/nginx_web:v0<span class="token punctuation">.</span>1
        imagePullPolicy: IfNotPresent
        ports:
        <span class="token operator">-</span> containerPort: 80
          name: http
</code></pre> 
<pre><code class="prism language-powershell">创建依赖的 kustomiz-service-test<span class="token punctuation">.</span>yaml
kind: Service
apiVersion: v1
metadata:
  name: service-nginx-web
spec:
  selector:
    app: nginx-web
  ports:
  <span class="token operator">-</span> name: http
    protocol: TCP
    port: 80
    targetPort: 80
</code></pre> 
<pre><code class="prism language-powershell">查看目录结构
kustomize/kustomize-test<span class="token punctuation">]</span><span class="token comment"># tree ./</span>
<span class="token punctuation">.</span><span class="token operator">/</span>
├── kustomization<span class="token punctuation">.</span>yaml
├── kustomiz-deployment-test<span class="token punctuation">.</span>yaml
└── kustomiz-service-test<span class="token punctuation">.</span>yaml

0 directories<span class="token punctuation">,</span> 3 files
</code></pre> 
<p>执行效果</p> 
<pre><code class="prism language-powershell">创建资源对象
kubectl apply <span class="token operator">-</span>k <span class="token punctuation">.</span><span class="token operator">/</span>
</code></pre> 
<pre><code class="prism language-powershell">查看资源对象
<span class="token punctuation">]</span><span class="token comment"># kubectl get pod,svc</span>
NAME                                      READY   STATUS    RESTARTS   AGE
pod/deployment-nginx-web-c77b687c5-6tzmt   1/1     Running   0          9s

NAME                       <span class="token function">TYPE</span>        CLUSTER-IP       EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>   AGE
service/kubernetes         ClusterIP   10<span class="token punctuation">.</span>96<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1        &lt;none&gt;        443/TCP   57d
service/service-nginx-web   ClusterIP   10<span class="token punctuation">.</span>106<span class="token punctuation">.</span>243<span class="token punctuation">.</span>105   &lt;none&gt;        80/TCP    10s

删除资源对象
kubectl delete <span class="token operator">-</span>k <span class="token punctuation">.</span><span class="token operator">/</span>
</code></pre> 
<pre><code class="prism language-powershell">直接以模拟的方式查看效果
kubectl apply  <span class="token operator">-</span>k <span class="token punctuation">.</span><span class="token operator">/</span> <span class="token operator">--</span>dry-run=client <span class="token operator">-</span>o yaml

仅仅查看生成的配置文件
kustomize build <span class="token punctuation">.</span><span class="token operator">/</span>
注意：
	这种方式可以确认，创建好的资源对象是否包含我们刚才定制的相关属性信息。
</code></pre> 
<p><strong>小结</strong></p> 
<pre><code>
</code></pre> 
<h4><a id="125__1926"></a>1.2.5 功能复用</h4> 
<p>学习目标</p> 
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p> 
<p><strong>基础知识</strong></p> 
<p>简介</p> 
<pre><code class="prism language-powershell">kustomize 可以通过目录复用的机制，实现在通用功能的基础上，对某些特殊的机制进行重写或者集成
</code></pre> 
<p>方案解析</p> 
<pre><code class="prism language-powershell">我们可以创建一个base目录，作为所有相关项目的根目录。
然后再另外一个目录中，通过 bases 属性，继承base目录的相关内容
</code></pre> 
<p><strong>简单实践</strong></p> 
<p>准备基础文件</p> 
<pre><code class="prism language-powershell">将我们之前实践出来的环境文件，作为一个基础的可以被其他环境集成的项目目录
mkdir kustomize-proj/base/ <span class="token operator">-</span>p
<span class="token function">cp</span> <span class="token operator">-</span>a kustomize-test/<span class="token operator">*</span> kustomize-proj/base/
</code></pre> 
<p>环境实践</p> 
<pre><code class="prism language-powershell">在base目录同级别的位置，创建一个test目录
mkdir kustomize-proj/test
</code></pre> 
<pre><code class="prism language-powershell">创建一个专用的继承功能的文件 kustomize-proj/test/kustomization<span class="token punctuation">.</span>yaml
apiVersion: kustomize<span class="token punctuation">.</span>config<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io/v1beta1
kind: Kustomization

bases:
<span class="token operator">-</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">/</span>base/
resources:
<span class="token operator">-</span> namespace<span class="token punctuation">.</span>yaml
namespace: test

<span class="token comment"># kustomize支持添加标注和注释，这些标注和注释会加在每一个它所管理的API对象上</span>
commonLabels:
  env: test
commonAnnotations:
  superopsmsb<span class="token punctuation">.</span>io/app: <span class="token string">"kustomize"</span>

images:
<span class="token operator">-</span> name: <span class="token string">"kubernetes-register.superopsmsb.com/superopsmsb/nginx_web"</span>
  newTag: <span class="token string">"v0.1"</span>
属性解析：
	1 通过base继承原来的应用
	2 images仅仅是基于原来的镜像名称，更改了镜像的标签。
</code></pre> 
<pre><code class="prism language-powershell">创建依赖出来的文件 kustomize-proj/test/namespace<span class="token punctuation">.</span>yaml
apiVersion: v1
kind: Namespace
metadata:
  name: test
</code></pre> 
<pre><code class="prism language-powershell">查看目录效果
<span class="token comment"># tree kustomize-proj/</span>
kustomize-proj/
├── base
│   ├── kustomization<span class="token punctuation">.</span>yaml
│   ├── kustomiz-deployment-test<span class="token punctuation">.</span>yaml
│   └── kustomiz-service-test<span class="token punctuation">.</span>yaml
└── test
    ├── kustomization<span class="token punctuation">.</span>yaml
    └── namespace<span class="token punctuation">.</span>yaml

2 directories<span class="token punctuation">,</span> 5 files
</code></pre> 
<pre><code class="prism language-powershell">检查效果
kubectl  apply <span class="token operator">-</span>k kustomize-proj/base/ <span class="token operator">--</span>dry-run=client <span class="token operator">-</span>o yaml
kubectl  apply <span class="token operator">-</span>k kustomize-proj/test/ <span class="token operator">--</span>dry-run=client <span class="token operator">-</span>o yaml

或者 
kustomize build kustomize-proj/base/
kustomize build kustomize-proj/test/
</code></pre> 
<p><strong>小结</strong></p> 
<pre><code>
</code></pre> 
<h4><a id="126__2032"></a>1.2.6 配置定制</h4> 
<p>学习目标</p> 
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p> 
<p><strong>基础知识</strong></p> 
<p>简介</p> 
<pre><code class="prism language-powershell">	ConfigMap 和 Secret 包含其他 Kubernetes 对象（如 Pod）所需要的配置或敏感数据。 ConfigMap 或 Secret 中数据的来源往往是集群外部<span class="token punctuation">.</span>	例如某个 <span class="token punctuation">.</span>properties 文件或者 SSH 密钥文件。
	Kustomize 提供 secretGenerator 和 configMapGenerator，可以基于文件或字面 值来生成 Secret 和 ConfigMap。
</code></pre> 
<p><strong>简单实践</strong></p> 
<p>准备基础文件</p> 
<pre><code class="prism language-powershell">在base目录同级别的位置，创建一个test目录
mkdir kustomize-proj/staging
</code></pre> 
<p>环境实践</p> 
<pre><code class="prism language-powershell">创建一个专用的继承功能的文件 kustomize-proj/staging/kustomization<span class="token punctuation">.</span>yaml
apiVersion: kustomize<span class="token punctuation">.</span>config<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io/v1beta1
kind: Kustomization

bases:
<span class="token operator">-</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">/</span>base/

resources:
<span class="token operator">-</span> namespace<span class="token punctuation">.</span>yaml

namespace: staging

commonLabels:
  environment: staging

commonAnnotations:
  superopsmsb<span class="token punctuation">.</span>io/app: <span class="token string">"kustomize"</span>

configMapGenerator:
<span class="token operator">-</span> name: nginx-conf
  literals:
  <span class="token operator">-</span> HOST=<span class="token string">"0.0.0.0"</span>
  <span class="token operator">-</span> PORT=<span class="token string">"80"</span>

secretGenerator:
<span class="token operator">-</span> name: nginx-ssl
  files:
  <span class="token operator">-</span> secrets/tls<span class="token punctuation">.</span>crt
  <span class="token operator">-</span> secrets/tls<span class="token punctuation">.</span>key
  <span class="token function">type</span>: <span class="token string">"kubernetes.io/tls"</span>

generatorOptions:
  disableNameSuffixHash: true
属性解析：
	1 通过secretGenerator 和 generatorOptions 生成相关的对象
	2 disableNameSuffixHash 的目的是在基于deployment创建pod的时候，禁止生成hash后缀
</code></pre> 
<pre><code class="prism language-powershell">创建依赖出来的文件 kustomize-proj/staging/namespace<span class="token punctuation">.</span>yaml
apiVersion: v1
kind: Namespace
metadata:
  name: staging
</code></pre> 
<pre><code class="prism language-powershell">准备相关的证书信息
mkdir kustomize-proj/staging/secrets &amp;&amp; cd kustomize-proj/staging/secrets
openssl  genrsa <span class="token operator">-</span>out tls<span class="token punctuation">.</span>key 2048
openssl req  <span class="token operator">-</span>new <span class="token operator">-</span>x509 <span class="token operator">-</span>key tls<span class="token punctuation">.</span>key  <span class="token operator">-</span>out tls<span class="token punctuation">.</span>crt <span class="token operator">-</span>subj <span class="token operator">/</span>C=CN/ST=Beijing/L=Beijing/O=DevOps/CN=shuji<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com
注意：
	域名必须是我们使用的域名信息
</code></pre> 
<p>检查效果</p> 
<pre><code class="prism language-powershell">查看目录效果
<span class="token punctuation">]</span><span class="token comment"># tree kustomize-proj/</span>
kustomize-proj/
├── base
│   ├── kustomization<span class="token punctuation">.</span>yaml
│   ├── kustomiz-deployment-test<span class="token punctuation">.</span>yaml
│   └── kustomiz-service-test<span class="token punctuation">.</span>yaml
├── staging
│   ├── kustomization<span class="token punctuation">.</span>yaml
│   ├── namespace<span class="token punctuation">.</span>yaml
│   └── secrets
│       ├── tls<span class="token punctuation">.</span>crt
│       └── tls<span class="token punctuation">.</span>key
└── test
    ├── kustomization<span class="token punctuation">.</span>yaml
    └── namespace<span class="token punctuation">.</span>yaml

4 directories<span class="token punctuation">,</span> 9 files
</code></pre> 
<pre><code class="prism language-powershell">方法1
kubectl  apply <span class="token operator">-</span>k <span class="token punctuation">.</span><span class="token operator">/</span>base/ <span class="token operator">--</span>dry-run=client <span class="token operator">-</span>o yaml
kubectl  apply <span class="token operator">-</span>k <span class="token punctuation">.</span><span class="token operator">/</span>staging/ <span class="token operator">--</span>dry-run=client <span class="token operator">-</span>o yaml

方法2
kustomize build kustomize-proj/base/
kustomize build kustomize-proj/staging/
</code></pre> 
<p><strong>小结</strong></p> 
<pre><code class="prism language-powershell">
</code></pre> 
<h4><a id="127__2157"></a>1.2.7 补丁实践</h4> 
<p>学习目标</p> 
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p> 
<p><strong>基础知识</strong></p> 
<p>简介</p> 
<pre><code class="prism language-powershell">	由于软件开发是一个复杂的过程，组织必须保持警惕以确保系统是最新版本的，涉及到的业务功能需要更新，以避免不必要的风险。根据2022年云原生环境下容器存活周期的调查，容器的更新时间是非常快的，在加上容器业务环境的更新迭代非常高，这就对于kubernetes场景中海量的资源清单文件的管理，提出了更高的要求。
</code></pre> 
<p>补丁的作用</p> 
<pre><code class="prism language-powershell">	补丁管理是针对当前资源对象进行识别、获取、部署和验证软件更新的做法。我们可以借助于kustomize补丁管理策略和解决方案有助于为kuberntes资源管理对象的统一管理，提供应用验证和应用更新的便捷方法。
	补丁管理的意义对于网络安全行业来说不言而喻。为了应对高级威胁，检测全球威胁情报源已知的恶意软件是成功的一半。补丁管理对于阻止已知威胁而言至关重要。
</code></pre> 
<p>属性解析</p> 
<pre><code class="prism language-powershell">资源补丁
patchesJson6902 &lt;<span class="token punctuation">[</span><span class="token punctuation">]</span>Json6902&gt;   			<span class="token comment"># 待补对象列表</span>
  path &lt;String&gt;   						<span class="token comment"># 补丁文件路径，支持json或yaml格式</span>
  target &lt;Target&gt;   					<span class="token comment"># 待补资源对象</span>
    <span class="token function">group</span> &lt;String&gt;  					<span class="token comment"># 资源所属的群组</span>
    version &lt;String&gt;   					<span class="token comment"># API版本</span>
    kind &lt;String&gt;   					<span class="token comment"># 资源类型</span>
    name &lt;String&gt;   					<span class="token comment"># 资源对象的名称</span>
    namespace &lt;string&gt;   				<span class="token comment"># 资源对象所属的名称空间</span>
patchesStrategicMerge &lt;<span class="token punctuation">[</span><span class="token punctuation">]</span>string&gt;   		<span class="token comment"># 将补丁补到匹配的资源之上，匹配的方式是根据资源</span>
                                        <span class="token comment"># Group/Version/Kind + Name/Namespace判断	</span>
</code></pre> 
<pre><code class="prism language-powershell">	由于定制的补丁信息，主要起的是补充的作用，所以，为了能够让补丁信息和所归属的资源对象产生关联，我们需要在patch文件中补充原资源对象的基本属性信息，比如apiVersion、Kind、Namespace等。
</code></pre> 
<p><strong>简单实践</strong></p> 
<p>准备基础文件</p> 
<pre><code class="prism language-powershell">在base目录同级别的位置，创建一个prod目录
mkdir kustomize-proj/prod/patches
</code></pre> 
<p>环境实践</p> 
<pre><code class="prism language-powershell">创建一个专用的继承功能的文件 kustomize-proj/prod/kustomization<span class="token punctuation">.</span>yaml
apiVersion: kustomize<span class="token punctuation">.</span>config<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io/v1beta1
kind: Kustomization

bases:
<span class="token operator">-</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">/</span>base/

resources:
<span class="token operator">-</span> namespace<span class="token punctuation">.</span>yaml

namespace: prod

commonLabels:
  env: prod

commonAnnotations:
  superopsmsb<span class="token punctuation">.</span>io/app: <span class="token string">"kustomize"</span>

configMapGenerator:
<span class="token operator">-</span> name: nginx-conf
  literals:
  <span class="token operator">-</span> host=<span class="token string">"0.0.0.0"</span>
  <span class="token operator">-</span> port=<span class="token string">"80"</span>

secretGenerator:
<span class="token operator">-</span> name: nginx-ssl
  files:
  <span class="token operator">-</span> secrets/tls<span class="token punctuation">.</span>crt
  <span class="token operator">-</span> secrets/tls<span class="token punctuation">.</span>key
  <span class="token function">type</span>: <span class="token string">"kubernetes.io/tls"</span>

generatorOptions:
  disableNameSuffixHash: true

patchesStrategicMerge:
<span class="token operator">-</span> patches/nginx-<span class="token function">add-check</span><span class="token punctuation">.</span>yaml
<span class="token operator">-</span> patches/nginx-<span class="token function">add-conf</span><span class="token punctuation">.</span>yaml

patchesJson6902:
<span class="token operator">-</span> target:
    version: v1
    kind: Service
    name: service-nginx-web
  path: patches/patch-service-nginx<span class="token punctuation">.</span>yaml
属性解析：
	1 通过patchesStrategicMerge 加载相关的补丁文件
	2 patchesJson6902 使用这种规则进行规范限制
</code></pre> 
<pre><code class="prism language-powershell">创建依赖出来的文件 kustomize-proj/prod/namespace<span class="token punctuation">.</span>yaml
apiVersion: v1
kind: Namespace
metadata:
  name: prod
</code></pre> 
<p>准备补丁文件</p> 
<pre><code class="prism language-powershell">定制配置相关的补丁文件 kustomize-proj/prod/patches/nginx-<span class="token function">add-conf</span><span class="token punctuation">.</span>yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deployment-nginx-web
spec:
  template:
    spec:
      containers:
      <span class="token operator">-</span> name: nginx
        env:
        <span class="token operator">-</span> name: PORT
          valueFrom:
            configMapKeyRef:
              name: nginx-conf
              key: port
              optional: false
        <span class="token operator">-</span> name: HOST
          valueFrom:
            configMapKeyRef:
              name: nginx-conf
              key: host
              optional: true
        volumeMounts:
        <span class="token operator">-</span> name: nginx-certs
          mountPath: <span class="token operator">/</span>etc/certs/
          readOnly: true
      volumes:
      <span class="token operator">-</span> name: nginx-certs
        secret:
          secretName: nginx-ssl
</code></pre> 
<pre><code class="prism language-powershell">定制检测相关的补丁文件  kustomize-proj/prod/patches/nginx-<span class="token function">add-check</span><span class="token punctuation">.</span>yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deployment-nginx-web
spec:
  template:
    spec:
      containers:
      <span class="token operator">-</span> name: nginx
        livenessProbe:
          httpGet:
            path: <span class="token string">'/'</span>
            port: 80
          initialDelaySeconds: 5
        readinessProbe:
          httpGet:
            path: <span class="token string">'/'</span>
            port: 80
          initialDelaySeconds: 15
</code></pre> 
<pre><code class="prism language-powershell">准备纯粹的补丁文件 kustomize-proj/prod/patches/nginx-<span class="token function">add-sidecar</span><span class="token punctuation">.</span>yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deployment-nginx-web
spec:
  template:
    spec:
      containers:
      <span class="token operator">-</span> name: busybox
        image: kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/busybox:v0<span class="token punctuation">.</span>1
        command: <span class="token punctuation">[</span><span class="token string">'/bin/sh'</span><span class="token punctuation">,</span><span class="token string">'-c'</span><span class="token punctuation">]</span>
        args: <span class="token punctuation">[</span><span class="token string">'sleep 3600'</span><span class="token punctuation">]</span>
</code></pre> 
<pre><code class="prism language-powershell">定制专属的service修改补丁文件 kustomize-proj/prod/patches/patch-service-nginx<span class="token punctuation">.</span>yaml
<span class="token operator">-</span> op: replace
  path: <span class="token operator">/</span>spec/ports/0/targetPort
  value: 8888
<span class="token operator">-</span> op: add
  path: <span class="token operator">/</span>spec/ports/1
  value:
    name: https
    protocol: TCP
    port: 443
    targetPort: 8443
</code></pre> 
<pre><code class="prism language-powershell">准备相关的证书信息
mkdir kustomize-proj/prod/secrets &amp;&amp; cd kustomize-proj/prod/secrets
openssl  genrsa <span class="token operator">-</span>out tls<span class="token punctuation">.</span>key 2048
openssl req <span class="token operator">-</span>new <span class="token operator">-</span>x509 <span class="token operator">-</span>key tls<span class="token punctuation">.</span>key <span class="token operator">-</span>out tls<span class="token punctuation">.</span>crt <span class="token operator">-</span>subj <span class="token operator">/</span>O=DevOps/CN=shuji<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com
注意：
	域名必须是我们使用的域名信息
</code></pre> 
<p>查看效果</p> 
<pre><code class="prism language-powershell">查看目录效果
<span class="token punctuation">]</span><span class="token comment"># tree kustomize-proj/prod/</span>
kustomize-proj/prod/
├── kustomization<span class="token punctuation">.</span>yaml
├── namespace<span class="token punctuation">.</span>yaml
├── patches
│   ├── nginx-<span class="token function">add-check</span><span class="token punctuation">.</span>yaml
│   ├── nginx-<span class="token function">add-conf</span><span class="token punctuation">.</span>yaml
│   ├── nginx-<span class="token function">add-sidecar</span><span class="token punctuation">.</span>yaml
│   └── patch-service-nginx<span class="token punctuation">.</span>yaml
└── secrets
    ├── tls<span class="token punctuation">.</span>crt
    └── tls<span class="token punctuation">.</span>key

2 directories<span class="token punctuation">,</span> 8 files
</code></pre> 
<pre><code class="prism language-powershell">方法1:
kubectl  apply <span class="token operator">-</span>k kustomize-proj/base/ <span class="token operator">--</span>dry-run=client <span class="token operator">-</span>o yaml
kubectl  apply <span class="token operator">-</span>k kustomize-proj/prod/ <span class="token operator">--</span>dry-run=client <span class="token operator">-</span>o yaml

方法2:
kustomize build kustomize-proj/base/
kustomize build kustomize-proj/prod/
</code></pre> 
<pre><code class="prism language-powershell">运行项目环境
kubectl  apply <span class="token operator">-</span>k kustomize-proj/prod/

检测效果
kubectl get all <span class="token operator">-</span>n prod
</code></pre> 
<p><strong>小结</strong></p> 
<h3><a id="13__2413"></a>1.3 访问安全</h3> 
<h4><a id="131__2415"></a>1.3.1 安全检测</h4> 
<p>学习目标</p> 
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p> 
<p><strong>基础知识</strong></p> 
<p>需求</p> 
<pre><code class="prism language-powershell">	国外软件供应商产品历史上出现了许多恶意后门和网络安全事件，譬如服务源码泄露漏洞、 黑客攻击漏洞、木马事件等，由于这些软件运行本身的安全漏洞，导致在此平台之上的应用也运行在危险环境中，我们把这类的安全问题统统成为供应链安全问题 <span class="token operator">--</span> 非项目代码本身导致的安全问题。由于供应链安全事件愈演愈烈，从2021年逐渐引起大家注意。
</code></pre> 
<p><img src="https://images2.imgbox.com/80/3c/z0UtmhR9_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-powershell">Synopsys 2022年对市场上17个行业2400多个商用产品的代码源进行了分析。开源软件代码使用率超过78%，81%的代码包含至少一个安全漏洞，而且53%的代码存在许可证冲突问题。许可证冲突问题会影响商务软件的使用。
</code></pre> 
<p><img src="https://images2.imgbox.com/42/69/WVGVEfxm_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-powershell">	虽然供应链方面的安全隐患非常多，但是我们可以站在用户访问流程的角度，直接从入口进行控制，只要我们能够将常见的用户请求进行精细化的限制的话，我们可以极大程度的降低软件项目所面对的安全攻击手段。
	对于基于kubernetes的容器应用来说，我们还可以在Ingress层面进行更加高层次的，专门针对用户请求数据的安全访问控制。
</code></pre> 
<p>为什么需要使用Ingress暴露服务？</p> 
<pre><code class="prism language-powershell">Kubernetes主要通过两种方式实现集群内外的流量访问：
	1 支持通过NodePort、LoadBalancer等方式向集群外部暴露内部服务
	2 支持以ingress通过单一IP为多个服务提供基于http形式的访问
		<span class="token operator">-</span> 通过主机名和路径将流量路由到特定服务，使得服务访问更加灵活，同时还可以用来提供https服务。
</code></pre> 
<pre><code class="prism language-powershell">ingress的两大实现软件：
	Kubernetes Ingress Nginx
		kubernetes社区开发和维护<span class="token punctuation">(</span>Nginx帮忙管理<span class="token punctuation">)</span>的ingress-nginx，通过nginx的负载均衡和反向代理能力实现流量控制
		<span class="token operator">-</span> kubernetes/ingress-nginx
		<span class="token operator">-</span> https:<span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com/kubernetes/ingress-nginx
	Nginx Ingress Controller
		NGINX公司开发和维护的一种Ingress Controller。实现了nginx更多的能力，包括VS和VSR等，这些都是k8s的ingress默认不支持的功能。
		<span class="token operator">-</span> 它主要有两个发行：基于NGINX开源<span class="token punctuation">(</span>免费<span class="token punctuation">)</span>和基于NGINX Plus<span class="token punctuation">(</span>商业<span class="token punctuation">)</span>
		<span class="token operator">-</span> nginxinc/kubernetes-ingress	
        <span class="token operator">-</span> https:<span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com/nginxinc/kubernetes-ingress/
        <span class="token operator">-</span> https:<span class="token operator">/</span><span class="token operator">/</span>docs<span class="token punctuation">.</span>nginx<span class="token punctuation">.</span>com/nginx-ingress-controller/
</code></pre> 
<p>nginx 控制器的优势</p> 
<pre><code class="prism language-powershell">	Nginx Ingress Controller和其他Ingress Controller之间的主要区别在于它们的开发和部署模型，尤其是这些模型可以基于不同的目标和优先级实现nginx善于负载均衡和反向代理。
	开发理念
		<span class="token operator">-</span> NGINX 项目和产品的首要任务是提供一个快速、轻量级的工具，并具有长期的稳定性和一致性。
	集成代码库
		<span class="token operator">-</span> 所有代码都是NGINX自己的代码和校验过的代码，保证控制器环境的高度稳定。
	高级流量管理
		<span class="token operator">-</span> 有别于其他Ingress通过注释、CM、template定制高级功能。
		<span class="token operator">-</span> Nginx控制器提供原生、类型安全和缩进的配置风格，高级功能配置
		<span class="token operator">-</span> 包括 TCP/UDP、断路、A/B测试、蓝绿部署、双向TLS认证和WAF等。
	持续的生产准备
		<span class="token operator">-</span> 每个版本都按照可支持的生产标准进行构建和维护。
</code></pre> 
<p><img src="https://images2.imgbox.com/ae/d8/ZIfhySxp_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-powershell">	根据2022年&lt;&lt;sysdig云原生和使用报告&gt;&gt;的统计数据显示：在生产环境中有了更多的命名空间，每个命名空间有了更多的 Deployments，每个命名空间下的 Deployments 构成了用户服务应用的部署单元。
	所以说如何让流量入口适应新形势下的kubernetes应用就是非常重要的选项了。
</code></pre> 
<p><strong>简单实践</strong></p> 
<p>清理旧环境</p> 
<pre><code class="prism language-powershell">清理旧有环境
cd <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>kubernetes/app_secure/
kubectl delete <span class="token operator">-</span>f <span class="token punctuation">.</span><span class="token operator">/</span>

清理旧有ingress控制器
kubectl delete <span class="token operator">-</span>f ingress/deploy-daemonset<span class="token punctuation">.</span>yaml
</code></pre> 
<p>准备环境</p> 
<pre><code class="prism language-powershell">获取环境文件
cd <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>kubernetes/process_secure/
git clone https:<span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com/nginxinc/kubernetes-ingress<span class="token punctuation">.</span>git <span class="token operator">--</span>branch v2<span class="token punctuation">.</span>4<span class="token punctuation">.</span>1
cd kubernetes-ingress/deployments
</code></pre> 
<pre><code class="prism language-powershell">部署基础环境
kubectl apply <span class="token operator">-</span>f common/ns-and-sa<span class="token punctuation">.</span>yaml
kubectl apply <span class="token operator">-</span>f rbac/rbac<span class="token punctuation">.</span>yaml
kubectl apply <span class="token operator">-</span>f rbac/ap-rbac<span class="token punctuation">.</span>yaml
kubectl apply <span class="token operator">-</span>f rbac/apdos-rbac<span class="token punctuation">.</span>yaml
</code></pre> 
<pre><code class="prism language-powershell">部署通用资源
kubectl apply <span class="token operator">-</span>f common/default-server-secret<span class="token punctuation">.</span>yaml
kubectl apply <span class="token operator">-</span>f common/nginx-config<span class="token punctuation">.</span>yaml
kubectl apply <span class="token operator">-</span>f common/ingress-<span class="token keyword">class</span><span class="token punctuation">.</span>yaml
</code></pre> 
<pre><code class="prism language-powershell">创建自定义资源
kubectl apply <span class="token operator">-</span>f common/crds/k8s<span class="token punctuation">.</span>nginx<span class="token punctuation">.</span>org_virtualservers<span class="token punctuation">.</span>yaml
kubectl apply <span class="token operator">-</span>f common/crds/k8s<span class="token punctuation">.</span>nginx<span class="token punctuation">.</span>org_virtualserverroutes<span class="token punctuation">.</span>yaml
kubectl apply <span class="token operator">-</span>f common/crds/k8s<span class="token punctuation">.</span>nginx<span class="token punctuation">.</span>org_transportservers<span class="token punctuation">.</span>yaml
kubectl apply <span class="token operator">-</span>f common/crds/k8s<span class="token punctuation">.</span>nginx<span class="token punctuation">.</span>org_policies<span class="token punctuation">.</span>yaml
kubectl apply <span class="token operator">-</span>f common/crds/k8s<span class="token punctuation">.</span>nginx<span class="token punctuation">.</span>org_globalconfigurations<span class="token punctuation">.</span>yaml
</code></pre> 
<pre><code class="prism language-powershell">创建应用保护资源对象
kubectl apply <span class="token operator">-</span>f common/crds/appprotect<span class="token punctuation">.</span>f5<span class="token punctuation">.</span>com_aplogconfs<span class="token punctuation">.</span>yaml
kubectl apply <span class="token operator">-</span>f common/crds/appprotect<span class="token punctuation">.</span>f5<span class="token punctuation">.</span>com_appolicies<span class="token punctuation">.</span>yaml
kubectl apply <span class="token operator">-</span>f common/crds/appprotect<span class="token punctuation">.</span>f5<span class="token punctuation">.</span>com_apusersigs<span class="token punctuation">.</span>yaml
</code></pre> 
<pre><code class="prism language-powershell">创建洪水攻击防护资源对象
kubectl apply <span class="token operator">-</span>f common/crds/appprotectdos<span class="token punctuation">.</span>f5<span class="token punctuation">.</span>com_apdoslogconfs<span class="token punctuation">.</span>yaml
kubectl apply <span class="token operator">-</span>f common/crds/appprotectdos<span class="token punctuation">.</span>f5<span class="token punctuation">.</span>com_apdospolicy<span class="token punctuation">.</span>yaml
kubectl apply <span class="token operator">-</span>f common/crds/appprotectdos<span class="token punctuation">.</span>f5<span class="token punctuation">.</span>com_dosprotectedresources<span class="token punctuation">.</span>yaml
</code></pre> 
<p>部署环境</p> 
<pre><code class="prism language-powershell">部署应用保护的环境
kubectl apply <span class="token operator">-</span>f deployment/appprotect-dos-arb<span class="token punctuation">.</span>yaml
kubectl apply <span class="token operator">-</span>f service/appprotect-dos-arb-svc<span class="token punctuation">.</span>yaml
</code></pre> 
<pre><code class="prism language-powershell">修改ingress的入口 service/nodeport<span class="token punctuation">.</span>yaml
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
spec:
  externalIPs: <span class="token punctuation">[</span><span class="token string">'10.0.0.12'</span><span class="token punctuation">]</span>  <span class="token comment"># 增加该条属性</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<pre><code class="prism language-powershell">deployment方式部署ingress控制器
kubectl apply <span class="token operator">-</span>f deployment/nginx-ingress<span class="token punctuation">.</span>yaml
kubectl create <span class="token operator">-</span>f service/nodeport<span class="token punctuation">.</span>yaml

daemonset方式部署ingress控制器
kubectl apply <span class="token operator">-</span>f daemon-<span class="token function">set</span><span class="token operator">/</span>nginx-ingress<span class="token punctuation">.</span>yaml

注意：
	二选一即可，由于daemonset自动做了端口的映射，所以不需要做service
</code></pre> 
<pre><code class="prism language-powershell">环境检查
<span class="token punctuation">]</span><span class="token comment"># kubectl get pods --namespace=nginx-ingress</span>
NAME                                  READY   STATUS    RESTARTS   AGE
appprotect-dos-arb-78fb9d4cbf-82xbt   1/1     Running   0          3m31s
nginx-ingress-6644665fb7-rrtsm        1/1     Running   0          2m34s
</code></pre> 
<p>其他</p> 
<pre><code class="prism language-powershell">环境的收尾
kubectl delete namespace nginx-ingress
kubectl delete clusterrole nginx-ingress
kubectl delete clusterrolebinding nginx-ingress
kubectl delete <span class="token operator">-</span>f common/crds/
</code></pre> 
<p><strong>小结</strong></p> 
<pre><code>
</code></pre> 
<h4><a id="133__2607"></a>1.3.3 简单实践</h4> 
<p>学习目标</p> 
<p>这一节，我们从 准备工作、简单实践、小结 三个方面来学习。</p> 
<p><strong>基础知识</strong></p> 
<p>准备服务模板文件</p> 
<pre><code class="prism language-powershell">定制资源清单文件 01_ingress_web_resource<span class="token punctuation">.</span>yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: django
spec:
  replicas: 2
  selector:
    matchLabels:
      app: django
  template:
    metadata:
      labels:
        app: django
    spec:
      containers:
      <span class="token operator">-</span> name: django
        image: kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/django_web:v0<span class="token punctuation">.</span>1
        imagePullPolicy: IfNotPresent
        ports:
        <span class="token operator">-</span> containerPort: 8000
<span class="token operator">--</span><span class="token operator">-</span>
apiVersion: v1
kind: Service
metadata:
  name: django-svc
spec:
  ports:
  <span class="token operator">-</span> port: 8000
    targetPort: 8000
    protocol: TCP
    name: http
  selector:
    app: django
<span class="token operator">--</span><span class="token operator">-</span>
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      <span class="token operator">-</span> name: nginx
        image: kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/nginx_web:v0<span class="token punctuation">.</span>1
        imagePullPolicy: IfNotPresent
        ports:
        <span class="token operator">-</span> containerPort: 80
<span class="token operator">--</span><span class="token operator">-</span>
apiVersion: v1
kind: Service
metadata:
  name: nginx-svc
  labels:
spec:
  ports:
  <span class="token operator">-</span> port: 80
    targetPort: 80
    protocol: TCP
    name: http
  selector:
    app: nginx
</code></pre> 
<pre><code class="prism language-powershell">应用资源清单文件
kubectl apply <span class="token operator">-</span>f 01_ingress_web_resource<span class="token punctuation">.</span>yaml
</code></pre> 
<pre><code class="prism language-powershell">检查效果
<span class="token punctuation">]</span><span class="token comment"># kubectl get deploy,svc</span>
NAME                     READY   UP-TO-DATE   AVAILABLE   AGE
deployment<span class="token punctuation">.</span>apps/django   2/2     2            2           30s
deployment<span class="token punctuation">.</span>apps/nginx    2/2     2            2           30s

NAME                 <span class="token function">TYPE</span>        CLUSTER-IP       EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>    AGE
service/django-svc   ClusterIP   10<span class="token punctuation">.</span>105<span class="token punctuation">.</span>153<span class="token punctuation">.</span>107   &lt;none&gt;        8000/TCP   30s
service/kubernetes   ClusterIP   10<span class="token punctuation">.</span>96<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1        &lt;none&gt;        443/TCP    49d
service/nginx-svc    ClusterIP   10<span class="token punctuation">.</span>97<span class="token punctuation">.</span>65<span class="token punctuation">.</span>163     &lt;none&gt;        80/TCP     30s

这里是使用ingressclasses的方式进行ingress方式选择的
<span class="token punctuation">]</span><span class="token comment"># kubectl get ingressclasses.networking.k8s.io</span>
NAME    CONTROLLER                     PARAMETERS   AGE
nginx   nginx<span class="token punctuation">.</span>org/ingress-controller   &lt;none&gt;       26h
</code></pre> 
<pre><code class="prism language-powershell">功能页面访问
<span class="token punctuation">]</span><span class="token comment"># curl 10.105.153.107:8000</span>
Hello Django<span class="token punctuation">,</span> django-548fb788f5-4mckj-1<span class="token punctuation">.</span>10<span class="token punctuation">.</span>4
<span class="token punctuation">]</span><span class="token comment"># curl 10.97.65.163</span>
Hello Nginx<span class="token punctuation">,</span> nginx-7f7b4d6686-56jc6-1<span class="token punctuation">.</span>23<span class="token punctuation">.</span>1
</code></pre> 
<p>定制单域名多url的ingress</p> 
<pre><code class="prism language-powershell">定制资源清单文件 02_ingress_mulurl<span class="token punctuation">.</span>yaml
apiVersion: networking<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io/v1
kind: Ingress
metadata:
  name: ingress-test
  annotations:
    <span class="token comment"># nginx controller的反向代理，默认没有进行重写，我们需要定制重写机制</span>
    nginx<span class="token punctuation">.</span>org/rewrites: <span class="token string">"serviceName=nginx-svc rewrite=/"</span>
spec:
  <span class="token comment"># 对于nginx的入口控制器，它是以ingressClassName的方式来选择如何使用的</span>
  <span class="token comment"># 后面的定制格式与kubernetes的ingress格式一致</span>
  ingressClassName: nginx
  rules:
  <span class="token operator">-</span> host: shuji<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com
    http:
      paths:
      <span class="token operator">-</span> path: <span class="token operator">/</span>django
        pathType: Prefix
        backend:
          service:
            name: django-svc
            port:
              number: 8000
      <span class="token operator">-</span> path: <span class="token operator">/</span>nginx
        pathType: Prefix
        backend:
          service:
            name: nginx-svc
            port:
              number: 80
</code></pre> 
<pre><code class="prism language-powershell">应用资源清单文件
kubectl apply <span class="token operator">-</span>f 02_ingress_mulurl<span class="token punctuation">.</span>yaml
</code></pre> 
<pre><code class="prism language-powershell">检查效果
<span class="token punctuation">]</span><span class="token comment"># kubectl describe ingress ingress-test</span>
Name:             ingress-test
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
Ingress <span class="token keyword">Class</span>:    nginx
Default backend:  &lt;default&gt;
Rules:
  Host                   Path  Backends
  <span class="token operator">--</span><span class="token operator">--</span>                   <span class="token operator">--</span><span class="token operator">--</span>  <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
  shuji<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com
                         <span class="token operator">/</span>django   django-svc:8000 <span class="token punctuation">(</span>10<span class="token punctuation">.</span>244<span class="token punctuation">.</span>3<span class="token punctuation">.</span>11:8000<span class="token punctuation">,</span>10<span class="token punctuation">.</span>244<span class="token punctuation">.</span>4<span class="token punctuation">.</span>11:8000<span class="token punctuation">)</span>
                         <span class="token operator">/</span>nginx    nginx-svc:80 <span class="token punctuation">(</span>10<span class="token punctuation">.</span>244<span class="token punctuation">.</span>3<span class="token punctuation">.</span>12:80<span class="token punctuation">,</span>10<span class="token punctuation">.</span>244<span class="token punctuation">.</span>5<span class="token punctuation">.</span>10:80<span class="token punctuation">)</span>
Annotations:             nginx<span class="token punctuation">.</span>org/rewrites: serviceName=nginx-svc rewrite=<span class="token operator">/</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<pre><code class="prism language-powershell">定制专属的域名解析，因为我们对于ingress的入口进行限制了，所以hosts主机名解析信息如下：
<span class="token function">echo</span> <span class="token string">'10.0.0.12 shuji.superopsmsb.com'</span> &gt;&gt; <span class="token operator">/</span>etc/hosts
</code></pre> 
<pre><code class="prism language-powershell">访问效果
<span class="token punctuation">]</span><span class="token comment"># curl shuji.superopsmsb.com/django</span>
Hello Django<span class="token punctuation">,</span> django-548fb788f5-xfdjs-1<span class="token punctuation">.</span>10<span class="token punctuation">.</span>4
<span class="token punctuation">]</span><span class="token comment"># curl shuji.superopsmsb.com/nginx</span>
Hello Nginx<span class="token punctuation">,</span> nginx-7f7b4d6686-qfsfn-1<span class="token punctuation">.</span>23<span class="token punctuation">.</span>1
</code></pre> 
<p>配置解析</p> 
<pre><code class="prism language-powershell"><span class="token punctuation">]</span><span class="token comment"># kubectl -n nginx-ingress exec -it nginx-ingress-6644665fb7-54scz -- cat /etc/nginx/conf.d/default-ingress-test.conf</span>
<span class="token comment"># configuration for default/ingress-test</span>

upstream default-ingress-<span class="token function">test-shuji</span><span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com-django-svc-8000 <span class="token punctuation">{<!-- --></span>
        zone default-ingress-<span class="token function">test-shuji</span><span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com-django-svc-8000 256k<span class="token punctuation">;</span>
        random two least_conn<span class="token punctuation">;</span>

        server 10<span class="token punctuation">.</span>244<span class="token punctuation">.</span>3<span class="token punctuation">.</span>11:8000 max_fails=1 fail_timeout=10s max_conns=0<span class="token punctuation">;</span>
        server 10<span class="token punctuation">.</span>244<span class="token punctuation">.</span>4<span class="token punctuation">.</span>11:8000 max_fails=1 fail_timeout=10s max_conns=0<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
upstream default-ingress-<span class="token function">test-shuji</span><span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com-nginx-svc-80 <span class="token punctuation">{<!-- --></span>
        zone default-ingress-<span class="token function">test-shuji</span><span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com-nginx-svc-80 256k<span class="token punctuation">;</span>
        random two least_conn<span class="token punctuation">;</span>

        server 10<span class="token punctuation">.</span>244<span class="token punctuation">.</span>3<span class="token punctuation">.</span>12:80 max_fails=1 fail_timeout=10s max_conns=0<span class="token punctuation">;</span>
        server 10<span class="token punctuation">.</span>244<span class="token punctuation">.</span>5<span class="token punctuation">.</span>10:80 max_fails=1 fail_timeout=10s max_conns=0<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
server <span class="token punctuation">{<!-- --></span>
        listen 80<span class="token punctuation">;</span>
        listen <span class="token punctuation">[</span>::<span class="token punctuation">]</span>:80<span class="token punctuation">;</span>
        server_tokens on<span class="token punctuation">;</span>
        server_name shuji<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com<span class="token punctuation">;</span>
        <span class="token function">set</span> <span class="token variable">$resource_type</span> <span class="token string">"ingress"</span><span class="token punctuation">;</span>
        <span class="token function">set</span> <span class="token variable">$resource_name</span> <span class="token string">"ingress-test"</span><span class="token punctuation">;</span>
        <span class="token function">set</span> <span class="token variable">$resource_namespace</span> <span class="token string">"default"</span><span class="token punctuation">;</span>
        location <span class="token operator">/</span>django <span class="token punctuation">{<!-- --></span>
                <span class="token function">set</span> <span class="token variable">$service</span> <span class="token string">"django-svc"</span><span class="token punctuation">;</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                proxy_pass http:<span class="token operator">/</span><span class="token operator">/</span>default-ingress-<span class="token function">test-shuji</span><span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com-django-svc-8000<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        location <span class="token operator">/</span>nginx <span class="token punctuation">{<!-- --></span>
                <span class="token function">set</span> <span class="token variable">$service</span> <span class="token string">"nginx-svc"</span><span class="token punctuation">;</span>
				<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                proxy_pass http:<span class="token operator">/</span><span class="token operator">/</span>default-ingress-<span class="token function">test-shuji</span><span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com-nginx-svc-80/<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>简单实践</strong></p> 
<pre><code class="prism language-powershell">定制secret文件
mkdir ingress-tls &amp;&amp; cd ingress-tls
<span class="token punctuation">(</span>umask 077<span class="token punctuation">;</span> openssl genrsa <span class="token operator">-</span>out tls<span class="token punctuation">.</span>key 2048<span class="token punctuation">)</span>
openssl req <span class="token operator">-</span>new <span class="token operator">-</span>x509 <span class="token operator">-</span>key tls<span class="token punctuation">.</span>key <span class="token operator">-</span>out tls<span class="token punctuation">.</span>crt <span class="token operator">-</span>subj <span class="token string">"/CN=shuji.superopsmsb.com"</span> <span class="token operator">-</span>days 365
kubectl create secret tls ingress-tls <span class="token operator">--</span>cert=<span class="token punctuation">.</span><span class="token operator">/</span>tls<span class="token punctuation">.</span>crt <span class="token operator">--</span>key=<span class="token punctuation">.</span><span class="token operator">/</span>tls<span class="token punctuation">.</span>key
cd <span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<pre><code class="prism language-powershell">创建资源对象文件 03_ingress_tlshosts<span class="token punctuation">.</span>yaml
apiVersion: networking<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io/v1
kind: Ingress
metadata:
  name: ingress-test
  annotations:
    <span class="token comment"># 定制重写规则</span>
    nginx<span class="token punctuation">.</span>org/rewrites: <span class="token string">"serviceName=nginx-svc rewrite=/"</span>
spec:
  ingressClassName: nginx
  <span class="token comment"># 添加tls认证信息</span>
  tls:
  <span class="token operator">-</span> hosts:
    <span class="token operator">-</span> shuji<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com
    secretName: ingress-tls
  rules:
  <span class="token operator">-</span> host: shuji<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com
    http:
      paths:
      <span class="token operator">-</span> path: <span class="token operator">/</span>django
        pathType: Prefix
        backend:
          service:
            name: django-svc
            port:
              number: 8000
      <span class="token operator">-</span> path: <span class="token operator">/</span>nginx
        pathType: Prefix
        backend:
          service:
            name: nginx-svc
            port:
              number: 80
</code></pre> 
<pre><code class="prism language-powershell">应用ingress资源对象
kubectl delete <span class="token operator">-</span>f 02_ingress_mulurl<span class="token punctuation">.</span>yaml
kubectl apply <span class="token operator">-</span>f 03_ingress_tlshosts<span class="token punctuation">.</span>yaml
</code></pre> 
<pre><code class="prism language-powershell">查看效果
<span class="token punctuation">]</span><span class="token comment"># kubectl describe  ingress ingress-test</span>
Name:             ingress-test
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
TLS:
  ingress-tls terminates shuji<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com
Rules:
  Host                   Path  Backends
  <span class="token operator">--</span><span class="token operator">--</span>                   <span class="token operator">--</span><span class="token operator">--</span>  <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
  shuji<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com
                         <span class="token operator">/</span>django   django-svc:8000 <span class="token punctuation">(</span>10<span class="token punctuation">.</span>244<span class="token punctuation">.</span>3<span class="token punctuation">.</span>11:8000<span class="token punctuation">,</span>10<span class="token punctuation">.</span>244<span class="token punctuation">.</span>4<span class="token punctuation">.</span>11:8000<span class="token punctuation">)</span>
                         <span class="token operator">/</span>nginx    nginx-svc:80 <span class="token punctuation">(</span>10<span class="token punctuation">.</span>244<span class="token punctuation">.</span>3<span class="token punctuation">.</span>12:80<span class="token punctuation">,</span>10<span class="token punctuation">.</span>244<span class="token punctuation">.</span>5<span class="token punctuation">.</span>10:80<span class="token punctuation">)</span>
Annotations:             nginx<span class="token punctuation">.</span>org/rewrites: serviceName=nginx-svc rewrite=<span class="token operator">/</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<pre><code class="prism language-powershell">访问效果
<span class="token punctuation">]</span><span class="token comment"># curl -k https://shuji.superopsmsb.com/django</span>
Hello Django<span class="token punctuation">,</span> django-548fb788f5-xfdjs-1<span class="token punctuation">.</span>10<span class="token punctuation">.</span>4
<span class="token punctuation">]</span><span class="token comment"># curl -k https://shuji.superopsmsb.com/nginx</span>
Hello Nginx<span class="token punctuation">,</span> nginx-7f7b4d6686-qfsfn-1<span class="token punctuation">.</span>23<span class="token punctuation">.</span>1
</code></pre> 
<p>环境收尾</p> 
<pre><code class="prism language-powershell">kubectl delete <span class="token operator">-</span>f 01_ingress_web_resource<span class="token punctuation">.</span>yaml <span class="token operator">-</span>f 03_ingress_tlshosts<span class="token punctuation">.</span>yaml
</code></pre> 
<p><strong>小结</strong></p> 
<pre><code>
</code></pre> 
<h4><a id="133__2925"></a>1.3.3 虚拟主机</h4> 
<p>学习目标</p> 
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p> 
<p><strong>基础知识</strong></p> 
<p>需求</p> 
<pre><code class="prism language-powershell">	Nginx Ingress Controller提供了基于虚拟主机的路由分发策略，可以让不同的应用位于不同的namespace环境，然后基于虚拟主机的方式在k8s中存在，然后定制一个专属的总路由进行配置，从而实现流量的分发。这种方式与传统意义上的应用流量分发基本一致。
</code></pre> 
<p>配置解析</p> 
<pre><code class="prism language-powershell">虚拟主机属性解析
apiVersion: k8s<span class="token punctuation">.</span>nginx<span class="token punctuation">.</span>org/v1
kind: VirtualServer
metadata:
  name: &lt;vs_name&gt;
  namespace: &lt;namespace&gt;
spec:
  host: 访问域名
  tls:
    secret: https依赖的tls
  routes:
  <span class="token operator">-</span> path: <span class="token operator">/</span>分发url
    route: namespace/虚拟主机名称
</code></pre> 
<pre><code class="prism language-powershell">虚拟主机路由配置
apiVersion: k8s<span class="token punctuation">.</span>nginx<span class="token punctuation">.</span>org/v1
kind: VirtualServerRoute
metadata:
  name: &lt;vs_name&gt;
  namespace: &lt;namespace&gt;
spec:
  host: 访问域名
  upstreams:
  <span class="token operator">-</span> name: &lt;应用service组名&gt;
    service: &lt;应用service组名&gt;
    port: &lt;应用service端口&gt;
  subroutes:
  <span class="token comment"># 反向代理配置</span>
  <span class="token operator">-</span> path: <span class="token operator">/</span>&lt;应用url&gt;
    action:
      proxy:
        upstream: &lt;应用service组名&gt;
        requestHeaders:
          pass: true
          <span class="token function">set</span>:
          <span class="token operator">-</span> name: 定制请求头
            value: 定制请求值
        responseHeaders:
          add:  <span class="token comment"># 增加响应头</span>
          <span class="token operator">-</span> name: 定制响应头
            value: 定制响应结果
            always: true  <span class="token comment"># 是否永远存在</span>
        rewritePath: <span class="token operator">/</span>  <span class="token comment"># 设定转发规则</span>
  <span class="token comment"># 根据条件请求路由分发</span>
  <span class="token operator">-</span> path: <span class="token operator">/</span>&lt;应用url&gt;
    matches:
    <span class="token operator">-</span> conditions:
      <span class="token operator">-</span> cookie: version
        value: v2
      action:
        pass: django-v2
</code></pre> 
<p>案例需求</p> 
<pre><code class="prism language-powershell">应用解析
	nginx命名空间
		nginx的deployment和svc，以及专属的虚拟主机路由
	django命名空间
		django的deployment和svc，以及专属的虚拟主机路由
		django同时部署两个版本，v1和v2
	shuji命名空间
		定制专属虚拟主机
访问解析
	https:<span class="token operator">/</span><span class="token operator">/</span>shuji<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/nginx <span class="token operator">-</span> 默认访问nginx命名空间的nginx应用
	https:<span class="token operator">/</span><span class="token operator">/</span>shuji<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/django <span class="token operator">-</span> 默认访问django命名空间的django的v2版本
	访问django的时候，携带<span class="token string">"version=v1"</span>请求头 <span class="token operator">-</span> 访问django命名空间的django的v1版本
</code></pre> 
<p><strong>简单实践</strong></p> 
<p>准备基础环境</p> 
<pre><code class="prism language-powershell">定制资源清单文件 04_ingress_vs_base<span class="token punctuation">.</span>yaml
apiVersion: v1
kind: Namespace
metadata:
  name: django
<span class="token operator">--</span><span class="token operator">-</span>
apiVersion: apps/v1
kind: Deployment
metadata:
  name: django-v1
  namespace: django
spec:
  replicas: 2
  selector:
    matchLabels:
      app: django-v1
  template:
    metadata:
      labels:
        app: django-v1
    spec:
      containers:
      <span class="token operator">-</span> name: django
        image: kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/django_web:v0<span class="token punctuation">.</span>1
        imagePullPolicy: IfNotPresent
        ports:
        <span class="token operator">-</span> containerPort: 8000
<span class="token operator">--</span><span class="token operator">-</span>
apiVersion: v1
kind: Service
metadata:
  name: django-v1-svc
  namespace: django
spec:
  ports:
  <span class="token operator">-</span> port: 8000
    targetPort: 8000
    protocol: TCP
    name: http
  selector:
    app: django-v1
<span class="token operator">--</span><span class="token operator">-</span>
apiVersion: apps/v1
kind: Deployment
metadata:
  name: django-v2
  namespace: django
spec:
  replicas: 2
  selector:
    matchLabels:
      app: django-v1
  template:
    metadata:
      labels:
        app: django-v1
    spec:
      containers:
      <span class="token operator">-</span> name: django
        image: kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/django_web:v0<span class="token punctuation">.</span>2
        imagePullPolicy: IfNotPresent
        ports:
        <span class="token operator">-</span> containerPort: 8000
<span class="token operator">--</span><span class="token operator">-</span>
apiVersion: v1
kind: Service
metadata:
  name: django-v1-svc
  namespace: django
spec:
  ports:
  <span class="token operator">-</span> port: 8000
    targetPort: 8000
    protocol: TCP
    name: http
  selector:
    app: django-v1
<span class="token operator">--</span><span class="token operator">-</span>
apiVersion: v1
kind: Namespace
metadata:
  name: nginx
<span class="token operator">--</span><span class="token operator">-</span>
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
  namespace: nginx
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      <span class="token operator">-</span> name: nginx
        image: kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/nginx_web:v0<span class="token punctuation">.</span>1
        imagePullPolicy: IfNotPresent
        ports:
        <span class="token operator">-</span> containerPort: 80
<span class="token operator">--</span><span class="token operator">-</span>
apiVersion: v1
kind: Service
metadata:
  name: nginx-svc
  namespace: nginx
spec:
  ports:
  <span class="token operator">-</span> port: 80
    targetPort: 80
    protocol: TCP
    name: http
  selector:
    app: nginx
<span class="token operator">--</span><span class="token operator">-</span>
apiVersion: v1
kind: Namespace
metadata:
  name: shuji
</code></pre> 
<p>准备子路由主机</p> 
<pre><code class="prism language-powershell">定制nginx虚拟主机路由资源清单文件 05_ingress_vs_nginx<span class="token punctuation">.</span>yaml
apiVersion: k8s<span class="token punctuation">.</span>nginx<span class="token punctuation">.</span>org/v1
kind: VirtualServerRoute
metadata:
  name: nginx
  namespace: nginx
spec:
  host: shuji<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com
  upstreams:
  <span class="token operator">-</span> name: nginx
    service: nginx-svc
    port: 80
  subroutes:
  <span class="token operator">-</span> path: <span class="token operator">/</span>nginx
    action:
      proxy:
        upstream: nginx
        requestHeaders:
          pass: true
          <span class="token function">set</span>:
          <span class="token operator">-</span> name: My-Header
            value: NGINX-Best
        responseHeaders:
          add:
          <span class="token operator">-</span> name: My-Header
            value: $<span class="token punctuation">{<!-- --></span>http_user_agent<span class="token punctuation">}</span>
          <span class="token operator">-</span> name: IC-Nginx-Version
            value: $<span class="token punctuation">{<!-- --></span>nginx_version<span class="token punctuation">}</span>
            always: true
        rewritePath: <span class="token operator">/</span>
</code></pre> 
<pre><code class="prism language-powershell">定制django虚拟主机路由资源清单文件 06_ingress_vs_django<span class="token punctuation">.</span>yaml
apiVersion: k8s<span class="token punctuation">.</span>nginx<span class="token punctuation">.</span>org/v1
kind: VirtualServerRoute
metadata:
  name: django
  namespace: django
spec:
  host: shuji<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com
  upstreams:
  <span class="token operator">-</span> name: django-v1
    service: django-v1-svc
    port: 8000
  <span class="token operator">-</span> name: django-v2
    service: django-v2-svc
    port: 8000
  subroutes:
  <span class="token operator">-</span> path: <span class="token operator">/</span>django
    matches:
    <span class="token operator">-</span> conditions:
      <span class="token operator">-</span> cookie: version
        value: v2
      action:
        pass: django-v2
    action:
      pass: django-v1
</code></pre> 
<p>定制虚拟服务主机</p> 
<pre><code class="prism language-powershell">定制虚拟主机的资源清单 07_ingress_vs_shuji<span class="token punctuation">.</span>yaml
apiVersion: k8s<span class="token punctuation">.</span>nginx<span class="token punctuation">.</span>org/v1
kind: VirtualServer
metadata:
  name: shuji
  namespace: shuji
spec:
  host: shuji<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com
  tls:
    secret: ingress-tls
  routes:
  <span class="token operator">-</span> path: <span class="token operator">/</span>nginx
    route: nginx/nginx
  <span class="token operator">-</span> path: <span class="token operator">/</span>django
    route: django/django
</code></pre> 
<pre><code class="prism language-powershell">创建secret
kubectl <span class="token operator">-</span>n shuji create secret tls ingress-tls <span class="token operator">--</span>cert=<span class="token punctuation">.</span><span class="token operator">/</span>ingress-tls/tls<span class="token punctuation">.</span>crt <span class="token operator">--</span>key=<span class="token punctuation">.</span><span class="token operator">/</span>ingress-tls/tls<span class="token punctuation">.</span>key
</code></pre> 
<p>测试效果</p> 
<pre><code class="prism language-powershell">应用资源清单文件
kubectl apply <span class="token operator">-</span>f 04_ingress_vs_base<span class="token punctuation">.</span>yaml <span class="token operator">-</span>f 05_ingress_vs_nginx<span class="token punctuation">.</span>yaml <span class="token operator">-</span>f 06_ingress_vs_django<span class="token punctuation">.</span>yaml  <span class="token operator">-</span>f 07_ingress_vs_shuji<span class="token punctuation">.</span>yaml
</code></pre> 
<pre><code class="prism language-powershell">检查命名空间
kubectl get ns <span class="token punctuation">|</span> egrep <span class="token string">'shuji|django|nginx'</span>

检查资源对象
kubectl get vs <span class="token operator">-</span>n shuji
kubectl get vsr<span class="token punctuation">,</span>deploy<span class="token punctuation">,</span>svc <span class="token operator">-</span>n django
kubectl get vsr<span class="token punctuation">,</span>deploy<span class="token punctuation">,</span>svc <span class="token operator">-</span>n nginx
</code></pre> 
<pre><code class="prism language-powershell">普通http检查
<span class="token punctuation">]</span><span class="token comment"># curl -k https://shuji.superopsmsb.com/nginx</span>
Hello Nginx<span class="token punctuation">,</span> nginx-7f7b4d6686-g66wh-1<span class="token punctuation">.</span>23<span class="token punctuation">.</span>1
<span class="token punctuation">]</span><span class="token comment"># curl -k https://shuji.superopsmsb.com/django</span>
Hello Django<span class="token punctuation">,</span> django-v1-fddf5c955-h8rrz-1<span class="token punctuation">.</span>10<span class="token punctuation">.</span>4

指定请求版本检查
<span class="token punctuation">]</span><span class="token comment"># curl -k --cookie "version=v1" https://shuji.superopsmsb.com/django</span>
Hello Django<span class="token punctuation">,</span> django-v1-fddf5c955-h8rrz-1<span class="token punctuation">.</span>10<span class="token punctuation">.</span>4
</code></pre> 
<p>环境收尾</p> 
<pre><code class="prism language-powershell">kubectl delete <span class="token operator">-</span>f 07_ingress_vs_shuji<span class="token punctuation">.</span>yaml <span class="token operator">-</span>f 06_ingress_vs_django<span class="token punctuation">.</span>yaml <span class="token operator">-</span>f 05_ingress_vs_nginx<span class="token punctuation">.</span>yaml <span class="token operator">-</span>f 04_ingress_vs_base<span class="token punctuation">.</span>yaml
</code></pre> 
<pre><code>
</code></pre> 
<h4><a id="134__3273"></a>1.3.4 四层实践</h4> 
<p>学习目标</p> 
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p> 
<p><strong>基础知识</strong></p> 
<p>需求</p> 
<pre><code class="prism language-powershell">	Nginx ingress 不仅仅可以做http级别的ingress，还支持ip:port级别的ingress。这个功能需要GlobalConfiguration能力的支持。
</code></pre> 
<p>准备工作</p> 
<pre><code class="prism language-powershell">改造 deployment资源对象 deployment/nginx-ingress<span class="token punctuation">.</span>yaml
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
spec:
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  template:
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    spec:
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      containers:
      <span class="token operator">-</span> image: nginx/nginx-ingress:2<span class="token punctuation">.</span>4<span class="token punctuation">.</span>1
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        ports:
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token operator">-</span> name: tcp-8001
          containerPort: 8001
        <span class="token operator">-</span> name: tcp-8002
          containerPort: 8002
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
         args:
          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
          <span class="token operator">-</span> <span class="token operator">-</span>global-configuration=$<span class="token punctuation">(</span>POD_NAMESPACE<span class="token punctuation">)</span><span class="token operator">/</span>nginx-configuration
配置解析：
	开启<span class="token operator">-</span>global-configuration启动参数，开启专属容器端口映射
</code></pre> 
<pre><code class="prism language-powershell">改造service资源对象 service/nodeport<span class="token punctuation">.</span>yaml
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
spec:
  externalIPs: <span class="token punctuation">[</span><span class="token string">'10.0.0.12'</span><span class="token punctuation">]</span>
  <span class="token function">type</span>: NodePort
  ports:
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token operator">-</span> port: 8001
    targetPort: 8001
    protocol: TCP
    name: tcp-8001
  <span class="token operator">-</span> port: 8002
    targetPort: 8002
    protocol: TCP
    name: tcp-8002
配置解析：
	开启专属容器端口映射
</code></pre> 
<pre><code class="prism language-powershell">重启环境
kubectl apply <span class="token operator">-</span>f deployment/nginx-ingress<span class="token punctuation">.</span>yaml
kubectl apply <span class="token operator">-</span>f service/nodeport<span class="token punctuation">.</span>yaml
</code></pre> 
<p><strong>简单实践</strong></p> 
<p>创建基础应用环境</p> 
<pre><code class="prism language-powershell">kubectl apply <span class="token operator">-</span>f 01_ingress_web_resource<span class="token punctuation">.</span>yaml
</code></pre> 
<p>创建资源对象文件</p> 
<pre><code class="prism language-powershell">创建 08_ingress_globalconfiguration_listener<span class="token punctuation">.</span>yaml
apiVersion: k8s<span class="token punctuation">.</span>nginx<span class="token punctuation">.</span>org/v1alpha1
kind: GlobalConfiguration
metadata:
  name: nginx-configuration
  namespace: nginx-ingress
spec:
  listeners:
  <span class="token operator">-</span> name: tcp-8001
    port: 8001
    protocol: TCP
  <span class="token operator">-</span> name: tcp-8002
    port: 8002
    protocol: TCP
</code></pre> 
<pre><code class="prism language-powershell">创建专属的代理配置 09_ingress_transportserver<span class="token punctuation">.</span>yaml
apiVersion: k8s<span class="token punctuation">.</span>nginx<span class="token punctuation">.</span>org/v1alpha1
kind: TransportServer
metadata:
  name: nginx
spec:
  listener:
    name: tcp-8001
    protocol: TCP
  upstreams:
  <span class="token operator">-</span> name: nginx
    service: nginx-svc
    port: 80
  action:
    pass: nginx
<span class="token operator">--</span><span class="token operator">-</span>
apiVersion: k8s<span class="token punctuation">.</span>nginx<span class="token punctuation">.</span>org/v1alpha1
kind: TransportServer
metadata:
  name: django
spec:
  listener:
    name: tcp-8002
    protocol: TCP
  upstreams:
  <span class="token operator">-</span> name: django
    service: django-svc
    port: 8000
  action:
    pass: django
</code></pre> 
<pre><code class="prism language-powershell">应用资源清单文件
kubectl apply <span class="token operator">-</span>f 01_ingress_web_resource<span class="token punctuation">.</span>yaml <span class="token operator">-</span>f 08_ingress_globalconfiguration_listener<span class="token punctuation">.</span>yaml <span class="token operator">-</span>f 09_ingress_transportserver<span class="token punctuation">.</span>yaml
</code></pre> 
<pre><code class="prism language-powershell">检查效果
<span class="token punctuation">]</span><span class="token comment"># curl 10.0.0.12:8001</span>
Hello Nginx<span class="token punctuation">,</span> nginx-7f7b4d6686-fkbbj-1<span class="token punctuation">.</span>23<span class="token punctuation">.</span>1
<span class="token punctuation">]</span><span class="token comment"># curl 10.0.0.12:8002</span>
Hello Django<span class="token punctuation">,</span> django-548fb788f5-pdgzw-1<span class="token punctuation">.</span>10<span class="token punctuation">.</span>4
</code></pre> 
<p>环境收尾</p> 
<pre><code class="prism language-powershell">	对于globalconfiguration环境来说，这个资源千万不要删除，如果非要删除的话，可以清理该对象的配置即可，资源对象文件：10_ingress_globalconfiguration_reset<span class="token punctuation">.</span>yaml
apiVersion: k8s<span class="token punctuation">.</span>nginx<span class="token punctuation">.</span>org/v1alpha1
kind: GlobalConfiguration
metadata:
  name: nginx-configuration
  namespace: nginx-ingress
spec:
</code></pre> 
<pre><code class="prism language-powershell">清理环境
kubectl delete <span class="token operator">-</span>f 01_ingress_web_resource<span class="token punctuation">.</span>yaml <span class="token operator">-</span>f 09_ingress_transportserver<span class="token punctuation">.</span>yaml <span class="token operator">-</span>f 10_ingress_globalconfiguration_reset<span class="token punctuation">.</span>yaml
</code></pre> 
<p><strong>小结</strong></p> 
<pre><code>
</code></pre> 
<h4><a id="135__3440"></a>1.3.5 策略实践</h4> 
<p>学习目标</p> 
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p> 
<p><strong>基础知识</strong></p> 
<p>需求</p> 
<pre><code class="prism language-powershell">	Nginx ingress 提供了大量与waf等相关的内容，我们可以在ingress中，为不同的应用定制各自的访问策略信息。
</code></pre> 
<p>属性解读</p> 
<pre><code class="prism language-powershell">apiVersion: k8s<span class="token punctuation">.</span>nginx<span class="token punctuation">.</span>org/v1
kind: Policy
metadata:
  name: &lt;policy_name&gt;
spec:
  rateLimit:
    rate: 100r/s			<span class="token comment"># 每秒 100 个请求的速率</span>
    burst: 50				<span class="token comment"># 超过burst数量的过多的请求会被延迟。</span>
    noDelay: true			<span class="token comment"># 在请求受到限制时禁用延迟过多请求。delay如果两者都设置，则覆盖。	</span>
    key: $<span class="token punctuation">{<!-- --></span>binary_remote_addr<span class="token punctuation">}</span>  <span class="token comment"># 应用速率限制的键。可以是文本、变量${}或组合。</span>
    zoneSize: 10M			<span class="token comment"># 设定共享内存区域的大小</span>
    rejectCode: 444			<span class="token comment"># 设置状态码以响应被拒绝的请求而返回。必须落入范围400..599。默认为503。</span>
</code></pre> 
<pre><code class="prism language-powershell">参考资料：
	https:<span class="token operator">/</span><span class="token operator">/</span>docs<span class="token punctuation">.</span>nginx<span class="token punctuation">.</span>com/nginx-ingress-controller/configuration/policy-resource/
</code></pre> 
<p>工具部署</p> 
<pre><code class="prism language-powershell">git clone https:<span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com/wg/wrk<span class="token punctuation">.</span>git wrk
cd wrk
make
<span class="token function">cp</span> wrk <span class="token operator">/</span>usr/local/bin
</code></pre> 
<pre><code class="prism language-powershell">命令帮助
	语法格式: wrk &lt;选项&gt; &lt;被测HTTP服务的URL&gt;
	语法参数
        <span class="token operator">-</span>c<span class="token punctuation">,</span> <span class="token operator">--</span>connections &lt;N&gt;  跟服务器建立并保持的 TCP 连接数量
        <span class="token operator">-</span>d<span class="token punctuation">,</span> <span class="token operator">--</span>duration    &lt;T&gt;  压测时间
        <span class="token operator">-</span>t<span class="token punctuation">,</span> <span class="token operator">--</span>threads     &lt;N&gt;  使用多少个线程进行压测
        <span class="token operator">-</span>s<span class="token punctuation">,</span> <span class="token operator">--</span>script      &lt;S&gt;  指定 Lua 脚本路径
        <span class="token operator">-</span>H<span class="token punctuation">,</span> <span class="token operator">--</span>header      &lt;H&gt;  为每一个 HTTP 请求添加 HTTP 头
            <span class="token operator">--</span>latency          在压测结束后，打印延迟统计信息
            <span class="token operator">--</span>timeout     &lt;T&gt;  超时时间
        <span class="token operator">-</span>v<span class="token punctuation">,</span> <span class="token operator">--</span>version          打印正在使用的 wrk 的详细版本信息

      &lt;N&gt;代表数字参数，支持国际单位 <span class="token punctuation">(</span>1k<span class="token punctuation">,</span> 1M<span class="token punctuation">,</span> 1G<span class="token punctuation">)</span>
      &lt;T&gt;代表时间参数，支持时间单位 <span class="token punctuation">(</span>2s<span class="token punctuation">,</span> 2m<span class="token punctuation">,</span> 2h<span class="token punctuation">)</span>
</code></pre> 
<p><strong>简单实践</strong></p> 
<p>简单对象</p> 
<pre><code class="prism language-powershell">定制资源对象 11_ingress_vs_nginx<span class="token punctuation">.</span>yaml
apiVersion: k8s<span class="token punctuation">.</span>nginx<span class="token punctuation">.</span>org/v1
kind: VirtualServer
metadata:
  name: shuji
spec:
  host: shuji<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com
  <span class="token comment"># policies:</span>
  <span class="token comment"># - name: rate-limit-policy</span>
  upstreams:
  <span class="token operator">-</span> name: nginx
    service: nginx-svc
    port: 80
  routes:
  <span class="token operator">-</span> path: <span class="token operator">/</span>
    action:
      pass: nginx
</code></pre> 
<pre><code class="prism language-powershell">运行资源对象
kubectl apply <span class="token operator">-</span>f 01_ingress_web_resource<span class="token punctuation">.</span>yaml <span class="token operator">-</span>f 11_ingress_vs_nginx<span class="token punctuation">.</span>yaml
</code></pre> 
<pre><code class="prism language-powershell">测试效果
<span class="token punctuation">]</span><span class="token comment"># wrk -t2 -c10 -d10s http://shuji.superopsmsb.com</span>
Running 10s test @ http:<span class="token operator">/</span><span class="token operator">/</span>shuji<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com				<span class="token comment"># 压测时间10s）</span>
  2 threads and 10 connections								<span class="token comment"># 共1个测试线程，10个连接</span>
  Thread Stats   Avg      Stdev     Max   <span class="token operator">+</span><span class="token operator">/</span><span class="token operator">-</span> Stdev
    Latency     5<span class="token punctuation">.</span>48ms    4<span class="token punctuation">.</span>97ms 109<span class="token punctuation">.</span>56ms   93<span class="token punctuation">.</span>11%			<span class="token comment"># 延迟信息</span>
    Req/Sec     1<span class="token punctuation">.</span>02k   229<span class="token punctuation">.</span>62     1<span class="token punctuation">.</span>48k    70<span class="token punctuation">.</span>50%			<span class="token comment"># 处理中请求</span>
  20466 requests in 10<span class="token punctuation">.</span>05s<span class="token punctuation">,</span> 5<span class="token punctuation">.</span>44MB read			 			<span class="token comment"># 10.05s处理20466个请求</span>
  															<span class="token comment"># 读取5.44MB数据</span>
Requests/sec:   2037<span class="token punctuation">.</span>01										<span class="token comment"># 平均每秒处理完成2037.01个请求</span>
Transfer/sec:    554<span class="token punctuation">.</span>91KB									<span class="token comment"># 平均每秒读取数据554.91KB</span>
</code></pre> 
<p>策略实践</p> 
<pre><code class="prism language-powershell">定制策略文件 12_ingress_policy_limit<span class="token punctuation">.</span>yaml
apiVersion: k8s<span class="token punctuation">.</span>nginx<span class="token punctuation">.</span>org/v1
kind: Policy
metadata:
  name: rate-<span class="token function">limit-policy</span>
spec:
  rateLimit:
    rate: 10r/s
    burst: 50
    noDelay: true
    key: $<span class="token punctuation">{<!-- --></span>binary_remote_addr<span class="token punctuation">}</span>
    zoneSize: 5M
    rejectCode: 444
</code></pre> 
<pre><code class="prism language-powershell">修改虚拟主机文件 11_ingress_vs_nginx<span class="token punctuation">.</span>yaml
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
spec:
  host: shuji<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com
  policies:
  <span class="token operator">-</span> name: rate-<span class="token function">limit-policy</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<pre><code class="prism language-powershell">应用资源清单文件
kubectl apply <span class="token operator">-</span>f 12_ingress_policy_limit<span class="token punctuation">.</span>yaml <span class="token operator">-</span>f 11_ingress_vs_nginx<span class="token punctuation">.</span>yaml
</code></pre> 
<pre><code class="prism language-powershell">测试效果：
<span class="token punctuation">]</span><span class="token comment"># wrk -t2 -c10 -d10s http://shuji.superopsmsb.com</span>
Running 10s test @ http:<span class="token operator">/</span><span class="token operator">/</span>shuji<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com
  2 threads and 10 connections
  Thread Stats   Avg      Stdev     Max   <span class="token operator">+</span><span class="token operator">/</span><span class="token operator">-</span> Stdev
    Latency     5<span class="token punctuation">.</span>72ms    3<span class="token punctuation">.</span>58ms  28<span class="token punctuation">.</span>40ms   83<span class="token punctuation">.</span>44%
    Req/Sec    11<span class="token punctuation">.</span>90     35<span class="token punctuation">.</span>35   282<span class="token punctuation">.</span>00     98<span class="token punctuation">.</span>02%
  151 requests in 10<span class="token punctuation">.</span>05s<span class="token punctuation">,</span> 41<span class="token punctuation">.</span>14KB read
  Socket errors: connect 0<span class="token punctuation">,</span> read 29404<span class="token punctuation">,</span> <span class="token function">write</span> 0<span class="token punctuation">,</span> timeout 0
Requests/sec:     15<span class="token punctuation">.</span>02
Transfer/sec:      4<span class="token punctuation">.</span>09KB
结果显示：
	Requests/sec 的值从原来的 2000左右，下降到了10左右，说明限制生效了。
</code></pre> 
<pre><code class="prism language-powershell">查看控制器pod
<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -n nginx-ingress</span>
NAME                            READY   STATUS    RESTARTS   AGE
nginx-ingress-79fbbb9dc-s4qnz   1/1     Running   0          64m

查看日志效果
<span class="token punctuation">]</span><span class="token comment"># kubectl logs nginx-ingress-79fbbb9dc-s4qnz -n nginx-ingress</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
2022/10/24 06:33:31 <span class="token namespace">[error]</span> 138<span class="token comment">#138: *81481 limiting requests, excess: 50.470 by zone "pol_rl_default_rate-limit-policy_default_shuji", client: 10.244.0.1, server: shuji.superopsmsb.com, request: "GET / HTTP/1.1", host: "shuji.superopsmsb.com"</span>
10<span class="token punctuation">.</span>244<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1 <span class="token operator">-</span> <span class="token operator">-</span> <span class="token punctuation">[</span>24/Oct/2022:06:33:31 <span class="token operator">+</span>0000<span class="token punctuation">]</span> <span class="token string">"GET / HTTP/1.1"</span> 444 0 <span class="token string">"-"</span> <span class="token string">"-"</span> <span class="token string">"-"</span>
结果显示：
	限制策略实施成功了
</code></pre> 
<p>环境收尾</p> 
<pre><code class="prism language-powershell">kubectl delete <span class="token operator">-</span>f 12_ingress_policy_limit<span class="token punctuation">.</span>yaml <span class="token operator">-</span>f 11_ingress_vs_nginx<span class="token punctuation">.</span>yaml <span class="token operator">-</span>f 01_ingress_web_resource<span class="token punctuation">.</span>yaml
</code></pre>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/59f90f0f22e6f44c4a7d48c78bb89103/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">K8S应用服务安全(最小特权 策略方案 资源限制 调用限制 沙箱)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b6e1a2f80ba73814111082c08cadaca9/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">K8S应用安全检测（调用分析 容器健康 审计日志）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>