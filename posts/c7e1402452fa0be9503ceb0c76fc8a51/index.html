<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Docker搭建MySQL的PXC方案集群 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Docker搭建MySQL的PXC方案集群" />
<meta property="og:description" content="文章目录 搭建5个MySQL节点使用Haproxy实现负载均衡Keepalived实现高可用方案 搭建5个MySQL节点 拉取镜像到本地 docker pull percona/percona‐xtradb‐cluster 镜像名称太长不方便使用，进行一下改名，改名后删除原来的镜像 docker tag percona/percona‐xtradb‐cluster pxc docker rmi percona/percona‐xtradb‐cluster 创建内网网段net1 创建网段：docker network create --subnet=172.18.0.0/24 net1 查询网段信息： docker inspect net1 删除网段：docker network rm net1 创建docker数据卷 创建：docker volume create --name v1 查看数据卷信息：docker inspect v1 删除：docker volume rm v1 重复操作创建v1-v5共5个数据卷 创建备份数据卷：docker volume create --name backup 创建容器 node1启动后一段时间再启动其他节点没如果node1没初始化完成就启动其他节点就会报错node如果启动几秒就挂掉了，删除对应的数据卷之后再重新创建数据卷再启动参数说明： -d 后台运行-p 3307:3306 将容器内的3306端口映射到宿主机3307端口-e 初始化MySQL的基本参数-v 映射宿主机数据卷和容器目录–name 指定容器名–net 指定容器的网关–ip 指定容器的IP，如果不指定会自动生成 #创建第1个MySQL节点 docker run -d -p 3306:3306 -e MYSQL_ROOT_PASSWORD=abc123456 -e CLUSTER_NAME=PXC -e XTRABACKUP_PASSWORD=abc123456 -v v1:/var/lib/mysql -v backup:/data --privileged --name=node1 --net=net1 --ip 172." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/c7e1402452fa0be9503ceb0c76fc8a51/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-06-21T17:34:46+08:00" />
<meta property="article:modified_time" content="2020-06-21T17:34:46+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Docker搭建MySQL的PXC方案集群</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atelier-sulphurpool-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#5MySQL_2" rel="nofollow">搭建5个MySQL节点</a></li><li><a href="#Haproxy_63" rel="nofollow">使用Haproxy实现负载均衡</a></li><li><a href="#Keepalived_197" rel="nofollow">Keepalived实现高可用方案</a></li></ul> 
</div> 
<p></p> 
<h2><a id="5MySQL_2"></a>搭建5个MySQL节点</h2> 
<ol><li>拉取镜像到本地</li></ol> 
<pre><code class="prism language-bash">docker pull percona/percona‐xtradb‐cluster
</code></pre> 
<ol start="2"><li>镜像名称太长不方便使用，进行一下改名，改名后删除原来的镜像</li></ol> 
<pre><code class="prism language-bash">docker tag percona/percona‐xtradb‐cluster pxc
docker rmi percona/percona‐xtradb‐cluster
</code></pre> 
<ol start="3"><li>创建内网网段net1</li></ol> 
<pre><code class="prism language-bash">创建网段：docker network create --subnet<span class="token operator">=</span>172.18.0.0/24 net1
查询网段信息： docker inspect net1
删除网段：docker network <span class="token function">rm</span> net1
</code></pre> 
<ol start="4"><li>创建docker数据卷</li></ol> 
<pre><code class="prism language-bash">创建：docker volume create --name v1
查看数据卷信息：docker inspect v1
删除：docker volume <span class="token function">rm</span> v1

 重复操作创建v1-v5共5个数据卷
 
创建备份数据卷：docker volume create --name backup
</code></pre> 
<ol start="7"><li>创建容器 
  <ul><li>node1启动后一段时间再启动其他节点没如果node1没初始化完成就启动其他节点就会报错</li><li>node如果启动几秒就挂掉了，删除对应的数据卷之后再重新创建数据卷再启动</li><li>参数说明： 
    <ul><li>-d 后台运行</li><li>-p 3307:3306 将容器内的3306端口映射到宿主机3307端口</li><li>-e 初始化MySQL的基本参数</li><li>-v 映射宿主机数据卷和容器目录</li><li>–name 指定容器名</li><li>–net 指定容器的网关</li><li>–ip 指定容器的IP，如果不指定会自动生成</li></ul> </li></ul> </li></ol> 
<pre><code class="prism language-bash"><span class="token comment">#创建第1个MySQL节点</span>
docker run -d -p 3306:3306 -e MYSQL_ROOT_PASSWORD<span class="token operator">=</span>abc123456 -e CLUSTER_NAME<span class="token operator">=</span>PXC -e XTRABACKUP_PASSWORD<span class="token operator">=</span>abc123456 -v v1:/var/lib/mysql -v backup:/data --privileged --name<span class="token operator">=</span>node1 --net<span class="token operator">=</span>net1 --ip 172.18.0.2 pxc
<span class="token comment">#创建第2个MySQL节点</span>
docker run -d -p 3307:3306 -e MYSQL_ROOT_PASSWORD<span class="token operator">=</span>abc123456 -e CLUSTER_NAME<span class="token operator">=</span>PXC -e XTRABACKUP_PASSWORD<span class="token operator">=</span>abc123456 -e CLUSTER_JOIN<span class="token operator">=</span>node1 -v v2:/var/lib/mysql -v backup:/data --privileged --name<span class="token operator">=</span>node2 --net<span class="token operator">=</span>net1 --ip 172.18.0.3 pxc
<span class="token comment">#创建第3个MySQL节点</span>
docker run -d -p 3308:3306 -e MYSQL_ROOT_PASSWORD<span class="token operator">=</span>abc123456 -e CLUSTER_NAME<span class="token operator">=</span>PXC -e XTRABACKUP_PASSWORD<span class="token operator">=</span>abc123456 -e CLUSTER_JOIN<span class="token operator">=</span>node1 -v v3:/var/lib/mysql --privileged --name<span class="token operator">=</span>node3 --net<span class="token operator">=</span>net1 --ip 172.18.0.4 pxc
<span class="token comment">#创建第4个MySQL节点</span>
docker run -d -p 3309:3306 -e MYSQL_ROOT_PASSWORD<span class="token operator">=</span>abc123456 -e CLUSTER_NAME<span class="token operator">=</span>PXC -e XTRABACKUP_PASSWORD<span class="token operator">=</span>abc123456 -e CLUSTER_JOIN<span class="token operator">=</span>node1 -v v4:/var/lib/mysql --privileged --name<span class="token operator">=</span>node4 --net<span class="token operator">=</span>net1 --ip 172.18.0.5 pxc
<span class="token comment">#创建第5个MySQL节点</span>
docker run -d -p 3310:3306 -e MYSQL_ROOT_PASSWORD<span class="token operator">=</span>abc123456 -e CLUSTER_NAME<span class="token operator">=</span>PXC -e XTRABACKUP_PASSWORD<span class="token operator">=</span>abc123456 -e CLUSTER_JOIN<span class="token operator">=</span>node1 -v v5:/var/lib/mysql -v backup:/data --privileged --name<span class="token operator">=</span>node5 --net<span class="token operator">=</span>net1 --ip 172.18.0.6 pxc
</code></pre> 
<ol start="8"><li>外部尝试连接5个MySQL节点，通过navicat进行连接 
  <ul><li>ip为宿主机公网IP</li><li>端口为只设置到暴露到公网的端口</li><li>用户名root</li><li>密码abc123456</li></ul> </li></ol> 
<p><img src="https://images2.imgbox.com/15/05/DyLIDThY_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/b3/8c/QLq0Lda4_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="Haproxy_63"></a>使用Haproxy实现负载均衡</h2> 
<p>MySQL各个节点之间通过TCP/IP协议进行交互，而使用较为广泛的负载均衡中间件nginx（适用于HTTP）就不太适合了，适用于TCP/IP协议的负载均衡中间件有Haproxy和LVS。这里采用Haproxy来实现负载均衡</p> 
<ol><li>安装Haproxy</li></ol> 
<p>拉取镜像到本地</p> 
<pre><code class="prism language-bash"> docker pull haproxy
</code></pre> 
<p>在宿主机创建haproxy.cfg的配置文件，放置在自定义目录，如<code>/root/docker/haproxy/</code>下</p> 
<pre><code class="prism language-bash">global
    <span class="token comment">#工作目录</span>
    <span class="token function">chroot</span> /usr/local/etc/haproxy
    <span class="token comment">#日志文件，使用rsyslog服务中local5日志设备（/var/log/local5），等级info</span>
    log 127.0.0.1 local5 info
    <span class="token comment">#守护进程运行</span>
    daemon


defaults
    log    global
    mode    http
    <span class="token comment">#日志格式</span>
    option    httplog
    <span class="token comment">#日志中不记录负载均衡的心跳检测记录</span>
    option    dontlognull
    <span class="token comment">#连接超时（毫秒）</span>
    <span class="token function">timeout</span> connect 5000
    <span class="token comment">#客户端超时（毫秒）</span>
    <span class="token function">timeout</span> client  50000
    <span class="token comment">#服务器超时（毫秒）</span>
    <span class="token function">timeout</span> server  50000


<span class="token comment">#监控界面    </span>
listen  admin_stats
    <span class="token comment">#监控界面的访问的IP和端口</span>
    bind  0.0.0.0:8888
    <span class="token comment">#访问协议</span>
    mode        http
    <span class="token comment">#URI相对地址</span>
    stats uri   /dbs
    <span class="token comment">#统计报告格式</span>
    stats realm     Global\ statistics
    <span class="token comment">#登陆帐户信息</span>
    stats auth  admin:abc123456
<span class="token comment">#数据库负载均衡</span>
listen  proxy-mysql
    <span class="token comment">#访问的IP和端口</span>
    bind  0.0.0.0:3306  
    <span class="token comment">#网络协议</span>
    mode  tcp
    <span class="token comment">#负载均衡算法（轮询算法）</span>
    <span class="token comment">#轮询算法：roundrobin</span>
    <span class="token comment">#权重算法：static-rr</span>
    <span class="token comment">#最少连接算法：leastconn</span>
    <span class="token comment">#请求源IP算法：source</span>
    balance  roundrobin
    <span class="token comment">#日志格式</span>
    option  tcplog
    <span class="token comment">#在MySQL中创建一个没有权限的haproxy用户，密码为空。Haproxy使用这个账户对MySQL数据库心跳检测</span>
    option  mysql-check user haproxy
    server  MySQL_1 172.18.0.2:3306 check weight 1 maxconn 2000  
    server  MySQL_2 172.18.0.3:3306 check weight 1 maxconn 2000  
    server  MySQL_3 172.18.0.4:3306 check weight 1 maxconn 2000
    server  MySQL_4 172.18.0.5:3306 check weight 1 maxconn 2000
    server  MySQL_5 172.18.0.6:3306 check weight 1 maxconn 2000
    <span class="token comment">#使用keepalive检测死链</span>
    option  tcpka  
</code></pre> 
<ol start="2"><li>启动第一个Haproxy容器</li></ol> 
<pre><code class="prism language-bash">docker run -it -d -p 4001:8888 -p 4002:3306 -v /root/docker/haproxy:/usr/local/etc/haproxy --name h1 --privileged --net<span class="token operator">=</span>net1 --ip 172.18.0.7 haproxy
</code></pre> 
<p>参数说明</p> 
<ul><li>4001:8888 ：将haproxy暴露在8888的监控端口映射到宿主机</li><li>4002:3306：将haproxy的3306端口映射到宿主机4002端口</li><li>将haproxy的/usr/local/etc/haproxy目录映射到宿主机的/root/docker/haproxy目录，用于设置配置文件</li><li>haproxy取名为h1</li><li>使用网段net1</li><li>手动设置一个ip为172.18.0.7</li></ul> 
<ol start="3"><li>启动第一个Haproxy<br> 以界面交互方式进入容器：</li></ol> 
<pre><code class="prism language-bash">docker <span class="token function">exec</span> -it h1 <span class="token function">bash</span>
</code></pre> 
<p>加上配置文件启动</p> 
<pre><code class="prism language-bash">haproxy -f /usr/local/etc/haproxy/haproxy.cfg
</code></pre> 
<ol start="4"><li>启动第二个Haproxy容器</li></ol> 
<pre><code class="prism language-bash">docker run -it -d -p 4003:8888 -p 4004:3306 -v /root/docker/haproxy:/usr/local/etc/haproxy --name h2 --privileged --net<span class="token operator">=</span>net1 --ip 172.18.0.8 haproxy
</code></pre> 
<ol start="5"><li>启动第一个Haproxy<br> 以界面交互方式进入容器：</li></ol> 
<pre><code class="prism language-bash">docker <span class="token function">exec</span> -it h2 <span class="token function">bash</span>
</code></pre> 
<p>加上配置文件启动</p> 
<pre><code class="prism language-bash">haproxy -f /usr/local/etc/haproxy/haproxy.cfg
</code></pre> 
<ol start="6"><li>配置连接账号</li></ol> 
<p>先任意登录一个MySQL节点<br> 在MySQL中创建一个没有权限的haproxy用户，密码为空。<br> Haproxy使用这个账户对MySQL数据库心跳检测</p> 
<pre><code class="prism language-bash">CREATE USER <span class="token string">'haproxy'</span> @<span class="token string">'%'</span> IDENTIFIED BY <span class="token string">''</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="7"><li>访问Haproxy监控<br> url可以是任意一个节点的监控端口</li></ol> 
<pre><code class="prism language-bash">公网ip:4001/dbs
公网ip:4003/dbs
</code></pre> 
<p>访问界面如图所示<br> <img src="https://images2.imgbox.com/6b/04/CymcYOsB_o.png" alt="在这里插入图片描述"><br> 使用的时候就可以直接向haproxy节点发起请求，haproxy只是对请求进行转发，并不会进行存储<br> 用navicat连接一个节点方便使用<br> <img src="https://images2.imgbox.com/9a/59/YfefigtE_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="Keepalived_197"></a>Keepalived实现高可用方案</h2> 
<p>PXC集群的目的是保证单节点MySQL故障时的高可用<br> 引入Haproxy做负载均衡后，所有的请求都需要Haproxy进行转发<br> 如果Haproxy宕机了，同样不能做到集群高可用<br> 所以需要对Haproxy也进行高可用配置</p> 
<p>方案如下<br> <img src="https://images2.imgbox.com/ab/29/li8LVzRE_o.png" alt="在这里插入图片描述"><br> 现在已经配置好了数据库集群和两个节点的Haproxy<br> 还需要在两个Haproxy上各配置一个Keepalived<br> 然后在宿主机上配置一个Keepalived用于为外提供服务</p> 
<ol><li>在haproxy上安装keepalived（haproxy镜像使用的是unbuntu，所以以下操作使用apt-get）</li></ol> 
<p>进入haproxy</p> 
<pre><code class="prism language-bash">docker <span class="token function">exec</span> -it h1 <span class="token function">bash</span>
</code></pre> 
<p>更新apt-get</p> 
<pre><code class="prism language-bash"><span class="token function">apt-get</span> update
</code></pre> 
<p>下载keepalived</p> 
<pre><code class="prism language-bash"><span class="token function">apt-get</span> <span class="token function">install</span> keepalived
</code></pre> 
<p>修改keepalived配置文件</p> 
<p>因为keepalived镜像装载ubuntu上，如果直接修改还需要装vim等工具，所以可以在宿主机写好了复制进来或者设置目录映射</p> 
<p>编写keepalived.conf文件</p> 
<pre><code class="prism language-bash">vrrp_instance  VI_1 <span class="token punctuation">{<!-- --></span>
    state  MASTER    <span class="token comment">#keepalived的身份：MASTER主服务，会抢占虚拟ip；BACKUP备用服务</span>
    interface  eth0  <span class="token comment">#网卡配置较：etho是docker虚拟机的网卡，宿主机能访问但是局域网不能访问，宿主机的keepalived上将网卡映射到局域网</span>
    virtual_router_id  51   <span class="token comment">#id：0-255间随便取</span>
    priority  100    <span class="token comment">#权重，根据硬件配置调整数字</span>
    advert_int  1    <span class="token comment"># 心跳检测的时间间隔  1s</span>
    authentication <span class="token punctuation">{<!-- --></span>   <span class="token comment">#心跳检测需要开放的密码</span>
        auth_type  PASS
        auth_pass  123456
    <span class="token punctuation">}</span> 
    virtual_ipaddress <span class="token punctuation">{<!-- --></span>  <span class="token comment">#eth0开放的虚拟ip</span>
        172.18.0.201
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>采用宿主机写好再复制的操作：</p> 
<pre><code class="prism language-bash">docker <span class="token function">cp</span> 宿主机文件路径  镜像名称:镜像中文件存放路径
docker <span class="token function">cp</span> /root/keepalived.conf h1:/etc/keepalived/
</code></pre> 
<p>启动keepalived</p> 
<pre><code class="prism language-bash"><span class="token function">service</span> keepalived start
</code></pre> 
<p>返回宿主机测试是否启动成功</p> 
<pre><code class="prism language-bash"><span class="token function">ping</span> 172.18.0.201
</code></pre> 
<p>同理修改h2中的配置，其中所有的配置包括ip设置都一模一样</p> 
<ol start="2"><li>宿主机安装keepalived</li></ol> 
<pre><code class="prism language-bash">yum ‐y <span class="token function">install</span> keepalived
</code></pre> 
<p>修改配置文件</p> 
<pre><code class="prism language-bash"><span class="token function">vi</span> /etc/keepalived/keepalived.conf
</code></pre> 
<p>配置文件如下<br> 其中：</p> 
<ul><li>172.26.0.288表示本地网关下的任意一个IP</li><li>查看本地网关可以通过：<code>ip addr</code> / <code>ifconfig</code> / <code>ip a</code> 查看</li><li>172.18.0.201表示Haproxy的IP</li><li>8888是Haproxy监控的端口</li><li>3306是MySQL的端口</li></ul> 
<pre><code class="prism language-bash">	virtual_server 172.26.0.228 8888 <span class="token punctuation">{<!-- --></span>
        delay_loop 3
        lb_algo rr
        lb_kind NAT
        persistence_timeout 50
        protocol TCP


        real_server 172.18.0.201 8888 <span class="token punctuation">{<!-- --></span>
            weight 1
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    virtual_server 172.26.0.228 3306 <span class="token punctuation">{<!-- --></span>
        delay_loop 3
        lb_algo rr
        lb_kind NAT
        persistence_timeout 50
        protocol TCP


        real_server 172.18.0.201 3306 <span class="token punctuation">{<!-- --></span>
            weight 1
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>启动keepalived</p> 
<pre><code class="prism language-bash"><span class="token function">service</span> keepalived start
</code></pre> 
<p>启动完成之后可以通过ping自定义的IP来查看是否连接成功</p> 
<pre><code class="prism language-bash"><span class="token function">ping</span> 172.26.0.228
</code></pre> 
<ol start="3"><li>数据热备份</li></ol> 
<p>进入node1</p> 
<pre><code class="prism language-bash">docker <span class="token function">exec</span> ‐it node1 <span class="token function">bash</span> 
</code></pre> 
<p>更新apt-get</p> 
<pre><code class="prism language-bash">apt‐get update 
</code></pre> 
<p>安装热备份工具</p> 
<pre><code class="prism language-bash">apt‐get <span class="token function">install</span> percona‐xtrabackup‐24
</code></pre> 
<p>进行全量热备份</p> 
<pre><code class="prism language-bash">innobackupex ‐‐user<span class="token operator">=</span>root ‐‐password<span class="token operator">=</span>abc123456 /data/backup/full
</code></pre>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1ae5feb2a62cb4b8f027e2187f4016c1/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Spring Boot 2.x: 爬取ip代理池</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f5488f19aa0a094bfac0ee826edaa0a3/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">matlab基于傅里叶变换实现信号的波形和频谱的绘制</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>