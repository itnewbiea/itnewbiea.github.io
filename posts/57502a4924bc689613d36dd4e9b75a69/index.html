<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>阿里云elasticsearch实践（最大限度提高写入速度） - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="阿里云elasticsearch实践（最大限度提高写入速度）" />
<meta property="og:description" content="ES学习文档 最权威的，当然就是官方文档，根据自己所安装的版本进行选择：elasticsearch所有版本参考文档如果英文文档阅读有困难，参考：Elasticsearch: 权威指南，但是中文文档有滞后性，比如目前es已经到6.X版本，而中文文档以2.X版本为基础，因此对于新版本的话会有部分不适用。参考博客：铭毅天下 使用阿里云 elasticsearch 使用阿里云 elasticsearch服务，就可以不用再自己安装elasticsearch，购买后即可立即使用，方便快捷。
如果使用java客户端进行访问会有限制：
具体请参考：阿里云elasticsearch介绍
elasticsearch插件 head插件
通过head插件连接es，可以从界面上进行可视化查看集群健康值、索引名称、类型名称，同时可进行基本查询以及es本身的DSL复杂查询
head插件可以直接使用360或者谷歌浏览器插件直接安装即可，不用再另外安装，下载地址：es head插件
X-PACK插件
可以提供身份验证，更好的保证数据安全。阿里云elasticsearch已经集成了X-PACK
IK分词插件
常用中文分词插件，阿里云elasticsearch已经有预置该插件，可以直接进行分词使用
阿里云elasticsearch实践 同步数据库数据到es包含两个过程，一个是从数据库中查出指定的数据，一个是将数据库查出来的数据保存到es中阿里云elasticsearch规格选用
cpu：4核
内存：16G
硬盘：256GB SSD（强烈建议使用固态硬盘，固态硬盘对于es的同步、更新效率有巨大的提升空间）
集群节点：3一般我们初始化数据到es的时候，数据量是非常大的，可能有几千万直至上亿，因此对于查询的sql一定要优化到非常快保存数据到es也是优化的重点，以下将列出所有优化步骤： 一定要用bulk批量提交
elasticsearch允许单次提交数据在15M以内，也不能过大，不然有可能会失败，因此我们可以批量查出多条数据（具体要多少数据才进行bulk条要看字段的多少，可以先保存部分数据到es验证下，目前总共占用多少容量，然后推算）。。千万不要用一条条提交，这个对于写入有巨大的提升！
禁用_all字段
_all字段是elasticsearch在保存的时候会自己生成一个字段，相当于将所有需要保存的数据全部冗余在这个字段里面，普通查询一般是用不到这个字段的，直接禁用掉：
http://localhost:9200/test_index/ { &#34;settings&#34;: { &#34;number_of_shards&#34;: 7 }, &#34;mappings&#34;: { &#34;testRequest&#34;: { &#34;_all&#34;: { &#34;enabled&#34;: false } } } } 注意：这里的number_of_shards这边设置为7（默认是5），那具体要怎么来确认到底需要创建多少分片数量呢？
请参考：es如何设置分片数量
提高硬盘的写入速率，前提是一定要固态硬盘！机械硬盘不能设置太高
http://localhost:9200/_cluster/settings/ { &#34;persistent&#34;: { &#34;indices.store.throttle.max_bytes_per_sec&#34;: &#34;200mb&#34; } } 注意：persistent，表示是永久设置，将会写入到elasticsearch配置文件中
关闭段合并merge
http://localhost:9200/_cluster/settings/ { &#34;transient&#34;: { &#34;indices.store.throttle.type&#34;: &#34;none&#34; } } 注意：transient，表示是临时设置，一旦elasticsearch重启，这个配置会立即失效。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/57502a4924bc689613d36dd4e9b75a69/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-09-03T12:00:12+08:00" />
<meta property="article:modified_time" content="2021-09-03T12:00:12+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">阿里云elasticsearch实践（最大限度提高写入速度）</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h4 id="es">ES学习文档</h4> 
<ol><li>最权威的，当然就是官方文档，根据自己所安装的版本进行选择：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/index.html" rel="nofollow">elasticsearch所有版本参考文档</a></li><li>如果英文文档阅读有困难，参考：<a href="https://www.elastic.co/guide/cn/elasticsearch/guide/cn/index.html" rel="nofollow">Elasticsearch: 权威指南</a>，但是中文文档有滞后性，比如目前es已经到6.X版本，而中文文档以2.X版本为基础，因此对于新版本的话会有部分不适用。</li><li>参考博客：<a href="https://blog.csdn.net/laoyang360/article/details/52244917">铭毅天下</a></li></ol> 
<h4 id="httpslgushujisitealiyunelasticsearch">使用<a href="https://l.gushuji.site/aliyun" rel="nofollow">阿里云</a> elasticsearch</h4> 
<p>使用<a href="https://l.gushuji.site/aliyun" rel="nofollow">阿里云</a> elasticsearch服务，就可以不用再自己安装elasticsearch，购买后即可立即使用，方便快捷。<br> 如果使用java客户端进行访问会有限制：<br><img alt="这里写图片描述" src="https://images2.imgbox.com/7d/8c/IdlbQgnE_o.png"><br> 具体请参考：<a href="https://help.aliyun.com/product/57736.html" rel="nofollow">阿里云elasticsearch介绍</a></p> 
<h4 id="elasticsearch">elasticsearch插件</h4> 
<ul><li> <p>head插件<br> 通过head插件连接es，可以从界面上进行可视化查看集群健康值、索引名称、类型名称，同时可进行基本查询以及es本身的DSL复杂查询<br><img alt="这里写图片描述" src="https://images2.imgbox.com/ba/e0/lIY7V6TA_o.png"><br> head插件可以直接使用360或者谷歌浏览器插件直接安装即可，不用再另外安装，下载地址：<a href="https://download.csdn.net/download/dongzhouzhou/10378031">es head插件</a></p> </li><li> <p>X-PACK插件<br> 可以提供身份验证，更好的保证数据安全。<a href="https://l.gushuji.site/aliyun" rel="nofollow">阿里云</a>elasticsearch已经集成了X-PACK</p> </li><li> <p>IK分词插件<br> 常用中文分词插件，<a href="https://l.gushuji.site/aliyun" rel="nofollow">阿里云</a>elasticsearch已经有预置该插件，可以直接进行分词使用</p> </li></ul> 
<h4 id="httpslgushujisitealiyunelasticsearch-1"><a href="https://l.gushuji.site/aliyun" rel="nofollow">阿里云</a>elasticsearch实践</h4> 
<ol><li>同步数据库数据到es包含两个过程，一个是从数据库中查出指定的数据，一个是将数据库查出来的数据保存到es中</li><li><a href="https://l.gushuji.site/aliyun" rel="nofollow">阿里云</a>elasticsearch规格选用<br> cpu：4核<br> 内存：16G<br> 硬盘：256GB SSD（强烈建议使用固态硬盘，固态硬盘对于es的同步、更新效率有巨大的提升空间）<br> 集群节点：3</li><li>一般我们初始化数据到es的时候，数据量是非常大的，可能有几千万直至上亿，因此对于查询的sql一定要优化到非常快</li><li>保存数据到es也是优化的重点，以下将列出所有优化步骤：</li></ol> 
<blockquote> 
 <p>一定要用bulk批量提交</p> 
</blockquote> 
<p>elasticsearch允许单次提交数据在15M以内，也不能过大，不然有可能会失败，因此我们可以批量查出多条数据（具体要多少数据才进行bulk条要看字段的多少，可以先保存部分数据到es验证下，目前总共占用多少容量，然后推算）。。千万不要用一条条提交，这个对于写入有巨大的提升！</p> 
<blockquote> 
 <p>禁用_all字段<br> _all字段是elasticsearch在保存的时候会自己生成一个字段，相当于将所有需要保存的数据全部冗余在这个字段里面，普通查询一般是用不到这个字段的，直接禁用掉：</p> 
</blockquote> 
<pre><code>http://localhost:9200/test_index/
{
  "settings": {
    "number_of_shards": 7
  },
  "mappings": {
    "testRequest": {
      "_all": {
        "enabled": false
      }
    }
  }
}
</code></pre> 
<p>注意：这里的number_of_shards这边设置为7（默认是5），那具体要怎么来确认到底需要创建多少分片数量呢？<br> 请参考：<a href="https://segmentfault.com/a/1190000008868585" rel="nofollow">es如何设置分片数量</a></p> 
<blockquote> 
 <p>提高硬盘的写入速率，前提是一定要固态硬盘！机械硬盘不能设置太高</p> 
</blockquote> 
<pre><code>http://localhost:9200/_cluster/settings/
{
  "persistent": {
    "indices.store.throttle.max_bytes_per_sec": "200mb"
  }
}
</code></pre> 
<p>注意：persistent，表示是永久设置，将会写入到elasticsearch配置文件中</p> 
<blockquote> 
 <p>关闭段合并merge</p> 
</blockquote> 
<pre><code>http://localhost:9200/_cluster/settings/
{
  "transient": {
    "indices.store.throttle.type": "none"
  }
}
</code></pre> 
<p>注意：transient，表示是临时设置，一旦elasticsearch重启，这个配置会立即失效。</p> 
<blockquote> 
 <p><strong>更改副本分片为0（非常重要）</strong><br> elasticsearch默认主分片数量是5，同时会生成对应的5个副本分片，每次在保存数据的时候会将主分片的数据拷贝到副本分片上，这个过程非常耗费资源，我们可以在初始化同步过程中先将副本分片数量改为0，等同步完成后再将副本分片改回5，这样在我们改回来之后就只会有一次的复制主分片数据到副本分片数据的过程，可极大提升同步效率</p> 
</blockquote> 
<pre><code>http://localhost:9200/test_index/_settings/
{
  "index": {
    "number_of_replicas": 0
  }
}
</code></pre> 
<blockquote> 
 <p>设置refresh刷新间隔为不刷新</p> 
</blockquote> 
<pre><code>http://localhost:9200/test_index/_settings/
{
  "index": {
    "refresh_interval": "-1"
  }
}
</code></pre> 
<blockquote> 
 <p>设置数据flush方式为异步，且加大translog文件大小</p> 
</blockquote> 
<pre><code>http://localhost:9200/test_index/_settings/
{
  "index.translog.durability": "async",
  "index.translog.flush_threshold_size": "1024mb"
}
</code></pre> 
<h4 id="elasticsearch-1">保存完数据到elasticsearch后</h4> 
<p>由于在写入时为了最大限度提高写入速度，我们做了一些特殊配置，因此在同步完数据后，需要将对应的配置还原回来</p> 
<blockquote> 
 <p>开启段合并merge</p> 
</blockquote> 
<pre><code>http://localhost:9200/_cluster/settings/
{
  "transient": {
    "indices.store.throttle.type": "merge"
  }
}
</code></pre> 
<blockquote> 
 <p>恢复副本分片数量</p> 
</blockquote> 
<pre><code>http://localhost:9200/test_index/_settings/
{
  "index": {
    "number_of_replicas": 1
  }
}
</code></pre> 
<blockquote> 
 <p>设置refresh刷新间隔为1s</p> 
</blockquote> 
<pre><code>http://localhost:9200/test_index/_settings/
{
  "index": {
    "refresh_interval": "1s"
  }
}
</code></pre> 
<blockquote> 
 <p>设置flush同步方式为request，同时修改translog文件大小为512M</p> 
</blockquote> 
<pre><code>http://localhost:9200/test_index/_settings/
{
  "index.translog.durability": "request",
  "index.translog.flush_threshold_size": "512mb"
}
</code></pre> 
<h4>验证结果</h4> 
<p>导入总条数：44000000条<br> 数据容量大小：40G（加上副本分片共80G）<br> 耗时：耗费2小时40分钟左右<br> elasticsearch服务器性能监控：<br><img alt="这里写图片描述" src="https://images2.imgbox.com/da/9e/gNS9H9BK_o.png"><br> 由上图可见：CPU的使用效率已经接近极限，可最大限度利用<a href="https://l.gushuji.site/aliyun" rel="nofollow">阿里云</a>elasticsearch服务器性能</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9358bbdb6226f02e6c7512bd7a85fa8d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">[浅析]UE4材质基础总结</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9c16ef75b28fa3e8f381adc4bd3e3a66/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">linux设备树分析2-创建device_node树</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>