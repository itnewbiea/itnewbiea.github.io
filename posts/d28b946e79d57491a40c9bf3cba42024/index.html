<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>嵌入式设备时间同步(gpsd pps chrony 校时) - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="嵌入式设备时间同步(gpsd pps chrony 校时)" />
<meta property="og:description" content="文章目录 二、时间同步方案三、chrony 介绍和使用3.1 chrony 介绍3.2 chrony 使用示例3.3 chrony.conf3.4 chronyd3.5 chronyc 四、gpsd &#43; chrony &#43; pps 介绍和使用4.1 gpsd 介绍4.1.1 gpsd 交叉编译4.1.2 gpsd 使用4.1.2 gpsd &#43; chrony 4.2 pps 和 pps-tools 介绍和使用 五、比较两个设备时间差5.1 date 命令5.2 ntpdate命令5.2.1 使用示例5.2.2 ntpdate 交叉编译5.2.3 chronyd 命令 六、核心参考 二、时间同步方案 该部分转自：一文了解自动驾驶中的时间同步 时间同步包含哪些内容？
时间同步可分为几部分的内容：统一时钟源，硬件同步，软件同步。
1. 统一时钟源
1.1 PPS &#43; NMEA
GPS能够从卫星获得高精度的时钟信号，因此通常作为整个系统的时钟源。常规的GPS单元都支持输出精确到毫秒的秒脉冲信号PPS和包含年月日时分秒信息的NMEA指令，通过PPS和NMEA的组合就能够实现对激光雷达或主机的毫秒级时钟同步。
PPS&#43;NMEA的优点是协议简单，容易实现；缺点是必须基于RS232。多个设备之间实现同步比较困难。
1.2 PTP（IEEE 1588或IEEE 802.1AS）
PTP(Precision Time Protocol，1588 V2)是基于以太网的高精度时钟同步协议，能够实现以太网中多个从节点（各种传感器）与主节点（主机）之间的亚微秒级时钟同步，前提是所有节点之间都通过以太网互联，交换机支持PTP协议，并且每个节点都支持PTP协议。
与PTP同时出现的还有一种NTP，即网络时间协议，不同的是PTP是在硬件级实现的，NTP是在应用层级别实现的 。
2. 硬件同步
3. 软件同步
三、chrony 介绍和使用 3.1 chrony 介绍 chrony 官网v2." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/d28b946e79d57491a40c9bf3cba42024/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-16T17:04:32+08:00" />
<meta property="article:modified_time" content="2023-11-16T17:04:32+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">嵌入式设备时间同步(gpsd pps chrony 校时)</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_2" rel="nofollow">二、时间同步方案</a></li><li><a href="#chrony__31" rel="nofollow">三、chrony 介绍和使用</a></li><li><ul><li><a href="#31_chrony__33" rel="nofollow">3.1 chrony 介绍</a></li><li><a href="#32_chrony__57" rel="nofollow">3.2 chrony 使用示例</a></li><li><a href="#33_chronyconf_91" rel="nofollow">3.3 chrony.conf</a></li><li><a href="#34_chronyd_115" rel="nofollow">3.4 chronyd</a></li><li><a href="#35_chronyc_117" rel="nofollow">3.5 chronyc</a></li></ul> 
  </li><li><a href="#gpsd__chrony__pps__146" rel="nofollow">四、gpsd + chrony + pps 介绍和使用</a></li><li><ul><li><a href="#41_gpsd__151" rel="nofollow">4.1 gpsd 介绍</a></li><li><ul><li><a href="#411_gpsd__157" rel="nofollow">4.1.1 gpsd 交叉编译</a></li><li><a href="#412_gpsd__307" rel="nofollow">4.1.2 gpsd 使用</a></li><li><a href="#412_gpsd__chrony_349" rel="nofollow">4.1.2 gpsd + chrony</a></li></ul> 
   </li><li><a href="#42_pps__ppstools__395" rel="nofollow">4.2 pps 和 pps-tools 介绍和使用</a></li></ul> 
  </li><li><a href="#_451" rel="nofollow">五、比较两个设备时间差</a></li><li><ul><li><a href="#51_date__452" rel="nofollow">5.1 date 命令</a></li><li><a href="#52_ntpdate_469" rel="nofollow">5.2 ntpdate命令</a></li><li><ul><li><a href="#521__471" rel="nofollow">5.2.1 使用示例</a></li><li><a href="#522_ntpdate__483" rel="nofollow">5.2.2 ntpdate 交叉编译</a></li><li><a href="#523_chronyd__529" rel="nofollow">5.2.3 chronyd 命令</a></li></ul> 
  </li></ul> 
  </li><li><a href="#_542" rel="nofollow">六、核心参考</a></li></ul> 
</div> 
<p></p> 
<h2><a id="_2"></a>二、时间同步方案</h2> 
<ul><li>该部分转自：<a href="http://www.360doc.com/content/22/0328/00/57514296_1023636982.shtml" rel="nofollow">一文了解自动驾驶中的时间同步</a></li></ul> 
<p><strong>时间同步包含哪些内容？</strong></p> 
<p>时间同步可分为几部分的内容：<strong>统一时钟源</strong>，<strong>硬件同步</strong>，<strong>软件同步</strong>。</p> 
<p><strong>1. 统一时钟源</strong></p> 
<p>1.1 PPS + NMEA</p> 
<p>GPS能够从卫星获得高精度的时钟信号，因此通常作为整个系统的时钟源。常规的GPS单元都支持输出精确到毫秒的秒脉冲信号PPS和包含年月日时分秒信息的NMEA指令，通过PPS和NMEA的组合就能够实现对激光雷达或主机的毫秒级时钟同步。<br> PPS+NMEA的优点是协议简单，容易实现；缺点是必须基于RS232。多个设备之间实现同步比较困难。</p> 
<p>1.2 PTP（IEEE 1588或IEEE 802.1AS）</p> 
<p>PTP(Precision Time Protocol，1588 V2)是基于以太网的高精度时钟同步协议，能够实现以太网中多个从节点（各种传感器）与主节点（主机）之间的亚微秒级时钟同步，前提是所有节点之间都通过以太网互联，交换机支持PTP协议，并且每个节点都支持PTP协议。</p> 
<p>与PTP同时出现的还有一种NTP，即网络时间协议，不同的是PTP是在硬件级实现的，NTP是在应用层级别实现的 。</p> 
<p><strong>2. 硬件同步</strong></p> 
<p><strong>3. 软件同步</strong></p> 
<p><img src="https://images2.imgbox.com/bd/af/mKF0ZTAf_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="chrony__31"></a>三、chrony 介绍和使用</h2> 
<h3><a id="31_chrony__33"></a>3.1 chrony 介绍</h3> 
<ul><li><a href="https://chrony-project.org/" rel="nofollow">chrony 官网</a></li><li><a href="https://chrony-project.org/doc/2.4/chrony.conf.html" rel="nofollow">v2.4 chrony.conf</a></li><li><a href="https://chrony-project.org/doc/2.4/chronyd.html" rel="nofollow">v2.4 chronyd</a></li><li><a href="https://chrony-project.org/doc/2.4/chronyc.html" rel="nofollow">v2.4 chronyc</a></li><li><a href="https://chrony-project.org/faq.html#_how_does_chrony_compare_to_ntpd" rel="nofollow">FAQ 常见问题</a></li></ul> 
<p>chrony是网络时间协议（NTP）的通用实现。它可以将系统时钟与NTP服务器、参考时钟（如GPS接收器）以及使用手表和键盘的手动输入同步。它还可以作为NTPv4（RFC 5905）服务器和对等端操作，为网络中的其他计算机提供时间服务。</p> 
<p>通过互联网同步的两台机器之间的典型精度在几毫秒内；在局域网上，精度通常为几十微秒。通过硬件时间戳或硬件参考时钟，亚微秒精度可能是可能的。</p> 
<p>chrony中包含两个程序，chronyd是一个可以在启动时启动的守护进程，chronyc是一个命令行界面程序，可以用来监视chronyd的性能，并在其运行时更改各种操作参数。</p> 
<p><strong>chrony支持的功能</strong></p> 
<ul><li>NTP校时：作为ntp client向ntp server进行校时。</li><li>PPS（脉冲秒信号）校时：通过连接GPS接收器或其他高精度时钟设备来获取脉冲秒信号。</li><li>RTC（实时时钟）校时：Chrony可以通过与计算机上的实时时钟设备进行通信，将计算机的时钟与实时时钟进行同步。</li><li>NMEA 校时：通过与NMEA设备（如GPS接收器）通信，获取到NMEA数据，并将其用于校正计算机时钟。</li><li>作为校时服务器：给其他设备校时。</li></ul> 
<p>注意：实际使用时根据chrony版本查阅帮助文档，这里使用的版本是chrony 2.4。</p> 
<h3><a id="32_chrony__57"></a>3.2 chrony 使用示例</h3> 
<p>使用步骤：</p> 
<ol><li>配置好chrony.conf文件</li><li>启动chronyd</li><li>选择性设置添加自启动</li><li>chronyc查看状态信息</li></ol> 
<p>示例1：ntp 客户端</p> 
<pre><code class="prism language-bash">server ntp1.aliyun.com trust minpoll <span class="token number">2</span> maxpoll <span class="token number">4</span> polltarget <span class="token number">30</span>
server <span class="token number">10.234</span>.111.138 trust minpoll <span class="token number">2</span> maxpoll <span class="token number">4</span> polltarget <span class="token number">30</span>
makestep <span class="token number">0.1</span> <span class="token parameter variable">-1</span>
driftfile /var/lib/chrony/drift
rtcsync
</code></pre> 
<p>示例1：gps校时，同时作为ntp服务器端给其他设备校时</p> 
<pre><code class="prism language-bash"><span class="token comment"># gpsd and pps</span>
refclock SHM <span class="token number">0</span> poll <span class="token parameter variable">-2</span> refid GPS precision 1e-1 offset <span class="token number">0.9999</span> delay <span class="token number">0.2</span>
refclock PPS /dev/pps1 lock NMEA refid PPS

makestep <span class="token number">0.1</span> <span class="token parameter variable">-1</span>
driftfile /var/lib/chrony/drift
rtcsync

<span class="token comment"># 作为校时服务器</span>
allow all
<span class="token builtin class-name">local</span> stratum <span class="token number">10</span>
</code></pre> 
<h3><a id="33_chronyconf_91"></a>3.3 chrony.conf</h3> 
<p><strong>示例1-faq</strong></p> 
<pre><code class="prism language-bash">server ntp.local minpoll <span class="token number">2</span> maxpoll <span class="token number">4</span> polltarget <span class="token number">30</span>
</code></pre> 
<p>在NTP服务器配置中，<code>minpoll</code>和<code>maxpoll</code>参数用于限制NTP客户端发送时间同步请求的频率。这两个参数控制了NTP客户端在连续的时间同步请求之间等待的最小和最大时间间隔。</p> 
<p><code>minpoll</code>参数指定了NTP客户端发送时间同步请求的最小时间间隔，单位为2的幂次方的秒。在你的配置中，<code>minpoll</code>的值为2，表示最小时间间隔为2的2次方，即4秒。</p> 
<p><code>maxpoll</code>参数指定了NTP客户端发送时间同步请求的最大时间间隔，单位同样为2的幂次方的秒。在你的配置中，<code>maxpoll</code>的值为4，表示最大时间间隔为2的4次方，即16秒。</p> 
<p><code>polltarget</code>参数表示NTP客户端向服务器发送请求的时间间隔的目标值，单位为秒。在你的配置中，<code>polltarget</code>的值为30，表示NTP客户端希望每30秒发送一次时间同步请求。</p> 
<p>需要注意的是，<code>polltarget</code>参数是以秒为单位的，而不是2的幂次方。因此，<code>polltarget</code>的值并不会超过<code>maxpoll</code>参数的限制。在你的配置中，即使<code>maxpoll</code>的值为4（即16秒），<code>polltarget</code>的值也仍然是30秒。这样设置的目的是为了在时间同步的准确性和服务器负载之间取得一个平衡。</p> 
<p>综上所述，NTP客户端的实际时间同步间隔取决于服务器响应和网络延迟等因素，但会受到<code>minpoll</code>和<code>maxpoll</code>参数的限制。在你的配置中，NTP客户端将以30秒为目标值发送时间同步请求，但实际的时间间隔可能会在4秒到16秒之间变化。</p> 
<p><strong>示例2-faq</strong></p> 
<pre><code class="prism language-bash">server ntp.local minpoll <span class="token number">0</span> maxpoll <span class="token number">0</span> xleave
hwtimestamp eth0
</code></pre> 
<h3><a id="34_chronyd_115"></a>3.4 chronyd</h3> 
<h3><a id="35_chronyc_117"></a>3.5 chronyc</h3> 
<p>chronyc是一个命令行界面程序，可用于监视chronyd的性能，并在运行时更改各种操作参数。</p> 
<ul><li>chronyc tracking：跟踪命令显示有关系统时钟性能的参数。</li><li>chronyc sources<pre><code class="prism language-bas">root@imx6qdlsabresd:/app/log#  chronyc tracking
Reference ID    : 127.127.1.1 ()
Stratum         : 10
Ref time (UTC)  : Thu Sep 07 23:14:28 2023
System time     : 14539.303710938 seconds fast of NTP time
Last offset     : -0.271399736 seconds
RMS offset      : 105085.718750000 seconds
Frequency       : 499789.469 ppm fast
Residual freq   : +0.000 ppm
Skew            : 0.000 ppm
Root delay      : 0.000000 seconds
Root dispersion : 0.000001 seconds
Update interval : 0.1 seconds
Leap status     : Normal
</code></pre> </li></ul> 
<p><font color="red">chrony如何查看校时精度？</font></p> 
<p>在上面的输出中，您可以看到Last offset和RMS offset字段，它们表示最近一次同步时钟的偏移量和持续的偏移量的均方根。这些值越小，校时精度越高。另外，您还可以关注Frequency字段，它表示系统时钟相对于NTP服务器时钟的频率偏移。</p> 
<p>请注意，校时精度的度量单位是秒，小数点后的数字表示精度的小数部分。</p> 
<h2><a id="gpsd__chrony__pps__146"></a>四、gpsd + chrony + pps 介绍和使用</h2> 
<ul><li>gpsd + chrony ： 实现时间同步。</li><li>gpsd + chrony + pps ： 实现更高精度的时间同步。</li></ul> 
<h3><a id="41_gpsd__151"></a>4.1 gpsd 介绍</h3> 
<ul><li><a href="https://gpsd.io/index.html" rel="nofollow">gpsd 官网</a></li></ul> 
<p>gpsd是一个服务守护进程，它通过串行或USB端口监视连接到主机的一个或多个GPSE或AIS接收器，使有关传感器的位置/路线/速度的所有数据都可以在主机的TCP端口2947上查询。</p> 
<h4><a id="411_gpsd__157"></a>4.1.1 gpsd 交叉编译</h4> 
<ul><li><a href="https://gpsd.io/index.html" rel="nofollow">gpsd 官网</a> （交叉编译：Installation &amp; Building --&gt; Quick start &amp;&amp; Cross-building，注意依赖和先决条件）</li><li><a href="https://blog.csdn.net/weixin_40407893/article/details/118024630">Linux-交叉编译-gpsd</a></li><li><a href="https://gitlab.com/gpsd/gpsd" rel="nofollow">https://gitlab.com/gpsd/gpsd</a></li><li><a href="https://gpsd.gitlab.io/gpsd/gpsd-time-service-howto.html#_1pps_quality_issues" rel="nofollow">gpsd 编译1pps配置</a></li></ul> 
<p><strong>1. gpsd 源码下载</strong></p> 
<pre><code class="prism language-bash"><span class="token comment"># 方式一（当前版本是 v3.25.1）</span>
<span class="token function">git</span> clone https://gitlab.com/gpsd/gpsd

<span class="token comment"># 方式二：浏览器下载源码压缩包</span>
</code></pre> 
<p><strong>2. ubuntu 下安装交叉编译工具链以及编译工具scons</strong><br> 1） 确保ubuntu系统已经安装python<br> 2） 已安装交叉编译工具链 arm-fslc-linux-gnueabi-gcc<br> 3）安装编译工具 scons</p> 
<p>scons是linux下的自动构建工具，类似cmake.</p> 
<pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> scons
</code></pre> 
<p><strong>3.1 交叉编译依赖库libusb</strong></p> 
<p>交叉编译gpsd，需要安装依赖库 libusb 、libncurses、libtinfo。</p> 
<p>1）下载libusb：<a href="http://sourceforge.net/projects/libusb/files/" rel="nofollow">http://sourceforge.net/projects/libusb/files/</a> （这里下载的 libusb-1.0.22.tar.bz2）<br> 2）交叉编译源码</p> 
<pre><code class="prism language-bash"><span class="token comment"># 解压</span>
<span class="token function">tar</span> xjvf libusb-1.0.22.tar.bz2
<span class="token builtin class-name">cd</span> libusb-1.0.22

<span class="token comment"># 配置交叉编译</span>
./configure <span class="token assign-left variable">CC</span><span class="token operator">=</span><span class="token string">"arm-fslc-linux-gnueabi-gcc  -march=armv7-a -mthumb -mfpu=neon -mfloat-abi=hard --sysroot=/opt/fslc-framebuffer/2.4.4/sysroots/armv7at2hf-neon-fslc-linux-gnueabi"</span> <span class="token parameter variable">--host</span><span class="token operator">=</span>arm-fslc-linux-gnueabi <span class="token parameter variable">--prefix</span><span class="token operator">=</span><span class="token environment constant">$PWD</span>/install_arm --disable-udev

<span class="token comment"># 编译和安装</span>
<span class="token function">make</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span>

<span class="token comment"># 查看成果物(头文件、库、pkgconfig文件)，一会要将库文件统一拷贝到gpsd目录下</span>
<span class="token function">ls</span> <span class="token parameter variable">-R</span> install_arm
<span class="token function">cp</span> <span class="token parameter variable">-rf</span> install_arm/lib/* <span class="token punctuation">..</span>/lib
</code></pre> 
<p><strong>3.2 交叉编译依赖库libncurses</strong><br> 1）下载ncurses库源码包：<a href="http://ftp.gnu.org/pub/gnu/ncurses/" rel="nofollow">http://ftp.gnu.org/pub/gnu/ncurses/</a> （这里下载的是ncurses-6.1.tar.gz）<br> 2）交叉编译源码</p> 
<pre><code class="prism language-bash"><span class="token comment"># 解压</span>
<span class="token function">tar</span> <span class="token parameter variable">-xzvf</span> ncurses-6.1.tar.gz
<span class="token builtin class-name">cd</span> ncurses-6.1/
<span class="token comment"># 配置交叉编译</span>
./configure <span class="token assign-left variable">CC</span><span class="token operator">=</span><span class="token string">"arm-fslc-linux-gnueabi-gcc  -march=armv7-a -mthumb -mfpu=neon -mfloat-abi=hard --sysroot=/opt/fslc-framebuffer/2.4.4/sysroots/armv7at2hf-neon-fslc-linux-gnueabi"</span> <span class="token parameter variable">--host</span><span class="token operator">=</span>arm-fslc-linux-gnueabi <span class="token parameter variable">--prefix</span><span class="token operator">=</span><span class="token environment constant">$PWD</span>/install_arm
<span class="token comment"># 编译和安装</span>
<span class="token function">make</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span>
<span class="token comment"># 拷贝库成果物</span>
<span class="token function">cp</span> <span class="token parameter variable">-rf</span> install_arm/lib/* <span class="token punctuation">..</span>/lib
</code></pre> 
<p><strong>3.3 交叉编译pps-tools（可选）</strong></p> 
<ul><li><a href="https://github.com/redlab-i/pps-tools">github 源码</a></li><li><a href="https://gitee.com/mirrors/pps-tools" rel="nofollow">gitee 源码</a></li><li>源码下载：<a href="https://packages.ubuntu.com/zh-cn/source/jammy/riscv64/pps-tools" rel="nofollow">https://packages.ubuntu.com/zh-cn/source/jammy/riscv64/pps-tools</a></li></ul> 
<p>计划使用gpsd + pps + chrony来使用，这里交叉编译pps-tools，一方面使用工具，<font color="red">另外一方面gpsd若支持pps需要 timepps.h 头文件（需要放到指定位置，以便编译时能找到）</font></p> 
<p>1）下载源码包：github下载压缩包（这里下载版本1.0.2）<br> 2）交叉编译源码</p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">cd</span> pps-tools-1.0.2/
<span class="token comment"># 配置环境变量</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">CC</span><span class="token operator">=</span><span class="token string">"arm-fslc-linux-gnueabi-gcc  -march=armv7-a -mthumb -mfpu=neon -mfloat-abi=hard --sysroot=/opt/fslc-framebuffer/2.4.4/sysroots/armv7at2hf-neon-fslc-linux-gnueabi"</span>

<span class="token comment"># 成果物（可执行程序）有：ppstest、ppsctl、ppswatch</span>

<span class="token comment"># 拷贝gpsd pps依赖头文件（已根据sysroot，所以拷贝到对应路径下）</span>
<span class="token function">cp</span> timepps.h /opt/fslc-framebuffer/2.4.4/sysroots/armv7at2hf-neon-fslc-linux-gnueabi/usr/include/sys/
</code></pre> 
<p><strong>4. gpsd 交叉编译</strong></p> 
<p>1）配置交叉编译</p> 
<p><img src="https://images2.imgbox.com/ac/50/oeQOuspA_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">cd</span> gpsd

<span class="token comment"># 拷贝依赖库</span>
<span class="token function">cp</span> <span class="token parameter variable">-fr</span> <span class="token punctuation">..</span>/lib/* <span class="token builtin class-name">.</span>

<span class="token comment"># 新增交叉编译配置</span>
<span class="token function">vi</span> .scons-option-cache
</code></pre> 
<p>配置如下内容：</p> 
<pre><code class="prism language-bash">libgpsmm <span class="token operator">=</span> False
python <span class="token operator">=</span> False
prefix <span class="token operator">=</span> <span class="token string">'/mnt/d/hik/debug/opensource/gpsd-depend/20231114/gpsd/install_arm'</span>
sysroot <span class="token operator">=</span> <span class="token string">'/opt/fslc-framebuffer/2.4.4/sysroots/armv7at2hf-neon-fslc-linux-gnueabi'</span>
target <span class="token operator">=</span> <span class="token string">'arm-fslc-linux-gnueabi'</span>
</code></pre> 
<p>修改 SConscript 文件</p> 
<pre><code class="prism language-bash">将 dbus_export 改成 <span class="token boolean">false</span> 或 交叉编译 dbus-1.14.0
</code></pre> 
<p>2）操作交叉编译（参考Quick start章节）</p> 
<pre><code class="prism language-bash"><span class="token comment"># 配置环境变量</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">CC</span><span class="token operator">=</span><span class="token string">"arm-fslc-linux-gnueabi-gcc  -march=armv7-a -mthumb -mfpu=neon -mfloat-abi=hard --sysroot=/opt/fslc-framebuffer/2.4.4/sysroots/armv7at2hf-neon-fslc-linux-gnueabi"</span>

<span class="token comment"># 清理、编译、安装</span>
scons <span class="token parameter variable">-c</span>
scons <span class="token assign-left variable">pps</span><span class="token operator">=</span>yes <span class="token assign-left variable">ntpshm</span><span class="token operator">=</span>yes <span class="token assign-left variable">prefix</span><span class="token operator">=</span><span class="token environment constant">$PWD</span>/install_arm
scons check						<span class="token comment"># 忽略报错</span>
<span class="token function">sudo</span> scons <span class="token function">install</span>				<span class="token comment"># 要带sudo、不然只安装gpsd，没其他组件</span>

<span class="token comment"># 参考留底</span>
<span class="token comment"># scons pps=yes ntpshm=yes prefix=$PWD/install_arm -n</span>
<span class="token comment"># scons pps=yes ntpshm=yes timeservice=yes nmea0183=yes -n</span>
<span class="token comment"># source /opt/fslc-framebuffer/2.4.4/environment-setup-armv7at2hf-neon-fslc-linux-gnueabi</span>

<span class="token comment"># 查看安装结果，如下图（若没成功再检查修复）</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/f9/56/3Dv3S73m_o.png" alt="在这里插入图片描述"></p> 
<p>注意，若没有python，操作安装或软连接</p> 
<pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">ln</span> <span class="token parameter variable">-s</span> /usr/bin/python3 /usr/bin/python
<span class="token comment"># 或</span>
<span class="token function">sudo</span> <span class="token function">ln</span> <span class="token parameter variable">-s</span> /opt/fslc-x11/2.4.4/sysroots/x86_64-fslcsdk-linux/usr/bin/python3  /usr/bin/python
</code></pre> 
<h4><a id="412_gpsd__307"></a>4.1.2 gpsd 使用</h4> 
<p>将gpsd、gpsmon、cgps、ppstest等拷贝到arm设备中，比如拷贝到/app/gpsd-test目录下，添加可执行权限 <code>chmod +x /app/gpsd-test/*</code></p> 
<ul><li><li><a href="https://blog.csdn.net/TSZ0000/article/details/131226209">嵌入式Linux时间同步 gpsd+chrony+pps</a></li><li><a href="https://gpsd.gitlab.io/gpsd/index.html" rel="nofollow">gpsd软件包介绍</a></li><li>gpsmon：gpsmon实时数据包监控和诊断工具。</li></ul> 
<pre><code class="prism language-bash"><span class="token builtin class-name">cd</span> /app/gpsd-test

<span class="token comment"># gpsd 查看支持项</span>
./gpsd <span class="token parameter variable">-l</span>

<span class="token comment"># gpsd 使用pps </span>
./gpsd <span class="token parameter variable">-n</span> <span class="token parameter variable">-G</span> /dev/ttyUSB5 /dev/pps1 
./gpsd <span class="token parameter variable">-n</span> <span class="token parameter variable">-G</span> <span class="token parameter variable">-s</span> <span class="token number">115200</span> /dev/ttymxc3 /dev/pps1

<span class="token comment"># gpsd 不使用pps </span>
./gpsd <span class="token parameter variable">-n</span> <span class="token parameter variable">-G</span> /dev/ttymxc3

<span class="token comment"># 带调试</span>
./gpsd <span class="token parameter variable">-D</span> <span class="token number">5</span> <span class="token parameter variable">-N</span> <span class="token parameter variable">-n</span> /dev/ttymxc3 /dev/pps1

<span class="token comment"># 数据验证</span>
./gpsmon

<span class="token comment"># 查看和修改串口波特率（由于gpsd没有设置，所以系统必须设置好 或 -s 指定波特率）</span>
stty <span class="token parameter variable">-F</span> /dev/ttymxc3
stty <span class="token parameter variable">-F</span> /dev/ttymxc3 speed <span class="token number">115200</span>
</code></pre> 
<p><code>./gpsd -l</code> 查看是否开启PPS<br> <img src="https://images2.imgbox.com/e5/03/uuNUVD76_o.png" alt="在这里插入图片描述"></p> 
<p>gpsd 带pps时，执行 <code>./gpsmon</code> 效果<br> <img src="https://images2.imgbox.com/14/6f/q6s2TR1V_o.png" alt="在这里插入图片描述"><br> gpsd 不带pps时，执行 <code>./gpsmon</code> 效果<br> <img src="https://images2.imgbox.com/d3/31/Qn0ySMEh_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="412_gpsd__chrony_349"></a>4.1.2 gpsd + chrony</h4> 
<ol><li>要先启动 gpsd</li><li>再启动 chronyd （先修改设置好配置文件 /etc/chrony.conf）</li></ol> 
<pre><code class="prism language-bash"><span class="token function">mv</span> /etc/chrony.conf /etc/chrony.conf.bk <span class="token comment"># 备份下原来文件</span>

<span class="token function">vi</span> /etc/chrony.conf
</code></pre> 
<p>填写如下内容：</p> 
<pre><code class="prism language-bash"><span class="token comment"># gpsd and pps 注意pps节点名称</span>
refclock SHM <span class="token number">0</span> poll <span class="token parameter variable">-2</span> refid GPS precision 1e-1 offset <span class="token number">0.9999</span> delay <span class="token number">0.2</span>
refclock PPS /dev/pps1 lock NMEA refid PPS

makestep <span class="token number">0.1</span> <span class="token parameter variable">-1</span>
driftfile /var/lib/chrony/drift
rtcsync

<span class="token comment"># 作为校时服务器（用来给其他设备校时 或 比较时间差）</span>
allow all
<span class="token builtin class-name">local</span> stratum <span class="token number">10</span>
</code></pre> 
<p>启动gpsd和chronyd</p> 
<pre><code class="prism language-bash"><span class="token function">killall</span> <span class="token parameter variable">-15</span> gpsd chronyd  	<span class="token comment"># 执行两遍</span>
./gpsd <span class="token parameter variable">-n</span> <span class="token parameter variable">-G</span> <span class="token parameter variable">-s</span> <span class="token number">115200</span> /dev/ttymxc3 /dev/pps1
chronyd <span class="token parameter variable">-d</span> <span class="token operator">&amp;</span>
./ppstest /dev/pps1			<span class="token comment"># 要稍微等一会才会校准</span>

<span class="token comment"># 比较时间</span>



./gpsd <span class="token parameter variable">-D</span> <span class="token number">5</span> <span class="token parameter variable">-N</span> <span class="token parameter variable">-n</span> /dev/ttyUSB5 /dev/pps1
chronyc sources
<span class="token function">date</span> +%Y-%m-%d<span class="token string">' '</span>%H:%M:%S.%N <span class="token operator">|</span> <span class="token function">cut</span> <span class="token parameter variable">-b</span> <span class="token number">1</span>-23		
./ntpdate <span class="token parameter variable">-q</span> <span class="token number">10.234</span>.111.138
</code></pre> 
<h3><a id="42_pps__ppstools__395"></a>4.2 pps 和 pps-tools 介绍和使用</h3> 
<ul><li>PPS 支持需要：GPS接收器 + 硬件设计连接 + 内核配置开启 + 驱动。</li><li>查看当前系统是否已支持 pps</li><li>ppstest查看pps信号时间值</li><li>查看pps中断</li><li>pps配合gpsd使用（配合）</li></ul> 
<p>PPS是指脉冲秒信号（Pulse Per Second），它是一个精确的时间标记信号，用于精确同步计时设备。PPS通常由GPS接收器提供，以确保设备与全球卫星导航系统（GPS）的时间同步。</p> 
<p>PPS-Tools是一个用于处理和分析PPS信号的软件工具包。它包含了一系列用于接收、分析和校准PPS信号的工具和库。使用PPS-Tools，用户可以通过计算和比较PPS信号与其他参考时间源的差异来实现高精度的时间同步。</p> 
<p>PPS-Tools的功能包括：</p> 
<ol><li>PPS接收器：用于接收和解码PPS信号的硬件设备。</li><li>PPS校准：通过与参考时间源比较PPS信号，进行时间校准和同步。</li><li>数据记录和分析：记录和分析PPS信号的时间戳数据。</li><li>精度测量：测量PPS信号与参考时间源之间的精确度和稳定性。</li></ol> 
<p>PPS-Tools是一个强大的工具包，广泛用于科学研究、计时设备校准和精确时间同步等领域。它可以帮助用户实现微秒级甚至更高精度的时间同步，对于需要高精度时间标记的应用非常有用。</p> 
<p><strong>查看当前系统是否已支持 pps</strong></p> 
<pre><code class="prism language-bash"><span class="token function">dmesg</span> <span class="token operator">|</span> <span class="token function">grep</span> pps

./ppstest /dev/pps*
</code></pre> 
<p><img src="https://images2.imgbox.com/9d/a5/ofbQt4N8_o.png" alt="在这里插入图片描述"></p> 
<p><strong>在应用层，使用ppstest工具可查看pps信号时间值（pps信号发生时刻的系统时间点）</strong></p> 
<p>ppstest若没有需通过源码交叉编译得到。<br> <img src="https://images2.imgbox.com/27/3e/dGY14H6m_o.png" alt="在这里插入图片描述"><br> 注意，若pps已校准，时间精度会变高：<br> <img src="https://images2.imgbox.com/4e/ce/BdYyUEdN_o.png" alt="在这里插入图片描述"></p> 
<p><strong>查看pps中断：</strong></p> 
<pre><code class="prism language-bash">root@imx6qdlsabresd:/app/test/debug_gpsd<span class="token comment"># cat /proc/interrupts |grep pps</span>
 <span class="token number">37</span>:     <span class="token number">258897</span>          <span class="token number">0</span>          <span class="token number">0</span>          <span class="token number">0</span>  gpio-mxc   <span class="token number">5</span> Edge      pps.-1
root@imx6qdlsabresd:/app/test/debug_gpsd<span class="token comment"># cat /proc/interrupts |grep pps</span>
 <span class="token number">37</span>:     <span class="token number">258899</span>          <span class="token number">0</span>          <span class="token number">0</span>          <span class="token number">0</span>  gpio-mxc   <span class="token number">5</span> Edge      pps.-1
root@imx6qdlsabresd:/app/test/debug_gpsd<span class="token comment"># cat /proc/interrupts |grep pps</span>
 <span class="token number">37</span>:     <span class="token number">258903</span>          <span class="token number">0</span>          <span class="token number">0</span>          <span class="token number">0</span>  gpio-mxc   <span class="token number">5</span> Edge      pps.-1
</code></pre> 
<p><strong>参考资料</strong></p> 
<ul><li>交叉编译pps-tools（见 gpsd交叉编译章节）</li><li><a href="https://blog.csdn.net/wind0419/article/details/106680799">关于GPS的1PPS时间同步功能探索与测试</a></li><li><a href="https://blog.51cto.com/u_15904120/5917270" rel="nofollow">关于GPS的1PPS时间同步功能探索与测试</a></li></ul> 
<h2><a id="_451"></a>五、比较两个设备时间差</h2> 
<h3><a id="51_date__452"></a>5.1 date 命令</h3> 
<p>两台设备分别通过xshll工具进行SSH连接，然后工具—发送输入到—所有会话：</p> 
<pre><code class="prism language-bash"><span class="token comment"># 获取系统时间纳秒</span>
<span class="token function">date</span> +%Y-%m-%d<span class="token string">' '</span>%H:%M:%S.%N

<span class="token comment"># 获取系统时间毫秒</span>
<span class="token function">date</span> +%Y-%m-%d<span class="token string">' '</span>%H:%M:%S.%N <span class="token operator">|</span> <span class="token function">cut</span> <span class="token parameter variable">-b</span> <span class="token number">1</span>-23

<span class="token comment"># 自动循环获取时间（有休眠、不如手动敲）</span>
<span class="token keyword">while</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token function">date</span> +%Y-%m-%d<span class="token string">' '</span>%H:%M:%S.%N<span class="token punctuation">;</span> <span class="token function">sleep</span> <span class="token number">0.1</span><span class="token punctuation">;</span><span class="token keyword">done</span>
</code></pre> 
<ul><li>若性能要求高：务必确保两台设备、PC在同一个交换机下。</li><li>时间误差：PC到两台设备的网络时延、IO时延。</li></ul> 
<h3><a id="52_ntpdate_469"></a>5.2 ntpdate命令</h3> 
<h4><a id="521__471"></a>5.2.1 使用示例</h4> 
<p><font color="red">只比较和ntp 服务器的时间差，不校时：</font>(务必在同一个交换机下)</p> 
<pre><code class="prism language-bash">./ntpdate <span class="token parameter variable">-q</span> ntp1.aliyun.com
</code></pre> 
<blockquote> 
 <p>响应：<br> server 120.25.115.20, stratum 2, offset 32.851291, delay 0.04848 8<br> Sep 14:43:24 ntpdate[15053]: step time server 120.25.115.20 offset 32.851291 sec</p> 
</blockquote> 
<h4><a id="522_ntpdate__483"></a>5.2.2 ntpdate 交叉编译</h4> 
<ul><li><a href="http://distfiles.macports.org/ntp/" rel="nofollow">ntp 和 ntpdate 源码下载地址</a></li><li><a href="https://www.ntp.org/downloads/" rel="nofollow">https://www.ntp.org/downloads/</a></li></ul> 
<p>版权声明：本文为CSDN博主「钱德勒宾」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。<br> 原文链接：<a href="https://blog.csdn.net/weixin_38184741/article/details/100011091">https://blog.csdn.net/weixin_38184741/article/details/100011091</a></p> 
<p><strong>前言</strong>：<br> 板子上需要在开机时同步网络时间。</p> 
<p>之前板子上有<code>ntpdate</code>工具，可以直接使用。最近突然不能用了。需要手动移植一个。</p> 
<p>开发板：<code>Hi3559A</code></p> 
<p>编译工具链：<code>aarch64-himix100-linux-gcc</code></p> 
<p><code>ntp</code>版本：<code>ntp-4.2.8p13.tar.gz</code></p> 
<p><code>openssl</code> 版本：<code>openssl-1.0.1f.tar.gz</code> （注意，使用其他版本会报版本错误）</p> 
<pre><code class="prism language-bash"><span class="token comment"># 交叉编译</span>

<span class="token comment"># 配置环境变量</span>
<span class="token builtin class-name">source</span> /opt/fslc-framebuffer/2.4.4/environment-setup-armv7at2hf-neon-fslc-linux-gnueabi

./configure <span class="token parameter variable">--prefix</span><span class="token operator">=</span><span class="token environment constant">$PWD</span>/install_arm --exec-prefix<span class="token operator">=</span><span class="token environment constant">$PWD</span>/install_arm <span class="token assign-left variable">CC</span><span class="token operator">=</span><span class="token string">"arm-fslc-linux-gnueabi-gcc  -march=armv7-a -mthumb -mfpu=neon -mfloat-abi=hard --sysroot=/opt/fslc-framebuffer/2.4.4/sysroots/armv7at2hf-neon-fslc-linux-gnueabi"</span> <span class="token parameter variable">--host</span><span class="token operator">=</span>arm-fslc-linux-gnueabi --with-yielding-select<span class="token operator">=</span>yes

<span class="token function">make</span> <span class="token parameter variable">-j</span>
<span class="token function">make</span> <span class="token function">install</span>
</code></pre> 
<p>编译成果物<br> <img src="https://images2.imgbox.com/dd/05/MN4HqVy0_o.png" alt="在这里插入图片描述"><br> 以下是一些常见的 NTP 可执行文件以及它们的功能和用途：</p> 
<ol><li>ntpd：NTP 守护进程，负责运行 NTP 服务器，提供时间同步服务。</li><li>ntpdate：手动更新系统时间的工具，通过与指定的 NTP 服务器通信，将服务器的时间应用到本地系统上。</li><li>ntpq：NTP 查询工具，用于监控和调试 NTP 服务器。通过 ntpq，你可以查看服务器状态、查询时间同步信息等。</li><li>ntpdc：NTP 控制台工具，用于与 NTP 服务器进行交互，进行配置、查询状态和执行其他管理操作。</li><li>ntptrace：追踪 NTP 服务器的路径，显示从本地系统到指定服务器的网络路径。</li><li>ntp-keygen：用于生成和管理 NTP 安全密钥的工具，用于加密和验证 NTP 服务器之间的通信。</li></ol> 
<h4><a id="523_chronyd__529"></a>5.2.3 chronyd 命令</h4> 
<p><img src="https://images2.imgbox.com/dc/be/xnoik9B6_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-bash"><span class="token comment"># 校时一次退出</span>
chronyd <span class="token parameter variable">-q</span> <span class="token string">'pool pool.ntp.org iburst'</span>

<span class="token comment"># 不校时，只比较时间差</span>
chronyd <span class="token parameter variable">-Q</span> <span class="token string">'pool pool.ntp.org iburst'</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/36/7d/I1TlGrhs_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_542"></a>六、核心参考</h2> 
<ul><li><a href="http://www.360doc.com/content/22/0328/00/57514296_1023636982.shtml" rel="nofollow">一文了解自动驾驶中的时间同步</a></li><li><a href="https://blog.csdn.net/TSZ0000/article/details/131226209">嵌入式Linux时间同步 gpsd+chrony+pps</a></li><li><a href="https://blog.csdn.net/qq_41281601/article/details/129621872">chrony+gpsd部署pps校时</a></li><li><a href="https://blog.csdn.net/weixin_40407893/article/details/118024630">Linux-交叉编译-gpsd</a></li><li><a href="https://blog.csdn.net/l1212xiao/article/details/80328918">CentOS 7时间和日期和时间同步</a></li><li><a href="https://blog.csdn.net/sep4075/article/details/119249223">嵌入式Linux 时间同步 gpsd+chrony</a></li></ul> 
<p>遗留问题：</p> 
<ul><li>不同设备 gpsd + chronyd + pps 校时后时间相差较大，什么原因？</li><li>gpsd + chronyd + pps 原理</li></ul>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f05c95852b9c24e0f1f3d54de12fc94e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Android8.1 MTK 去掉锁屏功能</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ba229b683bc47bf321b805d59a55be48/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">html表单和（横向）导航栏</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>