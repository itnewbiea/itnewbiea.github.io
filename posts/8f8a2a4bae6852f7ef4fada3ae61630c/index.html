<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>插件化原理 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="插件化原理" />
<meta property="og:description" content="插件化技术和热修复技术都属于动态加载，从普及率的角度来看，插件化技术还没有热修复的普及率高，主要原因是占大多数的中小型应用很少也没有必要去采用插件化技术。
Android P preview（Android 9）开始限制调用隐藏 API，也出现了一些绕过限制的方案。无论采用何种方案，插件化的原理还是需要理解的。
1 动态加载技术 动态加载技术是插件化的前身。
在 Android 传统开发中，一旦应用的代码被打包成 APK 并被上传到各个渠道市场，就不能修改应用的源码了。只能通过服务器来控制应用中预留的分支代码。但是很多时候我们无法提前预知需求和突发的情况，也就不能提前在应用代码中预留分支代码，这时就需要采用动态加载技术。
在应用程序运行时，动态加载一些程序中原本不存在的可执行文件并运行这些文件里的代码逻辑。可执行文件总的来说分为两种，一种是动态链接库 so，另一种是 dex 相关文件（dex 以及包含 dex 的 jar/apk 文件）。
随着应用的发展，动态加载技术派生出两个技术，分别是热修复技术和插件化技术：
其中热修复技术主要用来修复 Bug，插件化技术则主要用于解决应用越来越庞大以及功能模块的解耦，围绕着两个技术出现了很多的热修复框架和插件化框架。 需要注意的是，动态加载技术本身并没有被官方认可，并且是一个非常规的技术，在国外这门技术关注度并不高，它的产生更多的是国内的业务需求和产品驱动。
2 插件化的产生 在 Android 开发早起很少用到动态加载技术，因为这个时候业务需求和应用开发的复杂度不是很大高，但随着互联网的发展会出现以下几种情况：
1 业务复杂，模块耦合
随着业务越来越复杂越来越多，导致应用体积越来越大，应用程序的工程和功能模块数量越来越多，一个应用可能是由几十、几百人协同开发的，很多工程和功能模块都是由一个小组进行开发维护的，如果功能模块间的耦合度比较高，修改一个功能模块会影响其他的功能模块，势必会极大地增加沟通成本。
2 应用间的接入
一个应用不再是单独的应用，它可能需要接入其他的应用。拿手机淘宝来说，它的流量非常大，其他的淘宝应用或者业务比如：聚划算、菜鸟、淘票票、饿了么等都希望接入到淘宝客户端，这样既能获取到流量，同时也可以将用于引流到自己的应用中，如果使用常规的技术手段，会产生两个问题：
比如饿了么需要接入到淘宝客户端中，那么饿了么团队可能需要维护两个版本，一个是自身版本，另一个是淘宝客户端版本，这样维护成功和沟通成本会比较高。况且饿了么不止是接入淘宝客户端，它还可以接入到其他应用中，比如支付宝应用，那么饿了么团队维护的就不仅仅是两个版本了；比如淘宝客户端接入很多其他的应用，势必会使应用的体积急剧变大，编译时间会变得非常长，一个 Bug 和功能就会由组内的开发协作变为组与组之间甚至是部门之间的开发协作，极大地增加了开发测试成本和沟通成本，新功能的添加会牵扯的越多，版本发布的时间变得不可控； 3 65536 限制，内存占用大
随着应用功能越来越复杂，代码量不断的增大，引入的库也越来越多，可能会在编译时提示如下异常：
com.android.dex.DexIndexOverflowException: method ID not in [0, 0xffff]: 65536 这说明应用引用的方法超过了最大数 65536 个，产生这一问题的原因就是系统的 65536 限制，65536 限制的主要原因是 DVM Bytecode 的限制，DVM 指令集的方法调用指令 invoke-kind 索引为 16bits，最多能引用 65535 个方法。
应用代码量的增加同时也导致应用占用大量的内存。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/8f8a2a4bae6852f7ef4fada3ae61630c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-09-18T16:19:20+08:00" />
<meta property="article:modified_time" content="2023-09-18T16:19:20+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">插件化原理</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>插件化技术和热修复技术都属于动态加载，从普及率的角度来看，插件化技术还没有热修复的普及率高，主要原因是占大多数的中小型应用很少也没有必要去采用插件化技术。</p> 
<p>Android P preview（Android 9）开始限制调用隐藏 API，也出现了一些绕过限制的方案。无论采用何种方案，插件化的原理还是需要理解的。</p> 
<h4><a id="1__4"></a>1 动态加载技术</h4> 
<p>动态加载技术是插件化的前身。</p> 
<p>在 Android 传统开发中，一旦应用的代码被打包成 APK 并被上传到各个渠道市场，就不能修改应用的源码了。只能通过服务器来控制应用中预留的分支代码。但是很多时候我们无法提前预知需求和突发的情况，也就不能提前在应用代码中预留分支代码，这时就需要采用动态加载技术。</p> 
<p><strong>在应用程序运行时，动态加载一些程序中原本不存在的可执行文件并运行这些文件里的代码逻辑。可执行文件总的来说分为两种，一种是动态链接库 so，另一种是 dex 相关文件（dex 以及包含 dex 的 jar/apk 文件）。</strong></p> 
<p>随着应用的发展，动态加载技术派生出两个技术，分别是热修复技术和插件化技术：</p> 
<p><img src="https://images2.imgbox.com/a0/fa/XxDmzUjH_o.png" alt="动态加载技术的派生技术" width="40%" height="40%"></p> 
<p><strong>其中热修复技术主要用来修复 Bug，插件化技术则主要用于解决应用越来越庞大以及功能模块的解耦，围绕着两个技术出现了很多的热修复框架和插件化框架。</strong> 需要注意的是，动态加载技术本身并没有被官方认可，并且是一个非常规的技术，在国外这门技术关注度并不高，它的产生更多的是国内的业务需求和产品驱动。</p> 
<h4><a id="2__20"></a>2 插件化的产生</h4> 
<p>在 Android 开发早起很少用到动态加载技术，因为这个时候业务需求和应用开发的复杂度不是很大高，但随着互联网的发展会出现以下几种情况：</p> 
<p><strong>1 业务复杂，模块耦合</strong></p> 
<p>随着业务越来越复杂越来越多，导致应用体积越来越大，应用程序的工程和功能模块数量越来越多，一个应用可能是由几十、几百人协同开发的，很多工程和功能模块都是由一个小组进行开发维护的，<strong>如果功能模块间的耦合度比较高，修改一个功能模块会影响其他的功能模块，势必会极大地增加沟通成本。</strong></p> 
<p><strong>2 应用间的接入</strong></p> 
<p>一个应用不再是单独的应用，它可能需要接入其他的应用。拿手机淘宝来说，它的流量非常大，其他的淘宝应用或者业务比如：聚划算、菜鸟、淘票票、饿了么等都希望接入到淘宝客户端，这样既能获取到流量，同时也可以将用于引流到自己的应用中，如果使用常规的技术手段，会产生两个问题：</p> 
<ul><li>比如饿了么需要接入到淘宝客户端中，那么饿了么团队可能需要维护两个版本，一个是自身版本，另一个是淘宝客户端版本，这样维护成功和沟通成本会比较高。况且饿了么不止是接入淘宝客户端，它还可以接入到其他应用中，比如支付宝应用，那么饿了么团队维护的就不仅仅是两个版本了；</li><li>比如淘宝客户端接入很多其他的应用，势必会使应用的体积急剧变大，编译时间会变得非常长，一个 Bug 和功能就会由组内的开发协作变为组与组之间甚至是部门之间的开发协作，极大地增加了开发测试成本和沟通成本，新功能的添加会牵扯的越多，版本发布的时间变得不可控；</li></ul> 
<p><strong>3 65536 限制，内存占用大</strong></p> 
<p>随着应用功能越来越复杂，代码量不断的增大，引入的库也越来越多，可能会在编译时提示如下异常：</p> 
<pre><code>com.android.dex.DexIndexOverflowException: method ID not in [0, 0xffff]: 65536
</code></pre> 
<p>这说明应用引用的方法超过了最大数 65536 个，产生这一问题的原因就是系统的 65536 限制，65536 限制的主要原因是 DVM Bytecode 的限制，DVM 指令集的方法调用指令 invoke-kind 索引为 16bits，最多能引用 65535 个方法。</p> 
<p><strong>应用代码量的增加同时也导致应用占用大量的内存。</strong></p> 
<h4><a id="3__47"></a>3 插件化思想</h4> 
<p>Android 系统本身并没有提供太多的功能，内置的应用数量和整体功能也很有限，它像一个为人类服务的机器人，只能满足基本的需求。如下所示：</p> 
<p><img src="https://images2.imgbox.com/0d/32/7ulhgsHM_o.png" alt="Android 系统" width="50%" height="50%"></p> 
<p>可以看到初始的机器人只有相机、天气、地图、浏览器、计算器等功能，这显然是很乏味的，我们可以给这个机器人安装很多其他的应用，使它提供更多的功能，如下所示：</p> 
<p><img src="https://images2.imgbox.com/51/0f/KgwrgJ5N_o.png" alt="Android 系统" width="50%" height="50%"></p> 
<p>我们给这个设备安装了很多应用，这些应用不仅覆盖了人的衣食住行，还提供了娱乐功能，我们可以玩游戏、听音乐和购物等，手机的功能也得到了极大提升，能够为人类提供更多的服务。这些安装的应用可以理解为插件，这些插件可以自由地进行插拔，比如我们需要听音乐时可以安装“酷狗音乐”，如果不好用就把它卸载掉。这么说来其实 Android、iOS、Mac 等操作系统采用的都是这种思想，也就是插件化思想。</p> 
<h4><a id="4__59"></a>4 插件化定义</h4> 
<p>第 2 节所提出的问题就可以采用插件化的思想来解决，如果没有采用插件化，那么手机淘宝客户端的框架可以缩略为下图所示的样子：</p> 
<p><img src="https://images2.imgbox.com/f1/5a/EIIG8wWY_o.png" alt="淘宝客户端" width="80%" height="80%"></p> 
<p>上图中采用常规技术的淘宝客户端分为两大部分，一个是自身的业务模块，比如购物、逛逛、消息和搜索等，另一个是要外接的其他的应用业务，比如聚划算、菜鸟、淘票票和饿了么等。如果采用这种常规的技术方案，那么就会产生第二节的各种问题，为了解决这些问题，我们可以采用插件化的思想来对淘宝主客户端的框架进行改造，如图所示：</p> 
<p><img src="https://images2.imgbox.com/96/2c/tbN1cG52_o.png" alt="采用插件化思想的淘宝客户端" width="70%" height="70%"></p> 
<p><strong>插件化的客户端由宿主和插件两个部分组成。宿主就是指被安装到手机中的 APK，插件一般是指经过处理的 APK、so 和 dex 等文件，插件可以被宿主进行加载，有的插件也可以作为 APK 独立运行。</strong></p> 
<p>可以看出采用插件化的淘宝客户端分为两大部分，一部分是宿主，也就是淘宝客户端；另一部分是插件部分，不仅包括了外接的其他应用业务，比如聚划算和菜鸟，同时也包括了淘宝自身的业务模块，比如消息和搜索。需要注意的是，这里的举例更过是为了便于理解，只是淘宝客户端演讲过程中的一个非常缩略的框架，和真实的淘宝客户端有非常大的区别。</p> 
<p><strong>插件化的定义：将一个应用按照插件的方式进行改造的过程就叫做插件化。</strong></p> 
<p>采用了插件化的淘宝客户端就能避免出现第 2 节出现的各种问题，在协作方面，插件可以由一个人或者一个小组来进行开发，这样各个插件之间，以及插件和宿主之间的耦合度会降低。应用间的接入和维护也变的便捷，每个应用团队只需要负责自己的那一部分就可以了。应用以及主 dex 的体积也会相应变小，间接地避免了 65536 限制。<strong>第一次加载到内存的只有淘宝主客户端，当使用到其他插件时才会加载相应的插件到内存，这样就减少了内存的占用。</strong></p> 
<h4><a id="5__77"></a>5 插件化框架对比</h4> 
<p>为了方便地将应用插件化，出现了很多插件化的框架。虽然插件化湿近两年才受到广泛的关注，但是其实在 2012 年大众点评的屠毅就推出了 AndroidDynamicLoader 框架，这是最早的插件化框架。插件化技术发展到现在，已经产生了众多插件化框架，如下图所示：</p> 
<p><img src="https://images2.imgbox.com/47/8a/9wCKflzg_o.png" alt="主流的插件化方案对比" width="100%" height="100%"></p> 
<p>目前主流的插件化方案对比，如下所示：</p> 
<p><img src="https://images2.imgbox.com/a7/64/g2RNHkDs_o.png" alt="主流的插件化" width="100%" height="100%"></p> 
<p>如果加载的插件不需要和宿主有任何耦合，也无须和宿主进行通信，比如加载第三方 APP，那么推荐使用 RePlugin，其他的情况推荐使用 VirtualApk。</p> 
<h4><a id="6_Activity__89"></a>6 Activity 插件化</h4> 
<p><strong>Activity 插件化主要有 3 种实现方式，分别是反射实现、接口实现和 Hook 技术实现。</strong> 反射实现会对性能有所影响，主流的插件化框架没有采用此方式。目前 Hook 技术实现是主流，因此着重介绍 Hook 技术的实现。</p> 
<p><strong>Hook 技术实现主要有两种解决方案，一种是通过 Hook IActivityManager 来实现，另一种是 Hook Instrumentation 实现。</strong></p> 
<h5><a id="61_Activity__95"></a>6.1 Activity 的启动流程回顾</h5> 
<p>Activity 的启动分为两种，一种是根 Activity 的启动，另一种是普通 Activity 的启动。</p> 
<p>对于根 Activity 的启动，首先是 Launcher 进程向 system_server 进程的 ATMS 请求创建 Activity，如果所需要的应用程序进程不存在，就会向 Zygote 进程请求创建新的应用程序进程，应用程序进程启动后，ATMS 会请求应用程序进程创建并启动根 Activity。以下是根 Activity 的启动流程：</p> 
<p><img src="https://images2.imgbox.com/53/0c/po16D44Y_o.png" alt="根 Activity 的启动流程" width="60%" height="60%"></p> 
<p>对于普通的 Activity 的启动，不会涉及到应用进程的创建，和 Launcher 进程也没有关系。应用进程中的 Activity 向 system_server 进程中的 ATMS 请求创建 Activity，ATMS 会对这个 Activity 的生命周期和栈进行管理，校验 Activity 等。<strong>如果 Activity 满足 ATMS 的校验，ATMS 就会请求应用程序中的 ActivityThread 创建并启动 Activity。</strong></p> 
<p>以下是普通 Activity 的启动流程：</p> 
<p><img src="https://images2.imgbox.com/4c/eb/WwuuAZVZ_o.png" alt="普通 Activity 的启动过程" width="70%" height="70%"></p> 
<h5><a id="62_Hook_IActivityTaskManager__109"></a>6.2 Hook IActivityTaskManager 方案实现</h5> 
<p>ATMS 存在于 system_server 进程中，无法直接修改，只能在应用程序进程中做文章，可以采用预先占位的方式来解决没有在 AndroidManifest.xml 中显示声明的问题。</p> 
<p><strong>具体做法就是在 Activity 访问 ATMS 之前使用一个在 AndroidManifest.xml 中注册的 Activity 来进行占位，用来通过 ATMS 的校验，接着在 ATMS 向 ApplicationThread 发送请求时用插件 Activity 替换占位的 Activity。</strong></p> 
<h6><a id="621__Activity__115"></a>6.2.1 注册 Activity 进行占位</h6> 
<p>创建一个 TargetActivity 代表已经加载进来的插件 Activity，接着再创建一个 SubActivity 来进行占位。在 AndroidManifest.xml 中注册 SubActivity，如下所示：</p> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>manifest</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>android</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res/android<span class="token punctuation">"</span></span>
    <span class="token attr-name">package</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.example.myapplication<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>application</span>
        <span class="token attr-name">...</span> <span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>activity</span>
            <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>.MainActivity<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>exported</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>label</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@string/app_name<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>theme</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@style/Theme.androidcenter.NoActionBar<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>intent-filter</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>android.intent.action.MAIN<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>

                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>category</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>android.intent.category.LAUNCHER<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>intent-filter</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>activity</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>activity</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>.SubActivity<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>application</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>manifest</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>TargetActivity 用来代表已经被加载进来的插件 Activity，因此不需要在 AndroidManifest.xml 中进行注册。如果直接在 MainActivity 中启动 TargetActivity 肯定会报错（android.content.ActivityNotFoundException）：</p> 
<pre><code class="prism language-java"><span class="token class-name">Intent</span> intent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token class-name">MainActivity</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token class-name">TargetActivity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">startActivity</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>运行，出现以下问题：</p> 
<p><img src="https://images2.imgbox.com/e6/de/drMRxhWC_o.png" alt="未在清单文件中注册" width="100%" height="100%"></p> 
<p>这是 TargetActivity 没有在清单文件中进行注册的原因。那么如何避开清单文件的检查，正常的调用起 TargetActivity 呢？可以通过 Hook 技术，避开清单文件的校验，从而实现跳转到未注册的 TargetActivity 中。</p> 
<p><img src="https://images2.imgbox.com/24/e5/J8otrbx4_o.png" alt="Hook 技术" width="60%" height="60%"></p> 
<h6><a id="622__Activity__ATMS__158"></a>6.2.2 使用占位 Activity 通过 ATMS 验证</h6> 
<p>为了防止报错，需要将启动的 TargetActivity 替换为 SubActivity，用 SubActivity 来通过 ATMS 的验证。</p> 
<p>以下是 Android 7.0 的相关源码：</p> 
<pre><code class="prism language-java"><span class="token comment">// /frameworks/base/core/java/android/app/Instrumentation.java</span>
<span class="token keyword">public</span> <span class="token class-name">ActivityResult</span> <span class="token function">execStartActivity</span><span class="token punctuation">(</span>
    <span class="token class-name">Context</span> who<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> contextThread<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> token<span class="token punctuation">,</span> <span class="token class-name">String</span> target<span class="token punctuation">,</span>
    <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> options<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        intent<span class="token punctuation">.</span><span class="token function">migrateExtraStreamToClipData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        intent<span class="token punctuation">.</span><span class="token function">prepareToLeaveProcess</span><span class="token punctuation">(</span>who<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token class-name">ActivityManagerNative</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">startActivity</span><span class="token punctuation">(</span>whoThread<span class="token punctuation">,</span> who<span class="token punctuation">.</span><span class="token function">getBasePackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> intent<span class="token punctuation">,</span>
                    intent<span class="token punctuation">.</span><span class="token function">resolveTypeIfNeeded</span><span class="token punctuation">(</span>who<span class="token punctuation">.</span><span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    token<span class="token punctuation">,</span> target<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
        <span class="token function">checkStartActivityResult</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Failure from system"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">// frameworks/base/core/java/android/app/ActivityManagerNative.java</span>
<span class="token keyword">static</span> <span class="token keyword">public</span> <span class="token class-name">IActivityManager</span> <span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> gDefault<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Singleton</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IActivityManager</span><span class="token punctuation">&gt;</span></span> gDefault <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IActivityManager</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">protected</span> <span class="token class-name">IActivityManager</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">IBinder</span> b <span class="token operator">=</span> <span class="token class-name">ServiceManager</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token string">"activity"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token string">"ActivityManager"</span><span class="token punctuation">,</span> <span class="token string">"default service binder = "</span> <span class="token operator">+</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">IActivityManager</span> am <span class="token operator">=</span> <span class="token function">asInterface</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token string">"ActivityManager"</span><span class="token punctuation">,</span> <span class="token string">"default service = "</span> <span class="token operator">+</span> am<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> am<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">ActivityManagerProxy</span> <span class="token keyword">implements</span> <span class="token class-name">IActivityManager</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">startActivity</span><span class="token punctuation">(</span><span class="token class-name">IApplicationThread</span> caller<span class="token punctuation">,</span> <span class="token class-name">String</span> callingPackage<span class="token punctuation">,</span>
                             <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token class-name">String</span> resolvedType<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> resultTo<span class="token punctuation">,</span> 
                             <span class="token class-name">String</span> resultWho<span class="token punctuation">,</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token keyword">int</span> startFlags<span class="token punctuation">,</span> 
                             <span class="token class-name">ProfilerInfo</span> profilerInfo<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> options<span class="token punctuation">)</span> 
      <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Parcel</span> data <span class="token operator">=</span> <span class="token class-name">Parcel</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Parcel</span> reply <span class="token operator">=</span> <span class="token class-name">Parcel</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        data<span class="token punctuation">.</span><span class="token function">writeInterfaceToken</span><span class="token punctuation">(</span><span class="token class-name">IActivityManager</span><span class="token punctuation">.</span>descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        data<span class="token punctuation">.</span><span class="token function">writeStrongBinder</span><span class="token punctuation">(</span>caller <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> caller<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        data<span class="token punctuation">.</span><span class="token function">writeString</span><span class="token punctuation">(</span>callingPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        intent<span class="token punctuation">.</span><span class="token function">writeToParcel</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        data<span class="token punctuation">.</span><span class="token function">writeString</span><span class="token punctuation">(</span>resolvedType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        data<span class="token punctuation">.</span><span class="token function">writeStrongBinder</span><span class="token punctuation">(</span>resultTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        data<span class="token punctuation">.</span><span class="token function">writeString</span><span class="token punctuation">(</span>resultWho<span class="token punctuation">)</span><span class="token punctuation">;</span>
        data<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>requestCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        data<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>startFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>profilerInfo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            data<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            profilerInfo<span class="token punctuation">.</span><span class="token function">writeToParcel</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token class-name">Parcelable</span><span class="token punctuation">.</span><span class="token constant">PARCELABLE_WRITE_RETURN_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            data<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>options <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            data<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            options<span class="token punctuation">.</span><span class="token function">writeToParcel</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            data<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mRemote<span class="token punctuation">.</span><span class="token function">transact</span><span class="token punctuation">(</span><span class="token constant">START_ACTIVITY_TRANSACTION</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> reply<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        reply<span class="token punctuation">.</span><span class="token function">readException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> result <span class="token operator">=</span> reply<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        reply<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        data<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>以下是 Android 8.0 的相关源码：</p> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/core/java/android/app/Instrumentation.java</span>
<span class="token keyword">public</span> <span class="token class-name">ActivityResult</span> <span class="token function">execStartActivity</span><span class="token punctuation">(</span>
    <span class="token class-name">Context</span> who<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> contextThread<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> token<span class="token punctuation">,</span> <span class="token class-name">String</span> target<span class="token punctuation">,</span>
    <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> options<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">IApplicationThread</span> whoThread <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IApplicationThread</span><span class="token punctuation">)</span> contextThread<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        intent<span class="token punctuation">.</span><span class="token function">migrateExtraStreamToClipData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        intent<span class="token punctuation">.</span><span class="token function">prepareToLeaveProcess</span><span class="token punctuation">(</span>who<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">startActivity</span><span class="token punctuation">(</span>whoThread<span class="token punctuation">,</span> who<span class="token punctuation">.</span><span class="token function">getBasePackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> intent<span class="token punctuation">,</span>
                    intent<span class="token punctuation">.</span><span class="token function">resolveTypeIfNeeded</span><span class="token punctuation">(</span>who<span class="token punctuation">.</span><span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    token<span class="token punctuation">,</span> target<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">checkStartActivityResult</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Failure from system"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// /frameworks/base/core/java/android/app/ActivityManager.java</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">IActivityManager</span> <span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token class-name">IActivityManagerSingleton</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Singleton</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IActivityManager</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">IActivityManagerSingleton</span> <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IActivityManager</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">protected</span> <span class="token class-name">IActivityManager</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">final</span> <span class="token class-name">IBinder</span> b <span class="token operator">=</span> <span class="token class-name">ServiceManager</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">ACTIVITY_SERVICE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token class-name">IActivityManager</span> am <span class="token operator">=</span> <span class="token class-name">IActivityManager<span class="token punctuation">.</span>Stub</span><span class="token punctuation">.</span><span class="token function">asInterface</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> am<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token comment">// frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ActivityManagerService</span> <span class="token keyword">extends</span> <span class="token class-name">IActivityManager<span class="token punctuation">.</span>Stub</span>
         <span class="token keyword">implements</span> <span class="token class-name">Watchdog<span class="token punctuation">.</span>Monitor</span><span class="token punctuation">,</span> <span class="token class-name">BatteryStatsImpl<span class="token punctuation">.</span>BatteryCallback</span> <span class="token punctuation">{<!-- --></span>
  
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">startActivity</span><span class="token punctuation">(</span><span class="token class-name">IApplicationThread</span> caller<span class="token punctuation">,</span> <span class="token class-name">String</span> callingPackage<span class="token punctuation">,</span>
            <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token class-name">String</span> resolvedType<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> resultTo<span class="token punctuation">,</span> <span class="token class-name">String</span> resultWho<span class="token punctuation">,</span> 
            <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token keyword">int</span> startFlags<span class="token punctuation">,</span> <span class="token class-name">ProfilerInfo</span> profilerInfo<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> bOptions<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">startActivityAsUser</span><span class="token punctuation">(</span>caller<span class="token punctuation">,</span> callingPackage<span class="token punctuation">,</span> intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> resultTo<span class="token punctuation">,</span>
                resultWho<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span> startFlags<span class="token punctuation">,</span> profilerInfo<span class="token punctuation">,</span> bOptions<span class="token punctuation">,</span>
                <span class="token class-name">UserHandle</span><span class="token punctuation">.</span><span class="token function">getCallingUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">startActivityAsUser</span><span class="token punctuation">(</span><span class="token class-name">IApplicationThread</span> caller<span class="token punctuation">,</span> <span class="token class-name">String</span> callingPackage<span class="token punctuation">,</span>
          <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token class-name">String</span> resolvedType<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> resultTo<span class="token punctuation">,</span> <span class="token class-name">String</span> resultWho<span class="token punctuation">,</span> 
          <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token keyword">int</span> startFlags<span class="token punctuation">,</span> <span class="token class-name">ProfilerInfo</span> profilerInfo<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> bOptions<span class="token punctuation">,</span> 
          <span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">enforceNotIsolatedCaller</span><span class="token punctuation">(</span><span class="token string">"startActivity"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        userId <span class="token operator">=</span> mUserController<span class="token punctuation">.</span><span class="token function">handleIncomingUser</span><span class="token punctuation">(</span><span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">getCallingPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
                <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">getCallingUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token constant">ALLOW_FULL_ONLY</span><span class="token punctuation">,</span> 
                <span class="token string">"startActivity"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// TODO: Switch to user app stacks here.</span>
        <span class="token keyword">return</span> mActivityStarter<span class="token punctuation">.</span><span class="token function">startActivityMayWait</span><span class="token punctuation">(</span>caller<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> callingPackage<span class="token punctuation">,</span> intent<span class="token punctuation">,</span>
                resolvedType<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> resultTo<span class="token punctuation">,</span> resultWho<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span> startFlags<span class="token punctuation">,</span>
                profilerInfo<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> bOptions<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
                <span class="token string">"startActivityAsUser"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>以下是 Android 10.0 的相关源码：</p> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/core/java/android/app/Instrumentation.java</span>
<span class="token annotation punctuation">@UnsupportedAppUsage</span>
<span class="token keyword">public</span> <span class="token class-name">ActivityResult</span> <span class="token function">execStartActivity</span><span class="token punctuation">(</span>
    <span class="token class-name">Context</span> who<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> contextThread<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> token<span class="token punctuation">,</span> <span class="token class-name">String</span> target<span class="token punctuation">,</span>
    <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> options<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">IApplicationThread</span> whoThread <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IApplicationThread</span><span class="token punctuation">)</span> contextThread<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        intent<span class="token punctuation">.</span><span class="token function">migrateExtraStreamToClipData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        intent<span class="token punctuation">.</span><span class="token function">prepareToLeaveProcess</span><span class="token punctuation">(</span>who<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token class-name">ActivityTaskManager</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">startActivity</span><span class="token punctuation">(</span>whoThread<span class="token punctuation">,</span> who<span class="token punctuation">.</span><span class="token function">getBasePackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> intent<span class="token punctuation">,</span>
                    intent<span class="token punctuation">.</span><span class="token function">resolveTypeIfNeeded</span><span class="token punctuation">(</span>who<span class="token punctuation">.</span><span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    token<span class="token punctuation">,</span> target<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">checkStartActivityResult</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Failure from system"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// /frameworks/base/core/java/android/app/ActivityTaskManager.java</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">IActivityTaskManager</span> <span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token class-name">IActivityTaskManagerSingleton</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@UnsupportedAppUsage</span><span class="token punctuation">(</span>trackingBug <span class="token operator">=</span> <span class="token number">129726065</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Singleton</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IActivityTaskManager</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">IActivityTaskManagerSingleton</span> <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IActivityTaskManager</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">protected</span> <span class="token class-name">IActivityTaskManager</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">final</span> <span class="token class-name">IBinder</span> b <span class="token operator">=</span> <span class="token class-name">ServiceManager</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">ACTIVITY_TASK_SERVICE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token class-name">IActivityTaskManager<span class="token punctuation">.</span>Stub</span><span class="token punctuation">.</span><span class="token function">asInterface</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>



<span class="token comment">// frameworks/base/services/core/java/com/android/server/wm/ActivityTaskManagerService.java</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">startActivity</span><span class="token punctuation">(</span><span class="token class-name">IApplicationThread</span> caller<span class="token punctuation">,</span> <span class="token class-name">String</span> callingPackage<span class="token punctuation">,</span>
        <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token class-name">String</span> resolvedType<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> resultTo<span class="token punctuation">,</span> <span class="token class-name">String</span> resultWho<span class="token punctuation">,</span> 
        <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token keyword">int</span> startFlags<span class="token punctuation">,</span> <span class="token class-name">ProfilerInfo</span> profilerInfo<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> bOptions<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">startActivityAsUser</span><span class="token punctuation">(</span>caller<span class="token punctuation">,</span> callingPackage<span class="token punctuation">,</span> intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> resultTo<span class="token punctuation">,</span>
            resultWho<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span> startFlags<span class="token punctuation">,</span> profilerInfo<span class="token punctuation">,</span> bOptions<span class="token punctuation">,</span>
            <span class="token class-name">UserHandle</span><span class="token punctuation">.</span><span class="token function">getCallingUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">startActivityAsUser</span><span class="token punctuation">(</span><span class="token class-name">IApplicationThread</span> caller<span class="token punctuation">,</span> <span class="token class-name">String</span> callingPackage<span class="token punctuation">,</span>
        <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token class-name">String</span> resolvedType<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> resultTo<span class="token punctuation">,</span> <span class="token class-name">String</span> resultWho<span class="token punctuation">,</span> 
        <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token keyword">int</span> startFlags<span class="token punctuation">,</span> <span class="token class-name">ProfilerInfo</span> profilerInfo<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> bOptions<span class="token punctuation">,</span> 
        <span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">startActivityAsUser</span><span class="token punctuation">(</span>caller<span class="token punctuation">,</span> callingPackage<span class="token punctuation">,</span> intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> resultTo<span class="token punctuation">,</span>
            resultWho<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span> startFlags<span class="token punctuation">,</span> profilerInfo<span class="token punctuation">,</span> bOptions<span class="token punctuation">,</span> userId<span class="token punctuation">,</span>
            <span class="token boolean">true</span> <span class="token comment">/*validateIncomingUser*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">startActivityAsUser</span><span class="token punctuation">(</span><span class="token class-name">IApplicationThread</span> caller<span class="token punctuation">,</span> <span class="token class-name">String</span> callingPackage<span class="token punctuation">,</span>
        <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token class-name">String</span> resolvedType<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> resultTo<span class="token punctuation">,</span> <span class="token class-name">String</span> resultWho<span class="token punctuation">,</span> 
        <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token keyword">int</span> startFlags<span class="token punctuation">,</span> <span class="token class-name">ProfilerInfo</span> profilerInfo<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> bOptions<span class="token punctuation">,</span> 
        <span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token keyword">boolean</span> validateIncomingUser<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">enforceNotIsolatedCaller</span><span class="token punctuation">(</span><span class="token string">"startActivityAsUser"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    userId <span class="token operator">=</span> <span class="token function">getActivityStartController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">checkTargetUser</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> validateIncomingUser<span class="token punctuation">,</span>
            <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">getCallingPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">getCallingUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"startActivityAsUser"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// TODO: Switch to user app stacks here.</span>
    <span class="token keyword">return</span> <span class="token function">getActivityStartController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">obtainStarter</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> <span class="token string">"startActivityAsUser"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setCaller</span><span class="token punctuation">(</span>caller<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setCallingPackage</span><span class="token punctuation">(</span>callingPackage<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setResolvedType</span><span class="token punctuation">(</span>resolvedType<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setResultTo</span><span class="token punctuation">(</span>resultTo<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setResultWho</span><span class="token punctuation">(</span>resultWho<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setRequestCode</span><span class="token punctuation">(</span>requestCode<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setStartFlags</span><span class="token punctuation">(</span>startFlags<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setProfilerInfo</span><span class="token punctuation">(</span>profilerInfo<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setActivityOptions</span><span class="token punctuation">(</span>bOptions<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setMayWait</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>在 Android 7.0 中 AMS 的代理是 ActivityManagerProxy，Activity 的启动会调用 ActivityManagerNative.getDefault() 方法，getDefault() 方法返回了 IActivityManager 类型的对象，IActivityManager 借助了 Singleton 类来实现单例，而且 gDefault 是静态的，因此是一个比较好的 Hook 点。</p> 
<p>Android 8.0 的 Activity 的启动会调用 ActivityManager.getService() 方法， AMS 的代理是 IActivityManager，直接采用 AIDL 来进行进程间通信。ActivityManager.getService() 方法返回了 IActivityManager 类型的对象，并且 IActivityManager 借助了 Singleton 类来实现单例，同样的，IActivityManagerSingleton 是静态的，是一个比较好的 Hook 点。</p> 
<p>Android 10 使用的是 ATMS 启动的 Activity，ATMS 的代理是 IActivityTaskManager，采用的也是 AIDL 来进行进程间通信。ActivityTaskManager.getService() 返回的是 IActivityTaskManager 类型的对象，并且 IActivityTaskManager 借助了 Singleton 类来实现单例，同样的，IActivityTaskManagerSingleton 是静态的，是一个比较好的 Hook 点。</p> 
<p>因此，无论是 Android 7.0、Android 8.0 还是 Android 10，IActivityManager/IActivityTaskManager 都是比较好的 Hook 点。Singleton 类如下所示：</p> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/core/java/android/util/Singleton.java</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@UnsupportedAppUsage</span>
    <span class="token keyword">private</span> <span class="token class-name">T</span> mInstance<span class="token punctuation">;</span>

    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">T</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@UnsupportedAppUsage</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">T</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mInstance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                mInstance <span class="token operator">=</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> mInstance<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>由于 Hook 需要多次对字段进行反射操作，先实现一个工具类 FieldUtil：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FieldUtil</span> <span class="token punctuation">{<!-- --></span>
  
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">getField</span><span class="token punctuation">(</span><span class="token class-name">Class</span> clazz<span class="token punctuation">,</span> <span class="token class-name">Object</span> target<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> 
      <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Field</span> field <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        field<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> field<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Field</span> <span class="token function">getField</span><span class="token punctuation">(</span><span class="token class-name">Class</span> clazz<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Field</span> field <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        field<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> field<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setField</span><span class="token punctuation">(</span><span class="token class-name">Class</span> clazz<span class="token punctuation">,</span> <span class="token class-name">Object</span> target<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> 
      <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Field</span> field <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        field<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        field<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>接着定义替换 IActivityManager/IActivityTaskManager 的代理类 IActivityTaskManagerProxy，如下所示：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IActivityTaskManagerProxy</span> <span class="token keyword">implements</span> <span class="token class-name">InvocationHandler</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TAG</span> <span class="token operator">=</span> <span class="token string">"IActivityTaskManagerProxy"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Object</span> mActivityTaskManager<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">IActivityTaskManagerProxy</span><span class="token punctuation">(</span><span class="token class-name">Object</span> activityTaskManager<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>mActivityTaskManager <span class="token operator">=</span> activityTaskManager<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"startActivity"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 1</span>
            <span class="token class-name">Intent</span> intent <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> args<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">instanceof</span> <span class="token class-name">Intent</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    index <span class="token operator">=</span> i<span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            intent <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">)</span> args<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token class-name">Intent</span> subIntent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
            <span class="token class-name">String</span> packageName <span class="token operator">=</span> <span class="token string">"com.example.myapplication"</span><span class="token punctuation">;</span>
            subIntent<span class="token punctuation">.</span><span class="token function">setClassName</span><span class="token punctuation">(</span>packageName<span class="token punctuation">,</span> packageName <span class="token operator">+</span> <span class="token string">".SubActivity"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>
            subIntent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span><span class="token class-name">HookHelper</span><span class="token punctuation">.</span><span class="token constant">TARGET_INTENT</span><span class="token punctuation">,</span> intent<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 4</span>
            args<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> subIntent<span class="token punctuation">;</span> <span class="token comment">// 5</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>mActivityTaskManager<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>Hook 点 IActivityManager/IActivityTaskManager 是一个接口，建议采用动态代理。在注释 1 处拦截 startActivity 方法，接着获取参数 args 中第一个 Intent 对象，它原本要启动插件 TargetActivity 的 Intent。在注释 2、3 出新建一个 stubIntent 用来启动 StubActivity，在注释 4 处将这个 TargetActivity 的 Intent 保存到 stubIntent 中，便于以后还原 TargetActivity。在注释 5 处用 stubIntent 赋值给参数 args，这样启动的目标就变成了 SubActivity，用来通过 AMS/ATMS 的校验。最后用代理类 IActivityTaskManagerProxy 来替换 IActivityManager/IActivityTaskManager，如下所示：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HookHelper</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TARGET_INTENT</span> <span class="token operator">=</span> <span class="token string">"target_intent"</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">hookActivityTaskManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Build</span><span class="token punctuation">.</span><span class="token constant">VERSION</span><span class="token punctuation">.</span><span class="token constant">SDK_INT</span> <span class="token operator">&gt;</span> <span class="token class-name">Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>P</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 1 &gt; Android 9</span>
            <span class="token function">hookATMS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">hookAMS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">hookATMS</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Field</span> iActivityTaskManagerFiled <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> activityTaskManagerClazz <span class="token operator">=</span> 
              <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"android.app.ActivityTaskManager"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            iActivityTaskManagerFiled <span class="token operator">=</span> 
              activityTaskManagerClazz<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"IActivityTaskManagerSingleton"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            iActivityTaskManagerFiled<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Object</span> singleton <span class="token operator">=</span> iActivityTaskManagerFiled<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> singletonClass <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"android.util.Singleton"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Field</span> mInstanceField <span class="token operator">=</span> singletonClass<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"mInstance"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
            mInstanceField<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token class-name">Object</span> iActivityTaskManager <span class="token operator">=</span> mInstanceField<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>singleton<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>

            <span class="token class-name">Object</span> proxy <span class="token operator">=</span> 
              <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContextClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span><span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"android.app.IActivityTaskManager"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">IActivityTaskManagerProxy</span><span class="token punctuation">(</span>iActivityTaskManager<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mInstanceField<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>singleton<span class="token punctuation">,</span> proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">hookAMS</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Field</span> singletonField <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Build</span><span class="token punctuation">.</span><span class="token constant">VERSION</span><span class="token punctuation">.</span><span class="token constant">SDK_INT</span> <span class="token operator">&gt;=</span> <span class="token class-name">Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>O</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 
                <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> activityManagerClazz <span class="token operator">=</span> 
                  <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"android.app.ActivityManager"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 获取 activityManager 中的 IActivityManagerSingleton 字段</span>
                singletonField <span class="token operator">=</span> 
                  activityManagerClazz<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"IActivityManagerSingleton"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> activityManagerNativeClazz <span class="token operator">=</span> 
                  <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"android.app.ActivityManagerNative"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 获取 ActivityManagerNative 中的 gDefault 字段</span>
                singletonField <span class="token operator">=</span> activityManagerNativeClazz<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"gDefault"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            singletonField<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 可访问 gDefault 字段</span>
            <span class="token class-name">Object</span> singleton <span class="token operator">=</span> singletonField<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> activityManagerCls <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"android.util.Singleton"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Field</span> mInstanceField <span class="token operator">=</span> activityManagerCls<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"mInstance"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
            mInstanceField<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token class-name">Object</span> iActivityManager <span class="token operator">=</span> mInstanceField<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>singleton<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>
            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> iActivityManagerClazz <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"android.app.IActivityManager"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Object</span> proxy <span class="token operator">=</span> 
              <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContextClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span>iActivityManagerClazz<span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">IActivityTaskManagerProxy</span><span class="token punctuation">(</span>iActivityManager<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mInstanceField<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>singleton<span class="token punctuation">,</span> proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>首先在注释 1 处对系统版本进行区分，最终获取的是 <code>Singleton&lt;IActivityTaskManager&gt;/Singleton&lt;IActivityManager&gt;</code> 类型的 IActivityTaskManagerService/IActivityManagerSigleton/gDefault 字段。在注释 2 处获取 Singleton 类中的 mInstance 字段。</p> 
<p>从前面 Singleton 类的代码可以得知 mInstance 字段的类型为 T，在注释 3 处得到 IActivityTaskManagerSingleton/IActivityManagerSingle/gDefault 字段中的 T 的类型，T 的类型为 IActivityTaskManager/IActivityManager。最后后台创建代理类 IActivityTaskManagerProxy，用 IActivityTaskManagerProxy 来替换 IActivityTaskManager/IActivityManager。</p> 
<p>在 MainActivity 中启动 TargetActivity，如下所示：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainActivity</span> <span class="token keyword">extends</span> <span class="token class-name">AppCompatActivity</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token class-name">Button</span> button<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token class-name">Bundle</span> savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setContentView</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">HookHelper</span><span class="token punctuation">.</span><span class="token function">hookActivityTaskManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        button <span class="token operator">=</span> <span class="token function">findViewById</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>id<span class="token punctuation">.</span>button<span class="token punctuation">)</span><span class="token punctuation">;</span>
        button<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">View<span class="token punctuation">.</span>OnClickListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token class-name">View</span> v<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Intent</span> intent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token class-name">MainActivity</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token class-name">TargetActivity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">startActivity</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>点击 Button 时，启动的并不是 TargetActivity 而是 SubActivity，说明已经成功用 SubActivity 通过了 ATMS/AMS 的校验。</p> 
<h6><a id="623__Activity_602"></a>6.2.3 还原插件 Activity</h6> 
<p>前面用占位的 Activity 通过了 ATMS/AMS 的校验，但是我们要启动的插件是 TargetActivity，还需要用插件 TargetActivity 来替换占位的 SubActivity，替换时机就在 ApplicationThread 向 ActivityThread 发送消息之后。以下是 ActivityThread 启动 Activity 的过程：</p> 
<p><img src="https://images2.imgbox.com/08/0e/3a3G1OA3_o.png" alt="Activity 启动时序图_4" width="100%" height="100%"></p> 
<p>ActivityThread 会通过 H 类将代码的逻辑切换到主线程中，H 类是 ActivityThread 的内部类并继承自 Handler，如下所示：</p> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/core/java/android/app/ActivityThread.java</span>
<span class="token keyword">class</span> <span class="token class-name">H</span> <span class="token keyword">extends</span> <span class="token class-name">Handler</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">case</span> <span class="token constant">EXECUTE_TRANSACTION</span><span class="token operator">:</span>
            <span class="token keyword">final</span> <span class="token class-name">ClientTransaction</span> transaction <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ClientTransaction</span><span class="token punctuation">)</span> msg<span class="token punctuation">.</span>obj<span class="token punctuation">;</span>
            mTransactionExecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSystem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                transaction<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>H 类中重写了 handleMessage 方法会对 EXECUTE_TRANSACTION 类型的消息进行处理，最终会调用 Activity 的 onCreate 方法，那么在哪里进行替换呢？接着来看 Handler.dispatchMessage 方法：</p> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/core/java/android/os/Handler.java</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">dispatchMessage</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>callback <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">handleCallback</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mCallback <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mCallback<span class="token punctuation">.</span><span class="token function">handleMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">handleMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>Handler 的 dispatchMessage 用于处理消息，看到如果 Handler 的 Callback 类型的 mCallback 不为 null，就会执行 mCallback 的 handleMessage 方法。因此，mCallback 可以作为 Hook 点，我们可以用自定义的 Callback 来替换 mCallback，自定义的 Callback 如下所示：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HCallback</span> <span class="token keyword">implements</span> <span class="token class-name">Handler<span class="token punctuation">.</span>Callback</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">EXECUTE_TRANSACTION</span> <span class="token operator">=</span> <span class="token number">159</span><span class="token punctuation">;</span>
    <span class="token class-name">Handler</span> mHandler<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">HCallback</span><span class="token punctuation">(</span><span class="token class-name">Handler</span> handler<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mHandler <span class="token operator">=</span> handler<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what <span class="token operator">==</span> <span class="token constant">EXECUTE_TRANSACTION</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Object</span> r <span class="token operator">=</span> msg<span class="token punctuation">.</span>obj<span class="token punctuation">;</span>
                <span class="token comment">// 获取到 ClientTransaction 列表中的 mActivityCallbacks</span>
                <span class="token class-name">Field</span> mActivityCallbacksField <span class="token operator">=</span> 
                  r<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"mActivityCallbacks"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mActivityCallbacksField<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> mActivityCallbacks <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> 
                  mActivityCallbacksField<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> itemName <span class="token operator">=</span> <span class="token string">"android.app.servertransaction.LaunchActivityItem"</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Object</span> obj <span class="token operator">:</span> mActivityCallbacks<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCanonicalName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>itemName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token class-name">Field</span> mIntentField <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"mIntent"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        mIntentField<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">Intent</span> sugerBullet <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">)</span> mIntentField<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">Intent</span> realIntent <span class="token operator">=</span> sugerBullet<span class="token punctuation">.</span><span class="token function">getParcelableExtra</span><span class="token punctuation">(</span><span class="token constant">TARGET_INTENT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// 把 TargetActivity 信息写回去</span>
                        sugerBullet<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span>realIntent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        mHandler<span class="token punctuation">.</span><span class="token function">handleMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>HCallback 实现了 Handler.Callback，并重写了 handleMessage 方法，当收到消息的类型为 EXECUTE_TRANSACTION 时，将启动 StubActivity 的 Intent 替换为启动 TargetActivity 的 Intent。接着在 HookHelper 中定义一个 hookHandler 方法，如下所示：</p> 
<pre><code class="prism language-java"><span class="token comment">// HookHelper</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">hookHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> activityThread <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"android.app.ActivityThread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Field</span> sCurrentActivityThreadField <span class="token operator">=</span> 
          activityThread<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"sCurrentActivityThread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
        sCurrentActivityThreadField<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> sCurrentActivityThread <span class="token operator">=</span> sCurrentActivityThreadField<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Field</span> mHField <span class="token operator">=</span> activityThread<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"mH"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
        mHField<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Handler</span> mH <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Handler</span><span class="token punctuation">)</span> mHField<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>sCurrentActivityThread<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>

        <span class="token class-name">Field</span> mCallbackField <span class="token operator">=</span> <span class="token class-name">Handler</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"mCallback"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mCallbackField<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mCallbackField<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>mH<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HCallback</span><span class="token punctuation">(</span>mH<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>ActivityThread 类中有一个静态变量 sCurrentActivityThread，用于表示当前的 ActivityThread 对象，因此在注释 1 处获取 ActivityThread 中定义的 sCurrentActivityThread 对象。注释 2 处获取 ActivityThread 类的 mH 字段，接着在注释 3 处获取当前 ActivityThread 对象中的 mH 对象，最后用 HCallback 来替换 mH 中的 mCallback。在 Activity.onCreate 方法中调用 HookHelpler.hookHandler() 方法，运行程序，当我们单击“启动插件”时，发现启动的是插件 TargetActivity。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainActivity</span> <span class="token keyword">extends</span> <span class="token class-name">AppCompatActivity</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token class-name">Button</span> button<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token class-name">Bundle</span> savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setContentView</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">HookHelper</span><span class="token punctuation">.</span><span class="token function">hookActivityTaskManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HookHelper</span><span class="token punctuation">.</span><span class="token function">hookHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        button <span class="token operator">=</span> <span class="token function">findViewById</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>id<span class="token punctuation">.</span>button<span class="token punctuation">)</span><span class="token punctuation">;</span>
        button<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">View<span class="token punctuation">.</span>OnClickListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token class-name">View</span> v<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Intent</span> intent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token class-name">MainActivity</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token class-name">TargetActivity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">startActivity</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="624__Activity__745"></a>6.2.4 插件 Activity 的生命周期</h6> 
<p>插件 TargetActivity 确实启动了，但是它有生命周期吗？</p> 
<p>从源码的角度来进行分析，Activity.finish 方法可以触发 Activity 的生命周期变化，和 Activity 的启动过程类似。以下是 Activity.finish 的相关时序图：</p> 
<p><img src="https://images2.imgbox.com/08/1e/9T45Yi97_o.png" alt="销毁 Activity 时序图 Activity -&gt; ATMS" width="100%" height="100%"></p> 
<p><img src="https://images2.imgbox.com/b1/35/o6EIU0F7_o.png" alt="销毁 Activity 时序图 ATMS -&gt; ActivityThread -&gt; Activity" width="100%" height="100%"></p> 
<p>总体来说是，Activity 请求 ATMS，ATMS 通过 ApplicationThread 调用 ActivityThread，ActivityThread 向 H 类发送消息执行 handleDestroyActivity，接着调用 performDestroyActivity 方法。</p> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/core/java/android/app/servertransaction/TransactionExecutor.java</span>
<span class="token annotation punctuation">@VisibleForTesting</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">executeCallbacks</span><span class="token punctuation">(</span><span class="token class-name">ClientTransaction</span> transaction<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClientTransactionItem</span><span class="token punctuation">&gt;</span></span> callbacks <span class="token operator">=</span> transaction<span class="token punctuation">.</span><span class="token function">getCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>callbacks <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> callbacks<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// No callbacks to execute, return early.</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_RESOLVER</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token function">tId</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"Resolving callbacks in transaction"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">final</span> <span class="token class-name">IBinder</span> token <span class="token operator">=</span> transaction<span class="token punctuation">.</span><span class="token function">getActivityToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
    <span class="token class-name">ActivityClientRecord</span> r <span class="token operator">=</span> mTransactionHandler<span class="token punctuation">.</span><span class="token function">getActivityClient</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">final</span> <span class="token class-name">ActivityLifecycleItem</span> finalStateRequest <span class="token operator">=</span> transaction<span class="token punctuation">.</span><span class="token function">getLifecycleStateRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token keyword">int</span> finalState <span class="token operator">=</span> finalStateRequest <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> finalStateRequest<span class="token punctuation">.</span><span class="token function">getTargetState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">:</span> <span class="token constant">UNDEFINED</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token keyword">int</span> lastCallbackRequestingState <span class="token operator">=</span> <span class="token function">lastCallbackRequestingState</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">final</span> <span class="token keyword">int</span> size <span class="token operator">=</span> callbacks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> <span class="token class-name">ClientTransactionItem</span> item <span class="token operator">=</span> callbacks<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_RESOLVER</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token function">tId</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"Resolving callback: "</span> <span class="token operator">+</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> postExecutionState <span class="token operator">=</span> item<span class="token punctuation">.</span><span class="token function">getPostExecutionState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">shouldHaveDefinedPreExecutionState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> closestPreExecutionState <span class="token operator">=</span> mHelper<span class="token punctuation">.</span><span class="token function">getClosestPreExecutionState</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span>
                    item<span class="token punctuation">.</span><span class="token function">getPostExecutionState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>closestPreExecutionState <span class="token operator">!=</span> <span class="token constant">UNDEFINED</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">cycleToPath</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> closestPreExecutionState<span class="token punctuation">,</span> transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        item<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>mTransactionHandler<span class="token punctuation">,</span> token<span class="token punctuation">,</span> mPendingActions<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
        item<span class="token punctuation">.</span><span class="token function">postExecute</span><span class="token punctuation">(</span>mTransactionHandler<span class="token punctuation">,</span> token<span class="token punctuation">,</span> mPendingActions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Launch activity request will create an activity record.</span>
            r <span class="token operator">=</span> mTransactionHandler<span class="token punctuation">.</span><span class="token function">getActivityClient</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>postExecutionState <span class="token operator">!=</span> <span class="token constant">UNDEFINED</span> <span class="token operator">&amp;&amp;</span> r <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> <span class="token keyword">boolean</span> shouldExcludeLastTransition <span class="token operator">=</span>
                    i <span class="token operator">==</span> lastCallbackRequestingState <span class="token operator">&amp;&amp;</span> finalState <span class="token operator">==</span> postExecutionState<span class="token punctuation">;</span>
            <span class="token function">cycleToPath</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> postExecutionState<span class="token punctuation">,</span> shouldExcludeLastTransition<span class="token punctuation">,</span> transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// frameworks/base/core/java/android/app/servertransaction/DestroyActivityItem.java</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DestroyActivityItem</span> <span class="token keyword">extends</span> <span class="token class-name">ActivityLifecycleItem</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">ClientTransactionHandler</span> client<span class="token punctuation">,</span> <span class="token class-name">ActivityClientRecord</span> r<span class="token punctuation">,</span>
        <span class="token class-name">PendingTransactionActions</span> pendingActions<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">,</span> <span class="token string">"activityDestroy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        client<span class="token punctuation">.</span><span class="token function">handleDestroyActivity</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> mFinished<span class="token punctuation">,</span> mConfigChanges<span class="token punctuation">,</span>
                <span class="token boolean">false</span> <span class="token comment">/* getNonConfigInstance */</span><span class="token punctuation">,</span> <span class="token string">"DestroyActivityItem"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>注释 1 处通过 IBinder 类型的 token 来获取 ActivityClientRecord，ActivityClientRecord 用于描述应用进程中的 Activity：</p> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/core/java/android/app/ActivityThread.java</span>
<span class="token comment">/** Activity client record, used for bookkeeping for the real {@link Activity} instance. */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ActivityClientRecord</span> <span class="token punctuation">{<!-- --></span>  
<span class="token punctuation">}</span>
</code></pre> 
<p>在 ActivityThread.performDestroyActivity 方法中调用 Instrumentation.callActivityOnDestroy 方法并传入 r.activity，继而调用 Activity.performDestroy() 方法。</p> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/core/java/android/app/ActivityThread.java</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleDestroyActivity</span><span class="token punctuation">(</span><span class="token class-name">ActivityClientRecord</span> r<span class="token punctuation">,</span> <span class="token keyword">boolean</span> finishing<span class="token punctuation">,</span> 
                                  <span class="token keyword">int</span> configChanges<span class="token punctuation">,</span> <span class="token keyword">boolean</span> getNonConfigInstance<span class="token punctuation">,</span> 
                                  <span class="token class-name">String</span> reason<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">performDestroyActivity</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> finishing<span class="token punctuation">,</span> configChanges<span class="token punctuation">,</span> getNonConfigInstance<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token comment">/** Core implementation of activity destroy call. */</span>
<span class="token keyword">void</span> <span class="token function">performDestroyActivity</span><span class="token punctuation">(</span><span class="token class-name">ActivityClientRecord</span> r<span class="token punctuation">,</span> <span class="token keyword">boolean</span> finishing<span class="token punctuation">,</span>
        <span class="token keyword">int</span> configChanges<span class="token punctuation">,</span> <span class="token keyword">boolean</span> getNonConfigInstance<span class="token punctuation">,</span> <span class="token class-name">String</span> reason<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Activity</span><span class="token punctuation">&gt;</span></span> activityClass<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>localLOGV<span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"Performing finish of "</span> <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
    activityClass <span class="token operator">=</span> r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span>mConfigChangeFlags <span class="token operator">|=</span> configChanges<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>finishing<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span>mFinished <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">performPauseActivityIfNeeded</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token string">"destroy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>r<span class="token punctuation">.</span>stopped<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">callActivityOnStop</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* saveState */</span><span class="token punctuation">,</span> <span class="token string">"destroy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span>mCalled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        mInstrumentation<span class="token punctuation">.</span><span class="token function">callActivityOnDestroy</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>activity<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SuperNotCalledException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    r<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token constant">ON_DESTROY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token comment">// frameworks/base/core/java/android/app/Instrumentation.java</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">callActivityOnDestroy</span><span class="token punctuation">(</span><span class="token class-name">Activity</span> activity<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    activity<span class="token punctuation">.</span><span class="token function">performDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><a href="https://blog.csdn.net/xingyu19911016/article/details/132668021?csdn_share_tail=%7B%22type%22%3A%22blog%22%2C%22rType%22%3A%22article%22%2C%22rId%22%3A%22132668021%22%2C%22source%22%3A%22xingyu19911016%22%7D">Activity 的销毁流程</a></p> 
<p>前面用 SubActivity 替换了 TargetActivity 并通过了 ATMS 的校验，这样 ATMS 就只知道 SubActivity 的存在，那么 ATMS 是如何控制 TargetActivity 的生命周期的回调呢？接下来看 Activity.performLaunchActivity 方法：</p> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/core/java/android/app/Activity.java</span>
<span class="token keyword">final</span> <span class="token class-name">ArrayMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IBinder</span><span class="token punctuation">,</span> <span class="token class-name">ActivityClientRecord</span><span class="token punctuation">&gt;</span></span> mActivities <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**  Core implementation of activity launch. */</span>
<span class="token keyword">private</span> <span class="token class-name">Activity</span> <span class="token function">performLaunchActivity</span><span class="token punctuation">(</span><span class="token class-name">ActivityClientRecord</span> r<span class="token punctuation">,</span> <span class="token class-name">Intent</span> customIntent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  
  
    <span class="token class-name">ContextImpl</span> appContext <span class="token operator">=</span> <span class="token function">createBaseContextForActivity</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Activity</span> activity <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>ClassLoader</span> cl <span class="token operator">=</span> appContext<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        activity <span class="token operator">=</span> mInstrumentation<span class="token punctuation">.</span><span class="token function">newActivity</span><span class="token punctuation">(</span>
                cl<span class="token punctuation">,</span> component<span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
        <span class="token class-name">StrictMode</span><span class="token punctuation">.</span><span class="token function">incrementExpectedActivityCount</span><span class="token punctuation">(</span>activity<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">setExtrasClassLoader</span><span class="token punctuation">(</span>cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">prepareToEnterProcess</span><span class="token punctuation">(</span><span class="token function">isProtectedComponent</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>activityInfo<span class="token punctuation">)</span><span class="token punctuation">,</span>
                appContext<span class="token punctuation">.</span><span class="token function">getAttributionSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>state <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            r<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">setClassLoader</span><span class="token punctuation">(</span>cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mInstrumentation<span class="token punctuation">.</span><span class="token function">onException</span><span class="token punctuation">(</span>activity<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
                <span class="token string">"Unable to instantiate activity "</span> <span class="token operator">+</span> component
                <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Application</span> app <span class="token operator">=</span> r<span class="token punctuation">.</span>packageInfo<span class="token punctuation">.</span><span class="token function">makeApplicationInner</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> mInstrumentation<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment">// updatePendingActivityConfiguration() reads from mActivities to update</span>
        <span class="token comment">// ActivityClientRecord which runs in a different thread. Protect modifications to</span>
        <span class="token comment">// mActivities to avoid race.</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mResourcesManager<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mActivities<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>token<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>activity <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            appContext<span class="token punctuation">.</span><span class="token function">setOuterContext</span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            activity<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>appContext<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">getInstrumentation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>token<span class="token punctuation">,</span>
                    r<span class="token punctuation">.</span>ident<span class="token punctuation">,</span> app<span class="token punctuation">,</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">,</span> r<span class="token punctuation">.</span>activityInfo<span class="token punctuation">,</span> title<span class="token punctuation">,</span> r<span class="token punctuation">.</span>parent<span class="token punctuation">,</span>
                    r<span class="token punctuation">.</span>embeddedID<span class="token punctuation">,</span> r<span class="token punctuation">.</span>lastNonConfigurationInstances<span class="token punctuation">,</span> config<span class="token punctuation">,</span>
                    r<span class="token punctuation">.</span>referrer<span class="token punctuation">,</span> r<span class="token punctuation">.</span>voiceInteractor<span class="token punctuation">,</span> window<span class="token punctuation">,</span> r<span class="token punctuation">.</span>activityConfigCallback<span class="token punctuation">,</span>
                    r<span class="token punctuation">.</span>assistToken<span class="token punctuation">,</span> r<span class="token punctuation">.</span>shareableActivityToken<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        r<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token constant">ON_CREATE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SuperNotCalledException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> e<span class="token punctuation">;</span>

    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> activity<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>注释 1 处根据 Activity 的类名用 ClassLoader 加载 Activity，接着调用 Activity.attach 方法，将 r.token 赋值给 Activity 的成员变量 mToken。在注释 2 处将 ActivityClientRecord 根据 r.token 保存在 mActivities 中，mActivities 类型为 ArrayMap&lt;IBinder, ActivityClientRecord&gt;。</p> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/core/java/android/app/Activity.java</span>
<span class="token annotation punctuation">@UnsupportedAppUsage</span><span class="token punctuation">(</span>maxTargetSdk <span class="token operator">=</span> <span class="token class-name">Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>R</span><span class="token punctuation">,</span> trackingBug <span class="token operator">=</span> <span class="token number">170729553</span><span class="token punctuation">)</span>
<span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">attach</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ActivityThread</span> aThread<span class="token punctuation">,</span>
        <span class="token class-name">Instrumentation</span> instr<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> token<span class="token punctuation">,</span> <span class="token keyword">int</span> ident<span class="token punctuation">,</span>
        <span class="token class-name">Application</span> application<span class="token punctuation">,</span> <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token class-name">ActivityInfo</span> info<span class="token punctuation">,</span>
        <span class="token class-name">CharSequence</span> title<span class="token punctuation">,</span> <span class="token class-name">Activity</span> parent<span class="token punctuation">,</span> <span class="token class-name">String</span> id<span class="token punctuation">,</span>
        <span class="token class-name">NonConfigurationInstances</span> lastNonConfigurationInstances<span class="token punctuation">,</span>
        <span class="token class-name">Configuration</span> config<span class="token punctuation">,</span> <span class="token class-name">String</span> referrer<span class="token punctuation">,</span> <span class="token class-name">IVoiceInteractor</span> voiceInteractor<span class="token punctuation">,</span>
        <span class="token class-name">Window</span> window<span class="token punctuation">,</span> <span class="token class-name">ActivityConfigCallback</span> activityConfigCallback<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> assistToken<span class="token punctuation">,</span>
        <span class="token class-name">IBinder</span> shareableActivityToken<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">attachBaseContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>

    mFragments<span class="token punctuation">.</span><span class="token function">attachHost</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token comment">/*parent*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    mWindow <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PhoneWindow</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> window<span class="token punctuation">,</span> activityConfigCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mWindow<span class="token punctuation">.</span><span class="token function">setWindowControllerCallback</span><span class="token punctuation">(</span>mWindowControllerCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mWindow<span class="token punctuation">.</span><span class="token function">setCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mWindow<span class="token punctuation">.</span><span class="token function">setOnWindowDismissedCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mWindow<span class="token punctuation">.</span><span class="token function">getLayoutInflater</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPrivateFactory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>info<span class="token punctuation">.</span>softInputMode <span class="token operator">!=</span> <span class="token class-name">WindowManager<span class="token punctuation">.</span>LayoutParams</span><span class="token punctuation">.</span><span class="token constant">SOFT_INPUT_STATE_UNSPECIFIED</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mWindow<span class="token punctuation">.</span><span class="token function">setSoftInputMode</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>softInputMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>info<span class="token punctuation">.</span>uiOptions <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mWindow<span class="token punctuation">.</span><span class="token function">setUiOptions</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>uiOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    mUiThread <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    mMainThread <span class="token operator">=</span> aThread<span class="token punctuation">;</span>
    mInstrumentation <span class="token operator">=</span> instr<span class="token punctuation">;</span>
    mToken <span class="token operator">=</span> token<span class="token punctuation">;</span> <span class="token comment">// 1</span>
    mAssistToken <span class="token operator">=</span> assistToken<span class="token punctuation">;</span>
    mShareableActivityToken <span class="token operator">=</span> shareableActivityToken<span class="token punctuation">;</span>
    mIdent <span class="token operator">=</span> ident<span class="token punctuation">;</span>
    mApplication <span class="token operator">=</span> application<span class="token punctuation">;</span>
    mIntent <span class="token operator">=</span> intent<span class="token punctuation">;</span>
    mReferrer <span class="token operator">=</span> referrer<span class="token punctuation">;</span>
    mComponent <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mActivityInfo <span class="token operator">=</span> info<span class="token punctuation">;</span>
    mTitle <span class="token operator">=</span> title<span class="token punctuation">;</span>
    mParent <span class="token operator">=</span> parent<span class="token punctuation">;</span>
    mEmbeddedID <span class="token operator">=</span> id<span class="token punctuation">;</span>
    mLastNonConfigurationInstances <span class="token operator">=</span> lastNonConfigurationInstances<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>voiceInteractor <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lastNonConfigurationInstances <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mVoiceInteractor <span class="token operator">=</span> lastNonConfigurationInstances<span class="token punctuation">.</span>voiceInteractor<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            mVoiceInteractor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VoiceInteractor</span><span class="token punctuation">(</span>voiceInteractor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span>
                    <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    mWindow<span class="token punctuation">.</span><span class="token function">setWindowManager</span><span class="token punctuation">(</span>
            <span class="token punctuation">(</span><span class="token class-name">WindowManager</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span><span class="token function">getSystemService</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">WINDOW_SERVICE</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            mToken<span class="token punctuation">,</span> mComponent<span class="token punctuation">.</span><span class="token function">flattenToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span>info<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> <span class="token class-name">ActivityInfo</span><span class="token punctuation">.</span><span class="token constant">FLAG_HARDWARE_ACCELERATED</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mParent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mWindow<span class="token punctuation">.</span><span class="token function">setContainer</span><span class="token punctuation">(</span>mParent<span class="token punctuation">.</span><span class="token function">getWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    mWindowManager <span class="token operator">=</span> mWindow<span class="token punctuation">.</span><span class="token function">getWindowManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mCurrentConfig <span class="token operator">=</span> config<span class="token punctuation">;</span>

    mWindow<span class="token punctuation">.</span><span class="token function">setColorMode</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>colorMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mWindow<span class="token punctuation">.</span><span class="token function">setPreferMinimalPostProcessing</span><span class="token punctuation">(</span>
            <span class="token punctuation">(</span>info<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> <span class="token class-name">ActivityInfo</span><span class="token punctuation">.</span><span class="token constant">FLAG_PREFER_MINIMAL_POST_PROCESSING</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">getAutofillClientController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onActivityAttached</span><span class="token punctuation">(</span>application<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setContentCaptureOptions</span><span class="token punctuation">(</span>application<span class="token punctuation">.</span><span class="token function">getContentCaptureOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>因此得出结论：ATMS 和 ActivityThread 之间的通信采用了 token 来对 Activity 进行标识，并且此后的 Activity 的生命周期处理也是根据 token 来对 Activity 进行标识的。</strong></p> 
<p>在上面的例子中，在 Activity 启动时用插件 TargetActivity 替换占位置的 SubActivity，这一过程在 Activity.performLaunchActivity 方法调用之前，因此 r.token 指向的是 TargetActivity，在 performLaunchActivity 方法中获取的就是代表 TargetActivity 的 ActivityClientRecord，可见，TargetActivity 是有生命周期的。</p> 
<h5><a id="63_Hook_Instrumentation__1022"></a>6.3 Hook Instrumentation 方案实现</h5> 
<p>Hook Instrumentation 实现要比 Hook IActivityManager 实现简单一些。Hook Instrumentation 实现同样也需要用到占位的 Activity，与 Hook IActivityManager 实现不同的是，用占位 Activity 替换插件 Activity 以及还原插件 Activity 的地方不同。Activity.startActivity 方法调用时许图如下所示：</p> 
<p><img src="https://images2.imgbox.com/07/4f/qH0LFzLW_o.png" alt="startActivity 时序图" width="100%" height="100%"></p> 
<p>在 Activity 通过 ATMS 校验之前，会调用 Activity 的 startActivityForResult 方法：</p> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/core/java/android/app/Activity.java</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">startActivityForResult</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequiresPermission</span> <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span>
        <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Bundle</span> options<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mParent <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        options <span class="token operator">=</span> <span class="token function">transferSpringboardActivityOptions</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Instrumentation<span class="token punctuation">.</span>ActivityResult</span> ar <span class="token operator">=</span>
            mInstrumentation<span class="token punctuation">.</span><span class="token function">execStartActivity</span><span class="token punctuation">(</span>
                <span class="token keyword">this</span><span class="token punctuation">,</span> mMainThread<span class="token punctuation">.</span><span class="token function">getApplicationThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mToken<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span>
                intent<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ar <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mMainThread<span class="token punctuation">.</span><span class="token function">sendActivityResult</span><span class="token punctuation">(</span>
                mToken<span class="token punctuation">,</span> mEmbeddedID<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span> ar<span class="token punctuation">.</span><span class="token function">getResultCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                ar<span class="token punctuation">.</span><span class="token function">getResultData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>requestCode <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mStartedActivity <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">cancelInputsAndStartExitTransition</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>options <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mParent<span class="token punctuation">.</span><span class="token function">startActivityFromChild</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> intent<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            mParent<span class="token punctuation">.</span><span class="token function">startActivityFromChild</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> intent<span class="token punctuation">,</span> requestCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在注释 1 处调用了 Instrumentation.execStartActivity 方法来激活 Activity 的生命周期。</p> 
<p><img src="https://images2.imgbox.com/5e/6e/rzvHultj_o.png" alt="Activity 启动时序图_4" width="100%" height="100%"></p> 
<p>对于 ActivityThread.performLaunchActivity 方法，如下所示：</p> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/core/java/android/app/ActivityThread.java</span>
<span class="token comment">/**  Core implementation of activity launch. */</span>
<span class="token keyword">private</span> <span class="token class-name">Activity</span> <span class="token function">performLaunchActivity</span><span class="token punctuation">(</span><span class="token class-name">ActivityClientRecord</span> r<span class="token punctuation">,</span> <span class="token class-name">Intent</span> customIntent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
		<span class="token comment">// 创建要启动的 Activity 的上下文环境</span>
    <span class="token class-name">ContextImpl</span> appContext <span class="token operator">=</span> <span class="token function">createBaseContextForActivity</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Activity</span> activity <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>ClassLoader</span> cl <span class="token operator">=</span> appContext<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token comment">// 用类加载器来创建 Activity 的实例</span>
        activity <span class="token operator">=</span> mInstrumentation<span class="token punctuation">.</span><span class="token function">newActivity</span><span class="token punctuation">(</span>
                cl<span class="token punctuation">,</span> component<span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
        <span class="token class-name">StrictMode</span><span class="token punctuation">.</span><span class="token function">incrementExpectedActivityCount</span><span class="token punctuation">(</span>activity<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">setExtrasClassLoader</span><span class="token punctuation">(</span>cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">prepareToEnterProcess</span><span class="token punctuation">(</span><span class="token function">isProtectedComponent</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>activityInfo<span class="token punctuation">)</span><span class="token punctuation">,</span>
                appContext<span class="token punctuation">.</span><span class="token function">getAttributionSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>state <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            r<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">setClassLoader</span><span class="token punctuation">(</span>cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">return</span> activity<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>注释 1 处调用了 Instrumentation.newActivity 方法，其内部会用类加载器来创建 Activity 的实例。看到这里我们可以得到方案，就是在 Instrumentation.execStartActivity 方法中使用占位 SubActivity 来通过 ATMS 的验证，在 Instrumentation.newActivity 方法中还原 TargetActivity，这两步操作都和 Instrumentation 有关，因此我们可以用自定义的 Instrumentation 来替换掉 mInstrumentation。首先我们自定义一个 Instrumentation，在 execStartActivity 方法中将启动的 TargetActivity 替换为 SubActivity，如下所示：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InstrumentationProxy</span> <span class="token keyword">extends</span> <span class="token class-name">Instrumentation</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token class-name">Instrumentation</span> mInstrumentation<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">PackageManager</span> mPackageManager<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">InstrumentationProxy</span><span class="token punctuation">(</span><span class="token class-name">Instrumentation</span> instrumentation<span class="token punctuation">,</span> 
                                <span class="token class-name">PackageManager</span> packageManager<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mInstrumentation <span class="token operator">=</span> instrumentation<span class="token punctuation">;</span>
        mPackageManager <span class="token operator">=</span> packageManager<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">ActivityResult</span> <span class="token function">execStartActivity</span><span class="token punctuation">(</span><span class="token class-name">Context</span> who<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> contextThread<span class="token punctuation">,</span> 
                                            <span class="token class-name">IBinder</span> token<span class="token punctuation">,</span> <span class="token class-name">Activity</span> target<span class="token punctuation">,</span>
                                            <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> options<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ResolveInfo</span><span class="token punctuation">&gt;</span></span> infos <span class="token operator">=</span> mPackageManager<span class="token punctuation">.</span>
          <span class="token function">queryIntentActivities</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> <span class="token class-name">PackageManager</span><span class="token punctuation">.</span><span class="token constant">MATCH_ALL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>infos <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> infos<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            intent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span><span class="token class-name">HookHelper</span><span class="token punctuation">.</span><span class="token constant">TARGET_INTENT</span><span class="token punctuation">,</span> 
                            intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
            intent<span class="token punctuation">.</span><span class="token function">setClassName</span><span class="token punctuation">(</span>who<span class="token punctuation">,</span> <span class="token string">"com.example.myapplication.SubActivity"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Method</span> execMethod <span class="token operator">=</span> 
              <span class="token class-name">Instrumentation</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span><span class="token string">"execStartActivity"</span><span class="token punctuation">,</span>
                    <span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">IBinder</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">IBinder</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Activity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> 
                    <span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Bundle</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">ActivityResult</span><span class="token punctuation">)</span> execMethod<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>mInstrumentation<span class="token punctuation">,</span> who<span class="token punctuation">,</span> contextThread<span class="token punctuation">,</span> 
                                  token<span class="token punctuation">,</span> target<span class="token punctuation">,</span> intent<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>首先查找要启动的 Activity 是否已经在 AndroidManifest.xml 中注册了，如果没有注册就在注释 1 处将要启动的 Activity（TargetActivity）的 ClassName 保存起来用于后面还原 TargetActivity，接着在注释 2 处替换要启动的 Activity 为 SubActivity，最后通过反射调用 execStartActivity 方法，这要就可以用 SubActivity 通过 ATMS 的验证。在 InstrumentationProxy 的 newActivity 方法中还原 TargetActivity，如下所示：</p> 
<pre><code class="prism language-java"><span class="token comment">// InstrumentationProxy</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Activity</span> <span class="token function">newActivity</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> cl<span class="token punctuation">,</span> <span class="token class-name">String</span> className<span class="token punctuation">,</span> <span class="token class-name">Intent</span> intent<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalAccessException</span><span class="token punctuation">,</span> <span class="token class-name">InstantiationException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span> intentName <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getStringExtra</span><span class="token punctuation">(</span><span class="token class-name">HookHelper</span><span class="token punctuation">.</span><span class="token constant">TARGET_INTENT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">TextUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>intentName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">newActivity</span><span class="token punctuation">(</span>cl<span class="token punctuation">,</span> intentName<span class="token punctuation">,</span> intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
    <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">newActivity</span><span class="token punctuation">(</span>cl<span class="token punctuation">,</span> className<span class="token punctuation">,</span> intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在 newActivity 方法中创建了此前保存的 TargetActivity，完成了还原 TargetActivity。编写 hookInstrumentation 方法，用 InstrumentationProxy 替换 mInstrumentation：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">Application</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">attachBaseContext</span><span class="token punctuation">(</span><span class="token class-name">Context</span> base<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">attachBaseContext</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">hookInstrumentation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">hookInstrumentation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> activityThreadClass <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"android.app.ActivityThread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Field</span> activityThreadField <span class="token operator">=</span> 
              activityThreadClass<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"sCurrentActivityThread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            activityThreadField<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 1 获取 ActivityThread 对象 sCurrentActivityThread</span>
            <span class="token class-name">Object</span> activityThread <span class="token operator">=</span> activityThreadField<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Field</span> instrumentationField <span class="token operator">=</span> 
              activityThreadClass<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"mInstrumentation"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            instrumentationField<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 2 从 sCurrentActivityThread 中获取成员变量 mInstrumentation</span>
            <span class="token class-name">Instrumentation</span> instrumentation <span class="token operator">=</span> 
              <span class="token punctuation">(</span><span class="token class-name">Instrumentation</span><span class="token punctuation">)</span> instrumentationField<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>activityThread<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 创建代理对象 InstrumentationProxy</span>
            <span class="token class-name">InstrumentationProxy</span> proxy <span class="token operator">=</span> 
              <span class="token keyword">new</span> <span class="token class-name">InstrumentationProxy</span><span class="token punctuation">(</span>instrumentation<span class="token punctuation">,</span> <span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 3 将 sCurrentActivityThread 中成员变量 mInstrumentation 替换成代理类 InstrumentationProxy</span>
            instrumentationField<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>activityThread<span class="token punctuation">,</span> proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchFieldException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalAccessException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>在注释 1 处获取 ActivityThread 对象 sCurrentActivityThread。在注释 2 处获取 ActivityThread 类中的 mInstrumentation 字段，最后用 InstrumentationProxy 来替换 mInstrumentation。在 MyApplication 的 attachBaseContext 方法中调用 hookInstrumentation 方法，运行程序后，单击“启动插件”按钮时，发现启动的是插件 TargetActivity。</p> 
<h4><a id="_1197"></a>参考</h4> 
<p><a href="https://cloud.tencent.com/developer/article/1395380?areaSource=102001.14&amp;traceId=HyWntOdyHYfBnU1iFru2b" rel="nofollow">Hook技术</a></p> 
<p><a href="https://www.lxiaoyu.com/p/289137" rel="nofollow">Android Hook技术分析</a></p> 
<p><a href="https://baijiahao.baidu.com/s?id=1683240576771150307&amp;wfr=spider&amp;for=pc" rel="nofollow">黑科技之 - hook 欺骗 startActivity 清单文件校验规则</a></p> 
<p><a href="https://blog.csdn.net/weixin_33836223/article/details/93653827">Hook技术–Activity的启动过程的拦截</a></p> 
<p><a href="https://blog.csdn.net/lin20044140410/article/details/104584877/">Android中插件化实现的原理,hook Activity(二)</a></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/59b2b0081df90d3b4a37b644554e653e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">QM9 数据集性质预测的单位</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f07d0cab947954b82d2a41ba5bd9ef06/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">elementui的Upload组件实现图片上传回显功能</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>