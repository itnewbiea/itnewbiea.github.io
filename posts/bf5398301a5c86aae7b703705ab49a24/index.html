<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>线程池监控与动态参数调整设计 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="线程池监控与动态参数调整设计" />
<meta property="og:description" content="为了提高系统吞吐量，系统使用线程池越来越多。由于缺乏对线程池的统一监控手段，运营人员不知道线程池的具体运行情况，不利于线程池的性能调优。 开发线程池监控系统，对系统中的线程池进行统一监控。 详细代码参见utils
（一）线程池运行时数据的收集与展示
定义线程池统计数据接口ExecutorMonitorData，用于获取线程池的运行时数据，包括所属服务、线程池名称、线程池的唯一标识（线程池一般随系统启动而启动，随系统关闭而关闭）、核心线程数、当前线程数、历史最大线程、最大线程数、当前活跃线程数、最大空闲时间、当前任务数、已完成数量、任务执行总时间、任务执行最长时间、最短时间、排队最初时间、排队最短时间、执行超时次数、异常次数、排队超时次数、拒绝次数、阻塞队列、线程工厂、拒绝策略、启动时间。 import java.util.Date; import java.util.concurrent.TimeUnit; /** * 定义监控数据接口 */ public interface ExecutorMonitorData { /** * 线程池启动时间 */ Date getStartTime(); /** * 线程池所在服务 */ String getService(); /** * 线程池名字，每个线程池有一个唯一的名字，比如HttpRequest、DbExecutor */ String getPoolName(); /** * 线程池的唯一标识，因为线程池可能因为重启等因素被关闭，但是要唯一区别一个线程池，所以不能使用{@link ExecutorMonitorData#getPoolName()}， * 建议的格式为{@link top.jfunc.common.thread.monitor.generator.CommonIdentifierGenerator} */ String getIdentifier(); /** * 当前核心线程数 */ int getPoolSize(); /** * 配置的核心线程数 */ int getCorePoolSize(); /** * 历史到达最大线程数 */ int getLargestPoolSize(); /** * 配置的最大线程数 */ int getMaximumPoolSize(); /** * 当前活跃线程数 */ int getActiveCount(); /** * 线程最大空闲时间 */ long getKeepAliveTime(TimeUnit timeUnit); /** * 是否允许核心线程空闲回收 */ boolean allowsCoreThreadTimeOut(); /** * 当前任务数 */ long getTaskCount(); /** * 已完成任务数 */ long getCompletedTaskCount(); /*BlockingQueue&lt;Runnable&gt; getQueue(); ThreadFactory getThreadFactory(); RejectedExecutionHandler getRejectedExecutionHandler();*/ /** * 阻塞队列容量 */ int getQueueCapacity(); /** * 阻塞队列当前数量 */ int getQueueSize(); /** * 阻塞队列的类名 */ String getQueueClass(); /** * 线程工厂的类名 */ String getThreadFactoryClass(); /** * 拒绝策略的类名 */ String getRejectedExecutionHandlerClass(); /** * 任务执行总时间，依赖于{@link top." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/bf5398301a5c86aae7b703705ab49a24/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-08T22:16:22+08:00" />
<meta property="article:modified_time" content="2023-03-08T22:16:22+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">线程池监控与动态参数调整设计</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <pre><code>    为了提高系统吞吐量，系统使用线程池越来越多。由于缺乏对线程池的统一监控手段，运营人员不知道线程池的具体运行情况，不利于线程池的性能调优。
   开发线程池监控系统，对系统中的线程池进行统一监控。
</code></pre> 
<p>详细代码参见<a href="https://gitee.com/xxssyyyyssxx/utils/tree/master/src/main/java/top/jfunc/common/thread/monitor" rel="nofollow">utils</a></p> 
<p><strong>（一）线程池运行时数据的收集与展示</strong></p> 
<ol><li>定义线程池统计数据接口ExecutorMonitorData，用于获取线程池的运行时数据，包括所属服务、线程池名称、线程池的唯一标识（线程池一般随系统启动而启动，随系统关闭而关闭）、核心线程数、当前线程数、历史最大线程、最大线程数、当前活跃线程数、最大空闲时间、当前任务数、已完成数量、任务执行总时间、任务执行最长时间、最短时间、排队最初时间、排队最短时间、执行超时次数、异常次数、排队超时次数、拒绝次数、阻塞队列、线程工厂、拒绝策略、启动时间。</li></ol> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 定义监控数据接口
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ExecutorMonitorData</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">/**
	 * 线程池启动时间
	 */</span>
	<span class="token class-name">Date</span> <span class="token function">getStartTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/**
	 * 线程池所在服务
	 */</span>
	<span class="token class-name">String</span> <span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/**
	 * 线程池名字，每个线程池有一个唯一的名字，比如HttpRequest、DbExecutor
	 */</span>
	<span class="token class-name">String</span> <span class="token function">getPoolName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/**
	 * 线程池的唯一标识，因为线程池可能因为重启等因素被关闭，但是要唯一区别一个线程池，所以不能使用{@link ExecutorMonitorData#getPoolName()}，
	 * 建议的格式为{@link top.jfunc.common.thread.monitor.generator.CommonIdentifierGenerator}
	 */</span>
	<span class="token class-name">String</span> <span class="token function">getIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/**
	 * 当前核心线程数
	 */</span>
	<span class="token keyword">int</span> <span class="token function">getPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/**
	 * 配置的核心线程数
	 */</span>
	<span class="token keyword">int</span> <span class="token function">getCorePoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/**
	 * 历史到达最大线程数
	 */</span>
	<span class="token keyword">int</span> <span class="token function">getLargestPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/**
	 * 配置的最大线程数
	 */</span>
	<span class="token keyword">int</span> <span class="token function">getMaximumPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/**
	 * 当前活跃线程数
	 */</span>
	<span class="token keyword">int</span> <span class="token function">getActiveCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/**
	 * 线程最大空闲时间
	 */</span>
	<span class="token keyword">long</span> <span class="token function">getKeepAliveTime</span><span class="token punctuation">(</span><span class="token class-name">TimeUnit</span> timeUnit<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/**
	 * 是否允许核心线程空闲回收
	 */</span>
	<span class="token keyword">boolean</span> <span class="token function">allowsCoreThreadTimeOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/**
	 * 当前任务数
	 */</span>
	<span class="token keyword">long</span> <span class="token function">getTaskCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/**
	 * 已完成任务数
	 */</span>
	<span class="token keyword">long</span> <span class="token function">getCompletedTaskCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/*BlockingQueue&lt;Runnable&gt; getQueue();

	ThreadFactory getThreadFactory();

	RejectedExecutionHandler getRejectedExecutionHandler();*/</span>

    <span class="token comment">/**
     * 阻塞队列容量
     */</span>
	<span class="token keyword">int</span> <span class="token function">getQueueCapacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 阻塞队列当前数量
     */</span>
	<span class="token keyword">int</span> <span class="token function">getQueueSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 阻塞队列的类名
     */</span>
	<span class="token class-name">String</span> <span class="token function">getQueueClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 线程工厂的类名
     */</span>
	<span class="token class-name">String</span> <span class="token function">getThreadFactoryClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 拒绝策略的类名
     */</span>
	<span class="token class-name">String</span> <span class="token function">getRejectedExecutionHandlerClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/**
	 * 任务执行总时间，依赖于{@link top.jfunc.common.thread.monitor.adapter.MonitoredThreadPoolExecutor}和{@link StatisticsRunnable}
	 */</span>
	<span class="token keyword">long</span> <span class="token function">getTotalExecuteTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 任务执行最小时间，依赖于{@link top.jfunc.common.thread.monitor.adapter.MonitoredThreadPoolExecutor}和{@link StatisticsRunnable}
     */</span>
    <span class="token keyword">long</span> <span class="token function">getMinExecuteTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 任务执行最大时间，依赖于{@link top.jfunc.common.thread.monitor.adapter.MonitoredThreadPoolExecutor}和{@link StatisticsRunnable}
     */</span>
    <span class="token keyword">long</span> <span class="token function">getMaxExecuteTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/**
	 * 任务执行超时次数，依赖于{@link top.jfunc.common.thread.monitor.adapter.MonitoredThreadPoolExecutor#setExecuteTimeout(long)}和{@link StatisticsRunnable}
	 */</span>
	<span class="token keyword">int</span> <span class="token function">getExecuteTimeoutCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/**
	 * 执行发生异常次数
	 */</span>
	<span class="token keyword">int</span> <span class="token function">getExecuteExceptionCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/**
     * 任务排队最小时间，依赖于{@link top.jfunc.common.thread.monitor.adapter.MonitoredThreadPoolExecutor}和{@link StatisticsRunnable}
     */</span>
    <span class="token keyword">long</span> <span class="token function">getMinQueueTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/**
     * 任务排队最大时间，依赖于{@link top.jfunc.common.thread.monitor.adapter.MonitoredThreadPoolExecutor}和{@link StatisticsRunnable}
     */</span>
    <span class="token keyword">long</span> <span class="token function">getMaxQueueTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/**
	 * 任务执行超时次数，依赖于{@link top.jfunc.common.thread.monitor.adapter.MonitoredThreadPoolExecutor#setQueueTimeout(long)}和{@link StatisticsRunnable}
	 */</span>
	<span class="token keyword">int</span> <span class="token function">getQueueTimeoutCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/**
	 * 获取拒绝次数
	 */</span>
	<span class="token keyword">int</span> <span class="token function">getRejectedCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


	<span class="token comment">/**
	 * 重置一些统计数据，使统计数据具备统计周期的效果
	 */</span>
	<span class="token keyword">void</span> <span class="token function">resetStatistic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


</code></pre> 
<ol start="2"><li>定义一种统计数据接口的实现MonitoredThreadPoolExecutor，继承自ThreadPoolExecutor，增加没有的属性，包括所属服务、名称、启动时间、任务执行时间，复写构造器传入，任务执行、排队时间相关统计可通过复写beforeExecute和afterExecute方法统计到。</li></ol> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">top<span class="token punctuation">.</span>jfunc<span class="token punctuation">.</span>common<span class="token punctuation">.</span>thread<span class="token punctuation">.</span>monitor<span class="token punctuation">.</span>adapter</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">LoggerFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">top<span class="token punctuation">.</span>jfunc<span class="token punctuation">.</span>common<span class="token punctuation">.</span>thread<span class="token punctuation">.</span>monitor<span class="token punctuation">.</span></span><span class="token class-name">ConfigurableExecutorMonitorData</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">top<span class="token punctuation">.</span>jfunc<span class="token punctuation">.</span>common<span class="token punctuation">.</span>thread<span class="token punctuation">.</span>monitor<span class="token punctuation">.</span></span><span class="token class-name">CountedRejectedExecutionHandler</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">top<span class="token punctuation">.</span>jfunc<span class="token punctuation">.</span>common<span class="token punctuation">.</span>thread<span class="token punctuation">.</span>monitor<span class="token punctuation">.</span></span><span class="token class-name">StatisticsRunnable</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">top<span class="token punctuation">.</span>jfunc<span class="token punctuation">.</span>common<span class="token punctuation">.</span>thread<span class="token punctuation">.</span>monitor<span class="token punctuation">.</span>change<span class="token punctuation">.</span></span><span class="token class-name">ParamChangeBean</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">top<span class="token punctuation">.</span>jfunc<span class="token punctuation">.</span>common<span class="token punctuation">.</span>thread<span class="token punctuation">.</span>monitor<span class="token punctuation">.</span>change<span class="token punctuation">.</span></span><span class="token class-name">ParamChangerUtil</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">top<span class="token punctuation">.</span>jfunc<span class="token punctuation">.</span>common<span class="token punctuation">.</span>thread<span class="token punctuation">.</span>monitor<span class="token punctuation">.</span>change<span class="token punctuation">.</span></span><span class="token class-name">ThreadPoolExecutorParamChangeAdapter</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">top<span class="token punctuation">.</span>jfunc<span class="token punctuation">.</span>common<span class="token punctuation">.</span>thread<span class="token punctuation">.</span>monitor<span class="token punctuation">.</span>generator<span class="token punctuation">.</span></span><span class="token class-name">CommonIdentifierGenerator</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">top<span class="token punctuation">.</span>jfunc<span class="token punctuation">.</span>common<span class="token punctuation">.</span>thread<span class="token punctuation">.</span>monitor<span class="token punctuation">.</span>generator<span class="token punctuation">.</span></span><span class="token class-name">IdentifierGenerator</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>atomic<span class="token punctuation">.</span></span><span class="token class-name">AtomicInteger</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>atomic<span class="token punctuation">.</span></span><span class="token class-name">AtomicLong</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 具备监控功能的线程池，在使用j.u.c {@link ThreadPoolExecutor}的地方替换为该类即可
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MonitoredThreadPoolExecutor</span> <span class="token keyword">extends</span> <span class="token class-name">ThreadPoolExecutor</span> <span class="token keyword">implements</span> <span class="token class-name">ConfigurableExecutorMonitorData</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">MonitoredThreadPoolExecutor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 所属服务
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> service<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 线程池名称
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> poolName<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 线程池启动时间
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Date</span> startTime<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 唯一标识
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> identifier<span class="token punctuation">;</span>
    <span class="token comment">/**
     * Task execute timeout, unit (ms), just for statistics.
     * 设置了该值，才会统计执行时间
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">long</span> executeTimeout <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Task queue wait timeout, unit (ms), just for statistics.
     * 设置了该值，才会统计排队时间
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">long</span> queueTimeout <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 记录总执行时间
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicLong</span> totalExecuteTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicLong</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 记录一个统计周期内执行的最大时间
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">long</span> maxExecuteTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 记录一个统计周期内执行的最小时间
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">long</span> minExecuteTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * Count run timeout tasks.
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> executeTimeoutCount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * Count run with Exception tasks.
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> executeExceptionCount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 记录一个统计周期内排队的最大时间
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">long</span> minQueueTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 记录一个统计周期内排队的最大时间
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">long</span> maxQueueTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * Count queue wait timeout tasks.
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> queueTimeoutCount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">public</span> <span class="token class-name">MonitoredThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">,</span>
                                       <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">,</span>
                                       <span class="token keyword">long</span> keepAliveTime<span class="token punctuation">,</span>
                                       <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">,</span>
                                       <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> workQueue<span class="token punctuation">,</span>
                                       <span class="token class-name">String</span> service<span class="token punctuation">,</span>
                                       <span class="token class-name">String</span> poolName<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>corePoolSize<span class="token punctuation">,</span> maximumPoolSize<span class="token punctuation">,</span> keepAliveTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> workQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>service <span class="token operator">=</span> service<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>poolName <span class="token operator">=</span> poolName<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>startTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>identifier <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CommonIdentifierGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIdentifier</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">resetRejectedExecutionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">MonitoredThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">,</span>
                                       <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">,</span>
                                       <span class="token keyword">long</span> keepAliveTime<span class="token punctuation">,</span>
                                       <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">,</span>
                                       <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> workQueue<span class="token punctuation">,</span>
                                       <span class="token class-name">ThreadFactory</span> threadFactory<span class="token punctuation">,</span>
                                       <span class="token class-name">String</span> service<span class="token punctuation">,</span>
                                       <span class="token class-name">String</span> poolName<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>corePoolSize<span class="token punctuation">,</span> maximumPoolSize<span class="token punctuation">,</span> keepAliveTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> workQueue<span class="token punctuation">,</span> threadFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>service <span class="token operator">=</span> service<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>poolName <span class="token operator">=</span> poolName<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>startTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>identifier <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CommonIdentifierGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIdentifier</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">resetRejectedExecutionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">MonitoredThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">,</span>
                                       <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">,</span>
                                       <span class="token keyword">long</span> keepAliveTime<span class="token punctuation">,</span>
                                       <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">,</span>
                                       <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> workQueue<span class="token punctuation">,</span>
                                       <span class="token class-name">RejectedExecutionHandler</span> handler<span class="token punctuation">,</span>
                                       <span class="token class-name">String</span> service<span class="token punctuation">,</span>
                                       <span class="token class-name">String</span> poolName<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>corePoolSize<span class="token punctuation">,</span> maximumPoolSize<span class="token punctuation">,</span> keepAliveTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> workQueue<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>service <span class="token operator">=</span> service<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>poolName <span class="token operator">=</span> poolName<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>startTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>identifier <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CommonIdentifierGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIdentifier</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">resetRejectedExecutionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">MonitoredThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">,</span>
                                       <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">,</span>
                                       <span class="token keyword">long</span> keepAliveTime<span class="token punctuation">,</span>
                                       <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">,</span>
                                       <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> workQueue<span class="token punctuation">,</span>
                                       <span class="token class-name">ThreadFactory</span> threadFactory<span class="token punctuation">,</span>
                                       <span class="token class-name">RejectedExecutionHandler</span> handler<span class="token punctuation">,</span>
                                       <span class="token class-name">String</span> service<span class="token punctuation">,</span>
                                       <span class="token class-name">String</span> poolName<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>corePoolSize<span class="token punctuation">,</span> maximumPoolSize<span class="token punctuation">,</span> keepAliveTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> workQueue<span class="token punctuation">,</span> threadFactory<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>service <span class="token operator">=</span> service<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>poolName <span class="token operator">=</span> poolName<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>startTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>identifier <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CommonIdentifierGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIdentifier</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">resetRejectedExecutionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 重置线程池的拒绝策略，可计数的
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">resetRejectedExecutionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">setRejectedExecutionHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CountedRejectedExecutionHandler</span><span class="token punctuation">(</span><span class="token function">getRejectedExecutionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"{} Going to shutdown. Executed tasks: {}, Running tasks: {}, Pending tasks: {}"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>poolName<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCompletedTaskCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getActiveCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> <span class="token function">shutdownNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"{} Going to immediately shutdown. Executed tasks: {}, Running tasks: {}, Pending tasks: {}"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>poolName<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCompletedTaskCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getActiveCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">shutdownNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">beforeExecute</span><span class="token punctuation">(</span><span class="token class-name">Thread</span> t<span class="token punctuation">,</span> <span class="token class-name">Runnable</span> r<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>r <span class="token keyword">instanceof</span> <span class="token class-name">StatisticsRunnable</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">beforeExecute</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">StatisticsRunnable</span> runnable <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">StatisticsRunnable</span><span class="token punctuation">)</span> r<span class="token punctuation">;</span>
        <span class="token keyword">long</span> currTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>executeTimeout <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            runnable<span class="token punctuation">.</span><span class="token function">setStartTime</span><span class="token punctuation">(</span>currTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>queueTimeout <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">long</span> queueTime <span class="token operator">=</span> currTime <span class="token operator">-</span> runnable<span class="token punctuation">.</span><span class="token function">getSubmitTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//更新最大等待时间</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>queueTime <span class="token operator">&gt;</span> maxQueueTime<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                maxQueueTime <span class="token operator">=</span> queueTime<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">//更新最小等待时间</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>queueTime <span class="token operator">&lt;</span> minQueueTime <span class="token operator">||</span> minQueueTime <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                minQueueTime <span class="token operator">=</span> queueTime<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">//看是否超时</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>queueTime <span class="token operator">&gt;</span> queueTimeout<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                queueTimeoutCount<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//其他的可以做诸如告警</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">beforeExecute</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">afterExecute</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>r <span class="token keyword">instanceof</span> <span class="token class-name">StatisticsRunnable</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">afterExecute</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>executeTimeout <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">StatisticsRunnable</span> runnable <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">StatisticsRunnable</span><span class="token punctuation">)</span> r<span class="token punctuation">;</span>
            <span class="token keyword">long</span> executeTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> runnable<span class="token punctuation">.</span><span class="token function">getStartTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//统计执行时间</span>
            totalExecuteTime<span class="token punctuation">.</span><span class="token function">addAndGet</span><span class="token punctuation">(</span>executeTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//更新最大执行时间</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>executeTime <span class="token operator">&gt;</span> maxExecuteTime<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                maxExecuteTime <span class="token operator">=</span> executeTime<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//更新最小执行时间</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>executeTime <span class="token operator">&lt;</span> minExecuteTime <span class="token operator">||</span> minExecuteTime <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                minExecuteTime <span class="token operator">=</span> executeTime<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">//看是否超时</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>executeTime <span class="token operator">&gt;</span> executeTimeout<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                executeTimeoutCount<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//其他的可以做诸如告警</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>

        <span class="token comment">//发生异常统计</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            executeExceptionCount<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//其他的可以做诸如告警</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">afterExecute</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> command<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>command <span class="token keyword">instanceof</span> <span class="token class-name">StatisticsRunnable</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token function">statisticsWrap</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token class-name">Runnable</span> <span class="token function">statisticsWrap</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> command<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Runnable</span> c <span class="token operator">=</span> command<span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>executeTimeout <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">||</span> queueTimeout <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            c <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StatisticsRunnable</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> c<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getTotalExecuteTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>totalExecuteTime<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getMaxExecuteTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>maxExecuteTime<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getMinExecuteTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>minExecuteTime<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getExecuteTimeoutCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>executeTimeoutCount<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getExecuteExceptionCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> executeExceptionCount<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getMinQueueTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>minQueueTime<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getMaxQueueTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>maxQueueTime<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getQueueTimeoutCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>queueTimeoutCount<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">resetStatistic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        totalExecuteTime<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        maxExecuteTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        minExecuteTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        executeTimeoutCount<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        executeExceptionCount<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        maxQueueTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        minQueueTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        queueTimeoutCount<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">RejectedExecutionHandlerUtil</span><span class="token punctuation">.</span><span class="token function">resetRejectedCount</span><span class="token punctuation">(</span><span class="token function">getRejectedExecutionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Date</span> <span class="token function">getStartTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>startTime<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getPoolName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>poolName<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>service<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>identifier<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token class-name">MonitoredThreadPoolExecutor</span> <span class="token function">setIdentifierGenerator</span><span class="token punctuation">(</span><span class="token class-name">IdentifierGenerator</span> identifierGenerator<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>identifier <span class="token operator">=</span> identifierGenerator<span class="token punctuation">.</span><span class="token function">getIdentifier</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">MonitoredThreadPoolExecutor</span> <span class="token function">setExecuteTimeout</span><span class="token punctuation">(</span><span class="token keyword">long</span> executeTimeout<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>executeTimeout <span class="token operator">=</span> executeTimeout<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getExecuteTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>executeTimeout<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">MonitoredThreadPoolExecutor</span> <span class="token function">setQueueTimeout</span><span class="token punctuation">(</span><span class="token keyword">long</span> queueTimeout<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>queueTimeout <span class="token operator">=</span> queueTimeout<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getQueueTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>queueTimeout<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getQueueCapacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> blockingQueue <span class="token operator">=</span> <span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> blockingQueue<span class="token punctuation">.</span><span class="token function">remainingCapacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> blockingQueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getQueueSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getQueueClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getThreadFactoryClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">getThreadFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getRejectedExecutionHandlerClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">RejectedExecutionHandlerUtil</span><span class="token punctuation">.</span><span class="token function">getOriginalRejectedExecutionHandlerClass</span><span class="token punctuation">(</span><span class="token function">getRejectedExecutionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getRejectedCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">RejectedExecutionHandlerUtil</span><span class="token punctuation">.</span><span class="token function">getRejectedCount</span><span class="token punctuation">(</span><span class="token function">getRejectedExecutionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onChange</span><span class="token punctuation">(</span><span class="token class-name">ParamChangeBean</span> bean<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ParamChangerUtil</span><span class="token punctuation">.</span><span class="token function">paramChange</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutorParamChangeAdapter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<ol start="3"><li>针对某些情况我们无法直接定义线程池，即第二种方式无法实现的时候，我们可以代理线程池。定义ThreadPoolExecutorMonitoredDelegator，构造器传入ThreadPoolExecutor进行代理，增加没有的属性，包括所属服务、名称、启动时间，这种情况下无法获取到任务执行时间。</li></ol> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token namespace">top<span class="token punctuation">.</span>jfunc<span class="token punctuation">.</span>common<span class="token punctuation">.</span>thread<span class="token punctuation">.</span>monitor<span class="token punctuation">.</span></span><span class="token class-name">ConfigurableExecutorMonitorData</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">top<span class="token punctuation">.</span>jfunc<span class="token punctuation">.</span>common<span class="token punctuation">.</span>thread<span class="token punctuation">.</span>monitor<span class="token punctuation">.</span></span><span class="token class-name">CountedRejectedExecutionHandler</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">top<span class="token punctuation">.</span>jfunc<span class="token punctuation">.</span>common<span class="token punctuation">.</span>thread<span class="token punctuation">.</span>monitor<span class="token punctuation">.</span>change<span class="token punctuation">.</span></span><span class="token class-name">ParamChangeBean</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">top<span class="token punctuation">.</span>jfunc<span class="token punctuation">.</span>common<span class="token punctuation">.</span>thread<span class="token punctuation">.</span>monitor<span class="token punctuation">.</span>change<span class="token punctuation">.</span></span><span class="token class-name">ParamChangerUtil</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">top<span class="token punctuation">.</span>jfunc<span class="token punctuation">.</span>common<span class="token punctuation">.</span>thread<span class="token punctuation">.</span>monitor<span class="token punctuation">.</span>change<span class="token punctuation">.</span></span><span class="token class-name">ThreadPoolExecutorParamChangeAdapter</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">BlockingQueue</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 代理j.u.c原生线程池{@link ThreadPoolExecutor}，附加监控相关信息
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadPoolExecutorMonitoredAdapter</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractThreadPoolExecutorMonitoredAdapter</span> <span class="token keyword">implements</span> <span class="token class-name">ConfigurableExecutorMonitorData</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ThreadPoolExecutor</span> delegate<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ThreadPoolExecutorMonitoredAdapter</span><span class="token punctuation">(</span><span class="token class-name">ThreadPoolExecutor</span> threadPoolExecutor<span class="token punctuation">,</span> <span class="token class-name">String</span> service<span class="token punctuation">,</span> <span class="token class-name">String</span> poolName<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> poolName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>delegate <span class="token operator">=</span> threadPoolExecutor<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">.</span><span class="token function">setRejectedExecutionHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CountedRejectedExecutionHandler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">.</span><span class="token function">getRejectedExecutionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getActiveCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">.</span><span class="token function">getActiveCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getMaximumPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">.</span><span class="token function">getMaximumPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getCompletedTaskCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">.</span><span class="token function">getCompletedTaskCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">.</span><span class="token function">getPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getCorePoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">.</span><span class="token function">getCorePoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getLargestPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">.</span><span class="token function">getLargestPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getKeepAliveTime</span><span class="token punctuation">(</span><span class="token class-name">TimeUnit</span> timeUnit<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">.</span><span class="token function">getKeepAliveTime</span><span class="token punctuation">(</span>timeUnit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">allowsCoreThreadTimeOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">.</span><span class="token function">allowsCoreThreadTimeOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getTaskCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">.</span><span class="token function">getTaskCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getQueueCapacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> blockingQueue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> blockingQueue<span class="token punctuation">.</span><span class="token function">remainingCapacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> blockingQueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getQueueSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getQueueClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getThreadFactoryClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">.</span><span class="token function">getThreadFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getRejectedExecutionHandlerClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">RejectedExecutionHandlerUtil</span><span class="token punctuation">.</span><span class="token function">getOriginalRejectedExecutionHandlerClass</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">.</span><span class="token function">getRejectedExecutionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getRejectedCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">RejectedExecutionHandlerUtil</span><span class="token punctuation">.</span><span class="token function">getRejectedCount</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">.</span><span class="token function">getRejectedExecutionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">resetStatistic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">resetStatistic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RejectedExecutionHandlerUtil</span><span class="token punctuation">.</span><span class="token function">resetRejectedCount</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">.</span><span class="token function">getRejectedExecutionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onChange</span><span class="token punctuation">(</span><span class="token class-name">ParamChangeBean</span> bean<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ParamChangerUtil</span><span class="token punctuation">.</span><span class="token function">paramChange</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutorParamChangeAdapter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">)</span><span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


</code></pre> 
<ol start="4"><li>定义用于上报监控信息的接口ExecutorReportService，定义两个方法，分别在线程池启动的时候调用initReport（主要用于收集线程池的参数配置，属于静态参数）和系统定时调用report（主要用于收集线程池的动态运行参数，属于动态参数）。</li></ol> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 初始化线程池的时候调用，上报线程初始化相关信息
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ExecutorReportService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * 线程池初始化的时候调用上报初始化信息
     * @param executorMonitorData 被监控线程池初始化信息
     */</span>
    <span class="token keyword">void</span> <span class="token function">initReport</span><span class="token punctuation">(</span><span class="token class-name">ExecutorMonitorData</span> executorMonitorData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 普通上报信息，定时或者手动触发
     * @param executorMonitorData 被监控线程池监控信息
     */</span>
    <span class="token keyword">void</span> <span class="token function">report</span><span class="token punctuation">(</span><span class="token class-name">ExecutorMonitorData</span> executorMonitorData<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="5"><li>因为系统中可能有很多的上报具体实现，我们定义一个聚合的CompositeExecutorReportService，用于管理ExecutorReportService，它本身也可以看作为一个ExecutorReportService。</li></ol> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 组合service，系统中可能需要多种处理
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CompositeExecutorReportService</span> <span class="token keyword">implements</span> <span class="token class-name">ExecutorReportService</span><span class="token punctuation">{<!-- --></span>
	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ExecutorReportService</span><span class="token punctuation">&gt;</span></span> reportServices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">public</span> <span class="token class-name">CompositeExecutorReportService</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ExecutorReportService</span><span class="token punctuation">&gt;</span></span> reportServices<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>reportServices<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>reportServices<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token class-name">CompositeExecutorReportService</span><span class="token punctuation">(</span><span class="token class-name">ExecutorReportService</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> reportServices<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>reportServices<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>reportServices<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token class-name">CompositeExecutorReportService</span> <span class="token function">addServices</span><span class="token punctuation">(</span><span class="token class-name">ExecutorReportService</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> reportServices<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>reportServices<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>reportServices<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ExecutorReportService</span><span class="token punctuation">&gt;</span></span> <span class="token function">getReportServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reportServices<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initReport</span><span class="token punctuation">(</span><span class="token class-name">ExecutorMonitorData</span> executorMonitorData<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ExecutorReportService</span> reportService <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reportServices<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			reportService<span class="token punctuation">.</span><span class="token function">initReport</span><span class="token punctuation">(</span>executorMonitorData<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">report</span><span class="token punctuation">(</span><span class="token class-name">ExecutorMonitorData</span> executorMonitorData<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ExecutorReportService</span> reportService <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reportServices<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			reportService<span class="token punctuation">.</span><span class="token function">report</span><span class="token punctuation">(</span>executorMonitorData<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<ol start="6"><li>定义系统的监控服务ExecutorMonitorService，构造器传入ExecutorReportService，然后启动一个定时任务每十分钟收集一次系统的线程池的统计信息。线程池通过该类的register方法进行注册。</li></ol> 
<pre><code class="prism language-java">
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">LoggerFactory</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">top<span class="token punctuation">.</span>jfunc<span class="token punctuation">.</span>common<span class="token punctuation">.</span>thread<span class="token punctuation">.</span>monitor<span class="token punctuation">.</span>change<span class="token punctuation">.</span></span><span class="token class-name">ParamChangeBean</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">top<span class="token punctuation">.</span>jfunc<span class="token punctuation">.</span>common<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">MapUtil</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">top<span class="token punctuation">.</span>jfunc<span class="token punctuation">.</span>common<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">ThreadFactoryBuilder</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Closeable</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ConcurrentHashMap</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ScheduledExecutorService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ScheduledThreadPoolExecutor</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ThreadFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 线程池监控定时任务，定时上报线程池相关数据
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExecutorMonitorService</span> <span class="token keyword">implements</span> <span class="token class-name">Closeable</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">ExecutorMonitorService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//默认上报频率10分钟</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> DEFAULT_SCHEDULER_PERIOD <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ExecutorMonitorData</span><span class="token punctuation">&gt;</span></span> executorMonitorDataMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ScheduledExecutorService</span> scheduledExecutorService<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">CompositeExecutorReportService</span> executorReportServices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CompositeExecutorReportService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//统计数据呈现周期性，统计完成后就重置</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> statisticsPeriodically <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 指定上报监控信息的频率、上报服务
     * @param initDelay 初始化延迟
     * @param schedulerPeriod 上报频率
     * @param scheduledReportServices 定时上报的时候上报服务
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">ExecutorMonitorService</span><span class="token punctuation">(</span><span class="token keyword">long</span> initDelay<span class="token punctuation">,</span> <span class="token keyword">long</span> schedulerPeriod<span class="token punctuation">,</span> <span class="token class-name">ExecutorReportService</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> scheduledReportServices<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//首先注册reportService，否则register线程池的时候还没有reportService，就会丢失初始化数据</span>
        <span class="token function">addReportService</span><span class="token punctuation">(</span>scheduledReportServices<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>scheduledExecutorService <span class="token operator">=</span> <span class="token function">createAndInitScheduledExecutorService</span><span class="token punctuation">(</span>initDelay<span class="token punctuation">,</span> schedulerPeriod<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * 指定上报监控信息的频率默认频率、报服务
     * @param scheduledReportServices 定时上报的时候上报服务
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">ExecutorMonitorService</span><span class="token punctuation">(</span><span class="token class-name">ExecutorReportService</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> scheduledReportServices<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//首先注册reportService，否则register线程池的时候还没有reportService，就会丢失初始化数据</span>
        <span class="token function">addReportService</span><span class="token punctuation">(</span>scheduledReportServices<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>scheduledExecutorService <span class="token operator">=</span> <span class="token function">createAndInitScheduledExecutorService</span><span class="token punctuation">(</span>DEFAULT_SCHEDULER_PERIOD<span class="token punctuation">,</span> DEFAULT_SCHEDULER_PERIOD<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * 指定上报监控信息的线程池、报服务
     * @param scheduledExecutorService 用于运行监控上报信息的线程池
     * @param initDelay 初始化延迟
     * @param schedulerPeriod 上报频率
     * @param scheduledReportServices 定时上报的时候上报服务
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">ExecutorMonitorService</span><span class="token punctuation">(</span><span class="token class-name">ScheduledExecutorService</span> scheduledExecutorService<span class="token punctuation">,</span> <span class="token keyword">long</span> initDelay<span class="token punctuation">,</span> <span class="token keyword">long</span> schedulerPeriod<span class="token punctuation">,</span> <span class="token class-name">ExecutorReportService</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> scheduledReportServices<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//首先注册reportService，否则register线程池的时候还没有reportService，就会丢失初始化数据</span>
        <span class="token function">addReportService</span><span class="token punctuation">(</span>scheduledReportServices<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>scheduledExecutorService <span class="token operator">=</span> scheduledExecutorService<span class="token punctuation">;</span>
        <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>scheduledExecutorService<span class="token punctuation">,</span> initDelay<span class="token punctuation">,</span> schedulerPeriod<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 指定上报监控信息的线程池、报服务
     * @param scheduledExecutorService 用于运行监控上报信息的线程池
     * @param scheduledReportServices 定时上报的时候上报服务
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">ExecutorMonitorService</span><span class="token punctuation">(</span><span class="token class-name">ScheduledExecutorService</span> scheduledExecutorService<span class="token punctuation">,</span> <span class="token class-name">ExecutorReportService</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> scheduledReportServices<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//首先注册reportService，否则register线程池的时候还没有reportService，就会丢失初始化数据</span>
        <span class="token function">addReportService</span><span class="token punctuation">(</span>scheduledReportServices<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>scheduledExecutorService <span class="token operator">=</span> scheduledExecutorService<span class="token punctuation">;</span>
        <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>scheduledExecutorService<span class="token punctuation">,</span> DEFAULT_SCHEDULER_PERIOD<span class="token punctuation">,</span> DEFAULT_SCHEDULER_PERIOD<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 注册监控线程池
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">ExecutorMonitorData</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> executorMonitorDataList<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ExecutorMonitorData</span> executorMonitorData <span class="token operator">:</span> executorMonitorDataList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//注册</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>executorMonitorDataMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>executorMonitorData<span class="token punctuation">.</span><span class="token function">getIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> executorMonitorData<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//上报初始化信息</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>executorReportServices<span class="token punctuation">.</span><span class="token function">initReport</span><span class="token punctuation">(</span>executorMonitorData<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * 马上上报监控信息
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">reportMonitorData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">MapUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>executorMonitorDataMap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"还没有线程池注册，放弃上报任务"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ExecutorMonitorData</span> executorMonitorData <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>executorMonitorDataMap<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>executorReportServices<span class="token punctuation">.</span><span class="token function">report</span><span class="token punctuation">(</span>executorMonitorData<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//以上执行完后才重置</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>statisticsPeriodically<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    executorMonitorData<span class="token punctuation">.</span><span class="token function">resetStatistic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//当执行失败的时候需要catch，否则后续就不会执行了</span>
                logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 按照指定的{@link ExecutorReportService}来上报
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">reportMonitorData</span><span class="token punctuation">(</span><span class="token class-name">ExecutorReportService</span> executorReportService<span class="token punctuation">,</span> <span class="token class-name">ExecutorReportService</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> otherServices<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">MapUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>executorMonitorDataMap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"还没有线程池注册，放弃上报任务"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">CompositeExecutorReportService</span> compositeExecutorReportService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CompositeExecutorReportService</span><span class="token punctuation">(</span>executorReportService<span class="token punctuation">,</span> otherServices<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ExecutorMonitorData</span> executorMonitorData <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>executorMonitorDataMap<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            compositeExecutorReportService<span class="token punctuation">.</span><span class="token function">report</span><span class="token punctuation">(</span>executorMonitorData<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 动态修改线程池参数
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">changeParam</span><span class="token punctuation">(</span><span class="token class-name">ParamChangeBean</span> bean<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ExecutorMonitorData</span> executorMonitorData <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>executorMonitorDataMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> executorMonitorData<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"在本机未找到待修改线程池:"</span><span class="token operator">+</span>bean<span class="token punctuation">.</span><span class="token function">getIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span> <span class="token punctuation">(</span>executorMonitorData <span class="token keyword">instanceof</span> <span class="token class-name">ConfigurableExecutorMonitorData</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"放弃，该线程池不支持修改参数的:"</span><span class="token operator">+</span>bean<span class="token punctuation">.</span><span class="token function">getIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableExecutorMonitorData</span><span class="token punctuation">)</span>executorMonitorData<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onChange</span><span class="token punctuation">(</span>bean<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addReportService</span><span class="token punctuation">(</span><span class="token class-name">ExecutorReportService</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> reportServices<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        executorReportServices<span class="token punctuation">.</span><span class="token function">addServices</span><span class="token punctuation">(</span>reportServices<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">CompositeExecutorReportService</span> <span class="token function">getCompositeExecutorReportService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> executorReportServices<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token class-name">ScheduledExecutorService</span> <span class="token function">getScheduledExecutorService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>scheduledExecutorService<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ExecutorMonitorData</span><span class="token punctuation">&gt;</span></span> <span class="token function">getExecutorMonitorDataMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>executorMonitorDataMap<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isStatisticsPeriodically</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> statisticsPeriodically<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">ExecutorMonitorService</span> <span class="token function">setStatisticsPeriodically</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> statisticsPeriodically<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>statisticsPeriodically <span class="token operator">=</span> statisticsPeriodically<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>scheduledExecutorService<span class="token punctuation">.</span><span class="token function">shutdownNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>scheduledExecutorService<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">ScheduledExecutorService</span> <span class="token function">createAndInitScheduledExecutorService</span><span class="token punctuation">(</span><span class="token keyword">long</span> initDelay<span class="token punctuation">,</span> <span class="token keyword">long</span> schedulerPeriod<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ThreadFactory</span> threadFactory <span class="token operator">=</span> <span class="token class-name">ThreadFactoryBuilder</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setNameFormat</span><span class="token punctuation">(</span><span class="token string">"ExecutorMonitorService-Thread-%d"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
                <span class="token comment">//.setThreadFactory(Thread::new)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ScheduledThreadPoolExecutor</span> scheduledThreadPoolExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScheduledThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> threadFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">schedule</span><span class="token punctuation">(</span>scheduledThreadPoolExecutor<span class="token punctuation">,</span> initDelay<span class="token punctuation">,</span> schedulerPeriod<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> scheduledThreadPoolExecutor<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token class-name">ScheduledExecutorService</span> scheduledExecutorService<span class="token punctuation">,</span> <span class="token keyword">long</span> initDelay<span class="token punctuation">,</span> <span class="token keyword">long</span> schedulerPeriod<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        scheduledExecutorService<span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">reportMonitorData</span><span class="token punctuation">,</span> initDelay<span class="token punctuation">,</span> schedulerPeriod<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


</code></pre> 
<ol start="7"><li>定义用于保存监控统计数据到数据库的DbExecutorReportService和打印日志的LogExecutorReportService。</li></ol> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DbExecutorReportService</span> <span class="token keyword">implements</span> <span class="token class-name">ExecutorReportService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">DbExecutorReportService</span> service <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DbExecutorReportService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initReport</span><span class="token punctuation">(</span><span class="token class-name">ExecutorMonitorData</span> executorMonitorData<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">new</span> <span class="token class-name">ThreadpoolMonitorExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAttrs</span><span class="token punctuation">(</span><span class="token class-name">Bean2Map</span><span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span><span class="token class-name">ThreadPoolInitInfo</span><span class="token punctuation">.</span><span class="token function">fromMonitorData</span><span class="token punctuation">(</span>executorMonitorData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">report</span><span class="token punctuation">(</span><span class="token class-name">ExecutorMonitorData</span> executorMonitorData<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">new</span> <span class="token class-name">ThreadpoolMonitorExecutorDetail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAttrs</span><span class="token punctuation">(</span><span class="token class-name">Bean2Map</span><span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span><span class="token class-name">ThreadPoolDetailInfo</span><span class="token punctuation">.</span><span class="token function">fromMonitorData</span><span class="token punctuation">(</span>executorMonitorData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 将线程池监控信息json格式打印出来
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LogExecutorReportService</span> <span class="token keyword">implements</span> <span class="token class-name">ExecutorReportService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">LogExecutorReportService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">LogExecutorReportService</span> service <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LogExecutorReportService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initReport</span><span class="token punctuation">(</span><span class="token class-name">ExecutorMonitorData</span> executorMonitorData<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">toJSONStringWithDateFormat</span><span class="token punctuation">(</span><span class="token class-name">ThreadPoolInitInfo</span><span class="token punctuation">.</span><span class="token function">fromMonitorData</span><span class="token punctuation">(</span>executorMonitorData<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">DatetimeUtils</span><span class="token punctuation">.</span>SDF_DATETIME<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">report</span><span class="token punctuation">(</span><span class="token class-name">ExecutorMonitorData</span> executorMonitorData<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">toJSONStringWithDateFormat</span><span class="token punctuation">(</span><span class="token class-name">ThreadPoolDetailInfo</span><span class="token punctuation">.</span><span class="token function">fromMonitorData</span><span class="token punctuation">(</span>executorMonitorData<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">DatetimeUtils</span><span class="token punctuation">.</span>SDF_DATETIME<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="8"><li>定义线程池监控的静态数据实体ThreadPoolInitInfo和表threadpool_monitor_executor，包含所属服务、线程池名称、线程池的唯一标识（线程池一般随系统启动而启动，随系统关闭而关闭）、核心线程数、最大线程数、最大空闲时间、阻塞队列、线程工厂、拒绝策略、启动时间。</li></ol> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadPoolInitInfo</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//线程池所在服务</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> service<span class="token punctuation">;</span>
    <span class="token comment">//线程池名称</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> poolName<span class="token punctuation">;</span>
    <span class="token comment">//线程池唯一标识</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> identifier<span class="token punctuation">;</span>
    <span class="token comment">//线程池核心线程数量</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> corePoolSize<span class="token punctuation">;</span>
    <span class="token comment">//线程池中允许的最大线程数</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">;</span>
    <span class="token comment">//线程最大空闲时间（毫秒）</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> keepAliveTime<span class="token punctuation">;</span>
    <span class="token comment">//阻塞队列容量</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> queueCapacity<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> threadFactoryClass<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> blockingQueueClass<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> rejectedExecutionHandlerClass<span class="token punctuation">;</span>
    <span class="token comment">//线程池启动时间</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Date</span> startTime<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ThreadPoolInitInfo</span><span class="token punctuation">(</span><span class="token class-name">String</span> service<span class="token punctuation">,</span>
                              <span class="token class-name">String</span> poolName<span class="token punctuation">,</span>
                              <span class="token class-name">String</span> identifier<span class="token punctuation">,</span>
                              <span class="token keyword">int</span> corePoolSize<span class="token punctuation">,</span>
                              <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">,</span>
                              <span class="token keyword">long</span> keepAliveTime<span class="token punctuation">,</span>
                              <span class="token keyword">int</span> queueCapacity<span class="token punctuation">,</span>
                              <span class="token class-name">String</span> threadFactoryClass<span class="token punctuation">,</span>
                              <span class="token class-name">String</span> blockingQueueClass<span class="token punctuation">,</span>
                              <span class="token class-name">String</span> rejectedExecutionHandlerClass<span class="token punctuation">,</span>
                              <span class="token class-name">Date</span> startTime<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>service <span class="token operator">=</span> service<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>poolName <span class="token operator">=</span> poolName<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>identifier <span class="token operator">=</span> identifier<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>corePoolSize <span class="token operator">=</span> corePoolSize<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>maximumPoolSize <span class="token operator">=</span> maximumPoolSize<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>keepAliveTime <span class="token operator">=</span> keepAliveTime<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>queueCapacity <span class="token operator">=</span> queueCapacity<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>threadFactoryClass <span class="token operator">=</span> threadFactoryClass<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>blockingQueueClass <span class="token operator">=</span> blockingQueueClass<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rejectedExecutionHandlerClass <span class="token operator">=</span> rejectedExecutionHandlerClass<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>startTime <span class="token operator">=</span> startTime<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ThreadPoolInitInfo</span> <span class="token function">fromMonitorData</span><span class="token punctuation">(</span><span class="token class-name">ExecutorMonitorData</span> emd<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> blockingQueue <span class="token operator">=</span> emd<span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolInitInfo</span><span class="token punctuation">(</span>emd<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> emd<span class="token punctuation">.</span><span class="token function">getPoolName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> emd<span class="token punctuation">.</span><span class="token function">getIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                emd<span class="token punctuation">.</span><span class="token function">getCorePoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> emd<span class="token punctuation">.</span><span class="token function">getMaximumPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>emd<span class="token punctuation">.</span><span class="token function">getKeepAliveTime</span><span class="token punctuation">(</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span>
                blockingQueue<span class="token punctuation">.</span><span class="token function">remainingCapacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span> blockingQueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                emd<span class="token punctuation">.</span><span class="token function">getThreadFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                blockingQueue<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                emd<span class="token punctuation">.</span><span class="token function">getRejectedExecutionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                emd<span class="token punctuation">.</span><span class="token function">getStartTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="10"><li>定义线程池监控的动态数据实体ThreadPoolDetailInfo和表threadpool_monitor_executor_detail，所属服务、线程池名称、线程池的唯一标识（线程池一般随系统启动而启动，随系统关闭而关闭）、核心线程数、当前线程数、历史最大线程、最大线程数、当前活跃线程数、最大空闲时间、当前任务数、已完成数量、任务执行总时间、阻塞队列、线程工厂、拒绝策略、启动时间。</li></ol> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">top<span class="token punctuation">.</span>jfunc<span class="token punctuation">.</span>common<span class="token punctuation">.</span>thread<span class="token punctuation">.</span>monitor<span class="token punctuation">.</span>bean</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">top<span class="token punctuation">.</span>jfunc<span class="token punctuation">.</span>common<span class="token punctuation">.</span>thread<span class="token punctuation">.</span>monitor<span class="token punctuation">.</span></span><span class="token class-name">ExecutorMonitorData</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>math<span class="token punctuation">.</span></span><span class="token class-name">BigDecimal</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>math<span class="token punctuation">.</span></span><span class="token class-name">RoundingMode</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadPoolDetailInfo</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//线程池所在服务</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> service<span class="token punctuation">;</span>
    <span class="token comment">//线程池名称</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> poolName<span class="token punctuation">;</span>
    <span class="token comment">//线程池唯一标识</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> identifier<span class="token punctuation">;</span>
    <span class="token comment">//当前线程池大小</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> poolSize<span class="token punctuation">;</span>
    <span class="token comment">//线程池核心线程数量</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> corePoolSize<span class="token punctuation">;</span>
    <span class="token comment">//线程池生命周期中最大线程数量</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> largestPoolSize<span class="token punctuation">;</span>
    <span class="token comment">//线程池中允许的最大线程数</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">;</span>
    <span class="token comment">//线程池完成的任务数目</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> completedTaskCount<span class="token punctuation">;</span>
    <span class="token comment">//线程池中当前活跃个数</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> activeCount<span class="token punctuation">;</span>
    <span class="token comment">//线程池当前的任务个数</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> taskCount<span class="token punctuation">;</span>
    <span class="token comment">//线程最大空闲时间（毫秒）</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> keepAliveTime<span class="token punctuation">;</span>
    <span class="token comment">//是否允许核心线程空闲回收，0和1，数字方便存储</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> allowsCoreThreadTimeOut<span class="token punctuation">;</span>
    <span class="token comment">//当前活跃线程的占比</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> activePercent<span class="token punctuation">;</span>
    <span class="token comment">//任务队列容量（阻塞队列）</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> queueCapacity<span class="token punctuation">;</span>
    <span class="token comment">//当前队列中任务的数量</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> queueSize<span class="token punctuation">;</span>
    <span class="token comment">//线程池中任务平均执行时长</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> avgExecuteTime<span class="token punctuation">;</span>
    <span class="token comment">//最长执行时间</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> maxExecuteTime<span class="token punctuation">;</span>
    <span class="token comment">//最短执行时间</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> minExecuteTime<span class="token punctuation">;</span>
    <span class="token comment">//线程池中执行超时次数</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> executeTimeoutCount<span class="token punctuation">;</span>
    <span class="token comment">//线程池中执行发生异常次数</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> executeExceptionCount<span class="token punctuation">;</span>
    <span class="token comment">//最长等待时间</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> maxQueueTime<span class="token punctuation">;</span>
    <span class="token comment">//最短等待时间</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> minQueueTime<span class="token punctuation">;</span>
    <span class="token comment">//线程池中排队超时次数</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> queueTimeoutCount<span class="token punctuation">;</span>
    <span class="token comment">//拒绝次数</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> rejectedCount<span class="token punctuation">;</span>
    <span class="token comment">//线程池启动时间</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Date</span> startTime<span class="token punctuation">;</span>
    <span class="token comment">//统计时间</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Date</span> createTime<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ThreadPoolDetailInfo</span><span class="token punctuation">(</span><span class="token class-name">String</span> service<span class="token punctuation">,</span>
                                <span class="token class-name">String</span> poolName<span class="token punctuation">,</span>
                                <span class="token class-name">String</span> identifier<span class="token punctuation">,</span>
                                <span class="token keyword">int</span> poolSize<span class="token punctuation">,</span>
                                <span class="token keyword">int</span> corePoolSize<span class="token punctuation">,</span>
                                <span class="token keyword">int</span> largestPoolSize<span class="token punctuation">,</span>
                                <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">,</span>
                                <span class="token keyword">long</span> completedTaskCount<span class="token punctuation">,</span>
                                <span class="token keyword">int</span> activeCount<span class="token punctuation">,</span>
                                <span class="token keyword">long</span> taskCount<span class="token punctuation">,</span>
                                <span class="token keyword">long</span> keepAliveTime<span class="token punctuation">,</span>
                                <span class="token keyword">int</span> allowsCoreThreadTimeOut<span class="token punctuation">,</span>
                                <span class="token keyword">int</span> activePercent<span class="token punctuation">,</span>
                                <span class="token keyword">int</span> queueCapacity<span class="token punctuation">,</span>
                                <span class="token keyword">int</span> queueSize<span class="token punctuation">,</span>
                                <span class="token keyword">long</span> avgExecuteTime<span class="token punctuation">,</span>
                                <span class="token keyword">long</span> maxExecuteTime<span class="token punctuation">,</span>
                                <span class="token keyword">long</span> minExecuteTime<span class="token punctuation">,</span>
                                <span class="token keyword">long</span> executeTimeoutCount<span class="token punctuation">,</span>
                                <span class="token keyword">long</span> executeExceptionCount<span class="token punctuation">,</span>
                                <span class="token keyword">long</span> maxQueueTime<span class="token punctuation">,</span>
                                <span class="token keyword">long</span> minQueueTime<span class="token punctuation">,</span>
                                <span class="token keyword">long</span> queueTimeoutCount<span class="token punctuation">,</span>
                                <span class="token keyword">int</span> rejectedCount<span class="token punctuation">,</span>
                                <span class="token class-name">Date</span> startTime<span class="token punctuation">,</span>
                                <span class="token class-name">Date</span> createTime<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>service <span class="token operator">=</span> service<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>poolName <span class="token operator">=</span> poolName<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>identifier <span class="token operator">=</span> identifier<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>poolSize <span class="token operator">=</span> poolSize<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>corePoolSize <span class="token operator">=</span> corePoolSize<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>largestPoolSize <span class="token operator">=</span> largestPoolSize<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>maximumPoolSize <span class="token operator">=</span> maximumPoolSize<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>completedTaskCount <span class="token operator">=</span> completedTaskCount<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>activeCount <span class="token operator">=</span> activeCount<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>taskCount <span class="token operator">=</span> taskCount<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>keepAliveTime <span class="token operator">=</span> keepAliveTime<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>allowsCoreThreadTimeOut <span class="token operator">=</span> allowsCoreThreadTimeOut<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>activePercent <span class="token operator">=</span> activePercent<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>queueCapacity <span class="token operator">=</span> queueCapacity<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>queueSize <span class="token operator">=</span> queueSize<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>avgExecuteTime <span class="token operator">=</span> avgExecuteTime<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>maxExecuteTime <span class="token operator">=</span> maxExecuteTime<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>minExecuteTime <span class="token operator">=</span> minExecuteTime<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>executeTimeoutCount <span class="token operator">=</span> executeTimeoutCount<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>executeExceptionCount <span class="token operator">=</span> executeExceptionCount<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>maxQueueTime <span class="token operator">=</span> maxQueueTime<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>minQueueTime <span class="token operator">=</span> minQueueTime<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>queueTimeoutCount <span class="token operator">=</span> queueTimeoutCount<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rejectedCount <span class="token operator">=</span> rejectedCount<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>startTime <span class="token operator">=</span> startTime<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>createTime <span class="token operator">=</span> createTime<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ThreadPoolDetailInfo</span> <span class="token function">fromMonitorData</span><span class="token punctuation">(</span><span class="token class-name">ExecutorMonitorData</span> emd<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">BigDecimal</span> activeCount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span>emd<span class="token punctuation">.</span><span class="token function">getActiveCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BigDecimal</span> maximumPoolSize <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span>emd<span class="token punctuation">.</span><span class="token function">getMaximumPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BigDecimal</span> result <span class="token operator">=</span> activeCount<span class="token punctuation">.</span><span class="token function">divide</span><span class="token punctuation">(</span>maximumPoolSize<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token class-name">RoundingMode</span><span class="token punctuation">.</span>HALF_UP<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> activePercent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Double</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">doubleValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//总时间/总完成任务数</span>
        <span class="token keyword">long</span> avgExecuteTime <span class="token operator">=</span> emd<span class="token punctuation">.</span><span class="token function">getCompletedTaskCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0L</span> <span class="token operator">?</span> <span class="token number">0L</span> <span class="token operator">:</span> emd<span class="token punctuation">.</span><span class="token function">getTotalExecuteTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> emd<span class="token punctuation">.</span><span class="token function">getCompletedTaskCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolDetailInfo</span><span class="token punctuation">(</span>emd<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> emd<span class="token punctuation">.</span><span class="token function">getPoolName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> emd<span class="token punctuation">.</span><span class="token function">getIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                emd<span class="token punctuation">.</span><span class="token function">getPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>emd<span class="token punctuation">.</span><span class="token function">getCorePoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>emd<span class="token punctuation">.</span><span class="token function">getLargestPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>emd<span class="token punctuation">.</span><span class="token function">getMaximumPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                emd<span class="token punctuation">.</span><span class="token function">getCompletedTaskCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>emd<span class="token punctuation">.</span><span class="token function">getActiveCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>emd<span class="token punctuation">.</span><span class="token function">getTaskCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>emd<span class="token punctuation">.</span><span class="token function">getKeepAliveTime</span><span class="token punctuation">(</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span>
                emd<span class="token punctuation">.</span><span class="token function">allowsCoreThreadTimeOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> activePercent<span class="token punctuation">,</span>
                emd<span class="token punctuation">.</span><span class="token function">getQueueCapacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>emd<span class="token punctuation">.</span><span class="token function">getQueueSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                avgExecuteTime<span class="token punctuation">,</span>emd<span class="token punctuation">.</span><span class="token function">getMaxExecuteTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> emd<span class="token punctuation">.</span><span class="token function">getMinExecuteTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>emd<span class="token punctuation">.</span><span class="token function">getExecuteTimeoutCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>emd<span class="token punctuation">.</span><span class="token function">getExecuteExceptionCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                emd<span class="token punctuation">.</span><span class="token function">getMaxQueueTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> emd<span class="token punctuation">.</span><span class="token function">getMinQueueTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> emd<span class="token punctuation">.</span><span class="token function">getQueueTimeoutCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                emd<span class="token punctuation">.</span><span class="token function">getRejectedCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>emd<span class="token punctuation">.</span><span class="token function">getStartTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>threadpool_monitor_executor<span class="token punctuation">`</span></span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>threadpool_monitor_executor<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>service<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'线程池所在服务'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>poolName<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'线程池名称'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>identifier<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'线程池的唯一标识'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>corePoolSize<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'核心线程数'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>maximumPoolSize<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'最大线程数'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>keepAliveTime<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'最大空闲时间（ms）'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>queueCapacity<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'阻塞队列容量'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>threadFactoryClass<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>blockingQueueClass<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>rejectedExecutionHandlerClass<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>startTime<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'线程池启动时间'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_time<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>startTime<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">6</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span>

<span class="token comment">-- ----------------------------</span>
<span class="token comment">-- Table structure for threadpool_monitor_executor_detail</span>
<span class="token comment">-- ----------------------------</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>threadpool_monitor_executor_detail<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>service<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'线程池所在服务'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>poolName<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'线程池名称'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>identifier<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'线程池的唯一标识'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>poolSize<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'当前线程池大小'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>corePoolSize<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'核心线程数量'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>largestPoolSize<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'到达过的最大线程数量'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>keepAliveTime<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'最大空闲时间（ms）'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>allowsCoreThreadTimeOut<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'是否允许核心线程空闲回收'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>maximumPoolSize<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'最大线程数量'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>completedTaskCount<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'完成的任务数量'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>activeCount<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'活跃线程数'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>taskCount<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'任务数量'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>activePercent<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'活跃占比'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>queueCapacity<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'阻塞队列容量'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>queueSize<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'阻塞队列任务数量'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>avgExecuteTime<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'线程池中任务平均执行时长（ms）'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>maxExecuteTime<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'最大执行时间，周期性统计'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>minExecuteTime<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'最小执行时间，周期性统计'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>executeTimeoutCount<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'执行超时次数'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>executeExceptionCount<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'执行异常次数，即抛出异常次数'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>maxQueueTime<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'最大排队时间，周期性统计'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>minQueueTime<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'最小排队时间，周期性统计'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>queueTimeoutCount<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'排队超时次数'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>rejectedCount<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'拒绝次数'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>createTime<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'统计时间'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_time_service_name<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>createTime<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>service<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>poolName<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span>



</code></pre> 
<ol><li>开发页面用于展示线程池的静态参数和动态参数，动态参数展示中有一个比较特别的参数。因为相同的线程池可能因为重启唯一标识identifier不一样，但是所属服务service和名称poolName不会变。</li><li>以如下定义的线程池和任务统计数据图表展示如下</li></ol> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExecutorMonitorServiceHolder</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ExecutorMonitorService</span> service <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExecutorMonitorService</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">LogExecutorReportService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">DbExecutorReportService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">static</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">ThreadFactory</span> threadFactory <span class="token operator">=</span> <span class="token class-name">ThreadFactoryBuilder</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">setNameFormat</span><span class="token punctuation">(</span><span class="token string">"Test-Monitor-Thread-%d"</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
				<span class="token comment">//.setThreadFactory(Thread::new)</span>
				<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>AbortPolicy</span> policy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>AbortPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">MonitoredThreadPoolExecutor</span> executor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MonitoredThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span>
				<span class="token number">10</span><span class="token punctuation">,</span>
				<span class="token number">60</span><span class="token punctuation">,</span>
				<span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">,</span>
				<span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
				threadFactory<span class="token punctuation">,</span>
				policy<span class="token punctuation">,</span>
				<span class="token string">"Rest"</span><span class="token punctuation">,</span> <span class="token class-name">IpUtil</span><span class="token punctuation">.</span><span class="token function">getLocalIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">":"</span><span class="token operator">+</span> <span class="token class-name">SystemConfig</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>port<span class="token operator">+</span><span class="token string">":TestMonitorExecutor"</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">setExecuteTimeout</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setQueueTimeout</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">ExecutorMonitorServiceHolder</span><span class="token punctuation">.</span>service<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{<!-- --></span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">10000000</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
				<span class="token keyword">final</span> <span class="token keyword">int</span> j <span class="token operator">=</span> i<span class="token punctuation">;</span>
				executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{<!-- --></span>
					<span class="token keyword">if</span><span class="token punctuation">(</span>j <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
						<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					<span class="token class-name">ThreadUtil</span><span class="token punctuation">.</span><span class="token function">sleeps</span><span class="token punctuation">(</span><span class="token class-name">RandomUtil</span><span class="token punctuation">.</span><span class="token function">randomInt</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">ThreadUtil</span><span class="token punctuation">.</span><span class="token function">sleeps</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/d7/af/tuEkQfNe_o.png" alt="线程池线程监控"><br> <img src="https://images2.imgbox.com/5b/a1/Job8wT0U_o.png" alt="线程池任务监控"><br> <img src="https://images2.imgbox.com/4c/bd/crKdgEV8_o.png" alt="线程池队列监控"><br> <img src="https://images2.imgbox.com/ad/20/yoCA3goO_o.png" alt="线程池任务执行时间监控"><br> <img src="https://images2.imgbox.com/40/6f/77MhoEPd_o.png" alt="线程池异常监控"><br> <img src="https://images2.imgbox.com/6c/de/60hJUkYO_o.png" alt="其他"></p> 
<p>（二）、线程池动态修改参数</p> 
<ol><li>定义修改接口</li></ol> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 可修改参数的线程池接口
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ConfigurableExecutorMonitorData</span> <span class="token keyword">extends</span> <span class="token class-name">ExecutorMonitorData</span><span class="token punctuation">{<!-- --></span>
	<span class="token comment">/**
	 * 修改线程池参数
	 * @param bean 待修改的参数值
	 */</span>
	<span class="token keyword">void</span> <span class="token function">onChange</span><span class="token punctuation">(</span><span class="token class-name">ParamChangeBean</span> bean<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>实现该类的就需要实现该方法，将新参数设置进线程池<br> 2. <code>MonitoredThreadPoolExecutor</code>中的修改</p> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onChange</span><span class="token punctuation">(</span><span class="token class-name">ParamChangeBean</span> bean<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ParamChangerUtil</span><span class="token punctuation">.</span><span class="token function">paramChange</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutorParamChangeAdapter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>



<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">BlockingQueue</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * j.u.c {@link ThreadPoolExecutor}适配器
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadPoolExecutorParamChangeAdapter</span> <span class="token keyword">implements</span> <span class="token class-name">ParamChangeable</span><span class="token punctuation">{<!-- --></span>
	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ThreadPoolExecutor</span> delegate<span class="token punctuation">;</span>

	<span class="token keyword">public</span> <span class="token class-name">ThreadPoolExecutorParamChangeAdapter</span><span class="token punctuation">(</span><span class="token class-name">ThreadPoolExecutor</span> threadPoolExecutor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>delegate <span class="token operator">=</span> threadPoolExecutor<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getCorePoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">.</span><span class="token function">getCorePoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCorePoolSize</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">.</span><span class="token function">setCorePoolSize</span><span class="token punctuation">(</span>corePoolSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getMaximumPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">.</span><span class="token function">getMaximumPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setMaximumPoolSize</span><span class="token punctuation">(</span><span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">.</span><span class="token function">setMaximumPoolSize</span><span class="token punctuation">(</span>maximumPoolSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getKeepAliveTime</span><span class="token punctuation">(</span><span class="token class-name">TimeUnit</span> timeUnit<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">.</span><span class="token function">getKeepAliveTime</span><span class="token punctuation">(</span>timeUnit<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setKeepAliveTime</span><span class="token punctuation">(</span><span class="token keyword">long</span> keepAliveTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> timeUnit<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">.</span><span class="token function">setKeepAliveTime</span><span class="token punctuation">(</span>keepAliveTime<span class="token punctuation">,</span> timeUnit<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">allowsCoreThreadTimeOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">.</span><span class="token function">allowsCoreThreadTimeOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">allowCoreThreadTimeOut</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> allowCoreThreadTimeOut<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">.</span><span class="token function">allowCoreThreadTimeOut</span><span class="token punctuation">(</span>allowCoreThreadTimeOut<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCapacity</span><span class="token punctuation">(</span><span class="token keyword">int</span> queueCapacity<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">//队列容量</span>
		<span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> blockingQueue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>blockingQueue <span class="token keyword">instanceof</span> <span class="token class-name">ResizableCapacityLinkedBlockingQueue</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			<span class="token keyword">int</span> capacity <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ResizableCapacityLinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> blockingQueue<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCapacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>capacity <span class="token operator">!=</span> queueCapacity<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
				<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ResizableCapacityLinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>blockingQueue<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCapacity</span><span class="token punctuation">(</span>queueCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>




<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ParamChangerUtil</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">private</span> <span class="token class-name">ParamChangerUtil</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">paramChange</span><span class="token punctuation">(</span><span class="token class-name">ParamChangeable</span> paramChangeable<span class="token punctuation">,</span> <span class="token class-name">ParamChangeBean</span> bean<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token comment">//核心线程数</span>
		<span class="token keyword">int</span> corePoolSize <span class="token operator">=</span> bean<span class="token punctuation">.</span><span class="token function">getCorePoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>corePoolSize <span class="token operator">!=</span> paramChangeable<span class="token punctuation">.</span><span class="token function">getCorePoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			paramChangeable<span class="token punctuation">.</span><span class="token function">setCorePoolSize</span><span class="token punctuation">(</span>corePoolSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">//最大线程数</span>
		<span class="token keyword">int</span> maximumPoolSize <span class="token operator">=</span> bean<span class="token punctuation">.</span><span class="token function">getMaximumPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>maximumPoolSize <span class="token operator">!=</span> paramChangeable<span class="token punctuation">.</span><span class="token function">getMaximumPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			paramChangeable<span class="token punctuation">.</span><span class="token function">setMaximumPoolSize</span><span class="token punctuation">(</span>maximumPoolSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">//最大空闲时间</span>
		<span class="token keyword">long</span> keepAliveTime <span class="token operator">=</span> bean<span class="token punctuation">.</span><span class="token function">getKeepAliveTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>keepAliveTime <span class="token operator">!=</span> paramChangeable<span class="token punctuation">.</span><span class="token function">getKeepAliveTime</span><span class="token punctuation">(</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			paramChangeable<span class="token punctuation">.</span><span class="token function">setKeepAliveTime</span><span class="token punctuation">(</span>keepAliveTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">//是否允许核心线程空闲回收</span>
		<span class="token keyword">int</span> allowCoreThreadTimeOut <span class="token operator">=</span> bean<span class="token punctuation">.</span><span class="token function">getAllowCoreThreadTimeOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		paramChangeable<span class="token punctuation">.</span><span class="token function">allowCoreThreadTimeOut</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> allowCoreThreadTimeOut<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">//队列容量</span>
		paramChangeable<span class="token punctuation">.</span><span class="token function">setCapacity</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getQueueCapacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>以后适配其他线程池照此即可<br> 3. 而调用方法，在<code>ExecutorMonitorService#changeParam</code>中，一般有三种通知方法，收到通知后调用此方法修改。因为一般滴都需要考虑集群部署的情况。<br> 1） 利用redis的pubsub机制<br> 2）利用nginx的mirror机制<br> 3）有配置中心的利用配置中心的动态修改参数通知</p> 
<pre><code class="prism language-java">    <span class="token comment">/**
     * 动态修改线程池参数
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">changeParam</span><span class="token punctuation">(</span><span class="token class-name">ParamChangeBean</span> bean<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ExecutorMonitorData</span> executorMonitorData <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>executorMonitorDataMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> executorMonitorData<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"在本机未找到待修改线程池:"</span><span class="token operator">+</span>bean<span class="token punctuation">.</span><span class="token function">getIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span> <span class="token punctuation">(</span>executorMonitorData <span class="token keyword">instanceof</span> <span class="token class-name">ConfigurableExecutorMonitorData</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"放弃，该线程池不支持修改参数的:"</span><span class="token operator">+</span>bean<span class="token punctuation">.</span><span class="token function">getIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableExecutorMonitorData</span><span class="token punctuation">)</span>executorMonitorData<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onChange</span><span class="token punctuation">(</span>bean<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0fccd511c2ed135dea0d9a60af10bce1/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【软件卸载-ASM(IsaHelper)入网小助手卸载】</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b8ce534beb34e0e851c9a4ff0265db09/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Dubbo与SpringCloud核心组件Ribbon、Hystrix、Feign的优劣势比较</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>