<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>UC/OS-II在ARM微处理器上的移植及编译 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="UC/OS-II在ARM微处理器上的移植及编译" />
<meta property="og:description" content="一、实验目的
1．了解uCOS-II内核的主要结构。
2．掌握将uCOS-II内核移植到ARM920T处理器上的基本方法。
二、实验内容
1．将uCOS-II内核移植到ARM920T微处理器上。
2．编写两个简单任务，在开发板显示器上观察两个任务的切换。
三、预备知识
1．掌握在ARMADS1.2集成开发环境中编写和调试程序的基本过程。
2．了解ARM920T处理器的结构。
3．了解uCOS-II系统结构。
四、实验设备及工具
硬件：ARM嵌入式开发平台、用于ARM920T的JTAG仿真器、PC机Pentium100以上。
软件：PC机操作系统Win2000或WinXP、ARMADS1.2集成开发环境、仿真器驱动程序、超级终端通讯程序。
五、实验原理
所谓移植，指的是一个操作系统可以在某个微处理器或者微控制器上运行。虽然uCOS-II的大部分源代码是用C语言写成的，仍需要用C语言和汇编语言完成一些与处理器相关的代码。比如：uCOS-II在读写处理器、寄存器时只能通过汇编语言来实现。因为uCOS-II在设计的时候就已经充分考虑了可移植性，所以，uCOS-II的移植还是比较容易的。
要使uCOS-II可以正常工作，处理器必须满足以下要求：
1．处理器的C编译器能产生可重入代码。
可重入的代码指的是一段代码（如一个函数）可以被多个任务同时调用，而不必担心会破坏数据。也就是说，可重入型函数在任何时候都可以被中断执行，过一段时间以后又可以继续运行，而不会因为在函数中断的时候被其他的任务重新调用，影响函数中的数据。下面的两个例子可以比较可重入型函数和非可重入型函数：
程序1：可重入型函数
void swap(int *x, int *y)
{
int temp;
temp=*x;
*x=*y;
*y=temp;
}
程序2：非可重入型函数
int temp;
void swap(int *x, int *y)
{
temp=*x;
*x=*y;
*y=temp;
}
程序1中使用的是局部变量temp作为变量。通常的C编译器，把局部变量分配在栈中。所以，多次调用同一个函数，可以保证每次的temp互不受影响。而程序2中temp定义的是全局变量，多次调用函数的时候，必然受到影响。
代码的可重入性是保证完成多任务的基础，除了在C程序中使用局部变量以外，还需要C编译器的支持。笔者使用的是ARM ADS的集成开发环境，均可以生成可重入的代码。
2．在程序中可以打开或者关闭中断。
在uCOS-II中，可以通过OS_ENTER_CRITICAL()或者OS_EXIT_CRITICAL()宏来控制系统关闭或者打开中断。这需要处理器的支持,在ARM920T的处理器上，可以设置相应的寄存器来关闭或者打开系统的所有中断。
3．处理器支持中断，并且能产生定时中断（通常在10Hz1000Hz之间）。
uCOS-II是通过处理器产生的定时器的中断来实现多任务之间的调度的。在ARM920T的处理器上可以产生定时器中断。
4．处理器支持能够容纳一定量数据的硬件堆栈。
5．处理器有将堆栈指针和其它CPU寄存器存储和读出到堆栈（或者内存）的指令。
uCOS-II进行任务调度的时候，会把当前任务的CPU寄存器存放到此任务的堆栈中，然后，再从另一个任务的堆栈中恢复原来的工作寄存器，继续运行另一个任务。所以，寄存器的入栈和出栈是uCOS-II多任务调度的基础。
图3-1说明了uC/OS的结构以及它与硬件的关系。
图3-1 uCOS-II硬件和软件体系结构
ARM920T处理器完全满足上述要求。接下来将介绍如何把uCOS-II移植到Samsung公司的一款ARM920T的嵌入式处理器——S3C2410X上。
六、实验步骤
1．启动ADS1.20新建工程，将“Exp10 系统移植实验”中的文件添加到工程。由于开发商对源代码进行了封装，有些功能函数在“Exp10 系统移植实验”中的文件中没有实现，固可以尝试修改实验二的“Exp17 多任务与AD转换”主函数代码来实现本次实验。
2. 在ADS集成开发环境中编译、调试和运行工程程序。其中，修改部分代码，分别在主函数main和两个任务函数Task1和Task2。代码如下：
int main(void)
{ ARMTargetInit(); // do target (uHAL based ARM system)initialisation //" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/33ec1d7856c464432cc3c143effd3cf2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2015-06-27T23:24:27+08:00" />
<meta property="article:modified_time" content="2015-06-27T23:24:27+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">UC/OS-II在ARM微处理器上的移植及编译</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>一、实验目的</p> 
<p>1．了解uCOS-II内核的主要结构。</p> 
<p>2．掌握将uCOS-II内核移植到ARM920T处理器上的基本方法。</p> 
<p>二、实验内容</p> 
<p>1．将uCOS-II内核移植到ARM920T微处理器上。</p> 
<p>2．编写两个简单任务，在开发板显示器上观察两个任务的切换。</p> 
<p>三、预备知识</p> 
<p>1．掌握在ARMADS1.2集成开发环境中编写和调试程序的基本过程。</p> 
<p>2．了解ARM920T处理器的结构。</p> 
<p>3．了解uCOS-II系统结构。</p> 
<p>四、实验设备及工具</p> 
<p>硬件：ARM嵌入式开发平台、用于ARM920T的JTAG仿真器、PC机Pentium100以上。</p> 
<p>软件：PC机操作系统Win2000或WinXP、ARMADS1.2集成开发环境、仿真器驱动程序、超级终端通讯程序。</p> 
<p>五、实验原理</p> 
<p>所谓移植，指的是一个操作系统可以在某个微处理器或者微控制器上运行。虽然uCOS-II的大部分源代码是用C语言写成的，仍需要用C语言和汇编语言完成一些与处理器相关的代码。比如：uCOS-II在读写处理器、寄存器时只能通过汇编语言来实现。因为uCOS-II在设计的时候就已经充分考虑了可移植性，所以，uCOS-II的移植还是比较容易的。</p> 
<p>要使uCOS-II可以正常工作，处理器必须满足以下要求：</p> 
<p>1．处理器的C编译器能产生可重入代码。</p> 
<p>可重入的代码指的是一段代码（如一个函数）可以被多个任务同时调用，而不必担心会破坏数据。也就是说，可重入型函数在任何时候都可以被中断执行，过一段时间以后又可以继续运行，而不会因为在函数中断的时候被其他的任务重新调用，影响函数中的数据。下面的两个例子可以比较可重入型函数和非可重入型函数：</p> 
<p>程序1：可重入型函数</p> 
<p>void swap(int *x, int *y)</p> 
<p>{<!-- --></p> 
<p>int temp;</p> 
<p>       temp=*x;</p> 
<p>*x=*y;</p> 
<p>*y=temp;</p> 
<p>}</p> 
<p>程序2：非可重入型函数</p> 
<p>int temp;</p> 
<p>void swap(int *x, int *y)</p> 
<p>{<!-- --></p> 
<p>       temp=*x;</p> 
<p>       *x=*y;</p> 
<p>       *y=temp;</p> 
<p>}</p> 
<p>程序1中使用的是局部变量temp作为变量。通常的C编译器，把局部变量分配在栈中。所以，多次调用同一个函数，可以保证每次的temp互不受影响。而程序2中temp定义的是全局变量，多次调用函数的时候，必然受到影响。</p> 
<p>代码的可重入性是保证完成多任务的基础，除了在C程序中使用局部变量以外，还需要C编译器的支持。笔者使用的是ARM ADS的集成开发环境，均可以生成可重入的代码。</p> 
<p>2．在程序中可以打开或者关闭中断。</p> 
<p>在uCOS-II中，可以通过OS_ENTER_CRITICAL()或者OS_EXIT_CRITICAL()宏来控制系统关闭或者打开中断。这需要处理器的支持,在ARM920T的处理器上，可以设置相应的寄存器来关闭或者打开系统的所有中断。</p> 
<p>3．处理器支持中断，并且能产生定时中断（通常在10Hz1000Hz之间）。</p> 
<p>uCOS-II是通过处理器产生的定时器的中断来实现多任务之间的调度的。在ARM920T的处理器上可以产生定时器中断。</p> 
<p>4．处理器支持能够容纳一定量数据的硬件堆栈。</p> 
<p>5．处理器有将堆栈指针和其它CPU寄存器存储和读出到堆栈（或者内存）的指令。</p> 
<p>uCOS-II进行任务调度的时候，会把当前任务的CPU寄存器存放到此任务的堆栈中，然后，再从另一个任务的堆栈中恢复原来的工作寄存器，继续运行另一个任务。所以，寄存器的入栈和出栈是uCOS-II多任务调度的基础。</p> 
<p align="center">图3-1说明了uC/OS的结构以及它与硬件的关系。</p> 
<p align="center"><img src="https://images2.imgbox.com/25/5e/5HJ9i2nA_o.jpg" alt=""><br> </p> 
<p align="center" style="text-align:left"></p> 
<p align="center">图3-1 uCOS-II硬件和软件体系结构</p> 
<p>ARM920T处理器完全满足上述要求。接下来将介绍如何把uCOS-II移植到Samsung公司的一款ARM920T的嵌入式处理器——S3C2410X上。</p> 
<p>六、实验步骤</p> 
<p>1．启动ADS1.20新建工程，将“Exp10 系统移植实验”中的文件添加到工程。由于开发商对源代码进行了封装，有些功能函数在“Exp10 系统移植实验”中的文件中没有实现，固可以尝试修改实验二的“Exp17 多任务与AD转换”主函数代码来实现本次实验。</p> 
<p>2. 在ADS集成开发环境中编译、调试和运行工程程序。其中，修改部分代码，分别在主函数main和两个任务函数Task1和Task2。代码如下：</p> 
<p>int main(void)</p> 
<p>{     </p> 
<p>       ARMTargetInit();        // do target (uHAL based ARM system)initialisation //</p> 
<p>       OSInit();               // needed by uC/OS-II //</p> 
<p>       OSInitUart();</p> 
<p>       initOSFile();</p> 
<p>#if USE_MINIGUI==0</p> 
<p>       initOSMessage();</p> 
<p>       initOSList();</p> 
<p>       initOSDC();</p> 
<p>       initOSCtrl();</p> 
<p>       LoadFont();</p> 
<p>#endif</p> 
<p>       loadsystemParam();</p> 
<p>       //create the tasks in uC/OS and assign increasing //</p> 
<p>       //priorities to them so that Task3 at the end of //</p> 
<p>       //the pipeline has the highest priority.         //</p> 
<p>       LCD_printf("Createtask on uCOS-II...\n");</p> 
<p>       OSTaskCreate(Task1,  (void *)0, (OS_STK *)&amp;task1_Stack[STACKSIZE-1], Task1_Prio);</p> 
<p>       OSTaskCreate(Task2,  (void *)0, (OS_STK *)&amp;task2_Stack[STACKSIZE-1], Task2_Prio);</p> 
<p>       </p> 
<p>       OSAddTask_Init(1);//创建系统附加任务</p> 
<p>       LCD_printf("StartinguCOS-II...\n");</p> 
<p>       LCD_printf("Enteringgraph mode...\n");</p> 
<p>       LCD_ChangeMode(DspTxtMode);</p> 
<p>       OSStart();//操作系统任务调度开始</p> 
<p>       //不会执行到这里</p> 
<p>       return0;</p> 
<p>}</p> 
<p> </p> 
<p>//</p> 
<p> </p> 
<p>void Task1(void *Id)</p> 
<p>{<!-- --></p> 
<p>       for(;;){<!-- --></p> 
<p>              LCD_printf("runtask1\n");</p> 
<p>              OSTimeDly(1000);</p> 
<p>       }</p> 
<p>}</p> 
<p>void Task2(void *Id)</p> 
<p>{<!-- --></p> 
<p>       for(;;){<!-- --></p> 
<p>              LCD_printf("runtask2\n");</p> 
<p>              OSTimeDly(3000);</p> 
<p>       }</p> 
<p>}</p> 
<p>3.编译生成system.bin文件之前，首先清除一下已经生成的目标文件，避免路径不对，编译报错。点击project-&gt; remove object code ,出现下图，点击AllTargets。</p> 
<img src="https://images2.imgbox.com/5a/f5/KpkdJRSb_o.png" alt=""> 
<br> 
<p align="center" style="text-align:left"></p> 
<p>编译工程。点击project-&gt;make ;或者直接点击 make。</p> 
<img src="https://images2.imgbox.com/4b/ce/N8wsKTUE_o.png" alt=""> 
<br> 
<p align="center" style="text-align:left"></p> 
<p>编译之后弹出如下窗口，只要没要error就可以，warning 可以忽略。</p> 
<img src="https://images2.imgbox.com/7d/a6/Jqi7KiAe_o.png" alt=""> 
<br> 
<p align="center" style="text-align:left"></p> 
<p>4. 烧写 ADS 1.2 的system.bin 到flash：</p> 
<p>注意：ADS 1.2 生成的可烧写文件在对应工程目录里Data\Debug\system.bin。</p> 
<span style="color:rgb(51,51,51)">打开超级终端，选择ARM</span>开发平台实际连接的PC机串口（如COM1），按确定后出现如图所示的属性对话框，设置通信的格式和协议。这里波特率为115200，数据位 8，无奇偶校验，停止位 1，无数据流控制。按确定完成设置。将开发板重新启动同时按下键盘中任意键，这时在超级终端将会看到下面图提示，在 vivi&gt;后键入 load flash ucos x 然后回车。 
<p align="center" style="text-align:left"><img src="https://images2.imgbox.com/65/9e/sYWTjgT1_o.png" alt=""><br> </p> 
<p align="center" style="text-align:left"></p> 
<p align="left"><span style="color:rgb(51,51,51)">这时将会进入下图的界面，然后打开超级终端上方的“传送”菜单并选择发送文件，点击浏览按键，查找并进入到编译生成的映象文件夹下，打开 system.bin</span>。然后在发送文件对话框中的协议栏选择 Xmodem，最后选择发送。发送结束后，映象文件即下载到 flash 中，然后，按照第三个图键入 bootucos 命令再回车即可运行ucos程序。  </p> 
<img src="https://images2.imgbox.com/88/bc/YZ5qLTkP_o.png" alt=""> 
<br> 
<p align="center" style="text-align:left"><img src="https://images2.imgbox.com/71/1b/VvcFK0RK_o.png" alt=""><br> </p> 
<p align="center" style="text-align:left"></p> 
<h4>七、实验结果</h4> 
<p></p> 
<p>开发板上的显示器会不断随机出现runtask1和run task2，如图所示，这是多个任务在切换运行。</p> 
<img src="https://images2.imgbox.com/c2/06/GeiXJeqJ_o.jpg" alt=""> 
<br> 
<p align="center" style="text-align:left"></p> 
<h4>八、实验心得</h4> 
<p></p> 
<p>   通过实验，了解了系统移植到运行的整个开发过程，收益良多，但是还有一个问题没有很好地得到解决。那就是没有找到液晶显示相关函数LCD_printf()，因为没有找到头文件Lcd320.h，经过分析应该是开发商在这个实验工程没有封装进去，只好在工程文件“Exp17 多任务与AD转换”中进行修改代码，但是这样做会显得生成的目标代码过于冗长，不利于嵌入式的系统开发。</p> 
<span style="font-size:24px">需要“Exp10 系统移植实验”和“Exp17 多任务与AD转换”中的文件请联系邮箱269872441@qq.com</span> 
<br>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/19f1350b1418e156e8cedac05546a2ad/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">ubuntu下使用HDMI时输出无声音的解决方法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b54c708d8d4dee580796e50f882b3e6b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">多任务与AD转换</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>