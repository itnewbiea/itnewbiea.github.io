<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>C&#43;&#43; 实现lambda递归调用（C&#43;&#43;11 - C&#43;&#43;23） - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="C&#43;&#43; 实现lambda递归调用（C&#43;&#43;11 - C&#43;&#43;23）" />
<meta property="og:description" content="目录 前言前置知识 C&#43;&#43;11，借助std::functionC&#43;&#43;14，基于Y不动点组合子（Y Combinator）科里化直接传入打包关于返回值推断 C&#43;&#43;23 借助Deducing this实现lambda递归 前言 众所周知，C&#43;&#43;11起出现了 lambda表达式 ，或者叫闭包，使得C&#43;&#43;函数式编程的实现更为容易。本文不对lambda表达式的历史意义以及工程意义做过多探讨，只是给大家介绍一下如何递归调用lambda表达式。关于lambda表达式的基本用法，敬请移步 cppreference或相关博客，本文默认读者具有最基本的lambda语法认识。
我们知道，倘若直接如同普通函数一般在函数体内尝试递归调用是会语法错误的，无论是采用引用捕获亦或是值捕获都无法完成，此处不做赘述。因此我们需要借助别的东西来实现递归调用。
前置知识 阅读本文，你需要有：
相当基本的C&#43;&#43;语法基础十分基本的C&#43;&#43; lambda表达式语法基础非常基本的递归函数认识最为基本的中文基础 C&#43;&#43;11，借助std::function 以斐波那契数列为例，我们可以使用lambda表达式来构造一个 std::function 对象，如同这样：
#include &lt;iostream&gt; #include &lt;functional&gt; int main(int argc, char* argv[]) { std::function&lt;int(int)&gt; fib = [&amp;fib](int n) { return n &lt; 2 ? n : fib(n - 1) &#43; fib(n - 2); }; std::cout &lt;&lt; fib(5); return 0; } 不过很显然，这种方法从声明形式上来看并不是那么优雅，从书写形式上来看，右边lambda写了一遍的函数签名左边还要照抄一遍，过于繁琐与丑陋。此外，用闭包去初始化std::function对象，本质上并没有解决lambda递归调用的问题，只是规避了这个问题而已，反而引入了许多新的问题，它并不是零开销抽象的。另外他还有一些功能上的残缺，比如我们尝试实现一个尾递归调用的斐波那契数列：
很显然，对于带有默认参数的lambda表达式，std::function并不能承载其全部功能。
C&#43;&#43;14，基于Y不动点组合子（Y Combinator） 如果读者有基本的lambda演算基础，应该对于“Y不动点组合子”有一些概念，它是用来解决匿名函数的递归调用问题的。
科里化 具体理论此处不做讲述，直接看代码，相对纯正的FP写法如下，由于我们要做科里化，传递lambda表达式，此处使用了来自C&#43;&#43;14的泛型lambda，即支持在lambda表达式的参数列表中使用auto：
#include &lt;iostream&gt; int main() { auto T = [&amp;](auto x) { return [&amp;](auto y) { return y([&amp;](auto z) {return x(x)(y)(z); }); }; }; auto X = T(T); auto fib = X([](auto f) { return [&amp;](auto n)-&gt;int { return n &lt; 2 ?" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/8cb75e69ea50d55cd82545c2b5185e49/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-06-24T03:45:28+08:00" />
<meta property="article:modified_time" content="2022-06-24T03:45:28+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">C&#43;&#43; 实现lambda递归调用（C&#43;&#43;11 - C&#43;&#43;23）</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><ul><li><a href="#_1" rel="nofollow">前言</a></li><li><ul><li><a href="#_6" rel="nofollow">前置知识</a></li></ul> 
   </li><li><a href="#C11stdfunction_12" rel="nofollow">C++11，借助std::function</a></li><li><a href="#C14YY_Combinator_30" rel="nofollow">C++14，基于Y不动点组合子（Y Combinator）</a></li><li><ul><li><a href="#_32" rel="nofollow">科里化</a></li><li><a href="#_46" rel="nofollow">直接传入</a></li><li><a href="#_61" rel="nofollow">打包</a></li><li><a href="#_112" rel="nofollow">关于返回值推断</a></li></ul> 
   </li><li><a href="#C23_Deducing_thislambda_142" rel="nofollow">C++23 借助Deducing this实现lambda递归</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="_1"></a>前言</h3> 
<p>众所周知，C++11起出现了 <a href="https://zh.cppreference.com/w/cpp/language/lambda" rel="nofollow">lambda表达式</a> ，或者叫闭包，使得C++函数式编程的实现更为容易。本文不对lambda表达式的历史意义以及工程意义做过多探讨，只是给大家介绍一下如何递归调用lambda表达式。<strong>关于lambda表达式的基本用法，敬请移步 <a href="https://zh.cppreference.com/w/cpp/language/lambda" rel="nofollow">cppreference</a>或相关博客</strong>，本文默认读者具有最基本的lambda语法认识。</p> 
<p>我们知道，倘若直接如同普通函数一般在函数体内尝试递归调用是会语法错误的，无论是采用引用捕获亦或是值捕获都无法完成，此处不做赘述。因此我们需要借助别的东西来实现递归调用。<br> <img src="https://images2.imgbox.com/e2/43/fYuEmuaj_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_6"></a>前置知识</h4> 
<p>阅读本文，你需要有：</p> 
<ul><li>相当基本的C++语法基础</li><li>十分基本的C++ lambda表达式语法基础</li><li>非常基本的递归函数认识</li><li>最为基本的中文基础</li></ul> 
<h3><a id="C11stdfunction_12"></a>C++11，借助std::function</h3> 
<p>以斐波那契数列为例，我们可以使用lambda表达式来构造一个 std::function 对象，如同这样：</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;functional&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	std<span class="token double-colon punctuation">::</span>function<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> fib <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span>fib<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> n <span class="token operator">&lt;</span> <span class="token number">2</span> <span class="token operator">?</span> n <span class="token operator">:</span> <span class="token function">fib</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">fib</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
	std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token function">fib</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/23/33/Sm8XUldn_o.png" alt="在这里插入图片描述"><br> 不过很显然，这种方法从声明形式上来看并不是那么优雅，从书写形式上来看，右边lambda写了一遍的函数签名左边还要照抄一遍，过于繁琐与丑陋。此外，用闭包去初始化std::function对象，本质上并没有解决lambda递归调用的问题，只是规避了这个问题而已，反而引入了许多新的问题，它并不是零开销抽象的。另外他还有一些功能上的残缺，比如我们尝试实现一个尾递归调用的斐波那契数列：</p> 
<p><img src="https://images2.imgbox.com/8e/3d/Uih8jjA3_o.png" alt="在这里插入图片描述"><br> 很显然，对于带有默认参数的lambda表达式，std::function并不能承载其全部功能。</p> 
<h3><a id="C14YY_Combinator_30"></a>C++14，基于Y不动点组合子（Y Combinator）</h3> 
<p>如果读者有基本的lambda演算基础，应该对于“Y不动点组合子”有一些概念，它是用来解决匿名函数的递归调用问题的。</p> 
<h4><a id="_32"></a>科里化</h4> 
<p>具体理论此处不做讲述，直接看代码，相对纯正的FP写法如下，由于我们要做科里化，传递lambda表达式，此处使用了来自C++14的泛型lambda，即支持在lambda表达式的参数列表中使用auto：</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">auto</span> T <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">auto</span> x<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">auto</span> y<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> <span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">auto</span> z<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token keyword">return</span> <span class="token function">x</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">(</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> X <span class="token operator">=</span> <span class="token function">T</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> fib <span class="token operator">=</span> <span class="token function">X</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">auto</span> f<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">auto</span> n<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token keyword">int</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> n <span class="token operator">&lt;</span> <span class="token number">2</span> <span class="token operator">?</span> n <span class="token operator">:</span> <span class="token function">f</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">f</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token function">fib</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/34/36/2Jc7PYMl_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_46"></a>直接传入</h4> 
<p>这样看起来比较繁琐，我们可以这样简化：</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">auto</span> fib <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;&amp;</span> self<span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">,</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">int</span> num1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">int</span> num2 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;=</span> n<span class="token punctuation">)</span> <span class="token keyword">return</span> num1<span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token function">self</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> n<span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> num2<span class="token punctuation">,</span> num1 <span class="token operator">+</span> num2<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
	std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token function">fib</span><span class="token punctuation">(</span>fib<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/57/05/bpZCrBHQ_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_61"></a>打包</h4> 
<p>区别于使用科里化构造一个构造器，我们这里直接选择接受一个lambda表达式作为参数调用，缺点是每次调用的时候需要将自己传进去，因此我们直接使用另一个lambda或者std::bind打包一下就行了：</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">auto</span> f <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;&amp;</span> self<span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">,</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">int</span> num1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">int</span> num2 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;=</span> n<span class="token punctuation">)</span> <span class="token keyword">return</span> num1<span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token function">self</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> n<span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> num2<span class="token punctuation">,</span> num1 <span class="token operator">+</span> num2<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token keyword">auto</span> fib <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span>f<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> <span class="token function">f</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
	std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token function">fib</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/42/f6/gGHw7rdf_o.png" alt="在这里插入图片描述"></p> 
<p>不过这样实际上有一点不好，就是我们只需要一个fib，但是却多出来了一个f，污染了命名空间，那么如何解决呢？比较容易想到的是直接定义在fib的函数体内部：</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">auto</span> fib <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">auto</span> f <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;&amp;</span> self<span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">,</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">int</span> num1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">int</span> num2 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;=</span> n<span class="token punctuation">)</span> <span class="token keyword">return</span> num1<span class="token punctuation">;</span>
			<span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token function">self</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> n<span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> num2<span class="token punctuation">,</span> num1 <span class="token operator">+</span> num2<span class="token punctuation">)</span><span class="token punctuation">;</span> 
		<span class="token punctuation">}</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token function">f</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
	std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token function">fib</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/c7/5d/Nk8qunhx_o.png" alt="在这里插入图片描述"></p> 
<p>但是这样很显然，我们每调用一次fib，都要重新初始化一次f，如果不考虑编译器优化，将会有肉眼可见的性能开销，因此在这里我们可以使用同样来自C++14的带初始化器的捕获列表，这样f将只会在fib初始化时初始化：</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">auto</span> fib <span class="token operator">=</span> <span class="token punctuation">[</span>
		f <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;&amp;</span> self<span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">,</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">int</span> num1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">int</span> num2 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;=</span> n<span class="token punctuation">)</span> <span class="token keyword">return</span> num1<span class="token punctuation">;</span>
				<span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token function">self</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> n<span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> num2<span class="token punctuation">,</span> num1 <span class="token operator">+</span> num2<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> <span class="token function">f</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
	std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token function">fib</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/b8/11/wDPRX0PT_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_112"></a>关于返回值推断</h4> 
<p>在最后，需要指出的一点是，注意到我在最开始是直接返回的一个三目运算符，而在此处则使用的if - else语句返回，这是为了引出一个问题，即自动推断的返回值问题。<br> 我们将代码改为这样，可以发现发生了一个语法错误：</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">auto</span> fib <span class="token operator">=</span> <span class="token punctuation">[</span>
		f <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;&amp;</span> self<span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">,</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">int</span> num1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">int</span> num2 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">return</span> i <span class="token operator">&gt;=</span> n <span class="token operator">?</span> num1 <span class="token operator">:</span> <span class="token function">self</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> n<span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> num2<span class="token punctuation">,</span> num1 <span class="token operator">+</span> num2<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> <span class="token function">f</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
	std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token function">fib</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/23/11/8wjDkJxk_o.png" alt="在这里插入图片描述"><br> 通过阅读报错可以知道，我们尝试调用self，但是我们并不知道self的返回类型。关于发生这个错误的原因，通俗来描述，就是在知道函数返回值之前便调用了这个函数。搞清楚了原因，解决起来也就很简单了，一种方法是如同上文那样，在调用前返回一个值，这样编译器就能提前推断出返回值，另一种是使用尾后返回值类型：</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">auto</span> fib <span class="token operator">=</span> <span class="token punctuation">[</span>
		f <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;&amp;</span> self<span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">,</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">int</span> num1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">int</span> num2 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token keyword">int</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> i <span class="token operator">&gt;=</span> n <span class="token operator">?</span> num1 <span class="token operator">:</span> <span class="token function">self</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> n<span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> num2<span class="token punctuation">,</span> num1 <span class="token operator">+</span> num2<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> <span class="token function">f</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
	std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token function">fib</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/8b/3a/vMCOs4dq_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="C23_Deducing_thislambda_142"></a>C++23 借助Deducing this实现lambda递归</h3> 
<p>实际上早在2017年的提案<a href="https://wg21.link/p0839r0" rel="nofollow"> p0839r0</a> 就对于简化lambda递归做了努力，他尝试这么做：</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">auto</span> fib <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">self</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">return</span> n<span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token function">self</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">self</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
	std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token function">fib</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>差不多是给lambda起个名字，然而并没有实装。。</p> 
<p>C++23有这样一条提案：<a href="http://open-std.org/JTC1/SC22/WG21/docs/papers/2021/p0847r7.html#recursive-lambdas" rel="nofollow">P0847R7</a>，这条提案实际上并不是为了lambda准备的，但是lambda递归刚好可以利用上。详细内容可以自行查看，这里直接展示用法：<br> <img src="https://images2.imgbox.com/1c/c9/iTfVIucS_o.png" alt="在这里插入图片描述"><br> 可以看到，基本语法是和上面Y不动点组合子的形式类似的，同样是第一个参数接受一个闭包对象，不过调用形式更为美观了。</p> 
<p>借此我们可以直接一行爆栈（雾）<br> <img src="https://images2.imgbox.com/f1/7f/2VvJy8rA_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/098f96a70ccbec3b560e5728fe43b7ab/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">vs2019配置opencv4.6.0</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f85c76e9ae5df6bba3d49dcd8d54a649/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">[Vue warn]: Duplicate keys detected: ‘/‘. This may cause an update error.</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>