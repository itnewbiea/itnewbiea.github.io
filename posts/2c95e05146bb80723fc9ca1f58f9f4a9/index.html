<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【k8s】--insecure-registry详解 ( 访问仓库、https、http) - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【k8s】--insecure-registry详解 ( 访问仓库、https、http)" />
<meta property="og:description" content="文章目录 一、--insecure-registry是什么二、如何使用--insecure-registry三、--insecure-registry的安全风险四、--insecure-registry的替代方案五、总结参考 一、–insecure-registry是什么 --insecure-registry是docker中用来设置与docker registry通信的安全限制的一个参数，如果设置为true或1，意味着Docker将会在与这个registry通信时跨过证书问题，不再验证registry的TLS认证证书，可以忽略证书错误，从而绕过Docker安全机制。
这个描述很奇怪，https一般是服务器端开启的，客户端必须按照Https访问。除非docker服务器端同时开启了https、http，然后客户端默认禁用http，而--insecure-registry 允许本地开启http
这个参数的使用主要是为了方便在开发过程中迅速测试镜像，或者当运行docker的主机不具备安全加密能力的时候，可以选择打开这个开关。
在正式的生产环境中，一般情况下禁用这个选项，因为这个选项的打开为我们的系统带来很大的安全隐患。
二、如何使用–insecure-registry 使用–insecure-registry，我们可以在运行docker命令时添加这个参数。
docker run --rm --insecure-registry registry.local:5000 busybox 在上面的命令中，我们通过--insecure-registry参数指定了registry的地址为registry.local:5000，这意味着docker将会忽略registry.local:5000的SSL证书认证。
在Docker 1.13.1及之后的版本中，可以使用以下的方式来配置–insecure-registry的默认值：
{ &#34;insecure-registries&#34; : [&#34;registry.local:5000&#34;] } 这个配置文件需要保存为 /etc/docker/daemon.json。
需要注意的是，在Windows操作系统中，这个配置文件需要在C:\ProgramData\Docker\config目录下创建。
记得使用 service docker restart 重启docker服务
上述方法只能对单个服务器生效，如果想对所有的生效，可以使用 “insecure-registries” : [ “0.0.0.0/0” ] 三、–insecure-registry的安全风险 虽然使用--insecure-registry参数可以帮助我们快速测试镜像，但是打开这个选项也带来了很大的安全风险。
当我们忽略SSL证书时，意味着所有与该registry通信的数据都是明文传输，容易受到中间人攻击。黑客可以通过在通信过程中截取传输的数据，来获取敏感信息或者篡改数据。
同时，如果registry服务器本身被黑客攻击，会助长黑客利用中间人攻击的可能性，可以通过域名欺骗等方式进行攻击。
四、–insecure-registry的替代方案 如果我们有必要经常使用–insecure-registry，可以选择使用内部CA证书，将证书写入docker TLS认证证书池中，实现相对的安全性。这个过程需要创建自签名证书来为docker registry签名。
下面是一个创建自签名证书的例子：
openssl genrsa -out key.pem 2048 openssl req -new -key key.pem -out csr.pem openssl x509 -req -in csr.pem -signkey key.pem -out cert.crt 执行完上面的命令，会生成三个文件：key." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/2c95e05146bb80723fc9ca1f58f9f4a9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-15T17:20:40+08:00" />
<meta property="article:modified_time" content="2023-12-15T17:20:40+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【k8s】--insecure-registry详解 ( 访问仓库、https、http)</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#insecureregistry_1" rel="nofollow">一、--insecure-registry是什么</a></li><li><a href="#insecureregistry_10" rel="nofollow">二、如何使用--insecure-registry</a></li><li><a href="#insecureregistry_34" rel="nofollow">三、--insecure-registry的安全风险</a></li><li><a href="#insecureregistry_41" rel="nofollow">四、--insecure-registry的替代方案</a></li><li><a href="#_61" rel="nofollow">五、总结</a></li><li><a href="#_67" rel="nofollow">参考</a></li></ul> 
</div> 
<p></p> 
<h2><a id="insecureregistry_1"></a>一、–insecure-registry是什么</h2> 
<p><code>--insecure-registry</code>是docker中用来设置与docker registry通信的安全限制的一个参数，如果设置为true或1，意味着Docker将会在与这个registry通信时跨过证书问题，不再验证registry的TLS认证证书，可以忽略证书错误，从而绕过Docker安全机制。</p> 
<blockquote> 
 <p>这个描述很奇怪，https一般是服务器端开启的，客户端必须按照Https访问。除非docker服务器端同时开启了https、http，然后客户端默认禁用http，而<code>--insecure-registry</code> 允许本地开启http</p> 
</blockquote> 
<p>这个参数的使用主要是为了方便在开发过程中迅速测试镜像，或者当运行docker的主机不具备安全加密能力的时候，可以选择打开这个开关。</p> 
<p>在正式的生产环境中，一般情况下禁用这个选项，因为这个选项的打开为我们的系统带来很大的安全隐患。</p> 
<h2><a id="insecureregistry_10"></a>二、如何使用–insecure-registry</h2> 
<p>使用–insecure-registry，我们可以在运行docker命令时添加这个参数。</p> 
<pre><code class="prism language-bash"><span class="token function">docker</span> run <span class="token parameter variable">--rm</span> --insecure-registry registry.local:5000 busybox
</code></pre> 
<p>在上面的命令中，我们通过<code>--insecure-registry</code>参数指定了registry的地址为registry.local:5000，这意味着docker将会忽略registry.local:5000的SSL证书认证。</p> 
<p>在Docker 1.13.1及之后的版本中，可以使用以下的方式来配置–insecure-registry的默认值：</p> 
<pre><code class="prism language-bash"><span class="token punctuation">{<!-- --></span>
  <span class="token string">"insecure-registries"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">"registry.local:5000"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这个配置文件需要保存为 <code>/etc/docker/daemon.json</code>。</p> 
<p>需要注意的是，在Windows操作系统中，这个配置文件需要在C:\ProgramData\Docker\config目录下创建。</p> 
<p>记得使用 <code>service docker restart</code> 重启docker服务</p> 
<p><font color="blue">上述方法只能对单个服务器生效，如果想对所有的生效，可以使用 “insecure-registries” : [ “0.0.0.0/0” ] </font></p> 
<h2><a id="insecureregistry_34"></a>三、–insecure-registry的安全风险</h2> 
<p>虽然使用<code>--insecure-registry</code>参数可以帮助我们快速测试镜像，但是打开这个选项也带来了很大的安全风险。</p> 
<p>当我们忽略SSL证书时，意味着所有与该registry通信的数据都是明文传输，容易受到中间人攻击。黑客可以通过在通信过程中截取传输的数据，来获取敏感信息或者篡改数据。</p> 
<p>同时，如果registry服务器本身被黑客攻击，会助长黑客利用中间人攻击的可能性，可以通过域名欺骗等方式进行攻击。</p> 
<h2><a id="insecureregistry_41"></a>四、–insecure-registry的替代方案</h2> 
<p>如果我们有必要经常使用–insecure-registry，可以选择使用内部CA证书，将证书写入docker TLS认证证书池中，实现相对的安全性。这个过程需要创建自签名证书来为docker registry签名。</p> 
<p>下面是一个创建自签名证书的例子：</p> 
<pre><code class="prism language-bash">openssl genrsa <span class="token parameter variable">-out</span> key.pem <span class="token number">2048</span>
openssl req <span class="token parameter variable">-new</span> <span class="token parameter variable">-key</span> key.pem <span class="token parameter variable">-out</span> csr.pem
openssl x509 <span class="token parameter variable">-req</span> <span class="token parameter variable">-in</span> csr.pem <span class="token parameter variable">-signkey</span> key.pem <span class="token parameter variable">-out</span> cert.crt
</code></pre> 
<p>执行完上面的命令，会生成三个文件：key.pem、csr.pem、cert.crt，其中cert.crt就是我们创建的自签名证书。我们将cert.crt拷贝到所有需要访问registry的docker客户端主机上，然后重新启动docker服务。</p> 
<p>当我们在运行docker命令时，可以使用–tlsverify参数打开docker TLS验证。我们可以将上面生成的key.pem，csr.pem，cert.crt放在服务器的某个目录中，然后使用以下命令启动docker：</p> 
<pre><code class="prism language-bash"><span class="token function">docker</span> <span class="token parameter variable">--tlsverify</span> <span class="token parameter variable">--tlscacert</span><span class="token operator">=</span>/path/to/ca.pem <span class="token parameter variable">--tlscert</span><span class="token operator">=</span>/path/to/cert.pem <span class="token parameter variable">--tlskey</span><span class="token operator">=</span>/path/to/key.pem <span class="token parameter variable">-H</span><span class="token operator">=</span><span class="token number">127.0</span>.0.1:5555 version
</code></pre> 
<p>通过使用–tlsverify参数，在与registry通信时，Docker将会验证认证证书的有效性，实现了更高的安全性。</p> 
<h2><a id="_61"></a>五、总结</h2> 
<p>–insecure-registry是Docker中用来临时绕过TLS认证证书认证的参数，可以在开发、测试过程中节省时间和精力。但是在生产环境中，为了保证系统的安全性，我们需要关闭这个参数。</p> 
<p>如果确实有必要经常使用这个参数，我们可以选择使用内部CA证书来实现相对的安全性。</p> 
<p>在使用–insecure-registry时，我们需要时刻注意安全风险，并采取相应的防范措施。</p> 
<h2><a id="_67"></a>参考</h2> 
<p><a href="https://www.python100.com/html/81354.html" rel="nofollow">–insecure-registry详解</a></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e224ed8bce6e5dab970df7d6fa87250d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【C&#43;&#43;精品题目速刷】双指针</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7e60832a3dc3d9bfd02469e863cec104/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">注解 @Resource 与 @Autowired 比较</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>