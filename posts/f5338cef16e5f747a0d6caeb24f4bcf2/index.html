<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【Paper】复现VideoMAE - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【Paper】复现VideoMAE" />
<meta property="og:description" content="复现VideoMAE 论文信息环境准备数据集准备Kinetics 400（152GB，不推荐）Something-Something-V2（19.4GB）UCF101 （约6.5GB） 论文信息 论文全名VideoMAE: Masked Autoencoders are Data-Efficient Learners for Self-Supervised Video Pre-Training
发表在NeurIPS 2022
论文链接 https://arxiv.org/abs/2203.12602v3
论文官方代码https://github.com/MCG-NJU/VideoMAE
paperwithcode链接https://paperswithcode.com/paper/videomae-masked-autoencoders-are-data-1
他们还在CVPR 2023上发表了最新的VideoMAE V2: Scaling Video Masked Autoencoders with Dual Masking，如果有时间我也会复现
环境准备 Python 3.6 or higher
PyTorch and torchvision.
We can successfully reproduce the main results under two settings below:
Tesla A100 (40G): CUDA 11.1 &#43; PyTorch 1.8.0 &#43; torchvision 0.9.0
Tesla V100 (32G): CUDA 10.1 &#43; PyTorch 1.6.0 &#43; torchvision 0." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/f5338cef16e5f747a0d6caeb24f4bcf2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-27T14:51:53+08:00" />
<meta property="article:modified_time" content="2023-06-27T14:51:53+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【Paper】复现VideoMAE</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>复现VideoMAE</h4> 
 <ul><li><a href="#_2" rel="nofollow">论文信息</a></li><li><a href="#_15" rel="nofollow">环境准备</a></li><li><a href="#_57" rel="nofollow">数据集准备</a></li><li><ul><li><a href="#Kinetics_400152GB_58" rel="nofollow">Kinetics 400（152GB，不推荐）</a></li><li><a href="#SomethingSomethingV2194GB_65" rel="nofollow">Something-Something-V2（19.4GB）</a></li><li><a href="#UCF101_65GB_135" rel="nofollow">UCF101 （约6.5GB）</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_2"></a>论文信息</h2> 
<p>论文全名VideoMAE: Masked Autoencoders are Data-Efficient Learners for Self-Supervised Video Pre-Training</p> 
<p>发表在NeurIPS 2022</p> 
<p>论文链接 <a href="https://arxiv.org/abs/2203.12602v3" rel="nofollow">https://arxiv.org/abs/2203.12602v3</a></p> 
<p>论文官方代码<a href="https://github.com/MCG-NJU/VideoMAE">https://github.com/MCG-NJU/VideoMAE</a></p> 
<p>paperwithcode链接<a href="https://paperswithcode.com/paper/videomae-masked-autoencoders-are-data-1" rel="nofollow">https://paperswithcode.com/paper/videomae-masked-autoencoders-are-data-1</a></p> 
<p>他们还在CVPR 2023上发表了最新的<a href="https://paperswithcode.com/paper/videomae-v2-scaling-video-masked-autoencoders" rel="nofollow">VideoMAE V2: Scaling Video Masked Autoencoders with Dual Masking</a>，如果有时间我也会复现</p> 
<h2><a id="_15"></a>环境准备</h2> 
<p>Python 3.6 or higher</p> 
<p>PyTorch and torchvision.<br> We can successfully reproduce the main results under two settings below:<br> Tesla A100 (40G): CUDA 11.1 + PyTorch 1.8.0 + torchvision 0.9.0<br> Tesla V100 (32G): CUDA 10.1 + PyTorch 1.6.0 + torchvision 0.7.0</p> 
<p>timm==0.4.8/0.4.12</p> 
<p>deepspeed==0.5.8</p> 
<pre><code class="prism language-cpp">DS_BUILD_OPS<span class="token operator">=</span><span class="token number">1</span> pip install deepspeed
</code></pre> 
<p>TensorboardX</p> 
<p>decord</p> 
<p>einops</p> 
<pre><code class="prism language-cpp">conda create <span class="token operator">-</span>n mae python<span class="token operator">=</span><span class="token number">3.9</span>

conda activate mae

conda install pytorch<span class="token operator">==</span><span class="token number">1.12</span><span class="token punctuation">.</span><span class="token number">1</span> torchvision<span class="token operator">==</span><span class="token number">0.13</span><span class="token punctuation">.</span><span class="token number">1</span> torchaudio<span class="token operator">==</span><span class="token number">0.12</span><span class="token punctuation">.</span><span class="token number">1</span> cudatoolkit<span class="token operator">=</span><span class="token number">11.3</span> <span class="token operator">-</span>c pytorch

pip install timm<span class="token operator">==</span><span class="token number">0.4</span><span class="token punctuation">.</span><span class="token number">8</span>

pip install deepspeed<span class="token operator">==</span><span class="token number">0.5</span><span class="token punctuation">.</span><span class="token number">8</span>

pip install TensorboardX

pip install decord 

pip install einops

</code></pre> 
<p>后面几个几乎都只能pip install而不能conda install</p> 
<h2><a id="_57"></a>数据集准备</h2> 
<h3><a id="Kinetics_400152GB_58"></a>Kinetics 400（152GB，不推荐）</h3> 
<p>这里有处理好（视频短边为320px）的K400数据集下载，但需要注册登录按着这个操作<a href="https://opendatalab.com/Kinetics-400/cli" rel="nofollow">https://opendatalab.com/Kinetics-400/cli</a></p> 
<p>官网<a href="https://www.deepmind.com/open-source/kinetics" rel="nofollow">https://www.deepmind.com/open-source/kinetics</a></p> 
<h3><a id="SomethingSomethingV2194GB_65"></a>Something-Something-V2（19.4GB）</h3> 
<p>官网链接<a href="https://developer.qualcomm.com/software/ai-datasets/something-something" rel="nofollow">https://developer.qualcomm.com/software/ai-datasets/something-something</a></p> 
<p>或者pan <a href="https://pan.baidu.com/s/1c1AQn29jLJkJt4CzbrVmsQ" rel="nofollow">https://pan.baidu.com/s/1c1AQn29jLJkJt4CzbrVmsQ</a> ，提取码6666</p> 
<p>数据集下载后的解压参考<a href="https://blog.csdn.net/weixin_43759637/article/details/131351983">https://blog.csdn.net/weixin_43759637/article/details/131351983</a></p> 
<p>通过将视频扩展名从webm更改为.mp4（原始高度为240px）来预处理数据集，预处理可以参考<a href="https://github.com/MCG-NJU/VideoMAE/issues/62">https://github.com/MCG-NJU/VideoMAE/issues/62</a>，我这里运行失败了，而且<a href="https://github.com/MCG-NJU/VideoMAE/issues?page=3&amp;q=is:issue%20is:closed">https://github.com/MCG-NJU/VideoMAE/issues?page=3&amp;q=is%3Aissue+is%3Aclosed</a>中说的预处理脚本也没了，所以我自己写了个预处理脚本</p> 
<p>生成数据加载器所需的注释（注释中的“&lt;path_to_video&gt;&lt;video_class&gt;”）。注释通常包括train.csv、val.csv和test.csv（此处test.csv与val.csv相同）。<br> train.csv、val.csv和test.csv下载：<br> <a href="https://drive.google.com/drive/folders/1cfA-SrPhDB9B8ZckPvnh8D5ysCjD-S_I?usp=share_link" rel="nofollow">https://drive.google.com/drive/folders/1cfA-SrPhDB9B8ZckPvnh8D5ysCjD-S_I?usp=share_link</a><br> w我自己写的预处理代码</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> argparse
<span class="token keyword">import</span> moviepy<span class="token punctuation">.</span>editor <span class="token keyword">as</span> mp


<span class="token keyword">def</span> <span class="token function">resize_and_convert_video</span><span class="token punctuation">(</span>input_file<span class="token punctuation">,</span> output_file<span class="token punctuation">,</span> target_short_edge<span class="token operator">=</span><span class="token number">320</span><span class="token punctuation">,</span> output_format<span class="token operator">=</span><span class="token string">'mp4'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 读取输入视频</span>
    video <span class="token operator">=</span> mp<span class="token punctuation">.</span>VideoFileClip<span class="token punctuation">(</span>input_file<span class="token punctuation">)</span>
    
    <span class="token comment"># 计算长边和短边的缩放比例</span>
    width<span class="token punctuation">,</span> height <span class="token operator">=</span> video<span class="token punctuation">.</span>size
    <span class="token keyword">if</span> width <span class="token operator">&gt;</span> height<span class="token punctuation">:</span>
        new_width <span class="token operator">=</span> target_short_edge
        new_height <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>height <span class="token operator">*</span> <span class="token punctuation">(</span>target_short_edge <span class="token operator">/</span> width<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        new_height <span class="token operator">=</span> target_short_edge
        new_width <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>width <span class="token operator">*</span> <span class="token punctuation">(</span>target_short_edge <span class="token operator">/</span> height<span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 调整视频尺寸</span>
    resized_video <span class="token operator">=</span> video<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>height<span class="token operator">=</span>new_height<span class="token punctuation">,</span> width<span class="token operator">=</span>new_width<span class="token punctuation">)</span>
    
    <span class="token comment"># 转换视频格式并保存</span>
    output_file_path<span class="token punctuation">,</span> _ <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>splitext<span class="token punctuation">(</span>output_file<span class="token punctuation">)</span>
    output_file_path <span class="token operator">+=</span> <span class="token string-interpolation"><span class="token string">f'.</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>output_format<span class="token punctuation">}</span></span><span class="token string">'</span></span>
    resized_video<span class="token punctuation">.</span>write_videofile<span class="token punctuation">(</span>output_file_path<span class="token punctuation">,</span> codec<span class="token operator">=</span><span class="token string">'libx264'</span><span class="token punctuation">,</span> audio_codec<span class="token operator">=</span><span class="token string">'aac'</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span>description<span class="token operator">=</span><span class="token string">'Resize and convert videos in a directory'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'input_dir'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'input directory containing webm videos'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'output_dir'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'output directory for resized and converted videos'</span><span class="token punctuation">)</span>
    args <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 创建输出目录</span>
    os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>args<span class="token punctuation">.</span>output_dir<span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token comment"># 遍历输入目录中的所有webm文件</span>
    <span class="token keyword">for</span> file_name <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>args<span class="token punctuation">.</span>input_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> file_name<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">'.webm'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># 构建输入和输出文件路径</span>
            input_file <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>args<span class="token punctuation">.</span>input_dir<span class="token punctuation">,</span> file_name<span class="token punctuation">)</span>
            output_file <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>args<span class="token punctuation">.</span>output_dir<span class="token punctuation">,</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>splitext<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'.mp4'</span><span class="token punctuation">)</span>

            <span class="token comment"># 调整尺寸并转换格式</span>
            resize_and_convert_video<span class="token punctuation">(</span>input_file<span class="token punctuation">,</span> output_file<span class="token punctuation">,</span> target_short_edge<span class="token operator">=</span><span class="token number">320</span><span class="token punctuation">,</span> output_format<span class="token operator">=</span><span class="token string">'mp4'</span><span class="token punctuation">)</span>

</code></pre> 
<pre><code class="prism language-python">python resize_convert_videos<span class="token punctuation">.</span>py input_dir output_dir

</code></pre> 
<h3><a id="UCF101_65GB_135"></a>UCF101 （约6.5GB）</h3> 
<p>官网链接<a href="https://www.crcv.ucf.edu/data/UCF101.php" rel="nofollow">https://www.crcv.ucf.edu/data/UCF101.php</a></p> 
<p>具体可以参考<a href="https://blog.csdn.net/lidc1004/article/details/117195260#%E6%95%B0%E6%8D%AE%E9%9B%86%E8%8E%B7%E5%8F%96%E5%8F%8A%E8%A7%A3%E5%8E%8B%E7%BC%A9">UCF101动作识别数据集简介绍及数据预处理</a></p> 
<p><a href="https://www.jianshu.com/p/cd4500041acf" rel="nofollow">视频数据集UCF101的处理与加载</a></p> 
<p>无需对UCF101进行其他预处理操作<a href="https://github.com/MCG-NJU/VideoMAE/issues/35">https://github.com/MCG-NJU/VideoMAE/issues/35</a> <a href="https://github.com/MCG-NJU/VideoMAE/issues/69">https://github.com/MCG-NJU/VideoMAE/issues/69</a></p> 
<p>但是要划分数据集，作者没有给出数据集如何划分<a href="https://github.com/MCG-NJU/VideoMAE/issues/35">https://github.com/MCG-NJU/VideoMAE/issues/35</a></p> 
<p>checkpoint下载<a href="https://drive.google.com/file/d/1MSyon6fPpKz7oqD6WDGPFK4k_Rbyb6fw/view" rel="nofollow">https://drive.google.com/file/d/1MSyon6fPpKz7oqD6WDGPFK4k_Rbyb6fw/view</a></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a66bef497da75a00ca912a5e4b6d7a2f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Helm 部署</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d9118a75723b4489a6a0157107207819/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">js 根据id取出数组中的对象</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>