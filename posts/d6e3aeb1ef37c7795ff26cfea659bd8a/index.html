<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>onnx报错问题 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="onnx报错问题" />
<meta property="og:description" content="用onnxruntime报错：
onnxruntime.capi.onnxruntime_pybind11_state.InvalidArgument:
[ONNXRuntimeError] : 2 : INVALID_ARGUMENT : Failed to load model with
error: Unknown model file format version.
安装了onnx和onnxruntime之后还是报错，upgrade到最新版本还是报错。
发现是因为之前导出的.onnx模型和现在的版本不匹配，所以需要重新export一下，结果又报下面的错：
ONNX: export failure ❌ 0.0s: Unsupported ONNX opset version: 17
这个是因为opset的版本问题，把export时默认的17改成11就可以了。
python3 export.py --include onnx --weight /root/yolov5/runs/train-cls/exp4/weights/best.pt --opset 11 另外记得export的时候要指定imgsz，不然就是默认的640，之后用的时候就要匹配。
我没有原始pt文件，我只有onnx文件，所以没办法重新export，运行报错：
onnxruntime.capi.onnxruntime_pybind11_state.InvalidGraph: [ONNXRuntimeError] : 10 : INVALID_GRAPH : This is an invalid model. Error in Node:Identity_0 : No Op registered for Identity with domain_version of 13
可以通过下面的代码查看支持的opset version" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/d6e3aeb1ef37c7795ff26cfea659bd8a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-13T10:39:55+08:00" />
<meta property="article:modified_time" content="2023-04-13T10:39:55+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">onnx报错问题</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>用<code>onnxruntime</code>报错：</p> 
<blockquote> 
 <p>onnxruntime.capi.onnxruntime_pybind11_state.InvalidArgument:<br> [ONNXRuntimeError] : 2 : INVALID_ARGUMENT : Failed to load model with<br> error: Unknown model file format version.</p> 
</blockquote> 
<p>安装了<code>onnx</code>和<code>onnxruntime</code>之后还是报错，upgrade到最新版本还是报错。<br> 发现是因为之前导出的<code>.onnx</code>模型和现在的版本不匹配，所以需要重新export一下，结果又报下面的错：</p> 
<blockquote> 
 <p>ONNX: export failure ❌ 0.0s: Unsupported ONNX opset version: 17</p> 
</blockquote> 
<p>这个是因为opset的版本问题，把export时默认的17改成11就可以了。</p> 
<pre><code class="prism language-python">python3 export<span class="token punctuation">.</span>py <span class="token operator">-</span><span class="token operator">-</span>include onnx <span class="token operator">-</span><span class="token operator">-</span>weight <span class="token operator">/</span>root<span class="token operator">/</span>yolov5<span class="token operator">/</span>runs<span class="token operator">/</span>train<span class="token operator">-</span>cls<span class="token operator">/</span>exp4<span class="token operator">/</span>weights<span class="token operator">/</span>best<span class="token punctuation">.</span>pt <span class="token operator">-</span><span class="token operator">-</span>opset <span class="token number">11</span>
</code></pre> 
<p>另外记得export的时候要指定imgsz，不然就是默认的640，之后用的时候就要匹配。</p> 
<p>我没有原始pt文件，我只有onnx文件，所以没办法重新export，运行报错：</p> 
<blockquote> 
 <p>onnxruntime.capi.onnxruntime_pybind11_state.InvalidGraph: [ONNXRuntimeError] : 10 : INVALID_GRAPH : This is an invalid model. Error in Node:Identity_0 : No Op registered for Identity with domain_version of 13</p> 
</blockquote> 
<p>可以通过下面的代码查看支持的opset version</p> 
<pre><code class="prism language-python">python
<span class="token keyword">import</span> onnxruntime
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Supported onnxruntime version: "</span><span class="token punctuation">,</span> onnxruntime<span class="token punctuation">.</span>__version__<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Supported Opset versions: "</span><span class="token punctuation">,</span> onnxruntime<span class="token punctuation">.</span>get_available_providers<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>显示支持但就是不行，就卸载重装，可能是安装位置之类的问题</p> 
<pre><code class="prism language-python">pip uninstall onnxruntime
pip install <span class="token operator">-</span>i https<span class="token punctuation">:</span><span class="token operator">//</span>pypi<span class="token punctuation">.</span>tuna<span class="token punctuation">.</span>tsinghua<span class="token punctuation">.</span>edu<span class="token punctuation">.</span>cn<span class="token operator">/</span>simple onnxruntime
</code></pre> 
<p>安装完显示只支持cpu，不支持cuda，但是onnxruntime-gpu明明装了的，一样的，卸载重装：</p> 
<pre><code class="prism language-python">pip uninstall onnxruntime<span class="token operator">-</span>gpu
pip install <span class="token operator">-</span>i https<span class="token punctuation">:</span><span class="token operator">//</span>pypi<span class="token punctuation">.</span>tuna<span class="token punctuation">.</span>tsinghua<span class="token punctuation">.</span>edu<span class="token punctuation">.</span>cn<span class="token operator">/</span>simple onnxruntime<span class="token operator">-</span>gpu
</code></pre>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/31c6c0b541e318a65c7fb9f27fa46d61/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Linux 开启防火墙和指定端口</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/19c17f325614377a32d55f283ee2339d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">前端rem适配(自适应布局)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>