<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>springboot&#43;cas5.x&#43;shiro&#43;pac4j实现sso集成(一) - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="springboot&#43;cas5.x&#43;shiro&#43;pac4j实现sso集成(一)" />
<meta property="og:description" content="先说下项目背景，公司的项目原来用的kisso&#43;shiro，但是kisso太小众了，性能各方面也不满足要求，所以老大要更换springboot&#43;cas&#43;shiro&#43;pac4j集成，楼主在资料极少的情况下弄了很久还是没配置好shiro&#43;pac4j，项目老大奋斗到深夜给解决了，所以写一篇博客造福小白了！
首先下载cas，下载5以上的版本 https://github.com/apereo/cas-overlay-template
编译 解压zip，命令行进去，执行mvn clean package 结束之后会出现 target 文件夹，里面有war包啥的，把war包解压，比如我们把解压后的文件夹命名为 cas_war 吧，后文提到 cas_war 就代表是这个文件夹
本地配置tomcat通过https访问 注意以下所有命令除了文件路径最好都跟我的保持一致，比如alias，就用tomcat不要换别的，省的小白出问题 命令行里cd进入%JAVA_HOME%/bin目录，配置了环境变量就不用了
1.执行：
keytool -genkeypair -alias &#34;tomcat&#34; -keyalg &#34;RSA&#34; -keystore &#34;E:\projects\hugeo\cas\tomcat.keystore&#34; 按照以下输入：
密钥库口令:123456（这个密码非常重要） 名字与姓氏:www.hugeo.com（域名很重要，建议自己编个域名，在host文件里写好映射，host的使用百度吧） 组织单位名称:anything（随便填） 组织名称:anything（随便填） 城市:anything（随便填） 省市自治区:anything（随便填） 国家地区代码:anything（随便填） 现在E:\projects\hugeo\cas\tomcat.keystore这个文件生成了
2.继续执行：
keytool -export -file E:\projects\hugeo\cas\cas.crt -keystore E:\projects\hugeo\cas\tomcat.keystore -alias tomcat 用刚刚的tomcat.keystore文件生成了cas.crt文件
3.导入授权文件到jdk并设置密码：
keytool -import -file E:\projects\hugeo\cas\cas.crt -alias tomcat -keystore E:\programFiles\Java\jre1.8.0_131\lib\security\cacerts -storepass 123456 注意-storepass 123456是设置此步骤的密码的，第一次执行命令设置之后以后再执行这个命令就不要带这个参数了，然后输入密码的时候输第一次设置的密码，这个密码和生成keystore的密码可以不一样，设置成一样的比较方便防止搞混
要删除也很容易： keytool -delete -alias tomcat -keystore E:\programFiles\Java\jre1.8.0_131\lib\security\cacerts
(如果导入的时候没有设置别名就再导入一次，会显示别名)
5.修改tomcat的配置文件server.xml
删掉：
&lt;Connector port=&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/3c0a610b143756604e532f7fef3b191e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-05-17T17:31:10+08:00" />
<meta property="article:modified_time" content="2018-05-17T17:31:10+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">springboot&#43;cas5.x&#43;shiro&#43;pac4j实现sso集成(一)</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>先说下项目背景，公司的项目原来用的kisso+shiro，但是kisso太小众了，性能各方面也不满足要求，所以老大要更换springboot+cas+shiro+pac4j集成，楼主在资料极少的情况下弄了很久还是没配置好shiro+pac4j，项目老大奋斗到深夜给解决了，所以写一篇博客造福小白了！</p> 
<p>首先下载cas，下载5以上的版本 <a href="https://github.com/apereo/cas-overlay-template">https://github.com/apereo/cas-overlay-template</a></p> 
<p> </p> 
<h2>编译</h2> 
<p>解压zip，命令行进去，执行<code>mvn clean package</code> <br> 结束之后会出现 <strong>target</strong> 文件夹，里面有war包啥的，把war包解压，比如我们把解压后的文件夹命名为 <strong>cas_war</strong> 吧，后文提到 <strong>cas_war</strong> 就代表是这个文件夹</p> 
<h2>本地配置tomcat通过https访问</h2> 
<p><strong>注意以下所有命令除了文件路径最好都跟我的保持一致，比如alias，就用tomcat不要换别的，省的小白出问题</strong> <br> 命令行里cd进入%JAVA_HOME%/bin目录，配置了环境变量就不用了</p> 
<p>1.执行：</p> 
<p><code>keytool -genkeypair -alias "tomcat" -keyalg "RSA" -keystore "E:\projects\hugeo\cas\tomcat.keystore"</code> <br> 按照以下输入：</p> 
<pre class="prettyprint"><code>密钥库口令:123456（这个密码非常重要）
名字与姓氏:www.hugeo.com（域名很重要，建议自己编个域名，在host文件里写好映射，host的使用百度吧）
组织单位名称:anything（随便填）
组织名称:anything（随便填）
城市:anything（随便填）
省市自治区:anything（随便填）
国家地区代码:anything（随便填）</code></pre> 
<p>现在E:\projects\hugeo\cas\tomcat.keystore这个文件生成了</p> 
<p>2.继续执行：</p> 
<p><code>keytool -export -file E:\projects\hugeo\cas\cas.crt -keystore E:\projects\hugeo\cas\tomcat.keystore -alias tomcat</code> <br> 用刚刚的tomcat.keystore文件生成了cas.crt文件</p> 
<p>3.导入授权文件到jdk并设置密码：</p> 
<p><code>keytool -import -file E:\projects\hugeo\cas\cas.crt -alias tomcat -keystore E:\programFiles\Java\jre1.8.0_131\lib\security\cacerts -storepass 123456</code> <br><strong>注意-storepass 123456是设置此步骤的密码的，第一次执行命令设置之后以后再执行这个命令就不要带这个参数了，然后输入密码的时候输第一次设置的密码，这个密码和生成keystore的密码可以不一样，设置成一样的比较方便防止搞混</strong></p> 
<p>要删除也很容易： <br><code>keytool -delete -alias tomcat -keystore E:\programFiles\Java\jre1.8.0_131\lib\security\cacerts</code></p> 
<p>(如果导入的时候没有设置别名就再导入一次，会显示别名)</p> 
<p>5.修改tomcat的配置文件server.xml</p> 
<p>删掉：</p> 
<pre class="prettyprint"><code>&lt;Connector port="8080" protocol="HTTP/1.1"
               connectionTimeout="20000"
               redirectPort="8443" /&gt;</code></pre> 
<p>添加：</p> 
<pre class="prettyprint"><code>&lt;Connector
           protocol="org.apache.coyote.http11.Http11NioProtocol"
           port="8443" maxThreads="200"
           scheme="https" secure="true" SSLEnabled="true"
           keystoreFile="E:\projects\learn\cas\tomcat.keystore" keystorePass="123456"
           clientAuth="false" sslProtocol="TLS"/&gt;</code></pre> 
<p>6.把crt文件导入浏览器，我用的是chrome</p> 
<p><img alt="这里写图片描述" class="has" src="https://images2.imgbox.com/28/02/GAgxyOSL_o.png"><br><img alt="这里写图片描述" class="has" src="https://images2.imgbox.com/b7/65/rYtKBVqN_o.png"><br> 把第二步生成的crt文件导进去进行了</p> 
<p>7. 检查配置</p> 
<p>把 <strong>cas_war</strong> 放到tomcat的webapp下面改名为cas，启动tomcat，浏览器访问<a href="https://www.hugeo.com:8443/cas/login" rel="nofollow">https://www.hugeo.com:8443/cas/login</a>，如果提示签名不正确之类的就点击高级/详细信息，继续访问。</p> 
<p>8.注意</p> 
<p>大部分情况下本地开发是不需要ssl访问的，所以建议给cas单独弄个tomcat，反正一个tomcat也就十几兆，我本地开发其他项目时用tomcat8，cas使用的是tomcat9，版本其实也没太大关系，好像是高于tomcat8的版本就可以了</p> 
<h2>建项目</h2> 
<p>用idea新建一个spring boot项目，什么插件都不需要 <br> pom.xml是从第一步下载的zip里的pom文件改造的，最好大概看一下理解一下，需要修改的地方自己改：</p> 
<pre class="prettyprint"><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

    &lt;groupId&gt;com.hugeo&lt;/groupId&gt;
    &lt;artifactId&gt;cas&lt;/artifactId&gt;
    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
    &lt;packaging&gt;war&lt;/packaging&gt;

    &lt;name&gt;cas&lt;/name&gt;
    &lt;description&gt;Demo project for Spring Boot&lt;/description&gt;

    &lt;properties&gt;
        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;
        &lt;project.reporting.outputEncoding&gt;UTF-8&lt;/project.reporting.outputEncoding&gt;
        &lt;java.version&gt;1.8&lt;/java.version&gt;

        &lt;cas.version&gt;5.2.3&lt;/cas.version&gt;
        &lt;app.server&gt;-tomcat&lt;/app.server&gt;

        &lt;mainClassName&gt;org.springframework.boot.loader.WarLauncher&lt;/mainClassName&gt;
        &lt;isExecutable&gt;false&lt;/isExecutable&gt;
        &lt;manifestFileToUse&gt;
            ${project.build.directory}/war/work/org.apereo.cas/cas-server-webapp${app.server}/META-INF/MANIFEST.MF
        &lt;/manifestFileToUse&gt;

        &lt;maven.compiler.source&gt;1.8&lt;/maven.compiler.source&gt;
        &lt;maven.compiler.target&gt;1.8&lt;/maven.compiler.target&gt;
        &lt;springboot.version&gt;2.0.0.RELEASE&lt;/springboot.version&gt;
    &lt;/properties&gt;

    &lt;repositories&gt;
        &lt;repository&gt;
            &lt;id&gt;sonatype-releases&lt;/id&gt;
            &lt;url&gt;http://oss.sonatype.org/content/repositories/releases/&lt;/url&gt;
            &lt;snapshots&gt;
                &lt;enabled&gt;false&lt;/enabled&gt;
            &lt;/snapshots&gt;
            &lt;releases&gt;
                &lt;enabled&gt;true&lt;/enabled&gt;
            &lt;/releases&gt;
        &lt;/repository&gt;
        &lt;repository&gt;
            &lt;id&gt;sonatype-snapshots&lt;/id&gt;
            &lt;url&gt;https://oss.sonatype.org/content/repositories/snapshots/&lt;/url&gt;
            &lt;snapshots&gt;
                &lt;enabled&gt;true&lt;/enabled&gt;
            &lt;/snapshots&gt;
            &lt;releases&gt;
                &lt;enabled&gt;false&lt;/enabled&gt;
            &lt;/releases&gt;
        &lt;/repository&gt;
        &lt;repository&gt;
            &lt;id&gt;shibboleth-releases&lt;/id&gt;
            &lt;url&gt;https://build.shibboleth.net/nexus/content/repositories/releases&lt;/url&gt;
        &lt;/repository&gt;
    &lt;/repositories&gt;

    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
                &lt;version&gt;${springboot.version}&lt;/version&gt;
                &lt;configuration&gt;
                    &lt;mainClass&gt;${mainClassName}&lt;/mainClass&gt;
                    &lt;addResources&gt;true&lt;/addResources&gt;
                    &lt;executable&gt;${isExecutable}&lt;/executable&gt;
                    &lt;layout&gt;WAR&lt;/layout&gt;
                &lt;/configuration&gt;
                &lt;executions&gt;
                    &lt;execution&gt;
                        &lt;goals&gt;
                            &lt;goal&gt;repackage&lt;/goal&gt;
                        &lt;/goals&gt;
                    &lt;/execution&gt;
                &lt;/executions&gt;
            &lt;/plugin&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
                &lt;artifactId&gt;maven-war-plugin&lt;/artifactId&gt;
                &lt;version&gt;2.6&lt;/version&gt;
                &lt;configuration&gt;
                    &lt;warName&gt;cas&lt;/warName&gt;
                    &lt;failOnMissingWebXml&gt;false&lt;/failOnMissingWebXml&gt;
                    &lt;recompressZippedFiles&gt;false&lt;/recompressZippedFiles&gt;
                    &lt;archive&gt;
                        &lt;compress&gt;false&lt;/compress&gt;
                        &lt;manifestFile&gt;${manifestFileToUse}&lt;/manifestFile&gt;
                    &lt;/archive&gt;
                    &lt;overlays&gt;
                        &lt;overlay&gt;
                            &lt;groupId&gt;org.apereo.cas&lt;/groupId&gt;
                            &lt;artifactId&gt;cas-server-webapp${app.server}&lt;/artifactId&gt;
                        &lt;/overlay&gt;
                    &lt;/overlays&gt;
                &lt;/configuration&gt;
            &lt;/plugin&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
                &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;
                &lt;version&gt;3.3&lt;/version&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
        &lt;finalName&gt;cas&lt;/finalName&gt;
    &lt;/build&gt;

    &lt;dependencies&gt;
        &lt;!-- 和maven-war-plugin里配置的overlays配合使用 --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.apereo.cas&lt;/groupId&gt;
            &lt;artifactId&gt;cas-server-webapp${app.server}&lt;/artifactId&gt;
            &lt;version&gt;${cas.version}&lt;/version&gt;
            &lt;type&gt;war&lt;/type&gt;
            &lt;scope&gt;runtime&lt;/scope&gt;
        &lt;/dependency&gt;
        &lt;!-- 自己需要的jar包，我这里用到了查库验证身份，所以引入了mysql --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;mysql&lt;/groupId&gt;
            &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
            &lt;version&gt;5.1.44&lt;/version&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;

&lt;/project&gt;
</code></pre> 
<ul><li> </li></ul> 
<p>搞了很久的还有一个原因是以前没有接触过maven的overlay用法，这个功能就是引入一个war包（不知道jar包可不可以，没试），然后打包的时候，框架会在这个war包的基础上把自己写的类啊，配置文件啊什么加进去，如果原来已经有了就覆盖，了解这个之后就觉得这个用法挺好的，保持了项目的简洁性，实现无侵入性改造。 <br> 我理解的这两个地方是配合使用的： <br><img alt="这里写图片描述" class="has" src="https://images2.imgbox.com/39/28/ryVjgJkS_o.png"></p> 
<p>dependency的war包用于覆盖，overlay用于配置哪些文件不打包到最终war包里，类似这种用法： <br><img alt="这里写图片描述" class="has" src="https://images2.imgbox.com/e4/95/EWMNphpb_o.png"> <br> 不过我也没试过，猜测的</p> 
<p>这样虽然可以打包了，但是依赖的war包里的类并不能编译，想写一个类继承war包里的一个类搞不定，引用不到，scope改成compile也是一样，有博客提到用下面这种糟糕的方式：</p> 
<pre class="prettyprint"><code>  &lt;dependency&gt;
    &lt;groupId&gt;org.apereo.cas&lt;/groupId&gt;
    &lt;artifactId&gt;cas-server-webapp${app.server}&lt;/artifactId&gt;  
    &lt;version&gt;${cas.version}&lt;/version&gt;  
    &lt;type&gt;jar&lt;/type&gt;
    &lt;classifier&gt;classes&lt;/classifier&gt;
    &lt;scope&gt;provided&lt;/scope&gt;
  &lt;/dependency&gt;</code></pre> 
<p>相当于是把war包里需要的jar都下载下来的意思，下载了半年都没下好，很浪费时间空间，因为需要的jar包在咱们的 <strong>css_war/WEB_INF/lib</strong> 下面都有了啊，所以就不搞这些虚的了，直接在 Project Structure-&gt;Modules-&gt;Dependencies把 <strong>css_war/WEB_INF/lib</strong> 引入进来，scope选provided。</p> 
<p>==================================图解分割线=================================================</p> 
<p>如果你用的idea这几个一起按（Ctrl+Shift+Alt+S）会出现这么一个图   如果是elps是那个小瓶子，自己解决</p> 
<p><img alt="" class="has" src="https://images2.imgbox.com/e8/be/KCZTSHX2_o.png"></p> 
<p>webapp目录需要自己创建，如果不用在里面加什么自定义文件的话不创建也可以 <br> 目前为止项目结构： <br><img alt="这里写图片描述" class="has" src="https://images2.imgbox.com/f0/c1/sb55FiRs_o.png"></p> 
<p>application.properties和META-INF文件夹从 <strong>css_war</strong> 里面拷贝出来，后面自己定制化会涉及到修改这两个文件</p> 
<p>配置调试注意： <br> 1. tomcat选择配置了ssl的那个 <br> 2. url自己写一下，跟下面的https端口一样 <br> 3. jdk至少1.8 <br> 4. http port不要填，否则启动会报错 <br> 5. contextpath配置一下 <br><img alt="这里写图片描述" class="has" src="https://images2.imgbox.com/e8/78/XEE9XuUH_o.png"><br><img alt="这里写图片描述" class="has" src="https://images2.imgbox.com/f3/55/9XFVeuaR_o.png"><br> 第一次启动应该会出现： <br><img alt="这里写图片描述" class="has" src="https://images2.imgbox.com/be/3f/lZmZaeOz_o.png"> <br> 选accept就行了</p> 
<p>大功告成了 <br><img alt="这里写图片描述" class="has" src="https://images2.imgbox.com/ae/21/RFresITc_o.png"></p> 
<p> </p> 
<p>用户名casuser，密码Mellon。 </p> 
<p>后面会集成 自定义数据库认证</p> 
<p>shiro+pac4j的集成，权限管理</p> 
<p><br> 因为我主要讲解的是shiro+pac4j，前面的基础借鉴https://blog.csdn.net/u010588262/article/details/79741626 这个博客</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/897c1ae4857c5a99459975b6f798c5bf/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">在服务器端如何获取tomcat中部署的所有项目的项目名称?</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e4a60ae011e32e35b13db3e9c336d8bd/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">C#中事件（event）和委托（Delegate）的一些略解</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>