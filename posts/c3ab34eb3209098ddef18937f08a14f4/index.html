<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【控制篇 / 绑定】(5.4) ❀ 01. 通过 MAC 地址绑定 IP 的方式限制上网 ❀ FortiGate 防火墙 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【控制篇 / 绑定】(5.4) ❀ 01. 通过 MAC 地址绑定 IP 的方式限制上网 ❀ FortiGate 防火墙" />
<meta property="og:description" content="【简介】我们已经知道了可以在策略里指定某些IP允许上网，也可以指定某些IP禁止上网，但是如果某个员工知道了某个IP是可以上网的，把他自己的电脑改成这个IP，那不是也能上网了？为了防止修改IP地址后可以上网，我们需要将IP地址与网卡的MAC地址绑定在一起，这样即使修改了IP地址，但MAC地址不符，也是不能上网的。
接口环境
防火墙的内网接口常见的有硬件交换和各自独立两种，我们以各自独立的接口为例。
① 这里配置内网接口5，IP地址为172.20.5.1，打开了DHCP服务，允许自动分配IP地址。
② 在这个接口只允许部分IP地址上网，因此建立一个地址对象，指定可以上网的IP地址范围。
③ 建立上网策略，指定172.20.5.180-172.20.5.200这个IP范围的电脑，可以通过Wan1接口上网。
④ 在internal5接口上接上电脑，自动获取IP地址，根据DHCP服务的启始IP，获得的IP地址是172.20.5.20，但在策略里只允许180-200可以上网，因此这台电脑是不能上网的。
⑤ 手动将电脑IP地址修改为172.20.5.188，符合上网地址范围180-200，因此可以看到，这个IP地址的电脑是可以上网的。
MAC 地址占用
手动修改IP地址允许上网，很显然会工作量比较大并且效率低，其实我们只要记录下允许上网电脑的网卡MAC地址，将MAC地址与可以上网的IP地址绑定，就可以轻松达到目的了。
① 在网卡的属性中，我们可以看到网卡的物理地址，也就是MAC地址。
② 选择菜单【网络】-【接口】，选择internal5接口，点击【编辑】，可以看到接口内容，点击DHCP服务器设置里的高级选项。
③ 在MAC占用&#43;访问控制设置中，点击【新建】，将MAC地址与IP地址填入，动作为保留IP。可以建立多条MAC占用。点击【确认】。
④ 修改网卡的配置为自动获取IP地址与DNS。
⑤ 获取IP后可以看到，这个MAC地址得到的IP是指定172.20.5.188，而不再是一开始获得的172.20.5.20了。这样就可以通过策略允许上网了。
⑥ 这样操作虽然很省心，但也不是没有漏洞。如果正好这台电脑关机了，我们用另一台电脑手动修改地址为172.20.5.188，还是可以上网的。也就是说，DHCP里的设置只是占用了IP地址，并没有绑定在一起。
MAC地址绑定表
实际上，防火墙象设置黑白名单一样，可以设置一张MAC地址绑定表，并允许通过绑定表控制是否能访问防火墙或外网。只是这张绑定表的配置都需要通过命令来完成。
① 在仪表板上有可以输入命令的CLI控制台，也可以随时通过右上角的子菜单点击CLI Console打来命令输入窗口。
② 输入get firewall ipmacbinding table命令，可以看到MAC地址绑定表的内容，默认是空的。
③ 配置MAC绑定表的命令是config firewall ipmacbinding table，表格的内容包括序号、IP地址、MAC地址、备注（可选）、状态。
④ 根据MAC绑定表的结构，我们收集了三个MAC地址信息，分别是无线路由器外网接口、直连防火墙的电脑MAC地址，还有连接三层交换机再经过防火墙的电脑MAC地址。分别测试不同环境下的绑定效果。
⑤ 用config firewall ipmacbinding table命令进入配置状态，edit 0表示从最后一个开始加入表，例如是空表，edit 0就表示编辑第1个，如果里面有5条记录，edit 0就表示编辑第6条。next表示完成这条编辑，end保存并退出。
⑥ 用show firewall ipmacbinding table命令可以看到刚已经建立的三条记录，并自动编写了序号。
⑦ 如果需要修改某条记录，进入配置状态后，编辑记录序号，设置修改内容，end退出保存。例如修改状态，使某条记录启动或禁用MAC绑定。
⑧ 对于确定不再使用的记录，也可以用delete命令加序号删除。
【提示】 如果需要绑定几十至几百条MAC地址，手动一条条输入确实很影响效率，可以参考：维护篇(5.2)－08. 批量命令操作 ❀ 飞塔 (Fortinet) 防火墙。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/c3ab34eb3209098ddef18937f08a14f4/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-02T10:03:15+08:00" />
<meta property="article:modified_time" content="2022-08-02T10:03:15+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【控制篇 / 绑定】(5.4) ❀ 01. 通过 MAC 地址绑定 IP 的方式限制上网 ❀ FortiGate 防火墙</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>　　【简介】我们已经知道了可以在策略里指定某些IP允许上网，也可以指定某些IP禁止上网，但是如果某个员工知道了某个IP是可以上网的，把他自己的电脑改成这个IP，那不是也能上网了？为了防止修改IP地址后可以上网，我们需要将IP地址与网卡的MAC地址绑定在一起，这样即使修改了IP地址，但MAC地址不符，也是不能上网的。</p> 
<hr> 
<p><img alt="" src="https://images2.imgbox.com/1c/ea/htpjBO2P_o.png">  <strong><span style="color:#cc6600;">接口环境</span></strong></p> 
<p>        防火墙的内网接口常见的有硬件交换和各自独立两种，我们以各自独立的接口为例。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/31/65/idMRkmIl_o.png"></p> 
<p>        ① 这里配置内网接口5，IP地址为172.20.5.1，打开了DHCP服务，允许自动分配IP地址。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/77/64/dnJt6ejL_o.png"></p> 
<p>        ② 在这个接口只允许部分IP地址上网，因此建立一个地址对象，指定可以上网的IP地址范围。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/7c/96/mUC4A0rE_o.png"></p> 
<p>        ③ 建立上网策略，指定172.20.5.180-172.20.5.200这个IP范围的电脑，可以通过Wan1接口上网。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/a5/8c/gFNbJFnE_o.png"></p> 
<p>        ④ 在internal5接口上接上电脑，自动获取IP地址，根据DHCP服务的启始IP，获得的IP地址是172.20.5.20，但在策略里只允许180-200可以上网，因此这台电脑是不能上网的。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/5a/91/BKqggwlm_o.png"></p> 
<p>        ⑤ 手动将电脑IP地址修改为172.20.5.188，符合上网地址范围180-200，因此可以看到，这个IP地址的电脑是可以上网的。</p> 
<p><img alt="" src="https://images2.imgbox.com/1c/53/6qOgexyO_o.png">  <strong><span style="color:#cc6600;">MAC 地址占用</span></strong></p> 
<p>        手动修改IP地址允许上网，很显然会工作量比较大并且效率低，其实我们只要记录下允许上网电脑的网卡MAC地址，将MAC地址与可以上网的IP地址绑定，就可以轻松达到目的了。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/53/ec/Li3CxAZn_o.png"></p> 
<p>        ① 在网卡的属性中，我们可以看到网卡的物理地址，也就是MAC地址。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/00/f9/W5K12k5A_o.png"></p> 
<p>        ② 选择菜单【网络】-【接口】，选择internal5接口，点击【编辑】，可以看到接口内容，点击DHCP服务器设置里的高级选项。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/19/41/TFLkcSaU_o.png"></p> 
<p>        ③ 在MAC占用+访问控制设置中，点击【新建】，将MAC地址与IP地址填入，动作为保留IP。可以建立多条MAC占用。点击【确认】。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/9c/37/XRnuyhU5_o.png"></p> 
<p>        ④ 修改网卡的配置为自动获取IP地址与DNS。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/24/e3/jmDqZC3R_o.png"></p> 
<p>        ⑤ 获取IP后可以看到，这个MAC地址得到的IP是指定172.20.5.188，而不再是一开始获得的172.20.5.20了。这样就可以通过策略允许上网了。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/cc/0f/M7jC6XRa_o.png"></p> 
<p>        ⑥ 这样操作虽然很省心，但也不是没有漏洞。如果正好这台电脑关机了，我们用另一台电脑手动修改地址为172.20.5.188，还是可以上网的。也就是说，DHCP里的设置只是占用了IP地址，并没有绑定在一起。</p> 
<p><img alt="" src="https://images2.imgbox.com/3f/01/MM0eIyFN_o.png">  <strong><span style="color:#cc6600;"><span style="color:#cc6600;">MAC地址绑定表</span></span></strong></p> 
<p>        实际上，防火墙象设置黑白名单一样，可以设置一张MAC地址绑定表，并允许通过绑定表控制是否能访问防火墙或外网。只是这张绑定表的配置都需要通过命令来完成。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/f4/71/YCufbh5H_o.png"></p> 
<p>        ① 在仪表板上有可以输入命令的CLI控制台，也可以随时通过右上角的子菜单点击CLI Console打来命令输入窗口。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/54/1d/8DesxcRp_o.png"></p> 
<p>        ② 输入<span style="color:#ff0000;"><strong>get firewall ipmacbinding table</strong></span>命令，可以看到MAC地址绑定表的内容，默认是空的。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/35/63/20PtzNy7_o.png"></p> 
<p>        ③ 配置MAC绑定表的命令是<span style="color:#ff0000;"><strong>config firewall ipmacbinding table</strong></span>，表格的内容包括序号、IP地址、MAC地址、备注（可选）、状态。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/44/c9/rFa1EmHh_o.png"></p> 
<p>        ④ 根据MAC绑定表的结构，我们收集了三个MAC地址信息，分别是无线路由器外网接口、直连防火墙的电脑MAC地址，还有连接三层交换机再经过防火墙的电脑MAC地址。分别测试不同环境下的绑定效果。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/2d/46/0viPlZZb_o.png"></p> 
<p>        ⑤ 用<span style="color:#ff0000;"><strong>config firewall ipmacbinding table</strong></span>命令进入配置状态，<strong><span style="color:#ff0000;">edit 0</span></strong>表示从最后一个开始加入表，例如是空表，edit 0就表示编辑第1个，如果里面有5条记录，edit 0就表示编辑第6条。<strong><span style="color:#ff0000;">next</span></strong>表示完成这条编辑，<strong><span style="color:#ff0000;">end</span></strong>保存并退出。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/c0/75/cqjoucjS_o.png"></p> 
<p>        ⑥ 用<span style="color:#ff0000;"><strong>show firewall ipmacbinding table</strong></span>命令可以看到刚已经建立的三条记录，并自动编写了序号。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/49/7e/t2wPRQnE_o.png"></p> 
<p>        ⑦ 如果需要修改某条记录，进入配置状态后，编辑记录序号，设置修改内容，end退出保存。例如修改状态，使某条记录启动或禁用MAC绑定。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/59/9b/fNxK1Yak_o.png"></p> 
<p>        ⑧ 对于确定不再使用的记录，也可以用<span style="color:#ff0000;"><strong>delete</strong></span>命令加序号删除。</p> 
<p>        <img alt="" src="https://images2.imgbox.com/7d/54/ZfuA07pR_o.png">  <strong> <span style="color:#cc6600;">【提示】</span></strong> <span style="color:#3333ff;">如果需要绑定几十至几百条MAC地址，手动一条条输入确实很影响效率，可以参考：<a href="http://blog.csdn.net/meigang2012/article/details/53019600" title="维护篇(5.2)－08. 批量命令操作 ❀ 飞塔 (Fortinet) 防火墙">维护篇(5.2)－08. 批量命令操作 ❀ 飞塔 (Fortinet) 防火墙</a>。</span></p> 
<p><img alt="" src="https://images2.imgbox.com/75/7a/WKoi2pnU_o.png">  <span style="color:#cc6600;"> <strong>启用MAC地址绑定</strong></span></p> 
<p>        虽然我们编辑生成了MAC地址绑定表，但这张表默认是没有启用的，我们还需要用命令启用这张表。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/46/63/XgphIqpz_o.png"></p> 
<p>        ① 输入<span style="color:#ff0000;"><strong>get firewall ipmacbinding setting</strong></span>命令，可以看到MAC地址绑定表的默认设置两个参数都是禁用的。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/68/9d/MvABUYV1_o.png"></p> 
<p>        ② 实际上MAC绑定表设置有三个参数，只有第一个参数bindthroughfw设置为enable时，undefinedhost参数才可以配置。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/52/3d/DBoPYqFz_o.png"></p> 
<p>        ③ 三个参数的作用分别是：bindthroughfw，允行或禁止通过防火墙上网。bindtofw，允行或禁止访问防火墙，undefinedhost，block表示只有绑定表内容才能通过，Allow表示相反，非绑定表内容才能通过。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/50/b3/Sjr7m6gt_o.png"></p> 
<p>        ④ 用<span style="color:#ff0000;"><strong>config firewall ipmacbinding setting</strong></span>命令进入设置状态，修改bindthroughfw为enable，保存后立即可以看到效果，只有绑定表里的IP可以上网，其它都不能上网了。包括防火墙上的所有内网接口。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/2d/d9/YzD6g5yt_o.png"></p> 
<p>        ⑤ 再次查看MAC绑定设置状态，这次多出一个undefindehost参数。如果将undefinedhost参数设置为Allow，则所有MAC绑定表的IP都不可以上网，没有绑定的都可以上网。</p> 
<p><img alt="" src="https://images2.imgbox.com/c6/f4/KROQasPy_o.png">  <span style="color:#cc6600;"> <strong>验证效果 - 直接防火墙</strong></span></p> 
<p>        我们配置了三个不同连接方式的MAC地址绑定，也启动MAC地址绑定了，现在我们来验证一下绑定效果。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/76/2e/osJ8PdrU_o.png"></p> 
<p>        ① 直接连接防火墙内网接口5的电脑通过DHCP分配占用172.20.5.188地址，MAC绑定表了也绑定了这个地址，现在是可以正常上网的。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/2a/ae/tKAEsdYC_o.png"></p> 
<p>        ② 当修改了IP地址后，因为不符合MAC绑定表内容，应该是无法上网的，但是。。。。。然并卵用，还是可以上网。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/94/9b/MdMvXAZv_o.png"></p> 
<p>        ③ 原因是我们虽然启动了MAC绑定，但是接口的允许MAC绑定功能没有打开，因此我们需要编辑防火墙内网接口5，将直ipmac参数设置为enable。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/4e/0c/7mGBvmrW_o.png"></p> 
<p>        ④ 修改完后用show命令再次查看接口内容，确定ipmac状态是enable。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/e0/98/Ct22QptC_o.png"></p> 
<p>        ⑤ 再次修改连接防火墙内网接口5的电脑IP地址，发现不能上网了，只有绑定的IP地址可以上网，MAC绑定有效。</p> 
<p>        <img alt="" src="https://images2.imgbox.com/d6/42/k5zqZSaR_o.png">  <strong> <span style="color:#cc6600;">【注意】</span></strong> <span style="color:#ff0000;">接口的DHCP服务，如果没有使用MAC地址占用功能，请一定要关闭，否则会导致修改IP地址后仍可以上网。</span></p> 
<p><img alt="" src="https://images2.imgbox.com/6e/33/GakW4RQm_o.png">  <strong><span style="color:#cc6600;"><span style="color:#cc6600;"><strong>验证效果 - 无线路由器</strong></span></span></strong></p> 
<p>        我们在Mac绑定表里绑定了无线路由器的外网MAC地址，一般来说无线路由器的外网IP地址会很少改动，主要测试的是连接无线路由器的电脑因为不在MAC绑定表里，是否能上网。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/56/53/SU2sxiiq_o.png"></p> 
<p>        ① 我们将连接无线路由器的防火墙接口ipmac设置为enable。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/ce/01/3ZUAMa2H_o.png"></p> 
<p>        ② 笔记本电脑无线网卡连接无线路由器，可以看到IP地址和MAC地址并不在防火墙的MAC绑定表里，但是仍可以上网。连接无线路由器的任何设备都可以上网。证明防火墙无法绑定路由器后面的MAC地址。</p> 
<p><img alt="" src="https://images2.imgbox.com/c4/d2/3YvM8YgA_o.png">  <strong><span style="color:#cc6600;"><span style="color:#cc6600;"><strong>验证效果 - 三层交换机</strong></span></span></strong></p> 
<p>        我们将电脑连接在思科的三层交换机上面，交换机与防火墙连接，在防火墙连接交换机的内网接口ipmac没有打开的情况下，电脑无法上网。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/9c/bf/UjzWuy03_o.png"></p> 
<p>        ① 我们将连接三层交换机的防火墙接口ipmac设置为enable。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/20/26/T7GCVTK8_o.png"></p> 
<p>        ② 虽然MAC绑定表里有记录，而且策略也允许上网，但这台电脑却无法上网。而将ipmac设置为disable时则可以上网。证明防火墙无法绑定三层交换机下面的MAC地址。<br>  </p> 
<hr> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/b1/78/mXfmbKDk_o.png"></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/49bd04d8b8526f9ecadd9b88c36d0267/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">selenium安装和环境配置Firefox</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ae19bec210a82e12c37dd91ed268aca0/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">查看文件的MD5 值</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>