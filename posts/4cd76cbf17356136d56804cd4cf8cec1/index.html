<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Flink时间窗口和水位线 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Flink时间窗口和水位线" />
<meta property="og:description" content="Flink时间窗口和水位线 一、 Flink中的时间和窗口1.窗口（Window）2.窗口API 二、窗口函数(Window Functions)1.增量聚合函数2.全窗口函数3. 增量聚合和全窗口函数的结合使用4.窗口的生命周期 三、时间语义和水位线1.时间语义的选择1.水位线（Watermark）3.水位线和窗口的工作原理4.生成水位线5.水位线的传递6.迟到数据的处理 四、双流结合1.基于时间的合流——双流联结（Join）2.间隔联结（Interval Join） 一、 Flink中的时间和窗口 在批处理统计中，我们可以等待一批数据都到齐后，统一处理。但是在实时处理统计中，我们是来一条就得处理一条，那么我们怎么统计最近一段时间内的数据呢？
引入“窗口”。所谓的“窗口”，一般就是划定的一段时间范围，也就是“时间窗”；对在这范围内的数据进行处理，就是所谓的窗口计算。所以窗口和时间往往是分不开的。接下来我们就深入了解一下Flink中的时间语义和窗口的应用。
1.窗口（Window） Flink是一种流式计算引擎，主要是来处理无界数据流的，数据源源不断、无穷无尽。想要更加方便高效地处理无界流，一种方式就是将无限数据切割成有限的“数据块”进行处理，这就是所谓的“窗口”（Window）。
注意：Flink中窗口并不是静态准备好的，而是动态创建——当有落在这个窗口区间范围的数据达到时，才创建对应的窗口。另外，这里我们认为到达窗口结束时间时，窗口就触发计算并关闭，事实上“触发计算”和“窗口关闭”两个行为也可以分开。
1）按照驱动类型分
2）按照窗口分配数据的规则分类
根据分配数据的规则，窗口的具体实现可以分为4类：滚动窗口（Tumbling Window）、滑动窗口（Sliding Window）、会话窗口（Session Window），以及全局窗口（Global Window）。
滚动窗口（Tumbling Window）
滚动窗口可以基于时间也可以基于数据长度进行滚动，滚动窗口统计的数据是没有重复的
滑动窗口（Sliding Window）
滑动窗口基于时间进行滑动，两个窗口有可能会包含相同的数据。
会话窗口(Session Windows)
当在规定的时间间隔内，会话都没有收到数据，那么将开始下一个会话
全局窗口(Global Windows)
2.窗口API （1）按键分区窗口（Keyed Windows）
经过按键分区keyBy操作后，数据流会按照key被分为多条逻辑流（logical streams），这就是KeyedStream。基于KeyedStream进行窗口操作时，窗口计算会在多个并行子任务上同时执行。相同key的数据会被发送到同一个并行子任务，而窗口操作会基于每个key进行单独的处理。所以可以认为，每个key上都定义了一组窗口，各自独立地进行统计计算。
（2）非按键分区（Non-Keyed Windows）
如果没有进行keyBy，那么原始的DataStream就不会分成多条逻辑流。这时窗口逻辑只能在一个任务（task）上执行，就相当于并行度变成了1。
非按键分区的流使用AllWindowedStream进行开窗。
SingleOutputStreamOperator&lt;WaterSensor&gt; source = env.socketTextStream(&#34;localhost&#34;, 7777) .map(new WaterSensorMapFunction()); KeyedStream&lt;WaterSensor, String&gt; sensorKS = source.keyBy(sensor -&gt; sensor.id); //todo 基于时间的窗口 //滚动窗口,窗口长度10s sensorKS.window(TumblingEventTimeWindows.of(Time.seconds(10))); //滑动窗口,窗口长度10s,步长2s sensorKS.window(SlidingProcessingTimeWindows.of(Time.seconds(10),Time.seconds(2))); //会话窗口,超时间隔5s sensorKS.window(ProcessingTimeSessionWindows.withGap(Time.seconds(5))); //todo 基于计数的窗口 //滚动窗口 累计5条数据进行滚动 sensorKS." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/4cd76cbf17356136d56804cd4cf8cec1/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-09-15T12:10:09+08:00" />
<meta property="article:modified_time" content="2023-09-15T12:10:09+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Flink时间窗口和水位线</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>Flink时间窗口和水位线</h4> 
 <ul><li><a href="#_Flink_2" rel="nofollow">一、 Flink中的时间和窗口</a></li><li><ul><li><a href="#1Window_6" rel="nofollow">1.窗口（Window）</a></li><li><a href="#2API_42" rel="nofollow">2.窗口API</a></li></ul> 
  </li><li><a href="#Window_Functions_70" rel="nofollow">二、窗口函数(Window Functions)</a></li><li><ul><li><a href="#1_74" rel="nofollow">1.增量聚合函数</a></li><li><a href="#2_161" rel="nofollow">2.全窗口函数</a></li><li><a href="#3__198" rel="nofollow">3. 增量聚合和全窗口函数的结合使用</a></li><li><a href="#4_278" rel="nofollow">4.窗口的生命周期</a></li></ul> 
  </li><li><a href="#_291" rel="nofollow">三、时间语义和水位线</a></li><li><ul><li><a href="#1_292" rel="nofollow">1.时间语义的选择</a></li><li><a href="#1Watermark_305" rel="nofollow">1.水位线（Watermark）</a></li><li><a href="#3_318" rel="nofollow">3.水位线和窗口的工作原理</a></li><li><a href="#4_329" rel="nofollow">4.生成水位线</a></li><li><a href="#5_450" rel="nofollow">5.水位线的传递</a></li><li><a href="#6_475" rel="nofollow">6.迟到数据的处理</a></li></ul> 
  </li><li><a href="#_509" rel="nofollow">四、双流结合</a></li><li><ul><li><a href="#1Join_510" rel="nofollow">1.基于时间的合流——双流联结（Join）</a></li><li><a href="#2Interval_Join_587" rel="nofollow">2.间隔联结（Interval Join）</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_Flink_2"></a>一、 Flink中的时间和窗口</h2> 
<p>在批处理统计中，我们可以等待一批数据都到齐后，统一处理。但是在实时处理统计中，我们是来一条就得处理一条，那么我们怎么统计最近一段时间内的数据呢？<br> 引入“窗口”。所谓的“窗口”，<strong>一般就是划定的一段时间范围，也就是“时间窗”</strong>；对在这范围内的数据进行处理，就是所谓的窗口计算。所以窗口和时间往往是分不开的。接下来我们就深入了解一下Flink中的时间语义和窗口的应用。</p> 
<h3><a id="1Window_6"></a>1.窗口（Window）</h3> 
<blockquote> 
 <p>Flink是一种流式计算引擎，<strong>主要是来处理无界数据流</strong>的，数据源源不断、无穷无尽。想要更加方便高效地处理无界流，一种方式就是将无限数据切割成有限的“数据块”进行处理，这就是所谓的“窗口”（Window）。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/13/d1/RVtJr921_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>注意：Flink中窗口并不是静态准备好的，而是<strong>动态创建</strong>——当有落在这个窗口区间范围的数据达到时，才创建对应的窗口。另外，这里我们认为到达窗口结束时间时，窗口就触发计算并关闭，事实上“触发计算”和“窗口关闭”两个行为也可以分开。</p> 
</blockquote> 
<p><strong>1）按照驱动类型分</strong></p> 
<p><img src="https://images2.imgbox.com/6f/6a/k6piZAXH_o.png" alt="在这里插入图片描述"><br> <strong>2）按照窗口分配数据的规则分类</strong></p> 
<blockquote> 
 <p>根据分配数据的规则，窗口的具体实现可以分为4类：滚动窗口（Tumbling Window）、滑动窗口（Sliding Window）、会话窗口（Session Window），以及全局窗口（Global Window）。</p> 
</blockquote> 
<p>滚动窗口（Tumbling Window）</p> 
<p><img src="https://images2.imgbox.com/45/7c/0CIYpJFd_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>滚动窗口可以基于时间也可以基于数据长度进行滚动，滚动窗口统计的数据是没有重复的</p> 
</blockquote> 
<p>滑动窗口（Sliding Window）</p> 
<p><img src="https://images2.imgbox.com/ad/ff/B8yCILzd_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>滑动窗口基于时间进行滑动，两个窗口有可能会包含相同的数据。</p> 
</blockquote> 
<p>会话窗口(Session Windows)</p> 
<p><img src="https://images2.imgbox.com/53/dc/TDBvBnEo_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>当在规定的时间间隔内，会话都没有收到数据，那么将开始下一个会话</p> 
</blockquote> 
<p>全局窗口(Global Windows)</p> 
<p><img src="https://images2.imgbox.com/ab/2c/imVNDCyI_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="2API_42"></a>2.窗口API</h3> 
<p><strong>（1）按键分区窗口（Keyed Windows）</strong><br> 经过按键分区keyBy操作后，数据流会按照key被分为多条逻辑流（logical streams），这就是KeyedStream。基于KeyedStream进行窗口操作时，窗口计算会在多个并行子任务上同时执行。相同key的数据会被发送到同一个并行子任务，而窗口操作会基于每个key进行单独的处理。所以可以认为，每个key上都定义了一组窗口，各自独立地进行统计计算。<br> <strong>（2）非按键分区（Non-Keyed Windows）</strong><br> 如果没有进行keyBy，那么原始的DataStream就不会分成多条逻辑流。这时窗口逻辑只能在一个任务（task）上执行，就相当于并行度变成了1。<br> <strong>非按键分区的流使用AllWindowedStream进行开窗。</strong></p> 
<pre><code class="prism language-java">		<span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WaterSensor</span><span class="token punctuation">&gt;</span></span> source <span class="token operator">=</span> 
			env<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">7777</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WaterSensorMapFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">KeyedStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WaterSensor</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> sensorKS <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>sensor <span class="token operator">-&gt;</span> sensor<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//todo 基于时间的窗口</span>
        <span class="token comment">//滚动窗口,窗口长度10s</span>
        sensorKS<span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">TumblingEventTimeWindows</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//滑动窗口,窗口长度10s,步长2s</span>
        sensorKS<span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">SlidingProcessingTimeWindows</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//会话窗口,超时间隔5s</span>
        sensorKS<span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">ProcessingTimeSessionWindows</span><span class="token punctuation">.</span><span class="token function">withGap</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//todo 基于计数的窗口</span>
        <span class="token comment">//滚动窗口 累计5条数据进行滚动</span>
        sensorKS<span class="token punctuation">.</span><span class="token function">countWindow</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//滑动窗口 累计5条数据进行2条数据的滑动</span>
        sensorKS<span class="token punctuation">.</span><span class="token function">countWindow</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//todo 全局窗口,需要自定义触发器</span>
        sensorKS<span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">GlobalWindows</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>GlobalWindows是能够自定义的窗口，前边的窗口底层实现都是使用GlobalWindows，不过Flink实现了对应的触发器。</p> 
</blockquote> 
<h2><a id="Window_Functions_70"></a>二、窗口函数(Window Functions)</h2> 
<p><img src="https://images2.imgbox.com/5d/90/2mfzAVOR_o.png" alt="在这里插入图片描述"><br> 窗口函数定义了要对窗口中收集的数据做的计算操作，根据处理的方式可以分为两类：<br> 增量聚合函数和全窗口函数。</p> 
<h3><a id="1_74"></a>1.增量聚合函数</h3> 
<blockquote> 
 <p><strong>增量聚合函数（ReduceFunction / AggregateFunction）</strong><br> 窗口将数据收集起来，最基本的处理操作当然就是进行聚合。我们可以每来一个数据就在之前结果上聚合一次，这就是“增量聚合”。(来一条数据计算一次)<br> 典型的增量聚合函数有两个：ReduceFunction和AggregateFunction</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DataStreamSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> socketDS <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">7777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WaterSensor</span><span class="token punctuation">&gt;</span></span> sensorDS <span class="token operator">=</span> socketDS<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WaterSensorMapFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">KeyedStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WaterSensor</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> sensorKS <span class="token operator">=</span> sensorDS<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>value <span class="token operator">-&gt;</span> value<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">WindowedStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WaterSensor</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">TimeWindow</span><span class="token punctuation">&gt;</span></span> sensorWS <span class="token operator">=</span>
                sensorKS<span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">TumblingProcessingTimeWindows</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WaterSensor</span><span class="token punctuation">&gt;</span></span> reduceDS <span class="token operator">=</span> sensorWS<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>value1<span class="token punctuation">,</span> value2<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"value1Id"</span> <span class="token operator">+</span> value1<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"value2Id"</span> <span class="token operator">+</span> value2<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">WaterSensor</span><span class="token punctuation">(</span>value1<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value2<span class="token punctuation">.</span><span class="token function">getTs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value1<span class="token punctuation">.</span><span class="token function">getVc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> value2<span class="token punctuation">.</span><span class="token function">getVc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        reduceDS<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        部分运行结果<span class="token operator">:</span>
        <span class="token number">2</span><span class="token operator">&gt;</span> <span class="token class-name">WoaterSensor</span><span class="token punctuation">{<!-- --></span>id<span class="token operator">=</span><span class="token char">'s2'</span><span class="token punctuation">,</span> ts<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> vc<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">}</span>
		value1Ids2value2Ids2
		value1Ids2value2Ids2
		<span class="token number">2</span><span class="token operator">&gt;</span> <span class="token class-name">WoaterSensor</span><span class="token punctuation">{<!-- --></span>id<span class="token operator">=</span><span class="token char">'s2'</span><span class="token punctuation">,</span> ts<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> vc<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>使用输出语句对数据的计算过程进行检验，WindowReduce属于增量聚合函数，每条数据计算一次，但只有在窗口结束时,才会进行数据结果的打印输出。</p> 
<blockquote> 
 <p><strong>聚合函数（AggregateFunction）</strong><br> ReduceFunction可以解决大多数归约聚合的问题，但是这个接口有一个限制，就是聚合状态的类型、输出结果的类型都必须和输入数据类型一样。<br> Flink Window API中的aggregate就突破了这个限制，可以定义更加灵活的窗口聚合操作。这个方法需要传入一个AggregateFunction的实现类作为参数。</p> 
</blockquote> 
<p>AggregateFunction可以看作是ReduceFunction的通用版本，这里有三种类型：输入类型（IN）、累加器类型（ACC）和输出类型（OUT）。输入类型IN就是输入流中元素的数据类型；累加器类型ACC则是我们进行聚合的中间状态类型；而输出类型当然就是最终计算结果的类型了。</p> 
<pre><code class="prism language-java"><span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WaterSensor</span><span class="token punctuation">&gt;</span></span> sensorDS <span class="token operator">=</span> socketDS<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WaterSensorMapFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">KeyedStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WaterSensor</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> sensorKS <span class="token operator">=</span> sensorDS<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>value <span class="token operator">-&gt;</span> value<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">WindowedStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WaterSensor</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">TimeWindow</span><span class="token punctuation">&gt;</span></span> sensorWS <span class="token operator">=</span>
                sensorKS<span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">TumblingProcessingTimeWindows</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> aggregateDS <span class="token operator">=</span> sensorWS<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">AggregateFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WaterSensor</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">createAccumulator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"创建累加器"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">WaterSensor</span> waterSensor<span class="token punctuation">,</span> <span class="token class-name">Integer</span> integer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"调用计算逻辑"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//integer是之前的计算结果</span>
                        <span class="token keyword">return</span> waterSensor<span class="token punctuation">.</span><span class="token function">getVc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> integer<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getResult</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> integer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"获取计算结果"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> integer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">merge</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> integer<span class="token punctuation">,</span> <span class="token class-name">Integer</span> acc1<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//合并两个累加器</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"调用merge"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//todo 该方法通常只有会话窗口才会使用</span>
                        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        aggregateDS<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//计算结果</span>
        创建累加器
		调用计算逻辑
		获取计算结果
		<span class="token number">1</span>
		创建累加器
		调用计算逻辑
		调用计算逻辑
		调用计算逻辑
		获取计算结果
		<span class="token number">3</span>
</code></pre> 
<p>所以可以看到，AggregateFunction的工作原理是：首先调用createAccumulator()为任务初始化一个状态（累加器）；而后每来一个数据就调用一次add()方法，对数据进行聚合，得到的结果保存在状态中；等到了窗口需要输出时，再调用getResult()方法得到计算结果。很明显，与ReduceFunction相同，AggregateFunction也是增量式的聚合；而由于输入、中间状态、输出的类型可以不同，使得应用更加灵活方便。</p> 
<h3><a id="2_161"></a>2.全窗口函数</h3> 
<p>有些场景下，我们要做的计算必须基于全部的数据才有效，这时做增量聚合就没什么意义了；另外，输出的结果有可能要包含上下文中的一些信息（比如窗口的起始时间），这是增量聚合函数做不到的。<br> 所以，我们还需要有更丰富的窗口计算方式。窗口操作中的另一大类就是全窗口函数。与增量聚合函数不同，全窗口函数需要先收集窗口中的数据，并在内部缓存起来，等到窗口要输出结果的时候再取出数据进行计算。</p> 
<p><strong>窗口函数</strong><br> ProcessWindowFunction是Window API中最底层的通用窗口函数接口。之所以说它“最底层”，是因为除了可以拿到窗口中的所有数据之外，ProcessWindowFunction还可以获取到一个“<strong>上下文对象</strong>”（Context）。这个上下文对象非常强大，不仅能够获取窗口信息，还可以访问当前的时间和状态信息。这里的时间就包括了处理时间（processing time）和事件时间水位线（event time watermark）。这就使得ProcessWindowFunction更加灵活、功能更加丰富，其实就是一个增强版的WindowFunction。</p> 
<pre><code class="prism language-java">		<span class="token class-name">DataStreamSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> socketDS <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">7777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WaterSensor</span><span class="token punctuation">&gt;</span></span> sensorDS <span class="token operator">=</span> socketDS<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WaterSensorMapFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">KeyedStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WaterSensor</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> sensorKS <span class="token operator">=</span> sensorDS<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>value <span class="token operator">-&gt;</span> value<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">WindowedStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WaterSensor</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">TimeWindow</span><span class="token punctuation">&gt;</span></span> windowDS <span class="token operator">=</span>
                sensorKS<span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">TumblingProcessingTimeWindows</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        windowDS<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>
                <span class="token comment">//ProcessWindowFunction(数据类型,key类型,输出类型)</span>
                <span class="token keyword">new</span> <span class="token class-name">ProcessWindowFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WaterSensor</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">TimeWindow</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WaterSensor</span><span class="token punctuation">&gt;</span></span> iterable<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> collector<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//使用上下文获取窗口信息</span>
                        <span class="token keyword">long</span> start <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//获取窗口开始时间</span>
                        <span class="token keyword">long</span> end <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//获取窗口结束时间</span>
                        <span class="token class-name">String</span> windowStart <span class="token operator">=</span> <span class="token class-name">DateFormatUtils</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> <span class="token string">"yyyy-MM-dd HH:mm:ss.SSS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">String</span> windowEnd <span class="token operator">=</span> <span class="token class-name">DateFormatUtils</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>end<span class="token punctuation">,</span> <span class="token string">"yyyy-MM-dd HH:mm:ss.SSS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token keyword">long</span> amount <span class="token operator">=</span> iterable<span class="token punctuation">.</span><span class="token function">spliterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">estimateSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取数据条数</span>

                        collector<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token string">"key="</span><span class="token operator">+</span>s<span class="token operator">+</span><span class="token string">"的窗口["</span><span class="token operator">+</span>windowStart<span class="token operator">+</span><span class="token string">"-"</span><span class="token operator">+</span>windowEnd<span class="token operator">+</span><span class="token string">")包含"</span><span class="token operator">+</span>amount<span class="token operator">+</span><span class="token string">"条数据==&gt;"</span><span class="token operator">+</span>iterable<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//部分结果</span>
        <span class="token number">8</span><span class="token operator">&gt;</span> key<span class="token operator">=</span>s1的窗口<span class="token punctuation">[</span><span class="token number">2023</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">10</span> <span class="token number">17</span><span class="token operator">:</span><span class="token number">58</span><span class="token operator">:</span><span class="token number">50.000</span><span class="token operator">-</span><span class="token number">2023</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">10</span> <span class="token number">17</span><span class="token operator">:</span><span class="token number">59</span><span class="token operator">:</span><span class="token number">00.000</span><span class="token punctuation">)</span>包含<span class="token number">2</span>条数据<span class="token operator">==</span><span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token class-name">WoaterSensor</span><span class="token punctuation">{<!-- --></span>id<span class="token operator">=</span><span class="token char">'s1'</span><span class="token punctuation">,</span> ts<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> vc<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">WoaterSensor</span><span class="token punctuation">{<!-- --></span>id<span class="token operator">=</span><span class="token char">'s1'</span><span class="token punctuation">,</span> ts<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> vc<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
</code></pre> 
<blockquote> 
 <p>使用全窗口函数虽然能够获取窗口的上下文，但是全窗口需要等到窗口时间结束后才将数据一并进行逻辑计算，这种方式有可能会造成数据的堆积，导致程序运行失败。</p> 
</blockquote> 
<h3><a id="3__198"></a>3. 增量聚合和全窗口函数的结合使用</h3> 
<blockquote> 
 <p>在实际应用中，我们希望既能够对每条到来的数据进行计算，又希望能够使用窗口的上下文，并且在窗口结束时进行逻辑处理。 Flink的Window API就给我们实现了这样的用法。</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WindowAggregateAndProcessDemo</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DataStreamSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> socketDS <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">7777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WaterSensor</span><span class="token punctuation">&gt;</span></span> sensorDS <span class="token operator">=</span> socketDS<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WaterSensorMapFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">KeyedStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WaterSensor</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> sensorKS <span class="token operator">=</span> sensorDS<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>value <span class="token operator">-&gt;</span> value<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">WindowedStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WaterSensor</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">TimeWindow</span><span class="token punctuation">&gt;</span></span> sensorWS <span class="token operator">=</span>
                sensorKS<span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">TumblingProcessingTimeWindows</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        sensorWS<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyAgg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">MyProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyAgg</span> <span class="token keyword">implements</span> <span class="token class-name">AggregateFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WaterSensor</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">createAccumulator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"创建累加器"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">WaterSensor</span> waterSensor<span class="token punctuation">,</span> <span class="token class-name">Integer</span> integer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"调用计算逻辑"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//integer是之前的计算结果</span>
            <span class="token keyword">return</span> waterSensor<span class="token punctuation">.</span><span class="token function">getVc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> integer<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getResult</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> integer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"获取计算结果"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> integer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">merge</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> integer<span class="token punctuation">,</span> <span class="token class-name">Integer</span> acc1<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//合并两个累加器</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"调用merge"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//todo 该方法通常只有会话窗口才会使用</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyProcess</span> <span class="token keyword">extends</span> <span class="token class-name">ProcessWindowFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">TimeWindow</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> iterable<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> collector<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//使用上下文获取窗口信息</span>
            <span class="token keyword">long</span> start <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//获取窗口开始时间</span>
            <span class="token keyword">long</span> end <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//获取窗口结束时间</span>
            <span class="token class-name">String</span> windowStart <span class="token operator">=</span> <span class="token class-name">DateFormatUtils</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> <span class="token string">"yyyy-MM-dd HH:mm:ss.SSS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> windowEnd <span class="token operator">=</span> <span class="token class-name">DateFormatUtils</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>end<span class="token punctuation">,</span> <span class="token string">"yyyy-MM-dd HH:mm:ss.SSS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> amount <span class="token operator">=</span> iterable<span class="token punctuation">.</span><span class="token function">spliterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">estimateSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取数据条数</span>
            collector<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token string">"key="</span> <span class="token operator">+</span> s <span class="token operator">+</span> <span class="token string">"的窗口["</span> <span class="token operator">+</span> windowStart <span class="token operator">+</span> <span class="token string">"-"</span> <span class="token operator">+</span> windowEnd <span class="token operator">+</span> <span class="token string">")包含"</span> <span class="token operator">+</span> amount <span class="token operator">+</span> <span class="token string">"条数据==&gt;"</span> <span class="token operator">+</span> iterable<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
运行结果<span class="token operator">:</span><span class="token operator">==</span><span class="token operator">==</span>
创建累加器
调用计算逻辑
调用计算逻辑
调用计算逻辑
获取计算结果
key<span class="token operator">=</span><span class="token constant">S1</span>的窗口<span class="token punctuation">[</span><span class="token number">2023</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">10</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">27</span><span class="token operator">:</span><span class="token number">00.000</span><span class="token operator">-</span><span class="token number">2023</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">10</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">27</span><span class="token operator">:</span><span class="token number">10.000</span><span class="token punctuation">)</span>包含<span class="token number">1</span>条数据<span class="token operator">==</span><span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>
</code></pre> 
<blockquote> 
 <p>全窗口函数和增量聚合的结合使用，每当对应的key分区有数据到来时，使用聚合函数对数据进行处理，当窗口结束时，将数据的处理结果传递给全窗口函数，交给全窗口函数进行处理。</p> 
</blockquote> 
<blockquote> 
 <p>增量聚合:来一条数据计算一条，存储数据的中间计算结果，占用的空间资源少。<br> 全窗口函数:能够通过上下文实现灵活的功能。</p> 
</blockquote> 
<blockquote> 
 <p>窗口的触发时间:<br> 时间进展(窗口的创建时间开始的时间进展) &gt;=窗口最大时间戳-1ms<br> 窗口的划分:<br> start = 向下取整,取窗口长度的整数倍<br> end = start + 窗口长度<br> <strong>窗口是左闭右开的</strong></p> 
</blockquote> 
<h3><a id="4_278"></a>4.窗口的生命周期</h3> 
<p>窗口的生命周期包括四个阶段：窗口分配、窗口触发、窗口计算和窗口清除。</p> 
<p><strong>窗口的分配和触发:</strong><br> 当一个元素被分配到一个窗口中时，该窗口就会被创建并开始等待后续的元素。当窗口中的元素数量达到指定的阈值或者窗口的时间戳超过了指定的时间范围时，该窗口就会被触发，对窗口中的元素进行计算和聚合。因此，<strong>窗口的生成是在数据流中有新元素到达时动态进行的</strong>。</p> 
<blockquote> 
 <p>创建: 属于本窗口的第一条数据到来的时候,窗口将被创建并放入singleton单例集合中</p> 
</blockquote> 
<p><strong>窗口的清除:</strong><br> 当一个窗口被触发计算完成后，窗口中的元素会被清除，并且该窗口的状态也会被清除。如果一个窗口在指定的时间范围内没有被触发，那么该窗口也会被清除。窗口的清除是由窗口清除器（Window Evictor）来控制的。窗口清除器会根据指定的清除策略，定期地检查窗口中的元素，并将过期的元素从窗口中删除，以保证窗口中的元素数量不会无限增长。因此，窗口的销毁是在窗口清除阶段进行的，以释放窗口占用的资源和内存。</p> 
<blockquote> 
 <p>销毁: 时间进展=&gt;窗口最大时间戳(end-1ms)+运行迟到的时间(默认0)<br> 默认情况下销毁和关窗是同时的,但是这是两个不同的操作，flink允许窗口的延迟关闭。</p> 
</blockquote> 
<h2><a id="_291"></a>三、时间语义和水位线</h2> 
<h3><a id="1_292"></a>1.时间语义的选择</h3> 
<p><img src="https://images2.imgbox.com/6f/9b/dTvzQka2_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>一条数据的生成时间和处理时间是有区别的，一条数据从生成到被处理可能需要消耗几秒的时间差，对于分时统计而言，如果按照处理时间为衡量标准，那么该条数据有可能会被分配到错误的时间段。</p> 
</blockquote> 
<p><strong>数据处理系统中的时间语义</strong></p> 
<p>在实际应用中，事件时间语义会更为常见。一般情况下，业务日志数据中都会记录数据生成的时间戳（timestamp），它就可以作为事件时间的判断基础。<br> 在Flink中，由于处理时间比较简单，早期版本默认的时间语义是处理时间；而考虑到事件时间在实际应用中更为广泛，从Flink1.12版本开始，<strong>Flink已经将事件时间作为默认的时间语义了</strong>。</p> 
<blockquote> 
 <p>使用数据的时间作为逻辑时间，让计算脱离系统时间。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/46/3d/mDvdJCok_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="1Watermark_305"></a>1.水位线（Watermark）</h3> 
<p>在Flink中，用来衡量事件时间进展的标记，就被称作“水位线”（Watermark）。<br> 具体实现上，水位线可以看作一条特殊的数据记录，它是插入到数据流中的一个标记点，主要内容就是一个时间戳，用来指示当前的事件时间。而它插入流中的位置，就应该是在某个数据到来之后；这样就可以从这个数据中提取时间戳，作为当前水位线的时间戳了。<br> <img src="https://images2.imgbox.com/2a/a4/RwY63VNE_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>实际生成过程中，无法保证生成的数据是有序流</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/d4/1a/9PTgQ98x_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/2c/48/3YdZBD7T_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>假如存在一个时间长度为10秒的滚动窗口，正常情况下会在时间戳是10s的数据到来后窗口触发计算，但是考虑到网络延迟问题，<strong>有可能存在10秒的数据比8秒的数据先行到达，因此我们将当前水位线在数据时间戳的基础上增加延迟，来保证数据的不丢失。</strong></p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/43/e1/zNHpecJr_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3_318"></a>3.水位线和窗口的工作原理</h3> 
<p><img src="https://images2.imgbox.com/d4/48/1Vi9JjJy_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/28/53/QnqwHWsI_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>每个窗口都是相互独立的，<strong>水位线的更新是参考当前数据流中时间戳最大的数据</strong>，<strong>窗口关闭的参考标准是水位线(时间进展)</strong>，<strong>数据的分配是按照数据时间戳的向下取整进行分配的</strong>，时间窗口和水位线和数据时间可以看作是三条独立的线。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/02/a8/mYOyfiCg_o.png" alt="在这里插入图片描述"><br> Flink中窗口并不是静态准备好的，而是动态创建——当有落在这个窗口区间范围的数据达到时，才创建对应的窗口。另外，这里我们认为到达窗口结束时间时，窗口就触发计算并关闭，事实上“触发计算”和“窗口关闭”两个行为也可以分开。</p> 
<blockquote> 
 <p><strong>简单理解:窗口(桶)是提前准备好的，数据根据其事件时间自动分配到对应的桶中，真正的计算需要等到水位线推进到闭窗时间。</strong></p> 
</blockquote> 
<h3><a id="4_329"></a>4.生成水位线</h3> 
<p>完美的水位线是“绝对正确”的，也就是一个水位线一旦出现，就表示这个时间之前的数据已经全部到齐、之后再也不会出现了。不过如果要保证绝对正确，就必须等足够长的时间，这会带来更高的延迟。</p> 
<p>如果我们希望处理得更快、实时性更强，那么可以将<strong>水位线延迟设得低一些</strong>。这种情况下，可能很多迟到数据会在水位线之后才到达，就会<strong>导致窗口遗漏数据</strong>，计算结果不准确。当然，如果我们对准确性完全不考虑、一味地追求处理速度，可以直接使用处理时间语义，这在理论上可以得到最低的延迟。</p> 
<p>所以Flink中的水位线，其实是流处理中对低延迟和结果正确性的一个权衡机制，而且把控制的权力交给了程序员，我们可以在代码中定义水位线的生成策略。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WatermarkOutOfOrdermessDemo</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WaterSensor</span><span class="token punctuation">&gt;</span></span> sensorDS <span class="token operator">=</span> env
                <span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">7777</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WaterSensorMapFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//todo 定制水位线策略</span>
        <span class="token class-name">WatermarkStrategy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WaterSensor</span><span class="token punctuation">&gt;</span></span> watermarkStrategy <span class="token operator">=</span> <span class="token class-name">WatermarkStrategy</span>
                <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
                <span class="token function">forMonotonousTimestamps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//有序流</span>
                <span class="token function">forBoundedOutOfOrderness</span><span class="token punctuation">(</span>等待时间<span class="token punctuation">)</span> <span class="token comment">//乱序流</span>
                <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
                <span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WaterSensor</span><span class="token punctuation">&gt;</span></span><span class="token function">forMonotonousTimestamps</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">//指定时间戳分配器</span>
                <span class="token punctuation">.</span><span class="token function">withTimestampAssigner</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SerializableTimestampAssigner</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WaterSensor</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">extractTimestamp</span><span class="token punctuation">(</span><span class="token class-name">WaterSensor</span> waterSensor<span class="token punctuation">,</span> <span class="token keyword">long</span> l<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"数据="</span> <span class="token operator">+</span> waterSensor <span class="token operator">+</span> <span class="token string">",recordTS="</span> <span class="token operator">+</span> l<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> waterSensor<span class="token punctuation">.</span><span class="token function">getTs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000L</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WaterSensor</span><span class="token punctuation">&gt;</span></span> sensorWithWaterMark <span class="token operator">=</span> sensorDS
                <span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span>watermarkStrategy<span class="token punctuation">)</span><span class="token punctuation">;</span>
        sensorWithWaterMark
                <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>value <span class="token operator">-&gt;</span> value<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">TumblingEventTimeWindows</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>
                        <span class="token keyword">new</span> <span class="token class-name">ProcessWindowFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WaterSensor</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">TimeWindow</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token annotation punctuation">@Override</span>
                            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WaterSensor</span><span class="token punctuation">&gt;</span></span> iterable<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> collector<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token comment">//使用上下文获取窗口信息</span>
                                <span class="token keyword">long</span> start <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//获取窗口开始时间</span>
                                <span class="token keyword">long</span> end <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//获取窗口结束时间</span>
                                <span class="token class-name">String</span> windowStart <span class="token operator">=</span> <span class="token class-name">DateFormatUtils</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> <span class="token string">"yyyy-MM-dd HH:mm:ss.SSS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token class-name">String</span> windowEnd <span class="token operator">=</span> <span class="token class-name">DateFormatUtils</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>end<span class="token punctuation">,</span> <span class="token string">"yyyy-MM-dd HH:mm:ss.SSS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">long</span> amount <span class="token operator">=</span> iterable<span class="token punctuation">.</span><span class="token function">spliterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">estimateSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取数据条数</span>
                                collector<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token string">"key="</span><span class="token operator">+</span>s<span class="token operator">+</span><span class="token string">"的窗口["</span><span class="token operator">+</span>windowStart<span class="token operator">+</span><span class="token string">"-"</span><span class="token operator">+</span>windowEnd<span class="token operator">+</span><span class="token string">")包含"</span>
                                                <span class="token operator">+</span>amount<span class="token operator">+</span><span class="token string">"条数据==&gt;"</span><span class="token operator">+</span>iterable<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>运行结果:<br> <img src="https://images2.imgbox.com/4f/01/cIsrz05O_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>使用水位线要求窗口为事件窗口，不能使用时间窗口。</p> 
</blockquote> 
<p><strong>Flink内置的Watermark生成原理</strong><br> 1.Watermark是真实存在的数据，不可能接收一条数据生成一次，因此是周期性生成，默认200ms<br> 2.有序流: watermark = 当前最大的事件时间 - 1ms<br> 3.乱序流: watermark = 当前最大的事件时间 - 延迟时间 - 1ms</p> 
<p><strong>自定义水位线生成器</strong></p> 
<p><strong>1.周期性水位线生成器（Periodic Generator）</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyPeriodWatermarkGenerator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">WatermarkGenerator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> delayTS<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> maxTS<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">MyPeriodWatermarkGenerator</span><span class="token punctuation">(</span><span class="token keyword">long</span> delayTS<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>delayTS <span class="token operator">=</span> delayTS<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>maxTS <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token constant">MIN_VALUE</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delayTS <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//TODO 每条数据到来时都会调用一次</span>
    <span class="token comment">//@params l 提取到的事件时间</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onEvent</span><span class="token punctuation">(</span><span class="token class-name">T</span> t<span class="token punctuation">,</span> <span class="token keyword">long</span> l<span class="token punctuation">,</span> <span class="token class-name">WatermarkOutput</span> watermarkOutput<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>maxTS<span class="token punctuation">,</span>l<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//todo 周期性调用，生成watermark</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onPeriodicEmit</span><span class="token punctuation">(</span><span class="token class-name">WatermarkOutput</span> watermarkOutput<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        watermarkOutput<span class="token punctuation">.</span><span class="token function">emitWatermark</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Watermark</span><span class="token punctuation">(</span>maxTS<span class="token operator">-</span>delayTS<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token comment">//设置水位线采集周期</span>
env<span class="token punctuation">.</span><span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAutoWatermarkInterval</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">WatermarkStrategy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WaterSensor</span><span class="token punctuation">&gt;</span></span> watermarkStrategy <span class="token operator">=</span> <span class="token class-name">WatermarkStrategy</span>
                <span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WaterSensor</span><span class="token punctuation">&gt;</span></span><span class="token function">forGenerator</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WatermarkGeneratorSupplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WaterSensor</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token class-name">WatermarkGenerator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WaterSensor</span><span class="token punctuation">&gt;</span></span> <span class="token function">createWatermarkGenerator</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPeriodWatermarkGenerator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">3000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>2.断点式水位线生成器（Punctuated Generator）</strong><br> 断点式生成器会不停地检测onEvent()中的事件，当发现带有水位线信息的事件时，就立即发出水位线。我们把发射水位线的逻辑写在onEvent方法当中即可。(每条数据都会记录水位线)</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onEvent</span><span class="token punctuation">(</span><span class="token class-name">T</span> t<span class="token punctuation">,</span> <span class="token keyword">long</span> l<span class="token punctuation">,</span> <span class="token class-name">WatermarkOutput</span> watermarkOutput<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>maxTS<span class="token punctuation">,</span>l<span class="token punctuation">)</span><span class="token punctuation">;</span>
        watermarkOutput<span class="token punctuation">.</span><span class="token function">emitWatermark</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Watermark</span><span class="token punctuation">(</span>maxTS<span class="token operator">-</span>delayTS<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><strong>3.在数据源中发送水位线</strong></p> 
<pre><code class="prism language-java">env<span class="token punctuation">.</span><span class="token function">fromSource</span><span class="token punctuation">(</span><span class="token class-name">KafkaSource</span><span class="token punctuation">,</span><span class="token class-name">WatermarkStrategy</span><span class="token punctuation">.</span><span class="token function">forBoundedOutOfOrderness</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>在数据源中使用了水位线后，就不再运行再次使用水位线。</p> 
</blockquote> 
<h3><a id="5_450"></a>5.水位线的传递</h3> 
<p>Flink每个算子都有自己的水位线，事件时钟并不相同。<br> <img src="https://images2.imgbox.com/14/12/SbedAuC5_o.png" alt="在这里插入图片描述"><br> 在流处理中，上游任务处理完水位线、时钟改变之后，要把当前的水位线再次发出，<strong>广播给所有的下游子任务</strong>。<strong>而当一个任务接收到多个上游并行任务传递来的水位线时，应该以上游任务中最小的那个作为当前任务的事件时钟</strong>。</p> 
<blockquote> 
 <p>即使上游和下游算子的关系是1对多，上游数据只会发送到下游的一个分区中，watermark也会广播到所有的下游分区中。</p> 
</blockquote> 
<p>水位线在上下游任务之间的传递，非常巧妙地避免了分布式系统中没有统一时钟的问题，<strong>每个任务都以“处理完之前所有数据”为标准来确定自己的时钟。</strong></p> 
<blockquote> 
 <p>因为并行度的原因，数据是流式处理的，算子之间的水位线是存在差异的，watermark在生成后会跟随数据一起传递，因此<strong>水位线代表的是某一结点的进度</strong>。<br> 例如; source-&gt;map(生成水位线)-&gt;process-&gt;print<br> source处理数据2的时候，print的正在处理数据1</p> 
</blockquote> 
<blockquote> 
 <p>在多并行度下，窗口的关闭可能不是当临界watermark到来的时候，因为有可能临界watermark和别的watermark同时到来，flink会取最小的watermark作为当前任务的水位线，只有当临界wateramrk为到来的watermark中最小时，窗口才会触发。</p> 
</blockquote> 
<p><strong>空闲等待时间</strong><br> 在多个上游并行任务中，如果有其中一个没有数据，由于当前Task是以最小的那个作为当前任务的事件时钟，就会导致当前Task的水位线无法推进，就可能导致窗口无法触发。这时候可以设置空闲等待。</p> 
<pre><code class="prism language-java"><span class="token class-name">WatermarkStrategy</span><span class="token punctuation">.</span><span class="token function">withIdlenness</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSecond</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<blockquote> 
 <p>时间窗口的水位线是参考所有上游任务发送的最小的水位线的，如果存在一个上游任务一直没有数据发送，那么该上游任务的水位线为Long的最小值，窗口将无法触发，所以设置空闲等待时间；<br> 在空闲等待时间过后，如果该上游一直没有水位线推送，窗口将不再参考这个上游任务的水位线。</p> 
</blockquote> 
<h3><a id="6_475"></a>6.迟到数据的处理</h3> 
<p><strong>1.设置窗口的延迟关闭</strong></p> 
<pre><code class="prism language-java">sensorWithWaterMark
                <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>value <span class="token operator">-&gt;</span> value<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">TumblingEventTimeWindows</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">allowedLateness</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//延迟关窗</span>
</code></pre> 
<blockquote> 
 <p>窗口的触发计算和窗口关闭是两个不同的操作，使用allowedLatenessAIP设置窗口的推迟关闭，即使水位线触发了关窗，因为设置的推迟关窗，窗口只会触发计算，之后属于该窗口的迟到数据到来后仍会<strong>立即</strong>触发计算，只有水位线到达延迟关窗时间后窗口才会真正关闭。</p> 
</blockquote> 
<p><strong>2.使用侧流接收迟到的数据</strong></p> 
<pre><code class="prism language-java"><span class="token class-name">OutputTag</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WaterSensor</span><span class="token punctuation">&gt;</span></span> lateTag <span class="token operator">=</span> 
	<span class="token keyword">new</span> <span class="token class-name">OutputTag</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"late-data"</span><span class="token punctuation">,</span> <span class="token class-name">Types</span><span class="token punctuation">.</span><span class="token function">POJO</span><span class="token punctuation">(</span><span class="token class-name">WaterSensor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sensorWithWaterMark
                <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>value <span class="token operator">-&gt;</span> value<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">TumblingEventTimeWindows</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">allowedLateness</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">sideOutputLateData</span><span class="token punctuation">(</span>lateTag<span class="token punctuation">)</span>
</code></pre> 
<blockquote> 
 <p>窗口关闭后到来的迟到严重的数据会放入测输出流中</p> 
</blockquote> 
<p><strong>值得注意的是:</strong><br> 如果watermark等待3s，窗口允许迟到2s，为什么不直接watermark等待5s或者窗口允许迟到5s？</p> 
<blockquote> 
 <p>如果watermark等待时间设置太长，会影响计算的延迟，结果的输出会延后<br> 如果窗口允许迟到时间设置太长，会导致窗口频繁输出</p> 
</blockquote> 
<blockquote> 
 <p>窗口的允许迟到一般只考虑大部分迟到数据，一些迟到很久的数据可以放到测输出流中进行处理</p> 
</blockquote> 
<h2><a id="_509"></a>四、双流结合</h2> 
<h3><a id="1Join_510"></a>1.基于时间的合流——双流联结（Join）</h3> 
<p>可以发现，根据某个key合并两条流，与关系型数据库中表的join操作非常相近。事实上，Flink中两条流的connect操作，就可以通过keyBy指定键进行分组后合并，实现了类似于SQL中的join操作；另外connect支持处理函数，可以使用自定义实现各种需求，其实已经能够处理双流join的大多数场景。</p> 
<p>不过处理函数是底层接口，所以尽管connect能做的事情多，但在一些具体应用场景下还是显得太过抽象了。比如，如果我们希望统计固定时间内两条流数据的匹配情况，那就需要自定义来实现——其实这完全可以用窗口（window）来表示。为了更方便地实现基于时间的合流操作，Flink的DataStrema API提供了内置的join算子。</p> 
<p><strong>窗口联结（Window Join）</strong><br> Flink为基于一段时间的双流合并专门提供了一个窗口联结算子，可以定义时间窗口，并将两条流中共享一个公共键（key）的数据放在窗口中进行配对处理。</p> 
<blockquote> 
 <p>一个程序中，两条流数据的keyBy算子会将key相同的数据发送往同一个子任务(分区)</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WindowJoinDemo</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> ds1 <span class="token operator">=</span> env
                <span class="token punctuation">.</span><span class="token function">fromElements</span><span class="token punctuation">(</span>
                        <span class="token class-name">Tuple2</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token class-name">Tuple2</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token class-name">Tuple2</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token class-name">Tuple2</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"c"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token class-name">Tuple2</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token class-name">WatermarkStrategy</span>
                        <span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token function">forMonotonousTimestamps</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">withTimestampAssigner</span><span class="token punctuation">(</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> ts<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> value<span class="token punctuation">.</span>f1 <span class="token operator">*</span> <span class="token number">1000L</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple3</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">,</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> ds2 <span class="token operator">=</span> env
                <span class="token punctuation">.</span><span class="token function">fromElements</span><span class="token punctuation">(</span>
                        <span class="token class-name">Tuple3</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token class-name">Tuple3</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token class-name">Tuple3</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token class-name">Tuple3</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"c"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token class-name">Tuple3</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token class-name">WatermarkStrategy</span>
                        <span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple3</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">,</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token function">forMonotonousTimestamps</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">withTimestampAssigner</span><span class="token punctuation">(</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> ts<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> value<span class="token punctuation">.</span>f1 <span class="token operator">*</span> <span class="token number">1000L</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//todo window join</span>
        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> join <span class="token operator">=</span> ds1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>ds2<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>r1 <span class="token operator">-&gt;</span> r1<span class="token punctuation">.</span>f0<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">equalTo</span><span class="token punctuation">(</span>r2 <span class="token operator">-&gt;</span> r2<span class="token punctuation">.</span>f0<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">TumblingEventTimeWindows</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JoinFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Tuple3</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token comment">//todo join(ds1的数据,ds2的数据)</span>
                    <span class="token comment">//关联上的数据会调用join方法</span>
                    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">join</span><span class="token punctuation">(</span><span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> stringIntegerTuple2<span class="token punctuation">,</span> <span class="token class-name">Tuple3</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> stringIntegerIntegerTuple3<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">return</span> stringIntegerTuple2 <span class="token operator">+</span> <span class="token string">"&lt;---------&gt;"</span> <span class="token operator">+</span> stringIntegerIntegerTuple3<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        join<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>结果<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
<span class="token punctuation">(</span>a<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-&gt;</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span>a<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-&gt;</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span>b<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-&gt;</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span>c<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-&gt;</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span>b<span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-&gt;</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span>
</code></pre> 
<p>其实仔细观察可以发现，窗口join的调用语法和我们熟悉的SQL中表的join非常相似：</p> 
<p>SELECT * FROM table1 t1, table2 t2 WHERE t1.id = t2.id;</p> 
<p>这句SQL中where子句的表达，等价于inner join … on，所以本身表示的是两张表基于id的“内连接”（inner join）。而Flink中的window join，同样类似于inner join。也就是说，最后处理输出的，只有两条流中数据按key配对成功的那些；如果某个窗口中一条流的数据没有任何另一条流的数据匹配，那么就不会调用JoinFunction的.join()方法，也就没有任何输出了。</p> 
<blockquote> 
 <p>只有key相同并且属于同一时间窗口内的数据才能相互匹配，window join不推荐使用，因为数据必须在一个窗口内才能够进行匹配，一些外部原因可能会使数据原来能匹配的数据被另一个窗口处理。</p> 
</blockquote> 
<h3><a id="2Interval_Join_587"></a>2.间隔联结（Interval Join）</h3> 
<p>在有些场景下，我们要处理的时间间隔可能并不是固定的。这时显然不应该用滚动窗口或滑动窗口来处理——因为匹配的两个数据有可能刚好“卡在”<strong>窗口边缘两侧</strong>，于是窗口内就都没有匹配了；会话窗口虽然时间不固定，但也明显不适合这个场景。基于时间的窗口联结已经无能为力了。</p> 
<p>为了应对这样的需求，Flink提供了一种叫作“间隔联结”（interval join）的合流操作。顾名思义，间隔联结的思路就是针对一条流的每个数据，开辟出其时间戳前后的一段时间间隔，看这期间是否有来自另一条流的数据匹配。</p> 
<p><strong>间隔联结的原理</strong><br> 间隔联结具体的定义方式是，我们给定两个时间点，分别叫作间隔的“上界”（upperBound）和“下界”（lowerBound）；于是对于一条流（不妨叫作A）中的任意一个数据元素a，就可以开辟一段时间间隔：[a.timestamp + lowerBound, a.timestamp + upperBound],即以a的时间戳为中心，下至下界点、上至上界点的一个闭区间：我们就把这段时间作为可以匹配另一条流数据的“窗口”范围。所以对于另一条流（不妨叫B）中的数据元素b，如果它的时间戳落在了这个区间范围内，a和b就可以成功配对，进而进行计算输出结果。所以匹配的条件为：<br> a.timestamp + lowerBound &lt;= b.timestamp &lt;= a.timestamp + upperBound<br> 这里需要注意，做间隔联结的两条流A和B，也必须基于相同的key；下界lowerBound应该小于等于上界upperBound，两者都可正可负；<strong>间隔联结目前只支持事件时间语义</strong>。<br> 如下图所示，我们可以清楚地看到间隔联结的方式：<br> <img src="https://images2.imgbox.com/7d/49/wAlDbcvX_o.png" alt="在这里插入图片描述"><br> 下方的流A去间隔联结上方的流B，所以基于A的每个数据元素，都可以开辟一个间隔区间。我们这里设置下界为-2毫秒，上界为1毫秒。于是对于时间戳为2的A中元素，它的可匹配区间就是[0, 3],流B中有时间戳为0、1的两个元素落在这个范围内，所以就可以得到匹配数据对（2, 0）和（2, 1）。同样地，A中时间戳为3的元素，可匹配区间为[1, 4]，B中只有时间戳为1的一个数据可以匹配，于是得到匹配数据对（3, 1）。</p> 
<blockquote> 
 <p>只支持事件时间<br> 指定上界,下届的偏移，负号代表时间往前，正号代表时间往后<br> 两条流关联后的的watermark,以两条流中最小的为准<br> 如果当前数据的事件事件 &lt; 当前的watermark，就是迟到数据，主流不处理，可以放入测输出流中。</p> 
</blockquote>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/025d95b0be4611758bbb075a416f7f73/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">如何更加完善的封装axios请求：防抖拦截、无感刷新token、各环境baseUrl配置等</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/665bbfe23e264407079c3a942f199947/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">第七版教材下的PMP考试有多难？</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>