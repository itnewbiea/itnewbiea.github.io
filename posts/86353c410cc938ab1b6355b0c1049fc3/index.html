<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>新一代爬取JavaScript渲染页面的利器-playwright（二） - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="新一代爬取JavaScript渲染页面的利器-playwright（二）" />
<meta property="og:description" content="接上文：新一代爬取JavaScript渲染页面的利器-playwright（一）
上文我们主要讲了Playwright的特点、安装、基本使用、代码生成的使用以及模拟移动端浏览，这篇我们主要讲下Playwright的选择器以及常见的操作方法。
6.选择器 我们可以把传入的字符串称为Element Selector，除了它已经支持的CSS选择器、XPath，Playwright还为它拓展了一些方便好用的规则，例如直接根据文本内容筛选，根据节点的层级结构筛选等。
文本选择 文本选择支持text=这样的语句进行筛选，例如：
page.click(“text=Log in”)
该句代表点击文本内容是Log in的节点
CSS选择器 例如根据id/class筛选：
page.click(“button”)
page.click(“nav-bar .contact-us-item”)
根据特定的节点属性进行筛选：
page.click(“[data-test-login-button]”)
page.click(“[aria-label=‘Sign in’]”)
CSS选择器&#43;文本值 常用的方法是has-text和text，前者代表节点中包含指定的字符串，后者代表节点中的文本值和指定的字符串完全匹配，示例如下：
page.click(“article:has-text(‘playwright’)”)
page.click(“#nav-bar :text(‘Contact us’)”)
CSS选择器&#43;节点关系 CSS选择器还可以结合文本关系来筛选节点，例如指定另一个选择器，示例如下：
page.click(“.item-description:has(.item-promo-banner)”)
这里选择的就是class为item-description的节点，且该节点还要包含class为item-promo-banner的子节点。
另外还可以结合一些相对位置关系，例如使用right-of指定位于某个节点右侧的节点。
page.click(“input:right-of(:text(‘Username’))”)
这里选择的就是一个input节点，并且该节点要位于Username的节点的右侧。
XPath XPath也是支持的，不过是xpath关键字需要我们自己来指定，示例如下：
page.click(“xpath=//button”)
7.常用操作方法 下面介绍些一些常用的操作方法。例如click(点击)，fill(输入)等等，这些方法都属于page对象，所有方法都可以从page对象的API文档查找。
下面介绍几个常见的操作方法的用法。
事件监听 page对象提供一个on方法，用来监听页面中发生的各个事件，例如close，console，load，request，response等。
这里我们监听response事件，在每次页面请求得到相应的时候会触发这个事件，我们可以设置回调方法来获取响应中的全部信息，示例如下：
from playwright.sync_api import sync_playwright def on_response(response): print(f&#39;State{response.status}:{response.url}&#39;) with sync_playwright() as p: browser = p.chromium.launch(headless=False) page = browser.new_page() page.on(&#39;response&#39;,on_response) page.goto(&#39;https://spa6.scrape.center&#39;) page.wait_for_load_state(&#39;networkidle&#39;) browser.close() 可以看到输出结果如下；
我们在创建page对象后，就开始监听response事件，同时将回调方法设置为on_response，其接收一个参数，然后输出响应中的状态码和链接。
如果观察网页请求包内容可以发现，这个输出结果正好对应浏览器network中所有的请求和响应。
这个网站的真实的数据都是Ajax加载的，同时Ajax请求中还带有加密参数，不容易轻易获取。但是有了on_response方法，如果我们想截取Ajax请求，是非常容易的。
from playwright.sync_api import sync_playwright def on_response(response): if &#39;/api/movie&#39; in response." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/86353c410cc938ab1b6355b0c1049fc3/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-04T17:22:02+08:00" />
<meta property="article:modified_time" content="2024-01-04T17:22:02+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">新一代爬取JavaScript渲染页面的利器-playwright（二）</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><strong><a href="https://blog.csdn.net/chen626721/article/details/135278402">接上文：新一代爬取JavaScript渲染页面的利器-playwright（一）</a></strong><br>   上文我们主要讲了Playwright的特点、安装、基本使用、代码生成的使用以及模拟移动端浏览，这篇我们主要讲下Playwright的选择器以及常见的操作方法。</p> 
<h3><a id="6_2"></a>6.选择器</h3> 
<p>  我们可以把传入的字符串称为Element Selector，除了它已经支持的CSS选择器、XPath，Playwright还为它拓展了一些方便好用的规则，例如直接根据文本内容筛选，根据节点的层级结构筛选等。</p> 
<ul><li>文本选择</li></ul> 
<p>  文本选择支持text=这样的语句进行筛选，例如：</p> 
<blockquote> 
 <p>page.click(“text=Log in”)</p> 
</blockquote> 
<p>  该句代表点击文本内容是Log in的节点</p> 
<ul><li>CSS选择器</li></ul> 
<p>  例如根据id/class筛选：</p> 
<blockquote> 
 <p>page.click(“button”)<br> page.click(“nav-bar .contact-us-item”)</p> 
</blockquote> 
<p>  根据特定的节点属性进行筛选：</p> 
<blockquote> 
 <p>page.click(“[data-test-login-button]”)<br> page.click(“[aria-label=‘Sign in’]”)</p> 
</blockquote> 
<ul><li>CSS选择器+文本值</li></ul> 
<p>  常用的方法是has-text和text，前者代表节点中包含指定的字符串，后者代表节点中的文本值和指定的字符串完全匹配，示例如下：</p> 
<blockquote> 
 <p>page.click(“article:has-text(‘playwright’)”)<br> page.click(“#nav-bar :text(‘Contact us’)”)</p> 
</blockquote> 
<ul><li>CSS选择器+节点关系</li></ul> 
<p>  CSS选择器还可以结合文本关系来筛选节点，例如指定另一个选择器，示例如下：</p> 
<blockquote> 
 <p>page.click(“.item-description:has(.item-promo-banner)”)</p> 
</blockquote> 
<p>  这里选择的就是class为item-description的节点，且该节点还要包含class为item-promo-banner的子节点。<br>   另外还可以结合一些相对位置关系，例如使用right-of指定位于某个节点右侧的节点。</p> 
<blockquote> 
 <p>page.click(“input:right-of(:text(‘Username’))”)</p> 
</blockquote> 
<p>  这里选择的就是一个input节点，并且该节点要位于Username的节点的右侧。</p> 
<ul><li>XPath</li></ul> 
<p>  XPath也是支持的，不过是xpath关键字需要我们自己来指定，示例如下：</p> 
<blockquote> 
 <p>page.click(“xpath=//button”)</p> 
</blockquote> 
<h3><a id="7_51"></a>7.常用操作方法</h3> 
<p>  下面介绍些一些常用的操作方法。例如click(点击)，fill(输入)等等，这些方法都属于page对象，所有方法都可以从page对象的<a href="https://playwright.dev/python/docs/api/class-page" rel="nofollow">API文档</a>查找。<br>   下面介绍几个常见的操作方法的用法。</p> 
<ul><li>事件监听</li></ul> 
<p>  page对象提供一个on方法，用来监听页面中发生的各个事件，例如close，console，load，request，response等。<br>   这里我们监听response事件，在每次页面请求得到相应的时候会触发这个事件，我们可以设置回调方法来获取响应中的全部信息，示例如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> playwright<span class="token punctuation">.</span>sync_api <span class="token keyword">import</span> sync_playwright

<span class="token keyword">def</span> <span class="token function">on_response</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'State</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>response<span class="token punctuation">.</span>status<span class="token punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>response<span class="token punctuation">.</span>url<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>

<span class="token keyword">with</span> sync_playwright<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> p<span class="token punctuation">:</span>
    browser <span class="token operator">=</span> p<span class="token punctuation">.</span>chromium<span class="token punctuation">.</span>launch<span class="token punctuation">(</span>headless<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    page <span class="token operator">=</span> browser<span class="token punctuation">.</span>new_page<span class="token punctuation">(</span><span class="token punctuation">)</span>
    page<span class="token punctuation">.</span>on<span class="token punctuation">(</span><span class="token string">'response'</span><span class="token punctuation">,</span>on_response<span class="token punctuation">)</span>
    page<span class="token punctuation">.</span>goto<span class="token punctuation">(</span><span class="token string">'https://spa6.scrape.center'</span><span class="token punctuation">)</span>
    page<span class="token punctuation">.</span>wait_for_load_state<span class="token punctuation">(</span><span class="token string">'networkidle'</span><span class="token punctuation">)</span>
    browser<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>  可以看到输出结果如下；<br> <img src="https://images2.imgbox.com/3f/c7/J5Nn7vzd_o.png" alt="在这里插入图片描述"></p> 
<p>  我们在创建page对象后，就开始监听response事件，同时将回调方法设置为on_response，其接收一个参数，然后输出响应中的状态码和链接。<br>   如果观察网页请求包内容可以发现，这个输出结果正好对应浏览器network中所有的请求和响应。<br>   这个网站的真实的数据都是Ajax加载的，同时Ajax请求中还带有加密参数，不容易轻易获取。但是有了on_response方法，如果我们想截取Ajax请求，是非常容易的。</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> playwright<span class="token punctuation">.</span>sync_api <span class="token keyword">import</span> sync_playwright

<span class="token keyword">def</span> <span class="token function">on_response</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token string">'/api/movie'</span> <span class="token keyword">in</span> response<span class="token punctuation">.</span>url <span class="token keyword">and</span> response<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>json<span class="token punctuation">)</span>


<span class="token keyword">with</span> sync_playwright<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> p<span class="token punctuation">:</span>
    browser <span class="token operator">=</span> p<span class="token punctuation">.</span>chromium<span class="token punctuation">.</span>launch<span class="token punctuation">(</span>headless<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    page <span class="token operator">=</span> browser<span class="token punctuation">.</span>new_page<span class="token punctuation">(</span><span class="token punctuation">)</span>
    page<span class="token punctuation">.</span>on<span class="token punctuation">(</span><span class="token string">'response'</span><span class="token punctuation">,</span>on_response<span class="token punctuation">)</span>
    page<span class="token punctuation">.</span>goto<span class="token punctuation">(</span><span class="token string">'https://spa6.scrape.center'</span><span class="token punctuation">)</span>
    page<span class="token punctuation">.</span>wait_for_load_state<span class="token punctuation">(</span><span class="token string">'networkidle'</span><span class="token punctuation">)</span>
    browser<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>  可以看到我们通过on_response方法拦截了Ajax请求，直接拿到了响应结果，即使这个Ajax请求中有加密参数也不用担心，因为这里截获的是最后的请求结果。</p> 
<ul><li>获取页面源代码</li></ul> 
<p>  调用page对象的content方法可以获取网页源码。</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> playwright<span class="token punctuation">.</span>sync_api <span class="token keyword">import</span> sync_playwright

<span class="token keyword">with</span> sync_playwright<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> p<span class="token punctuation">:</span>
    browser <span class="token operator">=</span> p<span class="token punctuation">.</span>chromium<span class="token punctuation">.</span>launch<span class="token punctuation">(</span>headless<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    page <span class="token operator">=</span> browser<span class="token punctuation">.</span>new_page<span class="token punctuation">(</span><span class="token punctuation">)</span>
    page<span class="token punctuation">.</span>goto<span class="token punctuation">(</span><span class="token string">'https://spa6.scrape.center'</span><span class="token punctuation">)</span>
    page<span class="token punctuation">.</span>wait_for_load_state<span class="token punctuation">(</span><span class="token string">'networkidle'</span><span class="token punctuation">)</span>
    html <span class="token operator">=</span> page<span class="token punctuation">.</span>content<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span>
    browser<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>  运行结果就是页面源代码，然后可以再利用一些解析工具就可以提取到想要的信息了。</p> 
<ul><li>页面点击</li></ul> 
<p>  实现页面点击的方法就是click方法，click方法的API定义如下：</p> 
<blockquote> 
 <p>page.click(selector,**kwargs)</p> 
</blockquote> 
<p>  其中，必须传入的数据是selector，其他参数都是可选的。selector代表选择器，用来匹配想要点击的节点，如果有多个节点都匹配，只使用第一个。<br>   其他比较重要的参数如下：</p> 
<ul><li class="task-list-item"> <p><input type="checkbox" class="task-list-item-checkbox" disabled> click_count:点击次数，默认为1.</p> </li><li class="task-list-item"> <p><input type="checkbox" class="task-list-item-checkbox" disabled> timeout:等待找到要点击节点的超时的时间，默认为30秒。</p> </li><li class="task-list-item"> <p><input type="checkbox" class="task-list-item-checkbox" disabled> position:需要传入如一个字典，要带有x和y属性，代表点击位置相对节点左上角的偏移量。</p> </li><li class="task-list-item"> <p><input type="checkbox" class="task-list-item-checkbox" disabled> force:即使按钮设置了不可点击，也要强制点击，默认是False。</p> </li><li> <p>文本输入</p> </li></ul> 
<p>  文本输入对应的方法是fill，其API定义如下：</p> 
<blockquote> 
 <p>page.fill(selector,value,**kwargs)</p> 
</blockquote> 
<p>  第一个selector代表选择器，value代表输入的内容，还可以通过timeout参数查找对应节点的最长等待时间。</p> 
<ul><li>获取节点属性</li></ul> 
<p>  除了操作节点本身，我们也可以获得节点的属性，方法是get_attribute。</p> 
<blockquote> 
 <p>page.get_attribute(selector,name,**kwargs)<br>   这个有两个必传参数，selector和name，name代表要获取属性的名称。示例如下：</p> 
</blockquote> 
<pre><code class="prism language-python"><span class="token keyword">from</span> playwright<span class="token punctuation">.</span>sync_api <span class="token keyword">import</span> sync_playwright

<span class="token keyword">with</span> sync_playwright<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> p<span class="token punctuation">:</span>
    browser <span class="token operator">=</span> p<span class="token punctuation">.</span>chromium<span class="token punctuation">.</span>launch<span class="token punctuation">(</span>headless<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    page <span class="token operator">=</span> browser<span class="token punctuation">.</span>new_page<span class="token punctuation">(</span><span class="token punctuation">)</span>
    page<span class="token punctuation">.</span>goto<span class="token punctuation">(</span><span class="token string">'https://spa6.scrape.center'</span><span class="token punctuation">)</span>
    page<span class="token punctuation">.</span>wait_for_load_state<span class="token punctuation">(</span><span class="token string">'networkidle'</span><span class="token punctuation">)</span>
    href <span class="token operator">=</span> page<span class="token punctuation">.</span>get_attribute<span class="token punctuation">(</span><span class="token string">'a.name'</span><span class="token punctuation">,</span><span class="token string">'href'</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>href<span class="token punctuation">)</span>
    browser<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>  这里调用了get_attribute方法，传入的selector参数值是a.name，代表查找class为name的a的节点，name的参数传入了href，输出结果如下。</p> 
<blockquote> 
 <p>/detail/ZWYzNCN0ZXVxMGJ0dWEjKC01N3cxcTVvNS0takA5OHh5Z2ltbHlmeHMqLSFpLTAtbWIx</p> 
</blockquote> 
<p>  这里看到对应节点的href属性只输出了一条，因为如果匹配了多个节点，就只返回第一个。</p> 
<ul><li>获取多个节点</li></ul> 
<p>  对于获取所有节点，我们可以使用query_selector_all方法来获取。它会返回节点列表，通过遍历得到单个节点后，可以调用上面介绍的针对单个节点的方法完成一些操作和获取属性。示例如下：</p> 
<pre><code class="prism language-python"><span class="token comment"># 获取多个节点</span>
<span class="token keyword">from</span> playwright<span class="token punctuation">.</span>sync_api <span class="token keyword">import</span> sync_playwright

<span class="token keyword">with</span> sync_playwright<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> p<span class="token punctuation">:</span>
    browser <span class="token operator">=</span> p<span class="token punctuation">.</span>chromium<span class="token punctuation">.</span>launch<span class="token punctuation">(</span>headless<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    page <span class="token operator">=</span> browser<span class="token punctuation">.</span>new_page<span class="token punctuation">(</span><span class="token punctuation">)</span>
    page<span class="token punctuation">.</span>goto<span class="token punctuation">(</span><span class="token string">'https://spa6.scrape.center'</span><span class="token punctuation">)</span>
    page<span class="token punctuation">.</span>wait_for_load_state<span class="token punctuation">(</span><span class="token string">'networkidle'</span><span class="token punctuation">)</span>
    elements <span class="token operator">=</span> page<span class="token punctuation">.</span>query_selector_all<span class="token punctuation">(</span><span class="token string">'a.name'</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> element <span class="token keyword">in</span> elements<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>get_attribute<span class="token punctuation">(</span><span class="token string">'href'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>text_content<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    browser<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>  这里通过query_selector_all方法获取了所有可以匹配得到的节点，每个节点对应一个ElementHandle对象，然后通过该对象的get_attribute和text_content得到节点的属性和文本。运行结果如下：<br> <img src="https://images2.imgbox.com/72/fd/155zTRcR_o.png" alt="在这里插入图片描述"></p> 
<ul><li>获取单个节点</li></ul> 
<p>  多个节点用query_selector_all，那么单个节点自然就是query_selector，如果匹配到多个节点，那么就只返回第一个。<br> 示例如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> playwright<span class="token punctuation">.</span>sync_api <span class="token keyword">import</span> sync_playwright

<span class="token keyword">with</span> sync_playwright<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> p<span class="token punctuation">:</span>
    browser <span class="token operator">=</span> p<span class="token punctuation">.</span>chromium<span class="token punctuation">.</span>launch<span class="token punctuation">(</span>headless<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    page <span class="token operator">=</span> browser<span class="token punctuation">.</span>new_page<span class="token punctuation">(</span><span class="token punctuation">)</span>
    page<span class="token punctuation">.</span>goto<span class="token punctuation">(</span><span class="token string">'https://spa6.scrape.center'</span><span class="token punctuation">)</span>
    page<span class="token punctuation">.</span>wait_for_load_state<span class="token punctuation">(</span><span class="token string">'networkidle'</span><span class="token punctuation">)</span>
    element <span class="token operator">=</span> page<span class="token punctuation">.</span>query_selector<span class="token punctuation">(</span><span class="token string">'a.name'</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>get_attribute<span class="token punctuation">(</span><span class="token string">'href'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>text_content<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    browser<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>  运行后可以看到只返回了第一个节点的信息。</p> 
<ul><li>网络劫持</li></ul> 
<p>  利用route方法可以实现网络劫持和修改操作，例如修改request的属性，修改响应结果等。</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> playwright<span class="token punctuation">.</span>sync_api <span class="token keyword">import</span> sync_playwright
<span class="token keyword">import</span> re

<span class="token keyword">with</span> sync_playwright<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> p<span class="token punctuation">:</span>
    browser <span class="token operator">=</span> p<span class="token punctuation">.</span>chromium<span class="token punctuation">.</span>launch<span class="token punctuation">(</span>headless<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    page <span class="token operator">=</span> browser<span class="token punctuation">.</span>new_page<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">cancel_request</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        route<span class="token punctuation">.</span>abort<span class="token punctuation">(</span><span class="token punctuation">)</span>

    page<span class="token punctuation">.</span>route<span class="token punctuation">(</span>re<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span><span class="token string">r"(\.png)|(\.jpg)"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>cancel_request<span class="token punctuation">)</span>
    page<span class="token punctuation">.</span>goto<span class="token punctuation">(</span><span class="token string">'https://spa6.scrape.center'</span><span class="token punctuation">)</span>
    page<span class="token punctuation">.</span>wait_for_load_state<span class="token punctuation">(</span><span class="token string">'networkidle'</span><span class="token punctuation">)</span>
    page<span class="token punctuation">.</span>screenshot<span class="token punctuation">(</span>path<span class="token operator">=</span><span class="token string">'no_picture.png'</span><span class="token punctuation">)</span>
    browser<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>  这里调用了route方法，第一个参数通过正则表达式传入了URL路径，cancel_request 方法接收两个参数，一个是route，代表CallableRoute对象，另一个是request代表Request对象，这里我们直接调用CallableRoute对象的abort方法，取消了这次请求，导致最终的结果是取消全部图片的加载。结果截图如下图所示：<br> <img src="https://images2.imgbox.com/91/0f/khVENC1S_o.png" alt="在这里插入图片描述"><br>   我们在爬取的过程中只关心的是图片的url，图片是否加载出来并不重要，这样可以提高整个页面的加载速度，提高爬取效率。<br>   另外还可以利用这个功能对一些响应内容进行修改，例如我们可以将相应的结果直接修改为我们自定义的文本内容。<br>   我们先定义一个文本文件，命名demo.html，内容如下：</p> 
<pre><code class="prism language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Hack Response<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Hack Response<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>  代码编写如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> playwright<span class="token punctuation">.</span>sync_api <span class="token keyword">import</span> sync_playwright

<span class="token keyword">with</span> sync_playwright<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> p<span class="token punctuation">:</span>
    browser <span class="token operator">=</span> p<span class="token punctuation">.</span>chromium<span class="token punctuation">.</span>launch<span class="token punctuation">(</span>headless<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    page <span class="token operator">=</span> browser<span class="token punctuation">.</span>new_page<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">modify_response</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Modifying response for </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>request<span class="token punctuation">.</span>url<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        route<span class="token punctuation">.</span>fulfill<span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">"./demo.html"</span><span class="token punctuation">)</span>
        
    page<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'**/*'</span><span class="token punctuation">,</span> modify_response<span class="token punctuation">)</span>
    page<span class="token punctuation">.</span>goto<span class="token punctuation">(</span><span class="token string">'https://spa6.scrape.center'</span><span class="token punctuation">)</span>
    page<span class="token punctuation">.</span>wait_for_load_state<span class="token punctuation">(</span><span class="token string">'networkidle'</span><span class="token punctuation">)</span>

    browser<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<p>  这里我们使用callableRoute对象的fulfill方法指定了一个本地文件。<br> <img src="https://images2.imgbox.com/b4/d6/7czzxfWr_o.png" alt="在这里插入图片描述"><br>   这时可以看到响应结果已经被修改了，但是URL没有变，我们可以利用route方法，灵活的控制请求和响应的内容，从而在某些场景下达到某些目的。</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/30cf4d15ccb5df8fdbfec5a5bf1a2b42/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">OpenCV 安装概述</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/592d3b7c6fe004ad5679af5a58f958f8/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">新一代爬取JavaScript渲染页面的利器-playwright（一）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>