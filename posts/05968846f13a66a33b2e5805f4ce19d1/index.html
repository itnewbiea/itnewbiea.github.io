<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Ciliumç³»åˆ—-4-Ciliumæœ¬åœ°è·¯ç”± - ITå­¦ä¹ è€…åšå®¢</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Ciliumç³»åˆ—-4-Ciliumæœ¬åœ°è·¯ç”±" />
<meta property="og:description" content="ç³»åˆ—æ–‡ç«  Cilium ç³»åˆ—æ–‡ç«  å‰è¨€ åœ¨å‰æ–‡ä¸­æˆ‘ä»¬æåˆ°, cilium install é»˜è®¤å®‰è£…å, Cilium åŠŸèƒ½å¯ç”¨å’Œç¦ç”¨æƒ…å†µå¦‚ä¸‹:
datapath mode: tunnel: å› ä¸ºå…¼å®¹æ€§åŸå› ï¼ŒCilium ä¼šé»˜è®¤å¯ç”¨ tunnelï¼ˆåŸºäº vxlan) çš„ datapatch æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯ overlay ç½‘ç»œç»“æ„ã€‚KubeProxyReplacement: Disabled Cilium æ˜¯æ²¡æœ‰å®Œå…¨æ›¿æ¢æ‰ kube-proxy çš„ï¼Œåé¢æˆ‘ä»¬ä¼šå‡ºæ–‡ç« ä»‹ç»å¦‚ä½•å®ç°æ›¿æ¢ã€‚IPv6 BIG TCP: Disabled è¯¥åŠŸèƒ½è¦æ±‚ Linux Kernel &gt;= 5.19, æ‰€ä»¥åœ¨ Kernel 4.19.232 çŠ¶æ€ä¸ºç¦ç”¨ã€‚BandwidthManager: Disabled è¯¥åŠŸèƒ½è¦æ±‚ Linux Kernel &gt;= 5.1, æ‰€ä»¥ç›®å‰æ˜¯ç¦ç”¨çš„Host Routing: Legacy Legacy Host Routing è¿˜æ˜¯ä¼šç”¨åˆ° iptables, æ€§èƒ½è¾ƒå¼±ï¼›ä½†æ˜¯ BPF-based host routing éœ€è¦ Linux Kernel &gt;= 5.10Masquerading: IPtables IP ä¼ªè£…æœ‰å‡ ç§æ–¹å¼ï¼šåŸºäº eBPF çš„ï¼Œå’ŒåŸºäº iptables çš„ã€‚é»˜è®¤ä½¿ç”¨åŸºäº iptables, æ¨èä½¿ç”¨ åŸºäº eBPF çš„ã€‚Hubble Relay: disabled é»˜è®¤ Hubble ä¹Ÿæ˜¯ç¦ç”¨çš„ã€‚ ä»Šå¤©æˆ‘ä»¬å°è¯•å…³é—­ tunnel åŠŸèƒ½, å¯ç”¨æœ¬åœ°è·¯ç”±(Native-Routing)åŠŸèƒ½ä»¥æå‡ç½‘ç»œæ€§èƒ½." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/05968846f13a66a33b2e5805f4ce19d1/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-25T11:01:27+08:00" />
<meta property="article:modified_time" content="2023-07-25T11:01:27+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="ITå­¦ä¹ è€…åšå®¢" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">ITå­¦ä¹ è€…åšå®¢</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Ciliumç³»åˆ—-4-Ciliumæœ¬åœ°è·¯ç”±</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3 id="ç³»åˆ—æ–‡ç« ">ç³»åˆ—æ–‡ç« </h3> 
<ul><li><a href="https://ewhisper.cn/tags/Cilium/" rel="nofollow">Cilium ç³»åˆ—æ–‡ç« </a></li></ul> 
<h3 id="å‰è¨€">å‰è¨€</h3> 
<p>åœ¨<a href="https://ewhisper.cn/posts/7030/" rel="nofollow">å‰æ–‡</a>ä¸­æˆ‘ä»¬æåˆ°, <code>cilium install</code> é»˜è®¤å®‰è£…å, Cilium åŠŸèƒ½å¯ç”¨å’Œç¦ç”¨æƒ…å†µå¦‚ä¸‹:</p> 
<ol><li><code>datapath mode: tunnel</code>: å› ä¸ºå…¼å®¹æ€§åŸå› ï¼ŒCilium ä¼šé»˜è®¤å¯ç”¨ tunnelï¼ˆåŸºäº vxlan) çš„ datapatch æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯ overlay ç½‘ç»œç»“æ„ã€‚</li><li><code>KubeProxyReplacement: Disabled</code> Cilium æ˜¯æ²¡æœ‰å®Œå…¨æ›¿æ¢æ‰ kube-proxy çš„ï¼Œåé¢æˆ‘ä»¬ä¼šå‡ºæ–‡ç« ä»‹ç»å¦‚ä½•å®ç°æ›¿æ¢ã€‚</li><li><code>IPv6 BIG TCP: Disabled</code> è¯¥åŠŸèƒ½è¦æ±‚ Linux Kernel &gt;= 5.19, æ‰€ä»¥åœ¨ Kernel 4.19.232 çŠ¶æ€ä¸ºç¦ç”¨ã€‚</li><li><code>BandwidthManager: Disabled</code> è¯¥åŠŸèƒ½è¦æ±‚ Linux Kernel &gt;= 5.1, æ‰€ä»¥ç›®å‰æ˜¯ç¦ç”¨çš„</li><li><code>Host Routing: Legacy</code> Legacy Host Routing è¿˜æ˜¯ä¼šç”¨åˆ° iptables, æ€§èƒ½è¾ƒå¼±ï¼›ä½†æ˜¯ BPF-based host routing éœ€è¦ Linux Kernel &gt;= 5.10</li><li><code>Masquerading: IPtables</code> IP ä¼ªè£…æœ‰å‡ ç§æ–¹å¼ï¼šåŸºäº eBPF çš„ï¼Œå’ŒåŸºäº iptables çš„ã€‚é»˜è®¤ä½¿ç”¨åŸºäº iptables, æ¨èä½¿ç”¨ åŸºäº eBPF çš„ã€‚</li><li><code>Hubble Relay: disabled</code> é»˜è®¤ Hubble ä¹Ÿæ˜¯ç¦ç”¨çš„ã€‚</li></ol> 
<p>ä»Šå¤©æˆ‘ä»¬å°è¯•å…³é—­ tunnel åŠŸèƒ½, å¯ç”¨<strong>æœ¬åœ°è·¯ç”±</strong>(Native-Routing)åŠŸèƒ½ä»¥æå‡ç½‘ç»œæ€§èƒ½.</p> 
<h4 id="æµ‹è¯•ç¯å¢ƒ">æµ‹è¯•ç¯å¢ƒ</h4> 
<ul><li>Cilium 1.13.4</li><li>K3s v1.26.6+k3s1</li><li>OS 
  <ul><li>3å° Ubuntu 23.04 VM, Kernel 6.2, x86</li></ul> </li></ul> 
<h3 id="vxlan-å°è£…">VXLan å°è£…</h3> 
<p>åœ¨æœªæä¾›ä»»ä½•é…ç½®çš„æƒ…å†µä¸‹ï¼ŒCilium ä¼šè‡ªåŠ¨ä»¥è¿™ç§æ¨¡å¼è¿è¡Œï¼Œå› ä¸ºè¿™ç§æ¨¡å¼<strong>å¯¹åº•å±‚ç½‘ç»œåŸºç¡€è®¾æ–½çš„è¦æ±‚æœ€ä½</strong>ã€‚</p> 
<p>åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œæ‰€æœ‰é›†ç¾¤èŠ‚ç‚¹éƒ½ä¼šä½¿ç”¨åŸºäº UDP çš„å°è£…åè®® VXLAN æˆ– Geneve å½¢æˆç½‘çŠ¶éš§é“ã€‚Cilium èŠ‚ç‚¹ä¹‹é—´çš„æ‰€æœ‰æµé‡éƒ½ç»è¿‡å°è£….</p> 
<h4 id="è¿™ç§æ¨¡å¼çš„ç¼ºç‚¹">è¿™ç§æ¨¡å¼çš„ç¼ºç‚¹</h4> 
<p><strong>MTU å¼€é”€</strong></p> 
<p>ç”±äºå¢åŠ äº†å°è£…å¤´ï¼Œæœ‰æ•ˆè½½è·å¯ç”¨çš„ MTU è¦ä½äºæœ¬åœ°è·¯ç”±ï¼ˆVXLAN æ¯ä¸ªç½‘ç»œæ•°æ®åŒ… 50 å­—èŠ‚ï¼‰ã€‚è¿™å¯¼è‡´ç‰¹å®šç½‘ç»œè¿æ¥çš„æœ€å¤§ååç‡é™ä½ã€‚</p> 
<h3 id="æœ¬åœ°è·¯ç”±native-routing">æœ¬åœ°è·¯ç”±(Native-Routing)</h3> 
<p>æœ¬åœ°è·¯ç”±æ•°æ®è·¯å¾„åœ¨ <code>tunnel: disabled</code> æ—¶å¯ç”¨ï¼Œå¹¶å¯ç”¨æœ¬æœºæ•°æ®åŒ…è½¬å‘æ¨¡å¼ã€‚æœ¬æœºæ•°æ®åŒ…è½¬å‘æ¨¡å¼åˆ©ç”¨ Cilium è¿è¡Œç½‘ç»œçš„è·¯ç”±åŠŸèƒ½ï¼Œè€Œä¸æ˜¯æ‰§è¡Œå°è£…ã€‚</p> 
<p><img src="https://images2.imgbox.com/43/d8/gv4tFeJg_o.png" alt="Native-Routing"></p> 
<p>åœ¨æœ¬åœ°è·¯ç”±æ¨¡å¼ä¸‹ï¼ŒCilium ä¼šå°†æ‰€æœ‰æœªå¯»å€åˆ°å…¶ä»–æœ¬åœ°ç«¯ç‚¹çš„æ•°æ®åŒ…å§”æ‰˜ç»™ <strong>Linux å†…æ ¸çš„è·¯ç”±å­ç³»ç»Ÿ</strong>ã€‚è¿™æ„å‘³ç€ï¼Œæ•°æ®åŒ…çš„è·¯ç”±å°†å¦‚åŒæœ¬åœ°è¿›ç¨‹å‘å‡ºæ•°æ®åŒ…ä¸€æ ·ã€‚å› æ­¤ï¼Œè¿æ¥é›†ç¾¤èŠ‚ç‚¹çš„ç½‘ç»œå¿…é¡»èƒ½å¤Ÿè·¯ç”± PodCIDRã€‚</p> 
<p>é…ç½®æœ¬åœ°è·¯ç”±æ—¶ï¼ŒCilium ä¼šè‡ªåŠ¨åœ¨ Linux å†…æ ¸ä¸­å¯ç”¨ IP è½¬å‘ã€‚</p> 
<h4 id="ç½‘ç»œéœ€æ±‚">ç½‘ç»œéœ€æ±‚</h4> 
<ul><li>è¦è¿è¡Œæœ¬åœ°è·¯ç”±æ¨¡å¼ï¼Œè¿æ¥è¿è¡Œ Cilium çš„ä¸»æœºçš„ç½‘ç»œå¿…é¡»èƒ½å¤Ÿè½¬å‘ä½¿ç”¨ç»™ pod æˆ–å…¶ä»–å·¥ä½œè´Ÿè½½çš„åœ°å€çš„ IP æµé‡ã€‚</li><li>èŠ‚ç‚¹ä¸Šçš„ Linux å†…æ ¸å¿…é¡»çŸ¥é“å¦‚ä½•è½¬å‘æ‰€æœ‰è¿è¡Œ Cilium çš„èŠ‚ç‚¹ä¸Š pod æˆ–å…¶ä»–å·¥ä½œè´Ÿè½½çš„æ•°æ®åŒ…ã€‚è¿™å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼å®ç°ï¼š 
  <ul><li>èŠ‚ç‚¹æœ¬èº«ä¸çŸ¥é“å¦‚ä½•è·¯ç”±æ‰€æœ‰ pod IPï¼Œä½†<strong>ç½‘ç»œä¸Šæœ‰è·¯ç”±å™¨çŸ¥é“å¦‚ä½•åˆ°è¾¾æ‰€æœ‰å…¶ä»– pod</strong>ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒLinux èŠ‚ç‚¹è¢«é…ç½®ä¸ºåŒ…å«æŒ‡å‘æ­¤ç±»è·¯ç”±å™¨çš„é»˜è®¤è·¯ç”±ã€‚è¿™ç§æ¨¡å¼ç”¨äº<strong>äº‘æä¾›å•†ç½‘ç»œé›†æˆ</strong>ã€‚æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜… <a href="https://docs.cilium.io/en/stable/network/concepts/routing/#gke-datapath" rel="nofollow">Google Cloud</a>ã€<a href="https://docs.cilium.io/en/stable/network/concepts/routing/#aws-eni-datapath" rel="nofollow">AWS ENI</a> å’Œ <a href="https://docs.cilium.io/en/stable/network/concepts/ipam/azure/#ipam-azure" rel="nofollow">Azure IPAM</a>ã€‚</li><li>æ¯ä¸ªèŠ‚ç‚¹éƒ½çŸ¥é“æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹çš„æ‰€æœ‰ pod IPï¼Œå¹¶åœ¨ <strong>Linux å†…æ ¸è·¯ç”±è¡¨</strong>ä¸­æ’å…¥è·¯ç”±æ¥è¡¨ç¤ºè¿™ä¸€ç‚¹ã€‚ 
    <ul><li>å¦‚æœæ‰€æœ‰èŠ‚ç‚¹<strong>å…±äº«ä¸€ä¸ª L2 ç½‘ç»œ</strong>ï¼Œåˆ™å¯ä»¥å¯ç”¨é€‰é¡¹ <code>auto-direct-node-routes: true</code> æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚<strong>æœ¬æ¬¡å®éªŒæˆ‘ä»¬ä½¿ç”¨è¿™ç§æ–¹å¼å¯ç”¨æœ¬åœ°è·¯ç”±.</strong></li><li>å¦åˆ™ï¼Œå¿…é¡»è¿è¡Œé¢å¤–çš„ç³»ç»Ÿç»„ä»¶ï¼ˆå¦‚ <strong>BGP</strong> å®ˆæŠ¤è¿›ç¨‹ï¼‰æ¥åˆ†å‘è·¯ç”±ã€‚æœ‰å…³å¦‚ä½•ä½¿ç”¨ kube-router é¡¹ç›®å®ç°è¿™ä¸€ç›®æ ‡ï¼Œè¯·å‚é˜…æŒ‡å—<a href="https://docs.cilium.io/en/stable/network/kube-router/#kube-router" rel="nofollow">ã€Šä½¿ç”¨ Kube-Router è¿è¡Œ BGPã€‹</a>ã€‚</li></ul> </li></ul> </li></ul> 
<h3 id="å®æˆ˜-å¯ç”¨æœ¬åœ°è·¯ç”±">å®æˆ˜: å¯ç”¨æœ¬åœ°è·¯ç”±</h3> 
<p>ä»ç°åœ¨å¼€å§‹, åç»­çš„ cilium å®‰è£…é…ç½®è¶Šæ¥è¶Šå¤æ‚, æœ‰å¾ˆå¤šå®šåˆ¶çš„é…ç½®å‚æ•°, æ‰€ä»¥æˆ‘ä»¬ä»ç°åœ¨å¼€å§‹ä½¿ç”¨ <strong>Helm Chart</strong> æ–¹å¼å®‰è£… Cilium.</p> 
<blockquote> 
 <p>ğŸ“šï¸<strong>Reference:</strong></p> 
 <p>Helm Chart æ–¹æ³•é€‚ç”¨äºéœ€è¦å¯¹ Cilium å®‰è£…è¿›è¡Œ<strong>ç²¾ç»†æ§åˆ¶çš„é«˜çº§å®‰è£…å’Œç”Ÿäº§ç¯å¢ƒ</strong>ã€‚å®ƒè¦æ±‚ä½ ä¸ºç‰¹å®šçš„ Kubernetes ç¯å¢ƒæ‰‹åŠ¨é€‰æ‹©æœ€ä½³æ•°æ®è·¯å¾„ (datapath) å’Œ IPAM æ¨¡å¼ã€‚</p> 
</blockquote> 
<p>å…ˆä½¿ç”¨ Helm Chart è¿›è¡Œæœ€åŸºæœ¬å®‰è£…, ä¿è¯å’Œå‰æ–‡çš„é…ç½®ç›¸åŒ.</p> 
<h4 id="å¸è½½-cilium">å¸è½½ Cilium</h4> 
<p>é¦–å…ˆå¸è½½é€šè¿‡ <code>cilium install</code> å®‰è£…çš„ Cilium.</p> 
<pre><code class="language-bash">export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
cilium uninstall</code></pre> 
<h4 id="helm-chart-åŸºæœ¬å®‰è£…">Helm Chart åŸºæœ¬å®‰è£…</h4> 
<p>ç„¶å, ä½¿ç”¨ Helm Chart è¿›è¡ŒåŸºæœ¬å®‰è£…, ä¿è¯å’Œå‰æ–‡é…ç½®ç›¸åŒ.</p> 
<pre><code class="language-bash">helm repo add cilium https://helm.cilium.io/

helm install cilium cilium/cilium --version 1.13.4 \
   --namespace kube-system \
   --set operator.replicas=1 \
   --set k8sServiceHost=192.168.2.43 \
   --set k8sServicePort=6443 \
   --set hubble.relay.enabled=true \
   --set hubble.ui.enabled=true</code></pre> 
<p>è¯´æ˜å¦‚ä¸‹:</p> 
<ul><li><code>--namespace kube-system</code> å’Œé»˜è®¤çš„ <code>cilium install</code> ä¿æŒä¸€è‡´, cilium å®‰è£…åœ¨ <code>kube-system</code> ä¸‹</li><li><code>operator.replicas=1</code> æŒ‡å®š Operator å‰¯æœ¬æ•°ä¸º 1, é»˜è®¤ä¸º 2</li><li><code>k8sServiceHost</code> <code>k8sServicePort</code> æ˜¾å¼æŒ‡å®š K8s é›†ç¾¤çš„ APIServer çš„ IP å’Œ ç«¯å£</li><li><code>hubble.relay.enabled=true</code> <code>hubble.ui.enabled=true</code> å¯ç”¨ Hubble å¯è§‚å¯Ÿæ€§.</li></ul> 
<h4 id="é‡å¯æœªå—ç®¡èŠ‚ç‚¹">é‡å¯æœªå—ç®¡èŠ‚ç‚¹</h4> 
<p>å¦‚æœä½ åˆ›å»ºçš„é›†ç¾¤ä¸­æ²¡æœ‰ä½¿ç”¨ <code>node.cilium.io/agent-not-ready</code> æ±¡ç‚¹çš„èŠ‚ç‚¹ï¼Œåˆ™éœ€è¦æ‰‹åŠ¨é‡å¯æœªæ‰˜ç®¡çš„ podã€‚é‡å¯æ‰€æœ‰å·²è¿è¡Œä½†æœªä»¥ä¸»æœºè”ç½‘æ¨¡å¼è¿è¡Œçš„ podï¼Œä»¥ç¡®ä¿ Cilium å¼€å§‹ç®¡ç†å®ƒä»¬ã€‚è¿™æ ·åšæ˜¯ä¸ºäº†ç¡®ä¿æ‰€æœ‰åœ¨éƒ¨ç½² Cilium ä¹‹å‰å·²ç»è¿è¡Œçš„ pod éƒ½å…·æœ‰ Cilium æä¾›çš„ç½‘ç»œè¿æ¥ï¼Œå¹¶ä¸” NetworkPolicy ä¹Ÿé€‚ç”¨äºå®ƒä»¬ï¼š</p> 
<pre><code class="language-bash">$ kubectl get pods --all-namespaces -o custom-columns=NAMESPACE:.metadata.namespace,NAME:.metadata.name,HOSTNETWORK:.spec.hostNetwork --no-headers=true | grep '&lt;none&gt;' | awk '{print "-n "$1" "$2}' | xargs -L 1 -r kubectl delete pod
pod "helm-install-traefik-crd-wv67f" deleted
pod "helm-install-traefik-vt2zh" deleted
pod "svclb-traefik-c19bcc42-6jqxs" deleted
pod "coredns-59b4f5bbd5-qmn2k" deleted
pod "local-path-provisioner-76d776f6f9-mpct2" deleted
pod "traefik-57c84cf78d-jpx47" deleted
pod "metrics-server-68cf49699b-dxvnk" deleted
pod "hubble-ui-68fb44f6f5-z9w7c" deleted
pod "hubble-relay-5f68b89b76-s6xp5" deleted</code></pre> 
<h4 id="helm-chart-å¯ç”¨æœ¬åœ°è·¯ç”±">Helm Chart å¯ç”¨æœ¬åœ°è·¯ç”±</h4> 
<pre><code class="language-bash">helm upgrade cilium cilium/cilium \
   --namespace kube-system \
   --reuse-values \
   --set tunnel=disabled \
   --set autoDirectNodeRoutes=true \
   --set ipv4NativeRoutingCIDR=10.0.0.0/22</code></pre> 
<p>é…ç½®è¯´æ˜å¦‚ä¸‹:</p> 
<ul><li><code>--reuse-values</code> å¤ç”¨ä¸Šä¸€æ¬¡çš„ Helm Chart å®‰è£…é…ç½®</li><li><code>tunnel=disabled</code> å¯ç”¨æœ¬åœ°è·¯ç”±æ¨¡å¼</li><li><code>autoDirectNodeRoutes=true</code> æ¯ä¸ªèŠ‚ç‚¹éƒ½çŸ¥é“æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹çš„æ‰€æœ‰ pod IPï¼Œå¹¶åœ¨ <strong>Linux å†…æ ¸è·¯ç”±è¡¨</strong>ä¸­æ’å…¥è·¯ç”±æ¥è¡¨ç¤ºè¿™ä¸€ç‚¹ã€‚å¦‚æœæ‰€æœ‰èŠ‚ç‚¹<strong>å…±äº«ä¸€ä¸ª L2 ç½‘ç»œ</strong>ï¼Œåˆ™å¯ä»¥å¯ç”¨é€‰é¡¹ <code>auto-direct-node-routes: true</code> æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</li><li><code>ipv4-native-routing-cidr: x.x.x.x/y</code> è®¾ç½®å¯æ‰§è¡Œæœ¬åœ°è·¯ç”±çš„ CIDRã€‚</li></ul> 
<p>è‡³æ­¤, æœ¬åœ°è·¯ç”±å°±å·²ç»å¯ç”¨äº†. å¯ä»¥å†æ¬¡è¿è¡Œç›¸å…³å‘½ä»¤æ¥æ£€æŸ¥.</p> 
<h3 id="éªŒè¯æœ¬åœ°è·¯ç”±æ˜¯å¦å¯ç”¨">éªŒè¯æœ¬åœ°è·¯ç”±æ˜¯å¦å¯ç”¨</h3> 
<p>é¦–å…ˆ, æœªå¯ç”¨ä¹‹å‰, ä¹Ÿå°±æ˜¯é€šè¿‡ VXLan å°è£…æ—¶, ä¼šæœ‰ä¸€ä¸ªå¯¹åº”çš„ VXLan ç½‘å¡ <code>cilium_vxlan</code>. ç¤ºä¾‹å¦‚ä¸‹:</p> 
<pre><code>5: cilium_vxlan: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN group default qlen 1000
    link/ether 52:5b:dd:37:f5:45 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::505b:ddff:fe37:f545/64 scope link
       valid_lft forever preferred_lft forever</code></pre> 
<p>å¯ä»¥æŸ¥çœ‹ Cilium Agent çš„æ—¥å¿—:</p> 
<pre><code class="language-bash">$ k3s kubectl logs -f cilium-nxbsn -n kube-system|grep datapath
Defaulted container "cilium-agent" out of: cilium-agent, config (init), mount-cgroup (init), apply-sysctl-overwrites (init), mount-bpf-fs (init), clean-cilium-state (init), install-cni-binaries (init)
level=info msg="  --datapath-mode='veth'" subsys=daemon
level=info msg="clang (10.0.0) and kernel (6.2.0) versions: OK!" subsys=linux-datapath
level=info msg="linking environment: OK!" subsys=linux-datapath
level=info msg="Restored 1 node IDs from the BPF map" subsys=linux-datapath
level=info msg="Detected devices" devices="[]" subsys=linux-datapath
level=info msg="Setting up BPF datapath" bpfClockSource=jiffies bpfInsnSet=v3 subsys=datapath-loader</code></pre> 
<p>é€šè¿‡ <code>--datapath-mode='veth'</code> å¯ä»¥åˆ¤æ–­å·²ç»æˆåŠŸå¯ç”¨æœ¬åœ°è·¯ç”±.</p> 
<p>ä¹Ÿå¯ä»¥æŸ¥çœ‹ç½‘å¡çš„ mtu, cilium çš„ vslan ç½‘å¡æ²¡æœ‰äº†, å¦‚ä¸‹:</p> 
<pre><code class="language-bash">$ ip a
...
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000
    link/ether 00:15:5d:02:20:22 brd ff:ff:ff:ff:ff:ff
    inet 172.17.236.121/20 brd 172.17.239.255 scope global dynamic noprefixroute eth0
       valid_lft 84958sec preferred_lft 84958sec
    inet6 fe80::e4ed:31d3:3101:3265/64 scope link noprefixroute
       valid_lft forever preferred_lft forever
3: cilium_net@cilium_host: &lt;BROADCAST,MULTICAST,NOARP,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000
    link/ether f6:e6:97:fa:8a:d9 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::f4e6:97ff:fefa:8ad9/64 scope link
       valid_lft forever preferred_lft forever
4: cilium_host@cilium_net: &lt;BROADCAST,MULTICAST,NOARP,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000
    link/ether 72:f7:bb:f9:31:0b brd ff:ff:ff:ff:ff:ff
    inet 10.0.0.172/32 scope global cilium_host
       valid_lft forever preferred_lft forever
    inet6 fe80::70f7:bbff:fef9:310b/64 scope link
       valid_lft forever preferred_lft forever
15: lxca13b12696333@if14: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000
    link/ether de:89:24:7b:86:e0 brd ff:ff:ff:ff:ff:ff link-netns cni-0253f30e-07bc-2273-640c-7ec96f0a30dd
    inet6 fe80::dc89:24ff:fe7b:86e0/64 scope link
       valid_lft forever preferred_lft forever
...</code></pre> 
<p>å¯ä»¥çœ‹åˆ° cilium å’Œ lxc ç›¸å…³çš„ç½‘å¡, mtu å·²ç»å’Œ eth0 ä¿æŒä¸€è‡´, ä¸º: <code>mtu 1500</code>. è€Œåœ¨æ²¡å¯ç”¨ä¹‹å‰, <code>mtu 1280</code>.</p> 
<p>æ²¡å¯ç”¨æœ¬åœ°è·¯ç”±, ä½¿ç”¨VXLan å°è£…çš„ mtu å¦‚ä¸‹:</p> 
<pre><code class="language-bash">$ ip a
...
3: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000
    link/ether aa:94:b7:b4:25:ac brd ff:ff:ff:ff:ff:ff
    inet 192.168.2.44/24 brd 192.168.2.255 scope global dynamic noprefixroute eth0
       valid_lft 74264sec preferred_lft 74264sec
    inet6 240e:3a1:166d:dd70:4ea1:7c0c:13de:aa3/64 scope global dynamic noprefixroute
       valid_lft 208339sec preferred_lft 121939sec
    inet6 fe80::b0:3f98:e4e1:1d16/64 scope link noprefixroute
       valid_lft forever preferred_lft forever
6: cilium_net@cilium_host: &lt;BROADCAST,MULTICAST,NOARP,UP,LOWER_UP&gt; mtu 1280 qdisc noqueue state UP group default qlen 1000
    link/ether be:0f:af:14:c7:05 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::bc0f:afff:fe14:c705/64 scope link
       valid_lft forever preferred_lft forever
7: cilium_host@cilium_net: &lt;BROADCAST,MULTICAST,NOARP,UP,LOWER_UP&gt; mtu 1280 qdisc noqueue state UP group default qlen 1000
    link/ether 1e:96:a5:af:3c:a3 brd ff:ff:ff:ff:ff:ff
    inet 10.0.0.109/32 scope global cilium_host
       valid_lft forever preferred_lft forever
    inet6 fe80::1c96:a5ff:feaf:3ca3/64 scope link
       valid_lft forever preferred_lft forever
98: lxc_health@if97: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1280 qdisc noqueue state UP group default qlen 1000
    link/ether 1a:41:2c:3b:18:0b brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet6 fe80::1841:2cff:fe3b:180b/64 scope link
       valid_lft forever preferred_lft forever
...</code></pre> 
<h3 id="æ€§èƒ½æµ‹è¯•">æ€§èƒ½æµ‹è¯•</h3> 
<p>é€šè¿‡ iperf æµ‹è¯•ç½‘ç»œååé‡. æ¥éªŒè¯å¯ç”¨æœ¬åœ°è·¯ç”±å¸¦æ¥çš„æ€§èƒ½æå‡. æˆ‘ä»¬ä½¿ç”¨ iperf3 æ¥è¿›è¡Œæµ‹è¯•.</p> 
<h4 id="vm-é—´å®½å¸¦">VM é—´å®½å¸¦</h4> 
<p>æµ‹è¯• VM é—´åŸç”Ÿå¸¦å®½, apt å®‰è£… iperf3:</p> 
<pre><code class="language-bash">sudo apt install -y iperf3</code></pre> 
<p>æµ‹è¯• VM é—´å®½å¸¦. ç»“æœä¸º:</p> 
<pre><code>$ iperf3 -c 192.168.2.3 -f M
Connecting to host 192.168.2.3, port 5201
[  5] local 192.168.2.26 port 32930 connected to 192.168.2.3 port 5201
[ ID] Interval           Transfer     Bitrate         Retr  Cwnd
[  5]   0.00-1.00   sec  1.02 GBytes  1047 MBytes/sec    0   3.12 MBytes
[  5]   1.00-2.00   sec  1.13 GBytes  1161 MBytes/sec    0   3.12 MBytes
[  5]   2.00-3.00   sec  1.12 GBytes  1150 MBytes/sec    0   3.12 MBytes
[  5]   3.00-4.00   sec  1.08 GBytes  1107 MBytes/sec    0   3.12 MBytes
[  5]   4.00-5.00   sec  1.17 GBytes  1194 MBytes/sec    0   3.12 MBytes
[  5]   5.00-6.00   sec  1.09 GBytes  1120 MBytes/sec    0   3.12 MBytes
[  5]   6.00-7.00   sec  1.10 GBytes  1128 MBytes/sec    0   3.12 MBytes
[  5]   7.00-8.00   sec  1.10 GBytes  1131 MBytes/sec    0   3.12 MBytes
[  5]   8.00-9.00   sec  1.18 GBytes  1211 MBytes/sec    0   3.12 MBytes
[  5]   9.00-10.00  sec  1.11 GBytes  1133 MBytes/sec    0   3.12 MBytes
- - - - - - - - - - - - - - - - - - - - - - - - -
[ ID] Interval           Transfer     Bitrate         Retr
[  5]   0.00-10.00  sec  11.1 GBytes  1138 MBytes/sec    0             sender
[  5]   0.00-10.00  sec  11.1 GBytes  1138 MBytes/sec                  receiver

iperf Done.</code></pre> 
<p>ç»“æœä¸º <strong>1138 MBytes/sec</strong> å¸¦å®½.</p> 
<h4 id="å®¹å™¨é‡Œéƒ¨ç½²-iperf3">å®¹å™¨é‡Œéƒ¨ç½² iperf3</h4> 
<p>æµ‹è¯• Cilium vxlan å°è£…å’Œæœ¬åœ°è·¯ç”±æ¨¡å¼, å°† iperf3 éƒ¨ç½²ä¸º Daemonset:</p> 
<pre><code class="language-yaml">apiVersion: apps/v1
kind: DaemonSet
metadata:
   name: iperf3
   labels:
      app: iperf3
spec:
   selector:
      matchLabels:
        app: iperf3
   template:
      metadata:
         labels:
            app: iperf3
      spec:
         containers:
         -  name: iperf3
            image: clearlinux/iperf:3
            command: ['/bin/sh', '-c', 'sleep 1d']
            ports:
            - containerPort: 5201</code></pre> 
<p>ç»“æœå¦‚ä¸‹:</p> 
<pre><code class="language-bash">$ k3s kubectl get pod -o wide
NAME           READY   STATUS    RESTARTS   AGE   IP           NODE          NOMINATED NODE   READINESS GATES
iperf3-dmqzb   1/1     Running   0          30s   10.0.0.13    cilium-62-1   &lt;none&gt;           &lt;none&gt;
iperf3-g84hd   1/1     Running   0          30s   10.0.2.239   cilium-62-3   &lt;none&gt;           &lt;none&gt;
iperf3-lnwfn   1/1     Running   0          30s   10.0.1.39    cilium-62-2   &lt;none&gt;           &lt;none&gt;</code></pre> 
<h4 id="ä½¿ç”¨å®¹å™¨å†…-iperf3-æµ‹è¯•">ä½¿ç”¨å®¹å™¨å†… iperf3 æµ‹è¯•</h4> 
<p>é€‰æ‹©ä¸€ä¸ª pod ä½œä¸º server(cilium-62-2 node ä¸Šçš„ä¸º server), å¦ä¸€ä¸ªä½œä¸º client(cilium-62-3 node ä¸Šçš„ä¸ºclient).</p> 
<p>Server (iperf3-lnwfn) è¿è¡Œçš„å‘½ä»¤ä¸º:</p> 
<pre><code class="language-bash">kubectl exec -it iperf3-lnwfn -- iperf3 -s -f M</code></pre> 
<p>Client (iperf3-g84hd) è¿è¡Œçš„å‘½ä»¤ä¸º:</p> 
<pre><code class="language-bash">kubectl exec -it iperf3-g84hd -- iperf3 -c 10.0.1.39 -f M</code></pre> 
<h4 id="vxlan-å°è£…-1">VXLan å°è£…</h4> 
<p>VXLan å°è£…çš„æƒ…å†µ:</p> 
<pre><code>$ kubectl exec -it iperf3-g84hd -- iperf3 -c 10.0.1.39 -f M
Connecting to host 10.0.1.39, port 5201
[  5] local 10.0.2.239 port 38102 connected to 10.0.1.39 port 5201
[ ID] Interval           Transfer     Bitrate         Retr  Cwnd
[  5]   0.00-1.00   sec   377 MBytes   377 MBytes/sec   46   1.19 MBytes
[  5]   1.00-2.00   sec   458 MBytes   457 MBytes/sec    0   1.31 MBytes
[  5]   2.00-3.00   sec   538 MBytes   538 MBytes/sec   46   1.43 MBytes
[  5]   3.00-4.00   sec   538 MBytes   537 MBytes/sec    0   1.49 MBytes
[  5]   4.00-5.00   sec   525 MBytes   525 MBytes/sec   14   1.50 MBytes
[  5]   5.00-6.00   sec   494 MBytes   494 MBytes/sec    0   1.51 MBytes
[  5]   6.00-7.00   sec   494 MBytes   494 MBytes/sec    0   1.51 MBytes
[  5]   7.00-8.00   sec   494 MBytes   494 MBytes/sec   33   1.52 MBytes
[  5]   8.00-9.00   sec   528 MBytes   528 MBytes/sec    0   1.53 MBytes
[  5]   9.00-10.00  sec   495 MBytes   495 MBytes/sec   46   1.54 MBytes
- - - - - - - - - - - - - - - - - - - - - - - - -
[ ID] Interval           Transfer     Bitrate         Retr
[  5]   0.00-10.00  sec  4.82 GBytes   494 MBytes/sec  185             sender
[  5]   0.00-10.00  sec  4.82 GBytes   493 MBytes/sec                  receiver

iperf Done.</code></pre> 
<p>ç»“æœä¸º <strong>493 MBytes/sec</strong> å·¦å³å¸¦å®½, ç›´æ¥å°‘äº†ä¸€åŠ.</p> 
<h4 id="æœ¬åœ°è·¯ç”±">æœ¬åœ°è·¯ç”±</h4> 
<pre><code class="language-bash">$ kubectl exec -it iperf3-g84hd -- iperf3 -c 10.0.1.39 -f M
Connecting to host 10.0.1.39, port 5201
[  5] local 10.0.2.239 port 39518 connected to 10.0.1.39 port 5201
[ ID] Interval           Transfer     Bitrate         Retr  Cwnd
[  5]   0.00-1.00   sec  1.01 GBytes  1030 MBytes/sec   33   1.53 MBytes
[  5]   1.00-2.00   sec  1.16 GBytes  1191 MBytes/sec    0   2.01 MBytes
[  5]   2.00-3.00   sec  1.31 GBytes  1339 MBytes/sec    0   2.45 MBytes
[  5]   3.00-4.00   sec  1.28 GBytes  1312 MBytes/sec    0   2.79 MBytes
[  5]   4.00-5.00   sec  1.25 GBytes  1283 MBytes/sec    0   3.00 MBytes
[  5]   5.00-6.00   sec  1.28 GBytes  1310 MBytes/sec    0   3.00 MBytes
[  5]   6.00-7.00   sec  1.26 GBytes  1292 MBytes/sec    0   3.01 MBytes
[  5]   7.00-8.00   sec  1.31 GBytes  1337 MBytes/sec    0   3.01 MBytes
[  5]   8.00-9.00   sec  1.23 GBytes  1260 MBytes/sec    0   3.01 MBytes
[  5]   9.00-10.00  sec  1.28 GBytes  1308 MBytes/sec   92   3.01 MBytes
- - - - - - - - - - - - - - - - - - - - - - - - -
[ ID] Interval           Transfer     Bitrate         Retr
[  5]   0.00-10.00  sec  12.4 GBytes  1266 MBytes/sec  125             sender
[  5]   0.00-10.00  sec  12.4 GBytes  1266 MBytes/sec                  receiver

iperf Done.</code></pre> 
<p>ç»“æœä¸º <strong>1266 MBytes/sec</strong>. å’ŒåŸç”Ÿçš„ç›¸å·®æ— å‡ .</p> 
<h4 id="å°ç»“">å°ç»“</h4> 
<p>ğŸ‘ï¸ <strong>ç¦ç”¨å°è£…(éš§é“ tunnel)(æœ¬æ¬¡æµ‹è¯•ä¸º VXLAN å°è£…æ¨¡å¼), å¯ç”¨æœ¬åœ°è·¯ç”±, ç¡®å®å¯ä»¥æå‡ç½‘ç»œæœ€å¤§ååé‡.</strong></p> 
<h3 id="æ€»ç»“">æ€»ç»“</h3> 
<p>åœ¨æœªæä¾›ä»»ä½•é…ç½®çš„æƒ…å†µä¸‹ï¼ŒCilium ä¼šè‡ªåŠ¨ä»¥å°è£…(éš§é“ tunnel)æ¨¡å¼è¿è¡Œï¼Œå› ä¸ºè¿™ç§æ¨¡å¼<strong>å¯¹åº•å±‚ç½‘ç»œåŸºç¡€è®¾æ–½çš„è¦æ±‚æœ€ä½</strong>ã€‚</p> 
<p>åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œæ‰€æœ‰é›†ç¾¤èŠ‚ç‚¹éƒ½ä¼šä½¿ç”¨åŸºäº UDP çš„å°è£…åè®® VXLAN æˆ– Geneve å½¢æˆç½‘çŠ¶éš§é“ã€‚</p> 
<p>ç”±äºå¢åŠ äº†å°è£…å¤´ï¼Œæœ‰æ•ˆè½½è·å¯ç”¨çš„ MTU è¦ä½äºæœ¬åœ°è·¯ç”±, è¿™å¯¼è‡´ç‰¹å®šç½‘ç»œè¿æ¥çš„æœ€å¤§ååç‡é™ä½ã€‚</p> 
<p>å¯ç”¨æœ¬åœ°è·¯ç”±(Native-Routing)å¯ä»¥é¿å…è¿™ç§æƒ…å†µ, ä½†æ˜¯å¯ç”¨å¯¹æœ¬åœ°ç½‘ç»œæœ‰ä¸€å®šè¦æ±‚. æœ¬æ¬¡æˆ‘ä»¬é€šè¿‡ <code>autoDirectNodeRoutes=true</code> æ–¹å¼æ¥è¿›è¡Œå¯ç”¨.</p> 
<p>é€šè¿‡ iperf æµ‹è¯•, ä¹Ÿç¡®å®è¯æ˜å¯ç”¨æœ¬åœ°è·¯ç”±å¯ä»¥æå‡ååé‡.ğŸ’ª</p> 
<h3 id="ğŸ“šï¸å‚è€ƒæ–‡æ¡£">ğŸ“šï¸å‚è€ƒæ–‡æ¡£</h3> 
<ul><li><a href="https://docs.cilium.io/en/stable/network/concepts/routing/#native-routing" rel="nofollow">Routing â€” Cilium 1.13.4 documentation</a></li><li><a href="https://docs.cilium.io/en/stable/installation/k8s-install-helm/#k8s-install-helm" rel="nofollow">Installation using Helm â€” Cilium 1.13.4 documentation</a></li></ul> 
<blockquote> 
 <p><em>ä¸‰äººè¡Œ, å¿…æœ‰æˆ‘å¸ˆ; çŸ¥è¯†å…±äº«, å¤©ä¸‹ä¸ºå…¬.</em> æœ¬æ–‡ç”±ä¸œé£å¾®é¸£æŠ€æœ¯åšå®¢ <a href="https://EWhisper.cn" rel="nofollow">EWhisper.cn</a> ç¼–å†™.</p> 
</blockquote>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f846baa88dd7ed1e418c78fc69e652b1/" rel="prev">
			<span class="pager__subtitle">Â«&thinsp;Previous</span>
			<p class="pager__title">Docker å‘½ä»¤ï¼ˆæ–°æ‰‹ä¸Šè·¯ï¼‰</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2256958ae39d0ae728c79b45cc89a34c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;Â»</span>
			<p class="pager__title">Python tkinter(GUIç¼–ç¨‹)æ¨¡å—æœ€å®Œæ•´æ•™ç¨‹ï¼ˆä¸­ï¼‰</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 ITå­¦ä¹ è€…åšå®¢.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>