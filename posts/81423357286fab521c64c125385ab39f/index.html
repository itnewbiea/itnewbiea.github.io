<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>基于Detectron2的BlendMask训练 BlendMask环境配置 COCO数据集 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="基于Detectron2的BlendMask训练 BlendMask环境配置 COCO数据集" />
<meta property="og:description" content="提示：文章写完后，目录可以自动生成，如何生成可参考右边的帮助文档
文章目录 前言一、下载Detectron2在这里插入图片描述 AdelaiDet是基于Detectron2之上，可以包含多个实例级识别任务的开源工具箱，所以它也可以看作是Detectron2的一个拓展插件。BlendMask也是属于AdelaiDet其中一个任务。 二、使用步骤1.基础环境配置2.安装Detectron23.安装AdelaiDet4.用官方权重调通demo5.使用COCO数据集20146.修改配置文件7.进行训练 常见问题 前言 基于Detectron2的BlendMask训练
训练的数据为：2014COCO数据集
配置环境为：ubuntu18.4 cuda10.1 单张显卡2018ti
提示：以下是本篇文章正文内容，下面案例可供参考
一、下载Detectron2 要训练BlendMask，首先上github搜索BlendMask，出现的界面为
AdelaiDet是基于Detectron2之上，可以包含多个实例级识别任务的开源工具箱，所以它也可以看作是Detectron2的一个拓展插件。BlendMask也是属于AdelaiDet其中一个任务。 二、使用步骤 1.基础环境配置 在终端中输入
conda create -n detectron2 python=3.8 #conda创建虚拟环境 conda activate detectron2 #激活环境 nvcc --version #查看cuda版本 根据你的cuda配置去pytorch官网下载对应的pytroch
如果这个页面没看到，就点击Previous version of PyTorch，一定要找到对应的cuda和python版本。
例如我的版本是cuda10.1
使用以下命令安装
pip install torch1.8.1&#43;cu101 torchvision0.9.1&#43;cu101 torchaudio==0.8.1 -f https://download.pytorch.org/whl/torch_stable.html
检查一下
python #在终端中进入python环境 &gt;&gt;&gt; import torch &gt;&gt;&gt; import torchvision &gt;&gt;&gt; print(torch.cuda.is_available()) #查看cuda是否可用 &gt;&gt;&gt;torch.__version__ #查看torch版本 2.安装Detectron2 基本要求如下
下载代码
git clone https://github.com/facebookresearch/detectron2.git #用git下载代码 python -m pip install -e detectron2 #安装detectron2 3." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/81423357286fab521c64c125385ab39f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-26T09:18:47+08:00" />
<meta property="article:modified_time" content="2022-07-26T09:18:47+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">基于Detectron2的BlendMask训练 BlendMask环境配置 COCO数据集</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p>提示：文章写完后，目录可以自动生成，如何生成可参考右边的帮助文档</p> 
</blockquote> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_7" rel="nofollow">前言</a></li><li><a href="#Detectron2_15" rel="nofollow">一、下载Detectron2</a></li><li><ul><li><a href="#httpsimgblogcsdnimgcn91b61b3b369a4fc4bfebe053330a431cpng%0AAdelaiDetDetectron2Detectron2BlendMaskAdelaiDet_18" rel="nofollow">在这里插入图片描述 AdelaiDet是基于Detectron2之上，可以包含多个实例级识别任务的开源工具箱，所以它也可以看作是Detectron2的一个拓展插件。BlendMask也是属于AdelaiDet其中一个任务。</a></li></ul> 
  </li><li><a href="#_21" rel="nofollow">二、使用步骤</a></li><li><ul><li><a href="#1_22" rel="nofollow">1.基础环境配置</a></li><li><a href="#2Detectron2_48" rel="nofollow">2.安装Detectron2</a></li><li><a href="#3AdelaiDet_59" rel="nofollow">3.安装AdelaiDet</a></li><li><a href="#4demo_66" rel="nofollow">4.用官方权重调通demo</a></li><li><a href="#5COCO2014_85" rel="nofollow">5.使用COCO数据集2014</a></li><li><a href="#6_122" rel="nofollow">6.修改配置文件</a></li><li><a href="#7_146" rel="nofollow">7.进行训练</a></li></ul> 
  </li><li><a href="#_157" rel="nofollow">常见问题</a></li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="_7"></a>前言</h2> 
<p>基于Detectron2的BlendMask训练</p> 
<p>训练的数据为：2014COCO数据集<br> 配置环境为：ubuntu18.4 cuda10.1 单张显卡2018ti</p> 
<p><code>提示：以下是本篇文章正文内容，下面案例可供参考</code></p> 
<h2><a id="Detectron2_15"></a>一、下载Detectron2</h2> 
<p>要训练BlendMask，首先上github搜索BlendMask，出现的界面为</p> 
<h3><a id="httpsimgblogcsdnimgcn91b61b3b369a4fc4bfebe053330a431cpng%0AAdelaiDetDetectron2Detectron2BlendMaskAdelaiDet_18"></a><img src="https://images2.imgbox.com/e4/5c/nvkQSabk_o.png" alt="在这里插入图片描述"><br> AdelaiDet是基于Detectron2之上，可以包含多个实例级识别任务的开源工具箱，所以它也可以看作是Detectron2的一个拓展插件。BlendMask也是属于AdelaiDet其中一个任务。</h3> 
<h2><a id="_21"></a>二、使用步骤</h2> 
<h3><a id="1_22"></a>1.基础环境配置</h3> 
<p>在终端中输入</p> 
<pre><code class="prism language-c">conda create <span class="token operator">-</span>n detectron2 python<span class="token operator">=</span><span class="token number">3.8</span>   #conda创建虚拟环境
conda activate detectron2               #激活环境

nvcc <span class="token operator">--</span>version                          #查看cuda版本

</code></pre> 
<p>根据你的cuda配置去pytorch官网下载对应的pytroch<br> <img src="https://images2.imgbox.com/9b/e3/vspiQJJA_o.png" alt="在这里插入图片描述Pytorch官网页面"><br> 如果这个页面没看到，就点击Previous version of PyTorch，一定要找到对应的cuda和python版本。<br> 例如我的版本是cuda10.1<br> <img src="https://images2.imgbox.com/ce/a0/17l0B0AC_o.png" alt="在这里插入图片描述"><br> 使用以下命令安装<br> pip install torch<mark>1.8.1+cu101 torchvision</mark>0.9.1+cu101 torchaudio==0.8.1 -f https://download.pytorch.org/whl/torch_stable.html</p> 
<p>检查一下</p> 
<pre><code class="prism language-c">python                                 #在终端中进入python环境
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> import torch
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> import torchvision
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token function">print</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span><span class="token function">is_available</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    #查看cuda是否可用
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span>torch<span class="token punctuation">.</span>__version__                    #查看torch版本
</code></pre> 
<hr> 
<h3><a id="2Detectron2_48"></a>2.安装Detectron2</h3> 
<p>基本要求如下<br> <img src="https://images2.imgbox.com/42/59/uXqYGKeQ_o.png" alt="在这里插入图片描述"><br> 下载代码</p> 
<pre><code class="prism language-c">git clone https<span class="token operator">:</span><span class="token comment">//github.com/facebookresearch/detectron2.git   #用git下载代码</span>
python <span class="token operator">-</span>m pip install <span class="token operator">-</span>e detectron2                            #安装detectron2
</code></pre> 
<hr> 
<h3><a id="3AdelaiDet_59"></a>3.安装AdelaiDet</h3> 
<pre><code class="prism language-c">git clone https<span class="token operator">:</span><span class="token comment">//github.com/aim-uofa/AdelaiDet.git     </span>
cd AdelaiDet
python setup<span class="token punctuation">.</span>py build develop                      #进行编译
</code></pre> 
<hr> 
<h3><a id="4demo_66"></a>4.用官方权重调通demo</h3> 
<p>1.文件依赖的requirements要记得安装，一般都在requirements.txt里面<br> 2.选择一个官方已经训练好的模型权重，如<a href="https://cloudstor.aarnet.edu.au/plus/s/vbnKnQtaGlw8TKv/download" rel="nofollow">blendmask_r101_dcni3_5x.pth</a><br> 2.将blendmask_r101_dcni3_5x.pth放于AdelaiDet目录下<br> 3.在终端运行</p> 
<pre><code class="prism language-c">python demo<span class="token operator">/</span>demo<span class="token punctuation">.</span>py \
    <span class="token operator">--</span>config<span class="token operator">-</span>file configs<span class="token operator">/</span>BlendMask<span class="token operator">/</span>R_101_dcni3_5x<span class="token punctuation">.</span>yaml \
    <span class="token operator">--</span>input input1<span class="token punctuation">.</span>jpg \
    <span class="token operator">--</span>confidence<span class="token operator">-</span>threshold <span class="token number">0.35</span> \
    <span class="token operator">--</span>opts MODEL<span class="token punctuation">.</span>WEIGHTS blendmask_r101_dcni3_5x<span class="token punctuation">.</span>pth
</code></pre> 
<p>input1.jpg是自己选择的图片放在datasets下面的</p> 
<p>若出现实例分割图片则为成功</p> 
<p><img src="https://images2.imgbox.com/3b/65/1WVA8JTO_o.png" alt="在这里插入图片描述"></p> 
<hr> 
<h3><a id="5COCO2014_85"></a>5.使用COCO数据集2014</h3> 
<p>1.首先在<a href="https://cocodataset.org/" rel="nofollow">COCO数据集官网</a>下载2014的COCO数据集<br> 目录结构为：<br> datasets/coco/annotations<br> /train2014 #训练数据集<br> /test2014 #测试数据集<br> /val2014 #验证数据集<br> <img src="https://images2.imgbox.com/2d/42/BxXRotec_o.png" alt="在这里插入图片描述"><br> 2.cd AdelaiDet/datasets，修改文件prepare_thing_sem_from_instance.py，将文件中的train2017改为train2014</p> 
<pre><code>if __name__ == "__main__":
    args = get_parser().parse_args()
    dataset_dir = os.path.join(os.path.dirname(__file__), args.dataset_name)
    if args.dataset_name == "coco":
        thing_id_to_contiguous_id = _get_coco_instances_meta()["thing_dataset_id_to_contiguous_id"]
        #split_name = 'train2017'
        split_name = 'train2014'
        annotation_name = "annotations/instances_{}.json"
    else:
        thing_id_to_contiguous_id = {1: 0}
        split_name = 'train'
        annotation_name = "annotations/{}_person.json"
    #for s in ["train2017"]:                                       注释部分为修改部分，将2017修改为2014
    for s in ["train2014"]:
        create_coco_semantic_from_instance(
            os.path.join(dataset_dir, "annotations/instances_{}.json".format(s)),
            os.path.join(dataset_dir, "thing_{}".format(s)),
            thing_id_to_contiguous_id
        )
</code></pre> 
<p>3.运行</p> 
<pre><code class="prism language-c">python datasets<span class="token operator">/</span>prepare_thing_sem_from_instance<span class="token punctuation">.</span>py #从实例标注中提取语义信息
</code></pre> 
<p>会生成一个thing_train2014的文件夹，里面的文件为npz结尾。</p> 
<hr> 
<h3><a id="6_122"></a>6.修改配置文件</h3> 
<p>1.cd AdelaiDet/configs/BlendMask/Base-BlendMask.yaml</p> 
<pre><code>DATASETS:
  #TRAIN: ("coco_2017_train",)
  #TEST: ("coco_2017_val",)
  TRAIN: ("coco_2014_train",)                                  #修改训练数据集
  TEST: ("coco_2014_val",)
SOLVER:
  IMS_PER_BATCH: 2                                            #根据你的GPU修改batch size
  BASE_LR: 0.01  # Note that RetinaNet uses a different default learning rate
  STEPS: (60000, 80000)
  MAX_ITER: 90000                                                #根据需求修改迭代次数
</code></pre> 
<p>2.cd AdelaiDet/adet/config/defaults.py ,将文档中SynBN改为BN，因为我是单GPU训练，Syn表示需要同时训练，有多GPU的不用改这一步</p> 
<pre><code>#_C.MODEL.BASIS_MODULE.NORM = "SyncBN"
_C.MODEL.BASIS_MODULE.NORM = "BN"

#_C.MODEL.FCPOSE.BASIS_MODULE.BN_TYPE = "SyncBN"
_C.MODEL.FCPOSE.BASIS_MODULE.BN_TYPE = "BN"
</code></pre> 
<hr> 
<h3><a id="7_146"></a>7.进行训练</h3> 
<p>1.cd AdelaiDet</p> 
<pre><code>OMP_NUM_THREADS=1 python tools/train_net.py \
    --config-file configs/BlendMask/R_50_1x.yaml \         #配置文档的路径
    --num-gpus 1 \                                         #设置的GPU为1
    OUTPUT_DIR training_dir/blendmask_R_50_1x              #训练完输出的路径
</code></pre> 
<p>如果能显示这个页面，说明已经成功运行！<br> <img src="https://images2.imgbox.com/ed/41/LZQ6KIRQ_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_157"></a>常见问题</h2> 
<p>1.可以上github该项目，点击Issue里面搜索，里面大多数问题都有人回答。<br> <img src="https://images2.imgbox.com/6f/8b/VVTAyRmu_o.png" alt="在这里插入图片描述"><br> 2.我遇到的问题<br> (1) <strong>No module named ‘detectron2.utils’</strong> <img src="https://images2.imgbox.com/2c/c9/DNbTJM7b_o.png" alt="在这里插入图片描述"><br> 解决方法：重新安装detectron2</p> 
<p>(2) <strong>No such file or directory: ‘…/datasets/train2014/00000000_56456687.npz’</strong><br> 解决办法：将生成的thing_train2014里面的npz文件全部放在train2014中</p> 
<p>(3）<strong>RuntimeError:Default process group has not been initialized,</strong><br> <img src="https://images2.imgbox.com/84/0d/4vT42VSF_o.png" alt="在这里插入图片描述"><br> 解决办法：这是因为原配置文件设置的多GPU，但是我运行的是单CPU，所以初始化不成功，需要去cd AdelaiDet/adet/config/defaults.py ,将文档中SynBN改为BN，</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9ab4ea8fb315aead4d124a32cbdf4592/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">git commit代码报错 操作任何git命令，都提示该内容。Another git process seems to be running in this repository, e.g.an</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b37ea5bd935815f4ce428206cd9089e2/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">顺序表删除元素</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>