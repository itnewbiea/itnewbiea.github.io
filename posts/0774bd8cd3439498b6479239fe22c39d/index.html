<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>正点原子阿波罗F429&#43;STM32CubeMX&#43;LAN8720&#43;LWIP:不带操作系统实现网络热插拔 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="正点原子阿波罗F429&#43;STM32CubeMX&#43;LAN8720&#43;LWIP:不带操作系统实现网络热插拔" />
<meta property="og:description" content="1.前言 此文章是基于正点原子阿波罗F429开发版的,
利用STM32CubeMX新建一个项目带串口printf输出的,请查看我前面的文章,这里跳过新建项目的那些.
点击跳转
2.TM32CubeMX配置 1.ETH配置.,除了标记的地方,其它都是默认值
2.lwip配置.除了标记的地方,其它都是默认值.
3.生成代码.打开项目.
3 代码调试 新建四个文件,分别为:pcf8574.c,pcf8574.h,myiic.c,myiic.h.这四个文件是基于正点原子代码改的,主要是为了复位LAN8720用的.因为LAN8720的复位脚不是直接MCU上的,而是接在PCF8574那里的.但是正点原子的代码是适合在他的教程代码的.不适合我们STM32CubeMX直接生成的代码.我稍作了修改.修改后代码如下.
3.1 pcf8574.c全部代码 #include &#34;pcf8574.h&#34; //	//本程序只供学习使用，未经作者许可，不得用于其它任何用途 //ALIENTEK STM32F429开发板 //PCF8574驱动代码	//正点原子@ALIENTEK //技术论坛:www.openedv.com //创建日期:2016/1/13 //版本：V1.0 //版权所有，盗版必究。 //Copyright(C) 广州市星翼电子科技有限公司 2014-2024 //All rights reserved	// //初始化PCF8574 uint8_t PCF8574_Init(void) { uint8_t temp=0; GPIO_InitTypeDef GPIO_Initure; __HAL_RCC_GPIOB_CLK_ENABLE(); //使能GPIOB时钟 GPIO_Initure.Pin=GPIO_PIN_12; //PB12 GPIO_Initure.Mode=GPIO_MODE_INPUT; //输入 GPIO_Initure.Pull=GPIO_PULLUP; //上拉 GPIO_Initure.Speed=GPIO_SPEED_HIGH; //高速 HAL_GPIO_Init(GPIOB,&amp;GPIO_Initure); //初始化 IIC_Init();	//IIC初始化 //检查PCF8574是否在位 IIC_Start(); IIC_Send_Byte(PCF8574_ADDR); //写地址	temp=IIC_Wait_Ack();	//等待应答,通过判断是否有ACK应答,来判断PCF8574的状态 IIC_Stop();	//产生一个停止条件 PCF8574_WriteOneByte(0XFF);	//默认情况下所有IO输出高电平 return temp; } //读取PCF8574的8位IO值 //返回值:读到的数据 uint8_t PCF8574_ReadOneByte(void) {	uint8_t temp=0;	IIC_Start(); IIC_Send_Byte(PCF8574_ADDR|0X01); //进入接收模式	IIC_Wait_Ack();	temp=IIC_Read_Byte(0);	IIC_Stop();	//产生一个停止条件	return temp; } //向PCF8574写入8位IO值 //DataToWrite:要写入的数据 void PCF8574_WriteOneByte(uint8_t DataToWrite) {	IIC_Start(); IIC_Send_Byte(PCF8574_ADDR|0X00); //发送器件地址0X40,写数据 IIC_Wait_Ack();	IIC_Send_Byte(DataToWrite); //发送字节	IIC_Wait_Ack(); IIC_Stop();	//产生一个停止条件 HAL_Delay(10);	} //设置PCF8574某个IO的高低电平 //bit:要设置的IO编号,0~7 //sta:IO的状态;0或1 void PCF8574_WriteBit(uint8_t bit,uint8_t sta) { __IO uint8_t data; data=PCF8574_ReadOneByte(); //先读出原来的设置 if(sta==0)data&amp;=~(1&lt;&lt;bit); else data|=1&lt;&lt;bit; PCF8574_WriteOneByte(data); //写入新的数据 } //读取PCF8574的某个IO的值 //bit：要读取的IO编号,0~7 //返回值:此IO的值,0或1 uint8_t PCF8574_ReadBit(uint8_t bit) { uint8_t data; data=PCF8574_ReadOneByte(); //先读取这个8位IO的值 if(data&amp;(1&lt;&lt;bit))return 1; else return 0; } 3." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/0774bd8cd3439498b6479239fe22c39d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-12-30T20:09:25+08:00" />
<meta property="article:modified_time" content="2019-12-30T20:09:25+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">正点原子阿波罗F429&#43;STM32CubeMX&#43;LAN8720&#43;LWIP:不带操作系统实现网络热插拔</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="1_0"></a>1.前言</h2> 
<p>此文章是基于正点原子阿波罗F429开发版的,<br> 利用STM32CubeMX新建一个项目带串口printf输出的,请查看我前面的文章,这里跳过新建项目的那些.<br> <a href="https://blog.csdn.net/u013809244/article/details/103767583">点击跳转</a></p> 
<h2><a id="2TM32CubeMX_4"></a>2.TM32CubeMX配置</h2> 
<p><img src="https://images2.imgbox.com/9a/94/DTPg4cEj_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/70/37/k31hysDY_o.png" alt="在这里插入图片描述"><br> 1.ETH配置.,除了标记的地方,其它都是默认值<br> <img src="https://images2.imgbox.com/c1/7a/NWSGSf8c_o.png" alt="在这里插入图片描述"><br> 2.lwip配置.除了标记的地方,其它都是默认值.<br> 3.生成代码.打开项目.</p> 
<h2><a id="3__11"></a>3 代码调试</h2> 
<p>新建四个文件,分别为:<mark>pcf8574.c</mark>,<mark>pcf8574.h</mark>,<mark>myiic.c</mark>,<mark>myiic.h</mark>.这四个文件是基于正点原子代码改的,主要是为了复位LAN8720用的.因为LAN8720的复位脚不是直接MCU上的,而是接在PCF8574那里的.但是正点原子的代码是适合在他的教程代码的.不适合我们STM32CubeMX直接生成的代码.我稍作了修改.修改后代码如下.</p> 
<h3><a id="31_pcf8574c_13"></a>3.1 pcf8574.c全部代码</h3> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"pcf8574.h"</span></span>

<span class="token comment">//	 </span>
<span class="token comment">//本程序只供学习使用，未经作者许可，不得用于其它任何用途</span>
<span class="token comment">//ALIENTEK STM32F429开发板</span>
<span class="token comment">//PCF8574驱动代码	   </span>
<span class="token comment">//正点原子@ALIENTEK</span>
<span class="token comment">//技术论坛:www.openedv.com</span>
<span class="token comment">//创建日期:2016/1/13</span>
<span class="token comment">//版本：V1.0</span>
<span class="token comment">//版权所有，盗版必究。</span>
<span class="token comment">//Copyright(C) 广州市星翼电子科技有限公司 2014-2024</span>
<span class="token comment">//All rights reserved									  </span>
<span class="token comment">// 	</span>

<span class="token comment">//初始化PCF8574</span>
uint8_t <span class="token function">PCF8574_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    uint8_t temp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    GPIO_InitTypeDef GPIO_Initure<span class="token punctuation">;</span>
    <span class="token function">__HAL_RCC_GPIOB_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">//使能GPIOB时钟</span>
	
    GPIO_Initure<span class="token punctuation">.</span>Pin<span class="token operator">=</span>GPIO_PIN_12<span class="token punctuation">;</span>           <span class="token comment">//PB12</span>
    GPIO_Initure<span class="token punctuation">.</span>Mode<span class="token operator">=</span>GPIO_MODE_INPUT<span class="token punctuation">;</span>      <span class="token comment">//输入</span>
    GPIO_Initure<span class="token punctuation">.</span>Pull<span class="token operator">=</span>GPIO_PULLUP<span class="token punctuation">;</span>          <span class="token comment">//上拉</span>
    GPIO_Initure<span class="token punctuation">.</span>Speed<span class="token operator">=</span>GPIO_SPEED_HIGH<span class="token punctuation">;</span>     <span class="token comment">//高速</span>
    <span class="token function">HAL_GPIO_Init</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span><span class="token operator">&amp;</span>GPIO_Initure<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//初始化</span>
    <span class="token function">IIC_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>					            <span class="token comment">//IIC初始化 	</span>
	<span class="token comment">//检查PCF8574是否在位</span>
    <span class="token function">IIC_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    	 	   
	<span class="token function">IIC_Send_Byte</span><span class="token punctuation">(</span>PCF8574_ADDR<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//写地址			   </span>
	temp<span class="token operator">=</span><span class="token function">IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		            <span class="token comment">//等待应答,通过判断是否有ACK应答,来判断PCF8574的状态</span>
    <span class="token function">IIC_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>					            <span class="token comment">//产生一个停止条件</span>
    <span class="token function">PCF8574_WriteOneByte</span><span class="token punctuation">(</span><span class="token number">0XFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	            <span class="token comment">//默认情况下所有IO输出高电平</span>
	<span class="token keyword">return</span> temp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//读取PCF8574的8位IO值</span>
<span class="token comment">//返回值:读到的数据</span>
uint8_t <span class="token function">PCF8574_ReadOneByte</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>				  
	uint8_t temp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>		  	    																 
    <span class="token function">IIC_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    	 	   
	<span class="token function">IIC_Send_Byte</span><span class="token punctuation">(</span>PCF8574_ADDR<span class="token operator">|</span><span class="token number">0X01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//进入接收模式			   </span>
	<span class="token function">IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	 
    temp<span class="token operator">=</span><span class="token function">IIC_Read_Byte</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		   
    <span class="token function">IIC_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>							<span class="token comment">//产生一个停止条件	    </span>
	<span class="token keyword">return</span> temp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//向PCF8574写入8位IO值  </span>
<span class="token comment">//DataToWrite:要写入的数据</span>
<span class="token keyword">void</span> <span class="token function">PCF8574_WriteOneByte</span><span class="token punctuation">(</span>uint8_t DataToWrite<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>				   	  	    																 
    <span class="token function">IIC_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token function">IIC_Send_Byte</span><span class="token punctuation">(</span>PCF8574_ADDR<span class="token operator">|</span><span class="token number">0X00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//发送器件地址0X40,写数据 	 </span>
	<span class="token function">IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	    										  		   
	<span class="token function">IIC_Send_Byte</span><span class="token punctuation">(</span>DataToWrite<span class="token punctuation">)</span><span class="token punctuation">;</span>    	 	<span class="token comment">//发送字节							   </span>
	<span class="token function">IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      
    <span class="token function">IIC_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>							<span class="token comment">//产生一个停止条件 </span>
	<span class="token function">HAL_Delay</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	 
<span class="token punctuation">}</span>

<span class="token comment">//设置PCF8574某个IO的高低电平</span>
<span class="token comment">//bit:要设置的IO编号,0~7</span>
<span class="token comment">//sta:IO的状态;0或1</span>
<span class="token keyword">void</span> <span class="token function">PCF8574_WriteBit</span><span class="token punctuation">(</span>uint8_t bit<span class="token punctuation">,</span>uint8_t sta<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    __IO uint8_t data<span class="token punctuation">;</span>
    data<span class="token operator">=</span><span class="token function">PCF8574_ReadOneByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//先读出原来的设置</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>sta<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>data<span class="token operator">&amp;</span><span class="token operator">=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span>bit<span class="token punctuation">)</span><span class="token punctuation">;</span>     
    <span class="token keyword">else</span> data<span class="token operator">|</span><span class="token operator">=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span>bit<span class="token punctuation">;</span>
    <span class="token function">PCF8574_WriteOneByte</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//写入新的数据</span>
<span class="token punctuation">}</span>

<span class="token comment">//读取PCF8574的某个IO的值</span>
<span class="token comment">//bit：要读取的IO编号,0~7</span>
<span class="token comment">//返回值:此IO的值,0或1</span>
uint8_t <span class="token function">PCF8574_ReadBit</span><span class="token punctuation">(</span>uint8_t bit<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    uint8_t data<span class="token punctuation">;</span>
    data<span class="token operator">=</span><span class="token function">PCF8574_ReadOneByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//先读取这个8位IO的值 </span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>data<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span>bit<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>   
<span class="token punctuation">}</span>  
    
</code></pre> 
<h3><a id="32_pcf8574h_102"></a>3.2 pcf8574.h全部代码</h3> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">ifndef</span> __PCF8574_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __PCF8574_H</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"myiic.h"</span></span>
<span class="token comment">//	 </span>
<span class="token comment">//本程序只供学习使用，未经作者许可，不得用于其它任何用途</span>
<span class="token comment">//ALIENTEK STM32F429开发板</span>
<span class="token comment">//PCF8574驱动代码	   </span>
<span class="token comment">//正点原子@ALIENTEK</span>
<span class="token comment">//技术论坛:www.openedv.com</span>
<span class="token comment">//创建日期:2016/1/13</span>
<span class="token comment">//版本：V1.0</span>
<span class="token comment">//版权所有，盗版必究。</span>
<span class="token comment">//Copyright(C) 广州市星翼电子科技有限公司 2014-2024</span>
<span class="token comment">//All rights reserved									  </span>
<span class="token comment">// 	</span>

<span class="token macro property">#<span class="token directive keyword">define</span> PCF8574_INT  PBin(12) </span><span class="token comment">//PCF8574 INT脚</span>

<span class="token macro property">#<span class="token directive keyword">define</span> PCF8574_ADDR 	0X40	</span><span class="token comment">//PCF8574地址(左移了一位)</span>

<span class="token comment">//PCF8574各个IO的功能</span>
<span class="token macro property">#<span class="token directive keyword">define</span> BEEP_IO         0		</span><span class="token comment">//蜂鸣器控制引脚  	P0</span>
<span class="token macro property">#<span class="token directive keyword">define</span> AP_INT_IO       1   	</span><span class="token comment">//AP3216C中断引脚	P1</span>
<span class="token macro property">#<span class="token directive keyword">define</span> DCMI_PWDN_IO    2    	</span><span class="token comment">//DCMI的电源控制引脚	P2</span>
<span class="token macro property">#<span class="token directive keyword">define</span> USB_PWR_IO      3    	</span><span class="token comment">//USB电源控制引脚	P3</span>
<span class="token macro property">#<span class="token directive keyword">define</span> EX_IO      		4    	</span><span class="token comment">//扩展IO,自定义使用 	P4</span>
<span class="token macro property">#<span class="token directive keyword">define</span> MPU_INT_IO      5   	</span><span class="token comment">//MPU9250中断引脚	P5</span>
<span class="token macro property">#<span class="token directive keyword">define</span> RS485_RE_IO     6    	</span><span class="token comment">//RS485_RE引脚		P6</span>
<span class="token macro property">#<span class="token directive keyword">define</span> ETH_RESET_IO    7    	</span><span class="token comment">//以太网复位引脚		P7</span>

uint8_t <span class="token function">PCF8574_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
uint8_t <span class="token function">PCF8574_ReadOneByte</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">void</span> <span class="token function">PCF8574_WriteOneByte</span><span class="token punctuation">(</span>uint8_t DataToWrite<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">PCF8574_WriteBit</span><span class="token punctuation">(</span>uint8_t bit<span class="token punctuation">,</span>uint8_t sta<span class="token punctuation">)</span><span class="token punctuation">;</span>
uint8_t <span class="token function">PCF8574_ReadBit</span><span class="token punctuation">(</span>uint8_t bit<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>


</code></pre> 
<h3><a id="33_myiicc_144"></a>3.3 myiic.c全部代码</h3> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"myiic.h"</span></span>

<span class="token comment">//	 </span>
<span class="token comment">//本程序只供学习使用，未经作者许可，不得用于其它任何用途</span>
<span class="token comment">//ALIENTEK STM32F429开发板</span>
<span class="token comment">//IIC驱动代码	   </span>
<span class="token comment">//正点原子@ALIENTEK</span>
<span class="token comment">//技术论坛:www.openedv.com</span>
<span class="token comment">//创建日期:2016/1/13</span>
<span class="token comment">//版本：V1.0</span>
<span class="token comment">//版权所有，盗版必究。</span>
<span class="token comment">//Copyright(C) 广州市星翼电子科技有限公司 2014-2024</span>
<span class="token comment">//All rights reserved									  </span>
<span class="token comment">// 	</span>
<span class="token keyword">void</span> <span class="token function">delay_us</span><span class="token punctuation">(</span>uint32_t nus<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>		
	uint32_t ticks<span class="token punctuation">;</span>
	uint32_t told<span class="token punctuation">,</span>tnow<span class="token punctuation">,</span>tcnt<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	uint32_t reload<span class="token operator">=</span>SysTick<span class="token operator">-&gt;</span>LOAD<span class="token punctuation">;</span>				<span class="token comment">//LOAD的值	    	 </span>
	ticks<span class="token operator">=</span>nus<span class="token operator">*</span><span class="token number">180</span><span class="token punctuation">;</span> 						<span class="token comment">//需要的节拍数 </span>
	told<span class="token operator">=</span>SysTick<span class="token operator">-&gt;</span>VAL<span class="token punctuation">;</span>        				<span class="token comment">//刚进入时的计数器值</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		tnow<span class="token operator">=</span>SysTick<span class="token operator">-&gt;</span>VAL<span class="token punctuation">;</span>	
		<span class="token keyword">if</span><span class="token punctuation">(</span>tnow<span class="token operator">!=</span>told<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>	    
			<span class="token keyword">if</span><span class="token punctuation">(</span>tnow<span class="token operator">&lt;</span>told<span class="token punctuation">)</span>tcnt<span class="token operator">+</span><span class="token operator">=</span>told<span class="token operator">-</span>tnow<span class="token punctuation">;</span>	<span class="token comment">//这里注意一下SYSTICK是一个递减的计数器就可以了.</span>
			<span class="token keyword">else</span> tcnt<span class="token operator">+</span><span class="token operator">=</span>reload<span class="token operator">-</span>tnow<span class="token operator">+</span>told<span class="token punctuation">;</span>	    
			told<span class="token operator">=</span>tnow<span class="token punctuation">;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>tcnt<span class="token operator">&gt;=</span>ticks<span class="token punctuation">)</span><span class="token keyword">break</span><span class="token punctuation">;</span>			<span class="token comment">//时间超过/等于要延迟的时间,则退出.</span>
		<span class="token punctuation">}</span>  
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//IIC初始化</span>
<span class="token keyword">void</span> <span class="token function">IIC_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    GPIO_InitTypeDef GPIO_Initure<span class="token punctuation">;</span>
    
    <span class="token function">__HAL_RCC_GPIOH_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//使能GPIOH时钟</span>
    
    <span class="token comment">//PH4,5初始化设置</span>
    GPIO_Initure<span class="token punctuation">.</span>Pin<span class="token operator">=</span>GPIO_PIN_4<span class="token operator">|</span>GPIO_PIN_5<span class="token punctuation">;</span>
    GPIO_Initure<span class="token punctuation">.</span>Mode<span class="token operator">=</span>GPIO_MODE_OUTPUT_PP<span class="token punctuation">;</span>  <span class="token comment">//推挽输出</span>
    GPIO_Initure<span class="token punctuation">.</span>Pull<span class="token operator">=</span>GPIO_PULLUP<span class="token punctuation">;</span>          <span class="token comment">//上拉</span>
    GPIO_Initure<span class="token punctuation">.</span>Speed<span class="token operator">=</span>GPIO_SPEED_FAST<span class="token punctuation">;</span>     <span class="token comment">//快速</span>
    <span class="token function">HAL_GPIO_Init</span><span class="token punctuation">(</span>GPIOH<span class="token punctuation">,</span><span class="token operator">&amp;</span>GPIO_Initure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">IIC_SDA</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">IIC_SCL</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	
<span class="token punctuation">}</span>

<span class="token comment">//产生IIC起始信号</span>
<span class="token keyword">void</span> <span class="token function">IIC_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">SDA_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//sda线输出</span>
	<span class="token function">IIC_SDA</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	  	  
	<span class="token function">IIC_SCL</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 	<span class="token function">IIC_SDA</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//START:when CLK is high,DATA change form high to low </span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">IIC_SCL</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//钳住I2C总线，准备发送或接收数据 </span>
<span class="token punctuation">}</span>	  
<span class="token comment">//产生IIC停止信号</span>
<span class="token keyword">void</span> <span class="token function">IIC_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">SDA_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//sda线输出</span>
	<span class="token function">IIC_SCL</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">IIC_SDA</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//STOP:when CLK is high DATA change form low to high</span>
 	<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">IIC_SCL</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token function">IIC_SDA</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//发送I2C总线结束信号</span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>							   	
<span class="token punctuation">}</span>
<span class="token comment">//等待应答信号到来</span>
<span class="token comment">//返回值：1，接收应答失败</span>
<span class="token comment">//        0，接收应答成功</span>
uint8_t <span class="token function">IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	uint8_t ucErrTime<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">SDA_IN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//SDA设置为输入  </span>
	<span class="token function">IIC_SDA</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	   
	<span class="token function">IIC_SCL</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	 
	<span class="token keyword">while</span><span class="token punctuation">(</span>READ_SDA<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		ucErrTime<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>ucErrTime<span class="token operator">&gt;</span><span class="token number">250</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">IIC_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token function">IIC_SCL</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//时钟输出0 	   </span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span> 
<span class="token comment">//产生ACK应答</span>
<span class="token keyword">void</span> <span class="token function">IIC_Ack</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">IIC_SCL</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">SDA_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">IIC_SDA</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">IIC_SCL</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">IIC_SCL</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//不产生ACK应答		    </span>
<span class="token keyword">void</span> <span class="token function">IIC_NAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">IIC_SCL</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">SDA_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">IIC_SDA</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">IIC_SCL</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">IIC_SCL</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>					 				     
<span class="token comment">//IIC发送一个字节</span>
<span class="token comment">//返回从机有无应答</span>
<span class="token comment">//1，有应答</span>
<span class="token comment">//0，无应答			  </span>
<span class="token keyword">void</span> <span class="token function">IIC_Send_Byte</span><span class="token punctuation">(</span>uint8_t txd<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>                        
    uint8_t t<span class="token punctuation">;</span>   
	<span class="token function">SDA_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 	    
    <span class="token function">IIC_SCL</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//拉低时钟开始数据传输</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>t<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>t<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>t<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>              
        <span class="token function">IIC_SDA</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>txd<span class="token operator">&amp;</span><span class="token number">0x80</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">7</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        txd<span class="token operator">&lt;&lt;=</span><span class="token number">1</span><span class="token punctuation">;</span> 	  
		<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//对TEA5767这三个延时都是必须的</span>
		<span class="token function">IIC_SCL</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
		<span class="token function">IIC_SCL</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
		<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>	 
<span class="token punctuation">}</span> 	    
<span class="token comment">//读1个字节，ack=1时，发送ACK，ack=0，发送nACK   </span>
uint8_t <span class="token function">IIC_Read_Byte</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> ack<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> i<span class="token punctuation">,</span>receive<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">SDA_IN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//SDA设置为输入</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span> <span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
        <span class="token function">IIC_SCL</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">IIC_SCL</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        receive<span class="token operator">&lt;&lt;=</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>READ_SDA<span class="token punctuation">)</span>receive<span class="token operator">++</span><span class="token punctuation">;</span>   
		<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>					 
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ack<span class="token punctuation">)</span>
        <span class="token function">IIC_NAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//发送nACK</span>
    <span class="token keyword">else</span>
        <span class="token function">IIC_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//发送ACK   </span>
    <span class="token keyword">return</span> receive<span class="token punctuation">;</span>
<span class="token punctuation">}</span>



</code></pre> 
<h3><a id="34_myiich_308"></a>3.4 myiic.h全部代码</h3> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">ifndef</span> _MYIIC_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> _MYIIC_H</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"main.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"lwip.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"usart.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"gpio.h"</span></span>
<span class="token comment">//	 </span>
<span class="token comment">//本程序只供学习使用，未经作者许可，不得用于其它任何用途</span>
<span class="token comment">//ALIENTEK STM32F429开发板</span>
<span class="token comment">//IIC驱动代码	   </span>
<span class="token comment">//正点原子@ALIENTEK</span>
<span class="token comment">//技术论坛:www.openedv.com</span>
<span class="token comment">//创建日期:2016/1/13</span>
<span class="token comment">//版本：V1.0</span>
<span class="token comment">//版权所有，盗版必究。</span>
<span class="token comment">//Copyright(C) 广州市星翼电子科技有限公司 2014-2024</span>
<span class="token comment">//All rights reserved									  </span>
<span class="token comment">// 	</span>
<span class="token comment">//IO方向设置</span>
<span class="token macro property">#<span class="token directive keyword">define</span> SDA_IN()  {GPIOH-&gt;MODER&amp;=~(3&lt;&lt;(5*2));GPIOH-&gt;MODER|=0&lt;&lt;5*2;}	</span><span class="token comment">//PH5输入模式</span>
<span class="token macro property">#<span class="token directive keyword">define</span> SDA_OUT() {GPIOH-&gt;MODER&amp;=~(3&lt;&lt;(5*2));GPIOH-&gt;MODER|=1&lt;&lt;5*2;} </span><span class="token comment">//PH5输出模式</span>
<span class="token comment">//IO操作</span>
<span class="token macro property">#<span class="token directive keyword">define</span> IIC_SCL(a)   	if(a)	HAL_GPIO_WritePin(GPIOH,GPIO_PIN_4,GPIO_PIN_SET); else HAL_GPIO_WritePin(GPIOH,GPIO_PIN_4,GPIO_PIN_RESET);</span><span class="token comment">//SCL</span>
<span class="token macro property">#<span class="token directive keyword">define</span> IIC_SDA(a)  	if(a)	HAL_GPIO_WritePin(GPIOH,GPIO_PIN_5,GPIO_PIN_SET); else HAL_GPIO_WritePin(GPIOH,GPIO_PIN_5,GPIO_PIN_RESET);</span><span class="token comment">//SCL</span>
<span class="token macro property">#<span class="token directive keyword">define</span> READ_SDA  		HAL_GPIO_ReadPin(GPIOH,GPIO_PIN_5)</span>

<span class="token comment">//IIC所有操作函数</span>
<span class="token keyword">void</span> <span class="token function">IIC_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//初始化IIC的IO口				 </span>
<span class="token keyword">void</span> <span class="token function">IIC_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">//发送IIC开始信号</span>
<span class="token keyword">void</span> <span class="token function">IIC_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	  			<span class="token comment">//发送IIC停止信号</span>
<span class="token keyword">void</span> <span class="token function">IIC_Send_Byte</span><span class="token punctuation">(</span>uint8_t txd<span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//IIC发送一个字节</span>
uint8_t <span class="token function">IIC_Read_Byte</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> ack<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//IIC读取一个字节</span>
uint8_t <span class="token function">IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 				<span class="token comment">//IIC等待ACK信号</span>
<span class="token keyword">void</span> <span class="token function">IIC_Ack</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>					<span class="token comment">//IIC发送ACK信号</span>
<span class="token keyword">void</span> <span class="token function">IIC_NAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">//IIC不发送ACK信号</span>

<span class="token keyword">void</span> <span class="token function">IIC_Write_One_Byte</span><span class="token punctuation">(</span>uint8_t daddr<span class="token punctuation">,</span>uint8_t addr<span class="token punctuation">,</span>uint8_t data<span class="token punctuation">)</span><span class="token punctuation">;</span>
uint8_t <span class="token function">IIC_Read_One_Byte</span><span class="token punctuation">(</span>uint8_t daddr<span class="token punctuation">,</span>uint8_t addr<span class="token punctuation">)</span><span class="token punctuation">;</span>	 


<span class="token macro property">#<span class="token directive keyword">endif</span></span>


</code></pre> 
<h3><a id="35_357"></a>3.5代码调试</h3> 
<p>在<mark>main.c中</mark>添加头文件:<mark>#include “pcf8574.h”</mark></p> 
<pre><code class="prism language-c"><span class="token comment">/* USER CODE BEGIN Includes */</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"stdio.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"pcf8574.h"</span></span>
<span class="token comment">/* USER CODE END Includes */</span>
</code></pre> 
<p>在main函数中添加PCF8574的初始化函数:<mark>PCF8574_Init();</mark></p> 
<pre><code class="prism language-c">  <span class="token comment">/* USER CODE BEGIN SysInit */</span>
	<span class="token function">PCF8574_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* USER CODE END SysInit */</span>
</code></pre> 
<p>打开<mark>ethernetif.c</mark><br> 在<mark>ethernetif.c</mark>添加头文件:<mark>#include “pcf8574.h”</mark><br> 在==static void low_level_init(struct netif *netif)==函数中添加下面代码:</p> 
<pre><code class="prism language-c">  <span class="token comment">/* USER CODE BEGIN MACADDRESS */</span>
    <span class="token function">PCF8574_WriteBit</span><span class="token punctuation">(</span>ETH_RESET_IO<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">//硬件复位</span>
	<span class="token function">HAL_Delay</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">PCF8574_WriteBit</span><span class="token punctuation">(</span>ETH_RESET_IO<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">//复位结束</span>
	<span class="token function">HAL_Delay</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* USER CODE END MACADDRESS */</span>
</code></pre> 
<p>打开<mark>stm32f4xx_hal_eth.c</mark>找到==HAL_StatusTypeDef HAL_ETH_Init(ETH_HandleTypeDef *heth)==函数修改里面的两端代码(不修改也没事,只是开机有时候会判断为连接错误,具体原因没找.)</p> 
<pre><code class="prism language-c">      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">HAL_GetTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> tickstart <span class="token punctuation">)</span> <span class="token operator">&gt;</span> ETH_TIMEOUT_LINKED_STATE<span class="token punctuation">)</span>
      <span class="token punctuation">{<!-- --></span>
<span class="token comment">//        /* In case of write timeout */</span>
<span class="token comment">//        err = ETH_ERROR;</span>
<span class="token comment">//      </span>
<span class="token comment">//        /* Config MAC and DMA */</span>
<span class="token comment">//        ETH_MACDMAConfig(heth, err);</span>
<span class="token comment">//        </span>
<span class="token comment">//        heth-&gt;State= HAL_ETH_STATE_READY;</span>
<span class="token comment">//  </span>
<span class="token comment">//        /* Process Unlocked */</span>
<span class="token comment">//        __HAL_UNLOCK(heth);</span>
<span class="token comment">//    </span>
<span class="token comment">//        return HAL_TIMEOUT;</span>
		  <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>phyreg <span class="token operator">&amp;</span> PHY_LINKED_STATUS<span class="token punctuation">)</span> <span class="token operator">!=</span> PHY_LINKED_STATUS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-c">      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">HAL_GetTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> tickstart <span class="token punctuation">)</span> <span class="token operator">&gt;</span> ETH_TIMEOUT_AUTONEGO_COMPLETED<span class="token punctuation">)</span>
      <span class="token punctuation">{<!-- --></span>
<span class="token comment">//        /* In case of write timeout */</span>
<span class="token comment">//        err = ETH_ERROR;</span>
<span class="token comment">//      </span>
<span class="token comment">//        /* Config MAC and DMA */</span>
<span class="token comment">//        ETH_MACDMAConfig(heth, err);</span>
<span class="token comment">//        </span>
<span class="token comment">//        heth-&gt;State= HAL_ETH_STATE_READY;</span>
<span class="token comment">//  </span>
<span class="token comment">//        /* Process Unlocked */</span>
<span class="token comment">//        __HAL_UNLOCK(heth);</span>
<span class="token comment">//    </span>
<span class="token comment">//        return HAL_TIMEOUT;</span>
		  <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>phyreg <span class="token operator">&amp;</span> PHY_AUTONEGO_COMPLETE<span class="token punctuation">)</span> <span class="token operator">!=</span> PHY_AUTONEGO_COMPLETE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>新建<mark>use_lwip.c</mark>和<mark>use_lwip.h</mark>.为了处理网络热插拔.</p> 
<h3><a id="36_use_lwipc_429"></a>3.6 use_lwip.c源码</h3> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"use_lwip.H"</span></span>

<span class="token keyword">extern</span> <span class="token keyword">struct</span> netif <span class="token operator">*</span>netif_default<span class="token punctuation">;</span>
<span class="token keyword">extern</span> <span class="token keyword">struct</span> netif gnetif<span class="token punctuation">;</span>
<span class="token keyword">extern</span> ETH_HandleTypeDef heth<span class="token punctuation">;</span>

<span class="token keyword">static</span> uint8_t b_ip_state <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>			<span class="token comment">//ip状态</span>
<span class="token keyword">static</span> uint8_t b_network_cable <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>		<span class="token comment">//网线状态</span>

<span class="token comment">/*插入网线的话重新获取IP操作*/</span>
<span class="token keyword">void</span> <span class="token function">ethernetif_notify_conn_changed</span><span class="token punctuation">(</span><span class="token keyword">struct</span> netif <span class="token operator">*</span>netif<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">netif_is_link_up</span><span class="token punctuation">(</span>netif<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">netif_is_up</span><span class="token punctuation">(</span>netif<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">netif_set_up</span><span class="token punctuation">(</span>netif<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">extern</span> err_t <span class="token function">dhcp_start</span><span class="token punctuation">(</span><span class="token keyword">struct</span> netif <span class="token operator">*</span>netif<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">dhcp_start</span><span class="token punctuation">(</span>netif<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
读取网线状态
读取IP值
*/</span>
<span class="token keyword">void</span> <span class="token function">use_read_network_cable</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

	uint32_t phy_data <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	
	<span class="token function">HAL_ETH_ReadPHYRegister</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>heth<span class="token punctuation">,</span> PHY_BSR<span class="token punctuation">,</span> <span class="token operator">&amp;</span>phy_data<span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//读取PHY数据</span>
	
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>phy_data <span class="token operator">&amp;</span> PHY_LINKED_STATUS<span class="token punctuation">)</span> <span class="token operator">!=</span> PHY_LINKED_STATUS<span class="token punctuation">)</span><span class="token punctuation">)</span>	<span class="token comment">//</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>b_network_cable<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
		b_network_cable <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"未插网线\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		b_ip_state <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		gnetif<span class="token punctuation">.</span>ip_addr<span class="token punctuation">.</span>addr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>b_network_cable<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		b_network_cable <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"已插网线\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">if</span><span class="token punctuation">(</span>b_ip_state<span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>gnetif<span class="token punctuation">.</span>ip_addr<span class="token punctuation">.</span>addr<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		b_ip_state <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		
		uint8_t ip4_number<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		ip4_number<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> gnetif<span class="token punctuation">.</span>hwaddr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		ip4_number<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> gnetif<span class="token punctuation">.</span>hwaddr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		ip4_number<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> gnetif<span class="token punctuation">.</span>hwaddr<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		ip4_number<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> gnetif<span class="token punctuation">.</span>hwaddr<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		ip4_number<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> gnetif<span class="token punctuation">.</span>hwaddr<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		ip4_number<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> gnetif<span class="token punctuation">.</span>hwaddr<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"MAC地址..............%x.%x.%x.%x.%x.%x\r\n"</span><span class="token punctuation">,</span>ip4_number<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>ip4_number<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>ip4_number<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>ip4_number<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>ip4_number<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>ip4_number<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		ip4_number<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> gnetif<span class="token punctuation">.</span>ip_addr<span class="token punctuation">.</span>addr <span class="token operator">&gt;&gt;</span> <span class="token number">24</span><span class="token punctuation">;</span>
		ip4_number<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> gnetif<span class="token punctuation">.</span>ip_addr<span class="token punctuation">.</span>addr <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">;</span>
		ip4_number<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> gnetif<span class="token punctuation">.</span>ip_addr<span class="token punctuation">.</span>addr <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">;</span>
		ip4_number<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> gnetif<span class="token punctuation">.</span>ip_addr<span class="token punctuation">.</span>addr <span class="token operator">&gt;&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"通过DHCP获取到IP地址..............%d.%d.%d.%d\r\n"</span><span class="token punctuation">,</span>ip4_number<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>ip4_number<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>ip4_number<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>ip4_number<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		ip4_number<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> gnetif<span class="token punctuation">.</span>netmask<span class="token punctuation">.</span>addr <span class="token operator">&gt;&gt;</span> <span class="token number">24</span><span class="token punctuation">;</span>
		ip4_number<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> gnetif<span class="token punctuation">.</span>netmask<span class="token punctuation">.</span>addr <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">;</span>
		ip4_number<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> gnetif<span class="token punctuation">.</span>netmask<span class="token punctuation">.</span>addr <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">;</span>
		ip4_number<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> gnetif<span class="token punctuation">.</span>netmask<span class="token punctuation">.</span>addr <span class="token operator">&gt;&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"通过DHCP获取到子网掩码..............%d.%d.%d.%d\r\n"</span><span class="token punctuation">,</span>ip4_number<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>ip4_number<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>ip4_number<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>ip4_number<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		ip4_number<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> gnetif<span class="token punctuation">.</span>gw<span class="token punctuation">.</span>addr <span class="token operator">&gt;&gt;</span> <span class="token number">24</span><span class="token punctuation">;</span>
		ip4_number<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> gnetif<span class="token punctuation">.</span>gw<span class="token punctuation">.</span>addr <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">;</span>
		ip4_number<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> gnetif<span class="token punctuation">.</span>gw<span class="token punctuation">.</span>addr <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">;</span>
		ip4_number<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> gnetif<span class="token punctuation">.</span>gw<span class="token punctuation">.</span>addr <span class="token operator">&gt;&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"通过DHCP获取到默认网关..............%d.%d.%d.%d\r\n"</span><span class="token punctuation">,</span>ip4_number<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>ip4_number<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>ip4_number<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>ip4_number<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">use_lwip_process</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">MX_LWIP_Process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>					<span class="token comment">//LWIP轮询任务</span>
	<span class="token function">ethernetif_set_link</span><span class="token punctuation">(</span>netif_default<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//重新插网线进行获取IP的任务</span>
	
	<span class="token function">use_read_network_cable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


</code></pre> 
<h3><a id="35_use_lwiph_525"></a>3.5 use_lwip.h源码</h3> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">ifndef</span> __use_lwip_h_</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __use_lwip_h_</span>

<span class="token comment">/* Includes ------------------------------------------------------------------*/</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"main.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"lwip.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"usart.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"gpio.h"</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"pcf8574.h"</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token keyword">void</span> <span class="token function">use_lwip_process</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span></span>


</code></pre> 
<p>在<mark>main.c中</mark>添加头文件:<mark>#include “use_lwip.h”</mark><br> 在main函数里添加一段如下代码:</p> 
<pre><code class="prism language-c">  <span class="token comment">/* USER CODE BEGIN WHILE */</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"程序开始\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
	  <span class="token function">use_lwip_process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* USER CODE END WHILE */</span>
</code></pre> 
<p>编译,连接开发版.打开串口调试助手,烧录代码到开发版.可以尝试插拔网线,并查看串口返回的信息.<br> <img src="https://images2.imgbox.com/ca/e7/UiGvDrCM_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0ae595f9bf550f81ff7f80654041f175/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">[c语言]c语言中的#和##作用、参数表省略号作用</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/0c2f9f05dbbf9d0467f94adc181376d9/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">DGL图异构神经网络</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>