<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>django-apschedule定时任务异常停止 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="django-apschedule定时任务异常停止" />
<meta property="og:description" content="背景 在django项目中使用django-apschedule来实现定时任务，使用的是BackgroundScheduler调度类，该调度的实现是通过后台线程的方式执行定时任务。其中任务都是持久化到数据库中的。
在项目的运行过程中，因为数据库的异常，导致定时任务线程异常终止，即使数据库后续恢复正常，但也不再继续执行。我多次尝试复现未果，在开启定时任务期间，手动将数据库连接断开，定时任务执行失败，然后再将数据库建立连接，定时任务竟然重新恢复了，这让我一时摸不着头脑。
具体的错误日志如下，通过分析，是update_job连接数据库异常，没有任何捕获机制，然后层层网上抛，最终导致线程停止，可以很肯定的是，绝对是因为数据库连接失败导致的定时任务失败，那为什么无法复现呢？
Traceback (most recent call last): File &#34;/usr/local/python3/lib/python3.7/threading.py&#34;, line 926, in _bootstrap_inner self.run() File &#34;/usr/local/python3/lib/python3.7/threading.py&#34;, line 870, in run self._target(*self._args, **self._kwargs) File &#34;/usr/local/python3/lib/python3.7/site-packages/apscheduler/schedulers/blocking.py&#34;, line 32, in _main_loop wait_seconds = self._process_jobs() File &#34;/usr/local/python3/lib/python3.7/site-packages/apscheduler/schedulers/base.py&#34;, line 1009, in _process_jobs jobstore.update_job(job) File &#34;/usr/local/python3/lib/python3.7/site-packages/django_apscheduler/util.py&#34;, line 105, in func_wrapper result = func(*args, **kwargs) File &#34;/usr/local/python3/lib/python3.7/site-packages/django_apscheduler/jobstores.py&#34;, line 249, in update_job with transaction.atomic(): File &#34;/usr/local/python3/lib/python3.7/site-packages/django/db/transaction.py&#34;, line 189, in __enter__ if not connection.get_autocommit(): File &#34;/usr/local/python3/lib/python3.7/site-packages/django/db/backends/base/base.py&#34;, line 389, in get_autocommit self." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/93f8179ffc2b89c4d03262326817dbd3/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-01T12:29:18+08:00" />
<meta property="article:modified_time" content="2023-11-01T12:29:18+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">django-apschedule定时任务异常停止</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>背景</h3> 
<p>在django项目中使用<code>django-apschedule</code>来实现定时任务，使用的是<code>BackgroundScheduler</code>调度类，该调度的实现是通过后台线程的方式执行定时任务。其中任务都是持久化到数据库中的。</p> 
<p>在项目的运行过程中，因为数据库的异常，导致定时任务线程异常终止，即使数据库后续恢复正常，但也不再继续执行。我多次尝试复现未果，在开启定时任务期间，手动将数据库连接断开，定时任务执行失败，然后再将数据库建立连接，定时任务竟然重新恢复了，这让我一时摸不着头脑。</p> 
<p>具体的错误日志如下，通过分析，是update_job连接数据库异常，没有任何捕获机制，然后层层网上抛，最终导致线程停止，可以很肯定的是，绝对是因为数据库连接失败导致的定时任务失败，那为什么无法复现呢？</p> 
<pre><code>Traceback (most recent call last):
  File "/usr/local/python3/lib/python3.7/threading.py", line 926, in _bootstrap_inner
    self.run()
  File "/usr/local/python3/lib/python3.7/threading.py", line 870, in run
    self._target(*self._args, **self._kwargs)
  File "/usr/local/python3/lib/python3.7/site-packages/apscheduler/schedulers/blocking.py", line 32, in _main_loop
    wait_seconds = self._process_jobs()
  File "/usr/local/python3/lib/python3.7/site-packages/apscheduler/schedulers/base.py", line 1009, in _process_jobs
    jobstore.update_job(job)
  File "/usr/local/python3/lib/python3.7/site-packages/django_apscheduler/util.py", line 105, in func_wrapper
    result = func(*args, **kwargs)
  File "/usr/local/python3/lib/python3.7/site-packages/django_apscheduler/jobstores.py", line 249, in update_job
    with transaction.atomic():
  File "/usr/local/python3/lib/python3.7/site-packages/django/db/transaction.py", line 189, in __enter__
    if not connection.get_autocommit():
  File "/usr/local/python3/lib/python3.7/site-packages/django/db/backends/base/base.py", line 389, in get_autocommit
    self.ensure_connection()
  File "/usr/local/python3/lib/python3.7/site-packages/django/utils/asyncio.py", line 33, in inner
     return func(*args, **kwargs)
  File "/usr/local/python3/lib/python3.7/site-packages/django/db/backends/base/base.py", line 219, in ensure_connection
    self.connect()
  File "/usr/local/python3/lib/python3.7/site-packages/django/db/utils.py", line 90, in __exit__
    raise dj_exc_value.with_traceback(traceback) from exc_value
  File "/usr/local/python3/lib/python3.7/site-packages/django/db/backends/base/base.py", line 219, in ensure_connection
    self.connect()
  File "/usr/local/python3/lib/python3.7/site-packages/django/utils/asyncio.py", line 33, in inner
    return func(*args, **kwargs)
  File "/usr/local/python3/lib/python3.7/site-packages/django/db/backends/base/base.py", line 200, in connect
    self.connection = self.get_new_connection(conn_params)
  File "/usr/local/python3/lib/python3.7/site-packages/django/utils/asyncio.py", line 33, in inner
    return func(*args, **kwargs)
  File "/usr/local/python3/lib/python3.7/site-packages/django/db/backends/postgresql/base.py", line 187, in get_new_connection
    connection = Database.connect(**conn_params)
  File "/usr/local/python3/lib/python3.7/site-packages/psycopg2/__init__.py", line 122, in connect
    conn = _connect(dsn, connection_factory=connection_factory, **kwasync)
django.db.utils.OperationalError: connection to server at "xxxx.postgresql.svc.cluster.local" (xx.xx.xx.xx), port xxxx failed: server closed the connection unexpectedly
This probably means the server terminated abnormally
before or while processing the request.

</code></pre> 
<h3><a id="_51"></a>源码分析原因</h3> 
<p>可以先看下<code>BackgroundScheduler</code>的实现方式，在<code>start</code>方法中创建了个子线程。</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">BackgroundScheduler</span><span class="token punctuation">(</span>BlockingScheduler<span class="token punctuation">)</span><span class="token punctuation">:</span>

    _thread <span class="token operator">=</span> <span class="token boolean">None</span>

    <span class="token keyword">def</span> <span class="token function">start</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_event <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">or</span> self<span class="token punctuation">.</span>_event<span class="token punctuation">.</span>is_set<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_event <span class="token operator">=</span> Event<span class="token punctuation">(</span><span class="token punctuation">)</span>

        BaseScheduler<span class="token punctuation">.</span>start<span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_thread <span class="token operator">=</span> Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>self<span class="token punctuation">.</span>_main_loop<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'APScheduler'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_thread<span class="token punctuation">.</span>daemon <span class="token operator">=</span> self<span class="token punctuation">.</span>_daemon
        self<span class="token punctuation">.</span>_thread<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">shutdown</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>BackgroundScheduler<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>shutdown<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_thread<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">del</span> self<span class="token punctuation">.</span>_thread
</code></pre> 
<p>其中<code>_main_loop</code>在<code>BlockingScheduler</code>中实现，是一个死循环，执行<code>_process_jobs</code>方法</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">BlockingScheduler</span><span class="token punctuation">(</span>BaseScheduler<span class="token punctuation">)</span><span class="token punctuation">:</span>
    
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">def</span> <span class="token function">_main_loop</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        wait_seconds <span class="token operator">=</span> TIMEOUT_MAX
        <span class="token keyword">while</span> self<span class="token punctuation">.</span>state <span class="token operator">!=</span> STATE_STOPPED<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_event<span class="token punctuation">.</span>wait<span class="token punctuation">(</span>wait_seconds<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>_event<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
            wait_seconds <span class="token operator">=</span> self<span class="token punctuation">.</span>_process_jobs<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<p>再看_process_jobs中的内容，在<code>BaseScheduler</code>实现的，主要流程如下，先找到所有要执行的job，然后进行遍历运行并更新Job的状态。之前的错误日志，也就是这里的update_job抛出异常，而这里并没有捕获异常，最终层层往上抛，<code>update_job -&gt; _process_jobs -&gt; _main_loop</code>，最终线程异常终止。</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">_process_jobs</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> jobstore_alias<span class="token punctuation">,</span> jobstore <span class="token keyword">in</span> six<span class="token punctuation">.</span>iteritems<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_jobstores<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            due_jobs <span class="token operator">=</span> jobstore<span class="token punctuation">.</span>get_due_jobs<span class="token punctuation">(</span>now<span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">continue</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                
        <span class="token keyword">for</span> job <span class="token keyword">in</span> due_jobs<span class="token punctuation">:</span>
      
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                executor<span class="token punctuation">.</span>submit_job<span class="token punctuation">(</span>job<span class="token punctuation">,</span> run_times<span class="token punctuation">)</span>
            <span class="token keyword">except</span> BaseException<span class="token punctuation">:</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            jobstore<span class="token punctuation">.</span>update_job<span class="token punctuation">(</span>job<span class="token punctuation">)</span>
</code></pre> 
<p>那为什么复现不了呢？这个是因为，关闭数据库连接时，程序不一定可以正好运行在<code>update_job</code>，可以看到前面的<code>get_due_jobs</code>进行了异常捕获，如果这里抛出数据库连接异常是可以捕获到的，然后跳过后面的操作，等待下一次定时任务的执行，如果还是失败，则再次等待，所以这里的异常不会抛到最上层导致线程停止。</p> 
<p>但如果某个时机，上面连接数据库都成功了，到update_job这里异常抛出，则会导致整个线程停止，定时任务不再执行。</p> 
<p>那如何解决该问题呢？</p> 
<h3><a id="demo_124"></a>搭建demo</h3> 
<p>首先我们搭建一个demo出来，模拟复现该问题。</p> 
<ol><li>创建django项目</li></ol> 
<pre><code class="prism language-python">
django<span class="token operator">-</span>admin startproject apschedule_demo

python manage<span class="token punctuation">.</span>py startapp demo

python manage<span class="token punctuation">.</span>py makemigrations

python manage<span class="token punctuation">.</span>py migrate
</code></pre> 
<ol start="2"><li>在settings.py中配置到好数据库信息</li></ol> 
<pre><code class="prism language-python">DATABASES <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"default"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"ENGINE"</span><span class="token punctuation">:</span> <span class="token string">"django.db.backends.postgresql"</span><span class="token punctuation">,</span>
        <span class="token string">"NAME"</span><span class="token punctuation">:</span> <span class="token string">"apschedule_demo"</span><span class="token punctuation">,</span>
        <span class="token string">"HOST"</span><span class="token punctuation">:</span> <span class="token string">"xxxx"</span><span class="token punctuation">,</span>
        <span class="token string">"PORT"</span><span class="token punctuation">:</span> <span class="token number">5432</span><span class="token punctuation">,</span>
        <span class="token string">"USER"</span><span class="token punctuation">:</span> <span class="token string">"xxx"</span><span class="token punctuation">,</span>
        <span class="token string">"PASSWORD"</span><span class="token punctuation">:</span> <span class="token string">"xxx"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<ol start="3"><li>根据<a href="https://github.com/jcass77/django-apscheduler">django-apschedule官方</a>提供的文档搭建demo</li></ol> 
<p>在settings.py中添加该APP</p> 
<pre><code class="prism language-python">INSTALLED_APPS <span class="token operator">=</span> <span class="token punctuation">(</span>
    <span class="token comment"># ...</span>
    <span class="token string">"django_apscheduler"</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
</code></pre> 
<p>创建目录<code>demo/management/commands</code>，并在其下面创建<code>runapscheduler.py</code>文件，代码内容如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> logging

<span class="token keyword">from</span> django<span class="token punctuation">.</span>conf <span class="token keyword">import</span> settings

<span class="token keyword">from</span> apscheduler<span class="token punctuation">.</span>schedulers<span class="token punctuation">.</span>blocking <span class="token keyword">import</span> BlockingScheduler
<span class="token keyword">from</span> apscheduler<span class="token punctuation">.</span>triggers<span class="token punctuation">.</span>cron <span class="token keyword">import</span> CronTrigger
<span class="token keyword">from</span> django<span class="token punctuation">.</span>core<span class="token punctuation">.</span>management<span class="token punctuation">.</span>base <span class="token keyword">import</span> BaseCommand
<span class="token keyword">from</span> django_apscheduler<span class="token punctuation">.</span>jobstores <span class="token keyword">import</span> DjangoJobStore

logger <span class="token operator">=</span> logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">my_job</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token comment"># Your job processing logic here...</span>
  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"job.."</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">Command</span><span class="token punctuation">(</span>BaseCommand<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token builtin">help</span> <span class="token operator">=</span> <span class="token string">"Runs APScheduler."</span>

  <span class="token keyword">def</span> <span class="token function">handle</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>options<span class="token punctuation">)</span><span class="token punctuation">:</span>
    scheduler <span class="token operator">=</span> BlockingScheduler<span class="token punctuation">(</span>timezone<span class="token operator">=</span>settings<span class="token punctuation">.</span>TIME_ZONE<span class="token punctuation">)</span>
    scheduler<span class="token punctuation">.</span>add_jobstore<span class="token punctuation">(</span>DjangoJobStore<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"default"</span><span class="token punctuation">)</span>

    scheduler<span class="token punctuation">.</span>add_job<span class="token punctuation">(</span>
      my_job<span class="token punctuation">,</span>
      trigger<span class="token operator">=</span>CronTrigger<span class="token punctuation">(</span>second<span class="token operator">=</span><span class="token string">"*/3"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># Every 3 seconds</span>
      <span class="token builtin">id</span><span class="token operator">=</span><span class="token string">"my_job"</span><span class="token punctuation">,</span>  <span class="token comment"># The `id` assigned to each job MUST be unique</span>
      max_instances<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
      replace_existing<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"Added job 'my_job'."</span><span class="token punctuation">)</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
      logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"Starting scheduler..."</span><span class="token punctuation">)</span>
      scheduler<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 因为上面是非阻塞开启定时任务，所以这里需要阻塞，不让主线程结束。</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span>
      logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"Stopping scheduler..."</span><span class="token punctuation">)</span>
      scheduler<span class="token punctuation">.</span>shutdown<span class="token punctuation">(</span><span class="token punctuation">)</span>
      logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"Scheduler shut down successfully!"</span><span class="token punctuation">)</span>

</code></pre> 
<p>可以通过<code>python manage.py runapscheduler</code>执行上面的命令运行定时任务，该脚本创建了一个每3秒执行一次的任务。</p> 
<ol start="4"><li>复现</li></ol> 
<p>我们将断点打在<code>jobstore.update_job(job)</code>上，然后使用debug模式进行调试，当程序运行到断点上时，将数据库关闭，然后程序继续运行，则会报错，并抛出异常，线程停止了运行。至此，我们复现了该问题。</p> 
<h3><a id="_225"></a>线程重启</h3> 
<p>我一开始想，我可以判断该线程是否异常，如果异常则将线程重启就好了</p> 
<pre><code class="prism language-python">    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> scheduler<span class="token punctuation">.</span>_thread<span class="token punctuation">.</span>is_alive<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            scheduler<span class="token punctuation">.</span>_thread<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
</code></pre> 
<p>但事与愿违，抛出了异常，异常信息如下：</p> 
<pre><code>RuntimeError: threads can only be started once
</code></pre> 
<p>通过查看官方文档可以知道，线程的start方法只能调用一次。</p> 
<h3><a id="listener_245"></a>listener</h3> 
<p>apschedule中提供了监听器机制，也就是在定时任务的成功、失败等状态都可以通过提前注册的listener方法来进行回调。但通过分析源码，其并不能捕获到定时任务线程的异常。</p> 
<p>下面是简化了代码的listeners的原理流程：</p> 
<ol><li>外部通过<code>add_listener</code>方法注册回调方法</li><li>在定时任务线程主流程<code>_process_jobs</code>中发生的各个事件添加到events中</li><li>遍历events事件，然后通过与注册的回调方法mask进行匹配，匹配上则调用回调方法</li></ol> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">BaseScheduler</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>_listeners <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">add_listener</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> mask<span class="token operator">=</span>EVENT_ALL<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>_listeners<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> mask<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">_process_jobs</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>

        events <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        events<span class="token punctuation">.</span>append<span class="token punctuation">(</span>event<span class="token punctuation">)</span>
 
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>


        <span class="token keyword">for</span> event <span class="token keyword">in</span> events<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_dispatch_event<span class="token punctuation">(</span>event<span class="token punctuation">)</span>


    <span class="token keyword">def</span> <span class="token function">_dispatch_event</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> cb<span class="token punctuation">,</span> mask <span class="token keyword">in</span> listeners<span class="token punctuation">:</span>
            <span class="token keyword">if</span> event<span class="token punctuation">.</span>code <span class="token operator">&amp;</span> mask<span class="token punctuation">:</span>
                <span class="token keyword">try</span><span class="token punctuation">:</span>
                    cb<span class="token punctuation">(</span>event<span class="token punctuation">)</span>
                <span class="token keyword">except</span> BaseException<span class="token punctuation">:</span>
                    self<span class="token punctuation">.</span>_logger<span class="token punctuation">.</span>exception<span class="token punctuation">(</span><span class="token string">'Error notifying listener'</span><span class="token punctuation">)</span>

</code></pre> 
<p>如果线程本身挂了，回调方法是不可执行的。</p> 
<h3><a id="_290"></a>捕获线程中函数的异常</h3> 
<p>如果<code>update_job</code>抛出异常导致线程停止，那我捕获它的异常，然后再continue，等待下次定时任务运行再重试不就好了，但是这就需要改动源码，能不能改源码就尽量不改。所以这边我采用了继承<code>BackgroundScheduler</code>类，然后再重写<code>_process_jobs</code>方法来解决。</p> 
<p>在重写的<code>_process_jobs</code>方法中，对父类的<code>_process_jobs()</code>进行异常的捕获，然后再不断的进行重试，这样即使update_job抛出异常了，也可以不断的进行尝试恢复，直至成功。</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">DemoBackgroundScheduler</span><span class="token punctuation">(</span>BackgroundScheduler<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">_process_jobs</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>_process_jobs<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">except</span> BaseException<span class="token punctuation">:</span>
                time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Command</span><span class="token punctuation">(</span>BaseCommand<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token builtin">help</span> <span class="token operator">=</span> <span class="token string">"Runs APScheduler."</span>

    <span class="token keyword">def</span> <span class="token function">handle</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>options<span class="token punctuation">)</span><span class="token punctuation">:</span>
        scheduler <span class="token operator">=</span> DemoBackgroundScheduler<span class="token punctuation">(</span>timezone<span class="token operator">=</span>settings<span class="token punctuation">.</span>TIME_ZONE<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<p>然后再次尝试复现该问题，可以发现在断开数据库后，它能够一直进行重试，线程没有停止，当数据库恢复运行后，job执行成功，不再抛出异常。</p> 
<h3><a id="_316"></a>相关链接</h3> 
<ul><li><a href="https://apscheduler.readthedocs.io/en/3.x/index.html" rel="nofollow">APScheduler官方文档</a></li></ul> 
<h3><a id="_320"></a>欢迎关注，互相学习，共同进步~</h3> 
<p>我的<a href="https://www.zhengwenfeng.com/" rel="nofollow">个人博客</a><br> 公众号：编程黑洞</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/13c1a4028eb1f72bc4d9f639cf4c0745/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">List 移除指定元素</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8c38161f196c19b6a295436772bc5eef/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">亿咖通·天穹Pro行泊一体智能驾驶计算平台正式量产</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>