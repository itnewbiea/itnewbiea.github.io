<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android查缺补漏（线程篇）-- AsyncTask的使用及原理详细分析 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android查缺补漏（线程篇）-- AsyncTask的使用及原理详细分析" />
<meta property="og:description" content="一、AsyncTask的使用 AsyncTask是一种轻量级的异步任务类，可以很方便的在线程池中执行异步任务，并且将进度和结果传递给主线程。其底层由Thread&#43;handler实现。
AsyncTask是一个抽象的泛型类，其类的声明如下：
public abstract class AsyncTask&lt;Params, Progress, Result&gt; 其中三个泛型参数代表的意义如下：
Parmas：参数类型Progress：异步任务的执行进度类型Result：异步任务执行完毕后返回结果的类型 在使用AsyncTask执行异步任务需要创建一个类，让这个类继承AsyncTask，并实现相关方法，具体形式如下，在下面代码中实现了几个重要的方法，每个方法代表的意义可以见注释：
/** * Created by liuwei on 18/2/28. */ public class MyAsyncTask extends AsyncTask&lt;String, Integer, String&gt; { /** * 在异步任务执行之前调用 * 执行在主线程中 */ @Override protected void onPreExecute() { super.onPreExecute(); } /** * 执行异步任务 * 执行在线程池中 * @param params * @return */ @Override protected String doInBackground(String... params) { return null; } /** * 当异步任务被取消时执行此方法，此时将不会再调用onPostExecute方法 */ @Override protected void onCancelled() { super." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/eb345e408a19d88fa10a02b0d2a3c113/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-25T08:45:00+08:00" />
<meta property="article:modified_time" content="2023-12-25T08:45:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android查缺补漏（线程篇）-- AsyncTask的使用及原理详细分析</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><img src="https://images2.imgbox.com/27/66/AQntuR4S_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="AsyncTask_6"></a>一、AsyncTask的使用</h5> 
<p>AsyncTask是一种轻量级的异步任务类，可以很方便的在线程池中执行异步任务，并且将进度和结果传递给主线程。其底层由Thread+handler实现。</p> 
<p>AsyncTask是一个抽象的泛型类，其类的声明如下：</p> 
<pre><code class="prism language-javascript"><span class="token keyword">public</span> abstract <span class="token keyword">class</span> <span class="token class-name">AsyncTask</span><span class="token operator">&lt;</span>Params<span class="token punctuation">,</span> Progress<span class="token punctuation">,</span> Result<span class="token operator">&gt;</span>
</code></pre> 
<p>其中三个泛型参数代表的意义如下：</p> 
<ul><li>Parmas：参数类型</li><li>Progress：异步任务的执行进度类型</li><li>Result：异步任务执行完毕后返回结果的类型</li></ul> 
<p>在使用AsyncTask执行异步任务需要创建一个类，让这个类继承AsyncTask，并实现相关方法，具体形式如下，在下面代码中实现了几个重要的方法，每个方法代表的意义可以见注释：</p> 
<pre><code class="prism language-javascript"><span class="token comment">/**
 * Created by liuwei on 18/2/28.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyAsyncTask</span> <span class="token keyword">extends</span> <span class="token class-name">AsyncTask</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> String<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * 在异步任务执行之前调用
     * 执行在主线程中
     */</span>
    @Override
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onPreExecute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onPreExecute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 执行异步任务
     * 执行在线程池中
     * @param params
     * @return
     */</span>
    @Override
    <span class="token keyword">protected</span> String <span class="token function">doInBackground</span><span class="token punctuation">(</span><span class="token parameter">String<span class="token operator">...</span> params</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 当异步任务被取消时执行此方法，此时将不会再调用onPostExecute方法
     */</span>
    @Override
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCancelled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCancelled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 当异步任务执行进度改变时执行此方法
     * 执行在主线程中
     * @param values
     */</span>
    @Override
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onProgressUpdate</span><span class="token punctuation">(</span><span class="token parameter">Integer<span class="token operator">...</span> values</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onProgressUpdate</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 当异步任务执行完成后执行此方法
     * 执行在主线程中
     * @param s
     */</span>
    @Override
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onPostExecute</span><span class="token punctuation">(</span><span class="token parameter">String s</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onPostExecute</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>要注意的时，需要在doInBackground方法中调用publishProgress()发送任务执行进度，onProgressUpdate才能被回调。</p> 
<p>执行AsyncTask是需要在主线程中调用:</p> 
<pre><code class="prism language-javascript"><span class="token keyword">new</span> <span class="token class-name">MyAsyncTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>在使用AsyncTask时有一些限制我们要注意：</p> 
<ul><li>AsyncTask类必须在主线程中加载。这是因为在AsyncTask中存在这个一个静态类型的Handler对象成员，在AsyncTask被加载时，该静态类型的Handler对象就会被初始化，所以这就要求了首次访问AsyncTask要发送在主线程中。这一点在Android 4.1及以上版本中已经被系统自动完成。</li><li>AsyncTask的对象必须在主线程中创建。</li><li>AsyncTask的execute必须在主线程中调用。</li><li>不能直接调用onPreExecute()、doInBackground()、onProgressUpdate()、onPostExecute()方法。</li><li>一个AsyncTask对象只能调用一次execute，即每个对象只能被执行一次，否则会出异常。</li></ul> 
<h6><a id="1AsyncTask_102"></a>1、使用AsyncTask执行异步任务的小例子</h6> 
<p>接下类使用AsyncTask，借助循环模拟一个耗时任务的小例子，还是用上面的MyAsyncTask类，并在其相关方法上面添加一些辅助代码，详细代码如下：</p> 
<pre><code class="prism language-javascript"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyAsyncTask</span> <span class="token keyword">extends</span> <span class="token class-name">AsyncTask</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> String<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> final <span class="token keyword">static</span> String <span class="token constant">TAG</span> <span class="token operator">=</span> MyAsyncTask<span class="token punctuation">.</span>class<span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> int taskSize <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 在异步任务执行之前调用
     * 执行在主线程中
     */</span>
    @Override
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onPreExecute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onPreExecute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Log<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"onPreExecute: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 执行异步任务
     * 执行在线程池中
     * @param params
     * @return
     */</span>
    @Override
    <span class="token keyword">protected</span> String <span class="token function">doInBackground</span><span class="token punctuation">(</span><span class="token parameter">String<span class="token operator">...</span> params</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Log<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"doInBackground: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        int i<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> taskSize<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            SystemClock<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            int progress <span class="token operator">=</span> <span class="token punctuation">(</span>int<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">/</span> <span class="token punctuation">(</span>float<span class="token punctuation">)</span>taskSize<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">publishProgress</span><span class="token punctuation">(</span>progress<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isCancelled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token string">"执行结果："</span> <span class="token operator">+</span> <span class="token punctuation">(</span>i <span class="token operator">/</span> <span class="token punctuation">(</span>float<span class="token punctuation">)</span>taskSize<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span> <span class="token operator">+</span> <span class="token string">"%"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 当异步任务被取消时执行此方法，此时将不会再调用onPostExecute方法
     */</span>
    @Override
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCancelled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCancelled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Log<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"onCancelled: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    @Override
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCancelled</span><span class="token punctuation">(</span><span class="token parameter">String s</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCancelled</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Log<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"onCancelled: result="</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 当异步任务执行进度改变时执行此方法
     * 执行在主线程中
     * @param values
     */</span>
    @Override
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onProgressUpdate</span><span class="token punctuation">(</span><span class="token parameter">Integer<span class="token operator">...</span> values</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onProgressUpdate</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Log<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"onProgressUpdate: 执行进度："</span> <span class="token operator">+</span> values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">"%"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 当异步任务执行完成后执行此方法
     * 执行在主线程中
     * @param s
     */</span>
    @Override
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onPostExecute</span><span class="token punctuation">(</span><span class="token parameter">String s</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onPostExecute</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Log<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"onPostExecute: result="</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在Activity中调用new MyAsyncTask().execute();执行Log如下：</p> 
<pre><code class="prism language-javascript"><span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> onPreExecute<span class="token operator">:</span> 
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> doInBackground<span class="token operator">:</span> 
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">0</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">10</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">20</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">30</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">40</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">50</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">60</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">70</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">80</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">90</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> onPostExecute<span class="token operator">:</span> result<span class="token operator">=</span>执行结果：<span class="token number">100.0</span><span class="token operator">%</span>
</code></pre> 
<h5><a id="2AsyncTaskexecuteOnExecutor_206"></a>2、多个AsyncTask对象在执行异步任务时，默认是串行执行的，也可以通过executeOnExecutor让其并发执行。</h5> 
<ul><li>在Android 1.6之前，AsyncTask处理任务时是采用串行方式，Android 1.6时，AsyncTask处理任务时是在线程池中并行处理任务。但在Android 3.0开始，AsyncTask又开始采用串行方式处理任务。</li></ul> 
<p>我们稍加改造一下上面的示例，在构造方法中传入一个taskId，然后在关键log中输出这个taskId，以便于区分：</p> 
<pre><code class="prism language-javascript"><span class="token keyword">private</span> int taskId<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token function">MyAsyncTask</span><span class="token punctuation">(</span><span class="token parameter">int taskId</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>taskId <span class="token operator">=</span> taskId<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 在异步任务执行之前调用
 * 执行在主线程中
 */</span>
@Override
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onPreExecute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onPreExecute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Log<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"taskId= "</span> <span class="token operator">+</span> taskId <span class="token operator">+</span> <span class="token string">": onPreExecute: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 其他方法类比onPreExecute方法中的log增加taskId，就不贴出了</span>
</code></pre> 
<p>在Activity中初始化两个AsyncTask对象，并调用excute执行任务：</p> 
<pre><code class="prism language-javascript"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AsyncTaskActivity</span> <span class="token keyword">extends</span> <span class="token class-name">AppCompatActivity</span> <span class="token punctuation">{<!-- --></span>

    @Override
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token parameter">Bundle savedInstanceState</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setContentView</span><span class="token punctuation">(</span><span class="token constant">R</span><span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_async_task<span class="token punctuation">)</span><span class="token punctuation">;</span>
        MyAsyncTask task1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyAsyncTask</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        MyAsyncTask task2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyAsyncTask</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        task1<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        task2<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>log如下：</p> 
<pre><code class="prism language-javascript"><span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span> onPreExecute<span class="token operator">:</span> 
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">2</span><span class="token operator">:</span> onPreExecute<span class="token operator">:</span> 
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span> doInBackground<span class="token operator">:</span> 
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">0</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">10</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">20</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">30</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">40</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">50</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">60</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">70</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">80</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">90</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span> onPostExecute<span class="token operator">:</span> result<span class="token operator">=</span>taskId<span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span> 执行结果：<span class="token number">100.0</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">2</span><span class="token operator">:</span> doInBackground<span class="token operator">:</span> 
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">2</span><span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">0</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">2</span><span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">10</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">2</span><span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">20</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">2</span><span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">30</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">2</span><span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">40</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">2</span><span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">50</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">2</span><span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">60</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">2</span><span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">70</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">2</span><span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">80</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">2</span><span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">90</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">2</span><span class="token operator">:</span> onPostExecute<span class="token operator">:</span> result<span class="token operator">=</span>taskId<span class="token operator">=</span> <span class="token number">2</span><span class="token operator">:</span> 执行结果：<span class="token number">100.0</span><span class="token operator">%</span>
</code></pre> 
<p>可以看到两个任务是串行执行的。</p> 
<ul><li>使用executeOnExecutor方法</li></ul> 
<p>AsyncTask&lt;Params, Progress, Result&gt; executeOnExecutor(Executor exec, Params… params)</p> 
<p>executorOnExecutor方法有两个参数，第一个是Executor，第二个是任务参数。</p> 
<p>第一个参数有两种类型：</p> 
<ul><li>AsyncTask.SERIAL_EXECUTOR : 表示串行执行</li><li>AsyncTask.THREAD_POOL_EXECUTOR ：表示并发执行</li></ul> 
<p>在执行task2时调用executeOnExecutor，观察执行结果：</p> 
<pre><code class="prism language-javascript"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AsyncTaskActivity</span> <span class="token keyword">extends</span> <span class="token class-name">AppCompatActivity</span> <span class="token punctuation">{<!-- --></span>

    @Override
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token parameter">Bundle savedInstanceState</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setContentView</span><span class="token punctuation">(</span><span class="token constant">R</span><span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_async_task<span class="token punctuation">)</span><span class="token punctuation">;</span>
        MyAsyncTask task1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyAsyncTask</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        MyAsyncTask task2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyAsyncTask</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        task1<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        task2<span class="token punctuation">.</span><span class="token function">executeOnExecutor</span><span class="token punctuation">(</span>AsyncTask<span class="token punctuation">.</span><span class="token constant">THREAD_POOL_EXECUTOR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>log如下：</p> 
<pre><code class="prism language-javascript"><span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span> onPreExecute<span class="token operator">:</span> 
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">2</span><span class="token operator">:</span> onPreExecute<span class="token operator">:</span> 
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span> doInBackground<span class="token operator">:</span> 
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">2</span><span class="token operator">:</span> doInBackground<span class="token operator">:</span> 
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">2</span><span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">0</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">0</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">10</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">2</span><span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">10</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">2</span><span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">20</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">20</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">2</span><span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">30</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">30</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">2</span><span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">40</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">40</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">2</span><span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">50</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">50</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">2</span><span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">60</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">60</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">2</span><span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">70</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">70</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">2</span><span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">80</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">80</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">2</span><span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">90</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">2</span><span class="token operator">:</span> onPostExecute<span class="token operator">:</span> result<span class="token operator">=</span>taskId<span class="token operator">=</span> <span class="token number">2</span><span class="token operator">:</span> 执行结果：<span class="token number">100.0</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span> onProgressUpdate<span class="token operator">:</span> 执行进度：<span class="token number">90</span><span class="token operator">%</span>
<span class="token operator">...</span><span class="token operator">/</span>cn<span class="token punctuation">.</span>codingblock<span class="token punctuation">.</span>thread <span class="token constant">I</span><span class="token operator">/</span>MyAsyncTask<span class="token operator">:</span> taskId<span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span> onPostExecute<span class="token operator">:</span> result<span class="token operator">=</span>taskId<span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span> 执行结果：<span class="token number">100.0</span><span class="token operator">%</span>
</code></pre> 
<p>从log可以看到，两个任务在并发执行。</p> 
<h5><a id="AsyncTask_353"></a>二、AsyncTask的原理</h5> 
<ul><li>1、首先在AsyncTask被初始化时构建一个WorkerRunnable（mWorker）和一个FutureTask（mFuture），后面在执行的过程中会将封装好的mFuture放入一个线程池中执行。</li><li>2、在外界调用AsyncTask.execute方法之后，开始启动AsyncTask任务，根据代码查看调用过程如下：</li></ul> 
<pre><code class="prism language-javascript">@MainThread
<span class="token keyword">public</span> final AsyncTask<span class="token operator">&lt;</span>Params<span class="token punctuation">,</span> Progress<span class="token punctuation">,</span> Result<span class="token operator">&gt;</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token parameter">Params<span class="token operator">...</span> params</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">executeOnExecutor</span><span class="token punctuation">(</span>sDefaultExecutor<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>3、在execute方法中又调用了executeOnExecutor方法：</li></ul> 
<pre><code class="prism language-javascript">@MainThread
<span class="token keyword">public</span> final AsyncTask<span class="token operator">&lt;</span>Params<span class="token punctuation">,</span> Progress<span class="token punctuation">,</span> Result<span class="token operator">&gt;</span> <span class="token function">executeOnExecutor</span><span class="token punctuation">(</span><span class="token parameter">Executor exec<span class="token punctuation">,</span>
        Params<span class="token operator">...</span> params</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mStatus <span class="token operator">!=</span> Status<span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>mStatus<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> <span class="token constant">RUNNING</span><span class="token operator">:</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Cannot execute task:"</span>
                        <span class="token operator">+</span> <span class="token string">" the task is already running."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">FINISHED</span><span class="token operator">:</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Cannot execute task:"</span>
                        <span class="token operator">+</span> <span class="token string">" the task has already been executed "</span>
                        <span class="token operator">+</span> <span class="token string">"(a task can be executed only once)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    mStatus <span class="token operator">=</span> Status<span class="token punctuation">.</span><span class="token constant">RUNNING</span><span class="token punctuation">;</span>

    <span class="token function">onPreExecute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    mWorker<span class="token punctuation">.</span>mParams <span class="token operator">=</span> params<span class="token punctuation">;</span>
    exec<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>mFuture<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>我们需要了解的是，一个AsyncTask任务有三种状态：PENDING（未开始）、RUNNING（运行中）、FINISHED（已完成）。 从上面源码我们可以看到，一个AsyncTask实例任务只能运行一次，只有是在PENDING状态下，任务才能正常运行，否则就会抛出异常。</p> 
<p>接着在执行任务前先调用了onPreExecute方法，并将参数赋值给mWorker的参数数组，然后使用exec执行在AsyncTask初始化阶段封装好的mFuture。</p> 
<ul><li>4、从第二步可以知道exec就是sDefaultExecutor，它是一个Executor对象，相关的源码如下：</li></ul> 
<pre><code class="prism language-javascript"><span class="token keyword">private</span> <span class="token keyword">static</span> volatile Executor sDefaultExecutor <span class="token operator">=</span> <span class="token constant">SERIAL_EXECUTOR</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * An {@link Executor} that executes tasks one at a time in serial
 * order.  This serialization is global to a particular process.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> final Executor <span class="token constant">SERIAL_EXECUTOR</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SerialExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">SerialExecutor</span> <span class="token keyword">implements</span> <span class="token class-name">Executor</span> <span class="token punctuation">{<!-- --></span>
    final ArrayDeque<span class="token operator">&lt;</span>Runnable<span class="token operator">&gt;</span> mTasks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayDeque</span><span class="token operator">&lt;</span>Runnable<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Runnable mActive<span class="token punctuation">;</span>

    <span class="token keyword">public</span> synchronized <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token parameter">final Runnable r</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mTasks<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    r<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">scheduleNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mActive <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">scheduleNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> synchronized <span class="token keyword">void</span> <span class="token function">scheduleNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mActive <span class="token operator">=</span> mTasks<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token constant">THREAD_POOL_EXECUTOR</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>mActive<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>从源码可以进一步看出，sDefaultExecutor是SerialExecutor对象，是一个串行的线程池，同一个进程中的所有的AsyncTask任务都在这个线程池中排队执行。</p> 
<p>SerialExecutor的execute方法首先会将FutureTask任务加入到mTasks队列中，此时如果没有正在活动的任务就会调用scheduleNext执行下一个AsyncTask任务。</p> 
<ul><li>5、接下来我们再回过头来看AsyncTask的构造器中在创建mWorker和mFuture时都做了些什么：</li></ul> 
<pre><code class="prism language-javascript"><span class="token keyword">public</span> <span class="token function">AsyncTask</span><span class="token punctuation">(</span><span class="token parameter">@Nullable Looper callbackLooper</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    mHandler <span class="token operator">=</span> callbackLooper <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> callbackLooper <span class="token operator">==</span> Looper<span class="token punctuation">.</span><span class="token function">getMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">?</span> <span class="token function">getMainHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span>callbackLooper<span class="token punctuation">)</span><span class="token punctuation">;</span>

    mWorker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WorkerRunnable</span><span class="token operator">&lt;</span>Params<span class="token punctuation">,</span> Result<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">public</span> Result <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> throws Exception <span class="token punctuation">{<!-- --></span>
            mTaskInvoked<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Result result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                Process<span class="token punctuation">.</span><span class="token function">setThreadPriority</span><span class="token punctuation">(</span>Process<span class="token punctuation">.</span><span class="token constant">THREAD_PRIORITY_BACKGROUND</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//noinspection unchecked</span>
                result <span class="token operator">=</span> <span class="token function">doInBackground</span><span class="token punctuation">(</span>mParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
                Binder<span class="token punctuation">.</span><span class="token function">flushPendingCommands</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>Throwable tr<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                mCancelled<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> tr<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">postResult</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    mFuture <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FutureTask</span><span class="token operator">&lt;</span>Result<span class="token operator">&gt;</span><span class="token punctuation">(</span>mWorker<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        @Override
        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>   
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">postResultIfNotInvoked</span><span class="token punctuation">(</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>InterruptedException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                android<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Log<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token constant">LOG_TAG</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>ExecutionException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"An error occurred while executing doInBackground()"</span><span class="token punctuation">,</span>
                        e<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>CancellationException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">postResultIfNotInvoked</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>6、先来分析一下上面源码中的WorkerRunnable的call方法：</li></ul> 
<p>WorkerRunnable的call方法中的代码很好理解，首先调用了mTaskInvoked.set(true)，将任务的设为已调用状态。接着调用了doInBackground方法并获取了返回值，然后将返回值传递给postResult()方法，再看postResult方法的源码如下：</p> 
<pre><code class="prism language-javascript"><span class="token keyword">private</span> Result <span class="token function">postResult</span><span class="token punctuation">(</span><span class="token parameter">Result result</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    @<span class="token function">SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
    Message message <span class="token operator">=</span> <span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span><span class="token constant">MESSAGE_POST_RESULT</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">AsyncTaskResult</span><span class="token operator">&lt;</span>Result<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 在这里将doInBackground的返回结果result封装到AsyncTaskReuslt对象里面通过handler发送给主线程</span>
    message<span class="token punctuation">.</span><span class="token function">sendToTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在此方法中通过handler发送了一条MESSAGE_POST_RESULT的消息。此handler的相关代码如下（为方便查看，适当调整了代码顺序）：</p> 
<pre><code class="prism language-javascript"><span class="token keyword">private</span> final Handler mHandler<span class="token punctuation">;</span>

<span class="token keyword">private</span> Handler <span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> mHandler<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * Creates a new asynchronous task. This constructor must be invoked on the UI thread.
 */</span>
<span class="token keyword">public</span> <span class="token function">AsyncTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Looper<span class="token punctuation">)</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 在这里传入了null</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * Creates a new asynchronous task. This constructor must be invoked on the UI thread.
 *
 * @hide
 */</span>
<span class="token keyword">public</span> <span class="token function">AsyncTask</span><span class="token punctuation">(</span><span class="token parameter">@Nullable Handler handler</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">(</span>handler <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> handler<span class="token punctuation">.</span><span class="token function">getLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 根据上一步调用可知，handler为null</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * Creates a new asynchronous task. This constructor must be invoked on the UI thread.
 *
 * @hide
 */</span>
<span class="token keyword">public</span> <span class="token function">AsyncTask</span><span class="token punctuation">(</span><span class="token parameter">@Nullable Looper callbackLooper</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    mHandler <span class="token operator">=</span> callbackLooper <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> callbackLooper <span class="token operator">==</span> Looper<span class="token punctuation">.</span><span class="token function">getMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">?</span> <span class="token function">getMainHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                              <span class="token comment">// 根据上一步调用可知，callbackLooper为null，在此会调用getMainHandler()</span>
        <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span>callbackLooper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">...</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> Handler <span class="token function">getMainHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">synchronized</span> <span class="token punctuation">(</span><span class="token parameter">AsyncTask<span class="token punctuation">.</span>class</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sHandler <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            sHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InternalHandler</span><span class="token punctuation">(</span>Looper<span class="token punctuation">.</span><span class="token function">getMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> sHandler<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> InternalHandler sHandler<span class="token punctuation">;</span>
</code></pre> 
<p>在上面的源码中可知，最终getHandler()方法最终是为sHandler，而sHandler是一个静态的Handler对象，sHandler的作用是将执行环境切换到主线程中，所以这就要求sHandler要在主线程中被初始化，而由于静态成员会在类加载时被初始化，这就又要求了AsyncTask类必须在主线程中加载，否则该进程中的AsyncTask任务都无法正常工作。InternalHandler相关的源码如下：</p> 
<pre><code class="prism language-javascript"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">InternalHandler</span> <span class="token keyword">extends</span> <span class="token class-name">Handler</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token function">InternalHandler</span><span class="token punctuation">(</span><span class="token parameter">Looper looper</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>looper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    @<span class="token function">SuppressWarnings</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"unchecked"</span><span class="token punctuation">,</span> <span class="token string">"RawUseOfParameterizedType"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    @Override
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token parameter">Message msg</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        AsyncTaskResult<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> result <span class="token operator">=</span> <span class="token punctuation">(</span>AsyncTaskResult<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> msg<span class="token punctuation">.</span>obj<span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        
            <span class="token keyword">case</span> <span class="token constant">MESSAGE_POST_RESULT</span><span class="token operator">:</span>               <span class="token comment">// (看这里)</span>
                <span class="token comment">// There is only one result</span>
                result<span class="token punctuation">.</span>mTask<span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>mData<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用AsyncTask的finish方法。</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token operator">...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">finish</span><span class="token punctuation">(</span><span class="token parameter">Result result</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isCancelled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">onCancelled</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 如果任务被取消了就去调用onCancelled方法。</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">onPostExecute</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 任务完成后就将执行结果传递给onPostExecute方法</span>
    <span class="token punctuation">}</span>
    mStatus <span class="token operator">=</span> Status<span class="token punctuation">.</span><span class="token constant">FINISHED</span><span class="token punctuation">;</span>   <span class="token comment">// 最后将状态置为FINISHED</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>7、接着再来看一下第五步中的FutureTask的源码</li></ul> 
<pre><code class="prism language-javascript">mFuture <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FutureTask</span><span class="token operator">&lt;</span>Result<span class="token operator">&gt;</span><span class="token punctuation">(</span>mWorker<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    @Override
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>     <span class="token comment">// 1、在执行完mWorker的call方法之后会执行done方法。2、或者在FutureTask任务被取消后也会执行done方法</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">postResultIfNotInvoked</span><span class="token punctuation">(</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>InterruptedException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            android<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Log<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token constant">LOG_TAG</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>ExecutionException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"An error occurred while executing doInBackground()"</span><span class="token punctuation">,</span>
                    e<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>CancellationException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">postResultIfNotInvoked</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 在Future任务被取消时，在此段代码中就会抛出CancellationException异常，即会执行此方法。</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>我们知道Future被执行后，会调用传入的mWorker的call方法，在执行完mWorker的call方法之后或者FutureTask被取消时会调用done方法，我们看到源码中在done方法中调用postResultIfNotInvoked():</p> 
<pre><code class="prism language-javascript"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">postResultIfNotInvoked</span><span class="token punctuation">(</span><span class="token parameter">Result result</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    final boolean wasTaskInvoked <span class="token operator">=</span> mTaskInvoked<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>wasTaskInvoked<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">postResult</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在这个方法中可以看到，只有当wasTaskInvoked为false是才会发送结果，也就是说，这一步是在WorkerRunnable任务未被执行并取消的情况下才发送结果给主线程，在前几步中我们就已经知道了postResult()方法中的调用过程，最终会调用到finish方法。</p> 
<pre><code class="prism language-javascript"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">finish</span><span class="token punctuation">(</span><span class="token parameter">Result result</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isCancelled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">onCancelled</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 如果任务被取消了就去调用onCancelled方法。</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">onPostExecute</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 任务完成后就将执行结果传递给onPostExecute方法</span>
    <span class="token punctuation">}</span>
    mStatus <span class="token operator">=</span> Status<span class="token punctuation">.</span><span class="token constant">FINISHED</span><span class="token punctuation">;</span>   <span class="token comment">// 最后将状态置为FINISHED</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在任务被取消的情况下回调了onCancelled方法，至此AsyncTask异步任务执行流程基本分析完了。</p> 
<h5><a id="_646"></a>三、小结</h5> 
<p>最后简单总结一下AsyncTask的原理：</p> 
<ul><li>在AsyncTask类中有两个线程池（SerialExecutor、THREAD_POOL_EXECUTOR）和一个Handler（InternalHandler），其中SerialExecutor线程池用于对任务排队，THREAD_POOL_EXECUTOR用于真正的执行任务，InternalHandler的作用是将执行环境切换到主线程中，而AsyncTask类中的InternalHandler变量是一个静态类型的变量，这也就决定了AsyncTask类必须在主线程中加载。</li><li>在调用AsyncTask的executor方法开始执行异步任务时，会首先调用onPreExecute方法通知外界任务已经开始，接着使用线程池执行前面FutureTask任务。</li><li>前面所说的这个FutureTask任务是在AsyncTask初始化时被封装好的，在该任务中调用了doInBackground方法用于异步执行我们添加的耗时任务，doInBackground方法执行完毕会通过InternalHandler将返回结果发送到onPostExecute中，该方法是运行在主线程中。</li></ul> 
<blockquote> 
 <p>更多Android进阶指南 可以<strong>扫码 解锁</strong> <strong>《Android十大板块文档》</strong></p> 
</blockquote> 
<img src="https://images2.imgbox.com/9c/d9/dRuRnLBE_o.png"> 
<p>1.Android车载应用开发系统学习指南（附项目实战）</p> 
<p>2.Android Framework学习指南，助力成为系统级开发高手</p> 
<p>3.2023最新Android中高级面试题汇总+解析，告别零offer</p> 
<p>4.企业级Android音视频开发学习路线+项目实战（附源码）</p> 
<p>5.Android Jetpack从入门到精通，构建高质量UI界面</p> 
<p>6.Flutter技术解析与实战，跨平台首要之选</p> 
<p>7.Kotlin从入门到实战，全方面提升架构基础</p> 
<p>8.高级Android插件化与组件化（含实战教程和源码）</p> 
<p>9.Android 性能优化实战+360°全方面性能调优</p> 
<p>10.Android零基础入门到精通，高手进阶之路</p> 
<p><strong>敲代码不易，关注一下吧。ღ( ´･ᴗ･` ) 🤔</strong></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6ced0ed901f041df76b7f2cfd5bdc7b0/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Java研学-JSP</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/339e731922af4425013eaf7f47fed483/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【3D Max】入门</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>