<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SpringBoot&#43;druid&#43;dynamic&#43;clickhouse&#43;mysql实现读写分离 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="SpringBoot&#43;druid&#43;dynamic&#43;clickhouse&#43;mysql实现读写分离" />
<meta property="og:description" content="clickhouse&#43;mysql实现读写分离 背景配置mysql安装clickhouse使用可视化工具连接clickhouse创建clickhouse的数据库并连接mysqlSpringBoot&#43;druid&#43;dynamic配置多数据源实现读写分离 背景 由于系统数据量过大,查询条件自定义过多,mysql在查询时响应太慢,所以使用clickhouse作为读数据库,实现读写分离
配置mysql 这里使用mysql8.0及以上,mysql需要配置开始binlog日志,并且修改远程访问的密码加密方式
修改mysql的配置文件 vi /etc/my.cnf
# 配置远程访问的密码加密方式 default_authentication_plugin=mysql_native_password # 设置服务ID server-id=1 # 开启binlog日志 用来clickhouse读取数据 log-bin=mysql-bin binlog_format=ROW gtid-mode=on enforce-gtid-consistency=1 # 设置为主从强一致性 log-slave-updates=1 # 记录日志 安装clickhouse 这里使用rpm安装,步骤为官方文档步骤
sudo yum install -y yum-utils sudo yum-config-manager --add-repo https://packages.clickhouse.com/rpm/clickhouse.repo sudo yum install -y clickhouse-server clickhouse-client sudo /etc/init.d/clickhouse-server start 安装完成后,如果我们要使用DBeaver远程连接的方式,需要在配置文件中增加如下内容
vi /etc/clickhouse-server/config.xml 在下图所示位置加入 &lt;listen_host&gt;::&lt;/listen_host&gt; 然后重启服务即可 使用可视化工具连接clickhouse 官方文档推荐了很多种工具,这里使用DBeaver
第一步 :
第二步 :
填写主机IP地址,端口,数据库可以不填,
用户名默认 : default
用户密码默认是没有的,需要密码可以配置如下 :
# 编辑clickhouse配置文件 vi /etc/clickhouse-server/users.xml 找到箭头所指这一块,可能会在注视中,要放开注释,填入密码,修改后要重启哦" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/a4d27b8e580c38bc303091bc86183679/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-09T09:51:53+08:00" />
<meta property="article:modified_time" content="2023-08-09T09:51:53+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">SpringBoot&#43;druid&#43;dynamic&#43;clickhouse&#43;mysql实现读写分离</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>clickhouse+mysql实现读写分离</h4> 
 <ul><li><a href="#_2" rel="nofollow">背景</a></li><li><ul><li><a href="#mysql_6" rel="nofollow">配置mysql</a></li><li><a href="#clickhouse_22" rel="nofollow">安装clickhouse</a></li><li><a href="#clickhouse_44" rel="nofollow">使用可视化工具连接clickhouse</a></li><li><a href="#clickhousemysql_72" rel="nofollow">创建clickhouse的数据库并连接mysql</a></li><li><a href="#SpringBootdruiddynamic_88" rel="nofollow">SpringBoot+druid+dynamic配置多数据源实现读写分离</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_2"></a>背景</h2> 
<p>由于系统数据量过大,查询条件自定义过多,mysql在查询时响应太慢,所以使用clickhouse作为读数据库,实现读写分离</p> 
<h3><a id="mysql_6"></a>配置mysql</h3> 
<p>这里使用mysql8.0及以上,mysql需要配置开始binlog日志,并且修改远程访问的密码加密方式<br> 修改mysql的配置文件 vi /etc/my.cnf</p> 
<pre><code class="prism language-java">	# 配置远程访问的密码加密方式
	default_authentication_plugin<span class="token operator">=</span>mysql_native_password
	# 设置服务<span class="token constant">ID</span>
	server<span class="token operator">-</span>id<span class="token operator">=</span><span class="token number">1</span>
	# 开启binlog日志 用来clickhouse读取数据
	log<span class="token operator">-</span>bin<span class="token operator">=</span>mysql<span class="token operator">-</span>bin
	binlog_format<span class="token operator">=</span><span class="token constant">ROW</span>
	gtid<span class="token operator">-</span>mode<span class="token operator">=</span>on
	enforce<span class="token operator">-</span>gtid<span class="token operator">-</span>consistency<span class="token operator">=</span><span class="token number">1</span> # 设置为主从强一致性
	log<span class="token operator">-</span>slave<span class="token operator">-</span>updates<span class="token operator">=</span><span class="token number">1</span> # 记录日志
</code></pre> 
<h3><a id="clickhouse_22"></a>安装clickhouse</h3> 
<p>这里使用rpm安装,步骤为官方文档步骤</p> 
<pre><code class="prism language-java">	sudo yum install <span class="token operator">-</span>y yum<span class="token operator">-</span>utils
	sudo yum<span class="token operator">-</span>config<span class="token operator">-</span>manager <span class="token operator">--</span>add<span class="token operator">-</span>repo https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>packages<span class="token punctuation">.</span>clickhouse<span class="token punctuation">.</span>com<span class="token operator">/</span>rpm<span class="token operator">/</span>clickhouse<span class="token punctuation">.</span>repo
	sudo yum install <span class="token operator">-</span>y clickhouse<span class="token operator">-</span>server clickhouse<span class="token operator">-</span>client
	
	sudo <span class="token operator">/</span>etc<span class="token operator">/</span>init<span class="token punctuation">.</span>d<span class="token operator">/</span>clickhouse<span class="token operator">-</span>server start
</code></pre> 
<p>安装完成后,如果我们要使用DBeaver远程连接的方式,需要在配置文件中增加如下内容</p> 
<pre><code class="prism language-java">vi <span class="token operator">/</span>etc<span class="token operator">/</span>clickhouse<span class="token operator">-</span>server<span class="token operator">/</span>config<span class="token punctuation">.</span>xml
在下图所示位置加入
 <span class="token generics"><span class="token punctuation">&lt;</span>listen_host<span class="token punctuation">&gt;</span></span><span class="token operator">::</span><span class="token operator">&lt;</span><span class="token operator">/</span>listen_host<span class="token operator">&gt;</span>
 然后重启服务即可
</code></pre> 
<p><img src="https://images2.imgbox.com/7d/55/HIKNVi1R_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="clickhouse_44"></a>使用可视化工具连接clickhouse</h3> 
<p>官方文档推荐了很多种工具,这里使用DBeaver<br> 第一步 :<br> <img src="https://images2.imgbox.com/7c/ff/78V8I92J_o.png" alt="在这里插入图片描述"><br> 第二步 :<br> <img src="https://images2.imgbox.com/5a/bf/qGsadIiE_o.png" alt="在这里插入图片描述"><br> 填写主机IP地址,端口,数据库可以不填,<br> 用户名默认 : default<br> 用户密码默认是没有的,需要密码可以配置如下 :</p> 
<pre><code class="prism language-java"># 编辑clickhouse配置文件
vi <span class="token operator">/</span>etc<span class="token operator">/</span>clickhouse<span class="token operator">-</span>server<span class="token operator">/</span>users<span class="token punctuation">.</span>xml
</code></pre> 
<p><img src="https://images2.imgbox.com/77/d4/FYJQbEhU_o.png" alt="在这里插入图片描述"><br> 找到箭头所指这一块,可能会在注视中,要放开注释,填入密码,修改后要重启哦</p> 
<p>修改clickhouse配置</p> 
<pre><code class="prism language-java">vi <span class="token operator">/</span>etc<span class="token operator">/</span>clickhouse<span class="token operator">-</span>server<span class="token operator">/</span>users<span class="token punctuation">.</span>xml
在下图红框位置添加如下配置
<span class="token generics"><span class="token punctuation">&lt;</span>allow_experimental_database_materialized_mysql<span class="token punctuation">&gt;</span></span><span class="token number">1</span><span class="token operator">&lt;</span><span class="token operator">/</span>allow_experimental_database_materialized_mysql<span class="token operator">&gt;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/59/be/76z685ZJ_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="clickhousemysql_72"></a>创建clickhouse的数据库并连接mysql</h3> 
<pre><code class="prism language-java">创建连接数据库
<span class="token constant">CREATE</span> <span class="token constant">DATABASE</span> <span class="token constant">IF</span> <span class="token constant">NOT</span> <span class="token constant">EXISTS</span> dataBaseName
<span class="token constant">ENGINE</span> <span class="token operator">=</span> <span class="token class-name">MaterializeMySQL</span><span class="token punctuation">(</span>'ip<span class="token operator">:</span>port<span class="token char">', '</span>mysqlDataBaseName<span class="token char">', '</span>root<span class="token char">', '</span>pwd'<span class="token punctuation">)</span>
</code></pre> 
<p>dataBaseName : 在clickhouse创建的数据库名称<br> ip : 目标myql服务的IP地址<br> port : 目标myql服务的端口号<br> mysqlDataBaseName : 需要连接mysql的哪个库的名称<br> root : 目标mysql的账号<br> pwd : 目标mysql的密码</p> 
<blockquote> 
 <p>注意1: 如果需要同步的mysql的库数据量过大的话,创建clickhouse库后,需要一定时间同步,请耐心等待或者刷新可视化工具(DBeaver)查看<br> 注意2: <em><strong>需要同步的mysql的表,必须带有主键,没有主键会出现同步好数据后,查看不了数据</strong></em></p> 
</blockquote> 
<h3><a id="SpringBootdruiddynamic_88"></a>SpringBoot+druid+dynamic配置多数据源实现读写分离</h3> 
<pre><code class="prism language-java">依赖包<span class="token operator">:</span>
druid<span class="token operator">:</span>
		<span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
            <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>com<span class="token punctuation">.</span>alibaba<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
            <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>druid<span class="token operator">-</span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
            <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">1.2</span><span class="token number">.2</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
dynamic <span class="token operator">:</span> 
		<span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
            <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>com<span class="token punctuation">.</span>baomidou<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
            <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>dynamic<span class="token operator">-</span>datasource<span class="token operator">-</span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
            <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">3.5</span><span class="token number">.0</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
clickhouse<span class="token operator">-</span>jdbc<span class="token operator">:</span>
		<span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
            <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>ru<span class="token punctuation">.</span>yandex<span class="token punctuation">.</span>clickhouse<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
            <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>clickhouse<span class="token operator">-</span>jdbc<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
            <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">0.3</span><span class="token number">.2</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
</code></pre> 
<pre><code class="prism language-java">配置文件修改
  datasource<span class="token operator">:</span>
    dynamic<span class="token operator">:</span>
      primary<span class="token operator">:</span> mysql #设置默认主数据库名
      datasource<span class="token operator">:</span>
        mysql<span class="token operator">:</span> #主数据库名
          driverClassName<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>cj<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span>Driver</span>
          url<span class="token operator">:</span> $<span class="token punctuation">{<!-- --></span><span class="token constant">MYSQL_URL</span><span class="token operator">:</span>jdbc<span class="token operator">:</span>mysql<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>ip<span class="token operator">:</span>port<span class="token operator">/</span>zwpan_mes<span class="token operator">?</span>useUnicode<span class="token operator">=</span><span class="token boolean">true</span><span class="token operator">&amp;</span>allowPublicKeyRetrieval<span class="token operator">=</span><span class="token boolean">true</span><span class="token operator">&amp;</span>characterEncoding<span class="token operator">=</span><span class="token constant">UTF</span><span class="token operator">-</span><span class="token number">8</span><span class="token operator">&amp;</span>serverTimezone<span class="token operator">=</span><span class="token class-name">Asia</span><span class="token operator">/</span><span class="token class-name">Shanghai</span><span class="token operator">&amp;</span>useSSL<span class="token operator">=</span><span class="token boolean">false</span><span class="token operator">&amp;</span>allowMultiQueries<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">}</span>
          username<span class="token operator">:</span> root
          password<span class="token operator">:</span> <span class="token number">123456</span>
        clickhouse<span class="token operator">:</span>
          driverClassName<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">ru<span class="token punctuation">.</span>yandex<span class="token punctuation">.</span>clickhouse<span class="token punctuation">.</span></span>ClickHouseDriver</span>
          url<span class="token operator">:</span> jdbc<span class="token operator">:</span>clickhouse<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>ip<span class="token operator">:</span>port<span class="token operator">/</span>mes
          username<span class="token operator">:</span> <span class="token keyword">default</span>
          password<span class="token operator">:</span> <span class="token number">123456</span>
      druid<span class="token operator">:</span>
        initialSize<span class="token operator">:</span> <span class="token number">5</span>  #初始建立连接数量
        minIdle<span class="token operator">:</span> <span class="token number">5</span>  #最小连接数量
        maxActive<span class="token operator">:</span> <span class="token number">20</span> #最大连接数量
        maxWait<span class="token operator">:</span> <span class="token number">10000</span>  #获取连接最大等待时间，毫秒
        testOnBorrow<span class="token operator">:</span> <span class="token boolean">true</span> #申请连接时检测连接是否有效
        testOnReturn<span class="token operator">:</span> <span class="token boolean">false</span> #归还连接时检测连接是否有效
        timeBetweenEvictionRunsMillis<span class="token operator">:</span> <span class="token number">60000</span> #配置间隔检测连接是否有效的时间（单位是毫秒）
        minEvictableIdleTimeMillis<span class="token operator">:</span> <span class="token number">300000</span>  #连接在连接池的最小生存时间（毫秒）
</code></pre> 
<p><img src="https://images2.imgbox.com/cc/8a/Vm0GmbGE_o.png" alt="在这里插入图片描述"><br> 在接口方法或者类上直接加@DS注解就可以指定数据源读取数据啦</p> 
<blockquote> 
 <p>注意: 可能是版本不兼容,druid版本必须1.2.2以上.dynamic版本必须3.5.0以上,否则会启动失败</p> 
</blockquote>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/49ed9ef2437a8bf3789094bcddcdc097/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【数据分析专栏之Python篇】五、pandas数据结构之Series</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c07aaf868e9482fec2daa994cd372f09/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">快速获得图像中像素值的小工具</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>