<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>STM32CubeMX&#43;STM32F407&#43;FreeRTos&#43;LAN8720 以太网通信实现数据收发功能 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="STM32CubeMX&#43;STM32F407&#43;FreeRTos&#43;LAN8720 以太网通信实现数据收发功能" />
<meta property="og:description" content="目录
前言
一、STM32CubeMX配置
二、修改代码
三、硬件测试
总结
前言 该工程应用的以太网芯片是LAN8720，代码是基于STM32CUbeMx6.2.1配置生成的，在CubeMx中配置了ETH和LWIP，还有串口1和FREERTOS,最后通过创建任务函数实现udp的以太网数据收发功能。在测试中，可以在电脑的DOS窗口ping通在LWIP设置的单片机开发板的ip地址，通过网络调试助手可以实现数据的收发功能。
一、STM32CubeMX配置 1、选择STM32F407VET6芯片创建工程，首先配置RCC和SYS，再配置时钟，配置界面如下
2、配置ETH，配置界面如下
3、配FREERTOS和LWIP，配置界面如下
4、分配中断优先级，配置界面如下(如果需配置串口，先配置一下串口)
5、到这里，CubeMX就算配置完成了，就可以生成代码了
二、修改代码 1、打开生成的工程文件，找到HAL_ETH_MspInit函数，在最下面添加芯片复位的三行代码（作用是在芯片初始化时，对芯片复位一下，该芯片复位引脚对应我单片机开发板上的PA3）
2、在main.c中添加修改函数，首先是包含的文件，然后是创建任务函数，
#include &#34;main.h&#34; #include &#34;cmsis_os.h&#34; #include &#34;lwip.h&#34; #include &#34;usart.h&#34; #include &#34;gpio.h&#34; /* Private includes ----------------------------------------------------------*/ /* USER CODE BEGIN Includes */ #include &#34;stdio.h&#34; #include &#34;udp_echoserver.h&#34; /* USER CODE END Includes */ /* USER CODE BEGIN 0 */ void controlTask(void * param) { MX_LWIP_Init(); vTaskDelete( NULL ); } void commandTask(void * param) { udp_echoserver_init(); while(1) { vTaskDelay(2); } } TaskHandle_t StartTaskHandle; void StartTask(void * arg) { taskENTER_CRITICAL();	xTaskCreate(controlTask, &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/29f86e2e4dbb15b89a76b8b362737d12/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-10T16:57:55+08:00" />
<meta property="article:modified_time" content="2023-04-10T16:57:55+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">STM32CubeMX&#43;STM32F407&#43;FreeRTos&#43;LAN8720 以太网通信实现数据收发功能</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="%E5%89%8D%E8%A8%80-toc" style="margin-left:0px;"><a href="#%E5%89%8D%E8%A8%80" rel="nofollow">前言</a></p> 
<p id="%E4%B8%80%E3%80%81STM32CubeMX%E9%85%8D%E7%BD%AE-toc" style="margin-left:0px;"><a href="#%E4%B8%80%E3%80%81STM32CubeMX%E9%85%8D%E7%BD%AE" rel="nofollow">一、STM32CubeMX配置</a></p> 
<p id="%E4%BA%8C%E3%80%81%E4%BF%AE%E6%94%B9%E4%BB%A3%E7%A0%81-toc" style="margin-left:0px;"><a href="#%E4%BA%8C%E3%80%81%E4%BF%AE%E6%94%B9%E4%BB%A3%E7%A0%81" rel="nofollow">二、修改代码</a></p> 
<p id="%E4%B8%89%E3%80%81%E7%A1%AC%E4%BB%B6%E6%B5%8B%E8%AF%95-toc" style="margin-left:0px;"><a href="#%E4%B8%89%E3%80%81%E7%A1%AC%E4%BB%B6%E6%B5%8B%E8%AF%95" rel="nofollow">三、硬件测试</a></p> 
<p id="%E6%80%BB%E7%BB%93%EF%BC%9A%E4%BB%A5%E4%B8%8A%E6%98%AF%E6%88%91%E5%AF%B9LAN8740%E4%BB%A5%E5%A4%AA%E7%BD%91%E8%8A%AF%E7%89%87%E7%9A%84%E5%BA%94%E7%94%A8%EF%BC%8C%E5%B8%8C%E6%9C%9B%E5%AF%B9%E5%A4%A7%E5%AE%B6%E6%9C%89%E5%B8%AE%E5%8A%A9-toc" style="margin-left:40px;"><a href="#%E6%80%BB%E7%BB%93%EF%BC%9A%E4%BB%A5%E4%B8%8A%E6%98%AF%E6%88%91%E5%AF%B9LAN8740%E4%BB%A5%E5%A4%AA%E7%BD%91%E8%8A%AF%E7%89%87%E7%9A%84%E5%BA%94%E7%94%A8%EF%BC%8C%E5%B8%8C%E6%9C%9B%E5%AF%B9%E5%A4%A7%E5%AE%B6%E6%9C%89%E5%B8%AE%E5%8A%A9" rel="nofollow">总结</a></p> 
<p></p> 
<h2 id="%E5%89%8D%E8%A8%80">前言</h2> 
<p>该工程应用的以太网芯片是LAN8720，代码是基于STM32CUbeMx6.2.1配置生成的，在CubeMx中配置了ETH和LWIP，还有串口1和FREERTOS,最后通过创建任务函数实现udp的以太网数据收发功能。在测试中，可以在电脑的DOS窗口ping通在LWIP设置的单片机开发板的ip地址，通过网络调试助手可以实现数据的收发功能。</p> 
<h2 id="%E4%B8%80%E3%80%81STM32CubeMX%E9%85%8D%E7%BD%AE">一、STM32CubeMX配置</h2> 
<p>1、选择STM32F407VET6芯片创建工程，首先配置RCC和SYS，再配置时钟，配置界面如下</p> 
<p><img alt="" class="left" height="945" src="https://images2.imgbox.com/b2/5a/QFpHNR0h_o.png" width="1200"></p> 
<p><img alt="" class="left" height="799" src="https://images2.imgbox.com/ff/89/KjYKrj6Q_o.png" width="1200"></p> 
<p> <img alt="" class="left" height="721" src="https://images2.imgbox.com/ef/03/vywrspRc_o.png" width="1200"></p> 
<p> 2、配置ETH，配置界面如下</p> 
<p><img alt="" class="left" height="840" src="https://images2.imgbox.com/0a/aa/tlRxHRbT_o.png" width="1105"></p> 
<p><img alt="" class="left" height="571" src="https://images2.imgbox.com/6d/77/XJigwIJc_o.png" width="997"><img alt="" class="left" height="593" src="https://images2.imgbox.com/52/66/lAFyQOcf_o.png" width="988"></p> 
<p>  3、配FREERTOS和LWIP，配置界面如下</p> 
<p><img alt="" class="left" height="868" src="https://images2.imgbox.com/ad/f7/GNUEVtvb_o.png" width="1129"></p> 
<p><img alt="" class="left" height="877" src="https://images2.imgbox.com/41/ff/gpczmAQA_o.png" width="1126"></p> 
<p>4、分配中断优先级，配置界面如下(如果需配置串口，先配置一下串口)</p> 
<p><img alt="" class="left" height="743" src="https://images2.imgbox.com/66/cb/v3l5hbk4_o.png" width="1150"></p> 
<p><img alt="" class="left" height="849" src="https://images2.imgbox.com/d0/1b/wYZiCVGh_o.png" width="1084"></p> 
<p>5、到这里，CubeMX就算配置完成了，就可以生成代码了</p> 
<p><img alt="" class="left" height="990" src="https://images2.imgbox.com/8e/d7/vBueXfek_o.png" width="1200"></p> 
<h2 id="%E4%BA%8C%E3%80%81%E4%BF%AE%E6%94%B9%E4%BB%A3%E7%A0%81">二、修改代码</h2> 
<p>1、打开生成的工程文件，找到HAL_ETH_MspInit函数，在最下面添加芯片复位的三行代码（作用是在芯片初始化时，对芯片复位一下，该芯片复位引脚对应我单片机开发板上的PA3）</p> 
<p><img alt="" class="left" height="863" src="https://images2.imgbox.com/9c/a5/yh9eyHVS_o.png" width="1200"></p> 
<p><img alt="" class="left" height="615" src="https://images2.imgbox.com/cc/ea/x1ICwvIy_o.png" width="1178"></p> 
<p>2、在main.c中添加修改函数，首先是包含的文件，然后是创建任务函数，</p> 
<pre><code class="language-cpp">#include "main.h"
#include "cmsis_os.h"
#include "lwip.h"
#include "usart.h"
#include "gpio.h"

/* Private includes ----------------------------------------------------------*/
/* USER CODE BEGIN Includes */

#include "stdio.h"
#include "udp_echoserver.h"
/* USER CODE END Includes */</code></pre> 
<pre><code class="language-cpp">/* USER CODE BEGIN 0 */
void controlTask(void * param)
{
	MX_LWIP_Init();
	vTaskDelete( NULL );

}
void commandTask(void * param)
{
	udp_echoserver_init();
	while(1)
	{
		vTaskDelay(2);
	}

}

TaskHandle_t StartTaskHandle;
void StartTask(void * arg)
{
  taskENTER_CRITICAL();	        
	
	xTaskCreate(controlTask, "controlTask", 200,NULL,4,NULL);
	xTaskCreate(commandTask, "commandTask", 200,NULL,4,NULL);
	vTaskDelete(StartTaskHandle);	
	taskEXIT_CRITICAL();	    
}
/* USER CODE END 0 */

/**
  * @brief  The application entry point.
  * @retval int
  */
int main(void)
{
  /* USER CODE BEGIN 1 */

  /* USER CODE END 1 */

  /* MCU Configuration--------------------------------------------------------*/

  /* Reset of all peripherals, Initializes the Flash interface and the Systick. */
  HAL_Init();

  /* USER CODE BEGIN Init */

  /* USER CODE END Init */

  /* Configure the system clock */
  SystemClock_Config();

  /* USER CODE BEGIN SysInit */

  /* USER CODE END SysInit */

  /* Initialize all configured peripherals */
  MX_GPIO_Init();
  MX_USART1_UART_Init();
  /* USER CODE BEGIN 2 */
	printf("³õÊ¼»¯Íê±Ï");
	xTaskCreate(StartTask,"commanderTask",200,NULL,2,&amp;StartTaskHandle);
	vTaskStartScheduler();
  /* USER CODE END 2 */

  /* Call init function for freertos objects (in freertos.c) */
  MX_FREERTOS_Init();
  /* Start scheduler */
  osKernelStart();

  /* We should never get here as control is now taken by the scheduler */
  /* Infinite loop */
  /* USER CODE BEGIN WHILE */
  while (1)
  {
    /* USER CODE END WHILE */

    /* USER CODE BEGIN 3 */
  }
  /* USER CODE END 3 */
}</code></pre> 
<p>2、此时在电脑上是能够PING通在CubeMx中配置的ip地址的，如果需要实现udp数据收发功能，还需要创建功能文件，代码如下</p> 
<p><img alt="" class="left" height="841" src="https://images2.imgbox.com/ed/3a/rA2sPwII_o.png" width="1200"></p> 
<pre><code class="language-cpp">void udp_echoserver_init(void)
{
   struct udp_pcb *upcb;
   err_t err;
   
   /* Create a new UDP control block  */
   upcb = udp_new();
   
   if (upcb)
   {
     /* Bind the upcb to the UDP_PORT port */
     /* Using IP_ADDR_ANY allow the upcb to be used by any local interface */
      err = udp_bind(upcb, IP_ADDR_ANY, UDP_SERVER_PORT);
      
      if(err == ERR_OK)
      {
        /* Set a receive callback for the upcb */
        udp_recv(upcb, udp_echoserver_receive_callback, NULL);
      }
      else
      {
        udp_remove(upcb);
       // printf("can not bind pcb");
      }
   }
   else
   {
    // printf("can not create pcb");
   } 
}</code></pre> 
<pre><code class="language-cpp">uint8_t receivebuf[30] = {0};
//uint8_t send_buf[2] = {0x01,0x02};
uint8_t send_buf[] = "ÒÑ¾­ÊÕµ½Êý¾Ý";
int receivelen = 0;
void udp_echoserver_receive_callback(void *arg, struct udp_pcb *upcb, struct pbuf *p,const struct ip4_addr *addr, u16_t port)
{
	struct pbuf *pq;   //´´½¨Ò»¸ö½á¹¹Ìå±äÁ¿
	receivelen = p-&gt;len;
	memcpy(receivebuf,p-&gt;payload,p-&gt;len);//p-&gt;payloadÖ¸½ÓÊÕµ½µÄÊµ¼ÊÊý¾Ý£pp-&gt;lenÊÇÖ¸½ÓÊÕµ½µÄÊý¾Ý³¤¶È£»£»½«p±äÁ¿½ÓÊÕµ½µÄÊý¾Ý¸´ÖÆµ½receivebufÀïÃæ
  pbuf_free(p);//ÊÍ·Åp
	
  udp_connect(upcb, addr, UDP_CLIENT_PORT);  //½¨Á¢udpÁ¬½Ó
  pq = pbuf_alloc(PBUF_TRANSPORT,14,PBUF_POOL);//allocate memory  14Ïàµ±ÓÚ·ÖÅä14¸ö×Ö½Ú
	pbuf_take(pq,(char*)receivebuf,14);//copy data to buf
	udp_send(upcb,pq);//send udp data
	memset(receivebuf,0x00,30);  //Çå³ý»º´æ
	udp_disconnect(upcb);
	pbuf_free(pq);    
	
//  /* Connect to the remote client */
//  udp_connect(upcb, addr, UDP_CLIENT_PORT);
//    
//  /* Tell the client that we have accepted it */
//  udp_send(upcb, p);

//  /* free the UDP connection, so we can accept new clients */
//  udp_disconnect(upcb);
//	
//  /* Free the p buffer */
//  pbuf_free(p);
}</code></pre> 
<h2 id="%E4%B8%89%E3%80%81%E7%A1%AC%E4%BB%B6%E6%B5%8B%E8%AF%95">三、硬件测试</h2> 
<p>1、用网线将开发板和电脑网口连接上，配置电脑的ip地址，然后可以在电脑的DOS串口ping通开发板的IP地址，测试界面如下</p> 
<p><img alt="" class="left" height="300" src="https://images2.imgbox.com/25/a3/j2FZuQrf_o.png" width="400"></p> 
<p><img alt="" class="left" height="274" src="https://images2.imgbox.com/24/4c/Hn7mrytP_o.png" width="530"></p> 
<p>2、用网线将开发板和电脑网口连接上，打开网络调试助手，测试数据收发功能</p> 
<p><img alt="" class="left" height="614" src="https://images2.imgbox.com/48/f8/NC48iBmA_o.png" width="627"></p> 
<p><img alt="" class="left" height="650" src="https://images2.imgbox.com/f9/f6/9eABGLaA_o.png" width="782"></p> 
<h3 id="%E6%80%BB%E7%BB%93%EF%BC%9A%E4%BB%A5%E4%B8%8A%E6%98%AF%E6%88%91%E5%AF%B9LAN8740%E4%BB%A5%E5%A4%AA%E7%BD%91%E8%8A%AF%E7%89%87%E7%9A%84%E5%BA%94%E7%94%A8%EF%BC%8C%E5%B8%8C%E6%9C%9B%E5%AF%B9%E5%A4%A7%E5%AE%B6%E6%9C%89%E5%B8%AE%E5%8A%A9">总结</h3> 
<p>以上是我对LAN8720以太网芯片的应用，希望对大家有帮助</p> 
<p>整个工程代码下载：<a href="https://download.csdn.net/download/weixin_64705314/87672487?spm=1001.2014.3001.5503" title="https://download.csdn.net/download/weixin_64705314/87672487?spm=1001.2014.3001.5503">https://download.csdn.net/download/weixin_64705314/87672487?spm=1001.2014.3001.5503</a></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b96f996f7ace84d23cbc45144dc03e0f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">数据中台建设（三）：数据中台架构介绍</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1e8ac23f19e4d5468f9ae76b75ca9edd/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">SpringBoot进行测试出现提示TestContextAnnotationUtils错误</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>