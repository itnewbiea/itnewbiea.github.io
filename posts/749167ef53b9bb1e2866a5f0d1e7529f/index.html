<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ElasticSearch 数据备份与恢复 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="ElasticSearch 数据备份与恢复" />
<meta property="og:description" content="以下为背景
Elasticsearch 7.6.2单点，8.3.3单点
Docker 部署
当前使用场景：部分index，数据量较大，需要在跨版本的ES之间进行迁移
一、前提说明 1. Elasticsearch备份2. 备份恢复方案 二、Elasticsearch 环境准备 1.查看Elasticsearch所有版本2.部署2个Elasticsearch单点服务 三、数据备份 1. 增加仓库配置项2. API指令在原始ES集群创建仓库3. API查看原始ES集群里创建的仓库4. API验证原始ES集群备份仓库是否创建成功5. API创建快照备份6. API删除备份 四、数据恢复 1. 必做步骤2. API 恢复备份3. API 确认数据 一、前提说明 1. Elasticsearch备份 通常Elasticsearch备份有几种情况：
大量/全量数据的迁移增量数据的双写或异步准实时/定时同步临时部分数据的导出导入 2. 备份恢复方案 那么与之对应的解决方案有哪些呢？
什么样的方法适合什么样的场景呢？
Elasticsearch 原生自带的备份Snapshot与恢复Restore的功能，能够同步部分index、数据量级可允许GB\TB\PB的场景，原生自带的相对稳定性有保障，离线操作Logstash的管道同步方案，elk这套中我们也有使用到logstash作为一个重要的中间解析环节，我们这边作为数据同步的场景，需要中间对源数据（可来自ES或其他渠道）字段进行转换、处理、新增、删除的场景，还有异步增量同步场景Elasticsearch-dump 它是一款一款开源的 ES 数据迁移工具，node.js 开发的，需要自行从github下载下来部署后使用，可指定index\mapping等，类似于mysqldump，最终是将数据导出为类似insert的语句后写入，适合数据量小的场景其他开源工具：Kettle（是关系型到关系型/非关系型的数据同步，ES仅写入），DataX（比较完备完整的关系型到关系型/非关系型的数据同步组件，ES仅写入），Flinkx（ES可读取和写入），这种通常涉及关系型到非关系型，或者流程复杂需要二次包装的场景再考虑 基于以上说明，本地实验主要采取原生自带的备份snapshot与恢复restore的功能进行数据的迁移测试
二、Elasticsearch 环境准备 1.查看Elasticsearch所有版本 curl https://registry.hub.docker.com/v1/repositories/elasticsearch/tags | tr -d &#39;[\[\]&#34; ]&#39; | tr &#39;}&#39; &#39;\n&#39; | awk -F: -v image=&#39;elasticsearch&#39; &#39;{if(NR!=NF &amp;&amp; $3 != &#34;&#34;){printf(&#34;%s:%s\n&#34;,image,$3)}}&#39; % Total % Received % Xferd Average Speed Time Time Time Current Dload Upload Total Spent Left Speed 100 8250 0 8250 0 0 8620 0 --:--:-- --:--:-- --:--:-- 8611 elasticsearch:1 elasticsearch:1-alpine elasticsearch:1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/749167ef53b9bb1e2866a5f0d1e7529f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-15T10:07:35+08:00" />
<meta property="article:modified_time" content="2022-08-15T10:07:35+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ElasticSearch 数据备份与恢复</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>以下为背景</p> 
<blockquote> 
 <p>Elasticsearch 7.6.2单点，8.3.3单点</p> 
 <p>Docker 部署</p> 
 <p>当前使用场景：部分index，数据量较大，需要在跨版本的ES之间进行迁移</p> 
</blockquote> 
<ul><li><a href="#%E4%B8%80%E5%89%8D%E6%8F%90%E8%AF%B4%E6%98%8E" rel="nofollow">一、前提说明</a> 
  <ul><li><a href="#1-elasticsearch%E5%A4%87%E4%BB%BD" rel="nofollow">1. Elasticsearch备份</a></li><li><a href="#2-%E5%A4%87%E4%BB%BD%E6%81%A2%E5%A4%8D%E6%96%B9%E6%A1%88" rel="nofollow">2. 备份恢复方案</a></li></ul> </li><li><a href="#%E4%BA%8Celasticsearch-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87" rel="nofollow">二、Elasticsearch 环境准备</a> 
  <ul><li><a href="#1%E6%9F%A5%E7%9C%8Belasticsearch%E6%89%80%E6%9C%89%E7%89%88%E6%9C%AC" rel="nofollow">1.查看Elasticsearch所有版本</a></li><li><a href="#2%E9%83%A8%E7%BD%B22%E4%B8%AAelasticsearch%E5%8D%95%E7%82%B9%E6%9C%8D%E5%8A%A1" rel="nofollow">2.部署2个Elasticsearch单点服务</a></li></ul> </li><li><a href="#%E4%B8%89%E6%95%B0%E6%8D%AE%E5%A4%87%E4%BB%BD" rel="nofollow">三、数据备份</a> 
  <ul><li><a href="#1-%E5%A2%9E%E5%8A%A0%E4%BB%93%E5%BA%93%E9%85%8D%E7%BD%AE%E9%A1%B9" rel="nofollow">1. 增加仓库配置项</a></li><li><a href="#2-api%E6%8C%87%E4%BB%A4%E5%9C%A8%E5%8E%9F%E5%A7%8Bes%E9%9B%86%E7%BE%A4%E5%88%9B%E5%BB%BA%E4%BB%93%E5%BA%93" rel="nofollow">2. API指令在原始ES集群创建仓库</a></li><li><a href="#3-api%E6%9F%A5%E7%9C%8B%E5%8E%9F%E5%A7%8Bes%E9%9B%86%E7%BE%A4%E9%87%8C%E5%88%9B%E5%BB%BA%E7%9A%84%E4%BB%93%E5%BA%93" rel="nofollow">3. API查看原始ES集群里创建的仓库</a></li><li><a href="#4-api%E9%AA%8C%E8%AF%81%E5%8E%9F%E5%A7%8Bes%E9%9B%86%E7%BE%A4%E5%A4%87%E4%BB%BD%E4%BB%93%E5%BA%93%E6%98%AF%E5%90%A6%E5%88%9B%E5%BB%BA%E6%88%90%E5%8A%9F" rel="nofollow">4. API验证原始ES集群备份仓库是否创建成功</a></li><li><a href="#5-api%E5%88%9B%E5%BB%BA%E5%BF%AB%E7%85%A7%E5%A4%87%E4%BB%BD" rel="nofollow">5. API创建快照备份</a></li><li><a href="#6-api%E5%88%A0%E9%99%A4%E5%A4%87%E4%BB%BD" rel="nofollow">6. API删除备份</a></li></ul> </li><li><a href="#%E5%9B%9B%E6%95%B0%E6%8D%AE%E6%81%A2%E5%A4%8D" rel="nofollow">四、数据恢复</a> 
  <ul><li><a href="#1-%E5%BF%85%E5%81%9A%E6%AD%A5%E9%AA%A4" rel="nofollow">1. 必做步骤</a></li><li><a href="#2-api-%E6%81%A2%E5%A4%8D%E5%A4%87%E4%BB%BD" rel="nofollow">2. API 恢复备份</a></li><li><a href="#3-api-%E7%A1%AE%E8%AE%A4%E6%95%B0%E6%8D%AE" rel="nofollow">3. API 确认数据</a></li></ul> </li></ul> 
<h3><a id="_27"></a>一、前提说明</h3> 
<h4><a id="1_Elasticsearch_29"></a>1. Elasticsearch备份</h4> 
<p>通常Elasticsearch备份有几种情况：</p> 
<ul><li>大量/全量数据的迁移</li><li>增量数据的双写或异步准实时/定时同步</li><li>临时部分数据的导出导入</li></ul> 
<h4><a id="2__37"></a>2. 备份恢复方案</h4> 
<p>那么与之对应的解决方案有哪些呢？</p> 
<p>什么样的方法适合什么样的场景呢？</p> 
<ul><li><strong>Elasticsearch</strong> 原生自带的备份Snapshot与恢复Restore的功能，能够同步部分index、数据量级可允许GB\TB\PB的场景，原生自带的相对稳定性有保障，离线操作</li><li><strong>Logstash</strong>的管道同步方案，elk这套中我们也有使用到logstash作为一个重要的中间解析环节，我们这边作为数据同步的场景，需要中间对源数据（可来自ES或其他渠道）字段进行转换、处理、新增、删除的场景，还有异步增量同步场景</li><li><strong>Elasticsearch-dump</strong> 它是一款一款开源的 ES 数据迁移工具，node.js 开发的，需要自行从github下载下来部署后使用，可指定index\mapping等，类似于mysqldump，最终是将数据导出为类似insert的语句后写入，适合数据量小的场景</li><li>其他开源工具：Kettle（是关系型到关系型/非关系型的数据同步，ES仅写入），DataX（比较完备完整的关系型到关系型/非关系型的数据同步组件，ES仅写入），Flinkx（ES可读取和写入），这种通常涉及关系型到非关系型，或者流程复杂需要二次包装的场景再考虑</li></ul> 
<p>基于以上说明，本地实验主要采取<strong>原生自带的备份snapshot与恢复restore的功能</strong>进行数据的迁移测试</p> 
<h3><a id="Elasticsearch__50"></a>二、Elasticsearch 环境准备</h3> 
<h4><a id="1Elasticsearch_52"></a>1.查看Elasticsearch所有版本</h4> 
<pre><code class="prism language-bash"><span class="token function">curl</span> https://registry.hub.docker.com/v1/repositories/elasticsearch/tags <span class="token operator">|</span> <span class="token function">tr</span> -d <span class="token string">'[\[\]" ]'</span> <span class="token operator">|</span> <span class="token function">tr</span> <span class="token string">'}'</span> <span class="token string">'\n'</span> <span class="token operator">|</span> <span class="token function">awk</span> -F: -v <span class="token assign-left variable">image</span><span class="token operator">=</span><span class="token string">'elasticsearch'</span> <span class="token string">'{if(NR!=NF &amp;&amp; $3 != ""){printf("%s:%s\n",image,$3)}}'</span>
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
<span class="token number">100</span>  <span class="token number">8250</span>    <span class="token number">0</span>  <span class="token number">8250</span>    <span class="token number">0</span>     <span class="token number">0</span>   <span class="token number">8620</span>      <span class="token number">0</span> --:--:-- --:--:-- --:--:--  <span class="token number">8611</span>
elasticsearch:1
elasticsearch:1-alpine
elasticsearch:1.3.7
elasticsearch:1.3.8
elasticsearch:1.3.9
elasticsearch:1.4
elasticsearch:1.4.2
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
elasticsearch:8.1.2
elasticsearch:8.1.3
elasticsearch:8.2.0
elasticsearch:8.2.1
elasticsearch:8.2.2
elasticsearch:8.2.3
elasticsearch:8.3.1
elasticsearch:8.3.2
</code></pre> 
<h4><a id="22Elasticsearch_77"></a>2.部署2个Elasticsearch单点服务</h4> 
<p>获取镜像</p> 
<pre><code class="prism language-bash"><span class="token function">docker</span> pull elasticsearch:7.6.2
<span class="token function">docker</span> pull elasticsearch:8.3.3

<span class="token number">8.3</span>.3: Pulling from library/elasticsearch
d7bfe07ed847: Pull complete 
46789798a785: Pull complete 
17d53e557d11: Pull complete 
1044b0d3c7dc: Pull complete 
6d3e6541b7e9: Pull complete 
e56c78671a82: Pull complete 
b3b71c18a4f1: Pull complete 
5208b7309c64: Pull complete 
067f1fbe449c: Pull complete 
Digest: sha256:966<span class="token punctuation">..</span><span class="token punctuation">..</span>.2e1
Status: Downloaded newer image <span class="token keyword">for</span> elasticsearch:8.3.3
</code></pre> 
<p>启动服务</p> 
<pre><code class="prism language-bash"><span class="token function">docker</span> run --name elasticsearch1 -p <span class="token number">9200</span>:9201 -p <span class="token number">9300</span>:9301 <span class="token punctuation">\</span>
<span class="token operator">&gt;</span> -e  <span class="token string">"discovery.type=single-node"</span> <span class="token punctuation">\</span>
<span class="token operator">&gt;</span> -e <span class="token assign-left variable">ES_JAVA_OPTS</span><span class="token operator">=</span><span class="token string">"-Xms64m -Xmx256m"</span> <span class="token punctuation">\</span>
<span class="token operator">&gt;</span> -v ~/docker/elasticsearch1/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml <span class="token punctuation">\</span>
<span class="token operator">&gt;</span> -v ~/docker/elasticsearch1/data:/usr/share/elasticsearch/data <span class="token punctuation">\</span>
<span class="token operator">&gt;</span> -v  ~/docker/elasticsearch1/plugins:/usr/share/elasticsearch/plugins <span class="token punctuation">\</span>
<span class="token operator">&gt;</span> -v  ~/docker/elasticsearch/backup:/usr/share/elasticsearch/backup <span class="token punctuation">\</span>
<span class="token operator">&gt;</span> -d elasticsearch:7.6.2


<span class="token function">docker</span> run --name elasticsearch2 -p <span class="token number">9200</span>:9201 -p <span class="token number">9300</span>:9301 <span class="token punctuation">\</span>
<span class="token operator">&gt;</span> -e  <span class="token string">"discovery.type=single-node"</span> <span class="token punctuation">\</span>
<span class="token operator">&gt;</span> -e <span class="token assign-left variable">ES_JAVA_OPTS</span><span class="token operator">=</span><span class="token string">"-Xms64m -Xmx256m"</span> <span class="token punctuation">\</span>
<span class="token operator">&gt;</span> -v ~/docker/elasticsearch2/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml <span class="token punctuation">\</span>
<span class="token operator">&gt;</span> -v ~/docker/elasticsearch2/data:/usr/share/elasticsearch/data <span class="token punctuation">\</span>
<span class="token operator">&gt;</span> -v  ~/docker/elasticsearch2/plugins:/usr/share/elasticsearch/plugins <span class="token punctuation">\</span>
<span class="token operator">&gt;</span> -v  ~/docker/elasticsearch/backup:/usr/share/elasticsearch/backup <span class="token punctuation">\</span>
<span class="token operator">&gt;</span> -d elasticsearch:8.3.3
</code></pre> 
<p>确认服务</p> 
<pre><code class="prism language-bash">a@~:~$ <span class="token function">docker</span> <span class="token function">ps</span> -a
CONTAINER ID        IMAGE                             COMMAND                  CREATED             STATUS                      PORTS                                             NAMES
<span class="token number">9</span><span class="token punctuation">..</span><span class="token punctuation">..</span>b1        elasticsearch:8.3.3              <span class="token string">"/usr/local/bin/dock…"</span>   <span class="token number">9</span> seconds ago       Up <span class="token number">7</span> seconds                <span class="token number">0.0</span>.0.0:9201-<span class="token operator">&gt;</span><span class="token number">9200</span>/tcp, <span class="token number">0.0</span>.0.0:9301-<span class="token operator">&gt;</span><span class="token number">9300</span>/tcp    elasticsearch2
<span class="token number">75</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">83</span>        elasticsearch:7.6.2             <span class="token string">"/usr/local/bin/dock…"</span>   <span class="token number">25</span> minutes ago      Up <span class="token number">25</span> minutes               <span class="token number">0.0</span>.0.0:9200-<span class="token operator">&gt;</span><span class="token number">9200</span>/tcp, <span class="token number">0.0</span>.0.0:9300-<span class="token operator">&gt;</span><span class="token number">9300</span>/tcp    elasticsearch1
</code></pre> 
<h3><a id="_131"></a>三、数据备份</h3> 
<p>备份与恢复的版本说明</p> 
<pre><code class="prism language-text">备份恢复时的版本兼容性：当前版本支持当前版本及升高一个的版本进行恢复不支持跨版本直接恢复。当然如果你想跨版本恢复，可以尝试版本递增滚动升级来达到目的。

反之则不可行，不能递减版本来恢复备份的数据。
</code></pre> 
<h4><a id="1__141"></a>1. 增加仓库配置项</h4> 
<p>在每个Elastcisearch节点的elasticsearch.yml的配置文件内加入：</p> 
<pre><code class="prism language-bash">path:
  repo:
    - /usr/share/elasticsearch/backup
</code></pre> 
<h4><a id="2_APIES_151"></a>2. API指令在原始ES集群创建仓库</h4> 
<pre><code class="prism language-bash">a@~:~$ <span class="token function">curl</span> -H <span class="token string">"Content-Type:application/json"</span> -XPUT <span class="token string">'http://127.0.0.1:9200/_snapshot/{mybackup:这是备份的名称}'</span> -d <span class="token string">'{
&gt;   "type": "fs",
&gt;   "settings": {
&gt;     "location": "backupdata", #是对于elasticsearc.yml中地址的相对地址，也可以填完整地址
&gt;     "compress": "true"  #压缩
&gt;   }
&gt; }'</span>
</code></pre> 
<p>此外还可以选择的参数有：</p> 
<ul><li>location: 仓库地址</li><li>compress: 是否启用压缩，默认为true</li><li>chunk_size: 是否将文件切块，并指定文件块大小，默认：null(不切分)</li><li>max_restore_bytes_per_sec: Snapshot从仓库恢复时的限速，默认：无限制</li><li>max_snapshot_bytes_per_sec: 节点创建Snapshot进入仓库时的限速，默认：40mb/s</li><li>readonly: Snapshot是否只读，默认：false</li><li>更多参数可以参考：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/put-snapshot-repo-api.html?spm=a2c6h.12873639.article-detail.8.288077fcjYK26J" rel="nofollow">官方 Repository API</a></li></ul> 
<p>出现以下内容则说明创建成功</p> 
<pre><code class="prism language-bash"><span class="token punctuation">{<!-- --></span><span class="token string">"acknowledged"</span>:true<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="3_APIES_180"></a>3. API查看原始ES集群里创建的仓库</h4> 
<p>查看刚才建立的名为mybackup的仓库是否成功了</p> 
<pre><code class="prism language-bash">a@~:~$ <span class="token function">curl</span> -XGET <span class="token string">'http://127.0.0.1:9200/_snapshot'</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token string">"mybackup"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span> 
    <span class="token string">"type"</span><span class="token builtin class-name">:</span><span class="token string">"fs"</span>,
    <span class="token string">"settings"</span>:<span class="token punctuation">{<!-- --></span>
        <span class="token string">"compress"</span><span class="token builtin class-name">:</span><span class="token string">"true"</span>,<span class="token string">"location"</span><span class="token builtin class-name">:</span><span class="token string">"backupdata"</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>以上查询到了就是成功了， 此外可以在es创建的时候外挂的数据目录内看到新建的“backupdata”目录</p> 
<h4><a id="4_APIES_198"></a>4. API验证原始ES集群备份仓库是否创建成功</h4> 
<p>通过verify验证节点仓库是否在所有节点已生效</p> 
<pre><code class="prism language-bash">a@~:~$ <span class="token function">curl</span> -XPOST <span class="token string">'http://127.0.0.1:9200/_snapshot/mybackup/_verify'</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token string">"nodes"</span>:<span class="token punctuation">{<!-- --></span>
        <span class="token string">"VsZZX8i9Qk-o2YLwQbNPQQ"</span>:<span class="token punctuation">{<!-- --></span>
            <span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"75707f972883"</span>
            <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="5_API_213"></a>5. API创建快照备份</h4> 
<pre><code class="prism language-bash">a@~:~$ <span class="token function">curl</span> -H <span class="token string">"Content-Type:application/json"</span> -XPUT <span class="token string">'http://127.0.0.1:9200/_snapshot/{mybackup:备份仓库的名字}/{snapshot_1:备份的名字}?wait_for_completion=true'</span> -d <span class="token string">'{
&gt;   "indices": "sms_send_history_202208,users", #需要备份的index 
&gt;   "ignore_unavailable": true,
&gt;   "include_global_state": false,
&gt;   "metadata": {
&gt;     "taken_by": "testuser",
&gt;     "taken_because": "test for backup."
&gt;   }
&gt; }'</span>
</code></pre> 
<p>我们API选择参数等到其完成，因而API的结果最终会返回</p> 
<pre><code class="prism language-bash"><span class="token punctuation">{<!-- --></span><span class="token string">"snapshot"</span>:<span class="token punctuation">{<!-- --></span>
    <span class="token string">"snapshot"</span><span class="token builtin class-name">:</span><span class="token string">"snapshot_1"</span>,
    <span class="token string">"uuid"</span><span class="token builtin class-name">:</span><span class="token string">"8wrJ_ODOTQeiXN9uNamQRw"</span>,
    <span class="token string">"version_id"</span>:7060299,
    <span class="token string">"version"</span><span class="token builtin class-name">:</span><span class="token string">"7.6.2"</span>,
    <span class="token string">"indices"</span>:<span class="token punctuation">[</span><span class="token string">"sms_send_history_202208"</span>,<span class="token string">"users"</span><span class="token punctuation">]</span>,<span class="token string">"include_global_state"</span>:false,
    <span class="token string">"metadata"</span>:<span class="token punctuation">{<!-- --></span>
        <span class="token string">"taken_by"</span><span class="token builtin class-name">:</span><span class="token string">"testuser"</span>,
        <span class="token string">"taken_because"</span><span class="token builtin class-name">:</span><span class="token string">"test for backup."</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"state"</span><span class="token builtin class-name">:</span><span class="token string">"SUCCESS"</span>,
        <span class="token string">"start_time"</span><span class="token builtin class-name">:</span><span class="token string">"2022-08-08T09:43:24.082Z"</span>,<span class="token string">"start_time_in_millis"</span>:1659951804082,<span class="token string">"end_time"</span><span class="token builtin class-name">:</span><span class="token string">"2022-08-08T09:43:24.484Z"</span>,<span class="token string">"end_time_in_millis"</span>:1659951804484,
        <span class="token string">"duration_in_millis"</span>:402,<span class="token string">"failures"</span>:<span class="token punctuation">[</span><span class="token punctuation">]</span>,
        <span class="token string">"shards"</span>:<span class="token punctuation">{<!-- --></span>
            <span class="token string">"total"</span>:6,
            <span class="token string">"failed"</span>:0,
            <span class="token string">"successful"</span>:6
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="6_API_253"></a>6. API删除备份</h4> 
<p>如果导出配置错误\使用完毕，可以将备份删除</p> 
<pre><code class="prism language-bash">DELETE /_snapshot/my_fs_backup/snapshot_1
DELETE /_snapshot/my_fs_backup/snapshot_*
</code></pre> 
<p>能够指定一个、多个备份名称，或者通配符的方式将匹配的全部删除</p> 
<h3><a id="_264"></a>四、数据恢复</h3> 
<p>前面配置两个Elasticsearch节点的时候我们将数据备份的目录挂载在了同一个</p> 
<p>所以，我们只需要在Elasticsearch2的节点上也新建一下同名的仓库，路径名称与上面Elasticsearch1的一致，恢复的时候即可直接一键恢复，如果无法实现同一目录挂载，可能就要涉及数据的转移</p> 
<h4><a id="1__270"></a>1. 必做步骤</h4> 
<pre><code class="prism language-bash">a@~:~$ <span class="token function">curl</span> -H <span class="token string">"Content-Type:application/json"</span> -XPUT <span class="token string">'http://127.0.01:9201/_snapshot/{mybackup:与原仓库一致}'</span> -d <span class="token string">'{
&gt;   "type": "fs",
&gt;   "settings": {
&gt;     "location": "backupdata-与原仓库一致",
&gt;     "compress": "true"
&gt;   }
&gt; }'</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"acknowledged"</span>:true<span class="token punctuation">}</span>
</code></pre> 
<p>否则会有报错：</p> 
<pre><code class="prism language-bash"><span class="token punctuation">{<!-- --></span><span class="token string">"error"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"root_cause"</span>:<span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string">"type"</span><span class="token builtin class-name">:</span><span class="token string">"repository_missing_exception"</span>,<span class="token string">"reason"</span><span class="token builtin class-name">:</span><span class="token string">"[mybackup] missing"</span><span class="token punctuation">}</span><span class="token punctuation">]</span>,<span class="token string">"type"</span><span class="token builtin class-name">:</span><span class="token string">"repository_missing_exception"</span>,<span class="token string">"reason"</span><span class="token builtin class-name">:</span><span class="token string">"[mybackup] missing"</span><span class="token punctuation">}</span>,<span class="token string">"status"</span>:404<span class="token punctuation">}</span>

</code></pre> 
<h4><a id="2_API__290"></a>2. API 恢复备份</h4> 
<p>直接全量恢复</p> 
<pre><code class="prism language-bash"><span class="token function">curl</span> -XPOST <span class="token string">'http://127.0.0.1:9201/_snapshot/mybackup/snapshot_1/_restore'</span>
</code></pre> 
<p>选择部分恢复：</p> 
<pre><code class="prism language-bash"><span class="token function">curl</span> -H <span class="token string">"Content-Type:application/json"</span> -XPOST <span class="token string">'http://127.0.0.1:9201/_snapshot/mybackup/snapshot_1/_restore'</span> -d <span class="token string">'

{
  "indices": "user",
  "ignore_unavailable": true,   
  "include_global_state": false, # include_global_state默认为true，是设置集群全局状态 
  "rename_pattern": "user_(.+)",  # 重命名索引匹配规则，如： user_1  
  "rename_replacement": "re_user_$1",# 重命名索引为新的规则，如： re_user_1
  "include_aliases": false
}'</span>
</code></pre> 
<p>正常返回值：</p> 
<pre><code class="prism language-bash"><span class="token punctuation">{<!-- --></span>
    <span class="token string">"accepted"</span>:true
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="3_API__321"></a>3. API 确认数据</h4> 
<p>通过原始指令查看index 和 索引数据</p> 
<pre><code class="prism language-bash">a@~:~$ <span class="token function">curl</span> http://127.0.0.1:9201/_cat/indices
yellow <span class="token function">open</span> <span class="token function">users</span>                   jSc-YVNhREu_at5b-Nm7vA <span class="token number">5</span> <span class="token number">1</span> <span class="token number">2</span> <span class="token number">0</span> <span class="token number">12</span>.1kb <span class="token number">12</span>.1kb
yellow <span class="token function">open</span> sms_send_history_202208 lefrl7cAQkmO69J2r-xO1g <span class="token number">1</span> <span class="token number">1</span> <span class="token number">9</span> <span class="token number">0</span>   63kb   63kb

a@~:~$ <span class="token function">curl</span> http://127.0.0.1:9201/sms_send_history_202208/_search?pretty
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"took"</span> <span class="token builtin class-name">:</span> <span class="token number">58</span>,
  <span class="token string">"timed_out"</span> <span class="token builtin class-name">:</span> false,
  <span class="token string">"_shards"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"total"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
    <span class="token string">"successful"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
    <span class="token string">"skipped"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,
    <span class="token string">"failed"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span>,
  <span class="token string">"hits"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"total"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"value"</span> <span class="token builtin class-name">:</span> <span class="token number">9</span>,
      <span class="token string">"relation"</span> <span class="token builtin class-name">:</span> <span class="token string">"eq"</span>
    <span class="token punctuation">}</span>,
    <span class="token string">"max_score"</span> <span class="token builtin class-name">:</span> <span class="token number">1.0</span>,
    <span class="token string">"hits"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{<!-- --></span>
        <span class="token string">"_index"</span> <span class="token builtin class-name">:</span> <span class="token string">"sms_send_history_202208"</span>,
        <span class="token string">"_type"</span> <span class="token builtin class-name">:</span> <span class="token string">"sms_send_history"</span>,
        <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"efb44600dbbe446789371ae146df654d"</span>,
        <span class="token string">"_score"</span> <span class="token builtin class-name">:</span> <span class="token number">1.0</span>,
        <span class="token string">"_source"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"acctime"</span> <span class="token builtin class-name">:</span> <span class="token number">1659715200000</span>,
          <span class="token string">"channelid"</span> <span class="token builtin class-name">:</span> <span class="token number">3</span>,
          <span class="token string">"msgcount"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
          <span class="token string">"msgbody"</span> <span class="token builtin class-name">:</span> <span class="token string">"友情提示：1111111222222222220"</span>,
          <span class="token string">"sendcode"</span> <span class="token builtin class-name">:</span> <span class="token string">"001"</span>,
          <span class="token string">"@timestamp"</span> <span class="token builtin class-name">:</span> <span class="token string">"2022-08-08T0"</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>后续可以再通过页面或其他渠道验证下数据</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9ad1824bf50f034f483a8944553d0754/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">bug记录：Yolov5使用注意力机制CBAM报错untimeerror: adaptive_avg_pool2d_backward_cuda does not have a deterministi</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/80ebc96cc675b19535f34c1468801da9/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">使用香橙派zero2及其他单网口开发板搭建UU加速盒</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>