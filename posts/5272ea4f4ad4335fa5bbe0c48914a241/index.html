<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>深度学习100例-循环神经网络（LSTM）实现股票预测 | 第10天 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="深度学习100例-循环神经网络（LSTM）实现股票预测 | 第10天" />
<meta property="og:description" content="🔗 运行环境：python3🚩 作者：K同学啊🥇 精选专栏：《深度学习100例》🔥 选自专栏：《新手入门深度学习》📚 推荐专栏：《Matplotlib教程》🧿 优秀专栏：《Python入门100题》 文章目录 一、前言二、LSTM的是什么三、准备工作1.设置GPU2.设置相关参数3.加载数据 四、数据预处理1.归一化2.时间戳函数 五、构建模型六、激活模型七、训练模型八、结果可视化1.绘制loss图2.预测3.评估 一、前言 今天是第10天，我们将使用LSTM完成股票开盘价格的预测，最后的R2可达到0.74，相对传统的RNN的0.72提高了两个百分点。
我的环境：
语言环境：Python3.6.5编译器：jupyter notebook深度学习环境：TensorFlow2.4.1 来自专栏：【深度学习100例】
往期精彩内容：
深度学习100例-卷积神经网络（LeNet-5）深度学习里的“Hello Word” | 第22天深度学习100例-卷积神经网络（CNN）实现mnist手写数字识别 | 第1天深度学习100例-卷积神经网络（CNN）服装图像分类 | 第3天深度学习100例-卷积神经网络（CNN）花朵识别 | 第4天深度学习100例-卷积神经网络（CNN）天气识别 | 第5天深度学习100例-卷积神经网络（VGG-16）识别海贼王草帽一伙 | 第6天深度学习100例-卷积神经网络（ResNet-50）鸟类识别 | 第8天深度学习100例-循环神经网络（RNN）股票预测 | 第9天 如果你还是一名小白，可以看看我这个专门为你写的专栏：《小白入门深度学习》，帮助零基础的你入门深度学习。
二、LSTM的是什么 神经网络程序的基本流程
一句话介绍LSTM，它是RNN的进阶版，如果说RNN的最大限度是理解一句话，那么LSTM的最大限度则是理解一段话，详细介绍如下：
LSTM，全称为长短期记忆网络(Long Short Term Memory networks)，是一种特殊的RNN，能够学习到长期依赖关系。LSTM由Hochreiter &amp; Schmidhuber (1997)提出，许多研究者进行了一系列的工作对其改进并使之发扬光大。LSTM在许多问题上效果非常好，现在被广泛使用。
所有的循环神经网络都有着重复的神经网络模块形成链的形式。在普通的RNN中，重复模块结构非常简单，其结构如下：
LSTM避免了长期依赖的问题。可以记住长期信息！LSTM内部有较为复杂的结构。能通过门控状态来选择调整传输的信息，记住需要长时间记忆的信息，忘记不重要的信息，其结构如下：
三、准备工作 1.设置GPU 如果使用的是CPU可以注释掉这部分的代码。
import tensorflow as tf gpus = tf.config.list_physical_devices(&#34;GPU&#34;) if gpus: tf.config.experimental.set_memory_growth(gpus[0], True) #设置GPU显存用量按需使用 tf.config.set_visible_devices([gpus[0]],&#34;GPU&#34;) 2.设置相关参数 import pandas as pd import tensorflow as tf import numpy as np import matplotlib." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/5272ea4f4ad4335fa5bbe0c48914a241/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-09-11T15:38:18+08:00" />
<meta property="article:modified_time" content="2022-09-11T15:38:18+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">深度学习100例-循环神经网络（LSTM）实现股票预测 | 第10天</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-github-gist">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <ul><li>🔗 运行环境：python3</li><li>🚩 作者：<a href="https://mtyjkh.blog.csdn.net/" rel="nofollow">K同学啊</a></li><li>🥇 精选专栏：<a href="https://blog.csdn.net/qq_38251616/category_11068756.html"><strong>《深度学习100例》</strong></a></li><li>🔥 选自专栏：<a href="https://blog.csdn.net/qq_38251616/category_11188161.html"><strong>《新手入门深度学习》</strong></a></li><li>📚 推荐专栏：<a href="https://blog.csdn.net/qq_38251616/category_11351625.html"><strong>《Matplotlib教程》</strong></a></li><li>🧿 优秀专栏：<a href="https://blog.csdn.net/qq_38251616/category_11350302.html"><strong>《Python入门100题》</strong></a></li></ul> 
<hr> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_11" rel="nofollow">一、前言</a></li><li><a href="#LSTM_39" rel="nofollow">二、LSTM的是什么</a></li><li><a href="#_58" rel="nofollow">三、准备工作</a></li><li><ul><li><a href="#1GPU_60" rel="nofollow">1.设置GPU</a></li><li><a href="#2_75" rel="nofollow">2.设置相关参数</a></li><li><a href="#3_110" rel="nofollow">3.加载数据</a></li></ul> 
  </li><li><a href="#_285" rel="nofollow">四、数据预处理</a></li><li><ul><li><a href="#1_287" rel="nofollow">1.归一化</a></li><li><a href="#2_297" rel="nofollow">2.时间戳函数</a></li></ul> 
  </li><li><a href="#_323" rel="nofollow">五、构建模型</a></li><li><a href="#_366" rel="nofollow">六、激活模型</a></li><li><a href="#_375" rel="nofollow">七、训练模型</a></li><li><a href="#_443" rel="nofollow">八、结果可视化</a></li><li><ul><li><a href="#1loss_445" rel="nofollow">1.绘制loss图</a></li><li><a href="#2_456" rel="nofollow">2.预测</a></li><li><a href="#3_473" rel="nofollow">3.评估</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_11"></a>一、前言</h2> 
<p>今天是第10天，我们将使用LSTM完成股票开盘价格的预测，最后的R2可达到<code>0.74</code>，相对传统的RNN的<code>0.72</code>提高了两个百分点。</p> 
<p>我的环境：</p> 
<ul><li>语言环境：Python3.6.5</li><li>编译器：jupyter notebook</li><li>深度学习环境：TensorFlow2.4.1</li></ul> 
<p><strong>来自专栏：</strong><a href="https://blog.csdn.net/qq_38251616/category_11068756.html"><strong>【深度学习100例】</strong></a></p> 
<p>往期精彩内容：</p> 
<ul><li><a href="https://mtyjkh.blog.csdn.net/article/details/119700804" rel="nofollow"><strong>深度学习100例-卷积神经网络（LeNet-5）深度学习里的“Hello Word” | 第22天</strong></a></li><li><a href="https://mtyjkh.blog.csdn.net/article/details/116920825" rel="nofollow"><strong>深度学习100例-卷积神经网络（CNN）实现mnist手写数字识别 | 第1天</strong></a></li><li><a href="https://mtyjkh.blog.csdn.net/article/details/116992196" rel="nofollow"><strong>深度学习100例-卷积神经网络（CNN）服装图像分类 | 第3天</strong></a></li><li><a href="https://mtyjkh.blog.csdn.net/article/details/117079919" rel="nofollow"><strong>深度学习100例-卷积神经网络（CNN）花朵识别 | 第4天</strong></a></li><li><a href="https://mtyjkh.blog.csdn.net/article/details/117186183" rel="nofollow"><strong>深度学习100例-卷积神经网络（CNN）天气识别 | 第5天</strong></a></li><li><a href="https://blog.csdn.net/qq_38251616/article/details/117331631"><strong>深度学习100例-卷积神经网络（VGG-16）识别海贼王草帽一伙 | 第6天</strong></a></li><li><a href="https://mtyjkh.blog.csdn.net/article/details/117587326" rel="nofollow"><strong>深度学习100例-卷积神经网络（ResNet-50）鸟类识别 | 第8天</strong></a></li><li><a href="https://mtyjkh.blog.csdn.net/article/details/117752046" rel="nofollow"><strong>深度学习100例-循环神经网络（RNN）股票预测 | 第9天</strong></a></li></ul> 
<p>如果你还是一名小白，可以看看我这个专门为你写的专栏：<a href="https://blog.csdn.net/qq_38251616/category_11188161.html">《小白入门深度学习》</a>，帮助零基础的你入门深度学习。</p> 
<h2><a id="LSTM_39"></a>二、LSTM的是什么</h2> 
<p><strong>神经网络程序的基本流程</strong><br> <img src="https://images2.imgbox.com/9d/cf/8KxO6O20_o.png" alt="在这里插入图片描述"></p> 
<p>一句话介绍LSTM，<strong>它是RNN的进阶版，如果说RNN的最大限度是理解一句话，那么LSTM的最大限度则是理解一段话</strong>，详细介绍如下：</p> 
<p>LSTM，全称为长短期记忆网络(Long Short Term Memory networks)，是一种特殊的RNN，能够学习到长期依赖关系。LSTM由Hochreiter &amp; Schmidhuber (1997)提出，许多研究者进行了一系列的工作对其改进并使之发扬光大。LSTM在许多问题上效果非常好，现在被广泛使用。</p> 
<p>所有的循环神经网络都有着重复的神经网络模块形成链的形式。在普通的RNN中，重复模块结构非常简单，其结构如下：</p> 
<p><img src="https://images2.imgbox.com/74/f0/mxuiJD3U_o.png" alt="在这里插入图片描述"></p> 
<p>LSTM避免了长期依赖的问题。可以记住长期信息！LSTM内部有较为复杂的结构。能通过门控状态来选择调整传输的信息，<strong>记住需要长时间记忆的信息，忘记不重要的信息</strong>，其结构如下：</p> 
<p><img src="https://images2.imgbox.com/e4/bf/OOMnQuqw_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_58"></a>三、准备工作</h2> 
<h3><a id="1GPU_60"></a>1.设置GPU</h3> 
<p>如果使用的是CPU可以注释掉这部分的代码。</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf

gpus <span class="token operator">=</span> tf<span class="token punctuation">.</span>config<span class="token punctuation">.</span>list_physical_devices<span class="token punctuation">(</span><span class="token string">"GPU"</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> gpus<span class="token punctuation">:</span>
    tf<span class="token punctuation">.</span>config<span class="token punctuation">.</span>experimental<span class="token punctuation">.</span>set_memory_growth<span class="token punctuation">(</span>gpus<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment">#设置GPU显存用量按需使用</span>
    tf<span class="token punctuation">.</span>config<span class="token punctuation">.</span>set_visible_devices<span class="token punctuation">(</span><span class="token punctuation">[</span>gpus<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"GPU"</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="2_75"></a>2.设置相关参数</h3> 
<pre><code class="prism language-python"><span class="token keyword">import</span> pandas            <span class="token keyword">as</span> pd
<span class="token keyword">import</span> tensorflow        <span class="token keyword">as</span> tf  
<span class="token keyword">import</span> numpy             <span class="token keyword">as</span> np
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token comment"># 支持中文</span>
plt<span class="token punctuation">.</span>rcParams<span class="token punctuation">[</span><span class="token string">'font.sans-serif'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'SimHei'</span><span class="token punctuation">]</span>  <span class="token comment"># 用来正常显示中文标签</span>
plt<span class="token punctuation">.</span>rcParams<span class="token punctuation">[</span><span class="token string">'axes.unicode_minus'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">False</span>  <span class="token comment"># 用来正常显示负号</span>

<span class="token keyword">from</span> numpy                 <span class="token keyword">import</span> array
<span class="token keyword">from</span> sklearn               <span class="token keyword">import</span> metrics
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>preprocessing <span class="token keyword">import</span> MinMaxScaler
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>models          <span class="token keyword">import</span> Sequential
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>layers          <span class="token keyword">import</span> Dense<span class="token punctuation">,</span>LSTM<span class="token punctuation">,</span>Bidirectional


<span class="token comment"># 确保结果尽可能重现</span>
<span class="token keyword">from</span> numpy<span class="token punctuation">.</span>random          <span class="token keyword">import</span> seed
seed<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
tf<span class="token punctuation">.</span>random<span class="token punctuation">.</span>set_seed<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token comment"># 设置相关参数</span>
n_timestamp  <span class="token operator">=</span> <span class="token number">40</span>    <span class="token comment"># 时间戳</span>
n_epochs     <span class="token operator">=</span> <span class="token number">20</span>    <span class="token comment"># 训练轮数</span>
<span class="token comment"># ====================================</span>
<span class="token comment">#      选择模型：</span>
<span class="token comment">#            1: 单层 LSTM</span>
<span class="token comment">#            2: 多层 LSTM</span>
<span class="token comment">#            3: 双向 LSTM</span>
<span class="token comment"># ====================================</span>
model_type <span class="token operator">=</span> <span class="token number">1</span>
</code></pre> 
<h3><a id="3_110"></a>3.加载数据</h3> 
<pre><code class="prism language-python">data <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'./datasets/SH600519.csv'</span><span class="token punctuation">)</span>  <span class="token comment"># 读取股票文件</span>

data
</code></pre> 
<div> 
</div> 
<table border="1" class="dataframe"><thead><tr><th></th><th>Unnamed: 0</th><th>date</th><th>open</th><th>close</th><th>high</th><th>low</th><th>volume</th><th>code</th></tr></thead><tbody><tr><th>0</th><td>74</td><td>2010-04-26</td><td>88.702</td><td>87.381</td><td>89.072</td><td>87.362</td><td>107036.13</td><td>600519</td></tr><tr><th>1</th><td>75</td><td>2010-04-27</td><td>87.355</td><td>84.841</td><td>87.355</td><td>84.681</td><td>58234.48</td><td>600519</td></tr><tr><th>2</th><td>76</td><td>2010-04-28</td><td>84.235</td><td>84.318</td><td>85.128</td><td>83.597</td><td>26287.43</td><td>600519</td></tr><tr><th>3</th><td>77</td><td>2010-04-29</td><td>84.592</td><td>85.671</td><td>86.315</td><td>84.592</td><td>34501.20</td><td>600519</td></tr><tr><th>4</th><td>78</td><td>2010-04-30</td><td>83.871</td><td>82.340</td><td>83.871</td><td>81.523</td><td>85566.70</td><td>600519</td></tr><tr><th>...</th><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td></tr><tr><th>2421</th><td>2495</td><td>2020-04-20</td><td>1221.000</td><td>1227.300</td><td>1231.500</td><td>1216.800</td><td>24239.00</td><td>600519</td></tr><tr><th>2422</th><td>2496</td><td>2020-04-21</td><td>1221.020</td><td>1200.000</td><td>1223.990</td><td>1193.000</td><td>29224.00</td><td>600519</td></tr><tr><th>2423</th><td>2497</td><td>2020-04-22</td><td>1206.000</td><td>1244.500</td><td>1249.500</td><td>1202.220</td><td>44035.00</td><td>600519</td></tr><tr><th>2424</th><td>2498</td><td>2020-04-23</td><td>1250.000</td><td>1252.260</td><td>1265.680</td><td>1247.770</td><td>26899.00</td><td>600519</td></tr><tr><th>2425</th><td>2499</td><td>2020-04-24</td><td>1248.000</td><td>1250.560</td><td>1259.890</td><td>1235.180</td><td>19122.00</td><td>600519</td></tr></tbody></table> 
<p>2426 rows × 8 columns</p> 
<pre><code class="prism language-python"><span class="token triple-quoted-string string">"""
前(2426-300=2126)天的开盘价作为训练集,后300天的开盘价作为测试集
"""</span>
training_set <span class="token operator">=</span> data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">2426</span> <span class="token operator">-</span> <span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values  
test_set     <span class="token operator">=</span> data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token number">2426</span> <span class="token operator">-</span> <span class="token number">300</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values
</code></pre> 
<h2><a id="_285"></a>四、数据预处理</h2> 
<h3><a id="1_287"></a>1.归一化</h3> 
<pre><code class="prism language-python"><span class="token comment">#将数据归一化，范围是0到1</span>
sc  <span class="token operator">=</span> MinMaxScaler<span class="token punctuation">(</span>feature_range<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
training_set_scaled <span class="token operator">=</span> sc<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>training_set<span class="token punctuation">)</span>
testing_set_scaled  <span class="token operator">=</span> sc<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>test_set<span class="token punctuation">)</span> 
</code></pre> 
<h3><a id="2_297"></a>2.时间戳函数</h3> 
<pre><code class="prism language-python"><span class="token comment"># 取前 n_timestamp 天的数据为 X；n_timestamp+1天数据为 Y。</span>
<span class="token keyword">def</span> <span class="token function">data_split</span><span class="token punctuation">(</span>sequence<span class="token punctuation">,</span> n_timestamp<span class="token punctuation">)</span><span class="token punctuation">:</span>
    X <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    y <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>sequence<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        end_ix <span class="token operator">=</span> i <span class="token operator">+</span> n_timestamp
        
        <span class="token keyword">if</span> end_ix <span class="token operator">&gt;</span> <span class="token builtin">len</span><span class="token punctuation">(</span>sequence<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>
            
        seq_x<span class="token punctuation">,</span> seq_y <span class="token operator">=</span> sequence<span class="token punctuation">[</span>i<span class="token punctuation">:</span>end_ix<span class="token punctuation">]</span><span class="token punctuation">,</span> sequence<span class="token punctuation">[</span>end_ix<span class="token punctuation">]</span>
        X<span class="token punctuation">.</span>append<span class="token punctuation">(</span>seq_x<span class="token punctuation">)</span>
        y<span class="token punctuation">.</span>append<span class="token punctuation">(</span>seq_y<span class="token punctuation">)</span>
    <span class="token keyword">return</span> array<span class="token punctuation">(</span>X<span class="token punctuation">)</span><span class="token punctuation">,</span> array<span class="token punctuation">(</span>y<span class="token punctuation">)</span>

X_train<span class="token punctuation">,</span> y_train <span class="token operator">=</span> data_split<span class="token punctuation">(</span>training_set_scaled<span class="token punctuation">,</span> n_timestamp<span class="token punctuation">)</span>
X_train          <span class="token operator">=</span> X_train<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>X_train<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> X_train<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

X_test<span class="token punctuation">,</span> y_test   <span class="token operator">=</span> data_split<span class="token punctuation">(</span>testing_set_scaled<span class="token punctuation">,</span> n_timestamp<span class="token punctuation">)</span>
X_test           <span class="token operator">=</span> X_test<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>X_test<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> X_test<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> 
<h2><a id="_323"></a>五、构建模型</h2> 
<pre><code class="prism language-python"><span class="token comment"># 建构 LSTM模型</span>
<span class="token keyword">if</span> model_type <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
    <span class="token comment"># 单层 LSTM</span>
    model <span class="token operator">=</span> Sequential<span class="token punctuation">(</span><span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>LSTM<span class="token punctuation">(</span>units<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">,</span>
                   input_shape<span class="token operator">=</span><span class="token punctuation">(</span>X_train<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Dense<span class="token punctuation">(</span>units<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> model_type <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>
    <span class="token comment"># 多层 LSTM</span>
    model <span class="token operator">=</span> Sequential<span class="token punctuation">(</span><span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>LSTM<span class="token punctuation">(</span>units<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">,</span> return_sequences<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                   input_shape<span class="token operator">=</span><span class="token punctuation">(</span>X_train<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>LSTM<span class="token punctuation">(</span>units<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Dense<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> model_type <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">:</span>
    <span class="token comment"># 双向 LSTM</span>
    model <span class="token operator">=</span> Sequential<span class="token punctuation">(</span><span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Bidirectional<span class="token punctuation">(</span>LSTM<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            input_shape<span class="token operator">=</span><span class="token punctuation">(</span>X_train<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Dense<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
model<span class="token punctuation">.</span>summary<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 输出模型结构</span>
</code></pre> 
<pre><code>WARNING:tensorflow:Layer lstm will not use cuDNN kernel since it doesn't meet the cuDNN kernel criteria. It will use generic GPU kernel as fallback when running on GPU
Model: "sequential"
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
lstm (LSTM)                  (None, 50)                10400     
_________________________________________________________________
dense (Dense)                (None, 1)                 51        
=================================================================
Total params: 10,451
Trainable params: 10,451
Non-trainable params: 0
_________________________________________________________________
</code></pre> 
<h2><a id="_366"></a>六、激活模型</h2> 
<pre><code class="prism language-python"><span class="token comment"># 该应用只观测loss数值，不观测准确率，所以删去metrics选项，一会在每个epoch迭代显示时只显示loss值</span>
model<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span>optimizer<span class="token operator">=</span>tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>optimizers<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span><span class="token operator">**</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              loss<span class="token operator">=</span><span class="token string">'mean_squared_error'</span><span class="token punctuation">)</span>  <span class="token comment"># 损失函数用均方误差</span>
</code></pre> 
<h2><a id="_375"></a>七、训练模型</h2> 
<pre><code class="prism language-python">history <span class="token operator">=</span> model<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>X_train<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> 
                    batch_size<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> 
                    epochs<span class="token operator">=</span>n_epochs<span class="token punctuation">,</span> 
                    validation_data<span class="token operator">=</span><span class="token punctuation">(</span>X_test<span class="token punctuation">,</span> y_test<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                    validation_freq<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>                  <span class="token comment">#测试的epoch间隔数</span>

model<span class="token punctuation">.</span>summary<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>Epoch 1/20
33/33 [==============================] - 5s 107ms/step - loss: 0.1049 - val_loss: 0.0569
Epoch 2/20
33/33 [==============================] - 3s 86ms/step - loss: 0.0074 - val_loss: 1.1616
Epoch 3/20
33/33 [==============================] - 3s 83ms/step - loss: 0.0012 - val_loss: 0.1408
Epoch 4/20
33/33 [==============================] - 3s 78ms/step - loss: 5.8758e-04 - val_loss: 0.0421
Epoch 5/20
33/33 [==============================] - 3s 84ms/step - loss: 5.3411e-04 - val_loss: 0.0159
Epoch 6/20
33/33 [==============================] - 3s 81ms/step - loss: 3.9690e-04 - val_loss: 0.0034
Epoch 7/20
33/33 [==============================] - 3s 84ms/step - loss: 4.3521e-04 - val_loss: 0.0032
Epoch 8/20
33/33 [==============================] - 3s 85ms/step - loss: 3.8233e-04 - val_loss: 0.0059
Epoch 9/20
33/33 [==============================] - 3s 81ms/step - loss: 3.6539e-04 - val_loss: 0.0082
Epoch 10/20
33/33 [==============================] - 3s 81ms/step - loss: 3.1790e-04 - val_loss: 0.0141
Epoch 11/20
33/33 [==============================] - 3s 82ms/step - loss: 3.5332e-04 - val_loss: 0.0166
Epoch 12/20
33/33 [==============================] - 3s 86ms/step - loss: 3.2684e-04 - val_loss: 0.0155
Epoch 13/20
33/33 [==============================] - 3s 80ms/step - loss: 2.6495e-04 - val_loss: 0.0149
Epoch 14/20
33/33 [==============================] - 3s 84ms/step - loss: 3.1398e-04 - val_loss: 0.0172
Epoch 15/20
33/33 [==============================] - 3s 80ms/step - loss: 3.4533e-04 - val_loss: 0.0077
Epoch 16/20
33/33 [==============================] - 3s 81ms/step - loss: 2.9621e-04 - val_loss: 0.0082
Epoch 17/20
33/33 [==============================] - 3s 83ms/step - loss: 2.2228e-04 - val_loss: 0.0092
Epoch 18/20
33/33 [==============================] - 3s 86ms/step - loss: 2.4517e-04 - val_loss: 0.0093
Epoch 19/20
33/33 [==============================] - 3s 86ms/step - loss: 2.7179e-04 - val_loss: 0.0053
Epoch 20/20
33/33 [==============================] - 3s 82ms/step - loss: 2.5923e-04 - val_loss: 0.0054
Model: "sequential"
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
lstm (LSTM)                  (None, 50)                10400     
_________________________________________________________________
dense (Dense)                (None, 1)                 51        
=================================================================
Total params: 10,451
Trainable params: 10,451
Non-trainable params: 0
_________________________________________________________________
</code></pre> 
<h2><a id="_443"></a>八、结果可视化</h2> 
<h3><a id="1loss_445"></a>1.绘制loss图</h3> 
<pre><code class="prism language-python3">plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>history<span class="token punctuation">.</span>history<span class="token punctuation">[</span><span class="token string">'loss'</span><span class="token punctuation">]</span>    <span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Training Loss'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>history<span class="token punctuation">.</span>history<span class="token punctuation">[</span><span class="token string">'val_loss'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Validation Loss'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Training and Validation Loss by K同学啊'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/a2/41/vy2VTMxT_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="2_456"></a>2.预测</h3> 
<pre><code class="prism language-python">predicted_stock_price <span class="token operator">=</span> model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>X_test<span class="token punctuation">)</span>                        <span class="token comment"># 测试集输入模型进行预测</span>
predicted_stock_price <span class="token operator">=</span> sc<span class="token punctuation">.</span>inverse_transform<span class="token punctuation">(</span>predicted_stock_price<span class="token punctuation">)</span>  <span class="token comment"># 对预测数据还原---从（0，1）反归一化到原始范围</span>
real_stock_price      <span class="token operator">=</span> sc<span class="token punctuation">.</span>inverse_transform<span class="token punctuation">(</span>y_test<span class="token punctuation">)</span><span class="token comment"># 对真实数据还原---从（0，1）反归一化到原始范围</span>

<span class="token comment"># 画出真实数据和预测数据的对比曲线</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>real_stock_price<span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'red'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Stock Price'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>predicted_stock_price<span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'blue'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Predicted Stock Price'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Stock Price Prediction by K同学啊'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">'Time'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">'Stock Price'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/a3/94/BUGMeWkM_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3_473"></a>3.评估</h3> 
<pre><code class="prism language-python"><span class="token triple-quoted-string string">"""
MSE  ：均方误差    -----&gt;  预测值减真实值求平方后求均值
RMSE ：均方根误差  -----&gt;  对均方误差开方
MAE  ：平均绝对误差-----&gt;  预测值减真实值求绝对值后求均值
R2   ：决定系数，可以简单理解为反映模型拟合优度的重要的统计量

详细介绍可以参考文章：https://blog.csdn.net/qq_38251616/article/details/107997435
"""</span>
MSE   <span class="token operator">=</span> metrics<span class="token punctuation">.</span>mean_squared_error<span class="token punctuation">(</span>predicted_stock_price<span class="token punctuation">,</span> real_stock_price<span class="token punctuation">)</span>
RMSE  <span class="token operator">=</span> metrics<span class="token punctuation">.</span>mean_squared_error<span class="token punctuation">(</span>predicted_stock_price<span class="token punctuation">,</span> real_stock_price<span class="token punctuation">)</span><span class="token operator">**</span><span class="token number">0.5</span>
MAE   <span class="token operator">=</span> metrics<span class="token punctuation">.</span>mean_absolute_error<span class="token punctuation">(</span>predicted_stock_price<span class="token punctuation">,</span> real_stock_price<span class="token punctuation">)</span>
R2    <span class="token operator">=</span> metrics<span class="token punctuation">.</span>r2_score<span class="token punctuation">(</span>predicted_stock_price<span class="token punctuation">,</span> real_stock_price<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'均方误差: %.5f'</span> <span class="token operator">%</span> MSE<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'均方根误差: %.5f'</span> <span class="token operator">%</span> RMSE<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'平均绝对误差: %.5f'</span> <span class="token operator">%</span> MAE<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'R2: %.5f'</span> <span class="token operator">%</span> R2<span class="token punctuation">)</span>
</code></pre> 
<pre><code>均方误差: 2688.75170
均方根误差: 51.85317
平均绝对误差: 44.97829
R2: 0.74036
</code></pre> 
<p>拟合度除了更换模型外，还可以通过调整参数来提高，这里主要是介绍LSTM，就不对调参做详细介绍了。</p> 
<p>往期精彩内容：</p> 
<ul><li><a href="https://mtyjkh.blog.csdn.net/article/details/116920825" rel="nofollow"><strong>深度学习100例-卷积神经网络（CNN）实现mnist手写数字识别 | 第1天</strong></a></li><li><a href="https://mtyjkh.blog.csdn.net/article/details/116992196" rel="nofollow"><strong>深度学习100例-卷积神经网络（CNN）服装图像分类 | 第3天</strong></a></li><li><a href="https://mtyjkh.blog.csdn.net/article/details/117079919" rel="nofollow"><strong>深度学习100例-卷积神经网络（CNN）花朵识别 | 第4天</strong></a></li><li><a href="https://mtyjkh.blog.csdn.net/article/details/117186183" rel="nofollow"><strong>深度学习100例-卷积神经网络（CNN）天气识别 | 第5天</strong></a></li><li><a href="https://blog.csdn.net/qq_38251616/article/details/117331631"><strong>深度学习100例-卷积神经网络（VGG-16）识别海贼王草帽一伙 | 第6天</strong></a></li><li><a href="https://mtyjkh.blog.csdn.net/article/details/117587326" rel="nofollow"><strong>深度学习100例-卷积神经网络（ResNet-50）鸟类识别 | 第8天</strong></a></li><li><a href="https://mtyjkh.blog.csdn.net/article/details/117752046" rel="nofollow"><strong>深度学习100例-循环神经网络（RNN）股票预测 | 第9天</strong></a></li></ul> 
<p><strong>来自专栏：</strong><a href="https://mp.weixin.qq.com/mp/appmsgalbum?action=getalbum&amp;__biz=MzUyNDgyNDkyMQ==&amp;scene=1&amp;album_id=1902502231082352640&amp;count=3#wechat_redirect" rel="nofollow"><strong>《深度学习100例》</strong></a></p> 
<p>如果觉得本文对你有帮助记得 <strong>点个关注，给个赞，加个收藏</strong></p> 
<hr> 
<p>最后再送大家一本，<strong>帮助大家拿到 BAT 等一线大厂 offer 的数据结构刷题笔记</strong>，是谷歌和阿里的大佬写的，对于算法薄弱或者需要提高的同学都十分受用（提取码：9go2 ）：</p> 
<p><a href="https://pan.baidu.com/s/1Ng0CIXc_eiXoBhaiHwZ8xQ" rel="nofollow">谷歌和阿里大佬的Leetcode刷题笔记</a></p> 
<p>以及我整理的<strong>7K+本开源电子书</strong>，总有一本可以帮到你 💖（提取码：4eg0）</p> 
<p><a href="https://pan.baidu.com/s/1Uaw7Pd-Y21fVbrzzO3kLVA" rel="nofollow">7K+本开源电子书</a></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/92593c5d00c526acc89c1ad3bbb2e316/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">golang容易导致内存泄漏的几种情况</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9737eb706805732481ff19255928da81/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">数据库表设计优化-主键字段</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>