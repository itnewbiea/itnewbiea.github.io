<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android ANR问题定位 实战 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android ANR问题定位 实战" />
<meta property="og:description" content="在Android开发过程中，ANR问题可能是非常常见的一个问题，下面我分享一个亲身经历的ANR问题以及解决方法。
1.发生ANR 必然会有log日志，在系统的data/anr目录下， 我们将所有的anr log日志pull出来 由于权限的原因，一般使用：
adb pull /data/anr/anr_2022-08-04-19-43-53-830 ./ 会提示：
adb: error: failed to copy &#39;/data/anr/anr_2022-08-04-19-43-53-830&#39; to &#39;.//anr_2022-08-04-19-43-53-830&#39;: remote open failed: Permission denied 如果倒不出来，可以采用
adb bugreport 执行这个命令之后会在/home/ms(这里是我的路径)生成一个zip文件: bugreport-crosshatch-SPB5.210812.002-2022-08-04-19-52-30.zip
将这个zip解压开得到：
在/FS/data/anr 下面就是产生anr的日志文件
打开最新的一个anr日志文件,内容很多，可以通过搜索 main来快速定位到日志：
&#34;main&#34; prio=5 tid=1 Native | group=&#34;main&#34; sCount=1 ucsCount=0 flags=1 obj=0x71bb1108 self=0x7aaf011010 | sysTid=11840 nice=-10 cgrp=default sched=0/0 handle=0x7be4f0a4f8 | state=R schedstat=( 34563882813 172228872 5118 ) utm=3400 stm=55 core=6 HZ=100 | stack=0x7fc17f0000-0x7fc17f2000 stackSize=8188KB | held mutexes= native: #00 pc 00000000005f29dc /data/app/~~HpEMONV-UKwHtGltDb4G-w==/com." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/32bf2a8cbf4aaf17c8135163b4cccbf8/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-04T21:25:58+08:00" />
<meta property="article:modified_time" content="2022-08-04T21:25:58+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android ANR问题定位 实战</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>在Android开发过程中，ANR问题可能是非常常见的一个问题，下面我分享一个亲身经历的ANR问题以及解决方法。</p> 
<h5><a id="1ANR_logdataanr_anr_logpull_2"></a>1.发生ANR 必然会有log日志，在系统的data/anr目录下， 我们将所有的anr log日志pull出来</h5> 
<p>由于权限的原因，一般使用：</p> 
<pre><code class="prism language-shell">adb pull /data/anr/anr_2022-08-04-19-43-53-830 ./
</code></pre> 
<p>会提示：</p> 
<pre><code class="prism language-shell">adb: error: failed to copy <span class="token string">'/data/anr/anr_2022-08-04-19-43-53-830'</span> to <span class="token string">'.//anr_2022-08-04-19-43-53-830'</span><span class="token builtin class-name">:</span> remote <span class="token function">open</span> failed: Permission denied
</code></pre> 
<p>如果倒不出来，可以采用</p> 
<pre><code class="prism language-shell">adb bugreport
</code></pre> 
<p>执行这个命令之后会在/home/ms(这里是我的路径)生成一个zip文件: bugreport-crosshatch-SPB5.210812.002-2022-08-04-19-52-30.zip</p> 
<p>将这个zip解压开得到：</p> 
<p><img src="https://images2.imgbox.com/d7/e9/S2yEVsdy_o.png" alt="在这里插入图片描述"></p> 
<p>在/FS/data/anr 下面就是产生anr的日志文件</p> 
<p><img src="https://images2.imgbox.com/71/ef/CAs9gOCX_o.png" alt="在这里插入图片描述"></p> 
<p>打开最新的一个anr日志文件,内容很多，可以通过搜索 main来快速定位到日志：</p> 
<pre><code class="prism language-shell"><span class="token string">"main"</span> <span class="token assign-left variable">prio</span><span class="token operator">=</span><span class="token number">5</span> <span class="token assign-left variable">tid</span><span class="token operator">=</span><span class="token number">1</span> Native
  <span class="token operator">|</span> <span class="token assign-left variable">group</span><span class="token operator">=</span><span class="token string">"main"</span> <span class="token assign-left variable">sCount</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">ucsCount</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">flags</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">obj</span><span class="token operator">=</span>0x71bb1108 <span class="token assign-left variable">self</span><span class="token operator">=</span>0x7aaf011010
  <span class="token operator">|</span> <span class="token assign-left variable">sysTid</span><span class="token operator">=</span><span class="token number">11840</span> <span class="token assign-left variable">nice</span><span class="token operator">=</span>-10 <span class="token assign-left variable">cgrp</span><span class="token operator">=</span>default <span class="token assign-left variable">sched</span><span class="token operator">=</span><span class="token number">0</span>/0 <span class="token assign-left variable">handle</span><span class="token operator">=</span>0x7be4f0a4f8
  <span class="token operator">|</span> <span class="token assign-left variable">state</span><span class="token operator">=</span>R <span class="token assign-left variable">schedstat</span><span class="token operator">=</span><span class="token punctuation">(</span> <span class="token number">34563882813</span> <span class="token number">172228872</span> <span class="token number">5118</span> <span class="token punctuation">)</span> <span class="token assign-left variable">utm</span><span class="token operator">=</span><span class="token number">3400</span> <span class="token assign-left variable">stm</span><span class="token operator">=</span><span class="token number">55</span> <span class="token assign-left variable">core</span><span class="token operator">=</span><span class="token number">6</span> <span class="token assign-left variable">HZ</span><span class="token operator">=</span><span class="token number">100</span>
  <span class="token operator">|</span> <span class="token assign-left variable">stack</span><span class="token operator">=</span>0x7fc17f0000-0x7fc17f2000 <span class="token assign-left variable">stackSize</span><span class="token operator">=</span>8188KB
  <span class="token operator">|</span> held <span class="token assign-left variable">mutexes</span><span class="token operator">=</span>
  native: <span class="token comment">#00 pc 00000000005f29dc  /data/app/~~HpEMONV-UKwHtGltDb4G-w==/com.meishe.ms240sdkdemo-9NftEp5LVuvFBG2ZxJvKVQ==/lib/arm64/libNvStreamingSdkCore.so (???)</span>
  at com.meicam.sdk.NvsTimeline.nativeApplyThemeTemplate<span class="token punctuation">(</span>Native method<span class="token punctuation">)</span>
  at com.meicam.sdk.NvsTimeline.applyThemeTemplate<span class="token punctuation">(</span>NvsTimeline.java:1466<span class="token punctuation">)</span>
  at com.czc.cutsame.CutSameEditorActivity.createTimeline<span class="token punctuation">(</span>CutSameEditorActivity.java:250<span class="token punctuation">)</span>
  at com.czc.cutsame.CutSameEditorActivity.initData<span class="token punctuation">(</span>CutSameEditorActivity.java:118<span class="token punctuation">)</span>
  at com.meishe.base.model.BaseActivity.onCreate<span class="token punctuation">(</span>BaseActivity.java:48<span class="token punctuation">)</span>
  at com.czc.cutsame.CutSameEditorActivity.onCreate<span class="token punctuation">(</span>CutSameEditorActivity.java:95<span class="token punctuation">)</span>
  at android.app.Activity.performCreate<span class="token punctuation">(</span>Activity.java:8051<span class="token punctuation">)</span>
  at android.app.Activity.performCreate<span class="token punctuation">(</span>Activity.java:8031<span class="token punctuation">)</span>
  at android.app.Instrumentation.callActivityOnCreate<span class="token punctuation">(</span>Instrumentation.java:1329<span class="token punctuation">)</span>
  at android.app.ActivityThread.performLaunchActivity<span class="token punctuation">(</span>ActivityThread.java:3612<span class="token punctuation">)</span>
  at android.app.ActivityThread.handleLaunchActivity<span class="token punctuation">(</span>ActivityThread.java:3796<span class="token punctuation">)</span>
  at android.app.servertransaction.LaunchActivityItem.execute<span class="token punctuation">(</span>LaunchActivityItem.java:103<span class="token punctuation">)</span>
  at android.app.servertransaction.TransactionExecutor.executeCallbacks<span class="token punctuation">(</span>TransactionExecutor.java:135<span class="token punctuation">)</span>
  at android.app.servertransaction.TransactionExecutor.execute<span class="token punctuation">(</span>TransactionExecutor.java:95<span class="token punctuation">)</span>
  at android.app.ActivityThread<span class="token variable">$H</span>.handleMessage<span class="token punctuation">(</span>ActivityThread.java:2214<span class="token punctuation">)</span>
  at android.os.Handler.dispatchMessage<span class="token punctuation">(</span>Handler.java:106<span class="token punctuation">)</span>
  at android.os.Looper.loopOnce<span class="token punctuation">(</span>Looper.java:201<span class="token punctuation">)</span>
  at android.os.Looper.loop<span class="token punctuation">(</span>Looper.java:288<span class="token punctuation">)</span>
  at android.app.ActivityThread.main<span class="token punctuation">(</span>ActivityThread.java:7842<span class="token punctuation">)</span>
  at java.lang.reflect.Method.invoke<span class="token punctuation">(</span>Native method<span class="token punctuation">)</span>
  at com.android.internal.os.RuntimeInit<span class="token variable">$MethodAndArgsCaller</span>.run<span class="token punctuation">(</span>RuntimeInit.java:548<span class="token punctuation">)</span>
  at com.android.internal.os.ZygoteInit.main<span class="token punctuation">(</span>ZygoteInit.java:1003<span class="token punctuation">)</span>
</code></pre> 
<p>1： pid： 8625 对的上<br> 2： cmd line: 包名对得上 check完毕<br> 3： 查看UI线程，搜索main</p> 
<p>native: #00 pc 00000000005f29dc /data/app/~~HpEMONV-UKwHtGltDb4G-w==/com.meishe.ms240sdkdemo-9NftEp5LVuvFBG2ZxJvKVQ==/lib/arm64/libNvStreamingSdkCore.so (???)</p> 
<p>通过上面这个可以看出这个是一个native层的问题，给出出问题的so库的符号地址：00000000005f29dc</p> 
<p>2.通过aarch64-linux-android-addr2line 命令解析符号地址：00000000005f29dc</p> 
<p>aarch64-linux-android-addr2line 这个命令存在 /home/ms/tools/android-ndk-r21e/toolchains/aarch64-linux-android-4.9/prebuilt/linux-x86_64/bin（笔者是这个路径）</p> 
<p>可以将这个路径配置到环境变量，方便直接使用</p> 
<p>解析错误符号地址的命令：aarch64-linux-android-addr2line -C -f -e &lt;对应带符号表的so库&gt; &lt;8位内存地址&gt;</p> 
<pre><code class="prism language-shell">./aarch64-linux-android-addr2line -C -f -e <span class="token string">'/home/ms/ftp-download/sdk/3.5.1/NvStreamingSdk_Android_3.5.1.8_20220804_102011_ARScene_MS_Symbol/NvStreamingSdk_Android_3.5.1.8_20220804_102011_Symbol/android_arm64/libNvStreamingSdkCoreSymbol.so'</span> 0005f29dc
</code></pre> 
<p>注意这里的so库是对应的带符号的so库才可以</p> 
<p>解析的结果是：</p> 
<p><img src="https://images2.imgbox.com/43/a3/TQRtQFXO_o.png" alt="在这里插入图片描述"></p> 
<p>错误符号解析的结果：能定位到问题是由于CNvProjTimeline::ResetThemeTemplate() 这个方法导致的。</p> 
<p>这个ANR问题就定位到原因了。</p> 
<p>3.小技巧总结</p> 
<ul><li>“main” prio=：搜索 anr 相关信息</li><li>beginning of crash：搜索 crash 相关信息</li><li>CPU usage from：搜索 cpu 使用信息</li><li>也可以通过走索这个 ----- pid 来定位ANR问题</li></ul> 
<p>Cmd line：后边跟的是包名，包名能对上就能定位成功了</p> 
<pre><code class="prism language-shell">----- pid <span class="token number">11840</span> at <span class="token number">2022</span>-08-04 <span class="token number">19</span>:43:53.853466911+0800 -----
<span class="token punctuation">..</span>.
<span class="token punctuation">..</span>.
Total number of allocations <span class="token number">768630</span>  //进程创建到现在一共创建了多少对象
Total bytes allocated 67MB  // 进程创建到现在一共申请了多少内存
Total bytes freed 55MB    // 进程创建到现在一共释放了多少内存
Free memory 20MB   // 空闲内存（可用内存）
Free memory <span class="token keyword">until</span> GC 20MB  // GC前的空闲内存
Free memory <span class="token keyword">until</span> OOME 243MB    // OOM之前的可用内存，当这个值很小的时候，已经处于内存紧张状态，应用可能占用了过多的内存
Total memory 32MB    // 当前总内存（已用+可用）
Max memory 256MB     // 进程最多能申请的内存 

</code></pre> 
<p>从日志里边能看到有三个线程，一个是 <code>Signal Catcher</code> 线程，一个是 <code>main</code> 线程，一个是 <code>Jit thread pool worker thread 0</code>，他们的线程状态分别是 <code>Runnable</code> 、 <code>blocked</code> 和 <code>native</code> 状态。</p> 
<p>线程的状态：</p> 
<ul><li>NEW - 创建状态</li><li>RUNNABLE - 就绪或运行状态</li><li>BLOCKED - 阻塞状态</li><li>WATING - 等待状态</li><li>TIMED_WAITING - 定时等待状态</li><li>TERMINATED - 终止状态</li></ul> 
<p><strong>native 状态不在类别之内，这个表示正在执行JNI函数，也是runnable状态。</strong></p> 
<p>堆栈信息是我们分析ANR的第一个重要的信息，一般来说：</p> 
<ul><li>主线程处于 BLOCK / WAITING / TIMEWAITING 状态，基本上是函数阻塞导致的 anr</li><li>若主线程无异常，则应该排查 CPU 负载和内存环境等其他因素</li></ul> 
<p>另外，在 anr 日志中，还有一些常见参数，他们的含义如下：</p> 
<ul><li>group：线程所处的线程组</li><li>sCount：线程被正常挂起的次数</li><li>dsCount：线程因调试而挂起次数</li><li>nice：线程的调度优先级</li><li>utm：线程在用户态中调度时间值</li><li>stm：线程在内核态中的调度时间值</li><li>core：最后执行这个线程的CPU核序号</li></ul>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/fe9b1947b8952cdad7026f54055a36da/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">如何制定有效的模型应用策略？</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/400df097f06138d3e01c7c959d92c388/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">数据中台是什么？附9张架构图优质模板</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>