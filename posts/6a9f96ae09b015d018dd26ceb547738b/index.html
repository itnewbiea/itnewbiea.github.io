<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Ambari-2.7.5在麒麟V10操作系统中的集群部署（二） - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Ambari-2.7.5在麒麟V10操作系统中的集群部署（二）" />
<meta property="og:description" content="Ambari-2.7.5在麒麟V10操作系统中的集群部署（二） 之前通过修改os-check.py文件，解决了Ambari安装过程中无法识别kylin系统的问题。
最后成功在三台kylin V10系统上安装了Ambari，并登录前端页面。
本文解决在Ambari页面部署hdp集群的过程中所出现的问题以及解决方案。
1、 在confirm hosts步骤中出现的问题。 Ambari官方建议的是使用全限定类名来扫描hosts，也就是说在/etc/hosts文件中应该是：
#ip地址 全限定类名 简称 192.168.1.101 node1.test.com node1 192.168.1.102 node2.test.com node2 192.168.1.103 node3.test.com node3 我也没有多余的尝试使用简称到底行不行，没什么意义，但是见过成功案例，理论上应该都可以。
下载之前安装的ssh免密服务的密钥，在~/.ssh/目录下，名为id_rsa的文件。将其上传，然后进入confirm阶段。
在此过程中如果总是失败，就重试。
如果卡在preparing阶段，在每一台agent安装的机器上执行如下命令：
vim /etc/ambari-agent/conf/ambari-agent.ini #在[security]下，添加一行代码 force_https_protocol=PROTOCOL_TLSv1_2 [security] keysdir=/var/lib/ambari-agent/keys server_crt=ca.crt passphrase_env_var_name=AMBARI_PASSPHRASE ssl_verify_cert=0 credential_lib_dir=/var/lib/ambari-agent/cred/lib credential_conf_dir=/var/lib/ambari-agent/cred/conf credential_shell_cmd=org.apache.hadoop.security.alias.CredentialShell force_https_protocol=PROTOCOL_TLSv1_2 2、在Install，Start and Test出现问题（重点） 首先最直接的，进入到这一步骤，上来就报错，无论勾选几个服务，在Activity Analyzer Install这里一直报错。
File &#34;/usr/lib/ambari-agent/lib/ambari_commons/repo_manager/yum_manager.py&#34;, line 211, in install_package elif context.is_upgrade or context.use_repos or not self._check_existence(name): File &#34;/usr/lib/ambari-agent/lib/ambari_commons/repo_manager/yum_manager.py&#34;, line 278, in _check_existence return self.yum_check_package_available(name) File &#34;/usr/lib/ambari-agent/lib/ambari_commons/repo_manager/yum_manager.py&#34;, line 287, in yum_check_package_available import yum # Python Yum API is much faster then other check methods." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/6a9f96ae09b015d018dd26ceb547738b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-06T17:17:00+08:00" />
<meta property="article:modified_time" content="2023-07-06T17:17:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Ambari-2.7.5在麒麟V10操作系统中的集群部署（二）</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="Ambari275V10_0"></a>Ambari-2.7.5在麒麟V10操作系统中的集群部署（二）</h3> 
<blockquote> 
 <p>之前通过修改os-check.py文件，解决了Ambari安装过程中无法识别kylin系统的问题。</p> 
 <p>最后成功在三台kylin V10系统上安装了Ambari，并登录前端页面。</p> 
 <p>本文解决在Ambari页面部署hdp集群的过程中所出现的问题以及解决方案。</p> 
</blockquote> 
<h4><a id="1_confirm_hosts_9"></a>1、 在confirm hosts步骤中出现的问题。</h4> 
<p>Ambari官方建议的是使用全限定类名来扫描hosts，也就是说在/etc/hosts文件中应该是：</p> 
<pre><code class="prism language-shell"><span class="token comment">#ip地址        全限定类名        简称</span>
<span class="token number">192.168</span>.1.101 node1.test.com  node1
<span class="token number">192.168</span>.1.102 node2.test.com  node2
<span class="token number">192.168</span>.1.103 node3.test.com  node3
</code></pre> 
<p>我也没有多余的尝试使用简称到底行不行，没什么意义，但是见过成功案例，理论上应该都可以。</p> 
<p>下载之前安装的ssh免密服务的密钥，在<code>~/.ssh/</code>目录下，名为<code>id_rsa</code>的文件。将其上传，然后进入confirm阶段。</p> 
<p>在此过程中如果总是失败，就重试。</p> 
<p>如果卡在<code>preparing</code>阶段，在每一台agent安装的机器上执行如下命令：</p> 
<pre><code class="prism language-shell"><span class="token function">vim</span> /etc/ambari-agent/conf/ambari-agent.ini
<span class="token comment">#在[security]下，添加一行代码 force_https_protocol=PROTOCOL_TLSv1_2</span>
<span class="token punctuation">[</span>security<span class="token punctuation">]</span>
<span class="token assign-left variable">keysdir</span><span class="token operator">=</span>/var/lib/ambari-agent/keys
<span class="token assign-left variable">server_crt</span><span class="token operator">=</span>ca.crt
<span class="token assign-left variable">passphrase_env_var_name</span><span class="token operator">=</span>AMBARI_PASSPHRASE
<span class="token assign-left variable">ssl_verify_cert</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token assign-left variable">credential_lib_dir</span><span class="token operator">=</span>/var/lib/ambari-agent/cred/lib
<span class="token assign-left variable">credential_conf_dir</span><span class="token operator">=</span>/var/lib/ambari-agent/cred/conf
<span class="token assign-left variable">credential_shell_cmd</span><span class="token operator">=</span>org.apache.hadoop.security.alias.CredentialShell
<span class="token assign-left variable">force_https_protocol</span><span class="token operator">=</span>PROTOCOL_TLSv1_2
</code></pre> 
<h4><a id="2InstallStart_and_Test_41"></a>2、在Install，Start and Test出现问题（重点）</h4> 
<p>首先最直接的，进入到这一步骤，上来就报错，无论勾选几个服务，在Activity Analyzer Install这里一直报错。</p> 
<pre><code class="prism language-python">File <span class="token string">"/usr/lib/ambari-agent/lib/ambari_commons/repo_manager/yum_manager.py"</span><span class="token punctuation">,</span> line <span class="token number">211</span><span class="token punctuation">,</span> <span class="token keyword">in</span> install_package
    <span class="token keyword">elif</span> context<span class="token punctuation">.</span>is_upgrade <span class="token keyword">or</span> context<span class="token punctuation">.</span>use_repos <span class="token keyword">or</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>_check_existence<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>
  File <span class="token string">"/usr/lib/ambari-agent/lib/ambari_commons/repo_manager/yum_manager.py"</span><span class="token punctuation">,</span> line <span class="token number">278</span><span class="token punctuation">,</span> <span class="token keyword">in</span> _check_existence
    <span class="token keyword">return</span> self<span class="token punctuation">.</span>yum_check_package_available<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
  File <span class="token string">"/usr/lib/ambari-agent/lib/ambari_commons/repo_manager/yum_manager.py"</span><span class="token punctuation">,</span> line <span class="token number">287</span><span class="token punctuation">,</span> <span class="token keyword">in</span> yum_check_package_available
    <span class="token keyword">import</span> yum  <span class="token comment"># Python Yum API is much faster then other check methods. (even then "import rpm")</span>
ImportError<span class="token punctuation">:</span> No module named yum
</code></pre> 
<p>报错内容最后一句：<code>No module named yum</code></p> 
<h5><a id="_57"></a>重点分析：</h5> 
<p>yum是python的一个模块module；麒麟V10系统自带两个版本的python，2和3；也自带yum，但是此yum并不是yum，而是dnf，证据如下：</p> 
<p><img src="https://images2.imgbox.com/72/c3/EuXKywe8_o.png" alt="在这里插入图片描述"></p> 
<p>可见其<code>/usr/bin/yum</code>命令都指向了dnf。</p> 
<p>dnf是centos8中yum的升级版本，dnf包含yum，也就是在centos7中，可以说yum是python的模块：<code>py.yum</code>，但是在centos8或kylinV10中：<code>py.dnf.yum</code>。</p> 
<p>同时<code>vi /usr/bin/yum</code>可以看到头部为<code>#!/usr/bin/python3</code>，使用的是python3，这里又与Ambari的安装调用python有点出入。众所周知python的2和3版本语法不兼容，所以有时候一个py文件不能即用python2运行又可以用python3运行。</p> 
<p>下面贴上所做的尝试和最终的解决办法。</p> 
<p><strong>针对报错</strong><code>ImportError: No module named yum</code></p> 
<p><strong><code>方法一</code></strong></p> 
<p>经过之前安装Ambari，yum是可以正常使用的，但仍然出现该错误，可能是因为yum模块的路径没有正确设置。可以尝试手动设置PYTHONPATH环境变量，将yum模块的路径添加到其中。例如，在bash终端中，可以运行以下命令：</p> 
<pre><code class="prism language-shell"><span class="token builtin class-name">export</span> <span class="token assign-left variable">PYTHONPATH</span><span class="token operator">=</span><span class="token variable">$PYTHONPATH</span>:/usr/lib/python3.7/site-packages/
</code></pre> 
<p>这将把<code>/usr/lib/python3.7/site-packages/</code>路径添加到<code>PYTHONPATH</code>中。请根据你的实际情况修改路径。</p> 
<p><strong>结果：无效。</strong></p> 
<p><strong><code>方法二</code></strong></p> 
<p>在麒麟V10系统中 yum在dnf包内</p> 
<p>尝试在<code>/usr/lib/python3.7/site-packages/</code>中</p> 
<p>创建yum软链到<code>/usr/lib/python3.7/site-packages/dnf/yum</code></p> 
<pre><code class="prism language-shell"><span class="token function">ln</span> -s /usr/lib/python3.7/site-packages/yum /usr/lib/python3.7/site-packages/dnf/yum
</code></pre> 
<p>在python3命令行中 import yum 发现可以了</p> 
<pre><code class="prism language-python"><span class="token punctuation">[</span>root@node1 redlsb<span class="token punctuation">]</span><span class="token comment"># python3</span>
Python <span class="token number">3.7</span><span class="token number">.4</span> <span class="token punctuation">(</span>default<span class="token punctuation">,</span> Sep <span class="token number">30</span> <span class="token number">2020</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">:</span><span class="token number">28</span><span class="token punctuation">:</span><span class="token number">21</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>GCC <span class="token number">7.3</span><span class="token number">.0</span><span class="token punctuation">]</span> on linux
Type <span class="token string">"help"</span><span class="token punctuation">,</span> <span class="token string">"copyright"</span><span class="token punctuation">,</span> <span class="token string">"credits"</span> <span class="token keyword">or</span> <span class="token string">"license"</span> <span class="token keyword">for</span> more information<span class="token punctuation">.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">import</span> yum
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token comment">#这里正常无报错 即可</span>
</code></pre> 
<p>如果系统中存在多个Python版本，可能是因为Ambari正在使用不正确的Python版本。可以尝试指定正确的Python版本来运行Ambari。例如，可以使用以下命令在特定的Python版本中运行Ambari：</p> 
<p><code>python3.7 ambari-server.py start</code></p> 
<p>这将使用Python 3.7版本来运行Ambari。</p> 
<p>报错：</p> 
<pre><code class="prism language-shell">File <span class="token string">"/usr/sbin/ambari-server.py"</span>, line <span class="token number">169</span>
  except OSError, e:
                ^
SyntaxError: invalid syntax
</code></pre> 
<p>这是由于py2和py3的代码不兼容</p> 
<p><strong>结果：无效。</strong></p> 
<p><strong><code>方法三（卸载python2和3、yum、dnf，重装）</code></strong></p> 
<p>该方法是没有办法的办法，要慎重。尝试该方法之前，突然灵光乍现，见方法四。</p> 
<p><strong><code>方法四、最终办法，亲测有效</code></strong></p> 
<p>麒麟系统与centos7或者8类似，更像8一点。但是7的大部分软件包都可以用。</p> 
<p>Ambari-Server启动时的头部信息是 <code>#!/usr/bin/python</code>，也就是用的python2</p> 
<p>查看麒麟系统的python2和python3的模块包site-packages，发现2.7的模块很少，没有yum其他的依赖也少的可怜，3.7倒是有很多，也有dnf和之前设置的软链yum。这也解释了为什么yum可以正常使用，但是ambari安装服务时就是检测不到。</p> 
<p>因为是yum源的问题， 所以想到替换yum源的模块包：<strong>将centos7/8里面python2.7的site-packages包替换过来</strong>，注意ambari-server.py使用的是python2，所以我们的思路是给python2装一个可用的yum。</p> 
<p>重启ambari</p> 
<pre><code class="prism language-shell">ambari-server restart
</code></pre> 
<p>果然，<code>No module named yum</code> 报错没有了<br> 出现了新的报错：<code>No module named sqlitecachec</code></p> 
<p>可知，这是依赖问题。</p> 
<p>因为copy过来的site-packages里面没有安装pip，所以安装一下pip</p> 
<pre><code class="prism language-shell">python -m ensurepip --upgrade
<span class="token comment">#原生的pip安装比较慢 可以更换pip源：</span>
pip config <span class="token builtin class-name">set</span> global.index-url https://pypi.tuna.tsinghua.edu.cn/simple
</code></pre> 
<p><code>sqlitecachec</code>包在:<code>yum-metadata-parser</code>里：</p> 
<pre><code class="prism language-shell"><span class="token function">rpm</span> -ivh http://mirror.centos.org/centos/7/os/x86_64/Packages/yum-metadata-parser-1.1.4-10.el7.x86_64.rpm --force
</code></pre> 
<p>重启ambari。</p> 
<p>报错： <code>No module named pycurl</code></p> 
<pre><code class="prism language-shell">pip <span class="token function">install</span> pycurl
<span class="token comment">#报错：Could not run curl-config: [Errno 2] No such file or directory</span>
<span class="token function">rpm</span> -ivh http://mirrors.sohu.com/centos/7/os/x86_64/Packages/libidn-1.28-4.el7.x86_64.rpm --force
<span class="token function">rpm</span> -ivh http://mirrors.sohu.com/centos/7/os/x86_64/Packages/libidn-devel-1.28-4.el7.x86_64.rpm --force
<span class="token function">rpm</span> -ivh http://mirrors.sohu.com/centos/7/os/x86_64/Packages/nss-pem-1.0.3-7.el7.x86_64.rpm --force
<span class="token function">rpm</span> -ivh http://mirrors.sohu.com/centos/7/os/x86_64/Packages/libcurl-7.29.0-59.el7.x86_64.rpm --force
<span class="token function">rpm</span> -ivh http://mirrors.sohu.com/centos/7/os/x86_64/Packages/libcurl-devel-7.29.0-59.el7.x86_64.rpm --force
<span class="token comment">#成功安装后，再次安装pycurl </span>
pip <span class="token function">install</span> pycurl
<span class="token comment">#安装成功</span>
</code></pre> 
<p>再次重启ambari-server 继续安装服务</p> 
<p>报错：<code>ImportError: pycurl: libcurl link-time ssl backend (openssl) is different from compile-time ssl backend (none/other)</code></p> 
<pre><code class="prism language-shell"><span class="token comment">#安装openssl-devel    </span>
yum <span class="token function">install</span> -y openssl-devel 
<span class="token comment">#卸载重装pycurl并指定openssl</span>
pip uninstall pycurl 
<span class="token builtin class-name">export</span> <span class="token assign-left variable">PYCURL_SSL_LIBRARY</span><span class="token operator">=</span>openssl
pip <span class="token function">install</span> pycurl 
成功 
</code></pre> 
<p>重启ambari-server 重试</p> 
<p>新的报错：<code>redhat-lsb依赖错误</code></p> 
<pre><code class="prism language-shell">RuntimeError: Failed to execute <span class="token builtin class-name">command</span> <span class="token string">'/usr/bin/yum -y install hadoop_3_1_5_0_152'</span>, exited with code <span class="token string">'1'</span>, message: 'Error: 
 Problem: cannot <span class="token function">install</span> the best candidate <span class="token keyword">for</span> the job
  - nothing provides redhat-lsb needed by hadoop_3_1_5_0_152-3.1.1.3.1.5.0-152.x86_64
</code></pre> 
<p>kylin的yum仓库不支持redhat-lsb的下载安装，那么有两种方法：</p> 
<p>1、更换centos7的yum源，执行<code>yum -y install redhat-lsb</code></p> 
<p>2、自己wget下载并安装。（我的选择），操作如下：</p> 
<pre><code class="prism language-shell"><span class="token function">rpm</span> -ivh  https://update.cs2c.com.cn/NS/V10/V10SP2/os/adv/lic/base/x86_64/Packages/kylin-lsb-5.0-1.p01.ky10.x86_64.rpm
<span class="token comment">#执行 lsb_release  显示如下：</span>
LSB Version:    :core-5.0-amd64:core-5.0-noarch
</code></pre> 
<p>随便创建一个空的文件夹进去：</p> 
<pre><code class="prism language-shell"><span class="token function">wget</span> http://mirrors.sohu.com/centos/7/os/x86_64/Packages/redhat-lsb-4.1-27.el7.centos.1.x86_64.rpm
<span class="token function">wget</span> http://mirrors.sohu.com/centos/7/os/x86_64/Packages/redhat-lsb-core-4.1-27.el7.centos.1.x86_64.rpm
<span class="token function">wget</span> http://mirrors.sohu.com/centos/7/os/x86_64/Packages/redhat-lsb-cxx-4.1-27.el7.centos.1.x86_64.rpm
<span class="token function">wget</span> http://mirrors.sohu.com/centos/7/os/x86_64/Packages/redhat-lsb-desktop-4.1-27.el7.centos.1.x86_64.rpm
<span class="token function">wget</span> http://mirrors.sohu.com/centos/7/os/x86_64/Packages/redhat-lsb-languages-4.1-27.el7.centos.1.x86_64.rpm
<span class="token function">wget</span> http://mirrors.sohu.com/centos/7/os/x86_64/Packages/redhat-lsb-printing-4.1-27.el7.centos.1.x86_64.rpm
<span class="token function">wget</span> http://mirrors.sohu.com/centos/7/os/x86_64/Packages/redhat-lsb-submod-multimedia-4.1-27.el7.centos.1.x86_64.rpm
<span class="token function">wget</span> http://mirrors.sohu.com/centos/7/os/x86_64/Packages/redhat-lsb-submod-security-4.1-27.el7.centos.1.x86_64.rpm
<span class="token function">wget</span> http://mirrors.sohu.com/centos/7/os/x86_64/Packages/redhat-lsb-supplemental-4.1-27.el7.centos.1.x86_64.rpm
<span class="token function">wget</span> http://mirrors.sohu.com/centos/7/os/x86_64/Packages/redhat-lsb-trialuse-4.1-27.el7.centos.1.x86_64.rpm
</code></pre> 
<pre><code class="prism language-shell"><span class="token comment">#忽略依赖 强制安装</span>
<span class="token function">rpm</span> -ivh *rpm --nodeps --force
<span class="token comment">#安装完成后</span>
<span class="token comment">##执行 lsb_release  显示如下：</span>
LSB Version:    :core-4.1-amd64:core-4.1-noarch:core-5.0-amd64:core-5.0-noarch:cxx-4.1-amd64:cxx-4.1-noarch:desktop-4.1-amd64:desktop-4.1-noarch:languages-4.1-amd64:languages-4.1-noarch:printing-4.1-amd64:printing-4.1-noarch:trialuse-4.1-amd64:trialuse-4.1-noarch
</code></pre> 
<p>重启<code>ambari-server</code>重试<code>Install，Start and Test</code>。</p> 
<pre><code class="prism language-shell">ambari-server restart
</code></pre> 
<p>发现安装成功！！！<br> 安装其他服务试一试，没得问题！！！撒花~</p> 
<p><img src="https://images2.imgbox.com/0b/0b/S2rMTjLX_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/1b/d6/rLysVQqv_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/93/0c/nv2Shq5O_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5aa3b33482669110f7faa64b7d0de33a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">office的0xC004F017问题</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/63378fcae694505355a72c292e26c649/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">《计算机视觉》笔记——简介、目录</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>