<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【深度学习入门系列】 pytorch实现多层感知机（MLP）（内含分类、回归任务实例） - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【深度学习入门系列】 pytorch实现多层感知机（MLP）（内含分类、回归任务实例）" />
<meta property="og:description" content="文章目录 0. BP和MLP1 分类1.0 数据集1.1 网络架构1.2 代码1.3 结果 2 回归2.0 数据集2.1 网络架构2.2 代码2.3 结果 3 代码（可直接食用） 众所周知，sklearn提供了MLP函数。个人认为这个东西虽然蛮好用的——有的时候比你自己写的效果都好，但是，不是长久之计。通过Pytorch能建立自定义程度更高的人工神经网络，往后在网络里面加乱七八糟的东西都很方便（比如GA/PSO求解超参之类的、比如微调模型架构之类的）。本文将不再对MLP的理论基础进行赘述，直接介绍MLP的具体搭建方法。
0. BP和MLP 在做这个之前，我突然想到一个问题
我现在出了一篇 MLP 的文章，要不要再出一个 BP 的？
沉默……
这俩有什么区别啊？？？
跟某知名大博主讨论了一下，感觉大概是这样的：
我们先明确3个概念：
BP：BP的全称是back propagation（反向传播算法），这并不是一个神经网络。BP神经网络：用了BP算法的神经网络。MLP：多层感知机，也就是我们说的神经网络。 那么我们不难发现，所谓的BP神经网络其实应该是（BP-MLP ）
&lt;=&gt; BP神经网络 = BP算法 &#43; MLP（多层感知机）
也就是说，BP 和 MLP 本身是平行的两个概念，不是一件事；它们是 BP 神经网络这个事物的两个不同的方面。
猜测
最开始的时候，神经网络方面的知识还不够丰富，这个时候人们把刚开始的那个简单的结构称作MLP。
随着时间的流逝，人们发现了反向传播算法（BP），这个时候开始强调训练方法了，所以将其相关的神经网络称为BP神经网络。
再往后，因为人们都用BP了，BP不那么新那么火了，这个时候又开始强调模型结构了，就出现了乱七八糟的其他神经网络。
1 分类 1.0 数据集 数据集我采用的是之前接手的一个保险理赔项目。
目标是判断用户是不是来骗保的，给了一大堆特征，这里我就不详细解释是哪些特征了，这篇文章主要负责搭建模型。
归一化之后发现数据还是非常稀疏的，而且看着可能二值化效果会不错，嫌麻烦，不尝试了，就直接拿这个用也没什么大问题。
是一个4分类任务，结果可能没2分类好看，这跟项目的数据也有关，本身数据也比较脏、噪声也比较多，感觉特征与 label 之间的联系也不是特别紧密。不过问题不大，我们的重心还是放在搭网络上。
数据集缺点还包括样本不平衡，确实会影响结果。
data.csv （36221x24）=&gt; 已经包括 label 了
1.1 网络架构 torch 输出的架构如下" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/f0efaf5f2774f6787a8ad7aad72c66b9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-01T10:29:56+08:00" />
<meta property="article:modified_time" content="2023-05-01T10:29:56+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【深度学习入门系列】 pytorch实现多层感知机（MLP）（内含分类、回归任务实例）</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#0_BPMLP_4" rel="nofollow">0. BP和MLP</a></li><li><a href="#1__33" rel="nofollow">1 分类</a></li><li><ul><li><a href="#10__34" rel="nofollow">1.0 数据集</a></li><li><a href="#11__49" rel="nofollow">1.1 网络架构</a></li><li><a href="#12__58" rel="nofollow">1.2 代码</a></li><li><a href="#13__428" rel="nofollow">1.3 结果</a></li></ul> 
  </li><li><a href="#2__441" rel="nofollow">2 回归</a></li><li><ul><li><a href="#20__442" rel="nofollow">2.0 数据集</a></li><li><a href="#21__458" rel="nofollow">2.1 网络架构</a></li><li><a href="#22__468" rel="nofollow">2.2 代码</a></li><li><a href="#23__822" rel="nofollow">2.3 结果</a></li></ul> 
  </li><li><a href="#3__839" rel="nofollow">3 代码（可直接食用）</a></li></ul> 
</div> 
<p></p> 
<p>众所周知，sklearn提供了MLP函数。个人认为这个东西虽然蛮好用的——有的时候比你自己写的效果都好，但是，不是长久之计。通过Pytorch能建立自定义程度更高的人工神经网络，往后在网络里面加乱七八糟的东西都很方便（比如GA/PSO求解超参之类的、比如微调模型架构之类的）。本文将不再对MLP的理论基础进行赘述，直接介绍MLP的具体搭建方法。</p> 
<h2><a id="0_BPMLP_4"></a>0. BP和MLP</h2> 
<p>在做这个之前，我突然想到一个问题</p> 
<p>我现在出了一篇 MLP 的文章，要不要再出一个 BP 的？</p> 
<p>沉默……</p> 
<p>这俩有什么区别啊？？？</p> 
<p>跟某知名大博主讨论了一下，感觉大概是这样的：</p> 
<p>我们先明确3个概念：</p> 
<ul><li><strong>BP</strong>：BP的全称是back propagation（反向传播算法），这并不是一个神经网络。</li><li><strong>BP神经网络</strong>：用了BP算法的神经网络。</li><li><strong>MLP</strong>：多层感知机，也就是我们说的神经网络。</li></ul> 
<p>那么我们不难发现，所谓的BP神经网络其实应该是（BP-MLP ）<br> &lt;=&gt; BP神经网络 = BP算法 + MLP（多层感知机）</p> 
<p>也就是说，BP 和 MLP 本身是平行的两个概念，不是一件事；它们是 BP 神经网络这个事物的两个不同的方面。</p> 
<p><strong>猜测</strong></p> 
<p>最开始的时候，神经网络方面的知识还不够丰富，这个时候人们把刚开始的那个简单的结构称作MLP。</p> 
<p>随着时间的流逝，人们发现了反向传播算法（BP），这个时候开始强调训练方法了，所以将其相关的神经网络称为BP神经网络。</p> 
<p>再往后，因为人们都用BP了，BP不那么新那么火了，这个时候又开始强调模型结构了，就出现了乱七八糟的其他神经网络。</p> 
<h2><a id="1__33"></a>1 分类</h2> 
<h3><a id="10__34"></a>1.0 数据集</h3> 
<p>数据集我采用的是之前接手的一个保险理赔项目。</p> 
<p>目标是判断用户是不是来骗保的，给了一大堆特征，这里我就不详细解释是哪些特征了，这篇文章主要负责搭建模型。</p> 
<p>归一化之后发现数据还是非常稀疏的，而且看着可能二值化效果会不错，嫌麻烦，不尝试了，就直接拿这个用也没什么大问题。</p> 
<p>是一个4分类任务，结果可能没2分类好看，这跟项目的数据也有关，本身数据也比较脏、噪声也比较多，感觉特征与 label 之间的联系也不是特别紧密。不过问题不大，我们的重心还是放在搭网络上。</p> 
<p>数据集缺点还包括样本不平衡，确实会影响结果。</p> 
<p>data.csv （36221x24）=&gt; 已经包括 label 了</p> 
<p><img src="https://images2.imgbox.com/5f/0e/3DsY1NjF_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="11__49"></a>1.1 网络架构</h3> 
<p>torch 输出的架构如下</p> 
<p><img src="https://images2.imgbox.com/42/e8/m91TXPkg_o.png" alt="在这里插入图片描述"></p> 
<p>一共是4层隐藏层（10-&gt;10-&gt;10-&gt;10）</p> 
<p>也尝试过 128-&gt;64-&gt;16 和一些大的复杂的多层感知机，效果反而没这个好，从混淆矩阵看能发现过拟合了。</p> 
<h3><a id="12__58"></a>1.2 代码</h3> 
<p>分类任务的相关文件如下</p> 
<p><img src="https://images2.imgbox.com/df/04/imktD7Yb_o.png" alt="在这里插入图片描述"></p> 
<pre><code>MLP_clf.py			分类模型架构
data.csv			分类数据集
run.py				主函数
utils.py			相关函数和类
</code></pre> 
<p><code>run.py </code></p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> numpy
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> random
<span class="token keyword">from</span> utils <span class="token keyword">import</span> Config<span class="token punctuation">,</span> CLF_Model<span class="token punctuation">,</span> REG_Model
<span class="token keyword">from</span> clf_model<span class="token punctuation">.</span>MLP_clf <span class="token keyword">import</span> MLP

<span class="token comment"># 随机数种子确定</span>
seed <span class="token operator">=</span> <span class="token number">1129</span>
random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span>seed<span class="token punctuation">)</span>
numpy<span class="token punctuation">.</span>random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span>seed<span class="token punctuation">)</span>
torch<span class="token punctuation">.</span>manual_seed<span class="token punctuation">(</span>seed<span class="token punctuation">)</span>
torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>manual_seed<span class="token punctuation">(</span>seed<span class="token punctuation">)</span>
torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>manual_seed_all<span class="token punctuation">(</span>seed<span class="token punctuation">)</span>
torch<span class="token punctuation">.</span>backends<span class="token punctuation">.</span>cudnn<span class="token punctuation">.</span>deterministic <span class="token operator">=</span> <span class="token boolean">True</span>
torch<span class="token punctuation">.</span>backends<span class="token punctuation">.</span>cudnn<span class="token punctuation">.</span>benchmark <span class="token operator">=</span> <span class="token boolean">False</span>
os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">'PYTHONHASHSEED'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>seed<span class="token punctuation">)</span>


<span class="token comment"># 分类</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
	<span class="token comment"># 读数据</span>
    config <span class="token operator">=</span> Config<span class="token punctuation">(</span>
        data_path<span class="token operator">=</span><span class="token string">"dataset_clf/data.csv"</span><span class="token punctuation">,</span>
        name<span class="token operator">=</span><span class="token string">"MLP"</span><span class="token punctuation">,</span>
        batch_size<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">,</span>
        learning_rate<span class="token operator">=</span><span class="token number">0.000005</span><span class="token punctuation">,</span>
        epoch<span class="token operator">=</span><span class="token number">200</span>
    <span class="token punctuation">)</span>
    <span class="token comment"># 搭模型</span>
    clf <span class="token operator">=</span> MLP<span class="token punctuation">(</span>
        input_n<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>input_col<span class="token punctuation">)</span><span class="token punctuation">,</span>
        output_n<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>output_class<span class="token punctuation">)</span><span class="token punctuation">,</span>
        num_layer<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span>
        layer_list<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        dropout<span class="token operator">=</span><span class="token number">0.5</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>clf<span class="token punctuation">)</span>
    <span class="token comment"># 训练模型并评价模型</span>
    model <span class="token operator">=</span> CLF_Model<span class="token punctuation">(</span>clf<span class="token punctuation">,</span> config<span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><code>MLP_clf.py </code></p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">import</span> Linear<span class="token punctuation">,</span> ReLU<span class="token punctuation">,</span> ModuleList<span class="token punctuation">,</span> Sequential<span class="token punctuation">,</span> Dropout<span class="token punctuation">,</span> Softmax<span class="token punctuation">,</span> Tanh
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional <span class="token keyword">as</span> F

<span class="token keyword">class</span> <span class="token class-name">MLP</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 默认三层隐藏层，分别有128个 64个 16个神经元</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> input_n<span class="token punctuation">,</span> output_n<span class="token punctuation">,</span> num_layer<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> layer_list<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dropout<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        :param input_n: int 输入神经元个数
        :param output_n: int 输出神经元个数
        :param num_layer: int 隐藏层层数
        :param layer_list: list(int) 每层隐藏层神经元个数
        :param dropout: float 训练完丢掉多少
        """</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>MLP<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>input_n <span class="token operator">=</span> input_n
        self<span class="token punctuation">.</span>output_n <span class="token operator">=</span> output_n
        self<span class="token punctuation">.</span>num_layer <span class="token operator">=</span> num_layer
        self<span class="token punctuation">.</span>layer_list <span class="token operator">=</span> layer_list

        <span class="token comment"># 输入层</span>
        self<span class="token punctuation">.</span>input_layer <span class="token operator">=</span> Sequential<span class="token punctuation">(</span>
            Linear<span class="token punctuation">(</span>input_n<span class="token punctuation">,</span> layer_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>

        <span class="token comment"># 隐藏层</span>
        self<span class="token punctuation">.</span>hidden_layer <span class="token operator">=</span> Sequential<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">for</span> index <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_layer<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>hidden_layer<span class="token punctuation">.</span>extend<span class="token punctuation">(</span><span class="token punctuation">[</span>Linear<span class="token punctuation">(</span>layer_list<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">,</span> layer_list<span class="token punctuation">[</span>index<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>dropout <span class="token operator">=</span> Dropout<span class="token punctuation">(</span>dropout<span class="token punctuation">)</span>

        <span class="token comment"># 输出层</span>
        self<span class="token punctuation">.</span>output_layer <span class="token operator">=</span> Sequential<span class="token punctuation">(</span>
            Linear<span class="token punctuation">(</span>layer_list<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> output_n<span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            Softmax<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">input</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>input_layer<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        hidden <span class="token operator">=</span> self<span class="token punctuation">.</span>hidden_layer<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">)</span>
        hidden <span class="token operator">=</span> self<span class="token punctuation">.</span>dropout<span class="token punctuation">(</span>hidden<span class="token punctuation">)</span>
        output <span class="token operator">=</span> self<span class="token punctuation">.</span>output_layer<span class="token punctuation">(</span>hidden<span class="token punctuation">)</span>
        <span class="token keyword">return</span> output
</code></pre> 
<p><code>util.py </code></p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> sys

<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional <span class="token keyword">as</span> F
<span class="token keyword">from</span> matplotlib <span class="token keyword">import</span> pyplot <span class="token keyword">as</span> plt
<span class="token keyword">from</span> sklearn <span class="token keyword">import</span> metrics
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>metrics <span class="token keyword">import</span> mean_squared_error<span class="token punctuation">,</span> r2_score
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword">import</span> train_test_split
<span class="token keyword">import</span> time
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> timedelta


<span class="token comment"># 一个数据格式。感觉这玩意好多余啊，但是nlp写多了就很习惯的写了一个上去 =&gt; 主要是不写没法封装</span>
<span class="token keyword">class</span> <span class="token class-name">Dataset</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>Dataset<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data_df<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>label <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>data_df<span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>data <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>data_df<span class="token punctuation">[</span>data_df<span class="token punctuation">.</span>columns<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>

    <span class="token comment"># 每次迭代取出对应的data和author</span>
    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
        batch_data <span class="token operator">=</span> self<span class="token punctuation">.</span>get_batch_data<span class="token punctuation">(</span>idx<span class="token punctuation">)</span>
        batch_label <span class="token operator">=</span> self<span class="token punctuation">.</span>get_batch_label<span class="token punctuation">(</span>idx<span class="token punctuation">)</span>
        <span class="token keyword">return</span> batch_data<span class="token punctuation">,</span> batch_label

    <span class="token comment"># 下面的几条没啥用其实，就是为__getitem__服务的</span>
    <span class="token keyword">def</span> <span class="token function">classes</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>label

    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>data<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">get_batch_label</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>self<span class="token punctuation">.</span>label<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">get_batch_data</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>data<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>


<span class="token comment"># 存数据，加载数据用的</span>
<span class="token keyword">class</span> <span class="token class-name">Config</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data_path<span class="token punctuation">,</span> name<span class="token punctuation">,</span> batch_size<span class="token punctuation">,</span> learning_rate<span class="token punctuation">,</span> epoch<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        :param data_path: string 数据文件路径
        :param name: string 模型名字
        :param batch_size: int 多少条数据组成一个batch
        :param learning_rate: float 学习率
        :param epoch: int 学几轮
        """</span>
        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name
        self<span class="token punctuation">.</span>data_path <span class="token operator">=</span> data_path
        self<span class="token punctuation">.</span>batch_size <span class="token operator">=</span> batch_size
        self<span class="token punctuation">.</span>learning_rate <span class="token operator">=</span> learning_rate
        self<span class="token punctuation">.</span>epoch <span class="token operator">=</span> epoch
        self<span class="token punctuation">.</span>train_loader<span class="token punctuation">,</span> self<span class="token punctuation">.</span>dev_loader<span class="token punctuation">,</span> self<span class="token punctuation">.</span>test_loader <span class="token operator">=</span> self<span class="token punctuation">.</span>load_tdt<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>input_col<span class="token punctuation">,</span> self<span class="token punctuation">.</span>output_class <span class="token operator">=</span> self<span class="token punctuation">.</span>get_class<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 加载train, dev, test，把数据封装成Dataloader类</span>
    <span class="token keyword">def</span> <span class="token function">load_tdt</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">file</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>read_file<span class="token punctuation">(</span><span class="token punctuation">)</span>
        train_dev_test <span class="token operator">=</span> self<span class="token punctuation">.</span>cut_data<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">)</span>
        tdt_loader <span class="token operator">=</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>load_data<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> train_dev_test<span class="token punctuation">]</span>
        <span class="token keyword">return</span> tdt_loader<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tdt_loader<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tdt_loader<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>

    <span class="token comment"># 读文件</span>
    <span class="token keyword">def</span> <span class="token function">read_file</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">file</span> <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_path<span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">"utf-8-sig"</span><span class="token punctuation">,</span> index_col<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>
        <span class="token comment"># 保险起见，确认最后一列列名为label</span>
        <span class="token builtin">file</span><span class="token punctuation">.</span>columns<span class="token punctuation">.</span>values<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"label"</span>
        self<span class="token punctuation">.</span>if_nan<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token builtin">file</span>

    <span class="token comment"># 切7:1:2 =&gt; 训练:验证:测试</span>
    <span class="token keyword">def</span> <span class="token function">cut_data</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data_df<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            train_df<span class="token punctuation">,</span> test_dev_df <span class="token operator">=</span> train_test_split<span class="token punctuation">(</span>data_df<span class="token punctuation">,</span> test_size<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">1129</span><span class="token punctuation">,</span> stratify<span class="token operator">=</span>data_df<span class="token punctuation">[</span><span class="token string">"label"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            dev_df<span class="token punctuation">,</span> test_df <span class="token operator">=</span> train_test_split<span class="token punctuation">(</span>test_dev_df<span class="token punctuation">,</span> test_size<span class="token operator">=</span><span class="token number">0.66</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">1129</span><span class="token punctuation">,</span> stratify<span class="token operator">=</span>test_dev_df<span class="token punctuation">[</span><span class="token string">"label"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> ValueError<span class="token punctuation">:</span>
            train_df<span class="token punctuation">,</span> test_dev_df <span class="token operator">=</span> train_test_split<span class="token punctuation">(</span>data_df<span class="token punctuation">,</span> test_size<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">1129</span><span class="token punctuation">)</span>
            dev_df<span class="token punctuation">,</span> test_df <span class="token operator">=</span> train_test_split<span class="token punctuation">(</span>test_dev_df<span class="token punctuation">,</span> test_size<span class="token operator">=</span><span class="token number">0.66</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">1129</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>train_df<span class="token punctuation">,</span> dev_df<span class="token punctuation">,</span> test_df<span class="token punctuation">]</span>

    <span class="token comment"># Dataloader 封装进去</span>
    <span class="token keyword">def</span> <span class="token function">load_data</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data_df<span class="token punctuation">)</span><span class="token punctuation">:</span>
        dataset <span class="token operator">=</span> Dataset<span class="token punctuation">(</span>data_df<span class="token punctuation">)</span>
        <span class="token keyword">return</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>dataset<span class="token punctuation">,</span> batch_size<span class="token operator">=</span>self<span class="token punctuation">.</span>batch_size<span class="token punctuation">)</span>

    <span class="token comment"># 检验输入输出是否有空值</span>
    <span class="token keyword">def</span> <span class="token function">if_nan</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> data<span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            empty <span class="token operator">=</span> data<span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">any</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>empty<span class="token punctuation">[</span>empty<span class="token punctuation">]</span><span class="token punctuation">.</span>index<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Empty data exists"</span><span class="token punctuation">)</span>
            sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token comment"># 后面输出混淆矩阵用的</span>
    <span class="token keyword">def</span> <span class="token function">get_class</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">file</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>read_file<span class="token punctuation">(</span><span class="token punctuation">)</span>
        label <span class="token operator">=</span> <span class="token builtin">file</span><span class="token punctuation">[</span><span class="token builtin">file</span><span class="token punctuation">.</span>columns<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
        label <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>label<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token builtin">file</span><span class="token punctuation">.</span>columns<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> label


<span class="token comment"># 跑clf用的，里面包含了训练，测试，评价等等的代码</span>
<span class="token keyword">class</span> <span class="token class-name">CLF_Model</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> model<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>model <span class="token operator">=</span> model
        self<span class="token punctuation">.</span>config <span class="token operator">=</span> config

    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>train<span class="token punctuation">(</span>self<span class="token punctuation">.</span>model<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> model<span class="token punctuation">)</span><span class="token punctuation">:</span>
        dev_best_loss <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">'inf'</span><span class="token punctuation">)</span>
        start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 模型为训练模式</span>
        model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 定义优化器</span>
        optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span>self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>learning_rate<span class="token punctuation">)</span>
        <span class="token comment"># 记录训练、验证的准确率和损失</span>
        acc_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
        loss_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
        <span class="token comment"># 记录损失不下降的epoch数，到达20之后就直接退出 =&gt; 训练无效，再训练下去可能过拟合</span>
        break_epoch <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>epoch<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Epoch [{}/{}]'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>epoch<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> index<span class="token punctuation">,</span> <span class="token punctuation">(</span>trains<span class="token punctuation">,</span> labels<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>train_loader<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token comment"># 归零</span>
                model<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment"># 得到预测结果，是一堆概率</span>
                outputs <span class="token operator">=</span> model<span class="token punctuation">(</span>trains<span class="token punctuation">)</span>
                <span class="token comment"># 交叉熵计算要long的类型</span>
                labels <span class="token operator">=</span> labels<span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment"># 计算交叉熵损失</span>
                loss <span class="token operator">=</span> F<span class="token punctuation">.</span>cross_entropy<span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> labels<span class="token punctuation">)</span>
                <span class="token comment"># 反向传播loss</span>
                loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment"># 优化参数</span>
                optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment"># 每100个迭代或者跑完一个epoch后，验证一下</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">%</span> <span class="token number">100</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">and</span> index <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">or</span> index <span class="token operator">==</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>train_loader<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">:</span>
                    true <span class="token operator">=</span> labels<span class="token punctuation">.</span>data<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token comment"># 预测类别</span>
                    predict <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>outputs<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token comment"># 计算训练准确率</span>
                    train_acc <span class="token operator">=</span> metrics<span class="token punctuation">.</span>accuracy_score<span class="token punctuation">(</span>true<span class="token punctuation">,</span> predict<span class="token punctuation">)</span>
                    <span class="token comment"># 计算验证准确率和loss</span>
                    dev_acc<span class="token punctuation">,</span> dev_loss <span class="token operator">=</span> self<span class="token punctuation">.</span>evaluate<span class="token punctuation">(</span>model<span class="token punctuation">)</span>
                    <span class="token comment"># 查看验证loss是不是进步了</span>
                    <span class="token keyword">if</span> dev_loss <span class="token operator">&lt;</span> dev_best_loss<span class="token punctuation">:</span>
                        dev_best_loss <span class="token operator">=</span> dev_loss
                        improve <span class="token operator">=</span> <span class="token string">'*'</span>
                        break_epoch <span class="token operator">=</span> <span class="token number">0</span>
                    <span class="token keyword">else</span><span class="token punctuation">:</span>
                        improve <span class="token operator">=</span> <span class="token string">''</span>
                        break_epoch <span class="token operator">+=</span> <span class="token number">1</span>
                    time_dif <span class="token operator">=</span> self<span class="token punctuation">.</span>get_time_dif<span class="token punctuation">(</span>start_time<span class="token punctuation">)</span>
                    <span class="token comment"># 输出阶段性结果</span>
                    msg <span class="token operator">=</span> <span class="token string">'Iter: {0:&gt;6},  Train Loss: {1:&gt;5.3},  Train Acc: {2:&gt;6.3%},  Val Loss: {3:&gt;5.3},  Val Acc: {4:&gt;6.3%},  Time: {5} {6}'</span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> train_acc<span class="token punctuation">,</span> dev_loss<span class="token punctuation">,</span> dev_acc<span class="token punctuation">,</span> time_dif<span class="token punctuation">,</span> improve<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token comment"># 为了画图准备的，记录每个epoch的结果</span>
                    <span class="token keyword">if</span> index <span class="token operator">==</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>train_loader<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">:</span>
                        acc_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>train_acc<span class="token punctuation">)</span>
                        acc_list<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>dev_acc<span class="token punctuation">)</span>
                        loss_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        loss_list<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>dev_loss<span class="token punctuation">)</span>
                    <span class="token comment"># 验证集评估时模型编程验证模式了，现在变回训练模式</span>
                    model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment"># 20个epoch损失不变，直接退出训练</span>
            <span class="token keyword">if</span> break_epoch <span class="token operator">&gt;</span> <span class="token number">20</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>epoch <span class="token operator">=</span> epoch<span class="token operator">+</span><span class="token number">1</span>
                <span class="token keyword">break</span>
        <span class="token comment"># 测试</span>
        self<span class="token punctuation">.</span>test<span class="token punctuation">(</span>model<span class="token punctuation">)</span>
        <span class="token comment"># 画图</span>
        self<span class="token punctuation">.</span>draw_curve<span class="token punctuation">(</span>acc_list<span class="token punctuation">,</span> loss_list<span class="token punctuation">,</span> self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>epoch<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> model<span class="token punctuation">)</span><span class="token punctuation">:</span>
        start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 测试准确率，测试损失，测试分类报告，测试混淆矩阵</span>
        test_acc<span class="token punctuation">,</span> test_loss<span class="token punctuation">,</span> test_report<span class="token punctuation">,</span> test_confusion <span class="token operator">=</span> self<span class="token punctuation">.</span>evaluate<span class="token punctuation">(</span>model<span class="token punctuation">,</span> test<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        msg <span class="token operator">=</span> <span class="token string">'Test Loss: {0:&gt;5.3},  Test Acc: {1:&gt;6.3%}'</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>test_loss<span class="token punctuation">,</span> test_acc<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Precision, Recall and F1-Score..."</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>test_report<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Confusion Matrix..."</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>test_confusion<span class="token punctuation">)</span>
        time_dif <span class="token operator">=</span> self<span class="token punctuation">.</span>get_time_dif<span class="token punctuation">(</span>start_time<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Time usage:"</span><span class="token punctuation">,</span> time_dif<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">evaluate</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> model<span class="token punctuation">,</span> test<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 模型模式变一下</span>
        model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        loss_total <span class="token operator">=</span> <span class="token number">0</span>
        predict_all <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">)</span>
        labels_all <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">)</span>
        <span class="token comment"># 如果是测试模式（这一段写的不是很好）</span>
        <span class="token keyword">if</span> test<span class="token punctuation">:</span>
            <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>dev<span class="token punctuation">,</span> labels<span class="token punctuation">)</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>test_loader<span class="token punctuation">:</span>
                    outputs <span class="token operator">=</span> model<span class="token punctuation">(</span>dev<span class="token punctuation">)</span>
                    labels <span class="token operator">=</span> labels<span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    loss <span class="token operator">=</span> F<span class="token punctuation">.</span>cross_entropy<span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> labels<span class="token punctuation">)</span>
                    loss_total <span class="token operator">+=</span> loss
                    labels <span class="token operator">=</span> labels<span class="token punctuation">.</span>data<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    predict <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>outputs<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    labels_all <span class="token operator">=</span> np<span class="token punctuation">.</span>append<span class="token punctuation">(</span>labels_all<span class="token punctuation">,</span> labels<span class="token punctuation">)</span>
                    predict_all <span class="token operator">=</span> np<span class="token punctuation">.</span>append<span class="token punctuation">(</span>predict_all<span class="token punctuation">,</span> predict<span class="token punctuation">)</span>
            acc <span class="token operator">=</span> metrics<span class="token punctuation">.</span>accuracy_score<span class="token punctuation">(</span>labels_all<span class="token punctuation">,</span> predict_all<span class="token punctuation">)</span>
            report <span class="token operator">=</span> metrics<span class="token punctuation">.</span>classification_report<span class="token punctuation">(</span>labels_all<span class="token punctuation">,</span> predict_all<span class="token punctuation">,</span> target_names<span class="token operator">=</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>get_class<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> digits<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>
            confusion <span class="token operator">=</span> metrics<span class="token punctuation">.</span>confusion_matrix<span class="token punctuation">(</span>labels_all<span class="token punctuation">,</span> predict_all<span class="token punctuation">)</span>
            <span class="token keyword">return</span> acc<span class="token punctuation">,</span> loss_total <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>dev_loader<span class="token punctuation">)</span><span class="token punctuation">,</span> report<span class="token punctuation">,</span> confusion
        <span class="token comment"># 不是测试模式</span>
        <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>dev<span class="token punctuation">,</span> labels<span class="token punctuation">)</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>dev_loader<span class="token punctuation">:</span>
                outputs <span class="token operator">=</span> model<span class="token punctuation">(</span>dev<span class="token punctuation">)</span>
                labels <span class="token operator">=</span> labels<span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                loss <span class="token operator">=</span> F<span class="token punctuation">.</span>cross_entropy<span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> labels<span class="token punctuation">)</span>
                loss_total <span class="token operator">+=</span> loss
                labels <span class="token operator">=</span> labels<span class="token punctuation">.</span>data<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
                predict <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>outputs<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
                labels_all <span class="token operator">=</span> np<span class="token punctuation">.</span>append<span class="token punctuation">(</span>labels_all<span class="token punctuation">,</span> labels<span class="token punctuation">)</span>
                predict_all <span class="token operator">=</span> np<span class="token punctuation">.</span>append<span class="token punctuation">(</span>predict_all<span class="token punctuation">,</span> predict<span class="token punctuation">)</span>
        acc <span class="token operator">=</span> metrics<span class="token punctuation">.</span>accuracy_score<span class="token punctuation">(</span>labels_all<span class="token punctuation">,</span> predict_all<span class="token punctuation">)</span>
        <span class="token keyword">return</span> acc<span class="token punctuation">,</span> loss_total <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>dev_loader<span class="token punctuation">)</span>
    
    <span class="token comment"># 算时间损耗</span>
    <span class="token keyword">def</span> <span class="token function">get_time_dif</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> start_time<span class="token punctuation">)</span><span class="token punctuation">:</span>
        end_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        time_dif <span class="token operator">=</span> end_time <span class="token operator">-</span> start_time
        <span class="token keyword">return</span> timedelta<span class="token punctuation">(</span>seconds<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>time_dif<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># 画图</span>
    <span class="token keyword">def</span> <span class="token function">draw_curve</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> acc_list<span class="token punctuation">,</span> loss_list<span class="token punctuation">,</span> epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> epochs<span class="token punctuation">)</span>
        y1 <span class="token operator">=</span> loss_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        y2 <span class="token operator">=</span> loss_list<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        y3 <span class="token operator">=</span> acc_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        y4 <span class="token operator">=</span> acc_list<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">"blue"</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"train_loss"</span><span class="token punctuation">,</span> linewidth<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y2<span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">"orange"</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"val_loss"</span><span class="token punctuation">,</span> linewidth<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"Loss_curve"</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span>xlabel<span class="token operator">=</span><span class="token string">"Epochs"</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span>ylabel<span class="token operator">=</span><span class="token string">"Loss"</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y3<span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">"blue"</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"train_acc"</span><span class="token punctuation">,</span> linewidth<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y4<span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">"orange"</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"val_acc"</span><span class="token punctuation">,</span> linewidth<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"Acc_curve"</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span>xlabel<span class="token operator">=</span><span class="token string">"Epochs"</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span>ylabel<span class="token operator">=</span><span class="token string">"Accuracy"</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>savefig<span class="token punctuation">(</span><span class="token string">"images/"</span><span class="token operator">+</span>self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>name<span class="token operator">+</span><span class="token string">"_Loss&amp;acc.png"</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="13__428"></a>1.3 结果</h3> 
<p>训练ing……</p> 
<p><img src="https://images2.imgbox.com/64/51/Zj9Mghov_o.png" alt="在这里插入图片描述"></p> 
<p>第三类的精确率感人，不过其他分类效果挺好的。感觉是数据集的问题，悄悄拿sklearn试了一下，就差1%。</p> 
<p><img src="https://images2.imgbox.com/df/09/vr5tveTA_o.png" alt="在这里插入图片描述"></p> 
<p>曲线如下（感觉不是正常的曲线，主要是数据集的问题，70%的数据区分度很大，剩下的很难辨认）</p> 
<p><img src="https://images2.imgbox.com/3b/5e/66UWFbn8_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="2__441"></a>2 回归</h2> 
<h3><a id="20__442"></a>2.0 数据集</h3> 
<p>用的2023美赛春季赛Y题数据，在原有的数据集上加了很多船的参数，再把两个 dataset 合一起。</p> 
<p>预处理的操作简单暴力，重复值的行删掉，部分含空值多的行删掉，方便填充的随机森林下，不方便填充的直接暴力填0。</p> 
<p>平时肯定是不能这么干的，但是这里我们只是需要一个数据集而已，重点还是模型。</p> 
<p>data.csv（2793x39）=&gt; 已经包括 label 了</p> 
<p><img src="https://images2.imgbox.com/06/88/wHLt2qlj_o.png" alt="在这里插入图片描述"></p> 
<p>label.csv（2793x1）</p> 
<p><img src="https://images2.imgbox.com/2b/d3/AbLheNPz_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="21__458"></a>2.1 网络架构</h3> 
<p>torch 输出的架构如下</p> 
<p><img src="https://images2.imgbox.com/73/70/wNtub1ss_o.png" alt="在这里插入图片描述"></p> 
<p>一共是4层隐藏层（512-&gt;128-&gt;32-&gt;8）</p> 
<p>也尝试过 10-&gt;10-&gt;10 和一些大的复杂的多层感知机，效果都一般。</p> 
<h3><a id="22__468"></a>2.2 代码</h3> 
<p>回归任务的相关文件如下</p> 
<p><img src="https://images2.imgbox.com/4d/32/S8hBZVzm_o.png" alt="在这里插入图片描述"></p> 
<pre><code>data.csv			回归数据集
MLP_reg.py		回归模型架构
run.py				主函数
utils.py				相关函数和类
</code></pre> 
<p><code>run.py</code></p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> numpy
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> random
<span class="token keyword">from</span> utils <span class="token keyword">import</span> Config<span class="token punctuation">,</span> CLF_Model<span class="token punctuation">,</span> REG_Model
<span class="token keyword">from</span> clf_model<span class="token punctuation">.</span>MLP_clf <span class="token keyword">import</span> MLP


seed <span class="token operator">=</span> <span class="token number">1129</span>
random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span>seed<span class="token punctuation">)</span>
numpy<span class="token punctuation">.</span>random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span>seed<span class="token punctuation">)</span>
torch<span class="token punctuation">.</span>manual_seed<span class="token punctuation">(</span>seed<span class="token punctuation">)</span>
torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>manual_seed<span class="token punctuation">(</span>seed<span class="token punctuation">)</span>
torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>manual_seed_all<span class="token punctuation">(</span>seed<span class="token punctuation">)</span>
torch<span class="token punctuation">.</span>backends<span class="token punctuation">.</span>cudnn<span class="token punctuation">.</span>deterministic <span class="token operator">=</span> <span class="token boolean">True</span>
torch<span class="token punctuation">.</span>backends<span class="token punctuation">.</span>cudnn<span class="token punctuation">.</span>benchmark <span class="token operator">=</span> <span class="token boolean">False</span>
os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">'PYTHONHASHSEED'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>seed<span class="token punctuation">)</span>



<span class="token keyword">from</span> reg_model<span class="token punctuation">.</span>MLP_reg <span class="token keyword">import</span> MLP
<span class="token comment"># 回归</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    config <span class="token operator">=</span> Config<span class="token punctuation">(</span>
        data_path<span class="token operator">=</span><span class="token string">"dataset_reg/data.csv"</span><span class="token punctuation">,</span>
        name<span class="token operator">=</span><span class="token string">"MLP"</span><span class="token punctuation">,</span>
        batch_size<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span>
        learning_rate<span class="token operator">=</span><span class="token number">0.015</span><span class="token punctuation">,</span>
        epoch<span class="token operator">=</span><span class="token number">200</span>
    <span class="token punctuation">)</span>
    <span class="token comment"># 看是几输出问题</span>
    reg <span class="token operator">=</span> MLP<span class="token punctuation">(</span>
        input_n<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>input_col<span class="token punctuation">)</span><span class="token punctuation">,</span>
        output_n<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
        num_layer<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span>
        layer_list<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        dropout<span class="token operator">=</span><span class="token number">0.5</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>reg<span class="token punctuation">)</span>
    model <span class="token operator">=</span> REG_Model<span class="token punctuation">(</span>reg<span class="token punctuation">,</span> config<span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><code>utils.py</code></p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> sys

<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional <span class="token keyword">as</span> F
<span class="token keyword">from</span> matplotlib <span class="token keyword">import</span> pyplot <span class="token keyword">as</span> plt
<span class="token keyword">from</span> sklearn <span class="token keyword">import</span> metrics
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>metrics <span class="token keyword">import</span> mean_squared_error<span class="token punctuation">,</span> r2_score
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword">import</span> train_test_split
<span class="token keyword">import</span> time
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> timedelta


<span class="token comment"># 一个数据格式。感觉这玩意好多余啊，但是nlp写多了就很习惯的写了一个上去 =&gt; 主要是不写没法封装</span>
<span class="token keyword">class</span> <span class="token class-name">Dataset</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>Dataset<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data_df<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>label <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>data_df<span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>data <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>data_df<span class="token punctuation">[</span>data_df<span class="token punctuation">.</span>columns<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>

    <span class="token comment"># 每次迭代取出对应的data和author</span>
    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
        batch_data <span class="token operator">=</span> self<span class="token punctuation">.</span>get_batch_data<span class="token punctuation">(</span>idx<span class="token punctuation">)</span>
        batch_label <span class="token operator">=</span> self<span class="token punctuation">.</span>get_batch_label<span class="token punctuation">(</span>idx<span class="token punctuation">)</span>
        <span class="token keyword">return</span> batch_data<span class="token punctuation">,</span> batch_label

    <span class="token comment"># 下面的几条没啥用其实，就是为__getitem__服务的</span>
    <span class="token keyword">def</span> <span class="token function">classes</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>label

    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>data<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">get_batch_label</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>self<span class="token punctuation">.</span>label<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">get_batch_data</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>data<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>


<span class="token comment"># 存数据，加载数据用的</span>
<span class="token keyword">class</span> <span class="token class-name">Config</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data_path<span class="token punctuation">,</span> name<span class="token punctuation">,</span> batch_size<span class="token punctuation">,</span> learning_rate<span class="token punctuation">,</span> epoch<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        :param data_path: string 数据文件路径
        :param name: string 模型名字
        :param batch_size: int 多少条数据组成一个batch
        :param learning_rate: float 学习率
        :param epoch: int 学几轮
        """</span>
        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name
        self<span class="token punctuation">.</span>data_path <span class="token operator">=</span> data_path
        self<span class="token punctuation">.</span>batch_size <span class="token operator">=</span> batch_size
        self<span class="token punctuation">.</span>learning_rate <span class="token operator">=</span> learning_rate
        self<span class="token punctuation">.</span>epoch <span class="token operator">=</span> epoch
        self<span class="token punctuation">.</span>train_loader<span class="token punctuation">,</span> self<span class="token punctuation">.</span>dev_loader<span class="token punctuation">,</span> self<span class="token punctuation">.</span>test_loader <span class="token operator">=</span> self<span class="token punctuation">.</span>load_tdt<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>input_col<span class="token punctuation">,</span> self<span class="token punctuation">.</span>output_class <span class="token operator">=</span> self<span class="token punctuation">.</span>get_class<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 加载train, dev, test，把数据封装成Dataloader类</span>
    <span class="token keyword">def</span> <span class="token function">load_tdt</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">file</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>read_file<span class="token punctuation">(</span><span class="token punctuation">)</span>
        train_dev_test <span class="token operator">=</span> self<span class="token punctuation">.</span>cut_data<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">)</span>
        tdt_loader <span class="token operator">=</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>load_data<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> train_dev_test<span class="token punctuation">]</span>
        <span class="token keyword">return</span> tdt_loader<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tdt_loader<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tdt_loader<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>

    <span class="token comment"># 读文件</span>
    <span class="token keyword">def</span> <span class="token function">read_file</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">file</span> <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_path<span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">"utf-8-sig"</span><span class="token punctuation">,</span> index_col<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>
        <span class="token comment"># 保险起见，确认最后一列列名为label</span>
        <span class="token builtin">file</span><span class="token punctuation">.</span>columns<span class="token punctuation">.</span>values<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"label"</span>
        self<span class="token punctuation">.</span>if_nan<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token builtin">file</span>

    <span class="token comment"># 切7:1:2 =&gt; 训练:验证:测试</span>
    <span class="token keyword">def</span> <span class="token function">cut_data</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data_df<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            train_df<span class="token punctuation">,</span> test_dev_df <span class="token operator">=</span> train_test_split<span class="token punctuation">(</span>data_df<span class="token punctuation">,</span> test_size<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">1129</span><span class="token punctuation">,</span> stratify<span class="token operator">=</span>data_df<span class="token punctuation">[</span><span class="token string">"label"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            dev_df<span class="token punctuation">,</span> test_df <span class="token operator">=</span> train_test_split<span class="token punctuation">(</span>test_dev_df<span class="token punctuation">,</span> test_size<span class="token operator">=</span><span class="token number">0.66</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">1129</span><span class="token punctuation">,</span> stratify<span class="token operator">=</span>test_dev_df<span class="token punctuation">[</span><span class="token string">"label"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> ValueError<span class="token punctuation">:</span>
            train_df<span class="token punctuation">,</span> test_dev_df <span class="token operator">=</span> train_test_split<span class="token punctuation">(</span>data_df<span class="token punctuation">,</span> test_size<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">1129</span><span class="token punctuation">)</span>
            dev_df<span class="token punctuation">,</span> test_df <span class="token operator">=</span> train_test_split<span class="token punctuation">(</span>test_dev_df<span class="token punctuation">,</span> test_size<span class="token operator">=</span><span class="token number">0.66</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">1129</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>train_df<span class="token punctuation">,</span> dev_df<span class="token punctuation">,</span> test_df<span class="token punctuation">]</span>

    <span class="token comment"># Dataloader 封装进去</span>
    <span class="token keyword">def</span> <span class="token function">load_data</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data_df<span class="token punctuation">)</span><span class="token punctuation">:</span>
        dataset <span class="token operator">=</span> Dataset<span class="token punctuation">(</span>data_df<span class="token punctuation">)</span>
        <span class="token keyword">return</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>dataset<span class="token punctuation">,</span> batch_size<span class="token operator">=</span>self<span class="token punctuation">.</span>batch_size<span class="token punctuation">)</span>

    <span class="token comment"># 检验输入输出是否有空值</span>
    <span class="token keyword">def</span> <span class="token function">if_nan</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> data<span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            empty <span class="token operator">=</span> data<span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">any</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>empty<span class="token punctuation">[</span>empty<span class="token punctuation">]</span><span class="token punctuation">.</span>index<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Empty data exists"</span><span class="token punctuation">)</span>
            sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token comment"># 后面输出混淆矩阵用的</span>
    <span class="token keyword">def</span> <span class="token function">get_class</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">file</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>read_file<span class="token punctuation">(</span><span class="token punctuation">)</span>
        label <span class="token operator">=</span> <span class="token builtin">file</span><span class="token punctuation">[</span><span class="token builtin">file</span><span class="token punctuation">.</span>columns<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
        label <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>label<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token builtin">file</span><span class="token punctuation">.</span>columns<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> label



<span class="token comment"># 跑reg用的，里面包含了训练，测试，评价等等的代码</span>
<span class="token keyword">class</span> <span class="token class-name">REG_Model</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> model<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>model <span class="token operator">=</span> model
        self<span class="token punctuation">.</span>config <span class="token operator">=</span> config

    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>train<span class="token punctuation">(</span>self<span class="token punctuation">.</span>model<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> model<span class="token punctuation">)</span><span class="token punctuation">:</span>
        dev_best_loss <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">'inf'</span><span class="token punctuation">)</span>
        start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 模型为训练模式</span>
        model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 定义优化器</span>
        optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span>self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>learning_rate<span class="token punctuation">)</span>
        acc_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
        loss_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
        <span class="token comment"># 记录损失不下降的epoch数，到达20之后就直接退出 =&gt; 训练无效，再训练下去可能过拟合</span>
        break_epoch <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>epoch<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Epoch [{}/{}]'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>epoch<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> index<span class="token punctuation">,</span> <span class="token punctuation">(</span>trains<span class="token punctuation">,</span> labels<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>train_loader<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token comment"># 归零</span>
                model<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment"># 得到预测结果</span>
                outputs <span class="token operator">=</span> model<span class="token punctuation">(</span>trains<span class="token punctuation">)</span>
                <span class="token comment"># MSE计算要float的类型</span>
                labels <span class="token operator">=</span> labels<span class="token punctuation">.</span>to<span class="token punctuation">(</span>torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span>
                <span class="token comment"># 计算MSE损失</span>
                loss <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>MSELoss<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> labels<span class="token punctuation">)</span>
                <span class="token comment"># 反向传播loss</span>
                loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment"># 优化参数</span>
                optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment"># 每100个迭代或者跑完一个epoch后，验证一下</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">%</span> <span class="token number">100</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">and</span> index <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">or</span> index <span class="token operator">==</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>train_loader<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">:</span>
                    true <span class="token operator">=</span> labels<span class="token punctuation">.</span>data<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token comment"># 预测数据</span>
                    predict <span class="token operator">=</span> outputs<span class="token punctuation">.</span>data<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token comment"># 计算训练准确度 R2</span>
                    train_acc <span class="token operator">=</span> r2_score<span class="token punctuation">(</span>true<span class="token punctuation">,</span> predict<span class="token punctuation">)</span>
                    <span class="token comment"># 计算验证准确度 R2 和 loss</span>
                    dev_acc<span class="token punctuation">,</span> dev_loss<span class="token punctuation">,</span> dev_mse <span class="token operator">=</span> self<span class="token punctuation">.</span>evaluate<span class="token punctuation">(</span>model<span class="token punctuation">)</span>
                    <span class="token comment"># 查看验证loss是不是进步了</span>
                    <span class="token keyword">if</span> dev_loss <span class="token operator">&lt;</span> dev_best_loss<span class="token punctuation">:</span>
                        dev_best_loss <span class="token operator">=</span> dev_loss
                        improve <span class="token operator">=</span> <span class="token string">'*'</span>
                        break_epoch <span class="token operator">=</span> <span class="token number">0</span>
                    <span class="token keyword">else</span><span class="token punctuation">:</span>
                        improve <span class="token operator">=</span> <span class="token string">''</span>
                        break_epoch <span class="token operator">+=</span> <span class="token number">1</span>
                    time_dif <span class="token operator">=</span> self<span class="token punctuation">.</span>get_time_dif<span class="token punctuation">(</span>start_time<span class="token punctuation">)</span>
                    <span class="token comment"># 输出阶段性结果</span>
                    msg <span class="token operator">=</span> <span class="token string">'Iter: {0:&gt;6},  Train Loss: {1:&gt;5.3},  Train R2: {2:&gt;6.3},  Val Loss: {3:&gt;5.3},  Val R2: {4:&gt;6.3},  Val Mse: {5:&gt;6.3},  Time: {6} {7}'</span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> train_acc<span class="token punctuation">,</span> dev_loss<span class="token punctuation">,</span> dev_acc<span class="token punctuation">,</span> dev_mse<span class="token punctuation">,</span> time_dif<span class="token punctuation">,</span> improve<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token comment"># 为了画图准备的，记录每个epoch的结果</span>
                    <span class="token keyword">if</span> index <span class="token operator">==</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>train_loader<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">:</span>
                        acc_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>train_acc<span class="token punctuation">)</span>
                        acc_list<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>dev_acc<span class="token punctuation">)</span>
                        loss_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        loss_list<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>dev_loss<span class="token punctuation">)</span>
                    <span class="token comment"># 验证集评估时模型编程验证模式了，现在变回训练模式</span>
                    model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment"># 20个epoch损失不变，直接退出训练</span>
            <span class="token keyword">if</span> break_epoch <span class="token operator">&gt;</span> <span class="token number">20</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>epoch <span class="token operator">=</span> epoch<span class="token operator">+</span><span class="token number">1</span>
                <span class="token keyword">break</span>
        <span class="token comment"># 测试</span>
        self<span class="token punctuation">.</span>test<span class="token punctuation">(</span>model<span class="token punctuation">)</span>
        <span class="token comment"># 画图</span>
        self<span class="token punctuation">.</span>draw_curve<span class="token punctuation">(</span>acc_list<span class="token punctuation">,</span> loss_list<span class="token punctuation">,</span> self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>epoch<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> model<span class="token punctuation">)</span><span class="token punctuation">:</span>
        start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 测试准确度 R2，测试损失，测试MSE</span>
        test_acc<span class="token punctuation">,</span> test_loss<span class="token punctuation">,</span> mse <span class="token operator">=</span> self<span class="token punctuation">.</span>evaluate<span class="token punctuation">(</span>model<span class="token punctuation">,</span> test<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        msg <span class="token operator">=</span> <span class="token string">'Test R2: {0:&gt;5.3},  Test loss: {1:&gt;6.3},  Test MSE: {2:&gt;6.3}'</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>test_acc<span class="token punctuation">,</span> test_loss<span class="token punctuation">,</span> mse<span class="token punctuation">)</span><span class="token punctuation">)</span>
        time_dif <span class="token operator">=</span> self<span class="token punctuation">.</span>get_time_dif<span class="token punctuation">(</span>start_time<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Time usage:"</span><span class="token punctuation">,</span> time_dif<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">evaluate</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> model<span class="token punctuation">,</span> test<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 模型模式变一下</span>
        model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        loss_total <span class="token operator">=</span> <span class="token number">0</span>
        predict_all <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">)</span>
        labels_all <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">)</span>
        <span class="token comment"># 如果是测试模式（这一段写的不是很好）</span>
        <span class="token keyword">if</span> test<span class="token punctuation">:</span>
            <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>dev<span class="token punctuation">,</span> labels<span class="token punctuation">)</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>test_loader<span class="token punctuation">:</span>
                    outputs <span class="token operator">=</span> model<span class="token punctuation">(</span>dev<span class="token punctuation">)</span>
                    labels <span class="token operator">=</span> labels<span class="token punctuation">.</span>to<span class="token punctuation">(</span>torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span>
                    loss <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>MSELoss<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> labels<span class="token punctuation">)</span>
                    loss_total <span class="token operator">+=</span> loss
                    labels <span class="token operator">=</span> labels<span class="token punctuation">.</span>data<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    predict <span class="token operator">=</span> outputs<span class="token punctuation">.</span>data<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    labels_all <span class="token operator">=</span> np<span class="token punctuation">.</span>append<span class="token punctuation">(</span>labels_all<span class="token punctuation">,</span> labels<span class="token punctuation">)</span>
                    predict_all <span class="token operator">=</span> np<span class="token punctuation">.</span>append<span class="token punctuation">(</span>predict_all<span class="token punctuation">,</span> predict<span class="token punctuation">)</span>
        <span class="token comment"># 不是测试模式</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>dev<span class="token punctuation">,</span> labels<span class="token punctuation">)</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>dev_loader<span class="token punctuation">:</span>
                    outputs <span class="token operator">=</span> model<span class="token punctuation">(</span>dev<span class="token punctuation">)</span>
                    labels <span class="token operator">=</span> labels<span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    loss <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>MSELoss<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> labels<span class="token punctuation">)</span>
                    loss_total <span class="token operator">+=</span> loss
                    labels <span class="token operator">=</span> labels<span class="token punctuation">.</span>data<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    predict <span class="token operator">=</span> outputs<span class="token punctuation">.</span>data<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    labels_all <span class="token operator">=</span> np<span class="token punctuation">.</span>append<span class="token punctuation">(</span>labels_all<span class="token punctuation">,</span> labels<span class="token punctuation">)</span>
                    predict_all <span class="token operator">=</span> np<span class="token punctuation">.</span>append<span class="token punctuation">(</span>predict_all<span class="token punctuation">,</span> predict<span class="token punctuation">)</span>
        r2 <span class="token operator">=</span> r2_score<span class="token punctuation">(</span>labels_all<span class="token punctuation">,</span> predict_all<span class="token punctuation">)</span>
        mse <span class="token operator">=</span> mean_squared_error<span class="token punctuation">(</span>labels_all<span class="token punctuation">,</span> predict_all<span class="token punctuation">)</span>
        <span class="token keyword">if</span> test<span class="token punctuation">:</span>
            <span class="token keyword">return</span> r2<span class="token punctuation">,</span> loss_total <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>test_loader<span class="token punctuation">)</span><span class="token punctuation">,</span> mse
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> r2<span class="token punctuation">,</span> loss_total <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>dev_loader<span class="token punctuation">)</span><span class="token punctuation">,</span> mse

    <span class="token comment"># 算时间损耗</span>
    <span class="token keyword">def</span> <span class="token function">get_time_dif</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> start_time<span class="token punctuation">)</span><span class="token punctuation">:</span>
        end_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        time_dif <span class="token operator">=</span> end_time <span class="token operator">-</span> start_time
        <span class="token keyword">return</span> timedelta<span class="token punctuation">(</span>seconds<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>time_dif<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># 画图</span>
    <span class="token keyword">def</span> <span class="token function">draw_curve</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> acc_list<span class="token punctuation">,</span> loss_list<span class="token punctuation">,</span> epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> epochs<span class="token punctuation">)</span>
        y1 <span class="token operator">=</span> loss_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        y2 <span class="token operator">=</span> loss_list<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        y3 <span class="token operator">=</span> acc_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        y4 <span class="token operator">=</span> acc_list<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">"blue"</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"train_loss"</span><span class="token punctuation">,</span> linewidth<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y2<span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">"orange"</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"val_loss"</span><span class="token punctuation">,</span> linewidth<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"Loss_curve"</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span>xlabel<span class="token operator">=</span><span class="token string">"Epochs"</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span>ylabel<span class="token operator">=</span><span class="token string">"Loss"</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y3<span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">"blue"</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"train_acc"</span><span class="token punctuation">,</span> linewidth<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y4<span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">"orange"</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"val_acc"</span><span class="token punctuation">,</span> linewidth<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"Acc_curve"</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span>xlabel<span class="token operator">=</span><span class="token string">"Epochs"</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span>ylabel<span class="token operator">=</span><span class="token string">"Accuracy"</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>savefig<span class="token punctuation">(</span><span class="token string">"images/"</span><span class="token operator">+</span>self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>name<span class="token operator">+</span><span class="token string">"_Loss&amp;acc.png"</span><span class="token punctuation">)</span>
</code></pre> 
<p><code>MLP_reg.py </code></p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">import</span> Linear<span class="token punctuation">,</span> ReLU<span class="token punctuation">,</span> ModuleList<span class="token punctuation">,</span> Sequential<span class="token punctuation">,</span> Dropout<span class="token punctuation">,</span> Softmax<span class="token punctuation">,</span> Tanh
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional <span class="token keyword">as</span> F

<span class="token keyword">class</span> <span class="token class-name">MLP</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> input_n<span class="token punctuation">,</span> output_n<span class="token punctuation">,</span> num_layer<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> layer_list<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dropout<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>MLP<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>input_n <span class="token operator">=</span> input_n
        self<span class="token punctuation">.</span>output_n <span class="token operator">=</span> output_n
        self<span class="token punctuation">.</span>num_layer <span class="token operator">=</span> num_layer
        self<span class="token punctuation">.</span>layer_list <span class="token operator">=</span> layer_list

        self<span class="token punctuation">.</span>input_layer <span class="token operator">=</span> Sequential<span class="token punctuation">(</span>
            Linear<span class="token punctuation">(</span>input_n<span class="token punctuation">,</span> layer_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>hidden_layer <span class="token operator">=</span> Sequential<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">for</span> index <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_layer<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>hidden_layer<span class="token punctuation">.</span>extend<span class="token punctuation">(</span><span class="token punctuation">[</span>Linear<span class="token punctuation">(</span>layer_list<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">,</span> layer_list<span class="token punctuation">[</span>index<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>dropout <span class="token operator">=</span> Dropout<span class="token punctuation">(</span>dropout<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>output_layer <span class="token operator">=</span> Sequential<span class="token punctuation">(</span>
            Linear<span class="token punctuation">(</span>layer_list<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> output_n<span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment"># ReLU()</span>
            <span class="token comment"># Softmax(dim=1),</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">input</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>input_layer<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        hidden <span class="token operator">=</span> self<span class="token punctuation">.</span>hidden_layer<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">)</span>
        hidden <span class="token operator">=</span> self<span class="token punctuation">.</span>dropout<span class="token punctuation">(</span>hidden<span class="token punctuation">)</span>
        output <span class="token operator">=</span> self<span class="token punctuation">.</span>output_layer<span class="token punctuation">(</span>hidden<span class="token punctuation">)</span>
        output <span class="token operator">=</span> output<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> output
</code></pre> 
<h3><a id="23__822"></a>2.3 结果</h3> 
<p>训练ing……</p> 
<p><img src="https://images2.imgbox.com/e9/ed/4fiGSSnJ_o.png" alt="在这里插入图片描述"></p> 
<p>R2 有0.73。怎么说呢，还可以吧，不高不低。<br> 拿 sklearn 默认的 MLP 才-2.7400039908485083，SVR才-0.15191155233964238。</p> 
<p><img src="https://images2.imgbox.com/fe/ed/mhL2C6lt_o.png" alt="在这里插入图片描述"></p> 
<p>曲线如下（感觉不是正常的曲线，训练集太飘了=&gt; 也可能是epoch不到位）</p> 
<p><img src="https://images2.imgbox.com/75/03/g5cbeZoX_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="3__839"></a>3 代码（可直接食用）</h2> 
<p><a href="https://pan.baidu.com/s/1M3w9c1EH2NQI7h_L7Yeo_Q?pwd=jhnb" rel="nofollow">记得一键三连噢~~</a></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7147aa4fe984ee1fad5147ffd16dd059/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">linux部署tomcat项目详细教程（安装linux到部署tomcat）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c3ab421dc629b1f1993ec12a6ba60ea1/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">vue&#43;element 多选级联选择器自定义props</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>