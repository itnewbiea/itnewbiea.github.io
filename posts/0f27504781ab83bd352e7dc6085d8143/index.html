<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>在framework下新建系统api - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="在framework下新建系统api" />
<meta property="og:description" content="过程如下：
先在framework/base 下创建一目录叫venus
/venus 目录下有两个文件夹：
|-- java | `-- android`-- jni |-- Android.mk |-- jni.cppjava 下的类包遵循java 类包命名规则，好了，进入关键的第二步：
在文件build/core/pathmap.mk中的FRAMEWORKS_BASE_SUBDIRS变量里添加 venus\
OK,大功告成， 在Android 源码目录执行如下命令：
make update-api make make PRODUCT-sdk-sdk 新增的接口在源码环境和SDK环境中都有了，存放在 android.jar 里
------------------------------------------------------------------------------------
最近因项目需要，在frameworks\base\core\java\android\preference里面新添加了一个继承TwoStatePreference的类XXXSwitchPreference
经过查证后得知： Android SDK中有些JAVA类是开放的，有些是不开放的，API同样如此。这里所谓开放的类或API，只是javadoc的范畴，并不是java中public和private，也就是说，对于源码的编译无所谓，但是对android的上层应用有影响，因为非开放的类或API,android上层应用无法直接访问。
对于在原有的类中添加方法，google 给了两个解决方法： 1. 在你添加的API或者变量前面，增加 javadoc 注释＠hide。但是要注意的是，并不是简单写个＠hide 或者 /*@hide*/ 就可以了，这些都是错误的javadoc注释格式，标准的javadoc都是这样的 /** */ 而且对于 format 变量 应该加上 { }。应该写成 /** {@hide} */
2.想要在生成的javadoc里面出现这个方法或者变量，你必须执行:
make update-api 1 这样的话，系统自动将新增加的API添加到frameworks\base\api\current.txt中了，但是如果修改的是google没有开放出来的类，比如RIL，PhoneFactory，就不会出现这个问题。
而如果要加进新的类， 1、在原有的包下面加类，这个最简单，加完之后执行make update－api，在frameworks\base\api\current.txt中会自动增加一段代码
2、若加在framework/base下面，这时你make update－api是不会在frameworks\base\api\current.txt里生成你新增的API的。这时，需要修改android源码根目录下的build/core/pathmap.mk把你的目录加进去.（未经亲自验证） ------------------------------------------------------------------------------------
如何向Android的framework里添加新类
google对于所有的类和API，分为开放式和不开放式两种。所谓的开放式就是值javadoc所包含的，并不是java中有public和private，而是跟javadoc有关系，代码 没有关系。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/0f27504781ab83bd352e7dc6085d8143/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2017-10-11T09:36:20+08:00" />
<meta property="article:modified_time" content="2017-10-11T09:36:20+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">在framework下新建系统api</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p></p> 
<p style='margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; color:rgb(85,85,85); font-family:"microsoft yahei"; font-size:15px'> 过程如下：<br> 先在<span style="color:black; background-color:rgb(255,255,102)">framework</span>/base 下创建一目录叫venus<br> /venus 目录下有两个文件夹：</p> 
<div class="wp_syntax" style='color:rgb(85,85,85); font-family:"microsoft yahei"; font-size:15px'> 
 <div class="code"> 
  <pre class="sh" name="code" style="white-space: pre-wrap; word-wrap: break-word;"><span style="font-family: Simsun; font-size: 16px;"></span><pre class="sh" name="code" style="white-space: pre-wrap; word-wrap: break-word;">|-- java
|   `-- <span style="color: black; background-color: rgb(255, 153, 153);">android</span></pre><pre class="sh" name="code" style="white-space: pre-wrap; word-wrap: break-word;">`-- jni
    |-- <span style="color: black; background-color: rgb(255, 153, 153);">Android</span>.mk
    |-- jni.cpp</pre>
<pre></pre>
<pre></pre>
<pre></pre>
</pre> 
 </div> 
</div> 
<p style='margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; color:rgb(85,85,85); font-family:"microsoft yahei"; font-size:15px'> java 下的类包遵循java 类包命名规则，好了，进入关键的第二步：<br> <span width="100%" id="ad_content_h"></span><br> 在文件build/core/pathmap.mk中的FRAMEWORKS_BASE_SUBDIRS变量里添加 venus\</p> 
<p style='margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; color:rgb(85,85,85); font-family:"microsoft yahei"; font-size:15px'> OK,大功告成， 在<span style="color:black; background-color:rgb(255,153,153)">Android</span> <span class="wp_keywordlink_affiliate"><a target="_blank" title="查看 源码 的全部文章" href="http://newfaction.net/tag/%e6%ba%90%e7%a0%81" rel="nofollow noopener noreferrer" style="text-decoration:none; color:rgb(12,137,207)">源码</a></span>目录执行如下命令：</p> 
<div class="wp_syntax" style='color:rgb(85,85,85); font-family:"microsoft yahei"; font-size:15px'> 
 <div class="code"> 
  <pre class="sh" name="code" style="white-space: pre-wrap; word-wrap: break-word;">make update-api
make 
make PRODUCT-sdk-sdk</pre> 
 </div> 
</div> 
<p style='margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; color:rgb(85,85,85); font-family:"microsoft yahei"; font-size:15px'> 新增的接口在源码环境和SDK环境中都有了，存放在 <span class="wp_keywordlink_affiliate"><a target="_blank" title="查看 android 的全部文章" href="http://newfaction.net/tag/android-2" rel="nofollow noopener noreferrer" style="text-decoration:none; color:rgb(12,137,207)"><span style="color:black; background-color:rgb(255,153,153)">android</span></a></span>.jar 里</p> 
<br> 
<p></p> 
<p><span style='color:rgb(63,63,63); font-family:"microsoft yahei"; font-size:15px'>------------------------------------------------------------------------------------</span></p> 
<div> 
 <br> 
</div> 
<p><span style='color:rgb(63,63,63); font-family:"microsoft yahei"; font-size:15px'>最近因项目需要，在frameworks\base\core\java\android\preference里面新添加了一个继承TwoStatePreference的类XXXSwitchPreference</span><br> </p> 
<p><span style='color:rgb(63,63,63); font-family:"microsoft yahei"; font-size:15px'></span></p> 
<p style='margin-top:0px; margin-bottom:1.1em; padding-top:0px; padding-bottom:0px; color:rgb(63,63,63); font-family:"microsoft yahei"; font-size:15px'> 经过查证后得知： <br style=""> Android SDK中有些JAVA类是开放的，有些是不开放的，API同样如此。这里所谓开放的类或API，只是javadoc的范畴，并不是java中public和private，也就是说，对于源码的编译无所谓，但是对android的上层应用有影响，因为非开放的类或API,android上层应用无法直接访问。</p> 
<p style='margin-top:0px; margin-bottom:1.1em; padding-top:0px; padding-bottom:0px; color:rgb(63,63,63); font-family:"microsoft yahei"; font-size:15px'> 对于<span style="">在原有的类中添加方法</span>，google 给了两个解决方法： <br style=""> 1. 在你添加的API或者变量前面，增加 javadoc 注释<code style='font-family:"Source Code Pro",monospace; padding:2px 4px; font-size:13.5px; white-space:nowrap'>＠hide</code>。但是要注意的是，并不是简单写个＠hide 或者 <code style='font-family:"Source Code Pro",monospace; padding:2px 4px; font-size:13.5px; white-space:nowrap'>/*@hide*/</code> 就可以了，这些都是错误的javadoc注释格式，标准的javadoc都是这样的 <code style='font-family:"Source Code Pro",monospace; padding:2px 4px; font-size:13.5px; white-space:nowrap'>/** */</code> 而且对于 format 变量 应该加上 <code style='font-family:"Source Code Pro",monospace; padding:2px 4px; font-size:13.5px; white-space:nowrap'>{ }</code>。应该写成 <code style='font-family:"Source Code Pro",monospace; padding:2px 4px; font-size:13.5px; white-space:nowrap'>/** {@hide} */</code></p> 
<p style='margin-top:0px; margin-bottom:1.1em; padding-top:0px; padding-bottom:0px; color:rgb(63,63,63); font-family:"microsoft yahei"; font-size:15px'> 2.想要在生成的javadoc里面出现这个方法或者变量，你必须执行:</p> 
<pre class="prettyprint" name="code" style='white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.1em; font-family: "Source Code Pro", monospace; padding: 5px 5px 5px 60px; font-size: 14px; line-height: 1.45; word-break: break-all; color: rgb(51, 51, 51); background-color: rgba(128, 128, 128, 0.0470588); border: 0px solid rgb(136, 136, 136); border-radius: 0px;'><code class="hljs sql has-numbering" style='display: block; padding: 0px; background: transparent; color: inherit; box-sizing: border-box; font-family: "Source Code Pro", monospace;font-size:undefined; white-space: pre; border-radius: 0px; word-wrap: normal;'>make <span class="hljs-operator" style="box-sizing: border-box;"><span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">update</span>-api</span></code>
 
 </pre><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; background-color: rgb(238, 238, 238); top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right: 1px solid rgb(221, 221, 221); list-style: none; text-align: right;"><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">1</li></ul> 
<p style='margin-top:0px; margin-bottom:1.1em; padding-top:0px; padding-bottom:0px; color:rgb(63,63,63); font-family:"microsoft yahei"; font-size:15px'> 这样的话，系统自动将新增加的API添加到frameworks\base\api\current.txt中了，但是如果修改的是google没有开放出来的类，比如RIL，PhoneFactory，就不会出现这个问题。</p> 
<p style='margin-top:0px; margin-bottom:1.1em; padding-top:0px; padding-bottom:0px; color:rgb(63,63,63); font-family:"microsoft yahei"; font-size:15px'> 而如果要<span style="">加进新的类</span>， <br style=""> 1、在原有的包下面加类，这个最简单，加完之后执行<span style="">make update－api</span>，在frameworks\base\api\current.txt中会自动增加一段代码</p> 
<span style='color:rgb(63,63,63); font-family:"microsoft yahei"; font-size:15px'>2、若加在framework/base下面，这时你make update－api是不会在frameworks\base\api\current.txt里生成你新增的API的。这时，需要修改android源码根目录下的build/core/pathmap.mk把你的目录加进去.（未经亲自验证）</span> 
<br> 
<p><span style='color:rgb(63,63,63); font-family:"microsoft yahei"; font-size:15px'><span style='color:rgb(63,63,63); font-family:"microsoft yahei"; font-size:15px'><br> </span></span></p> 
<p><span style='color:rgb(63,63,63); font-family:"microsoft yahei"; font-size:15px'><span style='color:rgb(63,63,63); font-family:"microsoft yahei"; font-size:15px'><br> </span></span></p> 
<p><span style='color:rgb(63,63,63); font-family:"microsoft yahei"; font-size:15px'><span style='color:rgb(63,63,63); font-family:"microsoft yahei"; font-size:15px'></span></span></p> 
<p><span style='color:rgb(63,63,63); font-family:"microsoft yahei"; font-size:15px'>------------------------------------------------------------------------------------</span></p> 
<div> 
 <span style='color:rgb(63,63,63); font-family:"microsoft yahei"; font-size:15px'><a target="_blank" href="http://blog.csdn.net/badboyplane/article/details/7868381" style='color:rgb(0,0,0); text-decoration:none; font-family:"Microsoft YaHei"; font-size:20px' rel="noopener noreferrer">如何向Android的framework里添加新类</a><br> </span> 
</div> 
<br> 
<p><span style='color:rgb(63,63,63); font-family:"microsoft yahei"; font-size:15px'><span style='color:rgb(63,63,63); font-family:"microsoft yahei"; font-size:15px'><span style="font-size:14px; line-height:21px; font-family:verdana,sans-serif">google对于所有的类和API，分为开放式和不开放式两种。所谓的开放式就是值javadoc所包含的，并不是java中有public和private，而是跟javadoc有关系，代码 没有关系。<br> 在开放式的类中增加了一个变量，而又没隐藏，导致和原API的doc不一致造成的就会有错。<br> 通过提示，有2个方法可以解决 该问题：<br> 1、将新增加的变量或方法加上"@hide" 的注释，注意一点，加"@hide" 不是简简单单的/*@hide */就行了，标准的javadoc要这样 /** */ 而且对于 format 变量 应该加上 { }，也就是/**{@hide}*/<br> 2、如果想在生成的doc中增加该变量或方法的话，必须输入：<br> make update-api<br> 这样的话，系统 自动 将新增加的API添加到current.xml中了。</span><span style="font-size:14px; font-family:宋体"></span><span style="font-family:Arial; font-size:14px"></span></span></span></p> 
<div style="font-size:14px; font-family:宋体"> 
 <span style="line-height:21px; font-family:verdana,sans-serif"><br> </span> 
</div> 
<div style="font-size:14px; font-family:宋体"> 
 <span style="line-height:21px; font-family:verdana,sans-serif">所以如果要加方法就是按上面的方法加。</span> 
</div> 
<div style="font-size:14px; font-family:宋体"> 
 <span style="line-height:21px; font-family:verdana,sans-serif"><br> </span> 
</div> 
<div style="font-size:14px; font-family:宋体"> 
 <span style="line-height:21px; font-family:verdana,sans-serif">如果需要加进新的类 这时候又分2种 一种是原有的包下面加类 这个最简单 加完之后直接make update－api就好了 还有一种是加在framework/base下面 这个时候你make update－api是不会在current。xml里生成你的类的。 看了Android。mk才知道 原来需要修改android源码根目录下的build/core/pathmap.mk把你的目录加进去。然后就好了。</span> 
</div> 
<br> 
<p></p> 
<p><span style='color:rgb(63,63,63); font-family:"microsoft yahei"; font-size:15px'><span style='color:rgb(63,63,63); font-family:"microsoft yahei"; font-size:15px'><br> </span></span></p> 
<p><span style='color:rgb(63,63,63); font-family:"microsoft yahei"; font-size:15px'><span style='color:rgb(63,63,63); font-family:"microsoft yahei"; font-size:15px'>------------------------------------------------------------------------------------</span></span></p> 
<p><br> </p> 
<p></p> 
<p style='margin-top:0px; margin-bottom:1.1em; padding-top:0px; padding-bottom:0px; color:rgb(63,63,63); font-family:"microsoft yahei"; font-size:15px'> 修改framework/base下面的api要注意更新api/current.txt文件 <br style=""> 需要修改frameworks/base/下的代码，请注意 ：</p> 
<p style='margin-top:0px; margin-bottom:1.1em; padding-top:0px; padding-bottom:0px; color:rgb(63,63,63); font-family:"microsoft yahei"; font-size:15px'> 如果修改了Android原有API的 ，需要update frameworks/base/api/current.txt。否则编译被中断并出现编译错误提示。</p> 
<p style='margin-top:0px; margin-bottom:1.1em; padding-top:0px; padding-bottom:0px; color:rgb(63,63,63); font-family:"microsoft yahei"; font-size:15px'> 可以通过运行 make update-api 后，自动更新此文件，检查确认正确后，跟代码一起提交即可。</p> 
<p style='margin-top:0px; margin-bottom:1.1em; padding-top:0px; padding-bottom:0px; color:rgb(63,63,63); font-family:"microsoft yahei"; font-size:15px'> <br> </p> 
<p style='margin-top:0px; margin-bottom:1.1em; padding-top:0px; padding-bottom:0px; color:rgb(63,63,63); font-family:"microsoft yahei"; font-size:15px'> </p> 
<p><span style='color:rgb(63,63,63); font-family:"microsoft yahei"; font-size:15px'>------------------------------------------------------------------------------------</span></p> 
<div> 
 <span style='color:rgb(63,63,63); font-family:"microsoft yahei"; font-size:15px'>http://blog.csdn.net/badboyplane/article/details/7864621<br> </span> 
</div> 
<br> 
<p style='margin-top:0px; margin-bottom:1.1em; padding-top:0px; padding-bottom:0px; color:rgb(63,63,63); font-family:"microsoft yahei"; font-size:15px'> </p> 
<ol style="font-family:Arial; font-size:14px; color:rgb(51,51,51); line-height:26px"><li><p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px"> 主要是基于Android系统现在的Framework模块上再添加一个独立的模块，<span style="font-family:SimSun; font-size:10pt">目前</span><span style="font-family:SimSun; font-size:10pt">只是很简单的framework层调用native层(后期根据学习的进度，会将hal层补上，还有aidl, stub, 异步)。基本思路为：</span></p> 
 <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px">  </p> 
 </li><li value="1">为应用添加framework接口，即SDK API</li><li value="2">framework调用native代码，即jni部分</li><li value="3">jni部分实现最终功能 <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px">  </p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px"> 最终功能其实就是很简单的log打印，目的只要是重新温习一下framework开发的流程。之前都是在Android现有的机制上添加API，这次尝试添加一个独立的模块，只是个人的一个想法，不清楚Android添加一个新的独立模块的标准做法是怎样的，就当作学习吧。</p> </li></ol> 
<ol style="font-family:Arial; font-size:14px; color:rgb(51,51,51); line-height:26px"><li value="1"><span style="font-size:18px; color:rgb(255,0,0)">为应用添加framework接口，即SDK API</span> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px">  </p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px"> 在framework/base目录新建pmps目录，在pmps目录创建\java\android\pmps\PmpsManager.java 文件，输入代码：</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px">  </p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px"> package android.pmps;</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px"> import android.util.Log;</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px">  </p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px"> public class PmpsManager</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px"> {<!-- --></p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px"> private static final String LOG_TAG = "PmpsManager";</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px">  </p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px"> static {<!-- --></p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px"> <span style="color:rgb(255,0,0)">System.loadLibrary("pmps_jni");         </span>       </p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px"> }</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px">  </p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px"> public PmpsManager() {<!-- --></p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px"> Log.i(LOG_TAG, "PmpsManager constructor().");</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px"> }</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px"> <br> </p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px"> <span style="color:rgb(255,0,0)">public native static void sayHello();</span></p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px"> }</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px">  </p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px"> PmpsManager 为应用层提供相关API，如 sayHello()，这里是直接调用了JNI的native方法。值得注意的是PmpsManager加载了中的System.loadLibrary("pmps_jni")加载了文章中第3步将会生成的libpmps_jni.so文件。</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px">  </p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px"> 还有一个需要注意的细节，我们可以先看一下framework/base目录下的Android.mk文件，其中有一段：</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px"> # FRAMEWORKS_BASE_SUBDIRS comes from <span style="color:rgb(255,0,0)">build/core/pathmap.mk</span></p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px"> LOCAL_SRC_FILES := $(call find-other-java-files,$(FRAMEWORKS_BASE_SUBDIRS))</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px"> 我们再看看build/core/pathmap.mk，其中有一段</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px">  </p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px"> FRAMEWORKS_BASE_SUBDIRS := \</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px"> $(addsuffix /java, \</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px">     core \</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px">     graphics \</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px">     location \</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px">     media \</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px">     opengl \</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px">     sax \</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px">     telephony \</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px">     wifi \</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px">     vpn \</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px">     keystore \</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px">     voip \</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px">  )</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px">  </p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px"> 也就是说我们要在build/core/pathmap.mk文件中添加pmps目录，添加后为：</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px"> FRAMEWORKS_BASE_SUBDIRS := \</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px"> $(addsuffix /java, \</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px">     core \</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px">     graphics \</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px">     location \</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px">     media \</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px">     opengl \</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px">     sax \</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px">     telephony \</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px">     wifi \</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px">     vpn \</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px">     keystore \</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px">     voip \</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px">     <span style="color:rgb(255,0,0)">pmps \</span></p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px">  )</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px">  </p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px"> 然后我们就可以通过 mmm 命令编译这个新添加的模块了。</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px"> mmm framework/base 编译，生成文件为out/target/product/generic/system/framework/framework.jar</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px"> 代码编译通过后，就可以做接下来的事情了。</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px"> <br> </p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px"> <span style="font-size:18px; color:rgb(255,0,0)">2.framework调用native代码，即jni部分</span><br> </p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px"> </p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px"> 上一步中的 publicnative static void sayHello() 就可以由应用层调用了，当然我们可以在framework里面再封装一下，以实现更加复杂的功能，例如：</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px">  </p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px"> //api</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px"> public int sayHelloFirst()</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px"> {<!-- --></p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px"> //省略的代码...</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px"> return sayHello();</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px"> }</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px">  </p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px"> //declaration</p> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px"> public native static void sayHello();</p> <br> <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px">  </p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-size:17pt"><span style="color:rgb(255,0,0)"><span lang="en-US" style="font-family:Calibri">3.</span><span lang="zh-CN" style="font-family:SimSun">jni部分实现功能</span></span></p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-size:17pt"><span lang="zh-CN" style="font-family:SimSun"><br> </span></p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-size:17pt"><span lang="zh-CN" style="font-family:SimSun"></span></p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-size:10pt"><span lang="zh-CN" style="font-family:SimSun">这一步通过编写</span><span lang="en-US" style="font-family:Calibri">native</span><span lang="zh-CN" style="font-family:SimSun">代码实现</span><span lang="en-US" style="font-family:Calibri">framework</span><span lang="zh-CN" style="font-family:SimSun">中的调用的功能，可以实现具体的功能或者调用</span><span lang="en-US" style="font-family:Calibri">hal</span><span lang="zh-CN" style="font-family:SimSun">层的相关驱动，完成硬件操作功能。</span></p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt"> 当前只是简单地打印一下信息。</p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt">  </p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-size:10pt"><span lang="zh-CN" style="font-family:SimSun">值得注意的要实现JNI_OnLoad函数，如果有需要的话，也可以重写JNI_On</span><span lang="en-US" style="font-family:Calibri">Un</span><span lang="zh-CN" style="font-family:SimSun">Load函数。</span></p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt">  </p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt"> /*//device/libs/android_runtime/android_media_MediaPlayer.cpp</p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt"> **</p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt"> ** Copyright 2007,The Android Open Source Project</p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt"> **</p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt"> ** Licensed under theApache License, Version 2.0 (the "License");</p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt"> ** you may not usethis file except in compliance with the License.</p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt"> ** You may obtain acopy of the License at</p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt"> **</p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt"> **     <a target="_blank" href="http://www.apache.org/licenses/LICENSE-2.0" rel="nofollow noopener noreferrer" style="color:rgb(51,102,153); text-decoration:none">http://www.apache.org/licenses/LICENSE-2.0</a></p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt"> **</p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt"> ** Unless required byapplicable law or agreed to in writing, software</p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt"> ** distributed underthe License is distributed on an "AS IS" BASIS,</p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt"> ** WITHOUT WARRANTIESOR CONDITIONS OF ANY KIND, either express or implied.</p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt"> ** See the Licensefor the specific language governing permissions and</p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt"> ** limitations underthe License.</p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt"> */</p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt">  </p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt"> #define LOG_NDEBUG 0</p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt"> #define LOG_TAG"PmpsManager-JNI"</p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt"> #include"utils/Log.h"</p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt">  </p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt"> #include&lt;stdio.h&gt;</p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt"> #include&lt;assert.h&gt;</p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt"> #include&lt;limits.h&gt;</p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt"> #include&lt;unistd.h&gt;</p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt"> #include&lt;fcntl.h&gt;</p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt"> #include"jni.h"</p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt"> #include"JNIHelp.h"</p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt"> #include"android_runtime/AndroidRuntime.h"</p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt"> //----------------------------------------------------------------------------</p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt">  </p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt"> using namespaceandroid;</p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt">  </p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt"> <span style="color:rgb(255,0,0)">static voidandroid_pmps_PmpsManager_sayHello(JNIEnv *env, jobject thiz)</span></p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt"> {<!-- --></p> <p style="margin:0in 0in 0in 0.375in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt"> LOGV("sayHello()");</p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt"> }</p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt">  </p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt"> static constJNINativeMethod method_table[] = { </p> <p style="margin:0in 0in 0in 0.375in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt"> <span style="color:rgb(255,0,0)">{"sayHello","()V", (void*)android_pmps_PmpsManager_sayHello}, </span></p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt"> };        </p> <p style="margin:0in 0in 0in 0.375in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt">  </p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt"> // This function onlyregisters the native methods</p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt"> intregister_android_pmps_PmpsManager(JNIEnv *env) { </p> <p style="margin:0in 0in 0in 0.375in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt"> inti;</p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt">  </p> <p style="margin:0in 0in 0in 0.375in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt"> LOGI("JNI_OnLoad:register_android_pmps_PmpsPlayer");</p> <p style="margin:0in 0in 0in 0.375in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt">  </p> <p style="margin:0in 0in 0in 0.375in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt"> returnAndroidRuntime::registerNativeMethods(env,</p> <p style="margin:0in 0in 0in 0.75in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt"> "android/pmps/PmpsManager",method_table, NELEM(method_table)); </p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt"> } </p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt">  </p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt">  </p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt"> jintJNI_OnLoad(JavaVM* vm, void* reserved)</p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt"> {<!-- --></p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt">     JNIEnv* env = NULL;</p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt">     jint result = -1;</p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt">  </p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt">     if (vm-&gt;GetEnv((void**) &amp;env,JNI_VERSION_1_4) != JNI_OK) {<!-- --></p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt">         LOGE("ERROR: GetEnvfailed\n");</p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt">         goto bail;</p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt">     }</p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt">     assert(env != NULL);</p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt">  </p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt">     if (register_android_pmps_PmpsManager(env)&lt; 0) {<!-- --></p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt">         LOGE("ERROR: PmpsManager nativeregistration failed\n");</p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt">         goto bail;</p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt">     }</p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt">  </p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt">     /* success -- return valid version number*/</p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt">     result = JNI_VERSION_1_4;</p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt">  </p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt"> bail:</p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt">     return result;</p> <p style="margin:0in; padding-top:0px; padding-bottom:0px; font-family:SimSun; font-size:10pt"> }</p> </li></ol> 
<br> 
<p></p> 
<br>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/07f8b16ea245b5fb7bd5cbb774566c74/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">利用JMeter进行Tomcat调优</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e434ba5f1760b5e9178d534cf71937ed/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">framework添加res资源并打包进新的Android.jar</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>