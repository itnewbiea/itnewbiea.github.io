<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>FlinkCDC从Mongodb同步数据至elasticsearch（ES) 新版 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="FlinkCDC从Mongodb同步数据至elasticsearch（ES) 新版" />
<meta property="og:description" content="FlinkCDC从Mongodb同步数据至elasticsearch（ES） 一、 DataStreamingAPI方式pom.xml 二、主程序-配置三、主程序四、其他问题 一、 DataStreamingAPI方式 网上挺多flinksql方式同步数据，但是遇到数据比较杂乱，会经常无缘无故报错，笔者被逼无奈，采用API方式处理数据后同步，不知为何API资料笔者找到的资料很少，还很不全，摸着石头过河总算完成任务，收获颇丰，以此分享给大家。
pom.xml &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt; &lt;groupId&gt;com.cece&lt;/groupId&gt; &lt;artifactId&gt;Mongo-ES&lt;/artifactId&gt; &lt;version&gt;1.0&lt;/version&gt; &lt;properties&gt; &lt;java.version&gt;1.8&lt;/java.version&gt; &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt; &lt;project.reporting.outputEncoding&gt;UTF-8&lt;/project.reporting.outputEncoding&gt; &lt;maven.compiler.source&gt;${java.version}&lt;/maven.compiler.source&gt; &lt;maven.compiler.target&gt;${java.version}&lt;/maven.compiler.target&gt; &lt;flink.version&gt;1.13.0&lt;/flink.version&gt; &lt;scala.binary.version&gt;2.12&lt;/scala.binary.version&gt; &lt;scala.version&gt;2.12&lt;/scala.version&gt; &lt;/properties&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.apache.flink&lt;/groupId&gt; &lt;artifactId&gt;flink-java&lt;/artifactId&gt; &lt;version&gt;${flink.version}&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.apache.flink&lt;/groupId&gt; &lt;artifactId&gt;flink-streaming-java_2.12&lt;/artifactId&gt; &lt;version&gt;${flink.version}&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.apache.flink&lt;/groupId&gt; &lt;artifactId&gt;flink-clients_2.12&lt;/artifactId&gt; &lt;version&gt;${flink.version}&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.apache.flink&lt;/groupId&gt; &lt;artifactId&gt;flink-table-api-java-bridge_2.12&lt;/artifactId&gt; &lt;version&gt;${flink.version}&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.apache.flink&lt;/groupId&gt; &lt;artifactId&gt;flink-table-planner-blink_${scala.binary.version}&lt;/artifactId&gt; &lt;version&gt;${flink.version}&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.apache.flink&lt;/groupId&gt; &lt;artifactId&gt;flink-json&lt;/artifactId&gt; &lt;version&gt;${flink.version}&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.alibaba&lt;/groupId&gt; &lt;artifactId&gt;fastjson&lt;/artifactId&gt; &lt;version&gt;1.2.68&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.google.code.gson&lt;/groupId&gt; &lt;artifactId&gt;gson&lt;/artifactId&gt; &lt;version&gt;2.8.3&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.apache.flink&lt;/groupId&gt; &lt;artifactId&gt;flink-connector-elasticsearch7_2.11&lt;/artifactId&gt; &lt;version&gt;${flink.version}&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/2b087477605bce9fad7df6b251a12bfe/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-11-27T15:53:17+08:00" />
<meta property="article:modified_time" content="2022-11-27T15:53:17+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">FlinkCDC从Mongodb同步数据至elasticsearch（ES) 新版</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>FlinkCDC从Mongodb同步数据至elasticsearch（ES）</h4> 
 <ul><li><a href="#_DataStreamingAPI_2" rel="nofollow">一、 DataStreamingAPI方式</a></li><li><ul><li><a href="#pomxml_8" rel="nofollow">pom.xml</a></li></ul> 
  </li><li><a href="#_204" rel="nofollow">二、主程序-配置</a></li><li><a href="#_235" rel="nofollow">三、主程序</a></li><li><a href="#_419" rel="nofollow">四、其他问题</a></li></ul> 
</div> 
<p></p> 
<h2><a id="_DataStreamingAPI_2"></a>一、 DataStreamingAPI方式</h2> 
<p>网上挺多flinksql方式同步数据，但是遇到数据比较杂乱，会经常无缘无故报错，笔者被逼无奈，采用API方式处理数据后同步，不知为何API资料笔者找到的资料很少，还很不全，摸着石头过河总算完成任务，收获颇丰，以此分享给大家。</p> 
<h3><a id="pomxml_8"></a>pom.xml</h3> 
<pre><code class="prism language-javascript">  <span class="token operator">&lt;</span>modelVersion<span class="token operator">&gt;</span><span class="token number">4.0</span><span class="token number">.0</span><span class="token operator">&lt;</span><span class="token operator">/</span>modelVersion<span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>com<span class="token punctuation">.</span>cece<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>Mongo<span class="token operator">-</span><span class="token constant">ES</span><span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token number">1.0</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span>properties<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>java<span class="token punctuation">.</span>version<span class="token operator">&gt;</span><span class="token number">1.8</span><span class="token operator">&lt;</span><span class="token operator">/</span>java<span class="token punctuation">.</span>version<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>project<span class="token punctuation">.</span>build<span class="token punctuation">.</span>sourceEncoding<span class="token operator">&gt;</span><span class="token constant">UTF</span><span class="token operator">-</span><span class="token number">8</span><span class="token operator">&lt;</span><span class="token operator">/</span>project<span class="token punctuation">.</span>build<span class="token punctuation">.</span>sourceEncoding<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>project<span class="token punctuation">.</span>reporting<span class="token punctuation">.</span>outputEncoding<span class="token operator">&gt;</span><span class="token constant">UTF</span><span class="token operator">-</span><span class="token number">8</span><span class="token operator">&lt;</span><span class="token operator">/</span>project<span class="token punctuation">.</span>reporting<span class="token punctuation">.</span>outputEncoding<span class="token operator">&gt;</span>

        <span class="token operator">&lt;</span>maven<span class="token punctuation">.</span>compiler<span class="token punctuation">.</span>source<span class="token operator">&gt;</span>$<span class="token punctuation">{<!-- --></span>java<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>maven<span class="token punctuation">.</span>compiler<span class="token punctuation">.</span>source<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>maven<span class="token punctuation">.</span>compiler<span class="token punctuation">.</span>target<span class="token operator">&gt;</span>$<span class="token punctuation">{<!-- --></span>java<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>maven<span class="token punctuation">.</span>compiler<span class="token punctuation">.</span>target<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>flink<span class="token punctuation">.</span>version<span class="token operator">&gt;</span><span class="token number">1.13</span><span class="token number">.0</span><span class="token operator">&lt;</span><span class="token operator">/</span>flink<span class="token punctuation">.</span>version<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>scala<span class="token punctuation">.</span>binary<span class="token punctuation">.</span>version<span class="token operator">&gt;</span><span class="token number">2.12</span><span class="token operator">&lt;</span><span class="token operator">/</span>scala<span class="token punctuation">.</span>binary<span class="token punctuation">.</span>version<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>scala<span class="token punctuation">.</span>version<span class="token operator">&gt;</span><span class="token number">2.12</span><span class="token operator">&lt;</span><span class="token operator">/</span>scala<span class="token punctuation">.</span>version<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>properties<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>dependencies<span class="token operator">&gt;</span>







        <span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>flink<span class="token operator">-</span>java<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span>$<span class="token punctuation">{<!-- --></span>flink<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>

        <span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>flink<span class="token operator">-</span>streaming<span class="token operator">-</span>java_2<span class="token punctuation">.</span><span class="token number">12</span><span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span>$<span class="token punctuation">{<!-- --></span>flink<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>

        <span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>flink<span class="token operator">-</span>clients_2<span class="token punctuation">.</span><span class="token number">12</span><span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span>$<span class="token punctuation">{<!-- --></span>flink<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>flink<span class="token operator">-</span>table<span class="token operator">-</span>api<span class="token operator">-</span>java<span class="token operator">-</span>bridge_2<span class="token punctuation">.</span><span class="token number">12</span><span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span>$<span class="token punctuation">{<!-- --></span>flink<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>flink<span class="token operator">-</span>table<span class="token operator">-</span>planner<span class="token operator">-</span>blink_$<span class="token punctuation">{<!-- --></span>scala<span class="token punctuation">.</span>binary<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span>$<span class="token punctuation">{<!-- --></span>flink<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>flink<span class="token operator">-</span>json<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span>$<span class="token punctuation">{<!-- --></span>flink<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>






        <span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>com<span class="token punctuation">.</span>alibaba<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>fastjson<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token number">1.2</span><span class="token number">.68</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>

        <span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>code<span class="token punctuation">.</span>gson<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>gson<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token number">2.8</span><span class="token number">.3</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>

        <span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>flink<span class="token operator">-</span>connector<span class="token operator">-</span>elasticsearch7_2<span class="token punctuation">.</span><span class="token number">11</span><span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span>$<span class="token punctuation">{<!-- --></span>flink<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>flink<span class="token operator">-</span>connector<span class="token operator">-</span>kafka_$<span class="token punctuation">{<!-- --></span>scala<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span>$<span class="token punctuation">{<!-- --></span>flink<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org<span class="token punctuation">.</span>slf4j<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>slf4j<span class="token operator">-</span>api<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token number">1.7</span><span class="token number">.25</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>

        <span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org<span class="token punctuation">.</span>slf4j<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>slf4j<span class="token operator">-</span>log4j12<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token number">1.7</span><span class="token number">.25</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>

        <span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>log4j<span class="token operator">-</span>to<span class="token operator">-</span>slf4j<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token number">2.14</span><span class="token number">.0</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>

        <span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org<span class="token punctuation">.</span>mongodb<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>mongo<span class="token operator">-</span>java<span class="token operator">-</span>driver<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token number">3.11</span><span class="token number">.0</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>




        <span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>com<span class="token punctuation">.</span>ververica<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>flink<span class="token operator">-</span>connector<span class="token operator">-</span>mongodb<span class="token operator">-</span>cdc<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token number">2.2</span><span class="token number">.0</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>

        <span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>com<span class="token punctuation">.</span>ververica<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>flink<span class="token operator">-</span>sql<span class="token operator">-</span>connector<span class="token operator">-</span>mongodb<span class="token operator">-</span>cdc<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token number">2.2</span><span class="token number">.0</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>         https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>mvnrepository<span class="token punctuation">.</span>com<span class="token operator">/</span>artifact<span class="token operator">/</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token operator">/</span>connect<span class="token operator">-</span>api <span class="token operator">--</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>connect<span class="token operator">-</span>api<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token number">2.7</span><span class="token number">.0</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>kafka<span class="token operator">-</span>clients<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token number">2.7</span><span class="token number">.0</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>

        <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>mvnrepository<span class="token punctuation">.</span>com<span class="token operator">/</span>artifact<span class="token operator">/</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token operator">/</span>flink<span class="token operator">-</span>connector<span class="token operator">-</span>jdbc <span class="token operator">--</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>flink<span class="token operator">-</span>connector<span class="token operator">-</span>jdbc_2<span class="token punctuation">.</span><span class="token number">12</span><span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span>$<span class="token punctuation">{<!-- --></span>flink<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>dependencies<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>build<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>plugins<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>plugin<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>maven<span class="token punctuation">.</span>plugins<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>maven<span class="token operator">-</span>shade<span class="token operator">-</span>plugin<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token number">3.1</span><span class="token number">.1</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>executions<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>execution<span class="token operator">&gt;</span>
                        <span class="token operator">&lt;</span>phase<span class="token operator">&gt;</span><span class="token keyword">package</span><span class="token operator">&lt;</span><span class="token operator">/</span>phase<span class="token operator">&gt;</span>
                        <span class="token operator">&lt;</span>goals<span class="token operator">&gt;</span>
                            <span class="token operator">&lt;</span>goal<span class="token operator">&gt;</span>shade<span class="token operator">&lt;</span><span class="token operator">/</span>goal<span class="token operator">&gt;</span>
                        <span class="token operator">&lt;</span><span class="token operator">/</span>goals<span class="token operator">&gt;</span>
                        <span class="token operator">&lt;</span>configuration<span class="token operator">&gt;</span>
                            <span class="token operator">&lt;</span>artifactSet<span class="token operator">&gt;</span>
                                <span class="token operator">&lt;</span>excludes<span class="token operator">&gt;</span>
                                    <span class="token operator">&lt;</span>exclude<span class="token operator">&gt;</span>com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>code<span class="token punctuation">.</span>findbugs<span class="token operator">:</span>jsr305<span class="token operator">&lt;</span><span class="token operator">/</span>exclude<span class="token operator">&gt;</span>
                                    <span class="token operator">&lt;</span>exclude<span class="token operator">&gt;</span>org<span class="token punctuation">.</span>slf4j<span class="token operator">:</span><span class="token operator">*</span><span class="token operator">&lt;</span><span class="token operator">/</span>exclude<span class="token operator">&gt;</span>
                                    <span class="token operator">&lt;</span>exclude<span class="token operator">&gt;</span>log4j<span class="token operator">:</span><span class="token operator">*</span><span class="token operator">&lt;</span><span class="token operator">/</span>exclude<span class="token operator">&gt;</span>
                                    <span class="token operator">&lt;</span>exclude<span class="token operator">&gt;</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token operator">:</span><span class="token operator">*</span><span class="token operator">&lt;</span><span class="token operator">/</span>exclude<span class="token operator">&gt;</span>
                                <span class="token operator">&lt;</span><span class="token operator">/</span>excludes<span class="token operator">&gt;</span>
                            <span class="token operator">&lt;</span><span class="token operator">/</span>artifactSet<span class="token operator">&gt;</span>
                            <span class="token operator">&lt;</span>filters<span class="token operator">&gt;</span>
                                <span class="token operator">&lt;</span>filter<span class="token operator">&gt;</span>
                                    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> Do not copy the signatures <span class="token keyword">in</span> the <span class="token constant">META</span><span class="token operator">-</span><span class="token constant">INF</span> folder<span class="token punctuation">.</span>Otherwise<span class="token punctuation">,</span> <span class="token keyword">this</span> might cause SecurityExceptions when using the <span class="token constant">JAR</span><span class="token punctuation">.</span> <span class="token operator">--</span><span class="token operator">&gt;</span>
                                    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 打包时不复制<span class="token constant">META</span><span class="token operator">-</span><span class="token constant">INF</span>下的签名文件，避免报非法签名文件的SecurityExceptions异常<span class="token operator">--</span><span class="token operator">&gt;</span>
                                    <span class="token operator">&lt;</span>artifact<span class="token operator">&gt;</span><span class="token operator">*</span><span class="token operator">:</span><span class="token operator">*</span><span class="token operator">&lt;</span><span class="token operator">/</span>artifact<span class="token operator">&gt;</span>
                                    <span class="token operator">&lt;</span>excludes<span class="token operator">&gt;</span>
                                        <span class="token operator">&lt;</span>exclude<span class="token operator">&gt;</span><span class="token constant">META</span><span class="token operator">-</span><span class="token constant">INF</span><span class="token comment">/*.SF&lt;/exclude&gt;
                                        &lt;exclude&gt;META-INF/*.DSA&lt;/exclude&gt;
                                        &lt;exclude&gt;META-INF/*.RSA&lt;/exclude&gt;
                                    &lt;/excludes&gt;
                                &lt;/filter&gt;
                            &lt;/filters&gt;

                            &lt;transformers combine.children="append"&gt;
                                &lt;!-- The service transformer is needed to merge META-INF/services files --&gt;
                                &lt;!-- connector和format依赖的工厂类打包时会相互覆盖，需要使用ServicesResourceTransformer解决--&gt;
                                &lt;transformer
                                        implementation="org.apache.maven.plugins.shade.resource.ServicesResourceTransformer"/&gt;
                            &lt;/transformers&gt;
                        &lt;/configuration&gt;
                    &lt;/execution&gt;
                &lt;/executions&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;

    &lt;/build&gt;
</span></code></pre> 
<h2><a id="_204"></a>二、主程序-配置</h2> 
<pre><code class="prism language-javascript"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Config</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> final String <span class="token constant">MONGODB_URL</span> <span class="token operator">=</span> <span class="token string">"1xxx"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> final String <span class="token constant">MONGODB_USER</span> <span class="token operator">=</span> <span class="token string">"sxx"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> final String <span class="token constant">MONGODB_PWD</span> <span class="token operator">=</span> <span class="token string">"xx"</span><span class="token punctuation">;</span>



    <span class="token keyword">public</span> <span class="token keyword">static</span> final String <span class="token constant">MONGODB_DATABASE</span> <span class="token operator">=</span> <span class="token string">"xx"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> final String <span class="token constant">MONGODB_COLLECTION</span> <span class="token operator">=</span> <span class="token string">"xx"</span><span class="token punctuation">;</span>



    <span class="token keyword">public</span> <span class="token keyword">static</span> final String <span class="token constant">ES_URL</span> <span class="token operator">=</span> <span class="token string">"xx"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> final int <span class="token constant">ES_PORT</span> <span class="token operator">=</span> xx<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> final String <span class="token constant">ES_USER</span> <span class="token operator">=</span> <span class="token string">"xxx"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> final String <span class="token constant">ES_PWD</span> <span class="token operator">=</span> <span class="token string">"xxxx"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> final String <span class="token constant">ES_INDEX</span> <span class="token operator">=</span> <span class="token string">"xxxx"</span><span class="token punctuation">;</span>



    <span class="token keyword">public</span> <span class="token keyword">static</span> final int   <span class="token constant">BUFFER_TIMEOUT_MS</span> <span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> final int   <span class="token constant">CHECKPOINT_INTERVAL_MS</span> <span class="token operator">=</span><span class="token number">3</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> final int   <span class="token constant">CHECKPOINT_TIMEOUT_MS</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> final int   <span class="token constant">CHECKPOINT_MIN_PAUSE_MS</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="_235"></a>三、主程序</h2> 
<pre><code class="prism language-javascript"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FlinkCdcSyn_API</span> <span class="token punctuation">{<!-- --></span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> throws Exception <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//1.构建flink环境及配置checkpoint</span>
        StreamExecutionEnvironment env <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        env.setParallelism(1);</span>
        env<span class="token punctuation">.</span><span class="token function">setBufferTimeout</span><span class="token punctuation">(</span><span class="token constant">BUFFER_TIMEOUT_MS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">enableCheckpointing</span><span class="token punctuation">(</span><span class="token constant">CHECKPOINT_INTERVAL_MS</span><span class="token punctuation">,</span> CheckpointingMode<span class="token punctuation">.</span><span class="token constant">AT_LEAST_ONCE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">getCheckpointConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCheckpointTimeout</span><span class="token punctuation">(</span><span class="token constant">CHECKPOINT_TIMEOUT_MS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">getCheckpointConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setMinPauseBetweenCheckpoints</span><span class="token punctuation">(</span><span class="token constant">CHECKPOINT_MIN_PAUSE_MS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">setRestartStrategy</span><span class="token punctuation">(</span>RestartStrategies<span class="token punctuation">.</span><span class="token function">failureRateRestart</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> Time<span class="token punctuation">.</span><span class="token function">minutes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Time<span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2.通过FlinkCDC构建SourceFunction</span>
        SourceFunction<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> mongoDBSourceFunction <span class="token operator">=</span> MongoDBSource<span class="token punctuation">.</span><span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">hosts</span><span class="token punctuation">(</span><span class="token constant">MONGODB_URL</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">username</span><span class="token punctuation">(</span><span class="token constant">MONGODB_USER</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token constant">MONGODB_PWD</span><span class="token punctuation">)</span>

                <span class="token punctuation">.</span><span class="token function">databaseList</span><span class="token punctuation">(</span><span class="token constant">MONGODB_DATABASE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collectionList</span><span class="token punctuation">(</span><span class="token constant">MONGODB_COLLECTION</span><span class="token punctuation">)</span>

                <span class="token punctuation">.</span><span class="token function">deserializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JsonDebeziumDeserializationSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">//                .deserializer(new CoustomParse())</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//3.数据初步处理，因为es的keyword最大不能超过32766</span>

        SingleOutputStreamOperator<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> stream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span>mongoDBSourceFunction<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">"mongo_to_es"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FilterFunction</span><span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    @Override
                    <span class="token keyword">public</span> boolean <span class="token function">filter</span><span class="token punctuation">(</span>String s<span class="token punctuation">)</span> throws Exception <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//判断是否是json格式，不是过滤掉</span>
                            JSONObject obj <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>Exception e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"json格式错误："</span><span class="token operator">+</span> s<span class="token punctuation">)</span> <span class="token punctuation">;</span>
                            <span class="token keyword">return</span>  <span class="token boolean">false</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">//不处理会报whose UTF8 encoding is longer than the max length 32766，将过大的字段过滤掉</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MapFunction</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    @Override
                    <span class="token keyword">public</span> String <span class="token function">map</span><span class="token punctuation">(</span>String s<span class="token punctuation">)</span> throws Exception <span class="token punctuation">{<!-- --></span>
                        JSONObject obj <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        String str <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"operationType"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">"insert"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">"update"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                            JSONObject obj1 <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">getJSONObject</span><span class="token punctuation">(</span><span class="token string">"fullDocument"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span><span class="token punctuation">(</span>obj1<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">36000</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>


                            Set<span class="token operator">&lt;</span>Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">&gt;&gt;</span> entries <span class="token operator">=</span> obj1<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            Iterator<span class="token operator">&lt;</span>Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">&gt;&gt;</span> iterator <span class="token operator">=</span> entries<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                            <span class="token keyword">while</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
<span class="token comment">//                                    String s1 = iterator.next().toString();</span>
<span class="token comment">//                                    System.out.println("iterator含义:" + s1);</span>
                                <span class="token keyword">if</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">30000</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                    iterator<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                            obj<span class="token punctuation">.</span><span class="token function">fluentPut</span><span class="token punctuation">(</span><span class="token string">"fullDocument"</span><span class="token punctuation">,</span>obj1<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>

                        <span class="token keyword">return</span> obj<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  List<span class="token operator">&lt;</span>HttpHost<span class="token operator">&gt;</span> httpHosts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">//4.对insert/update/delete分别处理</span>
        httpHosts<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpHost</span><span class="token punctuation">(</span><span class="token constant">ES_URL</span><span class="token punctuation">,</span> <span class="token constant">ES_PORT</span><span class="token punctuation">,</span> <span class="token string">"http"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           ElasticsearchSink<span class="token punctuation">.</span>Builder<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> esSinkBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ElasticsearchSink<span class="token punctuation">.</span>Builder</span><span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">(</span>
                httpHosts<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ElasticsearchSinkFunction</span><span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

            <span class="token keyword">public</span> ActionRequest <span class="token function">createIndexRequest</span><span class="token punctuation">(</span><span class="token parameter">String element</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>



               JSONObject obj <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">//  System.out.println("create:" + obj.toString());</span>
              String str <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"operationType"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token comment">// Map&lt;String, String&gt; json = new HashMap&lt;&gt;();</span>
                String id <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    id <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">getJSONObject</span><span class="token punctuation">(</span><span class="token string">"documentKey"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getJSONObject</span><span class="token punctuation">(</span><span class="token string">"_id"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"$oid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>Exception e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                        id <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">getJSONObject</span><span class="token punctuation">(</span><span class="token string">"documentKey"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"_id"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>Exception ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"格式不对："</span> <span class="token operator">+</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                <span class="token punctuation">}</span>

                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">"insert"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    JSONObject data <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">getJSONObject</span><span class="token punctuation">(</span><span class="token string">"fullDocument"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    data<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">"_id"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//Object o = data.toJSON(JsonWriterSettings.builder().outputMode(JsonMode.RELAXED).build());</span>
                    Document parse <span class="token operator">=</span> Document<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    String s <span class="token operator">=</span> parse<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span>JsonWriterSettings<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">outputMode</span><span class="token punctuation">(</span>JsonMode<span class="token punctuation">.</span><span class="token constant">RELAXED</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token keyword">return</span> Requests<span class="token punctuation">.</span><span class="token function">indexRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token constant">ES_INDEX</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span>XContentType<span class="token punctuation">.</span><span class="token constant">JSON</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">"update"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    JSONObject data <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">getJSONObject</span><span class="token punctuation">(</span><span class="token string">"fullDocument"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    data<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">"_id"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    Document parse <span class="token operator">=</span> Document<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    String s <span class="token operator">=</span> parse<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span>JsonWriterSettings<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">outputMode</span><span class="token punctuation">(</span>JsonMode<span class="token punctuation">.</span><span class="token constant">RELAXED</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                          <span class="token keyword">return</span>   <span class="token keyword">new</span> <span class="token class-name">UpdateRequest</span><span class="token punctuation">(</span><span class="token constant">ES_INDEX</span><span class="token punctuation">,</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doc</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span>XContentType<span class="token punctuation">.</span><span class="token constant">JSON</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">retryOnConflict</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                    DeleteRequest deleteRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeleteRequest</span><span class="token punctuation">(</span><span class="token constant">ES_INDEX</span><span class="token punctuation">,</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                   <span class="token comment">// System.out.println("delete语句：" + obj.toString());</span>
                    <span class="token keyword">return</span> deleteRequest<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>


            <span class="token punctuation">}</span>
                @Override
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token parameter">String element<span class="token punctuation">,</span> RuntimeContext ctx<span class="token punctuation">,</span> RequestIndexer indexer</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//System.out.println(element);</span>
<span class="token comment">//                indexer.add(createIndexRequest(element));</span>
                indexer<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">createIndexRequest</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//                indexer.add();</span>


            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        esSinkBuilder<span class="token punctuation">.</span><span class="token function">setBulkFlushMaxActions</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        esSinkBuilder<span class="token punctuation">.</span><span class="token function">setRestClientFactory</span><span class="token punctuation">(</span>restClientBuilder <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
                    restClientBuilder<span class="token punctuation">.</span><span class="token function">setHttpClientConfigCallback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RestClientBuilder<span class="token punctuation">.</span>HttpClientConfigCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        @Override
                        <span class="token keyword">public</span> HttpAsyncClientBuilder <span class="token function">customizeHttpClient</span><span class="token punctuation">(</span><span class="token parameter">HttpAsyncClientBuilder httpAsyncClientBuilder</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            BasicCredentialsProvider credentialsProvider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BasicCredentialsProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            credentialsProvider<span class="token punctuation">.</span><span class="token function">setCredentials</span><span class="token punctuation">(</span>AuthScope<span class="token punctuation">.</span><span class="token constant">ANY</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordCredentials</span><span class="token punctuation">(</span><span class="token constant">ES_USER</span><span class="token punctuation">,</span> <span class="token constant">ES_PWD</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                            <span class="token keyword">return</span> httpAsyncClientBuilder<span class="token punctuation">.</span><span class="token function">setDefaultCredentialsProvider</span><span class="token punctuation">(</span>credentialsProvider<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        esSinkBuilder<span class="token punctuation">.</span><span class="token function">setBulkFlushInterval</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//5.处理报错的数据，因为延迟产生的增加到队列重新写入，其他的过滤掉</span>
        esSinkBuilder<span class="token punctuation">.</span><span class="token function">setFailureHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ActionRequestFailureHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            @Override
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onFailure</span><span class="token punctuation">(</span>ActionRequest action<span class="token punctuation">,</span> Throwable failure<span class="token punctuation">,</span> int restStatusCode<span class="token punctuation">,</span> RequestIndexer indexer<span class="token punctuation">)</span> throws Throwable <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ExceptionUtils<span class="token punctuation">.</span><span class="token function">findThrowable</span><span class="token punctuation">(</span>failure<span class="token punctuation">,</span> EsRejectedExecutionException<span class="token punctuation">.</span>class<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// full queue; re-add document for indexing</span>
                    indexer<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ExceptionUtils<span class="token punctuation">.</span><span class="token function">findThrowable</span><span class="token punctuation">(</span>failure<span class="token punctuation">,</span> ElasticsearchParseException<span class="token punctuation">.</span>class<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// malformed document; simply drop request without failing sink</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// for all other failures, fail the sink</span>
                    <span class="token comment">// here the failure is simply rethrown, but users can also choose to throw custom exceptions</span>
                    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"失败语句："</span><span class="token operator">+</span>action<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         stream<span class="token punctuation">.</span><span class="token function">addSink</span><span class="token punctuation">(</span>esSinkBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

           env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h2><a id="_419"></a>四、其他问题</h2> 
<p>有个大坑，我用该程序监控mongodb只能监控一个表，多个表监控一致报如下错误：</p> 
<pre><code class="prism language-bash"> Caused by: com.mongodb.MongoCommandException: Command failed with error <span class="token number">40415</span> <span class="token punctuation">(</span>Location40415<span class="token punctuation">)</span>: <span class="token string">'BSON field '</span><span class="token variable">$changeStream</span>.allChangesForCluster<span class="token string">' is an unknown field.'</span> on server common1:27017. The full response is <span class="token punctuation">{<!-- --></span><span class="token string">"operationTime"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"<span class="token variable">$timestamp</span>"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"t"</span><span class="token builtin class-name">:</span> <span class="token number">1668869353</span>, <span class="token string">"i"</span><span class="token builtin class-name">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span>, <span class="token string">"ok"</span><span class="token builtin class-name">:</span> <span class="token number">0.0</span>, <span class="token string">"errmsg"</span><span class="token builtin class-name">:</span> <span class="token string">"BSON field '<span class="token variable">$changeStream</span>.allChangesForCluster' is an unknown field."</span>, <span class="token string">"code"</span><span class="token builtin class-name">:</span> <span class="token number">40415</span>, <span class="token string">"codeName"</span><span class="token builtin class-name">:</span> <span class="token string">"Location40415"</span>, <span class="token string">"<span class="token variable">$clusterTime</span>"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"clusterTime"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"<span class="token variable">$timestamp</span>"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"t"</span><span class="token builtin class-name">:</span> <span class="token number">1668869353</span>, <span class="token string">"i"</span><span class="token builtin class-name">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span>, <span class="token string">"signature"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"hash"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"<span class="token variable">$binary</span>"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"base64"</span><span class="token builtin class-name">:</span> <span class="token string">"mvX+tJx602hlN5SW61z3sqMI6bI="</span>, <span class="token string">"subType"</span><span class="token builtin class-name">:</span> <span class="token string">"00"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>, <span class="token string">"keyId"</span><span class="token builtin class-name">:</span> <span class="token number">7165073358986412034</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>

org.apache.kafka.connect.errors.ConnectException: com.mongodb.MongoCommandException: Command failed with error <span class="token number">40415</span> <span class="token punctuation">(</span>Location40415<span class="token punctuation">)</span>: <span class="token string">'BSON field '</span><span class="token variable">$changeStream</span>.allChangesForCluster<span class="token string">' is an unknown field.'</span> on server common1:27017. The full response is <span class="token punctuation">{<!-- --></span><span class="token string">"operationTime"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"<span class="token variable">$timestamp</span>"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"t"</span><span class="token builtin class-name">:</span> <span class="token number">1668869353</span>, <span class="token string">"i"</span><span class="token builtin class-name">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span>, <span class="token string">"ok"</span><span class="token builtin class-name">:</span> <span class="token number">0.0</span>, <span class="token string">"errmsg"</span><span class="token builtin class-name">:</span> <span class="token string">"BSON field '<span class="token variable">$changeStream</span>.allChangesForCluster' is an unknown field."</span>, <span class="token string">"code"</span><span class="token builtin class-name">:</span> <span class="token number">40415</span>, <span class="token string">"codeName"</span><span class="token builtin class-name">:</span> <span class="token string">"Location40415"</span>, <span class="token string">"<span class="token variable">$clusterTime</span>"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"clusterTime"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"<span class="token variable">$timestamp</span>"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"t"</span><span class="token builtin class-name">:</span> <span class="token number">1668869353</span>, <span class="token string">"i"</span><span class="token builtin class-name">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span>, <span class="token string">"signature"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"hash"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"<span class="token variable">$binary</span>"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"base64"</span><span class="token builtin class-name">:</span> <span class="token string">"mvX+tJx602hlN5SW61z3sqMI6bI="</span>, <span class="token string">"subType"</span><span class="token builtin class-name">:</span> <span class="token string">"00"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>, <span class="token string">"keyId"</span><span class="token builtin class-name">:</span> <span class="token number">7165073358986412034</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
Caused by: com.mongodb.MongoCommandException: Command failed with error <span class="token number">40415</span> <span class="token punctuation">(</span>Location40415<span class="token punctuation">)</span>: <span class="token string">'BSON field '</span><span class="token variable">$changeStream</span>.allChangesForCluster<span class="token string">' is an unknown field.'</span> on server common1:27017. The full response is <span class="token punctuation">{<!-- --></span><span class="token string">"operationTime"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"<span class="token variable">$timestamp</span>"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"t"</span><span class="token builtin class-name">:</span> <span class="token number">1668869353</span>, <span class="token string">"i"</span><span class="token builtin class-name">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span>, <span class="token string">"ok"</span><span class="token builtin class-name">:</span> <span class="token number">0.0</span>, <span class="token string">"errmsg"</span><span class="token builtin class-name">:</span> <span class="token string">"BSON field '<span class="token variable">$changeStream</span>.allChangesForCluster' is an unknown field."</span>, <span class="token string">"code"</span><span class="token builtin class-name">:</span> <span class="token number">40415</span>, <span class="token string">"codeName"</span><span class="token builtin class-name">:</span> <span class="token string">"Location40415"</span>, <span class="token string">"<span class="token variable">$clusterTime</span>"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"clusterTime"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"<span class="token variable">$timestamp</span>"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"t"</span><span class="token builtin class-name">:</span> <span class="token number">1668869353</span>, <span class="token string">"i"</span><span class="token builtin class-name">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span>, <span class="token string">"signature"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"hash"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"<span class="token variable">$binary</span>"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"base64"</span><span class="token builtin class-name">:</span> <span class="token string">"mvX+tJx602hlN5SW61z3sqMI6bI="</span>, <span class="token string">"subType"</span><span class="token builtin class-name">:</span> <span class="token string">"00"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>, <span class="token string">"keyId"</span><span class="token builtin class-name">:</span> <span class="token number">7165073358986412034</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>



</code></pre> 
<p>一直以为是版本不匹配，jar冲突，多次调整，排除依赖，耗尽心力，陆陆续续研究了一个多月，从依赖缺少，研究到依赖冲突，从权限问题到自己安装mongodb。其间各种求人，请教，最后的最后。。。。<br> 有幸加入cdc开发者群，开发人员告诉我mongodb-3.6.3不支持changstream的多表监控，我的心啊。。。。。后来人，留着记录给你</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/23fa6788cb12360a5de19b708c9d68c9/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">CentOS7 安装GCC 11</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8fef037c80c386e93fda80ca893c15a1/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">c语言实现三子棋</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>