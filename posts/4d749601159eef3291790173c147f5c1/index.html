<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>finetune一个GPT3模型 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="finetune一个GPT3模型" />
<meta property="og:description" content="过程其实挺简单的，首先得注册一个账号获取token(我是叫在美国的朋友注册了一个)。注册好账号后，有18美金的试用额度，基本可以完成好几次模型训练了。除了模型训练需要收费之外，大概1000个token的费用是0.02美金。
设置好OPENAI_API_KEY这个环境变量。
export OPENAI_API_KEY=&#34;&lt;OPENAI_API_KEY&gt;&#34;
接下来就进入正题了，
1. 准备数据，格式如下，每一行都是一个json，换行用\n表示，我finetune的task只需要1000条左右的数据，模型结果还不错，根据训练时的提示，至少需要100条，越多越好
{&#34;prompt&#34;: &#34;&lt;prompt text&gt;&#34;, &#34;completion&#34;: &#34;&lt;ideal generated text&gt;&#34;} {&#34;prompt&#34;: &#34;&lt;prompt text&gt;&#34;, &#34;completion&#34;: &#34;&lt;ideal generated text&gt;&#34;} {&#34;prompt&#34;: &#34;&lt;prompt text&gt;&#34;, &#34;completion&#34;: &#34;&lt;ideal generated text&gt;&#34;} ... openai提供了现成的命令可以转csv成json: openai tools fine_tunes.prepare_data -f ./train_data.csv
2. 训练，我finetune的是davinci模型，还有三四个选择，输错命令行会提示。我的task只finetune了一个周期，整个过程大概花费1美金，持续约5～10分钟
openai api fine_tunes.create -t ./train_data_prepared.jsonl -m davinci --n_epochs 1
不需要的模型还可以删除
openai api models.delete -i &#34;davinci:ft-personal-2022-11-20-03-40-02&#34; 用如下命令可以列出曾经训练的模型列表
openai api fine_tunes.list 3. api调用，有好几种方法，比如直接
openai api completions.create -m davinci:ft-personal-2022-11-20-04-05-47 -p &#34;Beautiful sunset beach landscape with a boat&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/4d749601159eef3291790173c147f5c1/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-11-25T20:22:05+08:00" />
<meta property="article:modified_time" content="2022-11-25T20:22:05+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">finetune一个GPT3模型</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>过程其实挺简单的，首先得注册一个账号获取token(我是叫在美国的朋友注册了一个)。注册好账号后，有18美金的试用额度，基本可以完成好几次模型训练了。除了模型训练需要收费之外，大概1000个token的费用是0.02美金。</p> 
<p>设置好OPENAI_API_KEY这个环境变量。</p> 
<p>    export OPENAI_API_KEY="&lt;OPENAI_API_KEY&gt;"</p> 
<p>接下来就进入正题了，</p> 
<p>1. 准备数据，格式如下，每一行都是一个json，换行用\n表示，我finetune的task只需要1000条左右的数据，模型结果还不错，根据训练时的提示，至少需要100条，越多越好</p> 
<pre><code class="hljs">{"prompt": "&lt;prompt text&gt;", "completion": "&lt;ideal generated text&gt;"}
{"prompt": "&lt;prompt text&gt;", "completion": "&lt;ideal generated text&gt;"}
{"prompt": "&lt;prompt text&gt;", "completion": "&lt;ideal generated text&gt;"}
...</code></pre> 
<p>openai提供了现成的命令可以转csv成json: openai tools fine_tunes.prepare_data -f ./train_data.csv</p> 
<p>2. 训练，我finetune的是davinci模型，还有三四个选择，输错命令行会提示。我的task只finetune了一个周期，整个过程大概花费1美金，持续约5～10分钟</p> 
<p>openai api fine_tunes.create -t ./train_data_prepared.jsonl -m davinci --n_epochs 1</p> 
<p>不需要的模型还可以删除</p> 
<pre><code class="hljs">openai api models.delete -i "davinci:ft-personal-2022-11-20-03-40-02"</code></pre> 
<p>用如下命令可以列出曾经训练的模型列表</p> 
<pre><code class="hljs">openai api fine_tunes.list</code></pre> 
<p>3. api调用，有好几种方法，比如直接</p> 
<pre><code class="hljs">openai api completions.create -m davinci:ft-personal-2022-11-20-04-05-47 -p "Beautiful sunset beach landscape with a boat"</code></pre> 
<p>我的task还需要设置更多的两个参数temperature和frequency_penalty，所以我写了个简单的脚本完成这个任务，并且openai限制1秒调用超过60次，我加了个简单的sleep。其中有个坑是，推理的时候seperator里的\n，无需过采用"\\"多转义。</p> 
<pre><code class="hljs">import os
import sys
import openai
import json
import time

if not os.path.exists(sys.argv[2]):
    res = openai.Completion.create(
        max_tokens=32,
        model=sys.argv[1],
        prompt=sys.argv[2]+"\n##\n",
        temperature=0.7,
        frequency_penalty=0.1)
    text = res["choices"][0]["text"]
    items = text.split('\n')
    print(sys.argv[2]+"|"+items[0]+"|"+items[2])
else:
    f = open(sys.argv[2])
    lines = [line.strip()[:-2] for line in f.readlines()]
    f.close()

    f = open("./result.txt", "a+")

    for i,line in enumerate(lines):
        print(i, line)

        try:
            res = openai.Completion.create(
                max_tokens=32,
                model=sys.argv[1],
                prompt=line+"\n##\n",
                temperature=0.7,
                frequency_penalty=0.1)
            text = res["choices"][0]["text"]
            items = text.split('\n')
            print(line+"|"+items[0]+"|"+items[2], file=f)
            if i%30 == 0:
                f.flush()
            time.sleep(1.5)
        except Exception as e:
            print(e)
            time.sleep(15)
    f.close()</code></pre> 
<p>参考<a href="https://beta.openai.com/docs/guides/fine-tuning" rel="nofollow" title="OpenAI API">OpenAI API</a></p> 
<p></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0a6af93ea60bd5c6d632be06b9ea9181/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">JS获取上周（自然周、最近七天）、上月（自然月、最近一个月）、全年的开始和结束日期</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3bff69e28f94475ce00ab7b091ab2d23/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">FFmpeg - Android 直播推拉流</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>