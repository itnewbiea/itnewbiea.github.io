<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>单片机：解决一个STM32F4x串口DMA发送的问题 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="单片机：解决一个STM32F4x串口DMA发送的问题" />
<meta property="og:description" content="项目场景： 芯片：STM32F411CEU6和STM32F429IGT6
MDK版本：5,32
HAL库版本：1.27.1
STM32CubeMX版本：6.7.0
问题描述： 在使用DMA的情况下，串口发送的数据不更新，无论发送缓冲区内容是什么都只发送第一次发送的数据。
硬件配置 下面是STM32CubeMX的串口、DMA以及中断配置：
注：USART1的DMA中断开不开效果相同，都会出现上述问题，开了中断记得清除标志位。
问题代码以及错误现象 void UART1_Send_AT_Cmd(char *at_cmd) { char *AT_CMD = at_cmd; int AT_length = strlen(AT_CMD); HAL_UART_Transmit_DMA(&amp;huart1, (const uint8_t *)AT_CMD, AT_length); while(__HAL_DMA_GET_FLAG(&amp;hdma_usart1_tx, DMA_FLAG_TCIF3_7) == SET); __HAL_DMA_CLEAR_FLAG(&amp;hdma_usart1_tx, DMA_FLAG_TCIF3_7); __HAL_DMA_ENABLE(&amp;hdma_usart1_tx); //使能串口DMA发送 } //定义全局变量或者局部变量是一样 的效果 char a* = &#34;ccc&#34;; char b* = &#34;aaa&#34;; int main(void) { //省略CubeMX生成的初始化 UART1_Send_AT_Cmd(a); //HAL_Delay(500); //延时加不加也是同样的问题 UART1_Send_AT_Cmd(b); while(1) { UART1_Send_AT_Cmd(a); //HAL_Delay(500); //延时加不加也是同样的问题 UART1_Send_AT_Cmd(b); HAL_Delay(500); HAL_GPIO_TogglePin(GPIOC, GPIO_PIN_13);//这条的目的是检查是不是发生了中断，或者发生中断没有清除标志位 HAL_Delay(500); } } 串口助手的现象
一直发送*a的字符，*b的字符看都看不到，而且灯也在闪烁，说明DMA发送是正常的，芯片工作也是正常的。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/f4f40e351dccb4bc1ade21e32479f052/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-01-10T12:11:20+08:00" />
<meta property="article:modified_time" content="2023-01-10T12:11:20+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">单片机：解决一个STM32F4x串口DMA发送的问题</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>项目场景：</h2> 
<blockquote> 
 <p>芯片：STM32F411CEU6和STM32F429IGT6<br> MDK版本：5,32<br> HAL库版本：1.27.1<br> STM32CubeMX版本：6.7.0</p> 
</blockquote> 
<hr> 
<h2><a id="_6"></a>问题描述：</h2> 
<p><strong>在使用DMA的情况下，串口发送的数据不更新，无论发送缓冲区内容是什么都只发送第一次发送的数据。</strong></p> 
<h3><a id="_8"></a>硬件配置</h3> 
<p>下面是STM32CubeMX的串口、DMA以及中断配置：<br> <img src="https://images2.imgbox.com/4f/12/QBiqVLo6_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/4d/6b/H43wJxdL_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/c0/fc/4PO780i1_o.png" alt="在这里插入图片描述"><br> <strong>注：USART1的DMA中断开不开效果相同，都会出现上述问题，开了中断记得清除标志位。</strong></p> 
<h3><a id="_15"></a>问题代码以及错误现象</h3> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">UART1_Send_AT_Cmd</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>at_cmd<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">char</span> <span class="token operator">*</span>AT_CMD <span class="token operator">=</span> at_cmd<span class="token punctuation">;</span>
  <span class="token keyword">int</span> AT_length <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>AT_CMD<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">HAL_UART_Transmit_DMA</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>AT_CMD<span class="token punctuation">,</span> AT_length<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">__HAL_DMA_GET_FLAG</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hdma_usart1_tx<span class="token punctuation">,</span> DMA_FLAG_TCIF3_7<span class="token punctuation">)</span> <span class="token operator">==</span> SET<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">__HAL_DMA_CLEAR_FLAG</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hdma_usart1_tx<span class="token punctuation">,</span> DMA_FLAG_TCIF3_7<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">__HAL_DMA_ENABLE</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hdma_usart1_tx<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//使能串口DMA发送</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-c"><span class="token comment">//定义全局变量或者局部变量是一样 的效果</span>
<span class="token keyword">char</span> a<span class="token operator">*</span> <span class="token operator">=</span> <span class="token string">"ccc"</span><span class="token punctuation">;</span> 
<span class="token keyword">char</span> b<span class="token operator">*</span> <span class="token operator">=</span> <span class="token string">"aaa"</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//省略CubeMX生成的初始化</span>
	<span class="token function">UART1_Send_AT_Cmd</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//HAL_Delay(500); //延时加不加也是同样的问题</span>
	<span class="token function">UART1_Send_AT_Cmd</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">UART1_Send_AT_Cmd</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//HAL_Delay(500); //延时加不加也是同样的问题</span>
		<span class="token function">UART1_Send_AT_Cmd</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">HAL_Delay</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token function">HAL_GPIO_TogglePin</span><span class="token punctuation">(</span>GPIOC<span class="token punctuation">,</span> GPIO_PIN_13<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//这条的目的是检查是不是发生了中断，或者发生中断没有清除标志位</span>
      	<span class="token function">HAL_Delay</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>串口助手的现象<br> <img src="https://images2.imgbox.com/44/d4/v5ZdB3FP_o.png" alt="在这里插入图片描述"><br> 一直发送*a的字符，*b的字符看都看不到，而且灯也在闪烁，说明DMA发送是正常的，芯片工作也是正常的。</p> 
<hr> 
<h2><a id="_58"></a>解决方案：</h2> 
<blockquote> 
 <p>解决方案十分简单，只需要在发送前将DMA停止，HAL_UART_DMAStop(&amp;huart1);加一句这个。<br> 把UART1_Send_AT_Cmd函数改成下面这样，问题就完全解决了。</p> 
</blockquote> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">UART1_Send_AT_Cmd</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>at_cmd<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">char</span> <span class="token operator">*</span>AT_CMD <span class="token operator">=</span> at_cmd<span class="token punctuation">;</span>
  <span class="token keyword">int</span> AT_length <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>AT_CMD<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">HAL_UART_DMAStop</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">HAL_UART_Transmit_DMA</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>AT_CMD<span class="token punctuation">,</span> AT_length<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">__HAL_DMA_GET_FLAG</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hdma_usart1_tx<span class="token punctuation">,</span> DMA_FLAG_TCIF3_7<span class="token punctuation">)</span> <span class="token operator">==</span> SET<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">__HAL_DMA_CLEAR_FLAG</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hdma_usart1_tx<span class="token punctuation">,</span> DMA_FLAG_TCIF3_7<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">__HAL_DMA_ENABLE</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hdma_usart1_tx<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//使能串口DMA发送</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="_76"></a>原因分析(不严谨且不一定对)：</h2> 
<blockquote> 
 <p>简单分析下问题，LED灯闪烁并且串口助手收到数据，说明DMA发送没有问题，那么问题应该出在了串口，经过Debug，发现串口以及DMA的状态是正常更新而且发送数据的指针正常传送入串口DMA发送函数。查看HAL_UART_DMAStop函数发现这个函数清楚了USART的CR3寄存器，原因可能在这里。</p> 
</blockquote> 
<hr> 
<p>至此内容结束，如有错误，请评论指出。</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/fbc29a21ad4117ba44202ad710d49f86/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">BigDecimal使用小结</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9fb3a0b4f7c768fed1b902dde266a5a3/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">C语言基础一小时复习</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>