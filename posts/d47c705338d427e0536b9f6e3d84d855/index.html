<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>CUBEMX  STM32F105RB  U盘读写详细教程 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="CUBEMX  STM32F105RB  U盘读写详细教程" />
<meta property="og:description" content="CUBEMX STM32F105RB U盘读写详细教程
abin 42817001
打开cubemx软件， 2.选择单片机型号，本文选stm32f105rb
3.设置RCC，
4.设置时钟
1 根据开发板选外部晶振，一般是8Mhz。
2 选通外部晶振通道，由于ubs要使用48Mhz频率，内部频率无法提供
3工具单片机选择主频，
1 2 3步骤无先后顺序，
5.选择调试端口，这里使用UART2,可以根据需要选择其他的uart
6.配置USB顺序
检查usb时钟是否是48Mhz，一般软件会自动设置好。
Host 设置 见usbh_conf.h 65-90行
7.设置PC9脚输出
由于本开发板的usb通过PC9低电平导通三极管给usb供电，所以要另外设置PC9脚， 如与本板不同可忽略本步骤。
8.管脚布局查看
9.PROJECT配置
10.点击软件界面的右上角的 产生代码，可能会出现一个警告窗口，不必理会，点YES 软件会自动生成KEIL需要的相关工程文件，点打开工程，然后就自动打开KEIL，
11.Keil 操作
12.Cubemx生成的main.c还不能直接使用，要定义变量 回调函数 USB操作函数等
代码要保存在cubemx设定好的用户代码区域，如果硬件变动生成新代码，用户自定义的代码就会保留。
13.下面是main.c修改后的文件，红色部分是增加的内容，其他文件不需修改
/* USER CODE BEGIN Header */
/**
******************************************************************************
* @file : main.c
* @brief : Main program body
******************************************************************************
* @attention
*
* &lt;h2&gt;&lt;center&gt;&amp;copy; Copyright (c) 2019 STMicroelectronics.
* All rights reserved." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/d47c705338d427e0536b9f6e3d84d855/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-11-09T14:51:17+08:00" />
<meta property="article:modified_time" content="2019-11-09T14:51:17+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">CUBEMX  STM32F105RB  U盘读写详细教程</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p style="margin-left:0cm;">CUBEMX  STM32F105RB  U盘读写详细教程</p> 
<p style="margin-left:0cm;">abin 42817001</p> 
<ol><li>打开cubemx软件，</li></ol> 
<p style="margin-left:0cm;"> <img alt="" class="has" height="628" src="https://images2.imgbox.com/4a/9c/QDNvpjgu_o.png" width="424"></p> 
<p style="margin-left:0cm;"> </p> 
<p>2.选择单片机型号，本文选stm32f105rb</p> 
<p>3.设置RCC，</p> 
<p style="margin-left:0cm;"><img alt="" class="has" height="532" src="https://images2.imgbox.com/43/23/LcrlbY1Y_o.png" width="652"></p> 
<p style="margin-left:0cm;">4.设置时钟</p> 
<p style="margin-left:0cm;"><img alt="" class="has" height="647" src="https://images2.imgbox.com/ff/63/COJs7Azd_o.png" width="849"></p> 
<p style="margin-left:0cm;">1 根据开发板选外部晶振，一般是8Mhz。</p> 
<p style="margin-left:0cm;"> 2 选通外部晶振通道，由于ubs要使用48Mhz频率，内部频率无法提供</p> 
<p style="margin-left:0cm;"> 3工具单片机选择主频，</p> 
<p style="margin-left:0cm;">1  2  3步骤无先后顺序，</p> 
<p>5.选择调试端口，这里使用UART2,可以根据需要选择其他的uart</p> 
<p style="margin-left:0cm;"><img alt="" class="has" height="519" src="https://images2.imgbox.com/b5/d2/BZlNokSy_o.png" width="700"></p> 
<p style="margin-left:0cm;">6.配置USB顺序</p> 
<p style="margin-left:0cm;"><img alt="" class="has" height="622" src="https://images2.imgbox.com/10/4a/WTxOjrU5_o.png" width="143"></p> 
<p style="margin-left:0cm;"><img alt="" class="has" height="571" src="https://images2.imgbox.com/e9/f4/akOSu9kg_o.png" width="680"></p> 
<p style="margin-left:0cm;">检查usb时钟是否是48Mhz，一般软件会自动设置好。</p> 
<p style="margin-left:0cm;"><img alt="" class="has" height="523" src="https://images2.imgbox.com/ee/4a/buCosk5L_o.png" width="869"></p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;"><img alt="" class="has" height="634" src="https://images2.imgbox.com/a2/4e/53SvGSCb_o.png" width="718"></p> 
<p style="margin-left:0cm;">Host 设置 见usbh_conf.h  65-90行</p> 
<p style="margin-left:0cm;"><img alt="" class="has" height="445" src="https://images2.imgbox.com/70/84/l4x6WbZO_o.png" width="475"></p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;"><img alt="" class="has" height="668" src="https://images2.imgbox.com/2a/a5/Pe4xcxJX_o.png" width="886"></p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;"> </p> 
<p>7.设置PC9脚输出</p> 
<p style="margin-left:0cm;">由于本开发板的usb通过PC9低电平导通三极管给usb供电，所以要另外设置PC9脚， 如与本板不同可忽略本步骤。</p> 
<p>8.管脚布局查看</p> 
<p style="margin-left:0cm;"><img alt="" class="has" height="576" src="https://images2.imgbox.com/e9/24/WLgGxe4P_o.png" width="673"></p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;"><img alt="" class="has" height="441" src="https://images2.imgbox.com/d3/1c/UzO6WNdX_o.png" width="798"></p> 
<p style="margin-left:0cm;">9.PROJECT配置</p> 
<p style="margin-left:0cm;"><img alt="" class="has" height="566" src="https://images2.imgbox.com/32/ec/DsEMFWO3_o.png" width="1063"></p> 
<p style="margin-left:0cm;"><img alt="" class="has" height="694" src="https://images2.imgbox.com/a3/a6/XAlJqWXM_o.png" width="1057">10.点击软件界面的右上角的<img alt="" class="has" height="47" src="https://images2.imgbox.com/87/fc/NdgnN1QS_o.png" width="176"> 产生代码，可能会出现一个警告窗口，不必理会，点YES </p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;"><img alt="" class="has" height="359" src="https://images2.imgbox.com/c1/99/1wuh0PTE_o.png" width="604"></p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">软件会自动生成KEIL需要的相关工程文件，点打开工程，然后就自动打开KEIL，</p> 
<p style="margin-left:0cm;"><img alt="" class="has" height="334" src="https://images2.imgbox.com/4d/2e/aBCWw6jT_o.png" width="968"></p> 
<p style="margin-left:0cm;"> </p> 
<p>11.Keil 操作</p> 
<p style="margin-left:0cm;"><img alt="" class="has" height="790" src="https://images2.imgbox.com/a0/04/AHX0DltB_o.png" width="831"></p> 
<p style="margin-left:0cm;"> </p> 
<p>12.Cubemx生成的main.c还不能直接使用，要定义变量 回调函数 USB操作函数等</p> 
<p style="margin-left:0cm;">代码要保存在cubemx设定好的用户代码区域，如果硬件变动生成新代码，用户自定义的代码就会保留。</p> 
<p style="margin-left:0cm;"> </p> 
<p>13.下面是main.c修改后的文件，红色部分是增加的内容，其他文件不需修改</p> 
<p style="margin-left:0cm;">/* USER CODE BEGIN Header */</p> 
<p style="margin-left:0cm;">/**</p> 
<p style="margin-left:0cm;">  ******************************************************************************</p> 
<p style="margin-left:0cm;">  * @file           : main.c</p> 
<p style="margin-left:0cm;">  * @brief          : Main program body</p> 
<p style="margin-left:0cm;">  ******************************************************************************</p> 
<p style="margin-left:0cm;">  * @attention</p> 
<p style="margin-left:0cm;">  *</p> 
<p style="margin-left:0cm;">  * &lt;h2&gt;&lt;center&gt;&amp;copy; Copyright (c) 2019 STMicroelectronics.</p> 
<p style="margin-left:0cm;">  * All rights reserved.&lt;/center&gt;&lt;/h2&gt;</p> 
<p style="margin-left:0cm;">  *</p> 
<p style="margin-left:0cm;">  * This software component is licensed by ST under Ultimate Liberty license</p> 
<p style="margin-left:0cm;">  * SLA0044, the "License"; You may not use this file except in compliance with</p> 
<p style="margin-left:0cm;">  * the License. You may obtain a copy of the License at:</p> 
<p style="margin-left:0cm;">  *                             www.st.com/SLA0044</p> 
<p style="margin-left:0cm;">  *</p> 
<p style="margin-left:0cm;">  ******************************************************************************</p> 
<p style="margin-left:0cm;">  */</p> 
<p style="margin-left:0cm;">/* USER CODE END Header */</p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">/* Includes ------------------------------------------------------------------*/</p> 
<p style="margin-left:0cm;">#include "main.h"</p> 
<p style="margin-left:0cm;">#include "fatfs.h"</p> 
<p style="margin-left:0cm;">#include "usart.h"</p> 
<p style="margin-left:0cm;">#include "usb_host.h"</p> 
<p style="margin-left:0cm;">#include "gpio.h"</p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">/* Private includes ----------------------------------------------------------*/</p> 
<p style="margin-left:0cm;">/* USER CODE BEGIN Includes */</p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">/* USER CODE END Includes */</p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">/* Private typedef -----------------------------------------------------------*/</p> 
<p style="margin-left:0cm;">/* USER CODE BEGIN PTD */</p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">/* USER CODE END PTD */</p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">/* Private define ------------------------------------------------------------*/</p> 
<p style="margin-left:0cm;">/* USER CODE BEGIN PD */</p> 
<p style="margin-left:0cm;">/* USER CODE END PD */</p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">/* Private macro -------------------------------------------------------------*/</p> 
<p style="margin-left:0cm;">/* USER CODE BEGIN PM */</p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">//</span><span style="color:#ff0000;">定义</span><span style="color:#ff0000;">PC9</span><span style="color:#ff0000;">脚，如不需要可取消</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">#define USB_POWER_Pin GPIO_PIN_9</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">#define USB_POWER_GPIO_Port GPIOC</span></p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">/* USER CODE END PM */</p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">/* Private variables ---------------------------------------------------------*/</p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">/* USER CODE BEGIN PV */</p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">/* USER CODE END PV */</p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">/* Private function prototypes -----------------------------------------------*/</p> 
<p style="margin-left:0cm;">void SystemClock_Config(void);</p> 
<p style="margin-left:0cm;">void MX_USB_HOST_Process(void);</p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">/* USER CODE BEGIN PFP */</p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">FATFS USBDISKFatFs;           /* File system object for USB disk logical drive */</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">FIL MyFile;                   /* File object */</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">extern ApplicationTypeDef Appli_state;</span></p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">/* USER CODE END PFP */</p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">/* Private user code ---------------------------------------------------------*/</p> 
<p style="margin-left:0cm;">/* USER CODE BEGIN 0 */</p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">//</span><span style="color:#ff0000;">下面</span><span style="color:#ff0000;">2</span><span style="color:#ff0000;">个函数</span> <span style="color:#ff0000;">使能、禁止</span><span style="color:#ff0000;">HCD_Port</span><span style="color:#ff0000;">的回调函数，勿修改，必须</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">/**</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">* @brief  Port Port Enabled callback.</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  * @param  hhcd: HCD handle</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  * @retval None</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  */</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">void HAL_HCD_PortEnabled_Callback(HCD_HandleTypeDef *hhcd)</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">{<!-- --></span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  USBH_LL_PortEnabled(hhcd-&gt;pData);</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">} </span></p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">/**</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  * @brief  Port Port Disabled callback.</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  * @param  hhcd: HCD handle</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  * @retval None</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  */</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">void HAL_HCD_PortDisabled_Callback(HCD_HandleTypeDef *hhcd)</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">{<!-- --></span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  USBH_LL_PortDisabled(hhcd-&gt;pData);</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">} </span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">/**</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  * @brief  Main routine for Mass Storage Class</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  * @param  None</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  * @retval None</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  */</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">//</span><span style="color:#ff0000;">下面函数操作</span><span style="color:#ff0000;">USB </span><span style="color:#ff0000;">文件读写，可根据需要修改，函数名可自定义</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">void MSC_Application(void)</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">{<!-- --></span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  /* FatFs function common result code description: */</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">    /*  FR_OK = 0,                (0) Succeeded */</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">    /*  FR_DISK_ERR,              (1) A hard error occurred in the low level disk I/O layer */</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">    /*  FR_INT_ERR,               (2) Assertion failed */</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">    /*  FR_NOT_READY,             (3) The physical drive cannot work */</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">    /*  FR_NO_FILE,               (4) Could not find the file */</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">    /*  FR_NO_PATH,               (5) Could not find the path */</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">    /*  FR_INVALID_NAME,          (6) The path name format is invalid */</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">    /*  FR_DENIED,                (7) Access denied due to prohibited access or directory full */</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">    /*  FR_EXIST,                 (8) Access denied due to prohibited access */</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">    /*  FR_INVALID_OBJECT,        (9) The file/directory object is invalid */</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">    /*  FR_WRITE_PROTECTED,       (10) The physical drive is write protected */</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">    /*  FR_INVALID_DRIVE,         (11) The logical drive number is invalid */</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">    /*  FR_NOT_ENABLED,           (12) The volume has no work area */</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">    /*  FR_NO_FILESYSTEM,         (13) There is no valid FAT volume */</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">    /*  FR_MKFS_ABORTED,          (14) The f_mkfs() aborted due to any parameter error */</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">    /*  FR_TIMEOUT,               (15) Could not get a grant to access the volume within defined period */</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">    /*  FR_LOCKED,                (16) The operation is rejected according to thex file sharing policy */</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">    /*  FR_NOT_ENOUGH_CORE,       (17) LFN working buffer could not be allocated */</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">    /*  FR_TOO_MANY_OPEN_FILES,   (18) Number of open files &gt; _FS_SHARE */</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">    /*  FR_INVALID_PARAMETER      (19) Given parameter is invalid */</span></p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  FRESULT res;                                          /* FatFs function common result code */</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  uint32_t byteswritten, bytesread;                     /* File write/read counts */</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  uint8_t wtext[] = "Hello Test USB!";                     /* File write buffer */</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  uint8_t rtext[100];                                   /* File read buffer */</span></p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  /* Register the file system object to the FatFs module */</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  res = f_mount(&amp;USBDISKFatFs, (TCHAR const*)USBHPath, 0);</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  if(res != FR_OK)  </span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  {<!-- --></span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">    /* FatFs Initialization Error */</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">    USBH_UsrLog("f_mount error: %d", res);</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">    Error_Handler();</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  } </span></p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  USBH_UsrLog("create the file in: %s", USBHPath);</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  /* Create and Open a new text file object with write access */</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  res = f_open(&amp;MyFile, "USBHost.txt", FA_CREATE_ALWAYS | FA_WRITE);</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  if(res != FR_OK) </span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  {<!-- --></span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">    /* 'hello.txt' file Open for write Error */</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">    USBH_UsrLog("f_open with write access error: %d", res);</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">    Error_Handler();</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  }</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  /* Write data to the text file */</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  res = f_write(&amp;MyFile, wtext, sizeof(wtext), (void *)&amp;byteswritten);</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  if((byteswritten == 0) || (res != FR_OK)) </span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  {<!-- --></span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">    /* 'hello.txt' file Write or EOF Error */</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">    USBH_UsrLog("file write or EOF error: %d", res);</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">    Error_Handler();</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  }</span></p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  /* Close the open text file */</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  f_close(&amp;MyFile);</span></p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  /* Open the text file object with read access */</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  res = f_open(&amp;MyFile, "USBHost.txt", FA_READ);</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  if(res != FR_OK) </span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  {<!-- --></span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">    /* 'hello.txt' file Open for read Error */</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">    USBH_UsrLog("f_open with read access error: %d", res);</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">    Error_Handler();</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  }</span></p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  /* Read data from the text file */</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  res = f_read(&amp;MyFile, rtext, sizeof(rtext), (void *)&amp;bytesread);</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  if((bytesread == 0) || (res != FR_OK)) </span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  {<!-- --></span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">    /* 'hello.txt' file Read or EOF Error */</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">    USBH_UsrLog("f_read error: %d", res);</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">    Error_Handler();</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  }</span></p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  /* Close the open text file */</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  f_close(&amp;MyFile);</span></p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  /* Compare read data with the expected data */</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  if((bytesread != byteswritten))</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  {                </span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">    /* Read data is different from the expected data */</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">    USBH_UsrLog("file doesn't match");</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">    Error_Handler();</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  }</span></p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  /* Success of the demo: no error occurrence */</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  USBH_UsrLog("USBHost.txt was created into the disk");</span></p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  /* Unlink the USB disk I/O driver */</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">  FATFS_UnLinkDriver(USBHPath);</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">}</span></p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">/* USER CODE END 0 */</p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">/**</p> 
<p style="margin-left:0cm;">  * @brief  The application entry point.</p> 
<p style="margin-left:0cm;">  * @retval int</p> 
<p style="margin-left:0cm;">  */</p> 
<p style="margin-left:0cm;">int main(void)</p> 
<p style="margin-left:0cm;">{<!-- --></p> 
<p style="margin-left:0cm;">  /* USER CODE BEGIN 1 */</p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">  /* USER CODE END 1 */</p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">  /* MCU Configuration--------------------------------------------------------*/</p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">  /* Reset of all peripherals, Initializes the Flash interface and the Systick. */</p> 
<p style="margin-left:0cm;">  HAL_Init();</p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">  /* USER CODE BEGIN Init */</p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">  /* USER CODE END Init */</p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">  /* Configure the system clock */</p> 
<p style="margin-left:0cm;">  SystemClock_Config();</p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">  /* USER CODE BEGIN SysInit */</p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">  /* USER CODE END SysInit */</p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">  /* Initialize all configured peripherals */</p> 
<p style="margin-left:0cm;">  MX_GPIO_Init();</p> 
<p style="margin-left:0cm;">  MX_USART2_UART_Init();</p> 
<p style="margin-left:0cm;">  MX_FATFS_Init();</p> 
<p style="margin-left:0cm;">  MX_USB_HOST_Init();</p> 
<p style="margin-left:0cm;">  /* USER CODE BEGIN 2 */</p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">//</span><span style="color:#ff0000;">拉低</span><span style="color:#ff0000;">PC9</span><span style="color:#ff0000;">，如无该设置可取消</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">HAL_GPIO_WritePin(USB_POWER_GPIO_Port, USB_POWER_Pin, GPIO_PIN_RESET);</span></p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">  /* USER CODE END 2 */</p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">  /* Infinite loop */</p> 
<p style="margin-left:0cm;">  /* USER CODE BEGIN WHILE */</p> 
<p style="margin-left:0cm;">printf("STM32 start ok!\n");</p> 
<p style="margin-left:0cm;">  while (1)</p> 
<p style="margin-left:0cm;">  {<!-- --></p> 
<p style="margin-left:0cm;">    /* USER CODE END WHILE */</p> 
<p style="margin-left:0cm;">    MX_USB_HOST_Process();</p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">    /* USER CODE BEGIN 3 */</p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">//</span><span style="color:#ff0000;">判断</span><span style="color:#ff0000;">USB</span><span style="color:#ff0000;">是否进入准备状态</span><span style="color:#ff0000;">APPLICATION_READY</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">switch(Appli_state)</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">    {<!-- --></span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">      /**</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">        * The generated code from STM32CubeMX has two "confusing" application states </span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">        * APPLICATION_START on HOST_USER_CONNECTION and APPLICATION_READY on HOST_USER_CLASS_ACTIVE. </span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">        * Any FatFs commands should be executed after APPLICATION_STATE_READY is reached."</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">        */</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">      case APPLICATION_READY:</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">        printf("ready ok\n");</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">      MSC_Application();</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">        Appli_state = APPLICATION_IDLE;</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">        break;</span></p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">      case APPLICATION_IDLE:</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">      default:</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">        break;      </span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">    }</span></p> 
<p style="margin-left:0cm;">     </p> 
<p style="margin-left:0cm;">  }</p> 
<p style="margin-left:0cm;">  /* USER CODE END 3 */</p> 
<p style="margin-left:0cm;">}</p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">/**</p> 
<p style="margin-left:0cm;">  * @brief System Clock Configuration</p> 
<p style="margin-left:0cm;">  * @retval None</p> 
<p style="margin-left:0cm;">  */</p> 
<p style="margin-left:0cm;">void SystemClock_Config(void)</p> 
<p style="margin-left:0cm;">{<!-- --></p> 
<p style="margin-left:0cm;">  RCC_OscInitTypeDef RCC_OscInitStruct = {0};</p> 
<p style="margin-left:0cm;">  RCC_ClkInitTypeDef RCC_ClkInitStruct = {0};</p> 
<p style="margin-left:0cm;">  RCC_PeriphCLKInitTypeDef PeriphClkInit = {0};</p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">  /** Initializes the CPU, AHB and APB busses clocks</p> 
<p style="margin-left:0cm;">  */</p> 
<p style="margin-left:0cm;">  RCC_OscInitStruct.OscillatorType = RCC_OSCILLATORTYPE_HSE;</p> 
<p style="margin-left:0cm;">  RCC_OscInitStruct.HSEState = RCC_HSE_ON;</p> 
<p style="margin-left:0cm;">  RCC_OscInitStruct.HSEPredivValue = RCC_HSE_PREDIV_DIV1;</p> 
<p style="margin-left:0cm;">  RCC_OscInitStruct.HSIState = RCC_HSI_ON;</p> 
<p style="margin-left:0cm;">  RCC_OscInitStruct.Prediv1Source = RCC_PREDIV1_SOURCE_HSE;</p> 
<p style="margin-left:0cm;">  RCC_OscInitStruct.PLL.PLLState = RCC_PLL_ON;</p> 
<p style="margin-left:0cm;">  RCC_OscInitStruct.PLL.PLLSource = RCC_PLLSOURCE_HSE;</p> 
<p style="margin-left:0cm;">  RCC_OscInitStruct.PLL.PLLMUL = RCC_PLL_MUL9;</p> 
<p style="margin-left:0cm;">  RCC_OscInitStruct.PLL2.PLL2State = RCC_PLL_NONE;</p> 
<p style="margin-left:0cm;">  if (HAL_RCC_OscConfig(&amp;RCC_OscInitStruct) != HAL_OK)</p> 
<p style="margin-left:0cm;">  {<!-- --></p> 
<p style="margin-left:0cm;">    Error_Handler();</p> 
<p style="margin-left:0cm;">  }</p> 
<p style="margin-left:0cm;">  /** Initializes the CPU, AHB and APB busses clocks</p> 
<p style="margin-left:0cm;">  */</p> 
<p style="margin-left:0cm;">  RCC_ClkInitStruct.ClockType = RCC_CLOCKTYPE_HCLK|RCC_CLOCKTYPE_SYSCLK</p> 
<p style="margin-left:0cm;">                              |RCC_CLOCKTYPE_PCLK1|RCC_CLOCKTYPE_PCLK2;</p> 
<p style="margin-left:0cm;">  RCC_ClkInitStruct.SYSCLKSource = RCC_SYSCLKSOURCE_PLLCLK;</p> 
<p style="margin-left:0cm;">  RCC_ClkInitStruct.AHBCLKDivider = RCC_SYSCLK_DIV1;</p> 
<p style="margin-left:0cm;">  RCC_ClkInitStruct.APB1CLKDivider = RCC_HCLK_DIV2;</p> 
<p style="margin-left:0cm;">  RCC_ClkInitStruct.APB2CLKDivider = RCC_HCLK_DIV1;</p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">  if (HAL_RCC_ClockConfig(&amp;RCC_ClkInitStruct, FLASH_LATENCY_2) != HAL_OK)</p> 
<p style="margin-left:0cm;">  {<!-- --></p> 
<p style="margin-left:0cm;">    Error_Handler();</p> 
<p style="margin-left:0cm;">  }</p> 
<p style="margin-left:0cm;">  PeriphClkInit.PeriphClockSelection = RCC_PERIPHCLK_USB;</p> 
<p style="margin-left:0cm;">  PeriphClkInit.UsbClockSelection = RCC_USBCLKSOURCE_PLL_DIV3;</p> 
<p style="margin-left:0cm;">  if (HAL_RCCEx_PeriphCLKConfig(&amp;PeriphClkInit) != HAL_OK)</p> 
<p style="margin-left:0cm;">  {<!-- --></p> 
<p style="margin-left:0cm;">    Error_Handler();</p> 
<p style="margin-left:0cm;">  }</p> 
<p style="margin-left:0cm;">  /** Configure the Systick interrupt time</p> 
<p style="margin-left:0cm;">  */</p> 
<p style="margin-left:0cm;">  __HAL_RCC_PLLI2S_ENABLE();</p> 
<p style="margin-left:0cm;">}</p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">/* USER CODE BEGIN 4 */</p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">//##############</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">//USB</span><span style="color:#ff0000;">调试信息输出要用到</span><span style="color:#ff0000;">printf</span><span style="color:#ff0000;">，必须设置</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">//</span><span style="color:#ff0000;">如果</span><span style="color:#ff0000;">printf</span><span style="color:#ff0000;">不能使用，需</span><span style="color:#ff0000;">#include &lt;stdio.h&gt;</span><span style="color:#ff0000;">，如使用</span><span style="color:#00b050;">UART1</span><span style="color:#ff0000;">,</span><span style="color:#ff0000;">则下面的</span><span style="color:#00b050;">huart2</span><span style="color:#ff0000;">要改成</span><span style="color:#00b050;">huart1</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">/* fputc */</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">int fputc(int ch, FILE *f)</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;"> {<!-- --></span></p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">HAL_UART_Transmit(&amp;</span><span style="color:#00b050;">huart2</span><span style="color:#ff0000;"> , (uint8_t *)&amp;ch, 1 , 0xffff);</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">while (</span><span style="color:#00b050;">huart2</span><span style="color:#ff0000;">.gState != HAL_UART_STATE_READY);//Loop until the end of transmission </span><span style="color:#ff0000;">每个发送都值得优化</span></p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">return ch;</span></p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">}</span></p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">/* USER CODE END 4 */</p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">/**</p> 
<p style="margin-left:0cm;">  * @brief  This function is executed in case of error occurrence.</p> 
<p style="margin-left:0cm;">  * @retval None</p> 
<p style="margin-left:0cm;">  */</p> 
<p style="margin-left:0cm;">void Error_Handler(void)</p> 
<p style="margin-left:0cm;">{<!-- --></p> 
<p style="margin-left:0cm;">  /* USER CODE BEGIN Error_Handler_Debug */</p> 
<p style="margin-left:0cm;">  /* User can add his own implementation to report the HAL error return state */</p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">  /* USER CODE END Error_Handler_Debug */</p> 
<p style="margin-left:0cm;">}</p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">#ifdef  USE_FULL_ASSERT</p> 
<p style="margin-left:0cm;">/**</p> 
<p style="margin-left:0cm;">  * @brief  Reports the name of the source file and the source line number</p> 
<p style="margin-left:0cm;">  *         where the assert_param error has occurred.</p> 
<p style="margin-left:0cm;">  * @param  file: pointer to the source file name</p> 
<p style="margin-left:0cm;">  * @param  line: assert_param error line source number</p> 
<p style="margin-left:0cm;">  * @retval None</p> 
<p style="margin-left:0cm;">  */</p> 
<p style="margin-left:0cm;">void assert_failed(uint8_t *file, uint32_t line)</p> 
<p style="margin-left:0cm;">{<!-- --></p> 
<p style="margin-left:0cm;">  /* USER CODE BEGIN 6 */</p> 
<p style="margin-left:0cm;">  /* User can add his own implementation to report the file name and line number,</p> 
<p style="margin-left:0cm;">     tex: printf("Wrong parameters value: file %s on line %d\r\n", file, line) */</p> 
<p style="margin-left:0cm;">  /* USER CODE END 6 */</p> 
<p style="margin-left:0cm;">}</p> 
<p style="margin-left:0cm;">#endif /* USE_FULL_ASSERT */</p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">/************************ (C) COPYRIGHT STMicroelectronics *****END OF FILE****/</p> 
<p style="margin-left:0cm;"> </p> 
<p>14.程序运行结果如下（启动后插上U盘，然后拔出U盘）。</p> 
<p style="margin-left:0cm;"><span style="color:#ff0000;">由于</span><span style="color:#ff0000;">FATFS</span><span style="color:#ff0000;">系统版本不同，可能有些</span><span style="color:#ff0000;">U</span><span style="color:#ff0000;">盘无法识别。比如</span><span style="color:#ff0000;">3.0 U</span><span style="color:#ff0000;">盘</span></p> 
<ol><li>是MX_USB_HOST_Process(); 函数产生的信息</li><li>是 void MSC_Application(void)  输出的内容</li></ol> 
<p style="margin-left:0cm;"><img alt="" class="has" height="586" src="https://images2.imgbox.com/82/c5/gpHfRngQ_o.png" width="560"></p> 
<p style="margin-left:0cm;"> </p> 
<p>15.网友介绍F407可以直接使用CUBEMX生成的文件，无需修改。使用F407的朋友可自行验证。</p> 
<p>16.本文内容在STM32F105RB + cubemx5.4 + keilMDK5.2 + J-LINK V8.0调试通过。</p> 
<p>17.本文由abin  42817001整理，</p> 
<p>18.感谢 @厦门-电梯-窝瓜(892219846) @大拇指[em]IT(2571393392)   指点、解惑。</p> 
<p>19.完成时间 <span style="color:#f33b45;">2011.09</span>   补充：日期有误，实为<span style="color:#f33b45;">2019.09</span></p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">cubemx+keil 源码 下载地址 <a href="https://download.csdn.net/download/silno/11967893">https://download.csdn.net/download/silno/11967893</a></p> 
<p style="margin-left:0cm;"> </p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4639d37afb267129775dc01b8f95d8f6/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">mysql 插入中文字段报错 &#34;Incorrect string value: &#39;\\xE6\\xB5\\x8B\\xE8\\xAF\\x95...&#39; for column &#39;title&#39; at ro</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/84182ce6f7abed9f2e44e3a8ce65d7e5/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Duplicate keys detected: &#39;[object Object]&#39;. This may cause an update error.问题解决</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>