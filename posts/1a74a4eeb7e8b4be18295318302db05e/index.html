<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>STM32F103x学习笔记（1）—— IAP应用编程 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="STM32F103x学习笔记（1）—— IAP应用编程" />
<meta property="og:description" content="IAP应用编程 1、IAP简介 IAP是In Application Programming的首字母缩写，IAP是用户自己的程序在运行过程中对User Flash的部分区域进行烧写，目的是为了在产品发布后可以方便地通过预留的通信口对产品中的固件程序进行更新升级。
2、STM32内置Flash 1、STM32内部FLASH的起始地址为0X08000000,Bootloader程序文件就从此地址开始写入，存放APP程序的首地址设置在紧跟Bootloader之后。当程序开始执行时，首先运行的是Bootloader程序，然后Bootloader收到BIN文件并将其复制到APP区域使固件得以更新,固件更新结束后还需要跳转到APP程序开始执行新的程序,完成这最后这一步要了解Cortex-M3的中断向量表。
2、程序启动后，将首先从“中断向量表”取出复位中断向量执行复位中断程序完成启动，当复位中断程序运行完成后才跳转到main函数。由此可见，在最后一步的设计中需要根据存放APP程序的起始地址以及中断向量表来设置栈顶地址，并获取复位中断地址跳转到复位中断程序。
2.1、内置Flash的分配情况大致如下： 2.2、具体内置Flash大小参考选型手册 3、BootLoader程序 1、上电初始程序依然从0x08000004处取出复位中断向量地址，执行复位中断函数后跳转到IAP的main(标号①所示)，
2、在IAP的main函数执行完成后强制跳转到0x08000004&#43;N&#43;M处(标号②所示)，最后跳转到新的main函数中来(标号③所示)，
3、当发生中断请求后，程序跳转到新的中断向量表中取出新的中断函数入口地址，再跳转到新的中断服务函数中执行(标号④⑤所示)，执行完中断函数后再返回到main函数中来(标号⑥所示)。
3.1、标注如下图所示： 4、流程图 4.1、IAP升级过程中，我采用的大致方案是：
1、APP 收到上位机发来的升级指令后，将升级标志写入 Flash ，然后调用软件重启函数，进行重启；
2、重启后，STM32 先进入 Bootloader ，Bootloader 检查升级标志是否置位，如果未置位，则跳转到 APP 中，相反，则停留在 Bootloader 中；
3、Bootloader 初始化后发送准备完毕命令至上位机，上位机受到后将固件数据拆分成数据帧，依次发送给 STM32 ，每发送一帧需要等待 STM32 应答无误后，继续发送下一帧；
4、STM32 收到数据帧时，先保存在缓存数组中，然后发送应答给上位机，待接收的数据长度为一字或多字时，将数据一起写入 Flash ；
5、上位机发送完所有数据后，发送结束命令，STM32 收到后，将所有未写入的数据全部写完，将固件版本号写入 Flash 中，复位升级标志，检查 APP 程序区起始数据无误后，发送升级完毕应答给上位机，接着调用软件重启函数，重进 Bootloader ；
6、重进 Bootloader 后，Bootloader 检查升级标志为复位状态时，跳转到 APP 中执行 APP 程序；
7、至此，所有升级过程全部结束。
5、程序代码解析 5.1、bootloader程序设计 在 /Drivers/src/IAP.c中
Step 1) 确定存放APP程序的首地址
#define FLASH_APP1_ADDR 0x08006000 //应用程序起始地址" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/1a74a4eeb7e8b4be18295318302db05e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-07-27T16:39:01+08:00" />
<meta property="article:modified_time" content="2020-07-27T16:39:01+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">STM32F103x学习笔记（1）—— IAP应用编程</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="IAP_0"></a>IAP应用编程</h3> 
<h4><a id="1IAP_1"></a>1、IAP简介</h4> 
<blockquote> 
 <p>IAP是In Application Programming的首字母缩写，IAP是用户自己的程序在运行过程中对User Flash的部分区域进行烧写，目的是为了在产品发布后可以方便地通过预留的通信口对产品中的固件程序进行更新升级。</p> 
</blockquote> 
<h4><a id="2STM32Flash_4"></a>2、STM32内置Flash</h4> 
<blockquote> 
 <p>1、STM32内部FLASH的起始地址为0X08000000,Bootloader程序文件就从此地址开始写入，存放APP程序的首地址设置在紧跟Bootloader之后。当程序开始执行时，首先运行的是Bootloader程序，然后Bootloader收到BIN文件并将其复制到APP区域使固件得以更新,固件更新结束后还需要跳转到APP程序开始执行新的程序,完成这最后这一步要了解Cortex-M3的中断向量表。<br> 2、程序启动后，将首先从“中断向量表”取出复位中断向量执行复位中断程序完成启动，当复位中断程序运行完成后才跳转到main函数。由此可见，在最后一步的设计中需要根据存放APP程序的起始地址以及中断向量表来设置栈顶地址，并获取复位中断地址跳转到复位中断程序。</p> 
</blockquote> 
<h4><a id="21Flash_8"></a>2.1、内置Flash的分配情况大致如下：</h4> 
<p><img src="https://images2.imgbox.com/c2/ac/27t6JNYc_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="22Flash_10"></a>2.2、具体内置Flash大小参考选型手册</h4> 
<p><img src="https://images2.imgbox.com/2b/6e/6z3D86mr_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3BootLoader_13"></a>3、BootLoader程序</h3> 
<blockquote> 
 <p>1、上电初始程序依然从0x08000004处取出复位中断向量地址，执行复位中断函数后跳转到IAP的main(标号①所示)，<br> 2、在IAP的main函数执行完成后强制跳转到0x08000004+N+M处(标号②所示)，最后跳转到新的main函数中来(标号③所示)，<br> 3、当发生中断请求后，程序跳转到新的中断向量表中取出新的中断函数入口地址，再跳转到新的中断服务函数中执行(标号④⑤所示)，执行完中断函数后再返回到main函数中来(标号⑥所示)。</p> 
</blockquote> 
<h4><a id="31_18"></a>3.1、标注如下图所示：</h4> 
<p><img src="https://images2.imgbox.com/74/b9/fVX1sokH_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="4_21"></a>4、流程图</h3> 
<blockquote> 
 <p>4.1、IAP升级过程中，我采用的大致方案是：<br> 1、APP 收到上位机发来的升级指令后，将升级标志写入 Flash ，然后调用软件重启函数，进行重启；<br> 2、重启后，STM32 先进入 Bootloader ，Bootloader 检查升级标志是否置位，如果未置位，则跳转到 APP 中，相反，则停留在 Bootloader 中；<br> 3、Bootloader 初始化后发送准备完毕命令至上位机，上位机受到后将固件数据拆分成数据帧，依次发送给 STM32 ，每发送一帧需要等待 STM32 应答无误后，继续发送下一帧；<br> 4、STM32 收到数据帧时，先保存在缓存数组中，然后发送应答给上位机，待接收的数据长度为一字或多字时，将数据一起写入 Flash ；<br> 5、上位机发送完所有数据后，发送结束命令，STM32 收到后，将所有未写入的数据全部写完，将固件版本号写入 Flash 中，复位升级标志，检查 APP 程序区起始数据无误后，发送升级完毕应答给上位机，接着调用软件重启函数，重进 Bootloader ；<br> 6、重进 Bootloader 后，Bootloader 检查升级标志为复位状态时，跳转到 APP 中执行 APP 程序；<br> 7、至此，所有升级过程全部结束。</p> 
</blockquote> 
<h3><a id="5_31"></a>5、程序代码解析</h3> 
<h4><a id="51bootloader_32"></a>5.1、bootloader程序设计</h4> 
<p>在 <strong>/Drivers/src/IAP.c</strong>中<br> <strong>Step 1) 确定存放APP程序的首地址</strong><br> <code>#define FLASH_APP1_ADDR 0x08006000 //应用程序起始地址</code><br> <strong>Step 2) 跳转到新程序运行</strong></p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">Run_application</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>vu32<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>FLASH_APP1_ADDR<span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">0xFF000000</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0x08000000</span><span class="token punctuation">)</span><span class="token comment">//判断是否为0X08XXXXXX.</span>
	<span class="token punctuation">{<!-- --></span>	 
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"准备执行自带的APP代码!!\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">iap_load_app</span><span class="token punctuation">(</span>FLASH_APP1_ADDR<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//执行FLASH APP代码</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> 
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Err：自带的APP代码 地址是非法的 无法执行!!!!\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"准备软件复位 !!\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">Reset_MCU</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p><code>if(((*(vu32*)(FLASH_APP1_ADDR+4))&amp;0xFF000000)==0x08000000)</code><br> 串口接收过来的数据，是从：0X20001000开始存储的。 第一个4个字节是MSP地址，第二个4个字节，才是复位中断向量的入口地址。 &amp;0xFF000000就是取最高8位。因为FLASH的地址范围是0X0800 0000开始的。这可以一定程度上确保地址范围正常。</p> 
<pre><code class="prism language-cpp"><span class="token comment">//跳转到应用程序段</span>
<span class="token comment">//appxaddr:用户代码起始地址.</span>
<span class="token keyword">void</span> <span class="token function">iap_load_app</span><span class="token punctuation">(</span>u32 appxaddr<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>vu32<span class="token operator">*</span><span class="token punctuation">)</span>appxaddr<span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">0x2FFE0000</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0x20000000</span><span class="token punctuation">)</span>	<span class="token comment">//检查栈顶地址是否合法.</span>
	<span class="token punctuation">{<!-- --></span> 
		SysTick<span class="token operator">-</span><span class="token operator">&gt;</span>CTRL <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
		
		<span class="token function">__disable_irq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		jump2app<span class="token operator">=</span><span class="token punctuation">(</span>iapfun<span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>vu32<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>appxaddr<span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//用户代码区第二个字为程序开始地址(复位地址)		</span>
		<span class="token function">MSR_MSP</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>vu32<span class="token operator">*</span><span class="token punctuation">)</span>appxaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>					<span class="token comment">//初始化APP堆栈指针(用户代码区的第一个字用于存放栈顶地址)</span>
<span class="token comment">// 		SCB-&gt;VTOR = FLASH_BASE | 0x06000;</span>
		<span class="token function">jump2app</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>									<span class="token comment">//跳转到APP.</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Err: 跳转 程序段栈顶地址非法 !!\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>		 

</code></pre> 
<p><code>if(((*(vu32*)(FLASH_APP1_ADDR+4))&amp;0xFF000000)==0x08000000);</code><br> 检查栈顶地址是否合法(用户代码的第一个字存放的是栈顶地址，即检查此地址)<br> <code>jump2app=(iapfun)*(vu32*)(appxaddr+4);</code><br> 用户代码区第二个字为程序开始地址(复位中断向量地址)，强制把该地址转化为iapfun类型的函数指针，再赋给函数指针jump2app<br> <strong>Step 3) 串口接收缓存 IAP 数据</strong></p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">USART1_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>                	<span class="token comment">//串口1中断服务程序</span>
<span class="token punctuation">{<!-- --></span>
	u8 Res<span class="token punctuation">;</span>
  
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">USART_GetITStatus</span><span class="token punctuation">(</span>USART1<span class="token punctuation">,</span> USART_IT_RXNE<span class="token punctuation">)</span> <span class="token operator">!=</span> RESET<span class="token punctuation">)</span>  <span class="token comment">//接收中断(接收到的数据必须是0x0d 0x0a结尾)</span>
	<span class="token punctuation">{<!-- --></span>
	   Res <span class="token operator">=</span><span class="token function">USART_ReceiveData</span><span class="token punctuation">(</span>USART1<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//读取接收到的数据</span>

		 <span class="token function">mscp_rcv_data_api</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>usartMsg_t<span class="token punctuation">[</span>TRANS_DIRECTION_RELAY<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>Res<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> 
<span class="token punctuation">}</span> 

</code></pre> 
<p>这里列举USART1为例。<code>mscp_rcv_data_api(&amp;usartMsg_t[TRANS_DIRECTION_RELAY], &amp;Res, 1);</code><br> 是以数组实现的循环链表的具体实现。<br> <strong>Step 4) 轮询 IAP 数据</strong></p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">Updata_application</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	__IO u32 UpdaCnt<span class="token operator">=</span><span class="token number">0x5c50</span><span class="token punctuation">;</span><span class="token comment">//程序的大小</span>
	
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"有更新程序,已经开启了看门狗 !!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">if</span><span class="token punctuation">(</span>EM_USER_BIN_2 <span class="token operator">==</span> <span class="token function">GetFlashAddrLuenchCsFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"擦除了FLASH_APP1_ADDR....\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">STMFLASH_Erase_Sector</span><span class="token punctuation">(</span>FLASH_APP1_ADDR<span class="token punctuation">,</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//擦除addr1地址以及以上40页 (1024/页)</span>
		s_copy_address <span class="token operator">=</span> FLASH_APP1_ADDR<span class="token punctuation">;</span><span class="token comment">//存储用户程序地址</span>
		newDataAddr <span class="token operator">=</span> FLASH_APP1_ADDR<span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"擦除了FLASH_APP2_ADDR....\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">STMFLASH_Erase_Sector</span><span class="token punctuation">(</span>FLASH_APP2_ADDR<span class="token punctuation">,</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//擦除addr2地址以及以上40页 (1024/页)</span>
		s_copy_address <span class="token operator">=</span> FLASH_APP2_ADDR<span class="token punctuation">;</span><span class="token comment">//存储用户程序地址</span>
		newDataAddr <span class="token operator">=</span> FLASH_APP2_ADDR<span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"开始进入主函数\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	Task_delay<span class="token punctuation">[</span>EM_USER_UPDATE_TIMEOUT_DELAY<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>Task_delay<span class="token punctuation">[</span>EM_PRINTF_TIMEOUT_DELAY<span class="token punctuation">]</span> <span class="token operator">&gt;=</span> <span class="token function">D_DELAY_S</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">IWDG_FeedDog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//喂狗</span>
			Task_delay<span class="token punctuation">[</span>EM_PRINTF_TIMEOUT_DELAY<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"等待接收用户程序, 喂狗!!!!\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		
		<span class="token keyword">if</span><span class="token punctuation">(</span>Task_delay<span class="token punctuation">[</span>EM_USER_UPDATE_TIMEOUT_DELAY<span class="token punctuation">]</span> <span class="token operator">&gt;=</span> <span class="token function">D_DELAY_S</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Err：升级超时2分钟!!\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">Reset_MCU</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
		<span class="token punctuation">}</span>
		
		<span class="token comment">//串口数据分发（轮询）</span>
		<span class="token function">uart_receive_data_distribute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token comment">//接收升级数据完成</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">uart_receive_data_success</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span><span class="token comment">//数据接收完成</span>
	<span class="token punctuation">}</span>
	<span class="token function">uart_receive_data_success</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
  * @brief  串口数据分发
  * @param  argument: Not used 
  * @retval None
  */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">uart_receive_data_distribute</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">mscp_poll_packet_data</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>usartMsg_t<span class="token punctuation">[</span>TRANS_DIRECTION_RELAY<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取串口升级部分的数据</span>
	<span class="token function">mscp_poll_packet_data</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>usartMsg_t<span class="token punctuation">[</span>TRANS_DIRECTION_BLE<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取串口升级部分的数据</span>
	<span class="token function">mscp_poll_packet_data</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>usartMsg_t<span class="token punctuation">[</span>TRANS_DIRECTION_RS485_NOUSE<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取串口升级部分的数据</span>
	<span class="token function">mscp_poll_packet_data</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>usartMsg_t<span class="token punctuation">[</span>TRANS_DIRECTION_RS485_INUSE<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取串口升级部分的数据</span>
	<span class="token function">mscp_poll_packet_data</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>usartMsg_t<span class="token punctuation">[</span>TRANS_DIRECTION_4G<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取串口升级部分的数据</span>
	<span class="token function">mscp_poll_packet_data</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>usartMsg_t<span class="token punctuation">[</span>TRANS_DIRECTION_WIFI<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取串口升级部分的数据</span>
	<span class="token function">RFID_reader_poll_packet_data</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>RFID_reader_msg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//获取RS485升级部分的数据</span>
<span class="token punctuation">}</span>

</code></pre> 
<p><code>STMFLASH_Erase_Sector(FLASH_APP1_ADDR,40);</code>//擦除addr1地址以及以上40页 (1024/页)<br> STMFLASH_Erase_Sector 是一个擦除 FLASH 的自定义函数<br> <strong>Step 5) 擦除 内部 FLASH</strong></p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">STMFLASH_Erase_Sector</span><span class="token punctuation">(</span>u32 adderss<span class="token punctuation">,</span> u8 len<span class="token punctuation">)</span>   
<span class="token punctuation">{<!-- --></span>
	u8 i<span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>len<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">STMFLASH_Erase</span><span class="token punctuation">(</span>adderss<span class="token punctuation">,</span><span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//擦除addr2地址以及以上40页</span>
		adderss <span class="token operator">+</span><span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">STMFLASH_Erase</span><span class="token punctuation">(</span>u32 WriteAddr<span class="token punctuation">,</span>u16 NumToWrite<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  u32 secpos<span class="token punctuation">;</span>	   <span class="token comment">//扇区地址</span>
	u16 secoff<span class="token punctuation">;</span>	   <span class="token comment">//扇区内偏移地址(16位字计算)</span>
	u16 secremain<span class="token punctuation">;</span> <span class="token comment">//扇区内剩余地址(16位字计算)	   </span>
 	u16 i<span class="token punctuation">;</span>    
	u32 offaddr<span class="token punctuation">;</span>   <span class="token comment">//去掉0X08000000后的地址</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>WriteAddr<span class="token operator">&lt;</span>STM32_FLASH_BASE<span class="token operator">||</span><span class="token punctuation">(</span>WriteAddr<span class="token operator">&gt;=</span><span class="token punctuation">(</span>STM32_FLASH_BASE<span class="token operator">+</span><span class="token number">1024</span><span class="token operator">*</span>STM32_FLASH_SIZE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token comment">//非法地址</span>
	<span class="token function">FLASH_Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>						<span class="token comment">//解锁</span>
	offaddr<span class="token operator">=</span>WriteAddr<span class="token operator">-</span>STM32_FLASH_BASE<span class="token punctuation">;</span>		<span class="token comment">//实际偏移地址.</span>
	secpos<span class="token operator">=</span>offaddr<span class="token operator">/</span>STM_SECTOR_SIZE<span class="token punctuation">;</span>			<span class="token comment">//扇区地址  0~127 for STM32F103RBT6</span>
	secoff<span class="token operator">=</span><span class="token punctuation">(</span>offaddr<span class="token operator">%</span>STM_SECTOR_SIZE<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>		<span class="token comment">//在扇区内的偏移(2个字节为基本单位.)</span>
	secremain<span class="token operator">=</span>STM_SECTOR_SIZE<span class="token operator">/</span><span class="token number">2</span><span class="token operator">-</span>secoff<span class="token punctuation">;</span>		<span class="token comment">//扇区剩余空间大小   </span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>NumToWrite<span class="token operator">&lt;=</span>secremain<span class="token punctuation">)</span>secremain<span class="token operator">=</span>NumToWrite<span class="token punctuation">;</span><span class="token comment">//不大于该扇区范围</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> 
	<span class="token punctuation">{<!-- --></span>	
		<span class="token function">STMFLASH_Read</span><span class="token punctuation">(</span>secpos<span class="token operator">*</span>STM_SECTOR_SIZE<span class="token operator">+</span>STM32_FLASH_BASE<span class="token punctuation">,</span>STMFLASH_BUF<span class="token punctuation">,</span>STM_SECTOR_SIZE<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//读出整个扇区的内容</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>secremain<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token comment">//校验数据</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>STMFLASH_BUF<span class="token punctuation">[</span>secoff<span class="token operator">+</span>i<span class="token punctuation">]</span><span class="token operator">!=</span><span class="token number">0XFFFF</span><span class="token punctuation">)</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token comment">//需要擦除  	  </span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">&lt;</span>secremain<span class="token punctuation">)</span><span class="token comment">//需要擦除</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">FLASH_ErasePage</span><span class="token punctuation">(</span>secpos<span class="token operator">*</span>STM_SECTOR_SIZE<span class="token operator">+</span>STM32_FLASH_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//擦除这个扇区</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>NumToWrite<span class="token operator">==</span>secremain<span class="token punctuation">)</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token comment">//写入结束了</span>
		<span class="token keyword">else</span><span class="token comment">//写入未结束</span>
		<span class="token punctuation">{<!-- --></span>
			secpos<span class="token operator">++</span><span class="token punctuation">;</span>				<span class="token comment">//扇区地址增1</span>
			secoff<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>				<span class="token comment">//偏移位置为0 	 </span>
			WriteAddr<span class="token operator">+</span><span class="token operator">=</span>secremain<span class="token punctuation">;</span>	<span class="token comment">//写地址偏移	   </span>
			NumToWrite<span class="token operator">-</span><span class="token operator">=</span>secremain<span class="token punctuation">;</span>	<span class="token comment">//字节(16位)数递减</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>NumToWrite<span class="token operator">&gt;</span><span class="token punctuation">(</span>STM_SECTOR_SIZE<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>secremain<span class="token operator">=</span>STM_SECTOR_SIZE<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span><span class="token comment">//下一个扇区还是写不完</span>
			<span class="token keyword">else</span> secremain<span class="token operator">=</span>NumToWrite<span class="token punctuation">;</span><span class="token comment">//下一个扇区可以写完了</span>
		<span class="token punctuation">}</span>	 
	<span class="token punctuation">}</span><span class="token punctuation">;</span>	
	<span class="token function">FLASH_Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//上锁</span>
<span class="token punctuation">}</span>

<span class="token comment">//从指定地址开始读出指定长度的数据</span>
<span class="token comment">//ReadAddr:起始地址</span>
<span class="token comment">//pBuffer:数据指针</span>
<span class="token comment">//NumToWrite:半字(16位)数</span>
<span class="token keyword">void</span> <span class="token function">STMFLASH_Read</span><span class="token punctuation">(</span>u32 ReadAddr<span class="token punctuation">,</span>u16 <span class="token operator">*</span>pBuffer<span class="token punctuation">,</span>u16 NumToRead<span class="token punctuation">)</span>   	
<span class="token punctuation">{<!-- --></span>
	u16 i<span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>NumToRead<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		pBuffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">STMFLASH_ReadHalfWord</span><span class="token punctuation">(</span>ReadAddr<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//读取2个字节.</span>
		ReadAddr<span class="token operator">+</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span><span class="token comment">//偏移2个字节.	</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//读取指定地址的半字(16位数据)</span>
<span class="token comment">//faddr:读地址(此地址必须为2的倍数!!)</span>
<span class="token comment">//返回值:对应数据.</span>
u16 <span class="token function">STMFLASH_ReadHalfWord</span><span class="token punctuation">(</span>u32 faddr<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token operator">*</span><span class="token punctuation">(</span>vu16<span class="token operator">*</span><span class="token punctuation">)</span>faddr<span class="token punctuation">;</span> 
<span class="token punctuation">}</span>

</code></pre> 
<p><strong>Step 6) 写入 IAP 数据到 FLASH</strong></p> 
<pre><code class="prism language-cpp"><span class="token comment">/**
  * @brief  cmd   dfu
  * @param  argument: Not used 
  * @retval None
  */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">mcu_cmd_dfu_handle</span><span class="token punctuation">(</span>Msg_t <span class="token operator">*</span>p_msg_t<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">Copy_application</span><span class="token punctuation">(</span>p_msg_t<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Copy_application</span><span class="token punctuation">(</span>Msg_t <span class="token operator">*</span>p_msg_t<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">uint8_t</span> index <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
	<span class="token keyword">uint16_t</span> _readData <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">uint16_t</span> _checkData <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		
	<span class="token keyword">while</span><span class="token punctuation">(</span>index <span class="token operator">&lt;</span> p_msg_t<span class="token operator">-</span><span class="token operator">&gt;</span>msgHead_t<span class="token punctuation">.</span>data_size<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">IWDG_FeedDog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//喂狗</span>
		_readData <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>index<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> p_msg_t<span class="token operator">-</span><span class="token operator">&gt;</span>msgHead_t<span class="token punctuation">.</span>data_size<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			_readData <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">uint16_t</span><span class="token punctuation">)</span>p_msg_t<span class="token operator">-</span><span class="token operator">&gt;</span>rcv_buf<span class="token punctuation">[</span>index<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		_readData <span class="token operator">=</span> _readData<span class="token operator">|</span>p_msg_t<span class="token operator">-</span><span class="token operator">&gt;</span>rcv_buf<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token function">STMFLASH_Write</span><span class="token punctuation">(</span>s_copy_address<span class="token punctuation">,</span><span class="token operator">&amp;</span>_readData<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
		s_copy_address <span class="token operator">+</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>
		index <span class="token operator">+</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%x-%04x x "</span><span class="token punctuation">,</span> s_copy_address<span class="token punctuation">,</span> _readData<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n 升级数据接收完成，长度：%d d \n"</span><span class="token punctuation">,</span> p_msg_t<span class="token operator">-</span><span class="token operator">&gt;</span>msgHead_t<span class="token punctuation">.</span>data_size<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//检测 总包长 发完</span>
	_readData <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p_msg_t<span class="token operator">-</span><span class="token operator">&gt;</span>rcv_buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>p_msg_t<span class="token operator">-</span><span class="token operator">&gt;</span>rcv_buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	_checkData <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p_msg_t<span class="token operator">-</span><span class="token operator">&gt;</span>rcv_buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>p_msg_t<span class="token operator">-</span><span class="token operator">&gt;</span>rcv_buf<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>_checkData <span class="token operator">&gt;=</span> _readData<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">dataReceivedSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p><strong>Step 7) 检测 写入的 IAP 数据合法性</strong></p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">Check_application</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>vu32<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>newDataAddr<span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">0xFF000000</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0x08000000</span><span class="token punctuation">)</span><span class="token comment">//判断是否为0X08XXXXXX.</span>
	<span class="token punctuation">{<!-- --></span>	 
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"准备执行新的APP代码!!\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">Reset_MCU</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> 
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Err：接收的应用程序为 非FLASH应用程序,无法执行!\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">Reset_MCU</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h4><a id="52App_319"></a>5.2、用户App设计</h4> 
<p><strong>Step 1) 新建一个工程，编写一个 App LED 闪烁代码</strong><br> <img src="https://images2.imgbox.com/32/52/1SaK5k4X_o.png" alt="在这里插入图片描述"><br> 这部分代码不用抄，自己任意写一个 LED 灯闪烁的程序即可。<br> <strong>Step 2) 设置 App 地址偏移起点（理解成中断向量表偏移地址）</strong><br> <img src="https://images2.imgbox.com/3c/fd/XwzR6HTF_o.png" alt="在这里插入图片描述"><br> 这里的地址与 Bootloader 的<code>FLASH_APP1_ADDR</code>必须一致。<br> <strong>Step 3) Flash地址设置（这个地址需要和BootLoader中对应）</strong><br> <img src="https://images2.imgbox.com/e6/85/h0q2xlpp_o.png" alt="在这里插入图片描述"><br> 这里的地址与 Bootloader 的<code>FLASH_APP1_ADDR</code>必须一致。<br> 0x7A000 是由 0x80000 - <code>FLASH_APP1_ADDR</code> 得来。<br> <strong>Step 4) App.bin生成</strong><br> <img src="https://images2.imgbox.com/86/35/bqviShZS_o.png" alt="在这里插入图片描述"><br> 基本的命令格式是 这里需要注意空格，大小写。<br> <code>D:\Keil_v5\ARM\ARMCC\bin\fromelf.exe --bin --output=output\@L.bin !L</code><br> <strong>Step 5) 编译链接生成bin文件：</strong><br> <img src="https://images2.imgbox.com/c2/62/Qu7q3cTX_o.png" alt="在这里插入图片描述"><br> 窗口中有如下的提示信息，表示bin文件生成成功。<br> 在输出文件夹中找到BIN文件，这个文件就是用户App的BIN文件。</p> 
<h3><a id="53_339"></a>5.3、使用流程</h3> 
<p><strong>Step 1) 烧入 Bootloader 程序：</strong><br> <img src="https://images2.imgbox.com/4b/10/NnP5fY7q_o.png" alt="在这里插入图片描述"><br> <strong>Step 2) 打开 XCOM V2.1.exe 串口助手：</strong><br> <img src="https://images2.imgbox.com/fd/0c/WGvU5xTD_o.png" alt="在这里插入图片描述"><br> <strong>Step 3) 开发版接线图：</strong><br> <img src="https://images2.imgbox.com/f8/62/rzpGeJBT_o.png" alt="在这里插入图片描述"><br> 本例程以串口1测试为例。<br> <strong>Step 4) 使用 XCOM V2.1.exe 发送 BIN 文件：</strong><br> <img src="https://images2.imgbox.com/93/48/8qXxoCpJ_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/9a/02/DZv2SCk7_o.png" alt="在这里插入图片描述"><br> 过程中，<code>显示等待接收用户程序!!!</code>表示等待接收 BIN 文件 。<br> 过程中，<code>显示准备执行新的APP代码!!，准备执行自带的APP代码!!</code>表示程序跳转完成。<br> <strong>Step 5) 效果展示：</strong><br> <img src="https://images2.imgbox.com/70/90/k1rfcia3_o.png" alt="在这里插入图片描述"><br> 跳转前灯灭，跳转成功后，LED 快闪。（开发版 STM32F103ZET6）</p> 
<hr> 
<p>• 由 <a href="https://blog.csdn.net/qq_42209354">ChiKong_Tam</a> 写于 2020 年 7 月 27 日<br> • 参考：<a href="https://blog.csdn.net/morixinguan/article/details/99697314">stm32cubeMX学习九、带串口屏显示的BootLoader程序开发(基于野火STM32F103ZET6霸道开发板)</a><br> • 参考：<a href="https://blog.csdn.net/wzy15965343032/article/details/88545225">STM32+IAP方案的实现，IAP实现原理（详细解决说明）</a><br> • 参考：<a href="https://blog.csdn.net/elikang/article/details/86082960">STM32在线升级 （IAP）</a><br> • 参考：<a href="https://www.liuguogy.com/archives/stm32-iap.html" rel="nofollow">STM32 IAP 全解析</a></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/3e2f5f8758030324d3aa28dc15f2e84b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">WEB综合案例  day02 数据库设计 目录模块 题目模块（图片上传 显示） 题目选项模块  操作中遇到的问题总结</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d0b14a7837e89971be1efb5641235d9b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">如何提高解题速度?</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>