<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>基于阿里云 Serverless 容器服务轻松部署企业级 AI 应用 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="基于阿里云 Serverless 容器服务轻松部署企业级 AI 应用" />
<meta property="og:description" content="数禾科技 AI 模型服务基于云原生架构，为不同业务环节提供智能决策支持。随着业务的快速发展，摆在数禾面前的难题是支撑模型计算的底层应用资源无法根据请求量来调整机器资源支持运算能力。同时，随着模型在线推理服务数量的增加，数禾的模型服务也变得越来越庞大、臃肿，难以管理。这种状况不仅导致了资源浪费，还增加了维护和升级的成本。
为了解决这些“顽疾”，数禾科技采用阿里云 ASK 部署线上模型，无需 K8s 节点管理，根据实时流量动态使用 POD，资源成本节省 60%；通过 ASK Knative 服务，解决了数禾模型的灰度发布和多版本并存问题；得益于ASK 自动伸缩和缩容到 0 的优势，降低运行成本，大幅提升服务可用性。
目前，该系统已上线部署 500&#43;AI 模型服务，每天能够提供上亿次查询决策服务，具备无限横向扩展的能力。同时，数禾科技 AI 模型服务支持自动调整容量，满足不同业务压力下的需求，从而保障业务的稳定运行。不仅如此，采用云原生架构方案，平均部署周期由之前的1天缩短至 0.5天，大幅提升了研发迭代效率，从而加速商业化应用的进程，为金融业务提供新的增长动力。
关于 Serverless Kubernetes（ASK） Kubernetes（K8s）作为一个开源容器编排系统，被广泛运用于云原生应用的开发与管理。其优势在于降低运维成本，提高运维效率，形成了以 K8s 为核心的云原生生态。然而使用 K8s 常常需要用户面对的问题较多，例如资源规划、容量规划、Node 与 Pod 的亲和关系、容器网络规划、节点生命周期管理、操作系统版本、容器运行时版本兼容性等，这些问题显然不是用户所希望关心的，用户期望做的事情是专注在自身的业务逻辑，尽可能不关心这些基础设施。Serverless 的核心理念在于让开发者更聚焦业务逻辑，减少对基础设施的关注。因此我们将 K8s 复杂性下沉，提供 Serverless Kubernetes 的产品能力。
那么 Serverless Kubernetes 有哪些优势呢？主要包括以下三个方面：免运维、自动弹性、按需付费。
首先，Serverless Kubernetes 组件全托管免运维，支持自动升级 k8s 版本。其次，该产品具有极致弹性能力。可以根据业务需求，自动弹性、秒级扩容，从而在满足业务增长时自动容量规划。最后，使用 Serverless Kubernetes 的用户，只需根据实际使用量按需计费。除此之外，ASK 还提供了新增的 U 实例规格支持，统一支持多款处理器，相比上一代主售实例降价高达 40%。
为了让更多用户体验最佳实践，我们特地将其打造成了一个体验场景，配合热门开源的 AI 项目 Stable Diffusion，用户可以通过真实的云上环境，轻松体验容器化部署具备企业级弹性能力的 AI 模型。
在 ASK 中部署 Stable Diffusion 随着生成型 AI 技术的能力提升，越来越多的注意力放在了通过 AI 模型提升研发效率上。作为 AIGC（AI Generated Content）领域的知名项目 Stable Diffusion，可以帮助用户快速、准确地生成想要的场景及图片。不过当前直接在 K8s 使用 Stable Diffusion 面临如下问题：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/d39a0e8f98eb36ab51c671ae2be1c983/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-13T16:28:08+08:00" />
<meta property="article:modified_time" content="2023-06-13T16:28:08+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">基于阿里云 Serverless 容器服务轻松部署企业级 AI 应用</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p style="text-align:justify;">数禾科技 AI 模型服务基于云原生架构，为不同业务环节提供智能决策支持。随着业务的快速发展，摆在数禾面前的难题是支撑模型计算的底层应用资源无法根据请求量来调整机器资源支持运算能力。同时，随着模型在线推理服务数量的增加，数禾的模型服务也变得越来越庞大、臃肿，难以管理。这种状况不仅导致了资源浪费，还增加了维护和升级的成本。</p> 
<p style="text-align:justify;">为了解决这些“顽疾”，数禾科技采用阿里云 ASK 部署线上模型，无需 K8s 节点管理，根据实时流量动态使用 POD，资源成本节省 60%；通过 ASK Knative 服务，解决了数禾模型的灰度发布和多版本并存问题；得益于ASK 自动伸缩和缩容到 0 的优势，降低运行成本，大幅提升服务可用性。</p> 
<p style="text-align:justify;">目前，该系统已上线部署 500+AI 模型服务，每天能够提供上亿次查询决策服务，具备无限横向扩展的能力。同时，数禾科技 AI 模型服务支持自动调整容量，满足不同业务压力下的需求，从而保障业务的稳定运行。不仅如此，采用云原生架构方案，平均部署周期由之前的1天缩短至 0.5天，大幅提升了研发迭代效率，从而加速商业化应用的进程，为金融业务提供新的增长动力。</p> 
<h3 style="text-align:justify;">关于 Serverless Kubernetes（ASK）</h3> 
<p style="text-align:justify;">Kubernetes（K8s）作为一个开源容器编排系统，被广泛运用于云原生应用的开发与管理。其优势在于降低运维成本，提高运维效率，形成了以 K8s 为核心的云原生生态。然而使用 K8s 常常需要用户面对的问题较多，例如资源规划、容量规划、Node 与 Pod 的亲和关系、容器网络规划、节点生命周期管理、操作系统版本、容器运行时版本兼容性等，这些问题显然不是用户所希望关心的，用户期望做的事情是专注在自身的业务逻辑，尽可能不关心这些基础设施。Serverless 的核心理念在于让开发者更聚焦业务逻辑，减少对基础设施的关注。因此我们将 K8s 复杂性下沉，提供 Serverless Kubernetes 的产品能力。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/82/53/s3Rn5sws_o.png"></p> 
<p style="text-align:justify;">那么 Serverless Kubernetes 有哪些优势呢？<strong>主要包括以下三个方面：免运维、自动弹性、按需付费。</strong></p> 
<p style="text-align:justify;">首先，Serverless Kubernetes 组件全托管免运维，支持自动升级 k8s 版本。其次，该产品具有极致弹性能力。可以根据业务需求，自动弹性、秒级扩容，从而在满足业务增长时自动容量规划。最后，使用 Serverless Kubernetes 的用户，只需根据实际使用量按需计费。除此之外，ASK 还提供了新增的 U 实例规格支持，统一支持多款处理器，相比上一代主售实例降价高达 40%。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/63/91/Ng1RWr21_o.png"></p> 
<p style="text-align:justify;">为了让更多用户体验最佳实践，我们特地将其打造成了一个体验场景，配合热门开源的 AI 项目 Stable Diffusion，用户可以通过真实的云上环境，轻松体验容器化部署具备企业级弹性能力的 AI 模型。</p> 
<h3 style="text-align:justify;">在 ASK 中部署 Stable Diffusion</h3> 
<p style="text-align:justify;">随着生成型 AI 技术的能力提升，越来越多的注意力放在了通过 AI 模型提升研发效率上。作为 AIGC（AI Generated Content）领域的知名项目 Stable Diffusion，可以帮助用户快速、准确地生成想要的场景及图片。不过当前直接在 K8s 使用 Stable Diffusion 面临如下问题：</p> 
<ul><li style="text-align:justify;">单个 Pod 处理请求的吞吐率有限，如果多个请求转发到同一个 Pod，会导致服务端过载异常，因此需要精准的控制单个 Pod 请求并发处理数。</li><li style="text-align:justify;">GPU 资源很珍贵，期望做到按需使用资源，在业务低谷及时释放 GPU 资源</li></ul> 
<p style="text-align:justify;"><strong>基于上面两个问题，我们提供 ASK + Knative 解决方案，可以做到基于并发精准弹性，缩容到 0，资源按需使用，打造生产可用的 Stable Diffusion 服务。</strong></p> 
<h4 style="text-align:justify;">方案</h4> 
<p style="text-align:justify;">这里我们在 ASK 中提供 Knative + MSE 方式解决上述问题：</p> 
<ul><li style="text-align:justify;">基于 MSE 网关，扩展 Knative 弹性插件机制，实现基于并发数精准弹性</li><li style="text-align:justify;">支持缩容到 0， 按需使用自动弹性</li><li style="text-align:justify;">多版本管理、镜像加速，助力模型快速发布迭代</li></ul> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/58/a9/emYMsnTx_o.png"></p> 
<h4 style="text-align:justify;">实践</h4> 
<p style="text-align:justify;">接下来我们介绍如何在 ASK 中部署 Stable Diffusion 服务。</p> 
<h4 style="text-align:justify;">服务部署</h4> 
<p style="text-align:justify;">1. 在<strong>集群列表</strong>页面，单击目标集群 knative-sd-demo 进入集群信息页面，然后在左侧导航栏，选择<strong>应用&gt;Knative。</strong></p> 
<p style="text-align:justify;">2. 在 <strong>Knative </strong>页面，单击<strong>服务管理</strong>页签，然后单击<strong>使用模板创建</strong>。</p> 
<p style="text-align:justify;">3. 在<strong>命名空间</strong>下拉列表中，选择 <strong>default</strong>，在<strong>示例模板</strong>下拉列表中，选择 <strong>Resouce-Knative Service</strong>，将以下消息处理服务的 YAML 示例粘贴至模板，然后单击<strong>创建</strong>。</p> 
<p style="text-align:justify;">默认创建一个名为 <strong>knative-sd-demo </strong>的服务。</p> 
<pre><code>apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: knative-sd-demo
  annotations:
    serving.knative.dev.alibabacloud/affinity: "cookie"
    serving.knative.dev.alibabacloud/cookie-name: "sd"
    serving.knative.dev.alibabacloud/cookie-timeout: "1800"
spec:
  template:
    metadata:
      annotations:
        autoscaling.knative.dev/class: mpa.autoscaling.knative.dev
        autoscaling.knative.dev/maxScale: '10'
        autoscaling.knative.dev/targetUtilizationPercentage: "100"
        k8s.aliyun.com/eci-use-specs: ecs.gn5-c4g1.xlarge,ecs.gn5i-c8g1.2xlarge,ecs.gn5-c8g1.2xlarge  
    spec:
      containerConcurrency: 1
      containers:
      - args:
        - --listen
        - --skip-torch-cuda-test
        - --api
        command:
        - python3
        - launch.py
        image: yunqi-registry.cn-shanghai.cr.aliyuncs.com/lab/stable-diffusion@sha256:64999ff1aba706f65a2234d861d46318f7d58e2790b31ace0d567a96e65b617c
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 7860
          name: http1
          protocol: TCP
        name: stable-diffusion
        readinessProbe:
          tcpSocket:
            port: 7860
          initialDelaySeconds: 5
          periodSeconds: 1
          failureThreshold: 3</code></pre> 
<p style="text-align:justify;">参数说明：</p> 
<ul><li style="text-align:justify;">支持 Cookie 会话保持：serving.knative.dev.alibabacloud/affinity</li><li style="text-align:justify;">支持多种 GPU 规格配置：<a href="https://link.zhihu.com/?target=http%3A//k8s.aliyun.com/eci-use-specs" rel="nofollow" title="http://k8s.aliyun.com/eci-use-specs">http://k8s.aliyun.com/eci-use-specs</a></li><li style="text-align:justify;">支持并发数设置：containerConcurrency</li></ul> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/1c/44/JVv26K1V_o.png"></p> 
<p style="text-align:justify;">4. 在<strong>服务管理</strong>页签，刷新页面后，当 <strong>knative-sd-demo </strong>的状态变为<strong>成功</strong>时，表明 SD 服务部署成功。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/ee/31/0hb6Ks4Z_o.png"></p> 
<h4 style="text-align:justify;">服务访问并进行压测</h4> 
<p style="text-align:justify;">部署压测服务 portal-server，用于 Stable Diffusion 效果展示并发起压测。</p> 
<p style="text-align:justify;">1. 在 <strong>Knative </strong>页面，单击<strong>服务管理</strong>页签，然后单击<strong>使用模板创建</strong>。</p> 
<p style="text-align:justify;">2. 在<strong>命名空间</strong>下拉列表中，选择 <strong>default</strong>，在<strong>示例模板</strong>下拉列表中，选择<strong>自定义</strong>，将以下 portal-server 压测服务的 YAML 示例粘贴至模板，然后单击<strong>创建</strong>。</p> 
<pre><code>---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: portal-server
  name: portal-server
spec:
  replicas: 1
  selector:
    matchLabels:
      app: portal-server
  template:
    metadata:
      labels:
        app: portal-server
    spec:
      serviceAccountName: portal-server
      containers:
        - name: portal-server
          image: registry-vpc.cn-beijing.aliyuncs.com/acs/sd-yunqi-server:v1.0.2
          imagePullPolicy: IfNotPresent
          env:
            - name: MAX_CONCURRENT_REQUESTS
              value: "5"
            - name: POD_NAMESPACE
              value: "default"
          readinessProbe:
            failureThreshold: 3
            periodSeconds: 1
            successThreshold: 1
            tcpSocket:
              port: 8080
            timeoutSeconds: 1
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    service.beta.kubernetes.io/alibaba-cloud-loadbalancer-address-type: internet
    service.beta.kubernetes.io/alibaba-cloud-loadbalancer-instance-charge-type: PayByCLCU
  name: portal-server
spec:
  externalTrafficPolicy: Local
  ports:
    - name: http-80
      port: 80
      protocol: TCP
      targetPort: 8080
    - name: http-8888
      port: 8888
      protocol: TCP
      targetPort: 8888
  selector:
    app: portal-server
  type: LoadBalancer
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: pod-list-cluster-role
rules:
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["list"]
  - apiGroups: ["networking.k8s.io"]
    resources: ["ingresses"]
    verbs: ["get"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: pod-list-cluster-role-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: pod-list-cluster-role
subjects:
  - kind: ServiceAccount
    name: portal-server
    namespace: default
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: portal-server
  namespace: default</code></pre> 
<p style="text-align:justify;">3. 选择<strong>网络&gt;服务，</strong>在<strong>服务</strong>页面，查看 portal-server 压测服务，获取访问 IP 为 <strong>123.56.XX.XX。</strong></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/7d/e6/1gbqaGBS_o.png"></p> 
<p style="text-align:justify;">4. 在浏览器中输入 <strong><a href="https://link.zhihu.com/?target=http%3A//123.56.xx.xx/" rel="nofollow" title="http://123.56.XX.XX">http://123.56.XX.XX</a></strong>，然后在该页面单击 <strong>Stable Diffusion </strong>跳转至 Stable Diffusion 访问页面。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/00/9f/0b12Vt9K_o.png"></p> 
<p style="text-align:justify;">a. Stable Diffusion 访问页面如下所示。例如，在如下文本框中输入 cat，然后单击 Generate，将展示与输入有关的图片信息。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/0e/f7/SechvM5a_o.png"></p> 
<p style="text-align:justify;">b. 在压测访问页面，设置<strong>并发数</strong>为 5，<strong>总请求数</strong>为 20，然后单击<strong>开始压测</strong>，查看压测的结果。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/23/74/c2G3C6nJ_o.png"></p> 
<p style="text-align:justify;">压测期间，可以看到创建了 5 个 Pod，并且每个请求均会生成一个图片，图片生成后将展示到页面中。</p> 
<h4 style="text-align:justify;">查看可观测大盘</h4> 
<p style="text-align:justify;">此外在 Knative 提供了开箱即用的可观测能力，在 <strong>Knative </strong>页面，单击<strong>监控大盘</strong>页签。即可看到 Stable Diffusion 服务的请求量（Request Volume）、请求成功率（Success Rate）、4xx（客户端错误）、5xx（服务器端错误）和Pod扩缩容趋势的监控数据。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/98/dc/pAOZH9Oo_o.png"></p> 
<p style="text-align:justify;">在 <strong>Response Time </strong>区域，查看 Knative 的响应延迟数据，包括 P50、P90、P95 和 P99。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/28/20/SFREhWCV_o.png"></p> 
<p style="text-align:justify;"><em>作者：元毅、坤仑</em></p> 
<blockquote> 
 <strong><a href="https://click.aliyun.com/m/1000373503/" rel="nofollow" title="点击立即免费试用云产品 开启云上实践之旅！"><span style="color:#ff9900;">点击立即免费试用云产品 开启云上实践之旅！</span></a></strong> 
</blockquote> 
<p style="text-align:justify;"><strong><a href="https://link.zhihu.com/?target=https%3A//click.aliyun.com/m/1000373821/" rel="nofollow" title="原文链接">原文链接</a></strong></p> 
<p style="text-align:justify;"><strong>本文为阿里云原创内容，未经允许不得转载。</strong></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/564bc626544e6928b61a63f47995dc68/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">在华为外包待了3年，我秃了，但没变强...</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9675650b6766594c09c6e19691db0173/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【JavaWeb】Cookie和Session的使用场景分析与应用</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>