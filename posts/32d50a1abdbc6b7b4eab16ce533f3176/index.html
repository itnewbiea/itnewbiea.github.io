<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Nacos 获取配置时启用权限认证 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Nacos 获取配置时启用权限认证" />
<meta property="og:description" content="默认情况下获取 Nacos 中的配置是不需要权限认证的, 这个估计是由其使用场景决定的(绝大多数都是仅内网可访问).
今天调查了下如何在获取配置时增加权限验证以提高其安全性.
1. 启用 Nacos 的权限认证 只要 nacos.core.auth.enabled 设置为 true 就行了.
### If turn on auth system: nacos.core.auth.enabled=true 2. 添加 Nacos 用户 默认的用户 nacos 绑定的角色是 ROLE_ADMIN , 权限比较大, 最好是新增一个只读的用户用来读取对应命名空间(namespace)的配置.
权限控制 -&gt; 用户列表 中新增用户权限控制 -&gt; 角色管理 中新增用户对应的角色
一个用户可以绑定多个角色.权限控制 -&gt; 权限管理 中新增角色对应的权限
可以设置角色对应的命名空间(页面上名称为资源), 在动作下拉框中指定读写权限(只读\只写\读写).
一个角色可以配置多个权限. 合理的使用 namespace 和 group 来隔离配置文件, 再辅以用户的角色、权限控制, 组合的权限策略还是比较灵活的, 应该能满足大多数项目的安全需求.
创建好用户后可以通过 curl 命令验证一下效果.
curl -XGET &#39;http://localhost:8848/nacos/v1/cs/configs?dataId=test.yaml&amp;group=DEFAULT_GROUP&amp;tenant=&amp;username=test&amp;password=123456&#39; 这里需要注意的是默认的 public 命名空间对应的值是空字符串, 而不是 public .
在 PowerShell 中对应的命令:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/32d50a1abdbc6b7b4eab16ce533f3176/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-28T10:55:32+08:00" />
<meta property="article:modified_time" content="2022-04-28T10:55:32+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Nacos 获取配置时启用权限认证</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>默认情况下获取 <em>Nacos</em> 中的配置是不需要权限认证的, 这个估计是由其使用场景决定的(绝大多数都是仅内网可访问).</p> 
<p>今天调查了下如何在获取配置时增加权限验证以提高其安全性.</p> 
<h3 id="h2-1-nacos-">1. 启用 Nacos 的权限认证</h3> 
<p>只要 <em>nacos.core.auth.enabled</em> 设置为 <code>true</code> 就行了.</p> 
<pre><code>### If turn on auth system:
nacos.core.auth.enabled=true</code></pre> 
<h3 id="h2-2-nacos-">2. 添加 Nacos 用户</h3> 
<p>默认的用户 <em>nacos</em> 绑定的角色是 <em>ROLE_ADMIN</em> , 权限比较大, 最好是新增一个只读的用户用来读取对应命名空间(<em>namespace</em>)的配置.</p> 
<ol><li>权限控制 -&gt; 用户列表 中新增用户</li><li>权限控制 -&gt; 角色管理 中新增用户对应的角色<br> 一个用户可以绑定多个角色.</li><li>权限控制 -&gt; 权限管理 中新增角色对应的权限<br> 可以设置角色对应的命名空间(页面上名称为资源), 在动作下拉框中指定读写权限(只读\只写\读写).<br> 一个角色可以配置多个权限.</li></ol> 
<p>合理的使用 <em>namespace</em> 和 <em>group</em> 来隔离配置文件, 再辅以用户的角色、权限控制, 组合的权限策略还是比较灵活的, 应该能满足大多数项目的安全需求.</p> 
<p>创建好用户后可以通过 <em>curl</em> 命令验证一下效果.</p> 
<pre><code>curl -XGET 'http://localhost:8848/nacos/v1/cs/configs?dataId=test.yaml&amp;group=DEFAULT_GROUP&amp;tenant=&amp;username=test&amp;password=123456'</code></pre> 
<p>这里需要注意的是默认的 <em>public</em> 命名空间对应的值是空字符串, 而不是 <em>public</em> .</p> 
<p>在 <em>PowerShell</em> 中对应的命令:</p> 
<pre><code>curl -Uri 'http://localhost:8848/nacos/v1/cs/configs?dataId=test.yaml&amp;group=DEFAULT_GROUP&amp;tenant=&amp;username=test&amp;password=123456'</code></pre> 
<p>当请求中的用户不存在时, 会返回 <em>unknown user!</em> 错误.</p> 
<blockquote> 
 <p>com.alibaba.nacos.api.exception.NacosException:</p> 
 <h2>Whitelabel Error Page</h2> 
 <p>This application has no explicit mapping for /error, so you are seeing this as a fallback.</p> 
 <p>Wed Jul 28 10:58:15 CST 2021</p> 
 <p>There was an unexpected error (type=Forbidden, status=403).</p> 
 <p>unknown user!</p> 
 <p></p> 
</blockquote> 
<p>当请求中的用户没有绑定角色或角色没有配置对应的权限时, 会返回 <em>authorization failed!</em> 错误.</p> 
<blockquote> 
 <p>com.alibaba.nacos.api.exception.NacosException:</p> 
 <h2>Whitelabel Error Page</h2> 
 <p>This application has no explicit mapping for /error, so you are seeing this as a fallback.</p> 
 <p>Wed Jul 28 11:43:43 CST 2021</p> 
 <p>There was an unexpected error (type=Forbidden, status=403).</p> 
 <p>authorization failed!</p> 
 <p></p> 
</blockquote> 
<h3 id="h2-3-spring-boot-">3. 修改 Spring Boot 配置文件</h3> 
<p>在 <em>bootstrap.yml</em> 中添加 <em>spring.cloud.nacos.config.username</em> 和 <em>spring.cloud.nacos.config.password</em> 配置项 .</p> 
<p>如果不仅使用了配置中心, 还使用了 <em>Nacos</em> 的注册中心功能, 那么同时还要配置 <em>spring.cloud.nacos.discovery.username</em> 和 <em>spring.cloud.nacos.discovery.password</em> 配置项, 而且必须使用默认的 <em>ROLE_ADMIN</em> 角色的用户.</p> 
<pre><code>spring:
  cloud:
    nacos:
      config:
        namespace:
        server-addr: 127.0.0.1:8848
        username: test
        password: 123456
        group: DEFAULT_GROUP
        prefix: test
        file-extension: yaml
      discovery:
        namespace: 
        server-addr: 127.0.0.1:8848
        username: nacos
        password: nacos</code></pre> 
<h3 id="h2-u9644u5F55"><a name="%E9%99%84%E5%BD%95"></a>附录</h3> 
<ol><li> <p>查到有文章说需要在配置文件中指定 <code>spring.cloud.nacos.config.context-path</code> 的值为 <code>/nacos</code> , 这里使用的 <em>1.2.1</em> 版没有这个问题 .</p> <p>附一下正在使用的项目依赖. <em>spring-cloud-starter-alibaba-nacos-discovery</em> 和 <em>spring-cloud-starter-alibaba-nacos-config</em> 使用的均是 <em>2.2.1.RELEASE</em> 版.</p> <pre><code>&lt;!-- Nacos --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;
    &lt;version&gt;2.2.1.RELEASE&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-config&lt;/artifactId&gt;
    &lt;version&gt;2.2.1.RELEASE&lt;/version&gt;
&lt;/dependency&gt;</code></pre> </li><li> <p>命名空间(<em>namespace</em>) 和 租户(<em>tenant</em>)</p> <p>这两个貌似是同一个概念.</p> </li><li> <p>查资料的时候看到今年年初的时候有报道说 <em>1.4.1</em> 版本有安全漏洞.</p> <p>关于如何更加安全的使用 <em>Nacos</em>, 官方的公众号文章给出了一个比较全面的方案: <a href="https://mp.weixin.qq.com/s/Ktz7mUZ6OjMjSDhji3BBSA" rel="nofollow" title="Nacos配置安全最佳实践">Nacos配置安全最佳实践</a> .<br> 文中推的阿里云微服务引擎(MSE)也是一个不错的方案, 安全性比较高, 看了下价格, 相比买 ECS 自己搭建集群, 价格上还是有些优势的.</p> </li></ol>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9c23d4dd7a1e7807df8e1da5be2ae1e0/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">JAVA_求最小公倍数</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/817f8922f7894aad4479fff2cec6c3ae/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">嵌入式人工智能/机器学习（AI/ML）以“生态&#43;集成&#43;定制”差异化发展</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>