<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Linux 系统中提供CPU性能分析工具整理 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Linux 系统中提供CPU性能分析工具整理" />
<meta property="og:description" content="Linux 系统中提供CPU性能分析工具整理 汇总 查看CPU信息 在linux操作系统中，CPU的信息在启动的过程中被装载到虚拟目录/proc下的cpuinfo文件中，我们可以通过 cat /proc/cpuinfo 查看一下：
cat /proc/cpuinfo 显示如下：
root@thead-910:~# cat /proc/cpuinfo processor : 0 hart : 0 isa : rv64imafdcsu mmu : sv39 model name : T-HEAD C910 freq : 1.2GHz icache : 64kB dcache : 64kB l2cache : 2MB tlb : 1024 4-ways cache line : 64Bytes address sizes : 40 bits physical, 39 bits virtual vector version : 0.7.1 processor : 1 hart : 1 isa : rv64imafdcsu mmu : sv39 model name : T-HEAD C910 freq : 1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/1135ce653d7e2a39e3447e2fc95c1259/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-10-13T10:51:01+08:00" />
<meta property="article:modified_time" content="2023-10-13T10:51:01+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Linux 系统中提供CPU性能分析工具整理</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="Linux_CPU_0"></a>Linux 系统中提供CPU性能分析工具整理</h2> 
<h3><a id="_1"></a>汇总</h3> 
<p><img src="https://images2.imgbox.com/7a/7a/MnbNG0Ky_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="CPU_3"></a>查看CPU信息</h3> 
<p>在linux操作系统中，CPU的信息在启动的过程中被装载到虚拟目录/proc下的cpuinfo文件中，我们可以通过 cat /proc/cpuinfo 查看一下：</p> 
<pre><code class="prism language-bash"><span class="token function">cat</span> /proc/cpuinfo
</code></pre> 
<p>显示如下：</p> 
<pre><code class="prism language-bash">root@thead-910:~<span class="token comment"># cat /proc/cpuinfo</span>
processor       <span class="token builtin class-name">:</span> <span class="token number">0</span>
hart            <span class="token builtin class-name">:</span> <span class="token number">0</span>
isa             <span class="token builtin class-name">:</span> rv64imafdcsu
mmu             <span class="token builtin class-name">:</span> sv39
model name      <span class="token builtin class-name">:</span> T-HEAD C910
freq            <span class="token builtin class-name">:</span> <span class="token number">1</span>.2GHz
icache          <span class="token builtin class-name">:</span> 64kB
dcache          <span class="token builtin class-name">:</span> 64kB
l2cache         <span class="token builtin class-name">:</span> 2MB
tlb             <span class="token builtin class-name">:</span> <span class="token number">1024</span> <span class="token number">4</span>-ways
cache line      <span class="token builtin class-name">:</span> 64Bytes
address sizes   <span class="token builtin class-name">:</span> <span class="token number">40</span> bits physical, <span class="token number">39</span> bits virtual
vector version  <span class="token builtin class-name">:</span> <span class="token number">0.7</span>.1

processor       <span class="token builtin class-name">:</span> <span class="token number">1</span>
hart            <span class="token builtin class-name">:</span> <span class="token number">1</span>
isa             <span class="token builtin class-name">:</span> rv64imafdcsu
mmu             <span class="token builtin class-name">:</span> sv39
model name      <span class="token builtin class-name">:</span> T-HEAD C910
freq            <span class="token builtin class-name">:</span> <span class="token number">1</span>.2GHz
icache          <span class="token builtin class-name">:</span> 64kB
dcache          <span class="token builtin class-name">:</span> 64kB
l2cache         <span class="token builtin class-name">:</span> 2MB
tlb             <span class="token builtin class-name">:</span> <span class="token number">1024</span> <span class="token number">4</span>-ways
cache line      <span class="token builtin class-name">:</span> 64Bytes
address sizes   <span class="token builtin class-name">:</span> <span class="token number">40</span> bits physical, <span class="token number">39</span> bits virtual
vector version  <span class="token builtin class-name">:</span> <span class="token number">0.7</span>.1
</code></pre> 
<p>通过 cpuinfo 可以看到主要信息：</p> 
<pre><code class="prism language-bash">两颗 RISC-V <span class="token number">64</span>位处理器，型号 T-HEAD C910
CPU 主频：1.2GHz
支持的 ISA 特性：
i: 基础整形指令集
m: 整型乘除法指令扩展
a: 原子操作指令扩展
f: 单精度指令扩展
d: 双精度指令扩展
c: <span class="token number">16</span>位压缩指令扩展
s: 特权态支持
u: 用户态支持
I/D CACHE: 64KB
二级 CACHE： 2MB
MMU TLB：4路1024个表项
物理地址位宽：40位
虚拟地址位宽: <span class="token number">39</span>位
矢量加速指令集版本: <span class="token number">0.7</span>.1
</code></pre> 
<h3><a id="_dhrystone_64"></a>测量处理器运算能力 dhrystone</h3> 
<p>Dhrystone是测量处理器运算能力的最常见基准程序之一，常用于处理器的整型运算性能的测量。Dhrystone的计量单位为每秒计算多少次Dhrystone，后来把在VAX-11/780机器上的测试结果1757 Dhrystones/s定义为1 Dhrystone MIPS(百万条指令每秒)。但其也有许多不足，Dhrystone不仅不适合于作为嵌入式系统的测试向量，甚至在其大多数场合下都不适合进行应用。</p> 
<p>安装 dhrystone：</p> 
<pre><code class="prism language-bash"><span class="token function">apt</span> <span class="token function">install</span> <span class="token parameter variable">-y</span> dhrystone
</code></pre> 
<pre><code class="prism language-bash">ICE-EVB 开发板测试：

dhrystone
Copy
在 ICE-EVB 开发板上运行结果如下：

Dhrystone Benchmark, Version <span class="token number">2.1</span> <span class="token punctuation">(</span>Language: C<span class="token punctuation">)</span>

Execution starts, <span class="token number">600000000</span> runs through Dhrystone
Execution ends

Final values of the variables used <span class="token keyword">in</span> the benchmark:

Int_Glob:            <span class="token number">5</span>
        should be:   <span class="token number">5</span>
Bool_Glob:           <span class="token number">1</span>
        should be:   <span class="token number">1</span>
Ch_1_Glob:           A
        should be:   A
Ch_2_Glob:           B
        should be:   B
Arr_1_Glob<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span>:       <span class="token number">7</span>
        should be:   <span class="token number">7</span>
Arr_2_Glob<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span>:    <span class="token number">600000010</span>
        should be:   Number_Of_Runs + <span class="token number">10</span>
Ptr_Glob-<span class="token operator">&gt;</span>
  Ptr_Comp:          <span class="token number">481216</span>
        should be:   <span class="token punctuation">(</span>implementation-dependent<span class="token punctuation">)</span>
  Discr:             <span class="token number">0</span>
        should be:   <span class="token number">0</span>
  Enum_Comp:         <span class="token number">2</span>
        should be:   <span class="token number">2</span>
  Int_Comp:          <span class="token number">17</span>
        should be:   <span class="token number">17</span>
  Str_Comp:          DHRYSTONE PROGRAM, SOME STRING
        should be:   DHRYSTONE PROGRAM, SOME STRING
Next_Ptr_Glob-<span class="token operator">&gt;</span>
  Ptr_Comp:          <span class="token number">481216</span>
        should be:   <span class="token punctuation">(</span>implementation-dependent<span class="token punctuation">)</span>, same as above
  Discr:             <span class="token number">0</span>
        should be:   <span class="token number">0</span>
  Enum_Comp:         <span class="token number">1</span>
        should be:   <span class="token number">1</span>
  Int_Comp:          <span class="token number">18</span>
        should be:   <span class="token number">18</span>
  Str_Comp:          DHRYSTONE PROGRAM, SOME STRING
        should be:   DHRYSTONE PROGRAM, SOME STRING
Int_1_Loc:           <span class="token number">5</span>
        should be:   <span class="token number">5</span>
Int_2_Loc:           <span class="token number">13</span>
        should be:   <span class="token number">13</span>
Int_3_Loc:           <span class="token number">7</span>
        should be:   <span class="token number">7</span>
Enum_Loc:            <span class="token number">1</span>
        should be:   <span class="token number">1</span>
Str_1_Loc:           DHRYSTONE PROGRAM, <span class="token number">1</span><span class="token string">'ST STRING
        should be:   DHRYSTONE PROGRAM, 1'</span>ST STRING
Str_2_Loc:           DHRYSTONE PROGRAM, <span class="token number">2</span><span class="token string">'ND STRING
        should be:   DHRYSTONE PROGRAM, 2'</span>ND STRING

Microseconds <span class="token keyword">for</span> one run through Dhrystone:    <span class="token number">0.1</span> 
Dhrystones per Second:                      <span class="token number">12329495.0</span>
</code></pre> 
<p>换算：</p> 
<pre><code class="prism language-bash"><span class="token number">12329495</span>/1757/1200<span class="token operator">=</span><span class="token number">5.8</span> DMIPS/MHz
</code></pre> 
<h3><a id="CPU_coremark_143"></a>衡量CPU性能 coremark</h3> 
<p>CoreMark是用来衡量CPU性能的标准。包含如下的运算法则：列举（寻找并排序），数学矩阵操作（普通矩阵运算）和状态机（用来确定输入流中是否包含有效数字），最后还包括CRC（循环冗余校验）。</p> 
<p>安装 coremark：</p> 
<pre><code class="prism language-bash"><span class="token function">apt</span> <span class="token function">install</span> <span class="token parameter variable">-y</span> coremark
</code></pre> 
<p>ICE-EVB 开发板测试命令：</p> 
<pre><code class="prism language-bash">coremark
</code></pre> 
<p>在 ICE-EVB 开发板上运行结果如下：</p> 
<pre><code class="prism language-bash">2K performance run parameters <span class="token keyword">for</span> coremark.
CoreMark Size    <span class="token builtin class-name">:</span> <span class="token number">666</span>
Total ticks      <span class="token builtin class-name">:</span> <span class="token number">13193</span>
Total <span class="token function">time</span> <span class="token punctuation">(</span>secs<span class="token punctuation">)</span>: <span class="token number">13.193000</span>
Iterations/Sec   <span class="token builtin class-name">:</span> <span class="token number">8337.754870</span>
Iterations       <span class="token builtin class-name">:</span> <span class="token number">110000</span>
Compiler version <span class="token builtin class-name">:</span> GCC8.4.0
Compiler flags   <span class="token builtin class-name">:</span> <span class="token parameter variable">-O2</span> <span class="token parameter variable">-O3</span> <span class="token parameter variable">-static</span> -funroll-all-loops -finline-limit<span class="token operator">=</span><span class="token number">500</span> -fgcse-sm -fno-schedule-insns <span class="token parameter variable">--param</span> max-rtl-if-conversion-unpredictable-cost<span class="token operator">=</span><span class="token number">100</span> -msignedness-cmpiv -fno-code-hoisting -mno-thread-jumps1 -mno-iv-adjust-addr-cost -mno-expand-split-imm  <span class="token parameter variable">-lrt</span>
Memory location  <span class="token builtin class-name">:</span> Please put data memory location here
            <span class="token punctuation">(</span>e.g. code <span class="token keyword">in</span> flash, data on heap etc<span class="token punctuation">)</span>
seedcrc          <span class="token builtin class-name">:</span> 0xe9f5
<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>crclist       <span class="token builtin class-name">:</span> 0xe714
<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>crcmatrix     <span class="token builtin class-name">:</span> 0x1fd7
<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>crcstate      <span class="token builtin class-name">:</span> 0x8e3a
<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>crcfinal      <span class="token builtin class-name">:</span> 0x33ff
Correct operation validated. See readme.txt <span class="token keyword">for</span> run and reporting rules.
CoreMark <span class="token number">1.0</span> <span class="token builtin class-name">:</span> <span class="token number">8337.754870</span> / GCC8.4.0 <span class="token parameter variable">-O2</span> <span class="token parameter variable">-O3</span> <span class="token parameter variable">-static</span> -funroll-all-loops -finline-limit<span class="token operator">=</span><span class="token number">500</span> -fgcse-sm -fno-schedule-insns <span class="token parameter variable">--param</span> max-rtl-if-conversion-unpredictable-cost<span class="token operator">=</span><span class="token number">100</span> -msignedness-cmpiv -fno-code-hoisting -mno-thread-jumps1 -mno-iv-adjust-addr-cost -mno-expand-split-imm  <span class="token parameter variable">-lrt</span> / Heap
</code></pre> 
<p>换算：</p> 
<pre><code class="prism language-bash"><span class="token number">8337.754870</span> / <span class="token number">1200</span> <span class="token operator">=</span> <span class="token number">6.948</span>
</code></pre> 
<p>其中 1200表示 1200MHz，也就是 1.2GHz，也即 ICE 开发板的 CPU 频率。</p> 
<h3><a id="whetstone_189"></a>whetstone</h3> 
<p>whetstone是一个用于测量CPU浮点计算性能的工具。</p> 
<p>安装 whetstone：</p> 
<pre><code class="prism language-bash"><span class="token function">apt</span> <span class="token function">install</span> <span class="token parameter variable">-y</span> whetstone
</code></pre> 
<p>ICE-EVB 开发板测试：</p> 
<pre><code class="prism language-bash">root@thead-910:~<span class="token comment"># whetstone 1000000</span>
Loops: <span class="token number">1000000</span>, Iterations: <span class="token number">1</span>, Duration: <span class="token number">19.778</span> sec.
C Converted Double Precision Whetstones: <span class="token number">5056.029</span> MIPS
</code></pre> 
<p>换算：</p> 
<pre><code class="prism language-bash"><span class="token number">5056.029</span>/1200<span class="token operator">=</span><span class="token number">4.2</span> MIPS/MHz
</code></pre> 
<p>其中 1200表示 1200MHz，也就是 1.2GHz，也即 ICE 开发板的 CPU 频率。</p> 
<h3><a id="linpack_215"></a>linpack</h3> 
<p>通过利用高性能计算机，用高斯消元法求解N元一次稠密线性代数方程组的测试，评价高性能计算机的浮点性能。</p> 
<p>安装 linpack：</p> 
<pre><code class="prism language-bash"><span class="token function">apt</span> <span class="token function">install</span> <span class="token parameter variable">-y</span> linpack
</code></pre> 
<p>ICE-EVB 开发板测试：</p> 
<pre><code class="prism language-bash">root@thead-910:~<span class="token comment"># linpack</span>
Unrolled Double Precision Linpack

Unrolled Double Precision Linpack

     norm. resid      resid           machep         x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>-1        x<span class="token punctuation">[</span>n-1<span class="token punctuation">]</span>-1
       <span class="token number">2.7</span>        <span class="token number">2</span>.40728912e-13  <span class="token number">2</span>.22044605e-16  <span class="token number">4</span>.08562073e-14 -2.94209102e-14
    <span class="token builtin class-name">times</span> are reported <span class="token keyword">for</span> matrices of order   <span class="token number">200</span>
      dgefa      dgesl      total       kflops     unit      ratio
 <span class="token builtin class-name">times</span> <span class="token keyword">for</span> array with leading dimension of  <span class="token number">201</span>
       <span class="token number">0.01</span>       <span class="token number">0.00</span>       <span class="token number">0.01</span>     <span class="token number">644521</span>       <span class="token number">0.00</span>       <span class="token number">0.15</span>
       <span class="token number">0.01</span>       <span class="token number">0.00</span>       <span class="token number">0.01</span>     <span class="token number">646445</span>       <span class="token number">0.00</span>       <span class="token number">0.15</span>
       <span class="token number">0.01</span>       <span class="token number">0.00</span>       <span class="token number">0.01</span>     <span class="token number">647683</span>       <span class="token number">0.00</span>       <span class="token number">0.15</span>
       <span class="token number">0.01</span>       <span class="token number">0.00</span>       <span class="token number">0.01</span>     <span class="token number">651032</span>       <span class="token number">0.00</span>       <span class="token number">0.15</span>
 <span class="token builtin class-name">times</span> <span class="token keyword">for</span> array with leading dimension of <span class="token number">200</span>
       <span class="token number">0.01</span>       <span class="token number">0.00</span>       <span class="token number">0.01</span>     <span class="token number">691623</span>       <span class="token number">0.00</span>       <span class="token number">0.14</span>
       <span class="token number">0.01</span>       <span class="token number">0.00</span>       <span class="token number">0.01</span>     <span class="token number">693661</span>       <span class="token number">0.00</span>       <span class="token number">0.14</span>
       <span class="token number">0.01</span>       <span class="token number">0.00</span>       <span class="token number">0.01</span>     <span class="token number">696428</span>       <span class="token number">0.00</span>       <span class="token number">0.14</span>
       <span class="token number">0.01</span>       <span class="token number">0.00</span>       <span class="token number">0.01</span>     <span class="token number">696383</span>       <span class="token number">0.00</span>       <span class="token number">0.14</span>
Unrolled Double  Precision <span class="token number">651032</span> Kflops <span class="token punctuation">;</span> <span class="token number">10</span> Reps
</code></pre> 
<p>换算：</p> 
<pre><code class="prism language-bash"><span class="token number">651032</span>/1200<span class="token operator">=</span><span class="token number">542.5</span> KFLOPS/MHz
</code></pre> 
<p>其中 1200表示 1200MHz，也就是 1.2GHz，也即 ICE 开发板的 CPU 频率。</p> 
<h3><a id="stream_258"></a>stream</h3> 
<p>Stream测试是内存测试中业界公认的内存带宽性能测试基准工具。</p> 
<p>安装 stream：</p> 
<pre><code class="prism language-bash"><span class="token function">apt</span> <span class="token function">install</span> <span class="token parameter variable">-y</span> stream
</code></pre> 
<p>ICE-EVB 开发板测试：</p> 
<pre><code class="prism language-bash">root@thead-910:~<span class="token comment"># stream</span>
-------------------------------------------------------------
STREAM version <span class="token variable">$Revision</span><span class="token builtin class-name">:</span> <span class="token number">5.10</span> $
-------------------------------------------------------------
This system uses <span class="token number">8</span> bytes per array element.
-------------------------------------------------------------
Array size <span class="token operator">=</span> <span class="token number">10000000</span> <span class="token punctuation">(</span>elements<span class="token punctuation">)</span>, Offset <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">(</span>elements<span class="token punctuation">)</span>
Memory per array <span class="token operator">=</span> <span class="token number">76.3</span> MiB <span class="token punctuation">(</span><span class="token operator">=</span> <span class="token number">0.1</span> GiB<span class="token punctuation">)</span>.
Total memory required <span class="token operator">=</span> <span class="token number">228.9</span> MiB <span class="token punctuation">(</span><span class="token operator">=</span> <span class="token number">0.2</span> GiB<span class="token punctuation">)</span>.
Each kernel will be executed <span class="token number">10</span> times.
 The *best* <span class="token function">time</span> <span class="token keyword">for</span> each kernel <span class="token punctuation">(</span>excluding the first iteration<span class="token punctuation">)</span>
 will be used to compute the reported bandwidth.
-------------------------------------------------------------
Your clock granularity/precision appears to be <span class="token number">1</span> microseconds.
Each <span class="token builtin class-name">test</span> below will take on the order of <span class="token number">30088</span> microseconds.
   <span class="token punctuation">(</span><span class="token operator">=</span> <span class="token number">30088</span> clock ticks<span class="token punctuation">)</span>
Increase the size of the arrays <span class="token keyword">if</span> this shows that
you are not getting at least <span class="token number">20</span> clock ticks per test.
-------------------------------------------------------------
WARNING -- The above is only a rough guideline.
For best results, please be sure you know the
precision of your system timer.
-------------------------------------------------------------
Function    Best Rate MB/s  Avg <span class="token function">time</span>     Min <span class="token function">time</span>     Max <span class="token function">time</span>
Copy:            <span class="token number">6965.0</span>     <span class="token number">0.022986</span>     <span class="token number">0.022972</span>     <span class="token number">0.023003</span>
Scale:           <span class="token number">7020.0</span>     <span class="token number">0.022831</span>     <span class="token number">0.022792</span>     <span class="token number">0.022890</span>
Add:             <span class="token number">6095.7</span>     <span class="token number">0.039484</span>     <span class="token number">0.039372</span>     <span class="token number">0.039601</span>
Triad:           <span class="token number">6105.9</span>     <span class="token number">0.040019</span>     <span class="token number">0.039306</span>     <span class="token number">0.042522</span>
-------------------------------------------------------------
Solution Validates: avg error <span class="token function">less</span> than <span class="token number">1</span>.000000e-13 on all three arrays
-------------------------------------------------------------
</code></pre> 
<h3><a id="sysbench_303"></a>sysbench</h3> 
<p>sysbench是一个开源的、模块化的、跨平台的多线程性能测试工具，可以用来进行CPU、内存、磁盘I/O、线程、数据库的性能测试。</p> 
<p>安装 sysbench：</p> 
<pre><code class="prism language-bash"><span class="token function">apt</span> <span class="token function">install</span> <span class="token parameter variable">-y</span> sysbench
</code></pre> 
<p>ICE-EVB 开发板测试：</p> 
<p>测试线程：</p> 
<pre><code class="prism language-bash"><span class="token function">bash</span> root@thead-910:/<span class="token comment"># ./sysbench --test=threads --num-threads=32 --thread-yields=100 --thread-lock=8 run sysbench 0.5: multi-threaded system evaluation benchmark</span>

Running the <span class="token builtin class-name">test</span> with following options: Number of threads: <span class="token number">32</span> Random number generator seed is <span class="token number">0</span> and will be ignored

Threads started<span class="token operator">!</span>

General statistics: total time: <span class="token number">2</span>.9138s total number of events: <span class="token number">10000</span> total <span class="token function">time</span> taken by event execution: <span class="token number">93</span>.1165s response time: min: <span class="token number">0</span>.14ms avg: <span class="token number">9</span>.31ms max: <span class="token number">82</span>.38ms approx. <span class="token number">95</span> percentile: <span class="token number">32</span>.83ms

Threads fairness: events <span class="token punctuation">(</span>avg/stddev<span class="token punctuation">)</span>: <span class="token number">312.5000</span>/14.83 execution <span class="token function">time</span> <span class="token punctuation">(</span>avg/stddev<span class="token punctuation">)</span>: <span class="token number">2.9099</span>/0.00
</code></pre> 
<p>换算：</p> 
<pre><code class="prism language-bash">  <span class="token number">14.83</span>/2.9099<span class="token operator">=</span><span class="token number">5.1</span>
</code></pre> 
<p>其他测试项目：</p> 
<ul><li> <p>测试CPU:</p> <pre><code class="prism language-bash">root@thead-910:~<span class="token comment"># ./sysbench --test=cpu --cpu-max-prime=20000 --num-threads=2 run</span>
sysbench <span class="token number">0.5</span>:  multi-threaded system evaluation benchmark

Running the <span class="token builtin class-name">test</span> with following options:
Number of threads: <span class="token number">2</span>
Random number generator seed is <span class="token number">0</span> and will be ignored


Primer numbers limit: <span class="token number">20000</span>

Threads started<span class="token operator">!</span>


General statistics:
    total time:                          <span class="token number">15</span>.0576s
    total number of events:              <span class="token number">10000</span>
    total <span class="token function">time</span> taken by event execution: <span class="token number">30</span>.1038s
    response time:
         min:                                  <span class="token number">3</span>.00ms
         avg:                                  <span class="token number">3</span>.01ms
         max:                                  <span class="token number">3</span>.12ms
         approx.  <span class="token number">95</span> percentile:               <span class="token number">3</span>.01ms

Threads fairness:
    events <span class="token punctuation">(</span>avg/stddev<span class="token punctuation">)</span>:           <span class="token number">5000.0000</span>/0.00
    execution <span class="token function">time</span> <span class="token punctuation">(</span>avg/stddev<span class="token punctuation">)</span>:   <span class="token number">15.0519</span>/0.00

</code></pre> </li><li> <p>测试IO：</p> </li></ul> 
<pre><code class="prism language-bash">root@thead-910:~<span class="token comment"># .sysbench --test=fileio --num-threads=16 --file-total-size=2G --file-test-mode=rndrw prepare</span>
sysbench <span class="token number">0.5</span>:  multi-threaded system evaluation benchmark

<span class="token number">128</span> files, 16384Kb each, 2048Mb total
Creating files <span class="token keyword">for</span> the test<span class="token punctuation">..</span>.
Extra <span class="token function">file</span> <span class="token function">open</span> flags: <span class="token number">0</span>
Creating <span class="token function">file</span> test_file.0
Creating <span class="token function">file</span> test_file.1
<span class="token punctuation">..</span>.
Creating <span class="token function">file</span> test_file.125
Creating <span class="token function">file</span> test_file.126
Creating <span class="token function">file</span> test_file.127
<span class="token number">2147483648</span> bytes written <span class="token keyword">in</span> <span class="token number">110.50</span> seconds <span class="token punctuation">(</span><span class="token number">18.53</span> MB/sec<span class="token punctuation">)</span>.
</code></pre> 
<pre><code class="prism language-bash">root@thead-910:~<span class="token comment"># sysbench --test=fileio --num-threads=20 --file-total-size=2G --file-test-mode=rndrw run sysbench 0.5: multi-threaded system evaluation benchmark</span>

Running the <span class="token builtin class-name">test</span> with following options: Number of threads: <span class="token number">20</span> Random number generator seed is <span class="token number">0</span> and will be ignored

Extra <span class="token function">file</span> <span class="token function">open</span> flags: <span class="token number">0</span> <span class="token number">128</span> files, 16Mb each 2Gb total <span class="token function">file</span> size Block size 16Kb Number of IO requests: <span class="token number">10000</span> Read/Write ratio <span class="token keyword">for</span> combined random IO test: <span class="token number">1.50</span> Periodic FSYNC enabled, calling fsync<span class="token punctuation">(</span><span class="token punctuation">)</span> each <span class="token number">100</span> requests. Calling fsync<span class="token punctuation">(</span><span class="token punctuation">)</span> at the end of test, Enabled. Using synchronous I/O mode Doing random r/w <span class="token builtin class-name">test</span> Threads started<span class="token operator">!</span>

Operations performed: <span class="token number">6000</span> reads, <span class="token number">4000</span> writes, <span class="token number">12800</span> Other <span class="token operator">=</span> <span class="token number">22800</span> Total Read <span class="token number">93</span>.75Mb Written <span class="token number">62</span>.5Mb Total transferred <span class="token number">156</span>.25Mb <span class="token punctuation">(</span><span class="token number">34</span>.834Mb/sec<span class="token punctuation">)</span> <span class="token number">2229.38</span> Requests/sec executed

General statistics: total time: <span class="token number">4</span>.4856s total number of events: <span class="token number">10000</span> total <span class="token function">time</span> taken by event execution: <span class="token number">0</span>.8171s response time: min: <span class="token number">0</span>.01ms avg: <span class="token number">0</span>.08ms max: <span class="token number">20</span>.83ms approx. <span class="token number">95</span> percentile: <span class="token number">0</span>.08ms

Threads fairness: events <span class="token punctuation">(</span>avg/stddev<span class="token punctuation">)</span>: <span class="token number">500.0000</span>/179.75 execution <span class="token function">time</span> <span class="token punctuation">(</span>avg/stddev<span class="token punctuation">)</span>: <span class="token number">0.0409</span>/0.02
</code></pre> 
<pre><code class="prism language-bash">  root@thead-910:~<span class="token comment"># ./sysbench --test=fileio --num-threads=20 --file-total-size=2G --file-test-mode=rndrw cleanup</span>
  sysbench <span class="token number">0.5</span>:  multi-threaded system evaluation benchmark

  Removing <span class="token builtin class-name">test</span> files<span class="token punctuation">..</span>.
</code></pre> 
<ul><li>测试内存：</li></ul> 
<pre><code class="prism language-bash">root@thead-910:~<span class="token comment"># sysbench --test=memory --memory-block-size=8k --memory-total-size=1G run sysbench 0.5: multi-threaded system evaluation benchmark</span>

Running the <span class="token builtin class-name">test</span> with following options: Number of threads: <span class="token number">1</span> Random number generator seed is <span class="token number">0</span> and will be ignored

Threads started<span class="token operator">!</span>

Operations performed: <span class="token number">131072</span> <span class="token punctuation">(</span><span class="token number">374615.49</span> ops/sec<span class="token punctuation">)</span>

<span class="token number">1024.00</span> MB transferred <span class="token punctuation">(</span><span class="token number">2926.68</span> MB/sec<span class="token punctuation">)</span>

General statistics: total time: <span class="token number">0</span>.3499s total number of events: <span class="token number">131072</span> total <span class="token function">time</span> taken by event execution: <span class="token number">0</span>.2768s response time: min: <span class="token number">0</span>.00ms avg: <span class="token number">0</span>.00ms max: <span class="token number">0</span>.06ms approx. <span class="token number">95</span> percentile: <span class="token number">0</span>.00ms

Threads fairness: events <span class="token punctuation">(</span>avg/stddev<span class="token punctuation">)</span>: <span class="token number">131072.0000</span>/0.00 execution <span class="token function">time</span> <span class="token punctuation">(</span>avg/stddev<span class="token punctuation">)</span>: <span class="token number">0.2768</span>/0.00
</code></pre> 
<ul><li>测试mutex：</li></ul> 
<pre><code class="prism language-bash">  root@thead-910:~<span class="token comment"># sysbench --test=mutex --num-threads=64 run</span>
  sysbench <span class="token number">0.5</span>:  multi-threaded system evaluation benchmark

  Running the <span class="token builtin class-name">test</span> with following options:
  Number of threads: <span class="token number">64</span>
  Random number generator seed is <span class="token number">0</span> and will be ignored


  Threads started<span class="token operator">!</span>


  General statistics:
      total time:                          <span class="token number">1</span>.2616s
      total number of events:              <span class="token number">64</span>
      total <span class="token function">time</span> taken by event execution: <span class="token number">76</span>.6870s
      response time:
           min:                               <span class="token number">1066</span>.46ms
           avg:                               <span class="token number">1198</span>.23ms
           max:                               <span class="token number">1254</span>.10ms
           approx.  <span class="token number">95</span> percentile:            <span class="token number">1251</span>.30ms

  Threads fairness:
      events <span class="token punctuation">(</span>avg/stddev<span class="token punctuation">)</span>:           <span class="token number">1.0000</span>/0.00
      execution <span class="token function">time</span> <span class="token punctuation">(</span>avg/stddev<span class="token punctuation">)</span>:   <span class="token number">1.1982</span>/0.05
</code></pre> 
<h3><a id="nbench_462"></a>nbench</h3> 
<p>nbench是一个简单的用于测试处理器、存储器性能的基准测试程序。</p> 
<p>安装 nbench：</p> 
<pre><code class="prism language-bash"><span class="token function">apt</span> <span class="token function">install</span> <span class="token parameter variable">-y</span> nbench
</code></pre> 
<p>ICE-EVB 开发板测试：</p> 
<pre><code class="prism language-bash">root@thead-910:~<span class="token comment"># nbench</span>

BYTEmark* Native Mode Benchmark ver. <span class="token number">2</span> <span class="token punctuation">(</span><span class="token number">10</span>/95<span class="token punctuation">)</span>
Index-split by Andrew D. Balsa <span class="token punctuation">(</span><span class="token number">11</span>/97<span class="token punctuation">)</span>
Linux/Unix* port by Uwe F. Mayer <span class="token punctuation">(</span><span class="token number">12</span>/96,11/97<span class="token punctuation">)</span>

TEST                <span class="token builtin class-name">:</span> Iterations/sec.  <span class="token builtin class-name">:</span> Old Index   <span class="token builtin class-name">:</span> New Index
                    <span class="token builtin class-name">:</span>                  <span class="token builtin class-name">:</span> Pentium <span class="token number">90</span>* <span class="token builtin class-name">:</span> AMD K6/233*
--------------------:------------------:-------------:------------
NUMERIC SORT        <span class="token builtin class-name">:</span>          <span class="token number">676.01</span>  <span class="token builtin class-name">:</span>      <span class="token number">17.34</span>  <span class="token builtin class-name">:</span>       <span class="token number">5.69</span>
STRING SORT         <span class="token builtin class-name">:</span>          <span class="token number">148.55</span>  <span class="token builtin class-name">:</span>      <span class="token number">66.38</span>  <span class="token builtin class-name">:</span>      <span class="token number">10.27</span>
BITFIELD            <span class="token builtin class-name">:</span>      <span class="token number">1</span>.6208e+08  <span class="token builtin class-name">:</span>      <span class="token number">27.80</span>  <span class="token builtin class-name">:</span>       <span class="token number">5.81</span>
FP EMULATION        <span class="token builtin class-name">:</span>          <span class="token number">154.38</span>  <span class="token builtin class-name">:</span>      <span class="token number">74.08</span>  <span class="token builtin class-name">:</span>      <span class="token number">17.09</span>
FOURIER             <span class="token builtin class-name">:</span>           <span class="token number">21743</span>  <span class="token builtin class-name">:</span>      <span class="token number">24.73</span>  <span class="token builtin class-name">:</span>      <span class="token number">13.89</span>
ASSIGNMENT          <span class="token builtin class-name">:</span>           <span class="token number">17.95</span>  <span class="token builtin class-name">:</span>      <span class="token number">68.30</span>  <span class="token builtin class-name">:</span>      <span class="token number">17.72</span>
IDEA                <span class="token builtin class-name">:</span>          <span class="token number">3738.9</span>  <span class="token builtin class-name">:</span>      <span class="token number">57.19</span>  <span class="token builtin class-name">:</span>      <span class="token number">16.98</span>
HUFFMAN             <span class="token builtin class-name">:</span>          <span class="token number">1657.3</span>  <span class="token builtin class-name">:</span>      <span class="token number">45.96</span>  <span class="token builtin class-name">:</span>      <span class="token number">14.68</span>
NEURAL NET          <span class="token builtin class-name">:</span>           <span class="token number">14.84</span>  <span class="token builtin class-name">:</span>      <span class="token number">23.84</span>  <span class="token builtin class-name">:</span>      <span class="token number">10.03</span>
LU DECOMPOSITION    <span class="token builtin class-name">:</span>          <span class="token number">649.13</span>  <span class="token builtin class-name">:</span>      <span class="token number">33.63</span>  <span class="token builtin class-name">:</span>      <span class="token number">24.28</span>
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>ORIGINAL BYTEMARK <span class="token assign-left variable">RESULTS</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
INTEGER INDEX       <span class="token builtin class-name">:</span> <span class="token number">45.842</span>
FLOATING-POINT INDEX: <span class="token number">27.063</span>
Baseline <span class="token punctuation">(</span>MSDOS*<span class="token punctuation">)</span>   <span class="token builtin class-name">:</span> Pentium* <span class="token number">90</span>, <span class="token number">256</span> KB L2-cache, Watcom* compiler <span class="token number">10.0</span>
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>LINUX DATA <span class="token assign-left variable">BELOW</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
CPU                 <span class="token builtin class-name">:</span> Dual T-HEAD C910
L2 Cache            <span class="token builtin class-name">:</span>
OS                  <span class="token builtin class-name">:</span> Linux <span class="token number">5.10</span>.4
C compiler          <span class="token builtin class-name">:</span> riscv64-unknown-linux-gnu-gcc
libc                <span class="token builtin class-name">:</span> static
MEMORY INDEX        <span class="token builtin class-name">:</span> <span class="token number">10.186</span>
INTEGER INDEX       <span class="token builtin class-name">:</span> <span class="token number">12.479</span>
FLOATING-POINT INDEX: <span class="token number">15.010</span>
Baseline <span class="token punctuation">(</span>LINUX<span class="token punctuation">)</span>    <span class="token builtin class-name">:</span> AMD K6/233*, <span class="token number">512</span> KB L2-cache, gcc <span class="token number">2.7</span>.2.3, libc-5.4.38
* Trademarks are property of their respective holder.
</code></pre> 
<h3><a id="cache_calibrator_511"></a>cache_calibrator</h3> 
<p>cache_calibrator 可以测量 cache 相关的性能参数。</p> 
<p>安装 cache_calibrator：</p> 
<pre><code class="prism language-bash"><span class="token function">apt</span> <span class="token function">install</span> <span class="token parameter variable">-y</span> cache-calibrator
</code></pre> 
<p>ICE-EVB 开发板测试：</p> 
<pre><code class="prism language-bash">cache_calibrator <span class="token number">1200</span> 10M <span class="token function">file</span>
</code></pre> 
<p>在 ICE-EVB 开发板上运行结果如下：</p> 
<pre><code class="prism language-bash">Calibrator v0.9e
<span class="token punctuation">(</span>by Stefan.Manegold@cwi.nl, http://www.cwi.nl/~manegold/<span class="token punctuation">)</span>
e16a9010 <span class="token number">274364796944</span> <span class="token number">4096</span>    <span class="token number">16</span>
e16a9fff <span class="token number">274364801023</span> <span class="token number">4096</span>  <span class="token number">4095</span>
e16aa000 <span class="token number">274364801024</span> <span class="token number">4096</span>     <span class="token number">0</span>

MINTIME <span class="token operator">=</span> <span class="token number">10000</span>

analyzing cache throughput<span class="token punctuation">..</span>.
      range      stride       spots     brutto-  netto-time
   <span class="token number">10485760</span>           <span class="token number">8</span>     <span class="token number">1310720</span>       <span class="token number">17472</span>         <span class="token number">273</span>

analyzing cache latency<span class="token punctuation">..</span>.
      range      stride       spots     brutto-  netto-time
   <span class="token number">10485760</span>           <span class="token number">8</span>     <span class="token number">1310720</span>      <span class="token number">139776</span>         <span class="token number">273</span>

analyzing TLB latency<span class="token punctuation">..</span>.
      range      stride       spots     brutto-  netto-time
    <span class="token number">1474560</span>        <span class="token number">1152</span>        <span class="token number">1280</span>       <span class="token number">18176</span>        <span class="token number">1136</span>


CPU loop + L1 access:       <span class="token number">2.50</span> ns <span class="token operator">=</span>   <span class="token number">3</span> cy
             <span class="token punctuation">(</span> delay:       <span class="token number">0.00</span> ns <span class="token operator">=</span>   <span class="token number">0</span> cy <span class="token punctuation">)</span>

caches:
level  size    linesize   miss-latency        replace-time
  <span class="token number">1</span>     <span class="token number">64</span> KB  <span class="token number">128</span> bytes    <span class="token number">9.19</span> ns <span class="token operator">=</span>  <span class="token number">11</span> cy    <span class="token number">9.16</span> ns <span class="token operator">=</span>  <span class="token number">11</span> cy
  <span class="token number">2</span>      <span class="token number">2</span> MB  <span class="token number">128</span> bytes   <span class="token number">19.05</span> ns <span class="token operator">=</span>  <span class="token number">23</span> cy   <span class="token number">19.09</span> ns <span class="token operator">=</span>  <span class="token number">23</span> cy

TLBs:
level <span class="token comment">#entries  pagesize  miss-latency</span>
  <span class="token number">1</span>       <span class="token number">20</span>       <span class="token number">4</span> KB     <span class="token number">3.34</span> ns <span class="token operator">=</span>   <span class="token number">4</span> cy 

<span class="token comment"># ls</span>
file.cache-replace-time.gp
file.TLB-miss-latency.data
file.TLB-miss-latency.gp
file.cache-miss-latency.data
file.cache-miss-latency.gp
file.cache-replace-time.data


</code></pre> 
<p>其中 1200表示 1200MHz，也就是 1.2GHz，也即 ICE 开发板的 CPU 频率；跑完后生成了很多以“file”开头的文件，可以观测 cache 各个方面的性能。</p> 
<h3><a id="iperf3_573"></a>iperf3</h3> 
<p>iperf 用于测量网络性能。</p> 
<p>安装iperf3：</p> 
<pre><code class="prism language-bash"><span class="token function">apt</span> <span class="token function">install</span> <span class="token parameter variable">-y</span> iperf3
</code></pre> 
<p>启动 perf3 server：</p> 
<pre><code class="prism language-bash">iperf3 <span class="token parameter variable">-s</span> <span class="token operator">&gt;</span> /dev/null <span class="token operator">&amp;</span>
</code></pre> 
<p>开始测试：</p> 
<pre><code class="prism language-bash">iperf3 <span class="token parameter variable">-c</span> <span class="token number">127.0</span>.0.1
</code></pre> 
<p>在ICE 开发板上，测试数组如下：</p> 
<pre><code class="prism language-bash">root@thead-910:~<span class="token comment"># iperf3 -c 127.0.0.1</span>
Connecting to <span class="token function">host</span> <span class="token number">127.0</span>.0.1, port <span class="token number">5201</span>
<span class="token punctuation">[</span>  <span class="token number">5</span><span class="token punctuation">]</span> <span class="token builtin class-name">local</span> <span class="token number">127.0</span>.0.1 port <span class="token number">51114</span> connected to <span class="token number">127.0</span>.0.1 port <span class="token number">5201</span>
<span class="token punctuation">[</span> ID<span class="token punctuation">]</span> Interval           Transfer     Bitrate         Retr  Cwnd
<span class="token punctuation">[</span>  <span class="token number">5</span><span class="token punctuation">]</span>   <span class="token number">0.00</span>-1.00   sec   <span class="token number">454</span> MBytes  <span class="token number">3.80</span> Gbits/sec    <span class="token number">0</span>   <span class="token number">1.12</span> MBytes
<span class="token punctuation">[</span>  <span class="token number">5</span><span class="token punctuation">]</span>   <span class="token number">1.00</span>-2.00   sec   <span class="token number">452</span> MBytes  <span class="token number">3.79</span> Gbits/sec    <span class="token number">0</span>   <span class="token number">1.12</span> MBytes
<span class="token punctuation">[</span>  <span class="token number">5</span><span class="token punctuation">]</span>   <span class="token number">2.00</span>-3.00   sec   <span class="token number">430</span> MBytes  <span class="token number">3.61</span> Gbits/sec    <span class="token number">0</span>   <span class="token number">1.12</span> MBytes
<span class="token punctuation">[</span>  <span class="token number">5</span><span class="token punctuation">]</span>   <span class="token number">3.00</span>-4.00   sec   <span class="token number">445</span> MBytes  <span class="token number">3.73</span> Gbits/sec    <span class="token number">0</span>   <span class="token number">1.12</span> MBytes
<span class="token punctuation">[</span>  <span class="token number">5</span><span class="token punctuation">]</span>   <span class="token number">4.00</span>-5.00   sec   <span class="token number">452</span> MBytes  <span class="token number">3.79</span> Gbits/sec    <span class="token number">0</span>   <span class="token number">1.50</span> MBytes
<span class="token punctuation">[</span>  <span class="token number">5</span><span class="token punctuation">]</span>   <span class="token number">5.00</span>-6.00   sec   <span class="token number">442</span> MBytes  <span class="token number">3.71</span> Gbits/sec    <span class="token number">0</span>   <span class="token number">1.50</span> MBytes
<span class="token punctuation">[</span>  <span class="token number">5</span><span class="token punctuation">]</span>   <span class="token number">6.00</span>-7.00   sec   <span class="token number">448</span> MBytes  <span class="token number">3.76</span> Gbits/sec    <span class="token number">0</span>   <span class="token number">1.94</span> MBytes
<span class="token punctuation">[</span>  <span class="token number">5</span><span class="token punctuation">]</span>   <span class="token number">7.00</span>-8.00   sec   <span class="token number">451</span> MBytes  <span class="token number">3.78</span> Gbits/sec    <span class="token number">0</span>   <span class="token number">2.12</span> MBytes
<span class="token punctuation">[</span>  <span class="token number">5</span><span class="token punctuation">]</span>   <span class="token number">8.00</span>-9.00   sec   <span class="token number">464</span> MBytes  <span class="token number">3.90</span> Gbits/sec    <span class="token number">0</span>   <span class="token number">2.81</span> MBytes
<span class="token punctuation">[</span>  <span class="token number">5</span><span class="token punctuation">]</span>   <span class="token number">9.00</span>-10.00  sec   <span class="token number">458</span> MBytes  <span class="token number">3.84</span> Gbits/sec    <span class="token number">0</span>   <span class="token number">3.00</span> MBytes
- - - - - - - - - - - - - - - - - - - - - - - - -
<span class="token punctuation">[</span> ID<span class="token punctuation">]</span> Interval           Transfer     Bitrate         Retr
<span class="token punctuation">[</span>  <span class="token number">5</span><span class="token punctuation">]</span>   <span class="token number">0.00</span>-10.00  sec  <span class="token number">4.39</span> GBytes  <span class="token number">3.77</span> Gbits/sec    <span class="token number">0</span>             sender
<span class="token punctuation">[</span>  <span class="token number">5</span><span class="token punctuation">]</span>   <span class="token number">0.00</span>-10.00  sec  <span class="token number">4.39</span> GBytes  <span class="token number">3.77</span> Gbits/sec                  receiver
</code></pre> 
<p>如果需要测试物理网卡的速度，可以在远程电脑上启动 iperf3 服务，然后再通过 iperf3 -c &lt;host_ip&gt; 来测试网速。</p> 
<h3><a id="_stress_ng_618"></a>压力测试神器 stress_ng</h3> 
<p>stress-ng是stress的加强版，完全兼容stress，并在此基础上增加了几百个参数，堪称压测工具中的瑞士军刀。</p> 
<p>安装 stress-ng：</p> 
<pre><code class="prism language-bash"><span class="token function">apt</span> <span class="token function">install</span> <span class="token parameter variable">-y</span> stress-ng
</code></pre> 
<pre><code class="prism language-bash">应用场景1：CPU 密集型进程（使用CPU的进程）

stress-ng <span class="token parameter variable">--cpu</span> <span class="token number">2</span> --cpu-method all

应用场景2：I/O 密集型进程（等待IO的进程）

stress-ng <span class="token parameter variable">-i</span> <span class="token number">4</span> <span class="token parameter variable">--hdd</span> <span class="token number">1</span> <span class="token parameter variable">--timeout</span> <span class="token number">600</span>

应用场景3：大量进程的场景（等待CPU的进程-<span class="token operator">&gt;</span>进程间会争抢CPU）

stress-ng <span class="token parameter variable">-c</span> <span class="token number">16</span> <span class="token parameter variable">--timeout</span> <span class="token number">600</span>
</code></pre> 
<h3><a id="__perf_641"></a>性能分析工具 – perf</h3> 
<p>Perf 是内置于 Linux 内核源码树中的性能剖析(profiling)工具，它基于事件采样原理，以性能事件为基础，支持针对处理器相关性能指标与操作系统相关性能指标的性能剖析，常用于性能瓶颈的查找与热点代码的定位。</p> 
<p>通过它，应用程序可以利用 PMU，tracepoint 和内核中的特殊计数器来进行性能统计。它不但可以分析指定应用程序的性能问题 (per thread)，也可以用来分析内核的性能问题，当然也可以同时分析应用代码和内核，从而全面理解应用程序中的性能瓶颈。</p> 
<p>使用 perf，您可以分析程序运行期间发生的硬件事件，比如 instructions retired ，processor clock cycles 等；您也可以分析软件事件，比如 Page Fault 和进程切换。这使得 Perf 拥有了众多的性能分析能力，举例来说，使用 Perf 可以计算每个时钟周期内的指令数，称为 IPC，IPC 偏低表明代码没有很好地利用 CPU。Perf 还可以对程序进行函数级别的采样，从而了解程序的性能瓶颈究竟在哪里等等。Perf 还可以替代 strace，可以添加动态内核 probe 点，还可以做 benchmark 衡量调度器的好坏。</p> 
<p>安装perf</p> 
<pre><code class="prism language-bash"><span class="token function">apt</span> <span class="token function">install</span> perf
</code></pre> 
<p>装完之后就可以使用perf命令了。</p> 
<pre><code class="prism language-bash"> usage: perf <span class="token punctuation">[</span>--version<span class="token punctuation">]</span> <span class="token punctuation">[</span>--help<span class="token punctuation">]</span> <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> COMMAND <span class="token punctuation">[</span>ARGS<span class="token punctuation">]</span>

 The <span class="token function">most</span> commonly used perf commands are:
   annotate        Read perf.data <span class="token punctuation">(</span>created by perf record<span class="token punctuation">)</span> and display annotatedd code
   archive         Create archive with object files with build-ids found <span class="token keyword">in</span> perff.data <span class="token function">file</span>
   bench           General framework <span class="token keyword">for</span> benchmark suites
   buildid-cache   Manage build-id cache.
   buildid-list    List the buildids <span class="token keyword">in</span> a perf.data <span class="token function">file</span>
   c2c             Shared Data C2C/HITM Analyzer.
   config          Get and <span class="token builtin class-name">set</span> variables <span class="token keyword">in</span> a configuration file.
   data            Data <span class="token function">file</span> related processing
   <span class="token function">diff</span>            Read perf.data files and display the differential profile
   evlist          List the event names <span class="token keyword">in</span> a perf.data <span class="token function">file</span>
   ftrace          simple wrapper <span class="token keyword">for</span> kernel<span class="token string">'s ftrace functionality
   inject          Filter to augment the events stream with additional informatiion
   kallsyms        Searches running kernel for symbols
   kmem            Tool to trace/measure kernel memory properties
   kvm             Tool to trace/measure kvm guest os
   list            List all symbolic event types
   lock            Analyze lock events
   mem             Profile memory accesses
   record          Run a command and record its profile into perf.data
   report          Read perf.data (created by perf record) and display the profiile
   sched           Tool to trace/measure scheduler properties (latencies)
   script          Read perf.data (created by perf record) and display trace outtput
   stat            Run a command and gather performance counter statistics
   test            Runs sanity tests.
   timechart       Tool to visualize total system behavior during a workload
   top             System profiling tool.
   version         display the version of perf binary

 See '</span>perf <span class="token builtin class-name">help</span> COMMAND' <span class="token keyword">for</span> <span class="token function">more</span> information on a specific command.
</code></pre> 
<ul><li>安装flamegraph</li></ul> 
<p>火焰图是脚本，只需要下载:</p> 
<pre><code class="prism language-bash"><span class="token function">git</span> clone https://github.com/brendangregg/FlameGraph.git
</code></pre> 
<p>查看当前软硬件环境、支持的性能事件<br> 查看所有分类事件的个数:</p> 
<pre><code class="prism language-bash">perf list <span class="token operator">|</span> <span class="token function">awk</span> -F: <span class="token string">'/Tracepoint event/ { lib[$1]++ } END { for (l in lib) { printf " %-16s %d\n", l, lib[l] } }'</span> <span class="token operator">|</span> <span class="token function">sort</span> <span class="token operator">|</span> <span class="token function">column</span>
</code></pre> 
<p>在 ICE 芯片运行结果如下：</p> 
<pre><code class="prism language-bash">root@thead-910:~<span class="token comment"># perf list | awk -F: '/Tracepoint event/ { lib[$1]++ } END { for (l in lib) { printf " %-16s %d\n", l, lib[l] } }' | sort | column</span>
   9p             <span class="token number">3</span>        iomap          <span class="token number">9</span>        random         <span class="token number">16</span>
   alarmtimer     <span class="token number">4</span>        irq            <span class="token number">5</span>        ras            <span class="token number">4</span>
   block          <span class="token number">19</span>       jbd2           <span class="token number">17</span>       raw_syscalls   <span class="token number">2</span>
   bpf_test_run   <span class="token number">1</span>        kmem           <span class="token number">13</span>       rcu            <span class="token number">1</span>
   bpf_trace      <span class="token number">1</span>        kyber          <span class="token number">3</span>        regmap         <span class="token number">15</span>
   cgroup         <span class="token number">13</span>       mdio           <span class="token number">1</span>        rpcgss         <span class="token number">26</span>
   clk            <span class="token number">16</span>       migrate        <span class="token number">1</span>        sched          <span class="token number">20</span>
   compaction     <span class="token number">14</span>       mmap           <span class="token number">1</span>        signal         <span class="token number">2</span>
   cpuhp          <span class="token number">3</span>        mmc            <span class="token number">2</span>        skb            <span class="token number">3</span>
   dma_fence      <span class="token number">7</span>        module         <span class="token number">5</span>        smbus          <span class="token number">4</span>
   dwc3           <span class="token number">15</span>       napi           <span class="token number">1</span>        sock           <span class="token number">3</span>
   ext4           <span class="token number">117</span>      neigh          <span class="token number">7</span>        spi            <span class="token number">7</span>
   fib            <span class="token number">1</span>        net            <span class="token number">18</span>       sunrpc         <span class="token number">127</span>
   fib6           <span class="token number">1</span>        nfs            <span class="token number">58</span>       swiotlb        <span class="token number">1</span>
   filelock       <span class="token number">12</span>       nfs4           <span class="token number">87</span>       task           <span class="token number">2</span>
   filemap        <span class="token number">4</span>        oom            <span class="token number">8</span>        tcp            <span class="token number">7</span>
   ftrace         <span class="token number">1</span>        page_pool      <span class="token number">4</span>        timer          <span class="token number">12</span>
   gadget         <span class="token number">24</span>       pagemap        <span class="token number">2</span>        udp            <span class="token number">1</span>
   gpio           <span class="token number">2</span>        percpu         <span class="token number">5</span>        vmscan         <span class="token number">14</span>
   i2c            <span class="token number">4</span>        power          <span class="token number">22</span>       workqueue      <span class="token number">4</span>
   initcall       <span class="token number">3</span>        printk         <span class="token number">1</span>        writeback      <span class="token number">30</span>
   io_uring       <span class="token number">14</span>       qdisc          <span class="token number">4</span>        xdp            <span class="token number">12</span>
</code></pre> 
<ul><li>flamegraph火焰图</li></ul> 
<p>如果希望了解CPU在一段时间内的都运行了哪些函数以及各函数都消耗了多少时间，就可以使用On CPU火焰图，这种火焰图基于cpu-cycles事件进行采样，然后通过svg图片格式展现出来</p> 
<pre><code class="prism language-bash"><span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>/dev/zero <span class="token assign-left variable">of</span><span class="token operator">=</span>/tmp/testfile <span class="token assign-left variable">bs</span><span class="token operator">=</span>4K <span class="token assign-left variable">count</span><span class="token operator">=</span><span class="token number">102400</span> <span class="token operator">&amp;</span>
perf record <span class="token parameter variable">-e</span> cpu-cycles <span class="token parameter variable">-a</span> <span class="token parameter variable">-g</span> <span class="token function">sleep</span> <span class="token number">1</span>
perf script <span class="token operator">&gt;</span> perf.unfold
<span class="token builtin class-name">cd</span> FlameGraph
./stackcollapse-perf.pl <span class="token operator">&lt;</span> <span class="token punctuation">..</span>/perf.unfold <span class="token operator">|</span> ./flamegraph.pl <span class="token operator">&gt;</span> <span class="token punctuation">..</span>/perf.svg
</code></pre> 
<p>首先在后台启动一个dd命令，让它持续运行一段时间，然后开启perf record，记录一秒钟内cpu都运行了多少个cpu-cycles，也就是时间（同时使能-g，就会一并记录运行的函数以及调用关系），再利用perf script命令将perf.data转成perf.unfold，最后利用FlameGraph工具将其转换成一个perf.svg，这是一个图形文件，用浏览器打开后会得到这样图记录着函数调用关系及其cpu-cycles（时间）占比，就像一缕缕升起的火苗，所以被称之为火焰图。</p> 
<p>火焰图还可以通过鼠标点击放大，观察其细节。</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d04aed0baadcb1248d6d1bab5fad8826/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Python中collections.namedtuple用法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/be5bfaa1824063b11cc66d0a72a67ad9/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">gradle版本是7.1.3加载arr包踩坑</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>