<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>关于uniapp小程序压缩视频后上传云点播视频损坏这件事 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="关于uniapp小程序压缩视频后上传云点播视频损坏这件事" />
<meta property="og:description" content="问题起因
公司自研项目 技术栈是 uniapp 开发微信小程序 小程序内有个需要用户录制视频并上传的功能 项目内使用的是 uni.createCameraContext 相机组件进行录制视频的 一开始并没有出现什么问题 可以正常录制及上传 直到需求上多了一个 《视频直接上传过大 需要进行压缩处理再上传》 之后 问题就来了！本以为只是个简单的压缩罢了。想着直接使用uniapp提供的 uni.compressVideo api就好了 接下来就是一顿操作 简单测试一遍 自信提交！下班！
uni.compressVideo({ src, quality: &#39;low&#39;, // bitrate:60000, // fps: 30, // resolution:1, success: (res) =&gt; { //压缩后处理 }, fail: (err) =&gt; { //错误处理 }, }); 问题初现
第二天到公司后 昨天测试测出问题了 发现压缩后上传的视频 在云点播上是损坏的 基本上播放到十秒左右 就会突然跳到结束 不压缩上传的话 就没有问题
然后就是不停的测，改，测，改，测…
整了一下午还是没搞好。 后来翻 uniapp 文档的时候 看到了在暂停录像api上 还有个属性 compressed：启动视频压缩，压缩效果同 chooseVideo 抱着死马当活马医的态度换上了 然后一测 居然好了 那么新的问题又来了 既然文档上说压缩效果同 chooseVideo 为什么一个行一个不行呢。不过现在没时间想这个了 还有个问题就是 视频录制超时的话 是没有这个压缩的 而如果在超时之前自动暂停的话 又会导致录制时间可能不准确。后来经过讨论 还是决定先使用这个方法 只不过要把录制时间多加一两秒 尽量的保持准确。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/e79d457ad3d3bb649d085f88d7758a9d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-10T00:51:28+08:00" />
<meta property="article:modified_time" content="2022-12-10T00:51:28+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">关于uniapp小程序压缩视频后上传云点播视频损坏这件事</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <ol><li> <p>问题起因</p> <p>公司自研项目 技术栈是 uniapp 开发微信小程序 小程序内有个需要用户录制视频并上传的功能 项目内使用的是 uni.createCameraContext 相机组件进行录制视频的 一开始并没有出现什么问题 可以正常录制及上传 直到需求上多了一个 《视频直接上传过大 需要进行压缩处理再上传》 之后 问题就来了！本以为只是个简单的压缩罢了。想着直接使用uniapp提供的 <code>uni.compressVideo</code> api就好了 接下来就是一顿操作 简单测试一遍 自信提交！下班！</p> </li></ol> 
<pre><code>uni.compressVideo({
	src,
	quality: 'low',
	// bitrate:60000,
	// fps: 30,
	// resolution:1,
	success: (res) =&gt; {
		//压缩后处理
	},
	fail: (err) =&gt; {
		//错误处理
	},
});
</code></pre> 
<ol start="2"><li> <p>问题初现<br> 第二天到公司后 昨天测试测出问题了 发现压缩后上传的视频 在云点播上是损坏的 基本上播放到十秒左右 就会突然跳到结束 不压缩上传的话 就没有问题<br> 然后就是不停的测，改，测，改，测…<br> 整了一下午还是没搞好。 后来翻 uniapp 文档的时候 看到了在暂停录像api上 还有个属性 <code>compressed：启动视频压缩，压缩效果同 chooseVideo</code> 抱着死马当活马医的态度换上了 然后一测 居然好了 那么新的问题又来了 既然文档上说<code>压缩效果同 chooseVideo</code> 为什么一个行一个不行呢。不过现在没时间想这个了 还有个问题就是 视频录制超时的话 是没有这个压缩的 而如果在超时之前自动暂停的话 又会导致录制时间可能不准确。后来经过讨论 还是决定先使用这个方法 只不过要把录制时间多加一两秒 尽量的保持准确。</p> </li><li> <p>新的问题<br> 又是新的一天 在使用结束录制的 <code>compressed</code>属性暂时解决问题后 新的问题又来了 具体可看微信社区的bug反馈链接:<a href="https://developers.weixin.qq.com/community/develop/doc/0004ca5a70040888b51a5b75e51400" rel="nofollow">开启compressed后，结束录制CameraContext.stopRecord无返回数据</a><br> 简单来讲就是 开启了这个属性后 录制视频 第一次录制可以正常返回视频数据 但是从第二次开始 返回的数据就是null的 关闭这个属性后 数据正常<img src="https://images2.imgbox.com/54/43/QslBgK3t_o.png" alt="在这里插入图片描述"><br> （这个bug现在好像已经修复了）<br> <img src="https://images2.imgbox.com/ac/8e/yffS32o8_o.png" alt="在这里插入图片描述"></p> </li><li> <p>转机<br> 在使用<code>compressed</code>解决问题失败后 不得不另寻他路 在新建了一份代码片段 并将小程序内的功能在代码片段里实现后 我尝试将压缩后的视频直接在小程序内播放 发现:在想程序内播放 视频并无问题 下载后播放也没问题 将下载下来的视频放点电脑上 从电脑上在云点播后台上传 也没有问题！<br> 从这可以得知 并不是小程序的压缩视频有问题 而是云点播的上传有问题 随后到云点播后台 找了人工客服 花费一下午时间 从客服那边拿到了一个不同版本的 SDK 将项目内的 SDK 替换后 发现问题解决了。<br> 询问客服得知 云点播官方文档内的 SDK 下载链接可能并非是最新版的 最好到git仓库上下载<br> 然后自以为问题解决 收工下班</p> </li><li> <p>再起波澜–结束<br> 第二天上班时 得知昨天的问题并没完全解决<br> 经过测试发现 压缩过的视频 只要超过8MB 还是会出现上述的视频损坏的问题 8MB之后的视频文件 全部上传不上去 视频直接被截断了 (大概是8MB 差不多两个月前了 有些记不清了)<br> 然后打开昨天从客服那边拿到的新版本 SDK 源码 翻看了下源码 从源码中找到了 <code>getCosStrategy</code> 函数 在这个函数内的 <code>sourceData</code> 对象 里面的 ChunkSize 参数就是出现问题的地方了 将 <code>ChunkSize </code> 参数改为<code>1048576 * 30</code> 问题就解决了 <img src="https://images2.imgbox.com/56/fb/GoDLQ2nJ_o.png" alt="在这里插入图片描述"></p> </li><li> <p>结论<br> 视频压缩后上传损坏的问题可以确定是源码内的<code>getCosStrategy函数下的sourceData对象的ChunkSize</code>值过小造成的 <s>将数值改为自己项目需要的大小即可</s> 。<br> 最好还是不要改源码 直接在上传函数内传入自己需要的大小即可</p> </li></ol> 
<pre><code>VodUploader.start({
	...
	chunkSize:1024*1024*(MB)
	...
})
</code></pre> 
<p>其实<a href="https://cloud.tencent.com/document/product/266/9239" rel="nofollow">腾讯上传SDK文档</a>内有这个参数的描述<br> 但是描述内写的是分块上传时 每块的大小 并没有写会限制整体上传的大小 所以导致从头到尾都把这个参数忽视了 还是后面翻了源码才找到了这个参数 感觉文档这里写的和实际上的不太一样 也有可能视频被压缩了的问题<br> <img src="https://images2.imgbox.com/9b/69/vVYLHe1e_o.png" alt="在这里插入图片描述"><br> 总之 问题到此就结束了。<br> 闲来无事 就想记录下这次遇到的问题 好让自己有点印象 不至于转头就忘了。<br> 如果这篇文章有帮助到您 那是我的荣幸。如果没有帮助 那也感谢您能看到最后</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7f53441fa4a978127263ccafda0da7ba/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">C#使用 Async 和 Await 的异步编程</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b63a47bd8e2f0401c05f139da4f19657/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">OPC读写Kepware（C&#43;&#43;）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>