<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Excel·VBA合并工作簿 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Excel·VBA合并工作簿" />
<meta property="og:description" content="目录 1，合并文件夹下所有工作簿1.1，合并且建立超链接目录举例 2，合并工作簿中所有工作表2.1，纵向合并举例 2.2，横向合并举例 3，合并文件夹下所有工作簿中所有工作表举例3.1，合并且显示原工作簿名称、原工作表名称 4，合并文件夹下所有工作簿中同名工作表4.1，合并且显示原工作簿名称举例 5，合并文件夹下所有工作簿中所有工作表，横向汇总数据举例 6，合并子文件夹所有工作簿中所有工作表，纵向汇总数据举例 7，合并子文件夹同名工作簿中同名工作表，纵向汇总数据7.1，实现方法17.2，实现方法2举例，2种实现方法对比 1，合并文件夹下所有工作簿 适用将所有工作簿中所有工作表复制到1个新建工作簿中，不修改数据，原本一共有多少个工作表，合并后就有多少个工作表
如果存在同名工作表，复制后工作表名称会自动添加序号，如Sheet1 (2)
Sub 合并文件夹下所有工作簿() &#39;文件夹下所有工作簿wb所有工作表ws合并为一个新工作簿（但不含子文件夹），不修改数据 Dim write_wb As Workbook, wb As Workbook, sht As Worksheet, file_path$, file_name$ file_path = &#34;E:\测试\拆分表\&#34; &#39;待合并工作簿所在的文件夹 file_name = Dir(file_path &amp; &#34;*.xlsx&#34;) Application.ScreenUpdating = False &#39;关闭屏幕更新，加快程序运行 Application.DisplayAlerts = False &#39;不显示警告信息 Set write_wb = Workbooks.Add &#39;新建工作簿，合并文件 Do While file_name &lt;&gt; &#34;&#34; Set wb = Workbooks.Open(file_path &amp; file_name) For Each sht In wb.Worksheets sht.Copy After:=write_wb.Sheets(write_wb.Sheets.Count) Next wb." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/570b98f9107274b401f04f55ce39b474/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-15T12:03:19+08:00" />
<meta property="article:modified_time" content="2023-11-15T12:03:19+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Excel·VBA合并工作簿</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atelier-sulphurpool-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><ul><li><a href="#1_2" rel="nofollow">1，合并文件夹下所有工作簿</a></li><li><ul><li><a href="#11_31" rel="nofollow">1.1，合并且建立超链接目录</a></li><li><ul><li><a href="#_65" rel="nofollow">举例</a></li></ul> 
   </li></ul> 
   </li><li><a href="#2_72" rel="nofollow">2，合并工作簿中所有工作表</a></li><li><ul><li><a href="#21_75" rel="nofollow">2.1，纵向合并</a></li><li><ul><li><a href="#_107" rel="nofollow">举例</a></li></ul> 
    </li><li><a href="#22_115" rel="nofollow">2.2，横向合并</a></li><li><ul><li><a href="#_137" rel="nofollow">举例</a></li></ul> 
   </li></ul> 
   </li><li><a href="#3_143" rel="nofollow">3，合并文件夹下所有工作簿中所有工作表</a></li><li><ul><li><a href="#_185" rel="nofollow">举例</a></li><li><a href="#31_193" rel="nofollow">3.1，合并且显示原工作簿名称、原工作表名称</a></li></ul> 
   </li><li><a href="#4_243" rel="nofollow">4，合并文件夹下所有工作簿中同名工作表</a></li><li><ul><li><a href="#41_290" rel="nofollow">4.1，合并且显示原工作簿名称</a></li><li><ul><li><a href="#_357" rel="nofollow">举例</a></li></ul> 
   </li></ul> 
   </li><li><a href="#5_365" rel="nofollow">5，合并文件夹下所有工作簿中所有工作表，横向汇总数据</a></li><li><ul><li><a href="#_431" rel="nofollow">举例</a></li></ul> 
   </li><li><a href="#6_437" rel="nofollow">6，合并子文件夹所有工作簿中所有工作表，纵向汇总数据</a></li><li><ul><li><a href="#_541" rel="nofollow">举例</a></li></ul> 
   </li><li><a href="#7_552" rel="nofollow">7，合并子文件夹同名工作簿中同名工作表，纵向汇总数据</a></li><li><ul><li><a href="#711_555" rel="nofollow">7.1，实现方法1</a></li><li><a href="#722_651" rel="nofollow">7.2，实现方法2</a></li><li><a href="#2_749" rel="nofollow">举例，2种实现方法对比</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="1_2"></a>1，合并文件夹下所有工作簿</h3> 
<p>适用将所有工作簿中所有工作表复制到1个新建工作簿中，不修改数据，原本一共有多少个工作表，合并后就有多少个工作表<br> 如果存在同名工作表，复制后工作表名称会自动添加序号，如Sheet1 (2)</p> 
<pre><code class="prism language-vbnet"><span class="token keyword">Sub</span> 合并文件夹下所有工作簿<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">'文件夹下所有工作簿wb所有工作表ws合并为一个新工作簿（但不含子文件夹），不修改数据</span>
    <span class="token keyword">Dim</span> write_wb <span class="token keyword">As</span> Workbook<span class="token punctuation">,</span> wb <span class="token keyword">As</span> Workbook<span class="token punctuation">,</span> sht <span class="token keyword">As</span> Worksheet<span class="token punctuation">,</span> file_path$<span class="token punctuation">,</span> file_name$
    file_path <span class="token operator">=</span> <span class="token string">"E:\测试\拆分表\"</span>  <span class="token comment">'待合并工作簿所在的文件夹</span>
    file_name <span class="token operator">=</span> Dir<span class="token punctuation">(</span>file_path <span class="token operator">&amp;</span> <span class="token string">"*.xlsx"</span><span class="token punctuation">)</span>
    Application.ScreenUpdating <span class="token operator">=</span> <span class="token keyword">False</span>  <span class="token comment">'关闭屏幕更新，加快程序运行</span>
    Application.DisplayAlerts <span class="token operator">=</span> <span class="token keyword">False</span>   <span class="token comment">'不显示警告信息</span>
    <span class="token keyword">Set</span> write_wb <span class="token operator">=</span> Workbooks.Add    <span class="token comment">'新建工作簿，合并文件</span>
    <span class="token keyword">Do</span> <span class="token keyword">While</span> file_name <span class="token operator">&lt;&gt;</span> <span class="token string">""</span>
        <span class="token keyword">Set</span> wb <span class="token operator">=</span> Workbooks.<span class="token keyword">Open</span><span class="token punctuation">(</span>file_path <span class="token operator">&amp;</span> file_name<span class="token punctuation">)</span>
        <span class="token keyword">For Each</span> sht <span class="token keyword">In</span> wb.Worksheets
            sht.Copy After<span class="token punctuation">:</span><span class="token operator">=</span>write_wb.Sheets<span class="token punctuation">(</span>write_wb.Sheets.Count<span class="token punctuation">)</span>
        <span class="token keyword">Next</span>
        wb.<span class="token keyword">Close</span> <span class="token punctuation">(</span><span class="token keyword">False</span><span class="token punctuation">)</span>
        file_name <span class="token operator">=</span> Dir  <span class="token comment">'下一个文件名</span>
    <span class="token keyword">Loop</span>
    <span class="token comment">'保存文件</span>
    save_file <span class="token operator">=</span> file_path <span class="token operator">&amp;</span> <span class="token string">"合并表.xlsx"</span>
    write_wb.SaveAs filename<span class="token punctuation">:</span><span class="token operator">=</span>save_file
    write_wb.<span class="token keyword">Close</span> <span class="token punctuation">(</span><span class="token keyword">False</span><span class="token punctuation">)</span>
    Application.ScreenUpdating <span class="token operator">=</span> <span class="token keyword">True</span><span class="token punctuation">:</span> Application.DisplayAlerts <span class="token operator">=</span> <span class="token keyword">True</span>
<span class="token keyword">End</span> <span class="token keyword">Sub</span>
</code></pre> 
<h4><a id="11_31"></a>1.1，合并且建立超链接目录</h4> 
<pre><code class="prism language-vbnet"><span class="token keyword">Sub</span> 合并文件夹下所有工作簿并建立目录<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">'文件夹下所有工作簿wb所有工作表ws合并为一个新工作簿（但不含子文件夹），不修改数据，并建立目录超链接</span>
    <span class="token keyword">Dim</span> write_wb <span class="token keyword">As</span> Workbook<span class="token punctuation">,</span> wb <span class="token keyword">As</span> Workbook<span class="token punctuation">,</span> list_ws <span class="token keyword">As</span> Worksheet<span class="token punctuation">,</span> sht <span class="token keyword">As</span> Worksheet
    <span class="token keyword">Dim</span> fso <span class="token keyword">As</span> <span class="token keyword">Object</span><span class="token punctuation">,</span> file_path$<span class="token punctuation">,</span> file_name$<span class="token punctuation">,</span> full_name$<span class="token punctuation">,</span> newname$<span class="token punctuation">,</span> w<span class="token operator">&amp;</span>
    file_path <span class="token operator">=</span> <span class="token string">"E:\测试\拆分表\"</span>  <span class="token comment">'待合并工作簿所在的文件夹</span>
    file_name <span class="token operator">=</span> Dir<span class="token punctuation">(</span>file_path <span class="token operator">&amp;</span> <span class="token string">"*.xlsx"</span><span class="token punctuation">)</span>
    Application.ScreenUpdating <span class="token operator">=</span> <span class="token keyword">False</span>  <span class="token comment">'关闭屏幕更新，加快程序运行</span>
    Application.DisplayAlerts <span class="token operator">=</span> <span class="token keyword">False</span>   <span class="token comment">'不显示警告信息</span>
    <span class="token keyword">Set</span> write_wb <span class="token operator">=</span> Workbooks.Add    <span class="token comment">'新建工作簿，合并文件</span>
    <span class="token keyword">Set</span> list_ws <span class="token operator">=</span> write_wb.Worksheets<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span> list_ws.<span class="token keyword">Name</span> <span class="token operator">=</span> <span class="token string">"目录"</span>
    list_ws.Cells<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"目录(原工作簿名-工作表名)"</span><span class="token punctuation">:</span> list_ws.Cells<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"超链接"</span><span class="token punctuation">:</span> w <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token keyword">Set</span> fso <span class="token operator">=</span> CreateObject<span class="token punctuation">(</span><span class="token string">"Scripting.FileSystemObject"</span><span class="token punctuation">)</span>
    <span class="token keyword">Do</span> <span class="token keyword">While</span> file_name <span class="token operator">&lt;&gt;</span> <span class="token string">""</span>
        <span class="token keyword">Set</span> wb <span class="token operator">=</span> Workbooks.<span class="token keyword">Open</span><span class="token punctuation">(</span>file_path <span class="token operator">&amp;</span> file_name<span class="token punctuation">)</span>
        <span class="token keyword">For Each</span> sht <span class="token keyword">In</span> wb.Worksheets
            sht.Copy After<span class="token punctuation">:</span><span class="token operator">=</span>write_wb.Sheets<span class="token punctuation">(</span>write_wb.Sheets.Count<span class="token punctuation">)</span>
            full_name <span class="token operator">=</span> fso.GetBaseName<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token string">"-"</span> <span class="token operator">&amp;</span> sht.<span class="token keyword">Name</span>  <span class="token comment">'原工作簿名-工作表名</span>
            <span class="token comment">'write_wb.Sheets(write_wb.Sheets.Count).Name = full_name  '可对复制的ws重命名</span>
            w <span class="token operator">=</span> w <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">:</span> list_ws.Cells<span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> full_name<span class="token punctuation">:</span> newname <span class="token operator">=</span> write_wb.Sheets<span class="token punctuation">(</span>write_wb.Sheets.Count<span class="token punctuation">)</span>.<span class="token keyword">Name</span>
            list_ws.Hyperlinks.Add anchor<span class="token punctuation">:</span><span class="token operator">=</span>list_ws.Cells<span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Address<span class="token punctuation">:</span><span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">,</span> SubAddress<span class="token punctuation">:</span><span class="token operator">=</span><span class="token string">"'"</span> <span class="token operator">&amp;</span> newname <span class="token operator">&amp;</span> <span class="token string">"'!a1"</span><span class="token punctuation">,</span> TextToDisplay<span class="token punctuation">:</span><span class="token operator">=</span>newname
        <span class="token keyword">Next</span>
        wb.<span class="token keyword">Close</span> <span class="token punctuation">(</span><span class="token keyword">False</span><span class="token punctuation">)</span>
        file_name <span class="token operator">=</span> Dir  <span class="token comment">'下一个文件名</span>
    <span class="token keyword">Loop</span>
    <span class="token comment">'保存文件</span>
    list_ws.Columns<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>.AutoFit  <span class="token comment">'列宽自适应</span>
    save_file <span class="token operator">=</span> file_path <span class="token operator">&amp;</span> <span class="token string">"合并表.xlsx"</span>
    write_wb.SaveAs filename<span class="token punctuation">:</span><span class="token operator">=</span>save_file
    write_wb.<span class="token keyword">Close</span> <span class="token punctuation">(</span><span class="token keyword">False</span><span class="token punctuation">)</span>
    Application.ScreenUpdating <span class="token operator">=</span> <span class="token keyword">True</span><span class="token punctuation">:</span> Application.DisplayAlerts <span class="token operator">=</span> <span class="token keyword">True</span>
<span class="token keyword">End</span> <span class="token keyword">Sub</span>
</code></pre> 
<h5><a id="_65"></a>举例</h5> 
<p>合并<a href="https://blog.csdn.net/hhhhh_51/article/details/122414404">《Excel·VBA按列拆分工作表、工作簿》</a>，sub2拆分后的工作表<br> <img src="https://images2.imgbox.com/13/6a/SlLiXDs5_o.jpg" alt="在这里插入图片描述"><br> 并且每个工作簿中的工作表复制1个副本（1个地名表1个Sheet1表），这样就有5个工作簿各含2个工作表<br> 工作簿合并且建立超链接目录结果<br> <img src="https://images2.imgbox.com/34/60/bAzbA4rB_o.jpg" alt="在这里插入图片描述"></p> 
<h3><a id="2_72"></a>2，合并工作簿中所有工作表</h3> 
<p>对工作簿中相同格式的工作表进行合并，汇总所有工作表，保存在工作簿最前</p> 
<h4><a id="21_75"></a>2.1，纵向合并</h4> 
<pre><code class="prism language-vbnet"><span class="token keyword">Sub</span> 合并工作簿中所有工作表_纵向<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">'当前工作簿wb所有工作表ws合并保存至新建工作表（插入最前），但之前ws不修改（工作表格式相同）</span>
    <span class="token keyword">Dim</span> wb<span class="token punctuation">,</span> ws<span class="token punctuation">,</span> title_row<span class="token punctuation">,</span> end_row<span class="token punctuation">,</span> copy_title<span class="token punctuation">,</span> i
<span class="token comment">'--------------------参数填写：title_row，数字，第1行为1向下递增；end_row，数字</span>
    title_row <span class="token operator">=</span> <span class="token number">1</span>  <span class="token comment">'表头行数，仅复制1次；如果为0，则表示没有表头或表头每次都复制</span>
    end_row <span class="token operator">=</span> <span class="token number">0</span>    <span class="token comment">'表尾行数，不参与合并</span>
    <span class="token keyword">Set</span> wb <span class="token operator">=</span> Application.ActiveWorkbook  <span class="token comment">'当前工作簿即为待合并工作簿</span>
    <span class="token keyword">Set</span> ws <span class="token operator">=</span> wb.Worksheets.Add<span class="token punctuation">(</span>before<span class="token punctuation">:</span><span class="token operator">=</span>Sheets<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">'最前添加新sheet，即为合并工作表</span>
    ws.<span class="token keyword">Name</span> <span class="token operator">=</span> <span class="token string">"合并表"</span>
    <span class="token keyword">If</span> title_row <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">Then</span> copy_title <span class="token operator">=</span> <span class="token keyword">True</span> <span class="token keyword">Else</span> copy_title <span class="token operator">=</span> <span class="token keyword">False</span>  <span class="token comment">'是否复制表头</span>
    <span class="token keyword">If</span> title_row <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token keyword">Then</span> <span class="token function">Debug</span>.<span class="token function">Print</span> <span class="token string">"title_row参数错误，必须为&gt;=0的整数"</span><span class="token punctuation">:</span> <span class="token keyword">Exit</span> <span class="token keyword">Sub</span>
    Application.ScreenUpdating <span class="token operator">=</span> <span class="token keyword">False</span>  <span class="token comment">'关闭屏幕更新，加快程序运行</span>
    Application.DisplayAlerts <span class="token operator">=</span> <span class="token keyword">False</span>   <span class="token comment">'不显示警告信息</span>
    <span class="token comment">'遍历，复制表体</span>
    <span class="token keyword">For</span> i <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">To</span> Worksheets.count<span class="token punctuation">:</span>
        <span class="token keyword">If</span> Worksheets<span class="token punctuation">(</span>i<span class="token punctuation">)</span>.<span class="token keyword">Name</span> <span class="token operator">&lt;&gt;</span> ws.<span class="token keyword">Name</span> <span class="token keyword">Then</span>
            <span class="token keyword">If</span> copy_title <span class="token operator">=</span> <span class="token keyword">True</span> <span class="token keyword">Then</span>  <span class="token comment">'复制表头，仅执行1次</span>
                Worksheets<span class="token punctuation">(</span>i<span class="token punctuation">)</span>.Rows<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&amp;</span> <span class="token string">":"</span> <span class="token operator">&amp;</span> title_row<span class="token punctuation">)</span>.Copy ws.Range<span class="token punctuation">(</span><span class="token string">"A1"</span><span class="token punctuation">)</span>
                copy_title <span class="token operator">=</span> <span class="token keyword">False</span>
            <span class="token keyword">End</span> <span class="token keyword">If</span>
            <span class="token comment">'首行为空，会导致后续数据被覆盖</span>
            <span class="token keyword">If</span> WorksheetFunction.CountA<span class="token punctuation">(</span>ws.Rows<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">Then</span> ws.Rows<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>.<span class="token function">Delete</span>
            write_row <span class="token operator">=</span> ws.UsedRange.Rows.count <span class="token operator">+</span> <span class="token number">1</span>  <span class="token comment">'合并工作表的第一个空行写入</span>
            sheet_row <span class="token operator">=</span> Worksheets<span class="token punctuation">(</span>i<span class="token punctuation">)</span>.UsedRange.Rows.count
            Worksheets<span class="token punctuation">(</span>i<span class="token punctuation">)</span>.Rows<span class="token punctuation">(</span>title_row <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&amp;</span> <span class="token string">":"</span> <span class="token operator">&amp;</span> sheet_row <span class="token operator">-</span> end_row<span class="token punctuation">)</span>.Copy ws.Range<span class="token punctuation">(</span><span class="token string">"A"</span> <span class="token operator">&amp;</span> write_row<span class="token punctuation">)</span>
        <span class="token keyword">End</span> <span class="token keyword">If</span>
    <span class="token keyword">Next</span>
    Application.ScreenUpdating <span class="token operator">=</span> <span class="token keyword">True</span><span class="token punctuation">:</span> Application.DisplayAlerts <span class="token operator">=</span> <span class="token keyword">True</span>
<span class="token keyword">End</span> <span class="token keyword">Sub</span>
</code></pre> 
<h5><a id="_107"></a>举例</h5> 
<p>合并<a href="https://blog.csdn.net/hhhhh_51/article/details/122414404">《Excel·VBA按列拆分工作表、工作簿》</a>，sub1拆分后的工作表<br> <img src="https://images2.imgbox.com/20/c0/yU2LES85_o.jpg" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/c0/61/yCwKuOhH_o.jpg" alt="在这里插入图片描述"><br> 合并参数：title_row = 1，end_row = 0<br> <img src="https://images2.imgbox.com/86/87/6qUxgABL_o.jpg" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/ea/da/eN20lJoR_o.jpg" alt="在这里插入图片描述"></p> 
<h4><a id="22_115"></a>2.2，横向合并</h4> 
<pre><code class="prism language-vbnet"><span class="token keyword">Sub</span> 合并工作簿中所有工作表_横向<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">'当前工作簿wb所有工作表ws合并保存至新建工作表（插入最前），但之前ws不修改（工作表格式相同）</span>
    <span class="token keyword">Dim</span> ws <span class="token keyword">As</span> Worksheet<span class="token punctuation">,</span> sht <span class="token keyword">As</span> Worksheet<span class="token punctuation">,</span> write_col<span class="token operator">&amp;</span>
    Application.ScreenUpdating <span class="token operator">=</span> <span class="token keyword">False</span>  <span class="token comment">'关闭屏幕更新，加快程序运行</span>
    Application.DisplayAlerts <span class="token operator">=</span> <span class="token keyword">False</span>   <span class="token comment">'不显示警告信息</span>
    <span class="token keyword">With</span> ActiveWorkbook
        <span class="token keyword">Set</span> ws <span class="token operator">=</span> .Worksheets.Add<span class="token punctuation">(</span>before<span class="token punctuation">:</span><span class="token operator">=</span>Sheets<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">'最前添加新sheet，即为合并工作表</span>
        ws.<span class="token keyword">Name</span> <span class="token operator">=</span> <span class="token string">"合并表"</span>
        <span class="token keyword">For Each</span> sht <span class="token keyword">In</span> .Worksheets
            <span class="token keyword">If</span> sht.<span class="token keyword">Name</span> <span class="token operator">&lt;&gt;</span> ws.<span class="token keyword">Name</span> <span class="token keyword">Then</span>
                <span class="token comment">'首列为空时，会导致后续数据被覆盖</span>
                <span class="token keyword">If</span> WorksheetFunction.CountA<span class="token punctuation">(</span>ws.Columns<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">Then</span> ws.Columns<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>.<span class="token function">Delete</span>
                write_col <span class="token operator">=</span> ws.UsedRange.Columns.Count <span class="token operator">+</span> <span class="token number">1</span>
                sht.UsedRange.Copy ws.Cells<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> write_col<span class="token punctuation">)</span>
            <span class="token keyword">End</span> <span class="token keyword">If</span>
        <span class="token keyword">Next</span>
    <span class="token keyword">End</span> <span class="token keyword">With</span>
    Application.ScreenUpdating <span class="token operator">=</span> <span class="token keyword">True</span><span class="token punctuation">:</span> Application.DisplayAlerts <span class="token operator">=</span> <span class="token keyword">True</span>
<span class="token keyword">End</span> <span class="token keyword">Sub</span>
</code></pre> 
<h5><a id="_137"></a>举例</h5> 
<p>合并前<br> <img src="https://images2.imgbox.com/85/7b/ACSXNuPp_o.jpg" alt="在这里插入图片描述"><br> 合并后<br> <img src="https://images2.imgbox.com/f0/fd/luF9dHoz_o.jpg" alt="在这里插入图片描述"></p> 
<h3><a id="3_143"></a>3，合并文件夹下所有工作簿中所有工作表</h3> 
<p>对相同格式的工作簿进行合并，汇总所有工作表，保存为单独工作簿</p> 
<pre><code class="prism language-vbnet"><span class="token keyword">Sub</span> 合并文件夹下所有工作簿中所有工作表<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">'文件夹下所有工作簿wb所有工作表ws合并保存至新建工作表（但不含子文件夹），但不修改原数据（工作表格式相同）</span>
    <span class="token keyword">Dim</span> wb<span class="token punctuation">,</span> ws<span class="token punctuation">,</span> title_row<span class="token punctuation">,</span> end_row<span class="token punctuation">,</span> copy_title<span class="token punctuation">,</span> file_path<span class="token punctuation">,</span> file_name<span class="token punctuation">,</span> i
<span class="token comment">'--------------------参数填写：title_row，数字，第1行为1向下递增；end_row，数字；file_path，合并文件夹</span>
    title_row <span class="token operator">=</span> <span class="token number">1</span>  <span class="token comment">'表头行数，仅复制1次；如果为0，则表示没有表头或表头每次都复制</span>
    end_row <span class="token operator">=</span> <span class="token number">0</span>    <span class="token comment">'表尾行数，不参与合并</span>
    file_path <span class="token operator">=</span> <span class="token string">"E:\测试\拆分表\"</span>  <span class="token comment">'待合并工作簿所在的文件夹</span>
    file_name <span class="token operator">=</span> Dir<span class="token punctuation">(</span>file_path <span class="token operator">&amp;</span> <span class="token string">"*.xlsx"</span><span class="token punctuation">)</span> 
    <span class="token keyword">If</span> title_row <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">Then</span> copy_title <span class="token operator">=</span> <span class="token keyword">True</span> <span class="token keyword">Else</span> copy_title <span class="token operator">=</span> <span class="token keyword">False</span>  <span class="token comment">'是否复制表头</span>
    <span class="token keyword">If</span> title_row <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token keyword">Then</span> <span class="token function">Debug</span>.<span class="token function">Print</span> <span class="token string">"title_row参数错误，必须为&gt;=0的整数"</span><span class="token punctuation">:</span> <span class="token keyword">Exit</span> <span class="token keyword">Sub</span>
    Application.ScreenUpdating <span class="token operator">=</span> <span class="token keyword">False</span>  <span class="token comment">'关闭屏幕更新，加快程序运行</span>
    Application.DisplayAlerts <span class="token operator">=</span> <span class="token keyword">False</span>   <span class="token comment">'不显示警告信息</span>
    Workbooks.Add    <span class="token comment">'新建工作表</span>
    <span class="token keyword">Set</span> ws <span class="token operator">=</span> ActiveSheet
    ws.<span class="token keyword">Name</span> <span class="token operator">=</span> <span class="token string">"合并表"</span>
    <span class="token keyword">Do</span> <span class="token keyword">While</span> file_name <span class="token operator">&lt;&gt;</span> <span class="token string">""</span>
        <span class="token keyword">Set</span> wb <span class="token operator">=</span> Workbooks.<span class="token keyword">Open</span><span class="token punctuation">(</span>file_path <span class="token operator">&amp;</span> file_name<span class="token punctuation">)</span>
        <span class="token keyword">For</span> i <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">To</span> Worksheets.count<span class="token punctuation">:</span>
            <span class="token keyword">If</span> copy_title <span class="token operator">=</span> <span class="token keyword">True</span> <span class="token keyword">Then</span>  <span class="token comment">'复制表头，仅执行1次</span>
                wb.Worksheets<span class="token punctuation">(</span>i<span class="token punctuation">)</span>.Rows<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&amp;</span> <span class="token string">":"</span> <span class="token operator">&amp;</span> title_row<span class="token punctuation">)</span>.Copy ws.Range<span class="token punctuation">(</span><span class="token string">"A1"</span><span class="token punctuation">)</span>
                copy_title <span class="token operator">=</span> <span class="token keyword">False</span>
            <span class="token keyword">End</span> <span class="token keyword">If</span>
            <span class="token comment">'首行为空，会导致后续数据被覆盖</span>
            <span class="token keyword">If</span> WorksheetFunction.CountA<span class="token punctuation">(</span>ws.Rows<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">Then</span> ws.Rows<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>.<span class="token function">Delete</span>
            write_row <span class="token operator">=</span> ws.UsedRange.Rows.count <span class="token operator">+</span> <span class="token number">1</span>  <span class="token comment">'合并工作表的第一个空行写入</span>
            sheet_row <span class="token operator">=</span> wb.Worksheets<span class="token punctuation">(</span>i<span class="token punctuation">)</span>.UsedRange.Rows.count
            wb.Worksheets<span class="token punctuation">(</span>i<span class="token punctuation">)</span>.Rows<span class="token punctuation">(</span>title_row <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&amp;</span> <span class="token string">":"</span> <span class="token operator">&amp;</span> sheet_row <span class="token operator">-</span> end_row<span class="token punctuation">)</span>.Copy ws.Range<span class="token punctuation">(</span><span class="token string">"A"</span> <span class="token operator">&amp;</span> write_row<span class="token punctuation">)</span>
        <span class="token keyword">Next</span>
        wb.<span class="token keyword">Close</span> <span class="token punctuation">(</span><span class="token keyword">False</span><span class="token punctuation">)</span>
        file_name <span class="token operator">=</span> Dir  <span class="token comment">'下一个文件名</span>
    <span class="token keyword">Loop</span>
    <span class="token comment">'保存文件</span>
    ws.Parent.SaveAs filename<span class="token punctuation">:</span><span class="token operator">=</span>file_path <span class="token operator">&amp;</span> <span class="token string">"合并表.xlsx"</span>
    ws.Parent.<span class="token keyword">Close</span> <span class="token punctuation">(</span><span class="token keyword">False</span><span class="token punctuation">)</span>
    Application.ScreenUpdating <span class="token operator">=</span> <span class="token keyword">True</span><span class="token punctuation">:</span> Application.DisplayAlerts <span class="token operator">=</span> <span class="token keyword">True</span>
<span class="token keyword">End</span> <span class="token keyword">Sub</span>
</code></pre> 
<h4><a id="_185"></a>举例</h4> 
<p>合并<a href="https://blog.csdn.net/hhhhh_51/article/details/122414404">《Excel·VBA按列拆分工作表》</a>，sub2拆分后的工作表<br> <img src="https://images2.imgbox.com/bf/d3/xHJdjmAc_o.jpg" alt="在这里插入图片描述"><br> 合并参数：title_row = 0，end_row = 0<br> <img src="https://images2.imgbox.com/75/bd/xWsaN1JJ_o.jpg" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/e1/31/S5WgeeRV_o.jpg" alt="在这里插入图片描述"></p> 
<h4><a id="31_193"></a>3.1，合并且显示原工作簿名称、原工作表名称</h4> 
<p><font color="red" size="4">2022.8.27更新</font>，应评论建议<br> 增加在A列显示原工作簿名称，B列显示原工作表名称</p> 
<pre><code class="prism language-vbnet"><span class="token keyword">Sub</span> 合并文件夹下所有工作簿中所有工作表<span class="token number">1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">'文件夹下所有工作簿wb所有工作表ws合并保存至新建工作表（但不含子文件夹），但不修改原数据（工作表格式相同）</span>
    <span class="token keyword">Dim</span> write_ws <span class="token keyword">As</span> Worksheet<span class="token punctuation">,</span> wb <span class="token keyword">As</span> Workbook<span class="token punctuation">,</span> sht <span class="token keyword">As</span> Worksheet<span class="token punctuation">,</span> fso <span class="token keyword">As</span> <span class="token keyword">Object</span>
    <span class="token keyword">Dim</span> title_row<span class="token operator">&amp;</span><span class="token punctuation">,</span> end_row<span class="token operator">&amp;</span><span class="token punctuation">,</span> write_row<span class="token operator">&amp;</span><span class="token punctuation">,</span> sht_row<span class="token operator">&amp;</span><span class="token punctuation">,</span> sht_col<span class="token operator">&amp;</span><span class="token punctuation">,</span> copy_row<span class="token operator">&amp;</span><span class="token punctuation">,</span> file_path$<span class="token punctuation">,</span> file_name$
<span class="token comment">'--------------------参数填写：title_row，数字，第1行为1向下递增；end_row，数字；file_path，合并文件夹</span>
    title_row <span class="token operator">=</span> <span class="token number">1</span>  <span class="token comment">'表头行数，仅复制1次；如果为0，则表示没有表头或表头每次都复制</span>
    end_row <span class="token operator">=</span> <span class="token number">0</span>    <span class="token comment">'表尾行数，不参与合并</span>
    file_path <span class="token operator">=</span> <span class="token string">"E:\测试\拆分表\"</span>  <span class="token comment">'待合并工作簿所在的文件夹</span>
    file_name <span class="token operator">=</span> Dir<span class="token punctuation">(</span>file_path <span class="token operator">&amp;</span> <span class="token string">"*.xlsx"</span><span class="token punctuation">)</span>
    <span class="token keyword">If</span> title_row <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token keyword">Then</span> <span class="token function">Debug</span>.<span class="token function">Print</span> <span class="token string">"title_row参数错误，必须为&gt;=0的整数"</span><span class="token punctuation">:</span> <span class="token keyword">Exit</span> <span class="token keyword">Sub</span>
    Application.ScreenUpdating <span class="token operator">=</span> <span class="token keyword">False</span>  <span class="token comment">'关闭屏幕更新，加快程序运行</span>
    Application.DisplayAlerts <span class="token operator">=</span> <span class="token keyword">False</span>   <span class="token comment">'不显示警告信息</span>
    <span class="token keyword">Set</span> fso <span class="token operator">=</span> CreateObject<span class="token punctuation">(</span><span class="token string">"Scripting.FileSystemObject"</span><span class="token punctuation">)</span>
    <span class="token keyword">Do</span> <span class="token keyword">While</span> file_name <span class="token operator">&lt;&gt;</span> <span class="token string">""</span>
        <span class="token keyword">Set</span> wb <span class="token operator">=</span> Workbooks.<span class="token keyword">Open</span><span class="token punctuation">(</span>file_path <span class="token operator">&amp;</span> file_name<span class="token punctuation">)</span>
        <span class="token keyword">For Each</span> sht <span class="token keyword">In</span> wb.Worksheets
            <span class="token keyword">If</span> WorksheetFunction.CountA<span class="token punctuation">(</span>sht.UsedRange.Cells<span class="token punctuation">)</span> <span class="token operator">&lt;&gt;</span> <span class="token number">0</span> <span class="token keyword">Then</span>  <span class="token comment">'非空工作表</span>
                <span class="token keyword">If</span> write_ws <span class="token keyword">Is</span> <span class="token keyword">Nothing</span> <span class="token keyword">Then</span>
                    sht.Copy<span class="token punctuation">:</span> <span class="token keyword">Set</span> write_ws <span class="token operator">=</span> ActiveSheet  <span class="token comment">'整体复制工作表</span>
                    write_ws.<span class="token keyword">Name</span> <span class="token operator">=</span> <span class="token string">"合并表"</span><span class="token punctuation">:</span> write_ws.Columns<span class="token punctuation">(</span><span class="token string">"a:b"</span><span class="token punctuation">)</span>.Insert <span class="token comment">'插入列</span>
                    write_ws.[a1].Resize<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">Array</span><span class="token punctuation">(</span><span class="token string">"原工作簿名称"</span><span class="token punctuation">,</span> <span class="token string">"原工作表名称"</span><span class="token punctuation">)</span>
                    write_row <span class="token operator">=</span> write_ws.UsedRange.Rows.Count
                    write_ws.[a2].Resize<span class="token punctuation">(</span>write_row <span class="token operator">-</span> title_row<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">Array</span><span class="token punctuation">(</span>fso.GetBaseName<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token punctuation">,</span> sht.<span class="token keyword">Name</span><span class="token punctuation">)</span>
                    <span class="token keyword">If</span> end_row <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">Then</span>  <span class="token comment">'删除表尾行</span>
                        write_ws.Cells<span class="token punctuation">(</span>write_row<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>.Offset<span class="token punctuation">(</span><span class="token operator">-</span>end_row <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>.Resize<span class="token punctuation">(</span>end_row<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>.EntireRow.<span class="token function">Delete</span>
                    <span class="token keyword">End</span> <span class="token keyword">If</span>
                <span class="token keyword">Else</span>
                    write_row <span class="token operator">=</span> write_ws.UsedRange.Rows.Count <span class="token operator">+</span> <span class="token number">1</span>  <span class="token comment">'合并工作表的第一个空行写入</span>
                    sht_row <span class="token operator">=</span> sht.UsedRange.Rows.Count<span class="token punctuation">:</span> sht_col <span class="token operator">=</span> sht.UsedRange.Columns.Count
                    copy_row <span class="token operator">=</span> sht_row <span class="token operator">-</span> title_row <span class="token operator">-</span> end_row  <span class="token comment">'复制行数</span>
                    sht.Cells<span class="token punctuation">(</span>title_row <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">)</span>.Resize<span class="token punctuation">(</span>copy_row<span class="token punctuation">,</span> sht_col<span class="token punctuation">)</span>.Copy write_ws.Cells<span class="token punctuation">(</span>write_row<span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">)</span>
                    write_ws.Cells<span class="token punctuation">(</span>write_row<span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">)</span>.Resize<span class="token punctuation">(</span>copy_row<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">Array</span><span class="token punctuation">(</span>fso.GetBaseName<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token punctuation">,</span> sht.<span class="token keyword">Name</span><span class="token punctuation">)</span>
                <span class="token keyword">End</span> <span class="token keyword">If</span>
            <span class="token keyword">End</span> <span class="token keyword">If</span>
        <span class="token keyword">Next</span>
        wb.<span class="token keyword">Close</span> <span class="token punctuation">(</span><span class="token keyword">False</span><span class="token punctuation">)</span>  <span class="token comment">'关闭工作簿</span>
        file_name <span class="token operator">=</span> Dir   <span class="token comment">'下一个文件名</span>
    <span class="token keyword">Loop</span>
    <span class="token comment">'保存文件</span>
    write_ws.Parent.SaveAs filename<span class="token punctuation">:</span><span class="token operator">=</span>file_path <span class="token operator">&amp;</span> <span class="token string">"合并表.xlsx"</span>
    write_ws.Parent.<span class="token keyword">Close</span> <span class="token punctuation">(</span><span class="token keyword">False</span><span class="token punctuation">)</span>
    Application.ScreenUpdating <span class="token operator">=</span> <span class="token keyword">True</span><span class="token punctuation">:</span> Application.DisplayAlerts <span class="token operator">=</span> <span class="token keyword">True</span>
<span class="token keyword">End</span> <span class="token keyword">Sub</span>
</code></pre> 
<h3><a id="4_243"></a>4，合并文件夹下所有工作簿中同名工作表</h3> 
<p>对工作簿按工作表名称进行合并，汇总所有同名工作表，保存为单独工作簿</p> 
<pre><code class="prism language-vbnet"><span class="token keyword">Sub</span> 合并文件夹下所有工作簿中同名工作表<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">'文件夹下所有工作簿wb所有工作表ws按名称合并保存至新建工作表（但不含子文件夹），但不修改原数据（工作表格式相同）</span>
    <span class="token keyword">Dim</span> dict <span class="token keyword">As</span> <span class="token keyword">Object</span><span class="token punctuation">,</span> sht <span class="token keyword">As</span> Worksheet<span class="token punctuation">,</span> file_path$<span class="token punctuation">,</span> file_name$<span class="token punctuation">,</span> title_row<span class="token punctuation">,</span> end_row<span class="token punctuation">,</span> save_file$
<span class="token comment">'--------------------参数填写：title_row，数字，第1行为1向下递增；end_row，数字；file_path，合并文件夹</span>
    title_row <span class="token operator">=</span> <span class="token number">1</span>  <span class="token comment">'表头行数，不参与合并</span>
    end_row <span class="token operator">=</span> <span class="token number">0</span>    <span class="token comment">'表尾行数，不参与合并</span>
    file_path <span class="token operator">=</span> <span class="token string">"E:\测试\拆分表\"</span>  <span class="token comment">'待合并工作簿所在的文件夹</span>
    file_name <span class="token operator">=</span> Dir<span class="token punctuation">(</span>file_path <span class="token operator">&amp;</span> <span class="token string">"*.xlsx"</span><span class="token punctuation">)</span>
    Application.ScreenUpdating <span class="token operator">=</span> <span class="token keyword">False</span>
    Application.DisplayAlerts <span class="token operator">=</span> <span class="token keyword">False</span>
    <span class="token keyword">Set</span> dict <span class="token operator">=</span> CreateObject<span class="token punctuation">(</span><span class="token string">"scripting.dictionary"</span><span class="token punctuation">)</span>
    <span class="token keyword">Set</span> write_wb <span class="token operator">=</span> Workbooks.Add    <span class="token comment">'新建工作簿，合并文件</span>
    <span class="token comment">'新建工作簿默认工作表，防止有同名被合并表，导致整表复制后名称改变；但会缺少表头</span>
    <span class="token keyword">For Each</span> sht <span class="token keyword">In</span> write_wb.Worksheets
        dict<span class="token punctuation">(</span>sht.<span class="token keyword">Name</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">""</span>
    <span class="token keyword">Next</span>
    <span class="token keyword">Do</span> <span class="token keyword">While</span> file_name <span class="token operator">&lt;&gt;</span> <span class="token string">""</span>
        <span class="token keyword">Set</span> wb <span class="token operator">=</span> Workbooks.<span class="token keyword">Open</span><span class="token punctuation">(</span>file_path <span class="token operator">&amp;</span> file_name<span class="token punctuation">)</span>
        <span class="token keyword">For Each</span> sht <span class="token keyword">In</span> wb.Worksheets
            <span class="token keyword">If</span> <span class="token keyword">Not</span> dict.Exists<span class="token punctuation">(</span>sht.<span class="token keyword">Name</span><span class="token punctuation">)</span> <span class="token keyword">Then</span>  <span class="token comment">'不存在的，直接复制整表</span>
                dict<span class="token punctuation">(</span>sht.<span class="token keyword">Name</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">""</span>
                sht.Copy After<span class="token punctuation">:</span><span class="token operator">=</span>write_wb.Sheets<span class="token punctuation">(</span>write_wb.Sheets.count<span class="token punctuation">)</span>
            <span class="token keyword">Else</span>
                <span class="token keyword">Set</span> write_ws <span class="token operator">=</span> write_wb.Worksheets<span class="token punctuation">(</span>sht.<span class="token keyword">Name</span><span class="token punctuation">)</span>
                <span class="token comment">'首行为空，会导致后续数据被覆盖</span>
                <span class="token keyword">If</span> WorksheetFunction.CountA<span class="token punctuation">(</span>write_ws.Rows<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">Then</span> write_ws.Rows<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>.<span class="token function">Delete</span>
                write_row <span class="token operator">=</span> write_ws.UsedRange.Rows.count <span class="token operator">+</span> <span class="token number">1</span>  <span class="token comment">'合并工作表的第一个空行写入</span>
                sheet_row <span class="token operator">=</span> sht.UsedRange.Rows.count
                sht.Rows<span class="token punctuation">(</span>title_row <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&amp;</span> <span class="token string">":"</span> <span class="token operator">&amp;</span> sheet_row <span class="token operator">-</span> end_row<span class="token punctuation">)</span>.Copy write_ws.Range<span class="token punctuation">(</span><span class="token string">"A"</span> <span class="token operator">&amp;</span> write_row<span class="token punctuation">)</span>
            <span class="token keyword">End</span> <span class="token keyword">If</span>
            <span class="token comment">'Exit Do</span>
        <span class="token keyword">Next</span>
        wb.<span class="token keyword">Close</span> <span class="token punctuation">(</span><span class="token keyword">False</span><span class="token punctuation">)</span>
        file_name <span class="token operator">=</span> Dir  <span class="token comment">'下一个文件名</span>
    <span class="token keyword">Loop</span>
    <span class="token comment">'保存文件</span>
    save_file <span class="token operator">=</span> file_path <span class="token operator">&amp;</span> <span class="token string">"合并表.xlsx"</span>
    write_wb.SaveAs filename<span class="token punctuation">:</span><span class="token operator">=</span>save_file
    write_wb.<span class="token keyword">Close</span> <span class="token punctuation">(</span><span class="token keyword">False</span><span class="token punctuation">)</span>
    Application.ScreenUpdating <span class="token operator">=</span> <span class="token keyword">True</span><span class="token punctuation">:</span> Application.DisplayAlerts <span class="token operator">=</span> <span class="token keyword">True</span>
<span class="token keyword">End</span> <span class="token keyword">Sub</span>
</code></pre> 
<h4><a id="41_290"></a>4.1，合并且显示原工作簿名称</h4> 
<p><font color="red" size="4">2022.8.27更新</font>，应评论建议<br> 增加在A列显示原工作簿名称；因按同名工作表合并，故没有显示原工作表名称的必要<br> <font color="red" size="4">2023.5.23更新</font>，应评论建议<br> 为避免工作表公式因复制粘贴导致引用错误，新增粘贴为数值功能，且不改变工作表格式</p> 
<pre><code class="prism language-vbnet"><span class="token keyword">Sub</span> 合并文件夹下所有工作簿中同名工作表<span class="token number">1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">'文件夹下所有工作簿wb所有工作表ws按名称合并保存至新建工作表（但不含子文件夹），但不修改原数据（工作表格式相同）</span>
    <span class="token keyword">Dim</span> dict <span class="token keyword">As</span> <span class="token keyword">Object</span><span class="token punctuation">,</span> sht <span class="token keyword">As</span> Worksheet<span class="token punctuation">,</span> fso <span class="token keyword">As</span> <span class="token keyword">Object</span><span class="token punctuation">,</span> only_value <span class="token keyword">As</span> <span class="token keyword">Boolean</span>
    <span class="token keyword">Dim</span> file_path$<span class="token punctuation">,</span> file_name$<span class="token punctuation">,</span> title_row<span class="token operator">&amp;</span><span class="token punctuation">,</span> end_row<span class="token operator">&amp;</span><span class="token punctuation">,</span> save_file$
    <span class="token keyword">Dim</span> write_row<span class="token operator">&amp;</span><span class="token punctuation">,</span> sht_row<span class="token operator">&amp;</span><span class="token punctuation">,</span> sht_col<span class="token operator">&amp;</span><span class="token punctuation">,</span> copy_row<span class="token operator">&amp;</span><span class="token punctuation">,</span> temp<span class="token punctuation">,</span> r<span class="token operator">&amp;</span>
<span class="token comment">'--------------------参数填写：title_row，数字，第1行为1向下递增；end_row，数字</span>
    title_row <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">:</span> end_row <span class="token operator">=</span> <span class="token number">0</span>  <span class="token comment">'表头、表尾行数，不参与合并</span>
    only_value <span class="token operator">=</span> <span class="token keyword">True</span>  <span class="token comment">'仅粘贴为数值，是/否</span>
    file_path <span class="token operator">=</span> <span class="token string">"E:\测试\拆分表\"</span>  <span class="token comment">'待合并工作簿所在的文件夹</span>
    file_name <span class="token operator">=</span> Dir<span class="token punctuation">(</span>file_path <span class="token operator">&amp;</span> <span class="token string">"*.xlsx"</span><span class="token punctuation">)</span>
    Application.ScreenUpdating <span class="token operator">=</span> <span class="token keyword">False</span>  <span class="token comment">'关闭屏幕更新，加快程序运行</span>
    Application.DisplayAlerts <span class="token operator">=</span> <span class="token keyword">False</span>   <span class="token comment">'不显示警告信息</span>
    <span class="token keyword">Set</span> fso <span class="token operator">=</span> CreateObject<span class="token punctuation">(</span><span class="token string">"Scripting.FileSystemObject"</span><span class="token punctuation">)</span>
    <span class="token keyword">Set</span> dict <span class="token operator">=</span> CreateObject<span class="token punctuation">(</span><span class="token string">"scripting.dictionary"</span><span class="token punctuation">)</span>
    <span class="token keyword">Set</span> write_wb <span class="token operator">=</span> Workbooks.Add    <span class="token comment">'新建工作簿，合并文件</span>
    <span class="token comment">'新建工作簿默认工作表，防止有同名被合并表，导致整表复制后名称改变；但会缺少表头</span>
    <span class="token keyword">For Each</span> sht <span class="token keyword">In</span> write_wb.Worksheets
        dict<span class="token punctuation">(</span>sht.<span class="token keyword">Name</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">:</span> sht.[a1] <span class="token operator">=</span> <span class="token string">"原工作簿名称"</span>
    <span class="token keyword">Next</span>
    <span class="token keyword">Do</span> <span class="token keyword">While</span> file_name <span class="token operator">&lt;&gt;</span> <span class="token string">""</span>
        <span class="token keyword">Set</span> wb <span class="token operator">=</span> Workbooks.<span class="token keyword">Open</span><span class="token punctuation">(</span>file_path <span class="token operator">&amp;</span> file_name<span class="token punctuation">)</span>
        <span class="token keyword">For Each</span> sht <span class="token keyword">In</span> wb.Worksheets
            <span class="token keyword">If</span> <span class="token keyword">Not</span> dict.Exists<span class="token punctuation">(</span>sht.<span class="token keyword">Name</span><span class="token punctuation">)</span> <span class="token keyword">Then</span>  <span class="token comment">'不存在的，直接复制整表</span>
                dict<span class="token punctuation">(</span>sht.<span class="token keyword">Name</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">:</span> temp <span class="token operator">=</span> sht.UsedRange.Value
                sht.Copy After<span class="token punctuation">:</span><span class="token operator">=</span>write_wb.Sheets<span class="token punctuation">(</span>write_wb.Sheets.Count<span class="token punctuation">)</span>
                <span class="token keyword">With</span> ActiveSheet
                    .Columns<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>.Insert<span class="token punctuation">:</span> [a1] <span class="token operator">=</span> <span class="token string">"原工作簿名称"</span>  <span class="token comment">'插入列</span>
                    <span class="token keyword">If</span> end_row <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">Then</span>  <span class="token comment">'删除表尾行</span>
                        r <span class="token operator">=</span> .UsedRange.Rows.Count
                        .Cells<span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>.Offset<span class="token punctuation">(</span><span class="token operator">-</span>end_row <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>.Resize<span class="token punctuation">(</span>end_row<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>.EntireRow.<span class="token function">Delete</span>
                    <span class="token keyword">End</span> <span class="token keyword">If</span>
                    .Cells<span class="token punctuation">(</span>title_row <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>.Resize<span class="token punctuation">(</span>.UsedRange.Rows.Count <span class="token operator">-</span> title_row<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> fso.GetBaseName<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span>  <span class="token comment">'需要扩展名可直接赋值file_name</span>
                    <span class="token keyword">If</span> only_value <span class="token keyword">Then</span> .[b1].Resize<span class="token punctuation">(</span><span class="token function">UBound</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span> <span class="token operator">-</span> end_row<span class="token punctuation">,</span> <span class="token function">UBound</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> temp
                <span class="token keyword">End</span> <span class="token keyword">With</span>
            <span class="token keyword">Else</span>
                <span class="token keyword">With</span> write_wb.Worksheets<span class="token punctuation">(</span>sht.<span class="token keyword">Name</span><span class="token punctuation">)</span>
                    <span class="token keyword">If</span> WorksheetFunction.CountA<span class="token punctuation">(</span>.Rows<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">Then</span> .Rows<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>.<span class="token function">Delete</span>
                    write_row <span class="token operator">=</span> .UsedRange.Rows.Count <span class="token operator">+</span> <span class="token number">1</span>  <span class="token comment">'合并工作表的第一个空行写入</span>
                    sht_row <span class="token operator">=</span> sht.UsedRange.Rows.Count<span class="token punctuation">:</span> sht_col <span class="token operator">=</span> sht.UsedRange.Columns.Count
                    copy_row <span class="token operator">=</span> sht_row <span class="token operator">-</span> title_row <span class="token operator">-</span> end_row  <span class="token comment">'复制行数</span>
                    temp <span class="token operator">=</span> sht.Cells<span class="token punctuation">(</span>title_row <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">)</span>.Resize<span class="token punctuation">(</span>copy_row<span class="token punctuation">,</span> sht_col<span class="token punctuation">)</span>.Value
                    sht.Cells<span class="token punctuation">(</span>title_row <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">)</span>.Resize<span class="token punctuation">(</span>copy_row<span class="token punctuation">,</span> sht_col<span class="token punctuation">)</span>.Copy .Cells<span class="token punctuation">(</span>write_row<span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">)</span>
                    <span class="token keyword">If</span> only_value <span class="token keyword">Then</span> .Cells<span class="token punctuation">(</span>write_row<span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">)</span>.Resize<span class="token punctuation">(</span>copy_row<span class="token punctuation">,</span> sht_col<span class="token punctuation">)</span> <span class="token operator">=</span> temp
                    .Cells<span class="token punctuation">(</span>write_row<span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">)</span>.Resize<span class="token punctuation">(</span>copy_row<span class="token punctuation">)</span> <span class="token operator">=</span> fso.GetBaseName<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span>
                <span class="token keyword">End</span> <span class="token keyword">With</span>
            <span class="token keyword">End</span> <span class="token keyword">If</span>
        <span class="token keyword">Next</span>
        wb.<span class="token keyword">Close</span> <span class="token punctuation">(</span><span class="token keyword">False</span><span class="token punctuation">)</span>  <span class="token comment">'关闭工作簿</span>
        file_name <span class="token operator">=</span> Dir  <span class="token comment">'下一个文件名</span>
    <span class="token keyword">Loop</span>
    <span class="token keyword">For Each</span> sht <span class="token keyword">In</span> write_wb.Worksheets  <span class="token comment">'删除空表ws</span>
        <span class="token keyword">If</span> sht.UsedRange.Rows.Count <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">Then</span> sht.<span class="token function">Delete</span>
    <span class="token keyword">Next</span>
    <span class="token comment">'保存文件</span>
    save_file <span class="token operator">=</span> file_path <span class="token operator">&amp;</span> <span class="token string">"合并表.xlsx"</span>
    write_wb.SaveAs filename<span class="token punctuation">:</span><span class="token operator">=</span>save_file
    write_wb.<span class="token keyword">Close</span> <span class="token punctuation">(</span><span class="token keyword">False</span><span class="token punctuation">)</span>
    Application.ScreenUpdating <span class="token operator">=</span> <span class="token keyword">True</span><span class="token punctuation">:</span> Application.DisplayAlerts <span class="token operator">=</span> <span class="token keyword">True</span>
<span class="token keyword">End</span> <span class="token keyword">Sub</span>
</code></pre> 
<h5><a id="_357"></a>举例</h5> 
<p><a id="page_jump"></a><br> 合并<a href="https://blog.csdn.net/hhhhh_51/article/details/122414404">《Excel·VBA按列拆分工作表、工作簿》</a>，sub3（工作簿按列拆分）拆分后的工作簿<br> <img src="https://images2.imgbox.com/6c/54/JqefkMRk_o.jpg" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/20/47/GP5O5bhK_o.jpg" alt="在这里插入图片描述"><br> 合并参数：title_row = 1，end_row = 0，合并后<br> <img src="https://images2.imgbox.com/6a/f5/lOlHX1Ce_o.jpg" alt="在这里插入图片描述"></p> 
<h3><a id="5_365"></a>5，合并文件夹下所有工作簿中所有工作表，横向汇总数据</h3> 
<p>对格式相同的工作表进行合并，横向汇总数据（注意：如果数据量较大，需要修改arr数组的Resize大小）</p> 
<pre><code class="prism language-vbnet"><span class="token keyword">Sub</span> 合并文件夹下所有工作簿中所有工作表_横向汇总数据<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">'多列键汇总单列数据，适用工作表格式相同、待汇总数据为最后一列</span>
    <span class="token keyword">Dim</span> dict <span class="token keyword">As</span> <span class="token keyword">Object</span><span class="token punctuation">,</span> sht <span class="token keyword">As</span> Worksheet<span class="token punctuation">,</span> title_col<span class="token operator">&amp;</span><span class="token punctuation">,</span> key_col<span class="token punctuation">,</span> s_row<span class="token operator">&amp;</span>
    <span class="token keyword">Dim</span> file_path$<span class="token punctuation">,</span> file_name$<span class="token punctuation">,</span> arr<span class="token punctuation">,</span> brr<span class="token punctuation">,</span> temp$<span class="token punctuation">,</span> w_row<span class="token operator">&amp;</span><span class="token punctuation">,</span> w_col<span class="token operator">&amp;</span><span class="token punctuation">,</span> i<span class="token operator">&amp;</span><span class="token punctuation">,</span> j<span class="token operator">&amp;</span><span class="token punctuation">,</span> r<span class="token operator">&amp;</span>
<span class="token comment">'--------------------参数填写：title_col、key_col、s_row，大于0的整数</span>
    title_col <span class="token operator">=</span> <span class="token number">3</span>    <span class="token comment">'表头列数，每个拆分后的sheet都保留，数值</span>
    key_col <span class="token operator">=</span> <span class="token function">Array</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>  <span class="token comment">'关键值列，按该列的值相同的进行合并，数值数组</span>
    s_row <span class="token operator">=</span> <span class="token number">2</span>        <span class="token comment">'数据遍历开始行号</span>
    file_path <span class="token operator">=</span> <span class="token string">"E:\测试\拆分表\"</span>  <span class="token comment">'待合并工作簿所在的文件夹</span>
    file_name <span class="token operator">=</span> Dir<span class="token punctuation">(</span>file_path <span class="token operator">&amp;</span> <span class="token string">"*.xlsx"</span><span class="token punctuation">)</span>
    Application.ScreenUpdating <span class="token operator">=</span> <span class="token keyword">False</span>  <span class="token comment">'关闭屏幕更新，加快程序运行</span>
    Application.DisplayAlerts <span class="token operator">=</span> <span class="token keyword">False</span>   <span class="token comment">'不显示警告信息</span>
    <span class="token keyword">Set</span> dict <span class="token operator">=</span> CreateObject<span class="token punctuation">(</span><span class="token string">"scripting.dictionary"</span><span class="token punctuation">)</span>
    <span class="token keyword">Set</span> write_wb <span class="token operator">=</span> Workbooks.Add    <span class="token comment">'新建工作簿，合并文件</span>
    <span class="token keyword">Set</span> write_ws <span class="token operator">=</span> ActiveSheet<span class="token punctuation">:</span> write_ws.<span class="token keyword">Name</span> <span class="token operator">=</span> <span class="token string">"合并表"</span>
    
    <span class="token keyword">Do</span> <span class="token keyword">While</span> file_name <span class="token operator">&lt;&gt;</span> <span class="token string">""</span>
        <span class="token keyword">Set</span> wb <span class="token operator">=</span> Workbooks.<span class="token keyword">Open</span><span class="token punctuation">(</span>file_path <span class="token operator">&amp;</span> file_name<span class="token punctuation">)</span>
        <span class="token keyword">For Each</span> sht <span class="token keyword">In</span> wb.Worksheets
            <span class="token keyword">With</span> sht
                <span class="token keyword">If</span> WorksheetFunction.CountA<span class="token punctuation">(</span>.UsedRange.Cells<span class="token punctuation">)</span> <span class="token operator">&lt;&gt;</span> <span class="token number">0</span> <span class="token keyword">Then</span>  <span class="token comment">'非空工作表</span>
                    <span class="token keyword">If</span> w_col <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">Then</span>
                        arr <span class="token operator">=</span> .[a1].CurrentRegion.Resize<span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">^</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">10</span> <span class="token operator">^</span> <span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment">'arr最大化，写入行列号初始化</span>
                        w_row <span class="token operator">=</span> .[a1].CurrentRegion.Rows.Count<span class="token punctuation">:</span> w_col <span class="token operator">=</span> .[a1].CurrentRegion.Columns.Count
                        <span class="token keyword">For</span> i <span class="token operator">=</span> s_row <span class="token keyword">To</span> w_row
                            temp <span class="token operator">=</span> <span class="token string">""</span>
                            <span class="token keyword">For Each</span> k <span class="token keyword">In</span> key_col
                                temp <span class="token operator">=</span> temp <span class="token operator">&amp;</span> <span class="token string">"-"</span> <span class="token operator">&amp;</span> arr<span class="token punctuation">(</span>i<span class="token punctuation">,</span> k<span class="token punctuation">)</span>
                            <span class="token keyword">Next</span>
                            temp <span class="token operator">=</span> <span class="token function">Mid</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span> dict<span class="token punctuation">(</span>temp<span class="token punctuation">)</span> <span class="token operator">=</span> i  <span class="token comment">'键去除开头的"-"，值为行号</span>
                        <span class="token keyword">Next</span>
                    <span class="token keyword">Else</span>
                        brr <span class="token operator">=</span> .[a1].CurrentRegion
                        w_col <span class="token operator">=</span> w_col <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">:</span> arr<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> w_col<span class="token punctuation">)</span> <span class="token operator">=</span> brr<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">UBound</span><span class="token punctuation">(</span>brr<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">'新增列号</span>
                        <span class="token keyword">For</span> i <span class="token operator">=</span> s_row <span class="token keyword">To</span> <span class="token function">UBound</span><span class="token punctuation">(</span>brr<span class="token punctuation">)</span>
                            temp <span class="token operator">=</span> <span class="token string">""</span>
                            <span class="token keyword">For Each</span> k <span class="token keyword">In</span> key_col
                                temp <span class="token operator">=</span> temp <span class="token operator">&amp;</span> <span class="token string">"-"</span> <span class="token operator">&amp;</span> brr<span class="token punctuation">(</span>i<span class="token punctuation">,</span> k<span class="token punctuation">)</span>
                            <span class="token keyword">Next</span>
                            temp <span class="token operator">=</span> <span class="token function">Mid</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
                            <span class="token keyword">If</span> <span class="token keyword">Not</span> dict.exists<span class="token punctuation">(</span>temp<span class="token punctuation">)</span> <span class="token keyword">Then</span>  <span class="token comment">'新增关键值</span>
                                w_row <span class="token operator">=</span> w_row <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">:</span> dict<span class="token punctuation">(</span>temp<span class="token punctuation">)</span> <span class="token operator">=</span> w_row  <span class="token comment">'新增行号</span>
                                <span class="token keyword">For</span> j <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">To</span> <span class="token function">UBound</span><span class="token punctuation">(</span>brr<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span>
                                    arr<span class="token punctuation">(</span>w_row<span class="token punctuation">,</span> j<span class="token punctuation">)</span> <span class="token operator">=</span> brr<span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span>
                                <span class="token keyword">Next</span>
                            <span class="token keyword">End</span> <span class="token keyword">If</span>
                            r <span class="token operator">=</span> dict<span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token punctuation">:</span> arr<span class="token punctuation">(</span>r<span class="token punctuation">,</span> w_col<span class="token punctuation">)</span> <span class="token operator">=</span> brr<span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token function">UBound</span><span class="token punctuation">(</span>brr<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">'写入数据</span>
                        <span class="token keyword">Next</span>
                    <span class="token keyword">End</span> <span class="token keyword">If</span>
                <span class="token keyword">End</span> <span class="token keyword">If</span>
            <span class="token keyword">End</span> <span class="token keyword">With</span>
        <span class="token keyword">Next</span>
        wb.<span class="token keyword">Close</span> <span class="token punctuation">(</span><span class="token keyword">False</span><span class="token punctuation">)</span>
        file_name <span class="token operator">=</span> Dir  <span class="token comment">'下一个文件名</span>
    <span class="token keyword">Loop</span>
    write_ws.[a1].Resize<span class="token punctuation">(</span>w_row<span class="token punctuation">,</span> w_col<span class="token punctuation">)</span> <span class="token operator">=</span> arr
    write_wb.SaveAs filename<span class="token punctuation">:</span><span class="token operator">=</span>file_path <span class="token operator">&amp;</span> <span class="token string">"合并表.xlsx"</span>
    write_wb.<span class="token keyword">Close</span> <span class="token punctuation">(</span><span class="token keyword">False</span><span class="token punctuation">)</span>
    Application.ScreenUpdating <span class="token operator">=</span> <span class="token keyword">True</span><span class="token punctuation">:</span> Application.DisplayAlerts <span class="token operator">=</span> <span class="token keyword">True</span>
<span class="token keyword">End</span> <span class="token keyword">Sub</span>
</code></pre> 
<h4><a id="_431"></a>举例</h4> 
<p><img src="https://images2.imgbox.com/c6/0f/3iS7XLsK_o.jpg" alt="在这里插入图片描述"></p> 
<p>对文件夹下多个工作簿、每个工作簿下有多个工作表、每个工作表格式相同，横向汇总某一列数据。且不同工作簿可能存在行数不同的情况，按字典键值汇总，但不进行计算，结果如下：<br> <img src="https://images2.imgbox.com/0d/7d/FY33bZhp_o.jpg" alt="在这里插入图片描述"></p> 
<h3><a id="6_437"></a>6，合并子文件夹所有工作簿中所有工作表，纵向汇总数据</h3> 
<p>适用所有工作簿中的所有工作表格式都相同的合并，每个子文件夹生成一个工作表，工作表中包含该子文件夹所有工作簿数据，子文件夹名命名该工作表</p> 
<p>不仅可以在A列显示 “原工作簿名称” 、B列显示 “原工作表名称” 信息，<font color="red" size="4">同时参数old_name = False</font>也可将该信息删除</p> 
<p><font color="red" size="4">新增可指定合并至指定文件的功能</font>，而文章之前内容只能合并至固定新建文件。<strong>其优势在于：</strong> 遍历子文件夹获取的子文件夹名顺序，及其自动生成的工作表名称顺序，不一定是自己想要的/实际看到的，如果事先自建合并文件，可自行修改工作表名称、顺序，然后运行代码，最终生成的文件内工作表顺序就是自己想要的</p> 
<pre><code class="prism language-vbnet"><span class="token keyword">Sub</span> 合并文件夹下子文件夹所有工作簿中所有工作表_纵向汇总数据<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">'最终合并文件sheet以子文件夹命名，适用工作表格式相同</span>
    <span class="token comment">'合并文件A列显示原工作簿名称，B列显示原工作表名称；新增可指定合并文件</span>
    <span class="token keyword">Dim</span> dict <span class="token keyword">As</span> <span class="token keyword">Object</span><span class="token punctuation">,</span> sht <span class="token keyword">As</span> Worksheet<span class="token punctuation">,</span> fso <span class="token keyword">As</span> <span class="token keyword">Object</span><span class="token punctuation">,</span> only_value <span class="token keyword">As</span> <span class="token keyword">Boolean</span><span class="token punctuation">,</span> old_name <span class="token keyword">As</span> <span class="token keyword">Boolean</span>
    <span class="token keyword">Dim</span> file_path$<span class="token punctuation">,</span> file_name$<span class="token punctuation">,</span> title_row<span class="token operator">&amp;</span><span class="token punctuation">,</span> end_row<span class="token operator">&amp;</span><span class="token punctuation">,</span> save_file$<span class="token punctuation">,</span> s$<span class="token punctuation">,</span> title_name<span class="token punctuation">,</span> wb <span class="token keyword">As</span> Workbook
    <span class="token keyword">Dim</span> write_row<span class="token operator">&amp;</span><span class="token punctuation">,</span> sht_row<span class="token operator">&amp;</span><span class="token punctuation">,</span> sht_col<span class="token operator">&amp;</span><span class="token punctuation">,</span> copy_row<span class="token operator">&amp;</span><span class="token punctuation">,</span> nrr<span class="token punctuation">,</span> p<span class="token punctuation">,</span> f<span class="token punctuation">,</span> temp<span class="token punctuation">,</span> r<span class="token operator">&amp;</span><span class="token punctuation">,</span> write_wb <span class="token keyword">As</span> Workbook
<span class="token comment">'--------------------参数填写：title_row，数字，第1行为1向下递增；end_row，数字</span>
    title_row <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">:</span> end_row <span class="token operator">=</span> <span class="token number">0</span>  <span class="token comment">'表头、表尾行数，不参与合并</span>
    <span class="token comment">'file_path待合并的子文件夹所在文件夹；file_name合并至指定文件，为空""或注释则自动生成文件</span>
    file_path <span class="token operator">=</span> <span class="token string">"E:\测试\拆分表\"</span>
    <span class="token comment">'file_name = "E:\测试\拆分表\指定合并表.xlsx"</span>
    only_value <span class="token operator">=</span> <span class="token keyword">True</span>  <span class="token comment">'仅粘贴为数值，是/否</span>
    old_name <span class="token operator">=</span> <span class="token keyword">True</span>    <span class="token comment">'写入原工作簿、工作表名称，是/否</span>
    Application.ScreenUpdating <span class="token operator">=</span> <span class="token keyword">False</span>  <span class="token comment">'关闭屏幕更新，加快程序运行</span>
    Application.DisplayAlerts <span class="token operator">=</span> <span class="token keyword">False</span>   <span class="token comment">'不显示警告信息</span>
    <span class="token keyword">Set</span> dict <span class="token operator">=</span> CreateObject<span class="token punctuation">(</span><span class="token string">"scripting.dictionary"</span><span class="token punctuation">)</span><span class="token punctuation">:</span> delimiter <span class="token operator">=</span> <span class="token function">Chr</span><span class="token punctuation">(</span><span class="token number">28</span><span class="token punctuation">)</span>
    <span class="token keyword">Set</span> fso <span class="token operator">=</span> CreateObject<span class="token punctuation">(</span><span class="token string">"Scripting.FileSystemObject"</span><span class="token punctuation">)</span><span class="token punctuation">:</span> tm <span class="token operator">=</span> <span class="token keyword">Timer</span>
    <span class="token keyword">If</span> <span class="token function">Len</span><span class="token punctuation">(</span>file_name<span class="token punctuation">)</span> <span class="token keyword">Then</span>  <span class="token comment">'file_name不为空则打开，为空则新建工作簿，即合并文件</span>
        <span class="token keyword">Set</span> write_wb <span class="token operator">=</span> Workbooks.<span class="token keyword">Open</span><span class="token punctuation">(</span>file_name<span class="token punctuation">)</span>
    <span class="token keyword">Else</span>
        <span class="token keyword">Set</span> write_wb <span class="token operator">=</span> Workbooks.Add
    <span class="token keyword">End</span> <span class="token keyword">If</span>
    <span class="token comment">'新建工作簿默认工作表，防止有同名被合并表，导致整表复制后名称改变；并清空表格</span>
    title_name <span class="token operator">=</span> <span class="token function">Array</span><span class="token punctuation">(</span><span class="token string">"原工作簿名称"</span><span class="token punctuation">,</span> <span class="token string">"原工作表名称"</span><span class="token punctuation">)</span>
    <span class="token keyword">For Each</span> sht <span class="token keyword">In</span> write_wb.Worksheets
        dict<span class="token punctuation">(</span>sht.<span class="token keyword">Name</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">:</span> sht.UsedRange.<span class="token function">Delete</span><span class="token punctuation">:</span> sht.[a1].Resize<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> title_name
    <span class="token keyword">Next</span>
    <span class="token keyword">For Each</span> f <span class="token keyword">In</span> fso.GetFolder<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span>.SubFolders  <span class="token comment">'获取所有子文件夹名</span>
        s <span class="token operator">=</span> s <span class="token operator">&amp;</span> delimiter <span class="token operator">&amp;</span> f.<span class="token keyword">Name</span>
    <span class="token keyword">Next</span>
    fd <span class="token operator">=</span> Split<span class="token punctuation">(</span><span class="token function">Mid</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> delimiter<span class="token punctuation">)</span>
    <span class="token keyword">For Each</span> p <span class="token keyword">In</span> fd
        <span class="token keyword">For Each</span> f <span class="token keyword">In</span> fso.GetFolder<span class="token punctuation">(</span>file_path <span class="token operator">&amp;</span> p<span class="token punctuation">)</span>.<span class="token keyword">Files</span>  <span class="token comment">'空文件夹不影响</span>
            <span class="token keyword">If</span> f.<span class="token keyword">Name</span> <span class="token keyword">Like</span> <span class="token string">"*.xls*"</span> <span class="token keyword">Then</span>
                <span class="token keyword">Set</span> wb <span class="token operator">=</span> Workbooks.<span class="token keyword">Open</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span>
                <span class="token keyword">For Each</span> sht <span class="token keyword">In</span> wb.Worksheets
                    <span class="token keyword">If</span> <span class="token keyword">Not</span> dict.Exists<span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token keyword">Then</span>  <span class="token comment">'子文件夹不存在的，直接复制整表</span>
                        dict<span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">""</span>
                        sht.Copy After<span class="token punctuation">:</span><span class="token operator">=</span>write_wb.Sheets<span class="token punctuation">(</span>write_wb.Sheets.Count<span class="token punctuation">)</span>
                        ActiveSheet.<span class="token keyword">Name</span> <span class="token operator">=</span> p
                        <span class="token keyword">With</span> write_wb.Worksheets<span class="token punctuation">(</span>p<span class="token punctuation">)</span>
                            nrr <span class="token operator">=</span> <span class="token function">Array</span><span class="token punctuation">(</span>fso.GetBaseName<span class="token punctuation">(</span>f.<span class="token keyword">Name</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sht.<span class="token keyword">Name</span><span class="token punctuation">)</span><span class="token punctuation">:</span> temp <span class="token operator">=</span> sht.UsedRange.Value
                            .Columns<span class="token punctuation">(</span><span class="token string">"a:b"</span><span class="token punctuation">)</span>.Insert<span class="token punctuation">:</span> .[a1].Resize<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> title_name <span class="token comment">'插入列</span>
                            <span class="token keyword">If</span> end_row <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">Then</span>  <span class="token comment">'删除表尾行</span>
                                r <span class="token operator">=</span> .UsedRange.Rows.Count
                                .Cells<span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>.Offset<span class="token punctuation">(</span><span class="token operator">-</span>end_row <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>.Resize<span class="token punctuation">(</span>end_row<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>.EntireRow.<span class="token function">Delete</span>
                            <span class="token keyword">End</span> <span class="token keyword">If</span>
                            .Cells<span class="token punctuation">(</span>title_row <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>.Resize<span class="token punctuation">(</span>.UsedRange.Rows.Count <span class="token operator">-</span> title_row<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> nrr
                            <span class="token keyword">If</span> only_value <span class="token keyword">Then</span> .[c1].Resize<span class="token punctuation">(</span><span class="token function">UBound</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span> <span class="token operator">-</span> end_row<span class="token punctuation">,</span> <span class="token function">UBound</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> temp
                        <span class="token keyword">End</span> <span class="token keyword">With</span>
                    <span class="token keyword">Else</span>
                        <span class="token keyword">With</span> write_wb.Worksheets<span class="token punctuation">(</span>p<span class="token punctuation">)</span>
                            nrr <span class="token operator">=</span> <span class="token function">Array</span><span class="token punctuation">(</span>fso.GetBaseName<span class="token punctuation">(</span>f.<span class="token keyword">Name</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sht.<span class="token keyword">Name</span><span class="token punctuation">)</span>  <span class="token comment">'需要扩展名可直接赋值f.Name</span>
                            <span class="token keyword">If</span> .UsedRange.Rows.Count <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">Then</span>  <span class="token comment">'空表为1</span>
                                temp <span class="token operator">=</span> sht.UsedRange.Value<span class="token punctuation">:</span> sht.UsedRange.Copy .[c1]  <span class="token comment">'含格式复制</span>
                                <span class="token keyword">If</span> end_row <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">Then</span>  <span class="token comment">'删除表尾行</span>
                                    r <span class="token operator">=</span> .UsedRange.Rows.Count
                                    .Cells<span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>.Offset<span class="token punctuation">(</span><span class="token operator">-</span>end_row <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>.Resize<span class="token punctuation">(</span>end_row<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>.EntireRow.<span class="token function">Delete</span>
                                <span class="token keyword">End</span> <span class="token keyword">If</span>
                                .Cells<span class="token punctuation">(</span>title_row <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>.Resize<span class="token punctuation">(</span>.UsedRange.Rows.Count <span class="token operator">-</span> title_row<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> nrr
                                <span class="token keyword">If</span> only_value <span class="token keyword">Then</span> .[c1].Resize<span class="token punctuation">(</span><span class="token function">UBound</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span> <span class="token operator">-</span> end_row<span class="token punctuation">,</span> <span class="token function">UBound</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> temp
                            <span class="token keyword">Else</span>
                                write_row <span class="token operator">=</span> .UsedRange.Rows.Count <span class="token operator">+</span> <span class="token number">1</span>  <span class="token comment">'合并工作表的第一个空行写入</span>
                                sht_row <span class="token operator">=</span> sht.UsedRange.Rows.Count<span class="token punctuation">:</span> sht_col <span class="token operator">=</span> sht.UsedRange.Columns.Count
                                copy_row <span class="token operator">=</span> sht_row <span class="token operator">-</span> title_row <span class="token operator">-</span> end_row  <span class="token comment">'复制行数</span>
                                temp <span class="token operator">=</span> sht.Cells<span class="token punctuation">(</span>title_row <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">)</span>.Resize<span class="token punctuation">(</span>copy_row<span class="token punctuation">,</span> sht_col<span class="token punctuation">)</span>.Value
                                sht.Cells<span class="token punctuation">(</span>title_row <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">)</span>.Resize<span class="token punctuation">(</span>copy_row<span class="token punctuation">,</span> sht_col<span class="token punctuation">)</span>.Copy .Cells<span class="token punctuation">(</span>write_row<span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">)</span>
                                <span class="token keyword">If</span> only_value <span class="token keyword">Then</span> .Cells<span class="token punctuation">(</span>write_row<span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">)</span>.Resize<span class="token punctuation">(</span>copy_row<span class="token punctuation">,</span> sht_col<span class="token punctuation">)</span> <span class="token operator">=</span> temp
                                .Cells<span class="token punctuation">(</span>write_row<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>.Resize<span class="token punctuation">(</span>copy_row<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> nrr
                            <span class="token keyword">End</span> <span class="token keyword">If</span>
                        <span class="token keyword">End</span> <span class="token keyword">With</span>
                    <span class="token keyword">End</span> <span class="token keyword">If</span>
                <span class="token keyword">Next</span>
                wb.<span class="token keyword">Close</span> <span class="token punctuation">(</span><span class="token keyword">False</span><span class="token punctuation">)</span>
            <span class="token keyword">End</span> <span class="token keyword">If</span>
        <span class="token keyword">Next</span>
    <span class="token keyword">Next</span>
    <span class="token keyword">For Each</span> sht <span class="token keyword">In</span> write_wb.Worksheets  <span class="token comment">'删除空表ws</span>
        <span class="token keyword">If</span> sht.UsedRange.Rows.Count <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">Then</span> sht.<span class="token function">Delete</span>
    <span class="token keyword">Next</span>
    <span class="token keyword">If</span> <span class="token keyword">Not</span> old_name <span class="token keyword">Then</span>  <span class="token comment">'无需写入原工作簿、工作表名称</span>
        <span class="token keyword">For Each</span> sht <span class="token keyword">In</span> write_wb.Worksheets
            sht.Columns<span class="token punctuation">(</span><span class="token string">"a:b"</span><span class="token punctuation">)</span>.<span class="token function">Delete</span>
        <span class="token keyword">Next</span>
    <span class="token keyword">End</span> <span class="token keyword">If</span>
    <span class="token keyword">If</span> <span class="token function">Len</span><span class="token punctuation">(</span>file_name<span class="token punctuation">)</span> <span class="token keyword">Then</span>  <span class="token comment">'保存文件，file_name不为空</span>
        write_wb.<span class="token keyword">Close</span> <span class="token punctuation">(</span><span class="token keyword">True</span><span class="token punctuation">)</span>
    <span class="token keyword">Else</span>
        save_file <span class="token operator">=</span> file_path <span class="token operator">&amp;</span> <span class="token string">"合并表.xlsx"</span>
        write_wb.SaveAs filename<span class="token punctuation">:</span><span class="token operator">=</span>save_file
        write_wb.<span class="token keyword">Close</span> <span class="token punctuation">(</span><span class="token keyword">False</span><span class="token punctuation">)</span>
    <span class="token keyword">End</span> <span class="token keyword">If</span>
    Application.ScreenUpdating <span class="token operator">=</span> <span class="token keyword">True</span><span class="token punctuation">:</span> Application.DisplayAlerts <span class="token operator">=</span> <span class="token keyword">True</span>
    <span class="token function">Debug</span>.<span class="token function">Print</span> <span class="token string">"文件夹合并完成，用时："</span> <span class="token operator">&amp;</span> Format<span class="token punctuation">(</span><span class="token keyword">Timer</span> <span class="token operator">-</span> tm<span class="token punctuation">,</span> <span class="token string">"0.00"</span><span class="token punctuation">)</span>
<span class="token keyword">End</span> <span class="token keyword">Sub</span>
</code></pre> 
<h4><a id="_541"></a>举例</h4> 
<p>合并<a href="#page_jump" rel="nofollow">4.1-举例</a>中同样的数据，但是每个文件都放入一个同名文件夹中</p> 
<p>合并参数：title_row = 1，end_row = 0，file_name被注释，合并后<br> <img src="https://images2.imgbox.com/70/25/nLJBUE9N_o.jpg" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/99/93/xRnGw2Jy_o.jpg" alt="在这里插入图片描述"><br> 指定合并表，并自行修改工作表名称、顺序<br> <img src="https://images2.imgbox.com/e3/7b/HKCXeaYU_o.jpg" alt="在这里插入图片描述"><br> 合并参数：file_path不变，file_name为指定合并表的文件路径，合并后<br> <img src="https://images2.imgbox.com/86/ec/wYjm0sjB_o.jpg" alt="在这里插入图片描述"></p> 
<h3><a id="7_552"></a>7，合并子文件夹同名工作簿中同名工作表，纵向汇总数据</h3> 
<p>针对解决本问题：<a href="https://tieba.baidu.com/p/8607209427" rel="nofollow">《Excel吧-批量合并同名工作簿》</a><br> 合并不同文件夹中的同名工作簿，并按工作表名称纵向合并数据。适用同名工作簿中的同名工作表格式相同的合并，按每个工作簿名称生成一个合并工作簿，包含所有子文件夹中所有同名工作簿数据；合并工作簿统一保存在“合并表”文件夹</p> 
<h4><a id="711_555"></a>7.1，实现方法1</h4> 
<p>采用按子文件夹顺序，依次遍历子文件夹中所有工作簿，因此合并工作簿需要反复打开写入再保存关闭，速度较慢</p> 
<pre><code class="prism language-vbnet"><span class="token keyword">Sub</span> 合并子文件夹同名工作簿中同名工作表_纵向汇总数据<span class="token number">1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">'最终合并文件sheet以工作簿名命名，适用工作表格式相同；合并文件A列显示原子文件夹名</span>
    <span class="token keyword">Dim</span> dict <span class="token keyword">As</span> <span class="token keyword">Object</span><span class="token punctuation">,</span> sht <span class="token keyword">As</span> Worksheet<span class="token punctuation">,</span> fso <span class="token keyword">As</span> <span class="token keyword">Object</span><span class="token punctuation">,</span> only_value <span class="token keyword">As</span> <span class="token keyword">Boolean</span><span class="token punctuation">,</span> old_name <span class="token keyword">As</span> <span class="token keyword">Boolean</span>
    <span class="token keyword">Dim</span> file_path$<span class="token punctuation">,</span> save_path$<span class="token punctuation">,</span> title_row<span class="token operator">&amp;</span><span class="token punctuation">,</span> end_row<span class="token operator">&amp;</span><span class="token punctuation">,</span> save_file$<span class="token punctuation">,</span> s$<span class="token punctuation">,</span> wb <span class="token keyword">As</span> Workbook
    <span class="token keyword">Dim</span> write_row<span class="token operator">&amp;</span><span class="token punctuation">,</span> sht_row<span class="token operator">&amp;</span><span class="token punctuation">,</span> sht_col<span class="token operator">&amp;</span><span class="token punctuation">,</span> copy_row<span class="token operator">&amp;</span><span class="token punctuation">,</span> p<span class="token punctuation">,</span> f<span class="token punctuation">,</span> temp<span class="token punctuation">,</span> r<span class="token operator">&amp;</span><span class="token punctuation">,</span> write_wb <span class="token keyword">As</span> Workbook
<span class="token comment">'--------------------参数填写：title_row，数字，第1行为1向下递增；end_row，数字</span>
    title_row <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">:</span> end_row <span class="token operator">=</span> <span class="token number">0</span>  <span class="token comment">'表头、表尾行数，不参与合并</span>
    file_path <span class="token operator">=</span> <span class="token string">"E:\测试\拆分表\合并工作簿7\"</span>  <span class="token comment">'file_path待合并的子文件夹所在文件夹</span>
    save_path <span class="token operator">=</span> file_path <span class="token operator">+</span> <span class="token string">"合并表\"</span>   <span class="token comment">'合并后的表格保存路径</span>
    only_value <span class="token operator">=</span> <span class="token keyword">True</span>  <span class="token comment">'仅粘贴为数值，是/否</span>
    old_name <span class="token operator">=</span> <span class="token keyword">True</span>    <span class="token comment">'写入原子文件夹名，是/否</span>
    Application.ScreenUpdating <span class="token operator">=</span> <span class="token keyword">False</span>  <span class="token comment">'关闭屏幕更新，加快程序运行</span>
    Application.DisplayAlerts <span class="token operator">=</span> <span class="token keyword">False</span>   <span class="token comment">'不显示警告信息</span>
    <span class="token keyword">Set</span> dict <span class="token operator">=</span> CreateObject<span class="token punctuation">(</span><span class="token string">"scripting.dictionary"</span><span class="token punctuation">)</span><span class="token punctuation">:</span> delimiter <span class="token operator">=</span> <span class="token function">Chr</span><span class="token punctuation">(</span><span class="token number">28</span><span class="token punctuation">)</span>
    <span class="token keyword">Set</span> fso <span class="token operator">=</span> CreateObject<span class="token punctuation">(</span><span class="token string">"Scripting.FileSystemObject"</span><span class="token punctuation">)</span><span class="token punctuation">:</span> tm <span class="token operator">=</span> <span class="token keyword">Timer</span>
    <span class="token keyword">If</span> fso.FolderExists<span class="token punctuation">(</span>save_path<span class="token punctuation">)</span> <span class="token keyword">Then</span> <span class="token function">Debug</span>.<span class="token function">Print</span> <span class="token string">"保存文件夹已存在，会导致错误，请删除"</span><span class="token punctuation">:</span> <span class="token keyword">Exit</span> <span class="token keyword">Sub</span>
    <span class="token keyword">For Each</span> f <span class="token keyword">In</span> fso.GetFolder<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span>.SubFolders  <span class="token comment">'获取所有子文件夹名</span>
        s <span class="token operator">=</span> s <span class="token operator">&amp;</span> delimiter <span class="token operator">&amp;</span> f.<span class="token keyword">Name</span>
    <span class="token keyword">Next</span>
    fd <span class="token operator">=</span> Split<span class="token punctuation">(</span><span class="token function">Mid</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> delimiter<span class="token punctuation">)</span>
    <span class="token keyword">If</span> <span class="token keyword">Not</span> fso.FolderExists<span class="token punctuation">(</span>save_path<span class="token punctuation">)</span> <span class="token keyword">Then</span> fso.CreateFolder <span class="token punctuation">(</span>save_path<span class="token punctuation">)</span>  <span class="token comment">'创建文件夹</span>
    <span class="token keyword">For Each</span> p <span class="token keyword">In</span> fd
        <span class="token keyword">For Each</span> f <span class="token keyword">In</span> fso.GetFolder<span class="token punctuation">(</span>file_path <span class="token operator">&amp;</span> p<span class="token punctuation">)</span>.<span class="token keyword">Files</span>  <span class="token comment">'空文件夹不影响</span>
            <span class="token keyword">If</span> f.<span class="token keyword">Name</span> <span class="token keyword">Like</span> <span class="token string">"*.xls*"</span> <span class="token keyword">Then</span>
                <span class="token keyword">Set</span> wb <span class="token operator">=</span> Workbooks.<span class="token keyword">Open</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span>
                s <span class="token operator">=</span> fso.GetBaseName<span class="token punctuation">(</span>f.<span class="token keyword">Name</span><span class="token punctuation">)</span>  <span class="token comment">'工作簿文件名，不带扩展名</span>
                <span class="token keyword">If</span> <span class="token keyword">Not</span> dict.Exists<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token keyword">Then</span>   <span class="token comment">'工作簿不存在的，直接复制整个工作簿</span>
                    <span class="token keyword">Set</span> dict<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">=</span> CreateObject<span class="token punctuation">(</span><span class="token string">"scripting.dictionary"</span><span class="token punctuation">)</span>
                    wb.Worksheets.Copy
                    <span class="token keyword">For Each</span> sht <span class="token keyword">In</span> ActiveWorkbook.Worksheets
                        dict<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">(</span>sht.<span class="token keyword">Name</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">:</span> temp <span class="token operator">=</span> sht.UsedRange.Value
                        sht.Columns<span class="token punctuation">(</span><span class="token string">"a:a"</span><span class="token punctuation">)</span>.Insert<span class="token punctuation">:</span> sht.[a1] <span class="token operator">=</span> <span class="token string">"子文件夹"</span>  <span class="token comment">'插入列</span>
                        <span class="token keyword">If</span> end_row <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">Then</span>  <span class="token comment">'删除表尾行</span>
                            r <span class="token operator">=</span> sht.UsedRange.Rows.Count
                            sht.Cells<span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>.Offset<span class="token punctuation">(</span><span class="token operator">-</span>end_row <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>.Resize<span class="token punctuation">(</span>end_row<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>.EntireRow.<span class="token function">Delete</span>
                        <span class="token keyword">End</span> <span class="token keyword">If</span>
                        sht.Cells<span class="token punctuation">(</span>title_row <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>.Resize<span class="token punctuation">(</span>sht.UsedRange.Rows.Count <span class="token operator">-</span> title_row<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> p
                        <span class="token keyword">If</span> only_value <span class="token keyword">Then</span> sht.[b1].Resize<span class="token punctuation">(</span><span class="token function">UBound</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span> <span class="token operator">-</span> end_row<span class="token punctuation">,</span> <span class="token function">UBound</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> temp
                    <span class="token keyword">Next</span>
                    wb.<span class="token keyword">Close</span> <span class="token punctuation">(</span><span class="token keyword">False</span><span class="token punctuation">)</span>
                    save_file <span class="token operator">=</span> save_path <span class="token operator">&amp;</span> s <span class="token operator">&amp;</span> <span class="token string">"_合并表.xlsx"</span>  <span class="token comment">'保存文件，无发打开2个同名文件，故加标识</span>
                    ActiveWorkbook.SaveAs filename<span class="token punctuation">:</span><span class="token operator">=</span>save_file
                    ActiveWorkbook.<span class="token keyword">Close</span> <span class="token punctuation">(</span><span class="token keyword">False</span><span class="token punctuation">)</span>
                <span class="token keyword">Else</span>
                    <span class="token keyword">Set</span> write_wb <span class="token operator">=</span> Workbooks.<span class="token keyword">Open</span><span class="token punctuation">(</span>save_path <span class="token operator">&amp;</span> s <span class="token operator">&amp;</span> <span class="token string">"_合并表.xlsx"</span><span class="token punctuation">)</span>
                    <span class="token keyword">For Each</span> sht <span class="token keyword">In</span> wb.Worksheets
                        <span class="token keyword">If</span> <span class="token keyword">Not</span> dict<span class="token punctuation">(</span>s<span class="token punctuation">)</span>.Exists<span class="token punctuation">(</span>sht.<span class="token keyword">Name</span><span class="token punctuation">)</span> <span class="token keyword">Then</span>  <span class="token comment">'工作表不存在，直接复制</span>
                            sht.Copy After<span class="token punctuation">:</span><span class="token operator">=</span>write_wb.Sheets<span class="token punctuation">(</span>write_wb.Sheets.Count<span class="token punctuation">)</span>
                            dict<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">(</span>sht.<span class="token keyword">Name</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">:</span> temp <span class="token operator">=</span> sht.UsedRange.Value
                            <span class="token keyword">With</span> write_wb.Worksheets<span class="token punctuation">(</span>sht.<span class="token keyword">Name</span><span class="token punctuation">)</span>
                                .Columns<span class="token punctuation">(</span><span class="token string">"a:a"</span><span class="token punctuation">)</span>.Insert<span class="token punctuation">:</span> .[a1] <span class="token operator">=</span> <span class="token string">"子文件夹"</span>  <span class="token comment">'插入列</span>
                                <span class="token keyword">If</span> end_row <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">Then</span>  <span class="token comment">'删除表尾行</span>
                                    r <span class="token operator">=</span> .UsedRange.Rows.Count
                                    .Cells<span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>.Offset<span class="token punctuation">(</span><span class="token operator">-</span>end_row <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>.Resize<span class="token punctuation">(</span>end_row<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>.EntireRow.<span class="token function">Delete</span>
                                <span class="token keyword">End</span> <span class="token keyword">If</span>
                                .Cells<span class="token punctuation">(</span>title_row <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>.Resize<span class="token punctuation">(</span>.UsedRange.Rows.Count <span class="token operator">-</span> title_row<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> p
                                <span class="token keyword">If</span> only_value <span class="token keyword">Then</span> .[b1].Resize<span class="token punctuation">(</span><span class="token function">UBound</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span> <span class="token operator">-</span> end_row<span class="token punctuation">,</span> <span class="token function">UBound</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> temp
                            <span class="token keyword">End</span> <span class="token keyword">With</span>
                        <span class="token keyword">Else</span>
                            <span class="token keyword">With</span> write_wb.Worksheets<span class="token punctuation">(</span>sht.<span class="token keyword">Name</span><span class="token punctuation">)</span>
                                write_row <span class="token operator">=</span> .UsedRange.Rows.Count <span class="token operator">+</span> <span class="token number">1</span>  <span class="token comment">'合并工作表的第一个空行写入</span>
                                sht_row <span class="token operator">=</span> sht.UsedRange.Rows.Count<span class="token punctuation">:</span> sht_col <span class="token operator">=</span> sht.UsedRange.Columns.Count
                                copy_row <span class="token operator">=</span> sht_row <span class="token operator">-</span> title_row <span class="token operator">-</span> end_row  <span class="token comment">'复制行数</span>
                                temp <span class="token operator">=</span> sht.Cells<span class="token punctuation">(</span>title_row <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">)</span>.Resize<span class="token punctuation">(</span>copy_row<span class="token punctuation">,</span> sht_col<span class="token punctuation">)</span>.Value
                                sht.Cells<span class="token punctuation">(</span>title_row <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">)</span>.Resize<span class="token punctuation">(</span>copy_row<span class="token punctuation">,</span> sht_col<span class="token punctuation">)</span>.Copy .Cells<span class="token punctuation">(</span>write_row<span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">)</span>
                                <span class="token keyword">If</span> only_value <span class="token keyword">Then</span> .Cells<span class="token punctuation">(</span>write_row<span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">)</span>.Resize<span class="token punctuation">(</span>copy_row<span class="token punctuation">,</span> sht_col<span class="token punctuation">)</span> <span class="token operator">=</span> temp
                                .Cells<span class="token punctuation">(</span>write_row<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>.Resize<span class="token punctuation">(</span>copy_row<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> p
                            <span class="token keyword">End</span> <span class="token keyword">With</span>
                        <span class="token keyword">End</span> <span class="token keyword">If</span>
                    <span class="token keyword">Next</span>
                    wb.<span class="token keyword">Close</span> <span class="token punctuation">(</span><span class="token keyword">False</span><span class="token punctuation">)</span>
                    write_wb.<span class="token keyword">Close</span> <span class="token punctuation">(</span><span class="token keyword">True</span><span class="token punctuation">)</span>  <span class="token comment">'保存并关闭</span>
                <span class="token keyword">End</span> <span class="token keyword">If</span>
            <span class="token keyword">End</span> <span class="token keyword">If</span>
        <span class="token keyword">Next</span>
    <span class="token keyword">Next</span>
    <span class="token keyword">If</span> <span class="token keyword">Not</span> old_name <span class="token keyword">Then</span>  <span class="token comment">'无需写入原子文件夹名</span>
        <span class="token keyword">For Each</span> f <span class="token keyword">In</span> fso.GetFolder<span class="token punctuation">(</span>save_path<span class="token punctuation">)</span>.<span class="token keyword">Files</span>
            <span class="token keyword">Set</span> write_wb <span class="token operator">=</span> Workbooks.<span class="token keyword">Open</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span>
            <span class="token keyword">For Each</span> sht <span class="token keyword">In</span> write_wb.Worksheets
                sht.Columns<span class="token punctuation">(</span><span class="token string">"a:a"</span><span class="token punctuation">)</span>.<span class="token function">Delete</span>
            <span class="token keyword">Next</span>
            write_wb.<span class="token keyword">Close</span> <span class="token punctuation">(</span><span class="token keyword">True</span><span class="token punctuation">)</span>
        <span class="token keyword">Next</span>
    <span class="token keyword">End</span> <span class="token keyword">If</span>
    <span class="token keyword">For Each</span> f <span class="token keyword">In</span> fso.GetFolder<span class="token punctuation">(</span>save_path<span class="token punctuation">)</span>.<span class="token keyword">Files</span>
        f.<span class="token keyword">Name</span> <span class="token operator">=</span> Replace<span class="token punctuation">(</span>f.<span class="token keyword">Name</span><span class="token punctuation">,</span> <span class="token string">"_合并表"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>  <span class="token comment">'合并文件名删除标识</span>
    <span class="token keyword">Next</span>
    Application.ScreenUpdating <span class="token operator">=</span> <span class="token keyword">True</span><span class="token punctuation">:</span> Application.DisplayAlerts <span class="token operator">=</span> <span class="token keyword">True</span>
    <span class="token function">Debug</span>.<span class="token function">Print</span> <span class="token string">"文件夹合并完成，用时："</span> <span class="token operator">&amp;</span> Format<span class="token punctuation">(</span><span class="token keyword">Timer</span> <span class="token operator">-</span> tm<span class="token punctuation">,</span> <span class="token string">"0.00"</span><span class="token punctuation">)</span>
<span class="token keyword">End</span> <span class="token keyword">Sub</span>
</code></pre> 
<h4><a id="722_651"></a>7.2，实现方法2</h4> 
<p>采用每次遍历1个工作簿时，如果是之前从未遍历过的工作簿名称时，直接循环遍历其他子文件夹中的同名工作簿；同时，按子文件夹顺序，依次遍历子文件夹中所有工作簿，确保所有工作簿都被遍历。因为减少了合并工作簿反复打开、保存、关闭的操作，所以速度较实现方法1稍快</p> 
<pre><code class="prism language-vbnet"><span class="token keyword">Sub</span> 合并子文件夹同名工作簿中同名工作表_纵向汇总数据<span class="token number">2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">'最终合并文件sheet以工作簿名命名，适用工作表格式相同；合并文件A列显示原子文件夹名</span>
    <span class="token keyword">Dim</span> dict <span class="token keyword">As</span> <span class="token keyword">Object</span><span class="token punctuation">,</span> sht <span class="token keyword">As</span> Worksheet<span class="token punctuation">,</span> fso <span class="token keyword">As</span> <span class="token keyword">Object</span><span class="token punctuation">,</span> only_value <span class="token keyword">As</span> <span class="token keyword">Boolean</span><span class="token punctuation">,</span> old_name <span class="token keyword">As</span> <span class="token keyword">Boolean</span>
    <span class="token keyword">Dim</span> file_path$<span class="token punctuation">,</span> save_path$<span class="token punctuation">,</span> title_row<span class="token operator">&amp;</span><span class="token punctuation">,</span> end_row<span class="token operator">&amp;</span><span class="token punctuation">,</span> save_file$<span class="token punctuation">,</span> s$<span class="token punctuation">,</span> wb <span class="token keyword">As</span> Workbook
    <span class="token keyword">Dim</span> write_row<span class="token operator">&amp;</span><span class="token punctuation">,</span> sht_row<span class="token operator">&amp;</span><span class="token punctuation">,</span> sht_col<span class="token operator">&amp;</span><span class="token punctuation">,</span> copy_row<span class="token operator">&amp;</span><span class="token punctuation">,</span> p<span class="token punctuation">,</span> f<span class="token punctuation">,</span> temp<span class="token punctuation">,</span> r<span class="token operator">&amp;</span><span class="token punctuation">,</span> pp<span class="token punctuation">,</span> ff
<span class="token comment">'--------------------参数填写：title_row，数字，第1行为1向下递增；end_row，数字</span>
    title_row <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">:</span> end_row <span class="token operator">=</span> <span class="token number">0</span>  <span class="token comment">'表头、表尾行数，不参与合并</span>
    file_path <span class="token operator">=</span> <span class="token string">"E:\测试\拆分表\合并工作簿7\"</span>  <span class="token comment">'file_path待合并的子文件夹所在文件夹</span>
    save_path <span class="token operator">=</span> file_path <span class="token operator">+</span> <span class="token string">"合并表\"</span>   <span class="token comment">'合并后的表格保存路径</span>
    only_value <span class="token operator">=</span> <span class="token keyword">True</span>  <span class="token comment">'仅粘贴为数值，是/否</span>
    old_name <span class="token operator">=</span> <span class="token keyword">True</span>    <span class="token comment">'写入原子文件夹名，是/否</span>
    Application.ScreenUpdating <span class="token operator">=</span> <span class="token keyword">False</span>  <span class="token comment">'关闭屏幕更新，加快程序运行</span>
    Application.DisplayAlerts <span class="token operator">=</span> <span class="token keyword">False</span>   <span class="token comment">'不显示警告信息</span>
    <span class="token keyword">Dim</span> pn_dict <span class="token keyword">As</span> <span class="token keyword">Object</span><span class="token punctuation">:</span> <span class="token keyword">Set</span> pn_dict <span class="token operator">=</span> CreateObject<span class="token punctuation">(</span><span class="token string">"scripting.dictionary"</span><span class="token punctuation">)</span>  <span class="token comment">'记录已遍历文件名</span>
    <span class="token keyword">Set</span> dict <span class="token operator">=</span> CreateObject<span class="token punctuation">(</span><span class="token string">"scripting.dictionary"</span><span class="token punctuation">)</span><span class="token punctuation">:</span> delimiter <span class="token operator">=</span> <span class="token function">Chr</span><span class="token punctuation">(</span><span class="token number">28</span><span class="token punctuation">)</span>
    <span class="token keyword">Set</span> fso <span class="token operator">=</span> CreateObject<span class="token punctuation">(</span><span class="token string">"Scripting.FileSystemObject"</span><span class="token punctuation">)</span><span class="token punctuation">:</span> tm <span class="token operator">=</span> <span class="token keyword">Timer</span>
    <span class="token keyword">If</span> fso.FolderExists<span class="token punctuation">(</span>save_path<span class="token punctuation">)</span> <span class="token keyword">Then</span> <span class="token function">Debug</span>.<span class="token function">Print</span> <span class="token string">"保存文件夹已存在，会导致错误，请删除"</span><span class="token punctuation">:</span> <span class="token keyword">Exit</span> <span class="token keyword">Sub</span>
    <span class="token keyword">For Each</span> f <span class="token keyword">In</span> fso.GetFolder<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span>.SubFolders  <span class="token comment">'获取所有子文件夹名</span>
        s <span class="token operator">=</span> s <span class="token operator">&amp;</span> delimiter <span class="token operator">&amp;</span> f.<span class="token keyword">Name</span>
    <span class="token keyword">Next</span>
    fd <span class="token operator">=</span> Split<span class="token punctuation">(</span><span class="token function">Mid</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> delimiter<span class="token punctuation">)</span>
    <span class="token keyword">If</span> <span class="token keyword">Not</span> fso.FolderExists<span class="token punctuation">(</span>save_path<span class="token punctuation">)</span> <span class="token keyword">Then</span> fso.CreateFolder <span class="token punctuation">(</span>save_path<span class="token punctuation">)</span>  <span class="token comment">'创建文件夹</span>
    <span class="token keyword">For Each</span> p <span class="token keyword">In</span> fd
        <span class="token keyword">For Each</span> f <span class="token keyword">In</span> fso.GetFolder<span class="token punctuation">(</span>file_path <span class="token operator">&amp;</span> p<span class="token punctuation">)</span>.<span class="token keyword">Files</span>  <span class="token comment">'空文件夹不影响</span>
            <span class="token keyword">If</span> f.<span class="token keyword">Name</span> <span class="token keyword">Like</span> <span class="token string">"*.xls*"</span> <span class="token keyword">Then</span>
                pn <span class="token operator">=</span> p <span class="token operator">&amp;</span> <span class="token string">"\"</span> <span class="token operator">&amp;</span> f.<span class="token keyword">Name</span><span class="token punctuation">:</span> s <span class="token operator">=</span> fso.GetBaseName<span class="token punctuation">(</span>f.<span class="token keyword">Name</span><span class="token punctuation">)</span>  <span class="token comment">'s工作簿文件名，不带扩展名</span>
                <span class="token keyword">If</span> <span class="token keyword">Not</span> pn_dict.Exists<span class="token punctuation">(</span>pn<span class="token punctuation">)</span> <span class="token keyword">Then</span>  <span class="token comment">'未遍历</span>
                    <span class="token keyword">Set</span> wb <span class="token operator">=</span> Workbooks.<span class="token keyword">Open</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">:</span> pn_dict<span class="token punctuation">(</span>pn<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">""</span>
                    <span class="token keyword">Set</span> dict<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">=</span> CreateObject<span class="token punctuation">(</span><span class="token string">"scripting.dictionary"</span><span class="token punctuation">)</span>
                    wb.Worksheets.Copy   <span class="token comment">'工作簿不存在的，直接复制整个工作簿</span>
                    <span class="token keyword">With</span> ActiveWorkbook  <span class="token comment">'复制后的工作簿，合并表</span>
                        <span class="token keyword">For Each</span> sht <span class="token keyword">In</span> .Worksheets
                            dict<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">(</span>sht.<span class="token keyword">Name</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">:</span> temp <span class="token operator">=</span> sht.UsedRange.Value
                            sht.Columns<span class="token punctuation">(</span><span class="token string">"a:a"</span><span class="token punctuation">)</span>.Insert<span class="token punctuation">:</span> sht.[a1] <span class="token operator">=</span> <span class="token string">"子文件夹"</span>  <span class="token comment">'插入列</span>
                            <span class="token keyword">If</span> end_row <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">Then</span>  <span class="token comment">'删除表尾行</span>
                                r <span class="token operator">=</span> sht.UsedRange.Rows.Count
                                sht.Cells<span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>.Offset<span class="token punctuation">(</span><span class="token operator">-</span>end_row <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>.Resize<span class="token punctuation">(</span>end_row<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>.EntireRow.<span class="token function">Delete</span>
                            <span class="token keyword">End</span> <span class="token keyword">If</span>
                            sht.Cells<span class="token punctuation">(</span>title_row <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>.Resize<span class="token punctuation">(</span>sht.UsedRange.Rows.Count <span class="token operator">-</span> title_row<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> p
                            <span class="token keyword">If</span> only_value <span class="token keyword">Then</span> sht.[b1].Resize<span class="token punctuation">(</span><span class="token function">UBound</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span> <span class="token operator">-</span> end_row<span class="token punctuation">,</span> <span class="token function">UBound</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> temp
                        <span class="token keyword">Next</span>
                        wb.<span class="token keyword">Close</span> <span class="token punctuation">(</span><span class="token keyword">False</span><span class="token punctuation">)</span>
                        <span class="token keyword">For Each</span> pp <span class="token keyword">In</span> fd  <span class="token comment">'遍历所有子文件夹同名工作簿</span>
                            <span class="token keyword">For Each</span> ff <span class="token keyword">In</span> fso.GetFolder<span class="token punctuation">(</span>file_path <span class="token operator">&amp;</span> pp<span class="token punctuation">)</span>.<span class="token keyword">Files</span>
                                <span class="token keyword">If</span> ff.<span class="token keyword">Name</span> <span class="token keyword">Like</span> s <span class="token operator">&amp;</span> <span class="token string">".xls*"</span> <span class="token keyword">Then</span>
                                    pn <span class="token operator">=</span> pp <span class="token operator">&amp;</span> <span class="token string">"\"</span> <span class="token operator">&amp;</span> ff.<span class="token keyword">Name</span>
                                    <span class="token keyword">If</span> <span class="token keyword">Not</span> pn_dict.Exists<span class="token punctuation">(</span>pn<span class="token punctuation">)</span> <span class="token keyword">Then</span>  <span class="token comment">'未遍历</span>
                                        <span class="token keyword">Set</span> wb <span class="token operator">=</span> Workbooks.<span class="token keyword">Open</span><span class="token punctuation">(</span>ff<span class="token punctuation">)</span><span class="token punctuation">:</span> pn_dict<span class="token punctuation">(</span>pn<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">""</span>
                                        <span class="token keyword">For Each</span> sht <span class="token keyword">In</span> wb.Worksheets
                                            <span class="token keyword">If</span> <span class="token keyword">Not</span> dict<span class="token punctuation">(</span>s<span class="token punctuation">)</span>.Exists<span class="token punctuation">(</span>sht.<span class="token keyword">Name</span><span class="token punctuation">)</span> <span class="token keyword">Then</span>  <span class="token comment">'工作表不存在，直接复制</span>
                                                sht.Copy After<span class="token punctuation">:</span><span class="token operator">=</span>.Sheets<span class="token punctuation">(</span>.Sheets.Count<span class="token punctuation">)</span>
                                                dict<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">(</span>sht.<span class="token keyword">Name</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">:</span> temp <span class="token operator">=</span> sht.UsedRange.Value
                                                <span class="token keyword">With</span> .Worksheets<span class="token punctuation">(</span>sht.<span class="token keyword">Name</span><span class="token punctuation">)</span>
                                                    .Columns<span class="token punctuation">(</span><span class="token string">"a:a"</span><span class="token punctuation">)</span>.Insert<span class="token punctuation">:</span> .[a1] <span class="token operator">=</span> <span class="token string">"子文件夹"</span>  <span class="token comment">'插入列</span>
                                                    <span class="token keyword">If</span> end_row <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">Then</span>  <span class="token comment">'删除表尾行</span>
                                                        r <span class="token operator">=</span> .UsedRange.Rows.Count
                                                        .Cells<span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>.Offset<span class="token punctuation">(</span><span class="token operator">-</span>end_row <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>.Resize<span class="token punctuation">(</span>end_row<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>.EntireRow.<span class="token function">Delete</span>
                                                    <span class="token keyword">End</span> <span class="token keyword">If</span>
                                                    .Cells<span class="token punctuation">(</span>title_row <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>.Resize<span class="token punctuation">(</span>.UsedRange.Rows.Count <span class="token operator">-</span> title_row<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> pp
                                                    <span class="token keyword">If</span> only_value <span class="token keyword">Then</span> .[b1].Resize<span class="token punctuation">(</span><span class="token function">UBound</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span> <span class="token operator">-</span> end_row<span class="token punctuation">,</span> <span class="token function">UBound</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> temp
                                                <span class="token keyword">End</span> <span class="token keyword">With</span>
                                            <span class="token keyword">Else</span>
                                                <span class="token keyword">With</span> .Worksheets<span class="token punctuation">(</span>sht.<span class="token keyword">Name</span><span class="token punctuation">)</span>
                                                    write_row <span class="token operator">=</span> .UsedRange.Rows.Count <span class="token operator">+</span> <span class="token number">1</span>  <span class="token comment">'合并工作表的第一个空行写入</span>
                                                    sht_row <span class="token operator">=</span> sht.UsedRange.Rows.Count<span class="token punctuation">:</span> sht_col <span class="token operator">=</span> sht.UsedRange.Columns.Count
                                                    copy_row <span class="token operator">=</span> sht_row <span class="token operator">-</span> title_row <span class="token operator">-</span> end_row  <span class="token comment">'复制行数</span>
                                                    temp <span class="token operator">=</span> sht.Cells<span class="token punctuation">(</span>title_row <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">)</span>.Resize<span class="token punctuation">(</span>copy_row<span class="token punctuation">,</span> sht_col<span class="token punctuation">)</span>.Value
                                                    sht.Cells<span class="token punctuation">(</span>title_row <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">)</span>.Resize<span class="token punctuation">(</span>copy_row<span class="token punctuation">,</span> sht_col<span class="token punctuation">)</span>.Copy .Cells<span class="token punctuation">(</span>write_row<span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">)</span>
                                                    <span class="token keyword">If</span> only_value <span class="token keyword">Then</span> .Cells<span class="token punctuation">(</span>write_row<span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">)</span>.Resize<span class="token punctuation">(</span>copy_row<span class="token punctuation">,</span> sht_col<span class="token punctuation">)</span> <span class="token operator">=</span> temp
                                                    .Cells<span class="token punctuation">(</span>write_row<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>.Resize<span class="token punctuation">(</span>copy_row<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> pp
                                                <span class="token keyword">End</span> <span class="token keyword">With</span>
                                            <span class="token keyword">End</span> <span class="token keyword">If</span>
                                        <span class="token keyword">Next</span>
                                        wb.<span class="token keyword">Close</span> <span class="token punctuation">(</span><span class="token keyword">False</span><span class="token punctuation">)</span>
                                    <span class="token keyword">End</span> <span class="token keyword">If</span>
                                <span class="token keyword">End</span> <span class="token keyword">If</span>
                            <span class="token keyword">Next</span>
                        <span class="token keyword">Next</span>
                        <span class="token keyword">If</span> <span class="token keyword">Not</span> old_name <span class="token keyword">Then</span>  <span class="token comment">'无需写入原子文件夹名</span>
                            <span class="token keyword">For Each</span> sht <span class="token keyword">In</span> .Worksheets
                                sht.Columns<span class="token punctuation">(</span><span class="token string">"a:a"</span><span class="token punctuation">)</span>.<span class="token function">Delete</span>
                            <span class="token keyword">Next</span>
                        <span class="token keyword">End</span> <span class="token keyword">If</span>
                        .SaveAs filename<span class="token punctuation">:</span><span class="token operator">=</span>save_path <span class="token operator">&amp;</span> s <span class="token operator">&amp;</span> <span class="token string">".xlsx"</span>
                        .<span class="token keyword">Close</span> <span class="token punctuation">(</span><span class="token keyword">False</span><span class="token punctuation">)</span>
                    <span class="token keyword">End</span> <span class="token keyword">With</span>
                <span class="token keyword">End</span> <span class="token keyword">If</span>
            <span class="token keyword">End</span> <span class="token keyword">If</span>
        <span class="token keyword">Next</span>
    <span class="token keyword">Next</span>
    Application.ScreenUpdating <span class="token operator">=</span> <span class="token keyword">True</span><span class="token punctuation">:</span> Application.DisplayAlerts <span class="token operator">=</span> <span class="token keyword">True</span>
    <span class="token function">Debug</span>.<span class="token function">Print</span> <span class="token string">"文件夹合并完成，用时："</span> <span class="token operator">&amp;</span> Format<span class="token punctuation">(</span><span class="token keyword">Timer</span> <span class="token operator">-</span> tm<span class="token punctuation">,</span> <span class="token string">"0.00"</span><span class="token punctuation">)</span>
<span class="token keyword">End</span> <span class="token keyword">Sub</span>
</code></pre> 
<h4><a id="2_749"></a>举例，2种实现方法对比</h4> 
<p>合并<a href="#page_jump" rel="nofollow">4.1-举例</a>中同样的数据，但是所有5个工作簿都放入12个文件夹中，文件夹依次命名为“1月-12月”<br> <img src="https://images2.imgbox.com/04/0c/OQlZGhs6_o.jpg" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/24/04/RQrcpvg0_o.jpg" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/71/03/HGyg35Ku_o.jpg" alt="在这里插入图片描述"><br> 需要合并的数据共有，60个工作簿180个工作表<br> 合并参数：title_row = 1，end_row = 0，合并后<br> <img src="https://images2.imgbox.com/79/b6/s6Dmm5vx_o.jpg" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/a8/e8/17G64ezU_o.jpg" alt="在这里插入图片描述"><br> <strong>2种实现方法代码运行速度对比：</strong> 60个工作簿180个工作表<br> 方法1多次运行，用时在40-60秒之间<br> 方法2多次运行，用时在22.5-29秒之间<br> 2种实现方法生成的合并工作簿结果完全一致，但方法2速度更快。在代码行数差不多的情况下，不同的遍历方式对运行速度的影响较大</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/57e59a98d48f87b45e36db5487dc7b85/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">虚谷数据库定时任务的dbms_scheduler使用方法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d27b3aead0bbf2469c8d5f4693971e64/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">2023年原力计划第五季到期提醒</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>