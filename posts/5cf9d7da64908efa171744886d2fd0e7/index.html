<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>迈创采集卡搭配工业相机二次开发介绍（一） - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="迈创采集卡搭配工业相机二次开发介绍（一）" />
<meta property="og:description" content="迈创采集卡搭配工业相机二次开发介绍（一）SDK简介 迈创采集卡介绍迈创采集卡SDK简介MIL SDK获取路径 接口函数说明MIL接口简单介绍 迈创采集卡介绍 MIL全称为Matrox Imaging Library，由加拿大Matrox公司开发；MIL软件包是一个独立于硬件的、含有多个标准模块或组件的图像库，可以对图像进行采集、处理、分析、显示和存取操作，其功能覆盖图像领域的所有方面，使用起来也相当简单和方便；
MIL-Lite是MIL的子集,含有MIL的部分模块，可以进行图像的采集、显示、存取操作，还可以在图像上进行图形操作及LUT变换等；
MIL/MIL-Lite支持Matrox公司所有采集卡，如果应用程序采用其它公司的采集卡，则不能使用MIL/MIL-Lite的采集功能，但应用程序可以使用MIL/MIL-Lite的其它功能。
在工作中呢，主要接触到迈创的cameralink采集卡、coxpress采集卡，型号例如：CML；solios系列的的SOL 2M EV CLF、SOL 6M CLB E,CXP:rapixo的RAP 4G 4C6 、RAP 4G 4C12
虽然采集卡型号多，但是mil二次开发的基本思路是一样的
迈创采集卡SDK简介 首先，要理解MIL中的五大基本对象，如下图：
Application：用户开发的一个应用程序，一般应用程序同一时刻只存在一个Application对象。主要用它来提供一个用于控制和执行MIL应用程序的基本环境
System：System代表为一个包含CPU或GPU、内存或显存和图像控制器的单元分配的一个虚拟访问对象，例如一张Matrox采集卡、一台工控机都可以被分配为一个System。System能够通过加上相机和显示器来采集、保存和显示。每个Application下可以包含多个System，这就好比一台电脑可以插上多块Matrox采集卡
Display：Display对应显示。所有和显示的操作都是靠它来完成。这个在手册中提到了两种Display：一种是MIL内建的用于演示的Display叫Auxiliary Display，它不适用于Windows Desktop，主要用于和Matrox显卡配套使用的Screen，一般用不上，不予讨论；另一种是叫Windowed Display，其中一种是MIL用于演示的Display，不需要选择要显示的窗口句柄，默认分配的Display对象是此种display，另一种是用户选择要显示的窗口句柄，这个需要你自己选择在哪个windows窗体上显示对应的Buffer图像内容
Digitizer：Digitizer对应取图。它用于图像的采集和相机属性的调整等，和取图有关的操作都是靠它来完成。
Buffer：Buffer对应一块内存，可以对它赋予不同的属性用来对图像作相应处理，如存储、显示、采集、处理，只有赋予了对应的属性的Buffer才能用于对应操作，只赋予了保存属性的Buffer是不能用于显示的。
了解了这个5个基本概念有什么用呢，对于做工业相机二次开发来讲，很重要，它们决定了你代码开发的顺序与逻辑
MIL SDK获取路径 1、安装MIL客户端，目前MIL已经更新到MIL10、MILX 版本，搭配其最新的采集卡
2、安装完mil后,打开Matrox Imaging Library，即可找到sdk例程与帮助文档
3、结合工业相机，常用的两个例程试MdigGrab与MdigProcess两个，参考这两个例程即可
接口函数说明 mil与工业相机取流过程，主要分为三个步骤
MIL初始化，初始化app、systerm、digitizer、buffer等资源、初始化相机参数MIL取流，使用取流函数，获取图像，使用相机控制函数，控制相机出图节拍MIL资源释放，释放app、systerm、digitizer、buffer等资源 MIL接口简单介绍 MIL的初始化与资源释放需要严格按照顺序进行
1、初始化定义mil的各种变量
MIL_ID MilApplication, /* Application identifier. */ MilSystem, /* System identifier. */ MilDisplay, /* Display identifier. */ MilDigitizer, /* Digitizer identifier. */ MilImage; /* Image buffer identifier." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/5cf9d7da64908efa171744886d2fd0e7/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-07-30T11:18:39+08:00" />
<meta property="article:modified_time" content="2021-07-30T11:18:39+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">迈创采集卡搭配工业相机二次开发介绍（一）</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>迈创采集卡搭配工业相机二次开发介绍（一）SDK简介</h4> 
 <ul><li><a href="#_1" rel="nofollow">迈创采集卡介绍</a></li><li><ul><li><a href="#SDK_7" rel="nofollow">迈创采集卡SDK简介</a></li><li><ul><li><a href="#MIL_SDK_22" rel="nofollow">MIL SDK获取路径</a></li></ul> 
   </li><li><a href="#_28" rel="nofollow">接口函数说明</a></li><li><ul><li><a href="#MIL_36" rel="nofollow">MIL接口简单介绍</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>迈创采集卡介绍</h2> 
<p>MIL全称为Matrox Imaging Library，由加拿大Matrox公司开发；MIL软件包是一个独立于硬件的、含有多个标准模块或组件的图像库，可以对图像进行采集、处理、分析、显示和存取操作，其功能覆盖图像领域的所有方面，使用起来也相当简单和方便；<br> MIL-Lite是MIL的子集,含有MIL的部分模块，可以进行图像的采集、显示、存取操作，还可以在图像上进行图形操作及LUT变换等；<br> MIL/MIL-Lite支持Matrox公司所有采集卡，如果应用程序采用其它公司的采集卡，则不能使用MIL/MIL-Lite的采集功能，但应用程序可以使用MIL/MIL-Lite的其它功能。<br> 在工作中呢，主要接触到迈创的cameralink采集卡、coxpress采集卡，型号例如：CML；solios系列的的SOL 2M EV CLF、SOL 6M CLB E,CXP:rapixo的RAP 4G 4C6 、RAP 4G 4C12<br> 虽然采集卡型号多，但是mil二次开发的基本思路是一样的</p> 
<h3><a id="SDK_7"></a>迈创采集卡SDK简介</h3> 
<p>首先，要理解MIL中的五大基本对象，如下图：<br> <img src="https://images2.imgbox.com/fe/26/nGusbwlJ_o.png" alt="在这里插入图片描述"><br> <strong>Application</strong>：用户开发的一个应用程序，一般应用程序同一时刻只存在一个Application对象。主要用它来提供一个用于控制和执行MIL应用程序的基本环境</p> 
<p><strong>System</strong>：System代表为一个包含CPU或GPU、内存或显存和图像控制器的单元分配的一个虚拟访问对象，例如<strong>一张Matrox采集卡</strong>、一台工控机都可以被分配为一个System。System能够通过加上相机和显示器来采集、保存和显示。<strong>每个Application下可以包含多个System，这就好比一台电脑可以插上多块Matrox采集卡</strong></p> 
<p><strong>Display</strong>：Display对应显示。所有和显示的操作都是靠它来完成。这个在手册中提到了两种Display：一种是MIL内建的用于演示的Display叫Auxiliary Display，它不适用于Windows Desktop，主要用于和Matrox显卡配套使用的Screen，一般用不上，不予讨论；另一种是叫Windowed Display，其中一种是MIL用于演示的Display，不需要选择要显示的窗口句柄，默认分配的Display对象是此种display，另一种是用户选择要显示的窗口句柄，这个需要你自己选择在哪个windows窗体上显示对应的Buffer图像内容</p> 
<p><strong>Digitizer</strong>：Digitizer对应取图。它用于图像的采集和相机属性的调整等，和取图有关的操作都是靠它来完成。</p> 
<p><strong>Buffer</strong>：Buffer对应一块内存，可以对它赋予不同的属性用来对图像作相应处理，如存储、显示、采集、处理，只有赋予了对应的属性的Buffer才能用于对应操作，只赋予了保存属性的Buffer是不能用于显示的。</p> 
<p>了解了这个5个基本概念有什么用呢，对于做工业相机二次开发来讲，很重要，它们决定了你代码开发的顺序与逻辑</p> 
<h4><a id="MIL_SDK_22"></a>MIL SDK获取路径</h4> 
<p>1、安装MIL客户端，目前MIL已经更新到MIL10、MILX 版本，搭配其最新的采集卡<br> 2、安装完mil后,打开Matrox Imaging Library，即可找到sdk例程与帮助文档<br> <img src="https://images2.imgbox.com/75/c5/mJ2xm5aQ_o.png" alt="在这里插入图片描述"><br> 3、结合工业相机，常用的两个例程试MdigGrab与MdigProcess两个，参考这两个例程即可<br> <img src="https://images2.imgbox.com/40/93/AJxlbNKI_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_28"></a>接口函数说明</h3> 
<p>mil与工业相机取流过程，主要分为三个步骤</p> 
<ul><li>MIL初始化，初始化app、systerm、digitizer、buffer等资源、初始化相机参数</li><li>MIL取流，使用取流函数，获取图像，使用相机控制函数，控制相机出图节拍</li><li>MIL资源释放，释放app、systerm、digitizer、buffer等资源</li><li><img src="https://images2.imgbox.com/cd/8a/DXgLK7Tf_o.png" alt="在这里插入图片描述"></li></ul> 
<h4><a id="MIL_36"></a>MIL接口简单介绍</h4> 
<p>MIL的初始化与资源释放需要严格按照顺序进行<br> 1、初始化定义mil的各种变量</p> 
<pre><code class="prism language-c">		MIL_ID MilApplication<span class="token punctuation">,</span>  <span class="token comment">/* Application identifier.  */</span>
		MilSystem<span class="token punctuation">,</span>       <span class="token comment">/* System identifier.       */</span>
		MilDisplay<span class="token punctuation">,</span>      <span class="token comment">/* Display identifier.      */</span>
		MilDigitizer<span class="token punctuation">,</span>    <span class="token comment">/* Digitizer identifier.    */</span> 
		MilImage<span class="token punctuation">;</span>        <span class="token comment">/* Image buffer identifier. */</span>
</code></pre> 
<p>2、初始app、systerm、digitizer<br> 不管你使用多少个相机，使用多少张采集卡，同一时间，只有一个app在运行;<br> MsysAlloc这里需要注意第一个参数，M_SYSTEM_SOLIOS以为着我们使用的采集类型，不同的采集卡，使用不同的参数；<br> MdigAlloc的第三个参数，通常是传入dcf路径的，官方给的示例，往往传入的是M_DEFAULT默认值，那么就需要在milconfig中进行配置</p> 
<pre><code class="prism language-c"><span class="token function">MappAlloc</span><span class="token punctuation">(</span>M_DEFAULT<span class="token punctuation">,</span><span class="token operator">&amp;</span>MilApplication<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MsysAlloc</span><span class="token punctuation">(</span>M_SYSTEM_SOLIOS<span class="token punctuation">,</span> M_DEFAULT<span class="token punctuation">,</span> M_DEFAULT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>MilSystem<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MdigAlloc</span><span class="token punctuation">(</span>MilSystem<span class="token punctuation">,</span> M_DEV0<span class="token punctuation">,</span> <span class="token string">"./dcf/1.dcf"</span><span class="token punctuation">,</span> M_DEFAULT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>MilDigitizer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MdispAlloc</span><span class="token punctuation">(</span>MilSystem<span class="token punctuation">,</span> M_DEFAULT<span class="token punctuation">,</span> <span class="token string">"M_DEFAULT"</span><span class="token punctuation">,</span> M_DEFAULT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>MilDisplay<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//我们往往不会用到MilDisplay，所以，可以考虑注释掉它，节约内存</span>
</code></pre> 
<p>上面的三个接口，都是分开初始化app、systerm、digitizer，具备更多的灵活性，当然也可以使用MappAllocDefault，进行默认配置，如下面的接口</p> 
<pre><code class="prism language-c"><span class="token function">MappAllocDefault</span><span class="token punctuation">(</span>M_DEFAULT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>MilApplication<span class="token punctuation">,</span> <span class="token operator">&amp;</span>MilSystem<span class="token punctuation">,</span><span class="token operator">&amp;</span>MilDisplay<span class="token punctuation">,</span> <span class="token operator">&amp;</span>MilDigitizer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>MilImage<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>使用MappAllocDefault，那么默认的卡选项，dcf路径，都需在milconfig中进行配置，如下图所示：<br> <img src="https://images2.imgbox.com/e0/1a/YXnKFybu_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/3c/dd/ieWIYoxx_o.png" alt="在这里插入图片描述"><br> 3、分配buffer，获取图像宽高</p> 
<p>分配buffer呢，有多种情况需要考虑，例如黑白相机，彩色相机，8位图像，10位图像，12位图像，彩色bayer格式，彩色RGB格式等<br> 黑白统一使用MbufAlloc2d这个接口，彩色要使用MbufAllocColor或者MbufAllocColor2d</p> 
<pre><code class="prism language-c">	MIL_INT BufSizeX<span class="token punctuation">;</span>
	MIL_INT BufSizeY<span class="token punctuation">;</span>
	<span class="token function">MdigInquire</span><span class="token punctuation">(</span>MilDigitizer<span class="token punctuation">,</span> M_SIZE_X<span class="token punctuation">,</span>    <span class="token operator">&amp;</span>BufSizeX<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//读取采集卡中的图像宽度</span>
	<span class="token function">MdigInquire</span><span class="token punctuation">(</span>MilDigitizer<span class="token punctuation">,</span> M_SIZE_Y<span class="token punctuation">,</span>    <span class="token operator">&amp;</span>BufSizeY<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//读取采集卡中的图像高度</span>
	<span class="token function">MbufAlloc2d</span><span class="token punctuation">(</span>MilSystem<span class="token punctuation">,</span> BufSizeX<span class="token punctuation">,</span>BufSizeY<span class="token punctuation">,</span><span class="token number">8L</span><span class="token operator">+</span>M_UNSIGNED<span class="token punctuation">,</span> M_IMAGE<span class="token operator">+</span>M_GRAB<span class="token operator">+</span>M_DISP<span class="token punctuation">,</span> <span class="token operator">&amp;</span>MilImage<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//分配一个8位的黑白图像buffer用于取流</span>
	<span class="token function">MbufClear</span><span class="token punctuation">(</span>MilImage<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>4、取流函数<br> mil的取流函数，分成三种连续抓图，单帧抓图，回调抓图</p> 
<ul><li>连续抓图使用MdigGrabContinuous，搭配MdigHalt（停止采集使用），一般不推荐使用连续抓图</li><li>单帧抓图MdigGrab，从指定的相机digitizer中获取一张图片，搭配MdigGrabWait，可以在指定超时时间内获取一帧数据</li><li>回调抓图MdigProcess，支持同步与异步回调两种<br> 下面，跟着注释，来看一下官方提供的MdigProcess例程，结合上面简单讲的，应该就能更好的理解mil sdk开发逻辑</li></ul> 
<pre><code class="prism language-c"><span class="token comment">/***************************************************************************************/</span>
<span class="token comment">/*
 * File name: MdigProcess.cpp
 *
 * Synopsis:  This program shows the use of the MdigProcess() function and its multiple
 *            buffering acquisition to do robust real-time processing.
 *
 *            The user's processing code to execute is located in a callback function 
 *            that will be called for each frame acquired (see ProcessingFunction()).
 *
 *      Note: The average processing time must be shorter than the grab time or some
 *            frames will be missed. Also, if the processing results are not displayed
 *            and the frame count is not drawn or printed, the CPU usage is reduced 
 *            significantly.
 *
 * Copyright © Matrox Electronic Systems Ltd., 1992-2021.
 * All Rights Reserved
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;mil.h&gt;</span></span>

<span class="token comment">/* Number of images in the buffering grab queue.
   Generally, increasing this number gives a better real-time grab.
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BUFFERING_SIZE_MAX</span> <span class="token expression"><span class="token number">20</span></span></span>

<span class="token comment">/* User's processing function prototype. */</span>
MIL_INT MFTYPE <span class="token function">ProcessingFunction</span><span class="token punctuation">(</span>MIL_INT HookType<span class="token punctuation">,</span> MIL_ID HookId<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> HookDataPtr<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* User's processing function hook data structure. */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span>
   <span class="token punctuation">{<!-- --></span>
   MIL_ID  MilDigitizer<span class="token punctuation">;</span>
   MIL_ID  MilImageDisp<span class="token punctuation">;</span>
   MIL_INT ProcessedImageCount<span class="token punctuation">;</span>
   <span class="token punctuation">}</span> HookDataStruct<span class="token punctuation">;</span>


<span class="token comment">/* Main function. */</span>
<span class="token comment">/* ---------------*/</span>

<span class="token keyword">int</span> <span class="token function">MosMain</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
   MIL_ID MilApplication<span class="token punctuation">;</span>
   MIL_ID MilSystem     <span class="token punctuation">;</span>
   MIL_ID MilDigitizer  <span class="token punctuation">;</span>
   MIL_ID MilDisplay    <span class="token punctuation">;</span>
   MIL_ID MilImageDisp  <span class="token punctuation">;</span>
   MIL_ID MilGrabBufferList<span class="token punctuation">[</span>BUFFERING_SIZE_MAX<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
   MIL_INT MilGrabBufferListSize<span class="token punctuation">;</span>
   MIL_INT ProcessFrameCount   <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   MIL_DOUBLE ProcessFrameRate <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   MIL_INT NbFrames <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   HookDataStruct UserHookData<span class="token punctuation">;</span>
<span class="token comment">//上面都是初始化后面要用到的各种变量</span>

   <span class="token comment">/* Allocate defaults. */</span>
   <span class="token comment">//使用MappAllocDefault默认分配app、system等资源，也可以使用MappAlloc、MsysAlloc等函数，单独分配</span>
   <span class="token function">MappAllocDefault</span><span class="token punctuation">(</span>M_DEFAULT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>MilApplication<span class="token punctuation">,</span> <span class="token operator">&amp;</span>MilSystem<span class="token punctuation">,</span> <span class="token operator">&amp;</span>MilDisplay<span class="token punctuation">,</span><span class="token operator">&amp;</span>MilDigitizer<span class="token punctuation">,</span> M_NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">/* Allocate a monochrome display buffer. */</span>
   <span class="token comment">//申请一块黑白的8位图像缓存</span>
   <span class="token function">MbufAlloc2d</span><span class="token punctuation">(</span>MilSystem<span class="token punctuation">,</span>
      <span class="token function">MdigInquire</span><span class="token punctuation">(</span>MilDigitizer<span class="token punctuation">,</span> M_SIZE_X<span class="token punctuation">,</span> M_NULL<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">MdigInquire</span><span class="token punctuation">(</span>MilDigitizer<span class="token punctuation">,</span> M_SIZE_Y<span class="token punctuation">,</span> M_NULL<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token number">8</span> <span class="token operator">+</span> M_UNSIGNED<span class="token punctuation">,</span>
      M_IMAGE <span class="token operator">+</span> M_GRAB <span class="token operator">+</span> M_PROC <span class="token operator">+</span> M_DISP<span class="token punctuation">,</span>
      <span class="token operator">&amp;</span>MilImageDisp<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">MbufClear</span><span class="token punctuation">(</span>MilImageDisp<span class="token punctuation">,</span> M_COLOR_BLACK<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">/* Display the image buffer. */</span>
   <span class="token comment">//锁定显示窗口，使用mil的显示窗</span>
   <span class="token function">MdispSelect</span><span class="token punctuation">(</span>MilDisplay<span class="token punctuation">,</span> MilImageDisp<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">/* Print a message. */</span>
   <span class="token function">MosPrintf</span><span class="token punctuation">(</span><span class="token function">MIL_TEXT</span><span class="token punctuation">(</span><span class="token string">"\nMULTIPLE BUFFERED PROCESSING.\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">MosPrintf</span><span class="token punctuation">(</span><span class="token function">MIL_TEXT</span><span class="token punctuation">(</span><span class="token string">"-----------------------------\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">MosPrintf</span><span class="token punctuation">(</span><span class="token function">MIL_TEXT</span><span class="token punctuation">(</span><span class="token string">"Press &lt;Enter&gt; to start processing.\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">/* Grab continuously on the display and wait for a key press. */</span>
   <span class="token comment">//演示连续抓图，直到调用MdigHalt停止</span>
   <span class="token function">MdigGrabContinuous</span><span class="token punctuation">(</span>MilDigitizer<span class="token punctuation">,</span> MilImageDisp<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">MosGetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//键盘暂停命令</span>

   <span class="token comment">/* Halt continuous grab. */</span>
   <span class="token function">MdigHalt</span><span class="token punctuation">(</span>MilDigitizer<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">/* Allocate the grab buffers and clear them. */</span>
   <span class="token function">MappControl</span><span class="token punctuation">(</span>M_DEFAULT<span class="token punctuation">,</span> M_ERROR<span class="token punctuation">,</span> M_PRINT_DISABLE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//关闭弹窗打印报错信息</span>
   <span class="token comment">//申请一串buffer，用于回调取流，跟MilImageDisp类似，主要去看BUFFERING_SIZE_MAX，默认申请了20个buffer缓存，避免回调阻塞</span>
   
   <span class="token keyword">for</span> <span class="token punctuation">(</span>MilGrabBufferListSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> MilGrabBufferListSize<span class="token operator">&lt;</span>BUFFERING_SIZE_MAX<span class="token punctuation">;</span>
      MilGrabBufferListSize<span class="token operator">++</span><span class="token punctuation">)</span>
      <span class="token punctuation">{<!-- --></span>
      <span class="token function">MbufAlloc2d</span><span class="token punctuation">(</span>MilSystem<span class="token punctuation">,</span>
         <span class="token function">MdigInquire</span><span class="token punctuation">(</span>MilDigitizer<span class="token punctuation">,</span> M_SIZE_X<span class="token punctuation">,</span> M_NULL<span class="token punctuation">)</span><span class="token punctuation">,</span>
         <span class="token function">MdigInquire</span><span class="token punctuation">(</span>MilDigitizer<span class="token punctuation">,</span> M_SIZE_Y<span class="token punctuation">,</span> M_NULL<span class="token punctuation">)</span><span class="token punctuation">,</span>
         <span class="token number">8</span> <span class="token operator">+</span> M_UNSIGNED<span class="token punctuation">,</span>
         M_IMAGE <span class="token operator">+</span> M_GRAB <span class="token operator">+</span> M_PROC<span class="token punctuation">,</span>
         <span class="token operator">&amp;</span>MilGrabBufferList<span class="token punctuation">[</span>MilGrabBufferListSize<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>MilGrabBufferList<span class="token punctuation">[</span>MilGrabBufferListSize<span class="token punctuation">]</span><span class="token punctuation">)</span>
         <span class="token function">MbufClear</span><span class="token punctuation">(</span>MilGrabBufferList<span class="token punctuation">[</span>MilGrabBufferListSize<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">else</span>
         <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token function">MappControl</span><span class="token punctuation">(</span>M_DEFAULT<span class="token punctuation">,</span> M_ERROR<span class="token punctuation">,</span> M_PRINT_ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//开启弹窗打印报错信息</span>

   <span class="token comment">/* Initialize the user's processing function data structure. */</span>
   <span class="token comment">//回调里面自定义的一些变量初始化，用户也可以自己加一下变量，初始化就行</span>
   UserHookData<span class="token punctuation">.</span>MilDigitizer        <span class="token operator">=</span> MilDigitizer<span class="token punctuation">;</span>
   UserHookData<span class="token punctuation">.</span>MilImageDisp        <span class="token operator">=</span> MilImageDisp<span class="token punctuation">;</span>
   UserHookData<span class="token punctuation">.</span>ProcessedImageCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   
   <span class="token comment">/* Start the processing. The processing function is called with every frame grabbed. */</span>
   <span class="token comment">//开启回调函数M_START，MilGrabBufferList就是我们想要的buffer</span>
   <span class="token function">MdigProcess</span><span class="token punctuation">(</span>MilDigitizer<span class="token punctuation">,</span> MilGrabBufferList<span class="token punctuation">,</span> MilGrabBufferListSize<span class="token punctuation">,</span>
               M_START<span class="token punctuation">,</span> M_DEFAULT<span class="token punctuation">,</span> ProcessingFunction<span class="token punctuation">,</span> <span class="token operator">&amp;</span>UserHookData<span class="token punctuation">)</span><span class="token punctuation">;</span>


   <span class="token comment">/* Here the main() is free to perform other tasks while the processing is executing. */</span>
   <span class="token comment">/* --------------------------------------------------------------------------------- */</span>


   <span class="token comment">/* Print a message and wait for a key press after a minimum number of frames. */</span>
   <span class="token function">MosPrintf</span><span class="token punctuation">(</span><span class="token function">MIL_TEXT</span><span class="token punctuation">(</span><span class="token string">"Press &lt;Enter&gt; to stop.                    \n\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">MosGetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">/* Stop the processing. */</span>
   <span class="token comment">//关闭回调函数M_STOP</span>
   <span class="token function">MdigProcess</span><span class="token punctuation">(</span>MilDigitizer<span class="token punctuation">,</span> MilGrabBufferList<span class="token punctuation">,</span> MilGrabBufferListSize<span class="token punctuation">,</span>
               M_STOP<span class="token punctuation">,</span> M_DEFAULT<span class="token punctuation">,</span> ProcessingFunction<span class="token punctuation">,</span> <span class="token operator">&amp;</span>UserHookData<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">/* Print statistics. */</span>
   <span class="token function">MdigInquire</span><span class="token punctuation">(</span>MilDigitizer<span class="token punctuation">,</span> M_PROCESS_FRAME_COUNT<span class="token punctuation">,</span>  <span class="token operator">&amp;</span>ProcessFrameCount<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取一下回调里面的统计信息，帧号</span>
   <span class="token function">MdigInquire</span><span class="token punctuation">(</span>MilDigitizer<span class="token punctuation">,</span> M_PROCESS_FRAME_RATE<span class="token punctuation">,</span>   <span class="token operator">&amp;</span>ProcessFrameRate<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">MosPrintf</span><span class="token punctuation">(</span><span class="token function">MIL_TEXT</span><span class="token punctuation">(</span><span class="token string">"\n\n%d frames grabbed at %.1f frames/sec (%.1f ms/frame).\n"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>ProcessFrameCount<span class="token punctuation">,</span> ProcessFrameRate<span class="token punctuation">,</span> <span class="token number">1000.0</span><span class="token operator">/</span>ProcessFrameRate<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">MosPrintf</span><span class="token punctuation">(</span><span class="token function">MIL_TEXT</span><span class="token punctuation">(</span><span class="token string">"Press &lt;Enter&gt; to end.\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">MosGetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">/* Free the grab buffers. */</span>
   <span class="token comment">//清除缓存，注意顺序</span>
   <span class="token keyword">while</span><span class="token punctuation">(</span>MilGrabBufferListSize <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
         <span class="token function">MbufFree</span><span class="token punctuation">(</span>MilGrabBufferList<span class="token punctuation">[</span><span class="token operator">--</span>MilGrabBufferListSize<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">/* Free display buffer. */</span>
   <span class="token function">MbufFree</span><span class="token punctuation">(</span>MilImageDisp<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">/* Release defaults. */</span>
   <span class="token comment">//也有单独释放每一个关键角色的函数</span>
   <span class="token function">MappFreeDefault</span><span class="token punctuation">(</span>MilApplication<span class="token punctuation">,</span> MilSystem<span class="token punctuation">,</span> MilDisplay<span class="token punctuation">,</span> MilDigitizer<span class="token punctuation">,</span> M_NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/* User's processing function called every time a grab buffer is ready. */</span>
<span class="token comment">/* -------------------------------------------------------------------- */</span>

<span class="token comment">/* Local defines. */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">STRING_LENGTH_MAX</span>  <span class="token expression"><span class="token number">20</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">STRING_POS_X</span>       <span class="token expression"><span class="token number">20</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">STRING_POS_Y</span>       <span class="token expression"><span class="token number">20</span></span></span>
<span class="token comment">//回调函数啦</span>
MIL_INT MFTYPE <span class="token function">ProcessingFunction</span><span class="token punctuation">(</span>MIL_INT HookType<span class="token punctuation">,</span> MIL_ID HookId<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> HookDataPtr<span class="token punctuation">)</span>
   <span class="token punctuation">{<!-- --></span>
   HookDataStruct <span class="token operator">*</span>UserHookDataPtr <span class="token operator">=</span> <span class="token punctuation">(</span>HookDataStruct <span class="token operator">*</span><span class="token punctuation">)</span>HookDataPtr<span class="token punctuation">;</span>
   MIL_ID ModifiedBufferId<span class="token punctuation">;</span>
   MIL_TEXT_CHAR Text<span class="token punctuation">[</span>STRING_LENGTH_MAX<span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token function">MIL_TEXT</span><span class="token punctuation">(</span><span class="token string">'\0'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

   <span class="token comment">/* Retrieve the MIL_ID of the grabbed buffer. */</span>
   <span class="token function">MdigGetHookInfo</span><span class="token punctuation">(</span>HookId<span class="token punctuation">,</span> M_MODIFIED_BUFFER<span class="token operator">+</span>M_BUFFER_ID<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ModifiedBufferId<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">/* Increment the frame counter. */</span>
   UserHookDataPtr<span class="token operator">-&gt;</span>ProcessedImageCount<span class="token operator">++</span><span class="token punctuation">;</span>

   <span class="token comment">/* Print and draw the frame count (remove to reduce CPU usage). */</span>
   <span class="token function">MosPrintf</span><span class="token punctuation">(</span><span class="token function">MIL_TEXT</span><span class="token punctuation">(</span><span class="token string">"Processing frame #%d.\r"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>UserHookDataPtr<span class="token operator">-&gt;</span>ProcessedImageCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">MosSprintf</span><span class="token punctuation">(</span>Text<span class="token punctuation">,</span> STRING_LENGTH_MAX<span class="token punctuation">,</span> <span class="token function">MIL_TEXT</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>UserHookDataPtr<span class="token operator">-&gt;</span>ProcessedImageCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">MgraText</span><span class="token punctuation">(</span>M_DEFAULT<span class="token punctuation">,</span> ModifiedBufferId<span class="token punctuation">,</span> STRING_POS_X<span class="token punctuation">,</span> STRING_POS_Y<span class="token punctuation">,</span> Text<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">/* Execute the processing and update the display. */</span>
   <span class="token function">MimArith</span><span class="token punctuation">(</span>ModifiedBufferId<span class="token punctuation">,</span> M_NULL<span class="token punctuation">,</span> UserHookDataPtr<span class="token operator">-&gt;</span>MilImageDisp<span class="token punctuation">,</span> M_NOT<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//ModifiedBufferId是我们想要的图像buffer</span>
   <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

</code></pre>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d5aefdd8244d6b4b65544b3ef3e894d3/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">2021年全球与中国汽车可变排量油泵行业市场规模及销售渠道分析</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b9cf8b745d44335441dca0ab5654ec71/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">parameterType和@Param的使用</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>