<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ovn acl功能 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="ovn acl功能" />
<meta property="og:description" content="本文介绍一下ovn的acl功能，用来设置访问控制列表，并且只能应用在逻辑交换机或者port group上，不能应用在逻辑路由器上。
acl table 在nbdb中提供了acl table，如下所示，其中每行都表示一条acl规则，参数包括优先级，方向，匹配域和动作。
image.png
priority
指定acl规则的优先级，值越大优先级越高。如果匹配到的多条规则优先级相同，最终哪条规则生效是不确定的。
direction
指定报文的方向，只有两个值: from-lport和to-lport。前者表示入方向，后者表示出方向，这是在逻辑交换机的角度来说的。
match
用来指定报文匹配域，具体的表达式规则可参考sbdb中 logical_flow table的match列。注意：类型为localnet和router的端口上不能应用acl规则。
action
对于匹配到规则的报文的处理，目前支持四个值：allow, allow-related, drop, or reject。
allow: 表示允许报文通过；
allow-related：表示允许报文和其响应报文通过；
drop：静默丢弃报文；
reject：丢弃报文，并回复报文。对于tcp协议报文，回复rst，对于其他类型的报文，回复ICMPv4/ICMPv6 unreachable。
比如在逻辑交换机ls1上添加如下规则，发往ls1-vm1端口的ip报文被丢弃，优先级为0。
ovn-nbctl acl-add ls1 to-lport 0 &#39;outport == &#34;ls1-vm1&#34; &amp;&amp; ip&#39; drop address_set table address_set table的每行指定了地址集合，包含ipv4，ipv6和mac地址，可以用在acl规则的match字段。
image.png
如下两个例子
//创建ip地址集合 ovn-nbctl create Address_Set name=ipset addresses=&#39;10.10.20.2 10.10.10.3&#39; //创建mac地址集合 ovn-nbctl create Address_Set name=macset addresses=&#39;&#34;02:00:00:00:00:01&#34;,&#34;02:00:00:00:00:02&#34;&#39; 应用acl 只在acl table添加规则是没用的，还需要将其应用到逻辑交换机或者port group。如下Logical_Switch和Port_Group table的acls列指定了acl规则的集合。
Logical_Switch TABLE acls set of ACLs Port_Group TABLE acls set of ACLs 实验 在前一篇文章ovn 配置逻辑路由器实现三层转发的基础上，做个小实验，拓扑如下" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/b12c68276401a749dfc7993fe42d43b5/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-17T22:45:15+08:00" />
<meta property="article:modified_time" content="2022-07-17T22:45:15+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ovn acl功能</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>本文介绍一下ovn的acl功能，用来设置访问控制列表，并且只能应用在逻辑交换机或者port group上，不能应用在逻辑路由器上。</p> 
<h4>acl table</h4> 
<p>在<a href="https://links.jianshu.com/go?to=https%3A%2F%2Fman7.org%2Flinux%2Fman-pages%2Fman5%2Fovn-nb.5.html%23ACL_TABLE" rel="nofollow" title="nbdb">nbdb</a>中提供了acl table，如下所示，其中每行都表示一条acl规则，参数包括优先级，方向，匹配域和动作。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/11/32/NrTVk81u_o.png"></p> 
<p>image.png</p> 
<p><br><strong>priority</strong><br> 指定acl规则的优先级，值越大优先级越高。如果匹配到的多条规则优先级相同，最终哪条规则生效是不确定的。<br><strong>direction</strong><br> 指定报文的方向，只有两个值: from-lport和to-lport。前者表示入方向，后者表示出方向，这是在逻辑交换机的角度来说的。<br><strong>match</strong><br> 用来指定报文匹配域，具体的表达式规则可参考<a href="https://links.jianshu.com/go?to=https%3A%2F%2Fman7.org%2Flinux%2Fman-pages%2Fman5%2Fovn-sb.5.html" rel="nofollow" title="sbdb">sbdb</a>中 logical_flow table的match列。注意：类型为localnet和router的端口上不能应用acl规则。<br><strong>action</strong><br> 对于匹配到规则的报文的处理，目前支持四个值：allow, allow-related, drop, or reject。<br> allow: 表示允许报文通过；<br> allow-related：表示允许报文和其响应报文通过；<br> drop：静默丢弃报文；<br> reject：丢弃报文，并回复报文。对于tcp协议报文，回复rst，对于其他类型的报文，回复ICMPv4/ICMPv6 unreachable。</p> 
<p></p> 
<p>比如在逻辑交换机ls1上添加如下规则，发往ls1-vm1端口的ip报文被丢弃，优先级为0。</p> 
<p></p> 
<pre><code>ovn-nbctl acl-add ls1 to-lport 0 'outport == "ls1-vm1" &amp;&amp; ip' drop
</code></pre> 
<h4>address_set table</h4> 
<p>address_set table的每行指定了地址集合，包含ipv4，ipv6和mac地址，可以用在acl规则的match字段。</p> 
<p></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/e3/bd/haIHWAGs_o.png"></p> 
<p>image.png</p> 
<p></p> 
<p>如下两个例子</p> 
<p></p> 
<pre><code>//创建ip地址集合
ovn-nbctl create Address_Set name=ipset addresses='10.10.20.2 10.10.10.3'
//创建mac地址集合
ovn-nbctl create Address_Set name=macset addresses='"02:00:00:00:00:01","02:00:00:00:00:02"'
</code></pre> 
<h4>应用acl</h4> 
<p>只在acl table添加规则是没用的，还需要将其应用到逻辑交换机或者port group。如下Logical_Switch和Port_Group table的acls列指定了acl规则的集合。</p> 
<p></p> 
<pre><code>Logical_Switch TABLE 
  acls                          set of ACLs

Port_Group TABLE
  acls                          set of ACLs
</code></pre> 
<h4>实验</h4> 
<p>在前一篇文章<a href="https://www.jianshu.com/p/89ad462fb157" rel="nofollow" title="ovn 配置逻辑路由器实现三层转发">ovn 配置逻辑路由器实现三层转发</a>的基础上，做个小实验，拓扑如下</p> 
<div> 
 <img alt="" src="https://images2.imgbox.com/57/0e/qpQezmUb_o.png"> 
</div> 
<p>image.png</p> 
<p><br> ls1和ls2两个网段的四个vm是可以互相通信的，现在要做的是在ls1上的vm1 namespace中启动一个web服务器，默认情况下，其他三个vm都可以访问这个web服务，然后通过添加acl规则限制，仅让ls2上的两个vm可以访问。</p> 
<p></p> 
<p>首先在ls1的vm1上启动web服务</p> 
<p></p> 
<pre><code>rm /tmp/www -rf
mkdir -p /tmp/www
echo "i am vm1" &gt; /tmp/www/index.html
cd /tmp/www
ip netns exec vm1 python -m SimpleHTTPServer 8000
</code></pre> 
<p>先验证默认情况下，其余三个vm都可以访问web服务</p> 
<p></p> 
<pre><code>root@master:~# ip netns exec vm2 curl 10.10.10.2:8000
i am vm1
root@node1:~# ip netns exec vm1 curl 10.10.10.2:8000
i am vm1
root@node1:~# ip netns exec vm2 curl 10.10.10.2:8000
i am vm1

root@master:/tmp/www# ip netns exec vm1 python -m SimpleHTTPServer 8000
Serving HTTP on 0.0.0.0 port 8000 ...
10.10.10.3 - - [23/May/2021 19:32:42] "GET / HTTP/1.1" 200 -
10.10.20.2 - - [23/May/2021 19:32:49] "GET / HTTP/1.1" 200 -
10.10.20.3 - - [23/May/2021 19:32:53] "GET / HTTP/1.1" 200 -
</code></pre> 
<p>然后在中心节点上添加两条优先级最低的规则，从ls1-vm1发出和发往ls1-vm1的ip报文默认drop</p> 
<p></p> 
<pre><code>ovn-nbctl acl-add ls1 to-lport 0 'outport == "ls1-vm1" &amp;&amp; ip' drop
ovn-nbctl acl-add ls1 from-lport 0 'inport == "ls1-vm1" &amp;&amp; ip' drop
</code></pre> 
<p>再次在其他vm上访问，结果是失败的。</p> 
<p>下面添加另一个acl规则，使ls2上的两个vm可以访问web服务。</p> 
<p></p> 
<pre><code>//只允许 10.10.20.0/24 网段的ip访问8000服务
ovn-nbctl acl-add ls1 to-lport 1000 'outport == "ls1-vm1" &amp;&amp; ip4.src == 10.10.20.0/24 &amp;&amp; tcp.dst == 8000' allow-related
</code></pre> 
<p>查看结果，只有ls2上的vm1和vm2可以访问web服务</p> 
<p></p> 
<pre><code>root@master:~# ip netns exec vm2 curl 10.10.10.2:8000
 ... -&gt;不通
root@node1:~# ip netns exec vm1 curl 10.10.10.2:8000
i am vm1
root@node1:~# ip netns exec vm2 curl 10.10.10.2:8000
i am vm1
</code></pre> 
<h2>参考</h2> 
<p><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fblog.csdn.net%2Fzhengmx100%2Farticle%2Fdetails%2F75431393" title="https://blog.csdn.net/zhengmx100/article/details/75431393">https://blog.csdn.net/zhengmx100/article/details/75431393</a></p> 
<p></p> 
<p>也可参考：<a href="https://www.jianshu.com/p/d86d64a18415" rel="nofollow" title="ovn acl功能 - 简书">ovn acl功能 - 简书</a></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5e599cf0d9e3d54728c73ae56ab52fe3/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">SSH协议中隧道与代理的用法详解</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d731d789c80b1a6da7deee56c52cc1ab/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">ovn 通过网关虚拟路由器连接外部网络</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>