<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【转】log4j 设置将生成的日志进行gz压缩并删除过期日志 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【转】log4j 设置将生成的日志进行gz压缩并删除过期日志" />
<meta property="og:description" content="转自https://www.cnblogs.com/haw2106/p/10116164.html
1、准备jar :log4j-1.2.17.jar,commons-logging-1.2.jar，这2个就可以了，其他关于日志的jar包就不要加进来了，在优先级上会有冲突。
2、定义一个类，继承RollingFileAppender类，这个类是按照日志大小滚动生成日志，并把日志编号。我就在这个类基础上重新写了其中的一些方法，加上日期和删除功能，稍加改动就行了。
package com.hm.sage.bigdata.spark.log; import java.io.File; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.IOException; import java.text.SimpleDateFormat; import java.util.Date; import java.util.zip.GZIPOutputStream; import org.apache.log4j.RollingFileAppender; import org.apache.log4j.helpers.CountingQuietWriter; import org.apache.log4j.helpers.LogLog; public class RoolingAndDateFileAppender extends RollingFileAppender { private String datePattern;//日期格式 private String dateStr = &#34;&#34;;//文件后面的日期 private String expirDays = &#34;1&#34;;//保留最近几天 private String isCleanLog = &#34;true&#34;;//是否清日志 private String maxIndex = &#34;100&#34;;//一天最多几个文件 private File rootDir;//父目录的抽象路径名 private String gzFormat = &#34;gz&#34;;//压缩格式 /** * 设置日期格式 * * @param datePattern */ public void setDatePattern(String datePattern) { if (null !" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/8785c83c73a4701eef208ae1a4064677/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-05-04T22:20:02+08:00" />
<meta property="article:modified_time" content="2021-05-04T22:20:02+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【转】log4j 设置将生成的日志进行gz压缩并删除过期日志</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>转自<a href="https://www.cnblogs.com/haw2106/p/10116164.html" rel="nofollow">https://www.cnblogs.com/haw2106/p/10116164.html</a></p> 
<p>1、准备jar  :log4j-1.2.17.jar,commons-logging-1.2.jar，这2个就可以了，其他关于日志的jar包就不要加进来了，在优先级上会有冲突。</p> 
<p>2、定义一个类，继承RollingFileAppender类，这个类是按照日志大小滚动生成日志，并把日志编号。我就在这个类基础上重新写了其中的一些方法，加上日期和删除功能，稍加改动就行了。</p> 
<pre><code class="language-java">package com.hm.sage.bigdata.spark.log;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.zip.GZIPOutputStream;

import org.apache.log4j.RollingFileAppender;
import org.apache.log4j.helpers.CountingQuietWriter;
import org.apache.log4j.helpers.LogLog;


public class RoolingAndDateFileAppender extends RollingFileAppender {

    private String datePattern;//日期格式
    private String dateStr = "";//文件后面的日期
    private String expirDays = "1";//保留最近几天
    private String isCleanLog = "true";//是否清日志
    private String maxIndex = "100";//一天最多几个文件
    private File rootDir;//父目录的抽象路径名
    private String gzFormat = "gz";//压缩格式


    /**
     * 设置日期格式
     *
     * @param datePattern
     */
    public void setDatePattern(String datePattern) {
        if (null != datePattern &amp;&amp; !"".equals(datePattern)) {
            this.datePattern = datePattern;
        }
    }

    /**
     * 获取日期格式
     *
     * @return
     */
    public String getDatePattern() {
        return this.datePattern;
    }

    public void rollOver() {
        //文件后面的日期
        dateStr = new SimpleDateFormat(this.datePattern).format(new Date(System.currentTimeMillis()));
        File target = null;
        File file = null;
        if (qw != null) {
            //得到写入的字节数
            long size = ((CountingQuietWriter) this.qw).getCount();
            LogLog.debug("rolling over count=" + size);
        }
        //默认情况下有一个备份文件
        LogLog.debug("maxBackupIndex=" + this.maxBackupIndex);
        //如果maxIndex&lt;=0则不需命名
        if (maxIndex != null &amp;&amp; Integer.parseInt(maxIndex) &gt; 0) {
            //logRecoed.log.2018-08-24.5
            //删除旧文件
            file = new File(this.fileName + '.' + dateStr + '.' + Integer.parseInt(this.maxIndex) + '.' + gzFormat);
            if (file.exists()) {//测试用这个抽象路径名表示的文件或目录是否存在。
                //如果当天日志达到最大设置数量，则删除当天第一个日志，其他日志为尾号减一
                Boolean boo = reLogNum();
                if (!boo) {
                    LogLog.debug("日志滚动重命名失败！");
                }
            }
        }
        //获取当天日期文件个数
        int count = cleanLog();
        //生成新文件
        //target=new File(fileName+"."+dateStr+"."+(count+1));
        this.closeFile();//关闭先前打开的文件。
        file = new File(fileName);

        //creat zip output stream to build zip file
        GZIPOutputStream gzout = null;
        FileInputStream fin = null;
        byte[] buf = new byte[1024];

        //file -&gt; gz
        try {
            fin = new FileInputStream(file);
            gzout = new GZIPOutputStream(new FileOutputStream(fileName + "." + dateStr + "." + (count + 1) + '.' + gzFormat));

            int num;
            while ((num = fin.read(buf, 0, buf.length)) != -1) {
                gzout.write(buf, 0, num);
            }
            gzout.flush();
            gzout.finish();

            LogLog.debug(fileName + " -&gt; " + fileName + "." + dateStr + "." + (count + 1) + '.' + gzFormat + " successful!");
        } catch (IOException e) {
            LogLog.error("add gz file(" + fileName + "." + dateStr + "." + (count + 1) + '.' + gzFormat + ") failed.");
        } finally {
            try {
                if (gzout != null) {
                    gzout.close();
                }
                if (fin != null)
                    fin.close();
            } catch (IOException e) {
                LogLog.error("close Stream failed");
            }
        }

        //delete old file
        file.delete();


        //LogLog.debug("Renaming file"+file+"to"+target);
        //file.renameTo(target);//重命名file文件
        try {
            setFile(this.fileName, false, this.bufferedIO, this.bufferSize);
        } catch (IOException e) {
            LogLog.error("setFile(" + this.fileName + ",false)call failed.", e);
        }
    }

    /**
     * 获取当天日期文件个数
     *
     * @return
     */
    public int cleanLog() {
        int count = 0;//记录当天文件个数
        if (Boolean.parseBoolean(isCleanLog)) {
            File f = new File(fileName);
            //返回这个抽象路径名的父目录的抽象路径名
            rootDir = f.getParentFile();
            //目录中所有文件。
            File[] listFiles = rootDir.listFiles();
            for (File file : listFiles) {
                if (file.getName().contains(dateStr)) {
                    count = count + 1;//是当天日志，则+1
                } else {
                    //不是当天日志需要判断是否到期删除
                    if (Boolean.parseBoolean(isCleanLog)) {
                        //清除过期日志
                        String[] split = file.getName().split("\\\\")[0].split("\\.");
                        //校验日志名字，并取出日期，判断过期时间
                        if (split.length == 4 &amp;&amp; isExpTime(split[2])) {
                            file.delete();
                        }
                    }
                }
            }
        }
        return count;
    }

    /**
     * 判断过期时间
     *
     * @param time
     * @return
     */
    public Boolean isExpTime(String time) {
        SimpleDateFormat format = new SimpleDateFormat(this.datePattern);
        try {
            Date logTime = format.parse(time);
            Date nowTime = format.parse(format.format(new Date()));
            //算出日志与当前日期相差几天
            int days = (int) (nowTime.getTime() - logTime.getTime()) / (1000 * 3600 * 24);
            if (Math.abs(days) &gt;= Integer.parseInt(expirDays)) {
                return true;
            } else {
                return false;
            }
        } catch (Exception e) {
            LogLog.error(e.toString());
            return false;
        }
    }

    /**
     * 如果当天日志达到最大设置数量，则每次删除尾号为1的日志，
     * 其他日志编号依次减去1，重命名
     *
     * @return
     */
    public Boolean reLogNum() {
        boolean renameTo = false;
        File startFile = new File(this.fileName + '.' + dateStr + '.' + "1" + '.' + gzFormat);
        if (startFile.exists() &amp;&amp; startFile.delete()) {//是否存并删除
            for (int i = 2; i &lt;= Integer.parseInt(maxIndex); i++) {
                File target = new File(this.fileName + '.' + dateStr + '.' + (i - 1) + '.' + gzFormat);
                this.closeFile();
                File file = new File(this.fileName + '.' + dateStr + '.' + i + '.' + gzFormat);
                renameTo = file.renameTo(target);//重命名file文件
            }
        }
        return renameTo;
    }

    public String getDateStr() {
        return dateStr;
    }

    public void setDateStr(String dateStr) {
        this.dateStr = dateStr;
    }

    public String getExpirDays() {
        return expirDays;
    }

    public void setExpirDays(String expirDays) {
        this.expirDays = expirDays;
    }

    public String getIsCleanLog() {
        return isCleanLog;
    }

    public void setIsCleanLog(String isCleanLog) {
        this.isCleanLog = isCleanLog;
    }

    public String getMaxIndex() {
        return maxIndex;
    }

    public void setMaxIndex(String maxIndex) {
        this.maxIndex = maxIndex;
    }

}</code></pre> 
<p>log4j.properties 配置文件</p> 
<pre><code class="language-XML">log4j.rootLogger=ALL,R,CONSOLE

log4j.appender.R=com.hm.sage.bigdata.spark.log.RoolingAndDateFileAppender
log4j.appender.R.Encoding=UTF-8
log4j.appender.R.file=/Users/shengwen/tmp/logs/logRecoed.log
log4j.appender.R.Append=true
log4j.appender.R.DatePattern=yyyy-MM-dd
log4j.appender.R.MaxFileSize=5MB
log4j.appender.R.maxIndex=10
log4j.appender.R.expirDays=4
log4j.appender.R.isCleanLog=true

log4j.appender.R.layout.ConversionPattern=[%-5p] [%d{yyyy-MM-dd HH:mm:ss}] [%C{1}:%M:%L] %m%n
log4j.appender.R.layout=org.apache.log4j.PatternLayout

#console
log4j.appender.CONSOLE=org.apache.log4j.ConsoleAppender
log4j.appender.CONSOLE.layout.ConversionPattern=[%-5p] [%d{yyyy-MM-dd HH:mm:ss}] [%C{1}:%M:%L] %m%n
log4j.appender.CONSOLE.layout=org.apache.log4j.PatternLayout</code></pre> 
<p> </p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f725d3d36342bf7db0150b357ac174cb/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">js中的展开运算符(扩展运算符)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/502371a913d2b00b065f0378797903cc/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">电脑的Mac地址怎么查看</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>