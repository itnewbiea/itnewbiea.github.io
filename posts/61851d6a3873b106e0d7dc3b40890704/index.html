<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>详细讲解u-boot之网络移植与调试 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="详细讲解u-boot之网络移植与调试" />
<meta property="og:description" content="目录
一、前章回顾
二、硬件原理图检查
1.确认硬件原理图的fec对应的phy地址
2.修改网卡fec1的phy地址
3.网络初始化检查
4.fec部分管脚确认
5.检查是否存在多设备管脚复用
6.使用默认ENET2
三、编译烧写，下载验证
1.设置网络环境变量
2.使用软件配置，默认生成
3.验证网络是否连通
四、FEC1网卡1调试
1.屏蔽或删除掉 fec2 节点内容
2.在fec1 节点下添加 mdio 子节点
3.添加MDIO和MDC引脚配置
4.修改ENET设备为enet0
一、前章回顾 上一章，已经讲过如何讲uboot.2022.10版本移植到我们自己的imx6ull开发板上，但是最后编译下载后网络部分为能正确识别，今天我们就来讲一讲网络部分的调试。
上一篇uboot编译后，上电启动，串口打印如下：
U-Boot 2022.10-gaef9f25a-dirty (Apr 05 2023 - 17:49:18 &#43;0800) CPU: Freescale i.MX6ULL rev1.1 792 MHz (running at 396 MHz) CPU: Industrial temperature grade (-40C to 105C) at 26C Reset cause: POR Model: Freescale i.MX6 UltraLiteLite 14x14 EVK Board Board: MX6ULL TOTO DRAM: 512 MiB Core: 65 devices, 17 uclasses, devicetree: separate MMC: FSL_SDHC: 0, FSL_SDHC: 1 Loading Environment from MMC." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/61851d6a3873b106e0d7dc3b40890704/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-23T12:25:47+08:00" />
<meta property="article:modified_time" content="2023-05-23T12:25:47+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">详细讲解u-boot之网络移植与调试</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="%E4%B8%80%E3%80%81%E5%89%8D%E7%AB%A0%E5%9B%9E%E9%A1%BE-toc" style="margin-left:40px;"><a href="#%E4%B8%80%E3%80%81%E5%89%8D%E7%AB%A0%E5%9B%9E%E9%A1%BE" rel="nofollow">一、前章回顾</a></p> 
<p id="h-1-toc" style="margin-left:40px;"><a href="#h-1" rel="nofollow">二、硬件原理图检查</a></p> 
<p id="1.%E7%A1%AE%E8%AE%A4%E7%A1%AC%E4%BB%B6%E5%8E%9F%E7%90%86%E5%9B%BE%E7%9A%84fec%E5%AF%B9%E5%BA%94%E7%9A%84phy%E5%9C%B0%E5%9D%80-toc" style="margin-left:80px;"><a href="#1.%E7%A1%AE%E8%AE%A4%E7%A1%AC%E4%BB%B6%E5%8E%9F%E7%90%86%E5%9B%BE%E7%9A%84fec%E5%AF%B9%E5%BA%94%E7%9A%84phy%E5%9C%B0%E5%9D%80" rel="nofollow">1.确认硬件原理图的fec对应的phy地址</a></p> 
<p id="2.%E4%BF%AE%E6%94%B9%E7%BD%91%E5%8D%A1fec1%E7%9A%84phy%E5%9C%B0%E5%9D%80-toc" style="margin-left:80px;"><a href="#2.%E4%BF%AE%E6%94%B9%E7%BD%91%E5%8D%A1fec1%E7%9A%84phy%E5%9C%B0%E5%9D%80" rel="nofollow">2.修改网卡fec1的phy地址</a></p> 
<p id="3.%E7%BD%91%E7%BB%9C%E5%88%9D%E5%A7%8B%E5%8C%96%E6%A3%80%E6%9F%A5-toc" style="margin-left:80px;"><a href="#3.%E7%BD%91%E7%BB%9C%E5%88%9D%E5%A7%8B%E5%8C%96%E6%A3%80%E6%9F%A5" rel="nofollow">3.网络初始化检查</a></p> 
<p id="%C2%A04.fec%E9%83%A8%E5%88%86%E7%AE%A1%E8%84%9A%E7%A1%AE%E8%AE%A4-toc" style="margin-left:80px;"><a href="#%C2%A04.fec%E9%83%A8%E5%88%86%E7%AE%A1%E8%84%9A%E7%A1%AE%E8%AE%A4" rel="nofollow"> 4.fec部分管脚确认</a></p> 
<p id="5.%E6%A3%80%E6%9F%A5%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8%E5%A4%9A%E8%AE%BE%E5%A4%87%E7%AE%A1%E8%84%9A%E5%A4%8D%E7%94%A8-toc" style="margin-left:80px;"><a href="#5.%E6%A3%80%E6%9F%A5%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8%E5%A4%9A%E8%AE%BE%E5%A4%87%E7%AE%A1%E8%84%9A%E5%A4%8D%E7%94%A8" rel="nofollow">5.检查是否存在多设备管脚复用</a></p> 
<p id="6.%E4%BD%BF%E7%94%A8%E9%BB%98%E8%AE%A4ENET2-toc" style="margin-left:80px;"><a href="#6.%E4%BD%BF%E7%94%A8%E9%BB%98%E8%AE%A4ENET2" rel="nofollow">6.使用默认ENET2</a></p> 
<p id="h-2-toc" style="margin-left:40px;"><a href="#h-2" rel="nofollow">三、编译烧写，下载验证</a></p> 
<p id="1.%E8%AE%BE%E7%BD%AE%E7%BD%91%E7%BB%9C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F-toc" style="margin-left:80px;"><a href="#1.%E8%AE%BE%E7%BD%AE%E7%BD%91%E7%BB%9C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F" rel="nofollow">1.设置网络环境变量</a></p> 
<p id="2.%E4%BD%BF%E7%94%A8%E8%BD%AF%E4%BB%B6%E9%85%8D%E7%BD%AE%EF%BC%8C%E9%BB%98%E8%AE%A4%E7%94%9F%E6%88%90-toc" style="margin-left:80px;"><a href="#2.%E4%BD%BF%E7%94%A8%E8%BD%AF%E4%BB%B6%E9%85%8D%E7%BD%AE%EF%BC%8C%E9%BB%98%E8%AE%A4%E7%94%9F%E6%88%90" rel="nofollow">2.使用软件配置，默认生成</a></p> 
<p id="3.%E9%AA%8C%E8%AF%81%E7%BD%91%E7%BB%9C%E6%98%AF%E5%90%A6%E8%BF%9E%E9%80%9A-toc" style="margin-left:80px;"><a href="#3.%E9%AA%8C%E8%AF%81%E7%BD%91%E7%BB%9C%E6%98%AF%E5%90%A6%E8%BF%9E%E9%80%9A" rel="nofollow">3.验证网络是否连通</a></p> 
<p id="hfec11-toc" style="margin-left:40px;"><a href="#hfec11" rel="nofollow">四、FEC1网卡1调试</a></p> 
<p id="1.%E5%B1%8F%E8%94%BD%E6%88%96%E5%88%A0%E9%99%A4%E6%8E%89%20fec2%20%E8%8A%82%E7%82%B9%E5%86%85%E5%AE%B9-toc" style="margin-left:80px;"><a href="#1.%E5%B1%8F%E8%94%BD%E6%88%96%E5%88%A0%E9%99%A4%E6%8E%89%20fec2%20%E8%8A%82%E7%82%B9%E5%86%85%E5%AE%B9" rel="nofollow">1.屏蔽或删除掉 fec2 节点内容</a></p> 
<p id="2.%E5%9C%A8fec1%20%E8%8A%82%E7%82%B9%E4%B8%8B%E6%B7%BB%E5%8A%A0%20mdio%20%E5%AD%90%E8%8A%82%E7%82%B9-toc" style="margin-left:80px;"><a href="#2.%E5%9C%A8fec1%20%E8%8A%82%E7%82%B9%E4%B8%8B%E6%B7%BB%E5%8A%A0%20mdio%20%E5%AD%90%E8%8A%82%E7%82%B9" rel="nofollow">2.在fec1 节点下添加 mdio 子节点</a></p> 
<p id="3.%E6%B7%BB%E5%8A%A0MDIO%E5%92%8CMDC%E5%BC%95%E8%84%9A%E9%85%8D%E7%BD%AE-toc" style="margin-left:80px;"><a href="#3.%E6%B7%BB%E5%8A%A0MDIO%E5%92%8CMDC%E5%BC%95%E8%84%9A%E9%85%8D%E7%BD%AE" rel="nofollow">3.添加MDIO和MDC引脚配置</a></p> 
<p id="4.%E4%BF%AE%E6%94%B9ENET%E8%AE%BE%E5%A4%87%E4%B8%BAenet0-toc" style="margin-left:80px;"><a href="#4.%E4%BF%AE%E6%94%B9ENET%E8%AE%BE%E5%A4%87%E4%B8%BAenet0" rel="nofollow">4.修改ENET设备为enet0</a></p> 
<hr id="hr-toc"> 
<h3>一、前章回顾</h3> 
<p>        上一章，已经讲过如何讲uboot.2022.10版本移植到我们自己的imx6ull开发板上，但是最后编译下载后网络部分为能正确识别，今天我们就来讲一讲网络部分的调试。</p> 
<p>        上一篇uboot编译后，上电启动，串口打印如下：</p> 
<pre><code>U-Boot 2022.10-gaef9f25a-dirty (Apr 05 2023 - 17:49:18 +0800)

CPU:   Freescale i.MX6ULL rev1.1 792 MHz (running at 396 MHz)
CPU:   Industrial temperature grade (-40C to 105C) at 26C
Reset cause: POR
Model: Freescale i.MX6 UltraLiteLite 14x14 EVK Board
Board: MX6ULL TOTO
DRAM:  512 MiB
Core:  65 devices, 17 uclasses, devicetree: separate
MMC:   FSL_SDHC: 0, FSL_SDHC: 1
Loading Environment from MMC... OK
In:    serial
Out:   serial
Err:   serial
Net:   Could not get PHY for FEC1: addr 1
Could not get PHY for FEC1: addr 1
Get shared mii bus on ethernet@2188000
Could not get PHY for FEC1: addr 2
Get shared mii bus on ethernet@2188000
Could not get PHY for FEC1: addr 2
No ethernet found.

Hit any key to stop autoboot: 
=&gt; 
</code></pre> 
<p>        通过打印信息，我们可以发现连phy都没有正确识别到。首先来回顾一下，上一篇我们采用的是NXP官方默认imx6ull开发板的配置参数，任何参数都未做修改，现在使用默认配置网络未能正确识别，说明我们的硬件设计与官方的设计有偏差。因此，首先需要查看原理图，确认默认NXP imx6ull的网络管脚与我们自己硬件原理图上是否一致。</p> 
<h3 id="h-1">二、硬件原理图检查</h3> 
<h4 id="1.%E7%A1%AE%E8%AE%A4%E7%A1%AC%E4%BB%B6%E5%8E%9F%E7%90%86%E5%9B%BE%E7%9A%84fec%E5%AF%B9%E5%BA%94%E7%9A%84phy%E5%9C%B0%E5%9D%80">1.确认硬件原理图的fec对应的phy地址</h4> 
<p>        从imx6ull开发板硬件原理图上可以得到，<span style="background-color:#ff9900;">ENET1对应的phy addr为：0x0</span>，<span style="background-color:#ff9900;">ENET2对应的phy addr为：0x1</span></p> 
<p><img alt="" height="290" src="https://images2.imgbox.com/3b/16/ISd2wLRX_o.png" width="469"></p> 
<p> <img alt="" height="245" src="https://images2.imgbox.com/81/b2/Glxz3zpl_o.png" width="486"></p> 
<p> </p> 
<h4 id="2.%E4%BF%AE%E6%94%B9%E7%BD%91%E5%8D%A1fec1%E7%9A%84phy%E5%9C%B0%E5%9D%80">2.修改网卡fec1的phy地址</h4> 
<p>        imx6ull对应的设备树文件<span style="background-color:#ff9900;">imx6ull-14x14-evk.dtsi</span>，从设备树文件中可以得到，imx6ull FEC1对应位ethphy0，而ethphy0对应的phy地址默认位2，这与我们开发板硬件给的phy地址不符合，因此修改设备树中FEC1对应的phy地址为0</p> 
<pre><code class="language-bash">&amp;fec1 {
    pinctrl-names = "default";
    pinctrl-0 = &lt;&amp;pinctrl_enet1&gt;;
    phy-mode = "rmii";
    phy-handle = &lt;&amp;ethphy0&gt;;
    phy-supply = &lt;&amp;reg_peri_3v3&gt;;
    status = "okay";
};

&amp;fec2 {
    pinctrl-names = "default";
    pinctrl-0 = &lt;&amp;pinctrl_enet2&gt;;
    phy-mode = "rmii";
    phy-handle = &lt;&amp;ethphy1&gt;;
    phy-supply = &lt;&amp;reg_peri_3v3&gt;;
    status = "okay";    

    mdio {
        #address-cells = &lt;1&gt;;
        #size-cells = &lt;0&gt;;

        ethphy0: ethernet-phy@2 {
            compatible = "ethernet-phy-id0022.1560";
            reg = &lt;2&gt;;
            ...
        };

        ethphy1: ethernet-phy@1 {
            compatible = "ethernet-phy-id0022.1560";
            reg = &lt;1&gt;;
            ...
        };
    };
};
</code></pre> 
<p>修改FEC1节点对应的<span style="background-color:#ff9900;">phy地址为0,</span>如下；</p> 
<pre><code class="language-bash">mdio {
        #address-cells = &lt;1&gt;;
        #size-cells = &lt;0&gt;;

        ethphy0: ethernet-phy@0 {
            compatible = "ethernet-phy-id0022.1560";
            reg = &lt;0&gt;;
            micrel,led-mode = &lt;1&gt;;
            clocks = &lt;&amp;clks IMX6UL_CLK_ENET_REF&gt;;
            clock-names = "rmii-ref";

        };
        ...
    }
</code></pre> 
<p>重新编译，烧写验证，还是报错</p> 
<p><img alt="" height="377" src="https://images2.imgbox.com/0b/e6/If2JWjcs_o.png" width="619"></p> 
<h4 id="3.%E7%BD%91%E7%BB%9C%E5%88%9D%E5%A7%8B%E5%8C%96%E6%A3%80%E6%9F%A5">3.网络初始化检查</h4> 
<p>        接下来就只有从网络初始化入口initr_net函数开始，查看网络初始化哪里有问题。</p> 
<p>        在board_r文件中的<span style="background-color:#ff9900;">init_sequence_r</span>调用<img alt="" height="705" src="https://images2.imgbox.com/58/26/ld5Xw5n2_o.png" width="1055"></p> 
<p>         可以看到initr_net函数其实就两个作用，一是调用<span style="background-color:#ff9900;">eth_initialize</span>进行网络初始化，二是调用<span style="background-color:#ff9900;">reset_phy</span>对phy进行复位，具体实现，如下；</p> 
<pre><code class="language-objectivec">static int initr_net(void)
{
    puts("Net:   ");
    eth_initialize();
#if defined(CONFIG_RESET_PHY_R)
    debug("Reset Ethernet PHY\n");
    reset_phy();
#endif
    return 0;
}
</code></pre> 
<p>        继续往下，我们可以看到，phy_init初始化函数中只调用了<span style="background-color:#ff9900;">phy_micrel_ksz8xxx_init</span>对Micrel 公司生产的ksz8系列的phy进行了初始化，如下;</p> 
<pre><code class="language-objectivec">int phy_init(void)
{
...
#ifdef CONFIG_PHY_MICREL_KSZ8XXX
    phy_micrel_ksz8xxx_init();
#endif 
#ifdef CONFIG_PHY_MICREL_KSZ90X1
    phy_micrel_ksz90x1_init();
#endif
...
#ifdef CONFIG_PHY_SMSC
    phy_smsc_init();
#endif
...
    genphy_init();

    return 0;
}
</code></pre> 
<p>        而我们的硬件<span style="color:#fe2c24;">fec1</span>和<span style="color:#fe2c24;">fec2</span>都是使用<span style="color:#fe2c24;">SMSC </span>公司生产的<span style="color:#fe2c24;">LAN8720A</span>，因此修改为调用<span style="color:#fe2c24;">phy_smsc_init初始化phy芯片LAN8720A</span>。</p> 
<p>        具体修改为在<span style="background-color:#ff9900;">mx6ull_toto_defconfig</span>文件添加宏定义<span style="background-color:#ff9900;">CONFIG_PHY_SMSC=y</span>;然后屏蔽<span style="background-color:#ff9900;">CONFIG_PHY_MICREL=y</span>和<span style="background-color:#ff9900;">CONFIG_PHY_MICREL_KSZ8XXX=y</span>，如下；</p> 
<p><img alt="" height="740" src="https://images2.imgbox.com/2b/47/Vwa0L4Os_o.png" width="701"></p> 
<p><img alt="" height="773" src="https://images2.imgbox.com/ed/b1/8uo2YVfn_o.png" width="1200"></p> 
<h4 id="%C2%A04.fec%E9%83%A8%E5%88%86%E7%AE%A1%E8%84%9A%E7%A1%AE%E8%AE%A4"> 4.fec部分管脚确认</h4> 
<p>        继续往下，在fecmxc_probe函数中发现调用了<span style="background-color:#ff9900;">fec_gpio_reset()</span>函数复位fec网卡，但是设备树文件中没有配置复位管脚</p> 
<p><img alt="" height="414" src="https://images2.imgbox.com/c9/55/zNVBlmnU_o.png" width="724"></p> 
<p>       <span style="background-color:#ff9900;"> fecmxc_of_to_plat</span>函数会对设备中的phy的这三个定义进行解析。因此在设备中添加如下三个定义：</p> 
<p><img alt="" height="639" src="https://images2.imgbox.com/31/2e/chwCjeXQ_o.png" width="928"></p> 
<p>在硬件原理图中找到eth1、eth2phy复位管脚对应imx6ull芯片的管脚</p> 
<p><img alt="" height="566" src="https://images2.imgbox.com/d1/af/PeuvibLg_o.png" width="940"></p> 
<p><img alt="" height="352" src="https://images2.imgbox.com/fc/9b/t0mkqeh9_o.png" width="947"></p> 
<p>设备树文件<span style="background-color:#ff9900;">imx6ul-14x14-evk.dtsi</span>中，具体配置如下：</p> 
<p><img alt="" height="650" src="https://images2.imgbox.com/07/d3/8OvE709X_o.png" width="595"></p> 
<h4 id="5.%E6%A3%80%E6%9F%A5%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8%E5%A4%9A%E8%AE%BE%E5%A4%87%E7%AE%A1%E8%84%9A%E5%A4%8D%E7%94%A8">5.检查是否存在多设备管脚复用</h4> 
<p>         下面要做的就是查看在设备树文件中查看一下，刚刚添加的两个GPIO管脚在其他设备中是否存在该<span style="color:#fe2c24;">管脚复用</span>情况<img alt="" height="642" src="https://images2.imgbox.com/0d/1d/phqg7lwt_o.png" width="632"></p> 
<p>        查找结果如上，spi4接口中使用了GPIO5的7和8两个管脚，并且该设备status状态为“okay”激活，解决方法如下，<span style="background-color:#ff9900;">disable掉spi4接口</span></p> 
<p><img alt="" height="648" src="https://images2.imgbox.com/5d/f2/JedXeUlG_o.png" width="622"></p> 
<p>        还有一种方法就是<span style="background-color:#fe2c24;">删除使用gpio5两个管脚的两行定义</span>，这里就不演示了。<br> 编译验证如下；</p> 
<p><img alt="" height="346" src="https://images2.imgbox.com/04/14/gu2kwhy5_o.png" width="760"></p> 
<p>uboot下只会使用一个网口，因此屏蔽一个</p> 
<h4 id="6.%E4%BD%BF%E7%94%A8%E9%BB%98%E8%AE%A4ENET2">6.使用默认ENET2</h4> 
<p>        使用uboot中imx6ull默认的网卡ENET2<br>         默认网卡，宏定义<span style="background-color:#ff9900;">CONFIG_FEC_ENET_DEV</span>，路径：<span style="background-color:#ff9900;">/include/configs/mx6ull_toto.h</span></p> 
<pre><code class="language-objectivec">#ifdef CONFIG_CMD_NET
#define CONFIG_FEC_ENET_DEV     1
#endif
</code></pre> 
<p>        在设备树文件中将<span style="background-color:#ff9900;">FEC1</span>节点的<span style="background-color:#ff9900;">status</span>设置为<span style="background-color:#ff9900;">disabled</span></p> 
<pre><code class="language-objectivec">&amp;fec1 {
    pinctrl-names = "default";
    pinctrl-0 = &lt;&amp;pinctrl_enet1&gt;;
    phy-mode = "rmii";
    phy-handle = &lt;&amp;ethphy0&gt;;
    phy-supply = &lt;&amp;reg_peri_3v3&gt;;
    phy-reset-gpios = &lt;&amp;gpio5 7 GPIO_ACTIVE_LOW&gt;; // 复位引脚
    phy-reset-duration = &lt;100&gt;;
    phy-reset-post-delay = &lt;100&gt;;
    status = "disabled";    //禁用
};
</code></pre> 
<h3 id="h-2">三、编译烧写，下载验证</h3> 
<p>SecureCRT 输出结果如下：</p> 
<pre><code class="language-bash">U-Boot 2022.10-g8d3c4ea8-dirty (May 20 2023 - 11:49:18 +0800)

CPU:   Freescale i.MX6ULL rev1.1 792 MHz (running at 396 MHz)
CPU:   Industrial temperature grade (-40C to 105C) at 34C
Reset cause: POR
Model: Freescale i.MX6 UltraLiteLite 14x14 EVK Board
Board: MX6ULL TOTO
DRAM:  512 MiB
Core:  61 devices, 17 uclasses, devicetree: separate
MMC:   FSL_SDHC: 0, FSL_SDHC: 1
Loading Environment from MMC... OK
In:    serial
Out:   serial
Err:   serial
Net:   
Error: ethernet@20b4000 address not set.

Error: ethernet@20b4000 address not set.
No ethernet found.

Hit any key to stop autoboot:  0 
=&gt; 
=&gt;
</code></pre> 
<p>提示：</p> 
<ul><li>Error: ethernet@20b4000 address not set.</li><li>Error: ethernet@20b4000 address not set.</li><li>No ethernet found.</li></ul> 
<p>这是因为没有设置网络环境变量，<span style="background-color:#ff9900;">1.手动设置</span> <span style="background-color:#ff9900;">2.系统配置，默认生成</span></p> 
<h4 id="1.%E8%AE%BE%E7%BD%AE%E7%BD%91%E7%BB%9C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F">1.设置网络环境变量</h4> 
<pre><code class="language-objectivec">setenv ethaddr 32:34:46:78:9A:DC    //设置开发板网卡1 MAC地址 
setenv eth1addr 32:34:46:78:9A:DD   //设置开发板网卡2 MAC地址 
setenv serverip 192.168.0.106       //设置服务器地址，一般是windows或Ubuntu地址
setenv ipaddr 192.168.0.123         //设置开发板IP地址 
setenv gatewayip 192.168.0.1        //设置开发板默认网关 
setenv netmask 255.255.255.0        //设置开发板子网掩码
setenv bootdelay 5                  //设置启动延时实际
saveenv                             //将改变覆盖到MMC
</code></pre> 
<p>       <strong><span style="color:#fe2c24;"> 注意</span></strong>：u-boot的环境变量是设置在MMC中的，不会随着UBoot重新编译而清除，如果修改乱了可以使用如下命令恢复默认：</p> 
<pre><code class="language-objectivec">env default -a // 恢复默认设置
saveenv        // 将改变覆盖到MMC
</code></pre> 
<h4 id="2.%E4%BD%BF%E7%94%A8%E8%BD%AF%E4%BB%B6%E9%85%8D%E7%BD%AE%EF%BC%8C%E9%BB%98%E8%AE%A4%E7%94%9F%E6%88%90">2.使用软件配置，默认生成</h4> 
<p>        <span style="background-color:#ff9900;">configs/mx6ull_toto_defconfig</span> 文件,使能随机生成MAC地址</p> 
<pre><code class="language-objectivec">CONFIG_NET_RANDOM_ETHADDR=y
</code></pre> 
<p>重启开发板，打印信息如下;</p> 
<pre><code class="language-bash">U-Boot 2022.10-g8d3c4ea8-dirty (May 20 2023 - 11:49:18 +0800)

CPU:   Freescale i.MX6ULL rev1.1 792 MHz (running at 396 MHz)
CPU:   Industrial temperature grade (-40C to 105C) at 45C
Reset cause: WDOG
Model: Freescale i.MX6 UltraLiteLite 14x14 EVK Board
Board: MX6ULL TOTO
DRAM:  512 MiB
Core:  61 devices, 17 uclasses, devicetree: separate
MMC:   FSL_SDHC: 0, FSL_SDHC: 1
Loading Environment from MMC... OK
In:    serial
Out:   serial
Err:   serial
Net:   eth1: ethernet@20b4000 [PRIME]
Hit any key to stop autoboot:  0 
=&gt; 
=&gt; 
</code></pre> 
<h4 id="3.%E9%AA%8C%E8%AF%81%E7%BD%91%E7%BB%9C%E6%98%AF%E5%90%A6%E8%BF%9E%E9%80%9A">3.验证网络是否连通</h4> 
<p>使用ping命令，验证网络是否可以正常工作</p> 
<pre><code class="language-bash">=&gt; ping 192.168.0.106
Using ethernet@20b4000 device

ARP Retry count exceeded; starting again
ping failed; host 192.168.0.106 is not alive
=&gt; 
</code></pre> 
<p>ping测试失败</p> 
<ul><li>原因1：可能是windows的防火墙没有关，</li><li>原因2：LAN8720初始化需要复位，修改SMSC驱动。</li></ul> 
<p>我这边的原因就是uboot LAN8720初始化没有进行复位<br> 在 <span style="background-color:#ff9900;">drivers/net/phy/phy.c</span> 文件中修改：</p> 
<pre><code class="language-bash">int genphy_config_aneg(struct phy_device *phydev)
{
    int result;

    /* SOFT RESET */
    phy_reset(phydev);

    if (phydev-&gt;autoneg != AUTONEG_ENABLE)
        return genphy_setup_forced(phydev);

    result = genphy_config_advert(phydev);
    ...
    ...
}
</code></pre> 
<p>再次编译重启开发板，Ping成功。</p> 
<pre><code>=&gt; ping 192.168.0.106
Using ethernet@20b4000 device
host 192.168.0.106 is alive
=&gt; 
</code></pre> 
<h3 id="hfec11">四、FEC1网卡1调试</h3> 
<p>        使用 ENET1 网卡的话就稍微复杂一点了，不是简单的将 fec2 节点下的<span style="background-color:#ff9900;"> status</span> 改为<span style="background-color:#ff9900;">“disabled”</span>，需要对在设备树<span style="background-color:#ff9900;">arch/arm/dts/imx6ul-14x14-evk.dtsi</span>文件进行修改和添加。</p> 
<h4 id="1.%E5%B1%8F%E8%94%BD%E6%88%96%E5%88%A0%E9%99%A4%E6%8E%89%20fec2%20%E8%8A%82%E7%82%B9%E5%86%85%E5%AE%B9">1.屏蔽或删除掉 fec2 节点内容</h4> 
<pre><code class="language-bash">/*
&amp;fec2 {
    pinctrl-names = "default";
    pinctrl-0 = &lt;&amp;pinctrl_enet2&gt;;
    phy-mode = "rmii";
    phy-handle = &lt;&amp;ethphy1&gt;;
    phy-supply = &lt;&amp;reg_peri_3v3&gt;;
    phy-reset-gpios = &lt;&amp;gpio5 8 GPIO_ACTIVE_LOW&gt;;
    phy-reset-duration = &lt;200&gt;;
    phy-reset-post-delay = &lt;100&gt;;
    status = "okay";    

    mdio {
        #address-cells = &lt;1&gt;;
        #size-cells = &lt;0&gt;;

        ethphy0: ethernet-phy@0 {
            compatible = "ethernet-phy-id0022.1560";
            reg = &lt;0&gt;;
            micrel,led-mode = &lt;1&gt;;
            clocks = &lt;&amp;clks IMX6UL_CLK_ENET_REF&gt;;
            clock-names = "rmii-ref";

        };

        ethphy1: ethernet-phy@1 {
            compatible = "ethernet-phy-id0022.1560";
            reg = &lt;1&gt;;
            micrel,led-mode = &lt;1&gt;;
            clocks = &lt;&amp;clks IMX6UL_CLK_ENET2_REF&gt;;
            clock-names = "rmii-ref";
        };
    };
};
*/
</code></pre> 
<h4 id="2.%E5%9C%A8fec1%20%E8%8A%82%E7%82%B9%E4%B8%8B%E6%B7%BB%E5%8A%A0%20mdio%20%E5%AD%90%E8%8A%82%E7%82%B9">2.在fec1 节点下添加 mdio 子节点</h4> 
<pre><code class="language-bash">&amp;fec1 {
    pinctrl-names = "default";
    pinctrl-0 = &lt;&amp;pinctrl_enet1&gt;;
    phy-mode = "rmii";
    phy-handle = &lt;&amp;ethphy0&gt;;
    phy-supply = &lt;&amp;reg_peri_3v3&gt;;
    phy-reset-gpios = &lt;&amp;gpio5 7 GPIO_ACTIVE_LOW&gt;;
    phy-reset-duration = &lt;100&gt;;
    phy-reset-post-delay = &lt;100&gt;;
    status = "okay";

    mdio {
        #address-cells = &lt;1&gt;;
        #size-cells = &lt;0&gt;;

        ethphy0: ethernet-phy@0 {
            compatible = "ethernet-phy-id0022.1560";
            reg = &lt;0&gt;;
            micrel,led-mode = &lt;1&gt;;
            clocks = &lt;&amp;clks IMX6UL_CLK_ENET_REF&gt;;
            clock-names = "rmii-ref";
        };
    };
};
</code></pre> 
<h4 id="3.%E6%B7%BB%E5%8A%A0MDIO%E5%92%8CMDC%E5%BC%95%E8%84%9A%E9%85%8D%E7%BD%AE">3.添加MDIO和MDC引脚配置</h4> 
<p>在 ENET1 网卡对应的 pinctrl 节点中添加 MDIO 和 MDC 引脚配置<br> 将 GPIO1_IO07 复用为 ENET1_MDC 引脚<br> 将 GPIO1_IO06 复用为 ENET1_MDIO 引脚</p> 
<pre><code class="language-bash">pinctrl_enet1: enet1grp {
    fsl,pins = &lt;
        MX6UL_PAD_GPIO1_IO07__ENET1_MDC     0x1b0b0
        MX6UL_PAD_GPIO1_IO06__ENET1_MDIO    0x1b0b0
        ...
        MX6UL_PAD_ENET1_TX_CLK__ENET1_REF_CLK1  0x4001b031
    &gt;;
};
</code></pre> 
<h4 id="4.%E4%BF%AE%E6%94%B9ENET%E8%AE%BE%E5%A4%87%E4%B8%BAenet0">4.修改ENET设备为enet0</h4> 
<p>在<span style="background-color:#ff9900;">include/configs/mu6ull_toto.h</span>中修改宏<span style="background-color:#ff9900;">CONFIG_FEC_ENET_DEV为0</span>，使用enet0</p> 
<pre><code class="language-bash">#ifdef CONFIG_CMD_NET
#define CONFIG_FEC_ENET_DEV     0
#endif
</code></pre> 
<p>编译下载重启开发板，打印信息如下；</p> 
<pre><code>U-Boot 2022.10-g8d3c4ea8-dirty (May 20 2023 - 14:19:23 +0800)
CPU:   Freescale i.MX6ULL rev1.1 792 MHz (running at 396 MHz)
CPU:   Industrial temperature grade (-40C to 105C) at 40C
Reset cause: WDOG
Model: Freescale i.MX6 UltraLiteLite 14x14 EVK Board
Board: MX6ULL TOTO
DRAM:  512 MiB
Core:  60 devices, 17 uclasses, devicetree: separate
MMC:   FSL_SDHC: 0, FSL_SDHC: 1
Loading Environment from MMC... OK
In:    serial
Out:   serial
Err:   serial
Net:   eth0: ethernet@2188000
Hit any key to stop autoboot:  0
=&gt;
=&gt; ping 192.168.0.106
Using ethernet@2188000 device
host 192.168.0.106 is alive
=&gt;
</code></pre> 
<p>        至此，imx6ull在uboot下FEC1和FEC2均可单独使用，感兴趣的朋友可以试一试uboot如何让fec1和fec2两个网卡同时工作。</p> 
<p>        imx6ll开发板u-boot下网络部分就讲到此处，后续有时间将对u-boot的启动流程进行详细梳理与讲解，关注我，后期文章及时观看！</p> 
<p>        本期的内容到这就结束了，如果觉得文章不错，可以点赞、收藏和关注哦，谢谢大家收看，下期再见！</p> 
<hr> 
<p><strong><strong>        关于更多嵌入式C语言、FreeRTOS、RT-Thread、Linux应用编程、linux驱动等相关知识，关注公众号【嵌入式Linux知识共享】，后续精彩内容及时收看了解。</strong></strong></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f3e58446a3d3296eb870e0f1a9076309/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【设备默认口令&#43;弱口令】大道至简</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7fc9c1a233bb61d173d3e383f1a44397/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Prometheus安装、配置、维护及日常使用</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>