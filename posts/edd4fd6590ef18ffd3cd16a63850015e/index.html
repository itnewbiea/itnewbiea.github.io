<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【C语言】动态内存管理详解 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【C语言】动态内存管理详解" />
<meta property="og:description" content="文章目录 前言动态内存管理出现的原因malloc函数和free函数函数原型使用 calloc函数和realloc函数函数原型使用 动态内存使用中容易出现的错误柔性数组总结 前言 提示：这里可以添加本文要记录的大概内容：
动态内存管理是C语言中一项重要的编程任务，它使得程序在运行时能够灵活地分配和释放内存，更好地适应不同的运行条件。通过动态内存管理，我们可以实现更高效、更灵活的内存使用方式，但也需要谨慎处理，避免内存泄漏和其他潜在问题。本篇博客将深入探讨C语言中的动态内存管理，探索其原理、使用方法以及注意事项。
提示：以下是本篇文章正文内容，下面案例可供参考
动态内存管理出现的原因 考虑以下场景，展示了动态内存管理解决实际问题的情况：
#include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; int main() { int *dynamicArray; int size; // 用户输入数组大小 printf(&#34;Enter the size of the array: &#34;); scanf(&#34;%d&#34;, &amp;size); // 动态分配内存 dynamicArray = (int *)malloc(size * sizeof(int)); // 检查内存是否分配成功 if (dynamicArray == NULL) { printf(&#34;Memory allocation failed.\n&#34;); return 1; } // 用户输入数组元素 printf(&#34;Enter %d integers:\n&#34;, size); for (int i = 0; i &lt; size; i&#43;&#43;) { scanf(&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/edd4fd6590ef18ffd3cd16a63850015e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-27T15:33:56+08:00" />
<meta property="article:modified_time" content="2023-12-27T15:33:56+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【C语言】动态内存管理详解</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_4" rel="nofollow">前言</a></li><li><a href="#_12" rel="nofollow">动态内存管理出现的原因</a></li><li><a href="#mallocfree_60" rel="nofollow">malloc函数和free函数</a></li><li><ul><li><a href="#_61" rel="nofollow">函数原型</a></li><li><a href="#_77" rel="nofollow">使用</a></li></ul> 
  </li><li><a href="#callocrealloc_148" rel="nofollow">calloc函数和realloc函数</a></li><li><ul><li><a href="#_149" rel="nofollow">函数原型</a></li><li><a href="#_168" rel="nofollow">使用</a></li></ul> 
  </li><li><a href="#_279" rel="nofollow">动态内存使用中容易出现的错误</a></li><li><a href="#_328" rel="nofollow">柔性数组</a></li><li><a href="#_380" rel="nofollow">总结</a></li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="_4"></a>前言</h2> 
<p><code>提示：这里可以添加本文要记录的大概内容：</code><br> 动态内存管理是C语言中一项重要的编程任务，它使得程序在运行时能够灵活地分配和释放内存，更好地适应不同的运行条件。通过动态内存管理，我们可以实现更高效、更灵活的内存使用方式，但也需要谨慎处理，避免内存泄漏和其他潜在问题。本篇博客将深入探讨C语言中的动态内存管理，探索其原理、使用方法以及注意事项。</p> 
<hr> 
<p><code>提示：以下是本篇文章正文内容，下面案例可供参考</code></p> 
<h2><a id="_12"></a>动态内存管理出现的原因</h2> 
<p><strong>考虑以下场景，展示了动态内存管理解决实际问题的情况：</strong></p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> <span class="token operator">*</span>dynamicArray<span class="token punctuation">;</span>
    <span class="token keyword">int</span> size<span class="token punctuation">;</span>

    <span class="token comment">// 用户输入数组大小</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Enter the size of the array: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 动态分配内存</span>
    dynamicArray <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>size <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 检查内存是否分配成功</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dynamicArray <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Memory allocation failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 用户输入数组元素</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Enter %d integers:\n"</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>dynamicArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 打印数组内容</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Array elements: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d "</span><span class="token punctuation">,</span> dynamicArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 释放动态分配的内存</span>
    <span class="token function">free</span><span class="token punctuation">(</span>dynamicArray<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在这个例子中，<code>用户输入数组大小，程序根据用户输入动态分配了一个整数数组</code>。用户可以根据实际需求输入不同大小的数组，而不受固定大小的限制。动态内存的分配和释放使得程序更加灵活，能够适应不同规模的数据处理需求。</p> 
<p>这是动态内存管理的一个实际应用，通过动态内存的灵活性，程序可以根据运行时的需求动态调整内存的大小，提高了程序的适应性和可扩展性。</p> 
<h2><a id="mallocfree_60"></a>malloc函数和free函数</h2> 
<h3><a id="_61"></a>函数原型</h3> 
<blockquote> 
 <p><code>malloc函数：void* malloc (size_t size);</code></p> 
</blockquote> 
<p><strong>malloc函数向内存申请一块连续可用的空间，并返回指向这块空间的指针。</strong></p> 
<ol><li>如果开辟成功，则返回一个指向开辟好空间的指针。</li><li>如果开辟失败，则返回一个<code>NULL</code>指针，因此malloc的返回值一定要做检查。</li><li>返回值类型是void*，所以malloc函数并不知道开辟空间的类型，具体在使用的时候使用者自行决定。</li><li>如果参数<code>size</code>为0，malloc的行为是标准未定义的，取决于编译器。</li></ol> 
<blockquote> 
 <p><code>free函数：void free (void* ptr);</code></p> 
</blockquote> 
<p><strong>free函数是用来释放动态开辟的内存</strong></p> 
<ol><li>如果参数<code>ptr</code>指向的空间不是动态开辟的，那么free函数的行为是未定义的。</li><li>如果参数<code>ptr</code>是NULL指针，则函数什么也不做。</li></ol> 
<h3><a id="_77"></a>使用</h3> 
<p><strong>动态内存管理示例：malloc 和 free 函数</strong></p> 
<p>在C语言中，<code>malloc</code> 和 <code>free</code> 函数的使用对于动态内存的分配和释放至关重要。下面通过一个详细的例子来说明它们的作用和使用。</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>

<span class="token comment">// 定义结构体用于存储学生信息</span>
<span class="token keyword">struct</span> <span class="token class-name">Student</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> name<span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> age<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 用户输入学生数量</span>
    <span class="token keyword">int</span> numStudents<span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Enter the number of students: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>numStudents<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 动态分配内存以存储学生信息</span>
    <span class="token keyword">struct</span> <span class="token class-name">Student</span> <span class="token operator">*</span>students <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Student</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>numStudents <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Student</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 检查内存是否分配成功</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>students <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Memory allocation failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 用户输入学生信息</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numStudents<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Enter name for student %d: "</span><span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> students<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Enter age for student %d: "</span><span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>students<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 打印学生信息</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nStudent Information:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numStudents<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Student %d:\n"</span><span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Name: %s\n"</span><span class="token punctuation">,</span> students<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Age: %d\n"</span><span class="token punctuation">,</span> students<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 释放动态分配的内存</span>
    <span class="token function">free</span><span class="token punctuation">(</span>students<span class="token punctuation">)</span><span class="token punctuation">;</span>
    students <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>步骤解析：</strong></p> 
<ol><li> <p><strong>用户输入学生数量：</strong> 通过 <code>scanf</code> 函数获取用户输入的学生数量。</p> </li><li> <p><strong>动态分配内存：</strong> 使用 <code>malloc</code> 函数分配足够存储学生信息的内存块。类型转换 <code>(struct Student *)</code> 是为了将返回的 <code>void</code> 指针转换为结构体指针。</p> </li><li> <p><strong>检查内存分配是否成功：</strong> 使用条件语句检查 <code>malloc</code> 是否成功分配了内存。如果分配失败，打印错误消息并退出程序。</p> </li><li> <p><strong>用户输入学生信息：</strong> 通过循环，用户逐个输入学生的姓名和年龄。</p> </li><li> <p><strong>打印学生信息：</strong> 通过循环，打印用户输入的学生信息。</p> </li><li> <p><strong>释放动态分配的内存：</strong> 使用 <code>free</code> 函数释放先前分配的内存，确保在不再需要时及时释放，防止内存泄漏。</p> </li></ol> 
<p><strong>这个例子演示了如何使用 <code>malloc</code> 和 <code>free</code> 动态地管理内存，使程序更具灵活性，能够适应不同数量的学生信息。</strong></p> 
<h2><a id="callocrealloc_148"></a>calloc函数和realloc函数</h2> 
<h3><a id="_149"></a>函数原型</h3> 
<blockquote> 
 <p><code>void* calloc (size_t num, size_t size);</code></p> 
</blockquote> 
<ol><li>函数的功能是为<code>num</code>个大小为size的元素开辟一块空间，并且把空间的每个字节初始化为0.</li><li>与函数<code>malloc</code>的区别只在于<code>calloc</code>会在返回地址之前把申请到的空间，每个字节都初始化为0.</li></ol> 
<blockquote> 
 <p><code>void* realloc (void* ptr,size_t size);</code></p> 
</blockquote> 
<ul><li>realloc函数的出现让动态内存管理更加灵活。</li><li>有时候我们会发现过去申请的空间太小了，或者发现申请的空间过大了，那么为了合理的使用内存空间，我们一定会<code>对内存的大小做灵活的调整</code>。那么<code>realloc</code>函数就可以做到对动态开辟的内存大小做调整。</li><li><code>ptr</code>是要调整的内存地址</li><li><code>size</code>调整之后新大小</li><li>返回值为调整之后的内存起始位置</li><li>这个函数调整原内存空间大小的基础上，还会将原来内存中的数据移动到<code>新</code>的空间。</li><li><code>realloc</code>在调整内存空间的时候存在两种情况： 
  <ul><li>情况1：原有空间之后有足够大的空间</li><li>原有空间之后没有足够大的空间</li></ul> </li></ul> 
<h3><a id="_168"></a>使用</h3> 
<p><strong>动态内存管理示例：calloc 和 realloc 函数</strong></p> 
<p>在C语言中，除了 <code>malloc</code> 和 <code>free</code> 外，还有 <code>calloc</code> 和 <code>realloc</code> 函数用于更灵活地进行内存分配和重新分配。下面通过一个详细的例子来说明它们的作用和使用。</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>

<span class="token comment">// 定义结构体用于存储学生信息</span>
<span class="token keyword">struct</span> <span class="token class-name">Student</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> name<span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> age<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 用户输入学生数量</span>
    <span class="token keyword">int</span> numStudents<span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Enter the number of students: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>numStudents<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 使用 calloc 分配并初始化存储学生信息的内存块</span>
    <span class="token keyword">struct</span> <span class="token class-name">Student</span> <span class="token operator">*</span>students <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Student</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">calloc</span><span class="token punctuation">(</span>numStudents<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Student</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 检查内存是否分配成功</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>students <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Memory allocation failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 用户输入学生信息</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numStudents<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Enter name for student %d: "</span><span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> students<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Enter age for student %d: "</span><span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>students<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 打印学生信息</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nStudent Information:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numStudents<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Student %d:\n"</span><span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Name: %s\n"</span><span class="token punctuation">,</span> students<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Age: %d\n"</span><span class="token punctuation">,</span> students<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 用户输入新的学生数量</span>
    <span class="token keyword">int</span> newNumStudents<span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Enter the new number of students: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>newNumStudents<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 使用 realloc 函数重新分配内存，适应新的学生数量</span>
    students <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Student</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">realloc</span><span class="token punctuation">(</span>students<span class="token punctuation">,</span> newNumStudents <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Student</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 检查内存重新分配是否成功</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>students <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Memory reallocation failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 用户输入新学生信息</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> numStudents<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> newNumStudents<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Enter name for new student %d: "</span><span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> students<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Enter age for new student %d: "</span><span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>students<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 打印更新后的学生信息</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nUpdated Student Information:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> newNumStudents<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Student %d:\n"</span><span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Name: %s\n"</span><span class="token punctuation">,</span> students<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Age: %d\n"</span><span class="token punctuation">,</span> students<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 释放动态分配的内存</span>
    <span class="token function">free</span><span class="token punctuation">(</span>students<span class="token punctuation">)</span><span class="token punctuation">;</span>
	students <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>步骤解析：</strong></p> 
<ol><li> <p><strong>用户输入学生数量：</strong> 通过 <code>scanf</code> 函数获取用户输入的学生数量。</p> </li><li> <p><strong>使用 calloc 分配并初始化内存块：</strong> 使用 <code>calloc</code> 函数分配足够存储学生信息的内存块，并将内存初始化为零。类型转换 <code>(struct Student *)</code> 是为了将返回的 <code>void</code> 指针转换为结构体指针。</p> </li><li> <p><strong>检查内存是否分配成功：</strong> 使用条件语句检查 <code>calloc</code> 是否成功分配了内存。如果分配失败，打印错误消息并退出程序。</p> </li><li> <p><strong>用户输入学生信息：</strong> 通过循环，用户逐个输入学生的姓名和年龄。</p> </li><li> <p><strong>打印学生信息：</strong> 通过循环，打印用户输入的学生信息。</p> </li><li> <p><strong>用户输入新的学生数量：</strong> 通过 <code>scanf</code> 函数获取用户输入的新学生数量。</p> </li><li> <p><strong>使用 realloc 函数重新分配内存：</strong> 使用 <code>realloc</code> 函数重新分配内存，适应新的学生数量。如果新的数量比原来的多，额外的内存空间将被初始化为零。</p> </li><li> <p><strong>检查内存重新分配是否成功：</strong> 使用条件语句检查 <code>realloc</code> 是否成功重新分配了内存。如果重新分配失败，打印错误消息并退出程序。</p> </li><li> <p><strong>用户输入新学生信息：</strong> 通过循环，用户逐个输入新学生的姓名和年龄。</p> </li><li> <p><strong>打印更新后的学生信息：</strong> 通过循环，打印更新后的学生信息。</p> </li><li> <p><strong>释放动态分配的内存：</strong> 使用 <code>free</code> 函数释放先前分配的内存，确保在程序结束时释放所有内存。</p> </li></ol> 
<p>这个例子展示了 <code>calloc</code> 和 <code>realloc</code> 的使用，以及如何在运行时适应不同数量的学生信息。</p> 
<h2><a id="_279"></a>动态内存使用中容易出现的错误</h2> 
<p>在动态内存管理中，一些常见的错误可能导致程序运行时出现问题，如内存泄漏、访问越界等。下面详细介绍这些错误，并给出相应的例子：</p> 
<ol><li> <p><strong>内存泄漏：</strong> 忘记释放已分配的内存，导致程序运行时持续占用内存而不释放。</p> <pre><code class="prism language-c"><span class="token comment">// 错误示例</span>
<span class="token keyword">int</span> <span class="token operator">*</span>arr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 忘记释放内存</span>
</code></pre> </li><li> <p><strong>重复释放：</strong> 多次释放同一块内存，可能导致程序崩溃或不可预测的行为。</p> <pre><code class="prism language-c"><span class="token comment">// 错误示例</span>
<span class="token keyword">int</span> <span class="token operator">*</span>arr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">free</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">free</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 重复释放相同的内存</span>
</code></pre> </li><li> <p><strong>使用已释放的内存：</strong> 在释放内存后，仍然尝试访问或修改已释放的内存。</p> <pre><code class="prism language-c"><span class="token comment">// 错误示例</span>
<span class="token keyword">int</span> <span class="token operator">*</span>arr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">free</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>  <span class="token comment">// 尝试访问已释放的内存</span>
</code></pre> </li><li> <p><strong>内存越界：</strong> 访问超出分配内存范围的位置，可能导致数据损坏或程序崩溃。</p> <pre><code class="prism language-c"><span class="token comment">// 错误示例</span>
<span class="token keyword">int</span> <span class="token operator">*</span>arr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
arr<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>  <span class="token comment">// 越界访问</span>
</code></pre> </li><li> <p><strong>使用未初始化的内存：</strong> 分配内存后，没有正确初始化就开始使用，导致未定义的行为。</p> <pre><code class="prism language-c"><span class="token comment">// 错误示例</span>
<span class="token keyword">int</span> <span class="token operator">*</span>arr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    sum <span class="token operator">+=</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 未初始化的内存访问</span>
<span class="token punctuation">}</span>
</code></pre> </li></ol> 
<p>这些错误在程序中可能导致严重的运行时问题，因此在动态内存管理时，务必注意正确地分配、使用和释放内存。使用 <code>valgrind</code> 等工具可以帮助检测和修复这些问题。</p> 
<h2><a id="_328"></a>柔性数组</h2> 
<p>柔性数组（Flexible Array Member）是C语言中结构体的一种特殊用法，它允许在结构体的末尾定义一个数组，该数组的大小在运行时确定。柔性数组的声明通常如下所示：</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">ExampleStruct</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 其他成员</span>
    <span class="token keyword">int</span> someMember<span class="token punctuation">;</span>
    
    <span class="token comment">// 柔性数组成员</span>
    <span class="token keyword">float</span> flexibleArray<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>在上面的示例中，<code>flexibleArray</code> 就是柔性数组成员。这个数组没有指定大小，而是留空。在使用柔性数组时，你可以根据需要动态分配内存。</p> 
<p><code>请注意以下几点：</code></p> 
<ol><li>柔性数组只能出现在结构体的最后一个成员位置。</li><li>结构体中至少要有一个非柔性数组的成员。</li><li>柔性数组的大小不能在结构体内部指定，而是在运行时根据实际需要分配。</li></ol> 
<p>使用柔性数组时，通常需要使用动态内存分配函数（如<code>malloc</code>）为柔性数组成员分配内存。示例代码如下：</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">ExampleStruct</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> someMember<span class="token punctuation">;</span>
    <span class="token keyword">float</span> flexibleArray<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 计算结构体总大小，包括柔性数组</span>
    <span class="token class-name">size_t</span> structSize <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ExampleStruct</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 分配内存</span>
    <span class="token keyword">struct</span> <span class="token class-name">ExampleStruct</span> <span class="token operator">*</span>example <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ExampleStruct</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>structSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 使用柔性数组</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        example<span class="token operator">-&gt;</span>flexibleArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i <span class="token operator">*</span> <span class="token number">1.5</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 释放内存</span>
    <span class="token function">free</span><span class="token punctuation">(</span>example<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上述代码演示了柔性数组的声明和使用。在实际应用中，需要根据具体需求选择是否使用柔性数组，并谨慎处理内存分配和释放的问题。</p> 
<h2><a id="_380"></a>总结</h2> 
<p>动态内存管理是C语言中一个强大而灵活的特性，通过它，我们可以在程序运行时动态分配和释放内存，更好地满足不同场景下的内存需求。在使用动态内存时，必须注意良好的管理原则，及时释放不再使用的内存，以防止内存泄漏和程序性能问题。总体而言，动态内存管理为C语言程序员提供了更大的灵活性和控制力。</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0cbee65f6aed275c4f1df2066f4c6a7d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">中医养生行业为何要搭建自己的知识付费小程序平台</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/41a12cd6794c31c6f83901c8d74c6079/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">onnxruntime 不使用 gpu</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>