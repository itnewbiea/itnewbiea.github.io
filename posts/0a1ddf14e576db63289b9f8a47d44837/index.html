<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>C#委托与事件 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="C#委托与事件" />
<meta property="og:description" content="1.什么是委托 委托是C#中的一个引用类型。它允许捕捉对方法的引用，并像传递其他对象那样传递该引用，也可以像调用其他方法一样调用被捕捉的方法。
声明委托需要使用delegate关键字：
// 声明委托 delegate string TestDelegate(int a, int b); public static void DelegatePracticeMain() { TestDelegate testDelegate = null; // 绑定方法 testDelegate = Test; // 执行方法 Console.WriteLine(testDelegate(10,20)); } public static string Test(int a, int b) { return $&#34;a &#43; b = {a &#43; b}&#34;; } 我们同样可以使用C#为我们声明好的委托System.Func和System.Action。其中，System.Func代表有返回值的方法，System.Action代表无返回值的方法。它们的使用方法如下：
public static string Test(int a, int b) { return $&#34;a &#43; b = {a &#43; b}&#34;; } public static void VoidTest(int a) { Console." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/0a1ddf14e576db63289b9f8a47d44837/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-17T14:03:57+08:00" />
<meta property="article:modified_time" content="2022-07-17T14:03:57+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">C#委托与事件</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="1_0"></a>1.什么是委托</h2> 
<p>委托是C#中的一个引用类型。它允许捕捉对方法的引用，并像传递其他对象那样传递该引用，也可以像调用其他方法一样调用被捕捉的方法。</p> 
<p>声明委托需要使用delegate关键字：</p> 
<pre><code class="prism language-csharp"><span class="token comment">// 声明委托</span>
<span class="token keyword">delegate</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">TestDelegate</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> a<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">DelegatePracticeMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token class-name">TestDelegate</span> testDelegate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token comment">// 绑定方法</span>
	testDelegate <span class="token operator">=</span> Test<span class="token punctuation">;</span>
	<span class="token comment">// 执行方法</span>
	Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token function">testDelegate</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">Test</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> a<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> b<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token interpolation-string"><span class="token string">$"a + b = </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">a <span class="token operator">+</span> b</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>我们同样可以使用C#为我们声明好的委托<code>System.Func</code>和<code>System.Action</code>。其中，<code>System.Func</code>代表有返回值的方法，<code>System.Action</code>代表无返回值的方法。它们的使用方法如下：</p> 
<pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">Test</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> a<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> b<span class="token punctuation">)</span>  
<span class="token punctuation">{<!-- --></span>  
    <span class="token keyword">return</span> <span class="token interpolation-string"><span class="token string">$"a + b = </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">a <span class="token operator">+</span> b</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
  
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">VoidTest</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> a<span class="token punctuation">)</span>  
<span class="token punctuation">{<!-- --></span>  
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"a is </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">a</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">DelegatePracticeMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  
<span class="token punctuation">{<!-- --></span>  
	<span class="token comment">// 最后一个参数为返回值类型</span>
    <span class="token class-name">Func<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> testFunc <span class="token operator">=</span> Test<span class="token punctuation">;</span>  
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token function">testFunc</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token class-name">Action<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span> testAct <span class="token operator">=</span> VoidTest<span class="token punctuation">;</span>  
    <span class="token function">testAct</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>
</code></pre> 
<p>通过实例化委托的方式向方法中传递委托的一个实例：</p> 
<pre><code class="prism language-csharp"><span class="token comment">/**  
 * Person比较方法  
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">PersonCompare</span><span class="token punctuation">(</span><span class="token class-name">Person</span> person1<span class="token punctuation">,</span> <span class="token class-name">Person</span> person2<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> person1<span class="token punctuation">.</span>Age <span class="token operator">&gt;</span> person2<span class="token punctuation">.</span>Age<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**  
 * 输出较大的对象  
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token generic-method"><span class="token function">PrintGreater</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">T</span> item1<span class="token punctuation">,</span><span class="token class-name">T</span> item2<span class="token punctuation">,</span><span class="token class-name">Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span>T<span class="token punctuation">,</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span> compare<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>compare<span class="token class-name"><span class="token punctuation">(</span>item1<span class="token punctuation">,</span> item2<span class="token punctuation">)</span> <span class="token punctuation">?</span></span> item1<span class="token punctuation">:</span>item2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Person</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Name <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> Age <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
	
	<span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token interpolation-string"><span class="token string">$"姓名:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Name</span><span class="token punctuation">}</span></span><span class="token string">,年龄:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Age</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">DelegatePracticeMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token class-name">Person</span> person1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>Age <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span> Name <span class="token operator">=</span> <span class="token string">"张三"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token class-name">Person</span> person2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>Age <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">,</span> Name <span class="token operator">=</span> <span class="token string">"李四"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token comment">// 向方法传递要委托的方法名</span>
	<span class="token function">PrintGreater</span><span class="token punctuation">(</span>person1<span class="token punctuation">,</span>person2<span class="token punctuation">,</span>PersonCompare<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="2_85"></a>2.委托的逆变和协变</h2> 
<p>.Net的委托类型不具备结构相等性。即无法将一个委托类型的对象引用转换成另一个不相关的委托类型。但可以通过创建新委托，并让它引用旧委托的Invoke方法实现。</p> 
<pre><code class="prism language-csharp"><span class="token keyword">delegate</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">Test1Delegate</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> a<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token keyword">delegate</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">Test2Delegate</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> a<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">DelegatePracticeMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token class-name">Test1Delegate</span> test1Delegate <span class="token operator">=</span> Test<span class="token punctuation">;</span>
	<span class="token comment">// 编译不通过</span>
	<span class="token comment">// Test2Delegate test2Delegate = test1Delegate;</span>
	<span class="token comment">// 编译通过</span>
	<span class="token class-name">Test2Delegate</span> test2Delegate <span class="token operator">=</span> test1Delegate<span class="token punctuation">.</span>Invoke<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>通过C#4.0添加的对可变性的支持，也可以实现某些委托类型之间的转换。C#提供的<code>System.Func</code>委托类型，参数类型使用了in修饰，结果类型使用了out修饰；<code>System.Action</code>的参数类型同样也使用了in修饰。这就意味着这两种委托类型是可以进行协变与逆变转换的：</p> 
<pre><code class="prism language-csharp"><span class="token comment">// 逆变</span>
<span class="token class-name">Action<span class="token punctuation">&lt;</span><span class="token keyword">object</span><span class="token punctuation">&gt;</span></span> objAction <span class="token operator">=</span> o <span class="token operator">=&gt;</span> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Action<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> strAction <span class="token operator">=</span> objAction<span class="token punctuation">;</span>

<span class="token comment">// 协变</span>
<span class="token class-name">Func<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> strFunc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">"strFunc"</span><span class="token punctuation">;</span>
<span class="token class-name">Func<span class="token punctuation">&lt;</span><span class="token keyword">object</span><span class="token punctuation">&gt;</span></span> objFunc <span class="token operator">=</span> strFunc<span class="token punctuation">;</span>

<span class="token comment">// 协变与逆变同时发生</span>
<span class="token class-name">Func<span class="token punctuation">&lt;</span><span class="token keyword">object</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> objStrFunc <span class="token operator">=</span> o <span class="token operator">=&gt;</span> o<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Func<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> <span class="token keyword">object</span><span class="token punctuation">&gt;</span></span> strObjFunc <span class="token operator">=</span> objStrFunc<span class="token punctuation">;</span>
</code></pre> 
<h2><a id="3_118"></a>3.多播委托</h2> 
<p>我们来设想一个场景：假设有一个恒温器，它连接了一台加热器和一台冷却器。当温度发生变化时，恒温器需要将温度变化发送给加热器和冷却器。该如何设计这几个类呢？其实这是一个典型的观察者模式的应用。而通过多播委托，我们可以很容易地实现这种设计模式。</p> 
<p>我们首先要定义出消息的订阅者，也就是加热器和冷却器：</p> 
<pre><code class="prism language-csharp"><span class="token comment">/**
 * 冷却器
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Cooler</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 设定温度</span>
	<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">float</span></span> Temperature <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token function">Cooler</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">float</span></span> ratedTemp<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		Temperature <span class="token operator">=</span> ratedTemp<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 温度改变事件</span>
	<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnTemperatureChanged</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">float</span></span> newTemp<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"冷却器："</span><span class="token operator">+</span><span class="token punctuation">(</span>newTemp <span class="token operator">&gt;</span> Temperature<span class="token punctuation">?</span> <span class="token string">"开"</span><span class="token punctuation">:</span><span class="token string">"关"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 加热器
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Heater</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 设定温度</span>
	<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">float</span></span> Temperature <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token function">Heater</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">float</span></span> ratedTemp<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		Temperature <span class="token operator">=</span> ratedTemp<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 温度改变事件</span>
	<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnTemperatureChanged</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">float</span></span> newTemp<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"加热器："</span><span class="token operator">+</span><span class="token punctuation">(</span>newTemp <span class="token operator">&lt;</span> Temperature<span class="token punctuation">?</span> <span class="token string">"开"</span><span class="token punctuation">:</span><span class="token string">"关"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>接下来就可以定义消息的发布者，也就是恒温器：</p> 
<pre><code class="prism language-csharp"><span class="token comment">/**
 * 恒温器
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Thermostat</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 当前温度</span>
	<span class="token keyword">private</span> <span class="token class-name"><span class="token keyword">float</span></span> _CurrentTemp<span class="token punctuation">;</span>

	<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">float</span></span> CurrentTemp
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">get</span> <span class="token operator">=&gt;</span> _CurrentTemp<span class="token punctuation">;</span>
		<span class="token keyword">set</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">value</span> <span class="token operator">!=</span> _CurrentTemp<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				_CurrentTemp <span class="token operator">=</span> <span class="token keyword">value</span><span class="token punctuation">;</span>
				<span class="token comment">// OnTemperatureChanged(value);</span>
				<span class="token comment">// 防止为空</span>
				OnTemperatureChanged<span class="token punctuation">?.</span><span class="token function">Invoke</span><span class="token punctuation">(</span><span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 委托</span>
	<span class="token keyword">public</span> <span class="token return-type class-name">Action<span class="token punctuation">&lt;</span><span class="token keyword">float</span><span class="token punctuation">&gt;</span><span class="token punctuation">?</span></span> OnTemperatureChanged <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在恒温器中定义了一个无返回值的，带一个float类型参数的委托。通过这个委托，就可以连接发布者和订阅者。在CurrentTemp属性的赋值方法中调用委托，即可向所有订阅者发送消息。</p> 
<pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">MultiDelegateMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token class-name">Thermostat</span> thermostat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Thermostat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">Heater</span> heater <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Heater</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">Cooler</span> cooler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Cooler</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 注册事件</span>
	thermostat<span class="token punctuation">.</span>OnTemperatureChanged <span class="token operator">+=</span> heater<span class="token punctuation">.</span>OnTemperatureChanged<span class="token punctuation">;</span>
	thermostat<span class="token punctuation">.</span>OnTemperatureChanged <span class="token operator">+=</span> cooler<span class="token punctuation">.</span>OnTemperatureChanged<span class="token punctuation">;</span>

	thermostat<span class="token punctuation">.</span>CurrentTemp <span class="token operator">=</span> <span class="token number">40</span><span class="token punctuation">;</span>
	thermostat<span class="token punctuation">.</span>CurrentTemp <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>当我们使用“+=”操作符时，它会获取第一个委托并将第二个委托添加到委托链。第一个委托方法返回后就会调用第二个委托。同理使用“-=”会从委托链中删除该委托。无论是“+”“-”还是它们的复合赋值版本“+=”“-=”，内部都是使用了静态方法<code>System.Delegate.Combine()</code>和<code>System.Delegate.Remove()</code>实现，它们会返回一个全新的多播委托——即原始的多播委托并不会受到影响。</p> 
<h4><a id="_213"></a>多播委托的内部机制</h4> 
<p>.Net的委托总是派生自<code>System.MulticastDelegate</code>类型，而<code>System.MulticastDelegate</code>又派生自<code>System.Delegate</code>。在<code>System.MulticastDelegate</code>中有一个非常重要的字段<code>_invocationList</code>，在<code>System.Delegate</code>中也有两个重要的字段<code>_target</code>和<code>_methodPtr</code>。当我们将方法的引用传递给一个委托的实例，它的<code>_methodPtr</code>字段会指向这个方法，<code>_target</code>字段会指向调用方法的类型实例，而<code>_invocationList</code>则被置空。当我们通过<code>+=</code>实现多播委托时，内部会调用<code>CombineImpl</code>方法，该方法会返回一个新的委托，这个新的委托<code>_invocationList</code>字段是一个数组，数组中的每个元素就是一个委托的实例。当调用多播委托时，数组中的实例会被顺序调用。下面引用另一个博客（<a href="https://www.cnblogs.com/sjr10/archive/2012/08/17/delegate_essence.html" rel="nofollow">原地址</a>）的一张示意图：</p> 
<p><img src="https://images2.imgbox.com/eb/72/CCfFxvcj_o.png" alt=""></p> 
<h2><a id="4_218"></a>4.事件</h2> 
<p>到目前为止，委托存在着两个重要的问题。</p> 
<p>（1）错误使用赋值操作符导致原本的委托链被覆盖</p> 
<pre><code class="prism language-csharp">thermostat<span class="token punctuation">.</span>OnTemperatureChanged <span class="token operator">+=</span> heater<span class="token punctuation">.</span>OnTemperatureChanged<span class="token punctuation">;</span>
<span class="token comment">// 错误使用了=,导致之前的委托链被覆盖</span>
thermostat<span class="token punctuation">.</span>OnTemperatureChanged <span class="token operator">=</span> cooler<span class="token punctuation">.</span>OnTemperatureChanged<span class="token punctuation">;</span>
</code></pre> 
<p>（2）在外部也可以调用委托</p> 
<pre><code class="prism language-csharp">thermostat<span class="token punctuation">.</span>OnTemperatureChanged <span class="token operator">+=</span> heater<span class="token punctuation">.</span>OnTemperatureChanged<span class="token punctuation">;</span>
thermostat<span class="token punctuation">.</span>OnTemperatureChanged <span class="token operator">+=</span> cooler<span class="token punctuation">.</span>OnTemperatureChanged<span class="token punctuation">;</span>

<span class="token comment">// thermostat.CurrentTemp = 40;</span>
<span class="token comment">// 原本当前温度改变时才会调用委托,但现在可以直接在外部调用委托</span>
thermostat<span class="token punctuation">.</span><span class="token function">OnTemperatureChanged</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>以上两个问题都是因为委托的封装不充分。而事件则解决了这些问题。要使用事件，我们只需要对原有的Thermostat类进行如下修改：</p> 
<pre><code class="prism language-csharp"><span class="token comment">/**
 * 恒温器
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Thermostat</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 当前温度</span>
	<span class="token keyword">private</span> <span class="token class-name"><span class="token keyword">float</span></span> _CurrentTemp<span class="token punctuation">;</span>

	<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">float</span></span> CurrentTemp
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">get</span> <span class="token operator">=&gt;</span> _CurrentTemp<span class="token punctuation">;</span>
		<span class="token keyword">set</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">value</span> <span class="token operator">!=</span> _CurrentTemp<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				_CurrentTemp <span class="token operator">=</span> <span class="token keyword">value</span><span class="token punctuation">;</span>
				<span class="token comment">// OnTemperatureChanged(value);</span>
				<span class="token comment">// 防止为空</span>
				OnTemperatureChanged<span class="token punctuation">?.</span><span class="token function">Invoke</span><span class="token punctuation">(</span><span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 委托</span>
	<span class="token comment">// public Action&lt;float&gt;? OnTemperatureChanged { get; set; }</span>
	<span class="token comment">// 事件</span>
	<span class="token keyword">public</span> <span class="token keyword">event</span> <span class="token class-name">Action<span class="token punctuation">&lt;</span><span class="token keyword">float</span><span class="token punctuation">&gt;</span></span> OnTemperatureChanged <span class="token operator">=</span> <span class="token keyword">delegate</span> <span class="token punctuation">{<!-- --></span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在上面的修改中，我们只是将原本的<code>OnTemperatureChanged</code>属性移除，并更换为event关键字修饰的字段，并将这个字段赋值为空白委托，用来防止委托为null时产生异常。修改完成后，在外部就无法直接调用<code>OnTemperatureChanged</code>委托，同时也无法使用<code>=</code>符进行直接赋值。</p> 
<pre><code class="prism language-csharp"><span class="token comment">// 编译不通过</span>
thermostat<span class="token punctuation">.</span><span class="token function">OnTemperatureChanged</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
thermostat<span class="token punctuation">.</span>OnTemperatureChanged <span class="token operator">=</span> cooler<span class="token punctuation">.</span>OnTemperatureChanged<span class="token punctuation">;</span>
</code></pre> 
<p>在实际的事件编程中，我们一般使用<code>EventHandler&lt;&gt;</code>来代替<code>Action&lt;&gt;</code>，目的是遵循标准的C#编程规范。<code>EventHandler&lt;&gt;</code>提供了两个参数<code>(object? sender, TEventArgs e)</code>，前者代表事件的发布者，后者代表事件参数。当一个订阅者方法注册了多个事件时，将发布者作为参数传入就可以判断出具体是哪个实例触发了事件。第二个事件参数是<code>System.EventArgs</code>类型或从<code>System.EventArgs</code>派生的类型，但包含事件附加数据。<code>System.EventArgs</code>唯一重要的属性是Empty，用于指出“没有事件数据”。</p> 
<pre><code class="prism language-csharp"><span class="token comment">// 事件数据</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TemperatureArgs</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">EventArgs</span></span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">float</span></span> NewTemp <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token function">TemperatureArgs</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">float</span></span> temperature<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		NewTemp <span class="token operator">=</span> temperature<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 事件</span>
<span class="token keyword">public</span> <span class="token keyword">event</span> <span class="token class-name">EventHandler<span class="token punctuation">&lt;</span>TemperatureArgs<span class="token punctuation">&gt;</span></span> OnTemperatureChanged <span class="token operator">=</span> <span class="token keyword">delegate</span> <span class="token punctuation">{<!-- --></span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-csharp"><span class="token comment">// 调用时将sender指定为容器类</span>
OnTemperatureChanged<span class="token punctuation">?.</span><span class="token function">Invoke</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">TemperatureArgs</span><span class="token punctuation">(</span><span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="_300"></a>事件的内部机制</h4> 
<p>C#编译器获取带有event关键字修饰的public委托变量后，会在内部将委托声明为private，并添加两个方法和两个特殊事件块。下面是与CIL等价的C#代码：</p> 
<p><img src="https://images2.imgbox.com/dd/a8/9U7RtT0m_o.png" alt="图片来自《C#本质论》"></p> 
<p>两个方法<code>add_OnTemperatureChange()</code>和<code>remove_OnTemperatureChange()</code>分别实现了“+=”和“-=”操作符。下面的两个特殊事件块语法与C#实现属性时创建的代码语法类似，负责调用add和remove方法。</p> 
<p>基于此我们可以实现自定义的事件，可以将内部的委托设置为protected而不是private，也可以添加自定义的add和remove块：</p> 
<pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">event</span> <span class="token return-type class-name">EventHandler<span class="token punctuation">&lt;</span>TemperatureArgs<span class="token punctuation">&gt;</span></span> OnTemperatureChanged  
<span class="token punctuation">{<!-- --></span>  
    <span class="token keyword">add</span>  
    <span class="token punctuation">{<!-- --></span>  
        _OnTemperatureChanged <span class="token operator">=</span> <span class="token punctuation">(</span>EventHandler<span class="token operator">&lt;</span>TemperatureArgs<span class="token operator">&gt;</span><span class="token punctuation">)</span>Delegate<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span><span class="token keyword">value</span><span class="token punctuation">,</span> _OnTemperatureChanged<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
    <span class="token keyword">remove</span>  
    <span class="token punctuation">{<!-- --></span>  
        _OnTemperatureChanged <span class="token operator">=</span> <span class="token punctuation">(</span>EventHandler<span class="token operator">&lt;</span>TemperatureArgs<span class="token operator">&gt;</span><span class="token punctuation">)</span>Delegate<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>_OnTemperatureChanged<span class="token punctuation">,</span> <span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>  
<span class="token keyword">protected</span> <span class="token class-name">EventHandler<span class="token punctuation">&lt;</span>TemperatureArgs<span class="token punctuation">&gt;</span><span class="token punctuation">?</span></span> _OnTemperatureChanged<span class="token punctuation">;</span>
</code></pre>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/38efda1545381c3d239e156a12ec9592/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">python数据分析-因子分析（转载）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/38211d19469d1227994cad714f82ef45/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">全栈开发实战 | SSM框架整合完整教程</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>