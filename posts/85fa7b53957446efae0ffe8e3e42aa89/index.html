<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>mysql通过xbk备份快速进行大数据量搭建gtid主从 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="mysql通过xbk备份快速进行大数据量搭建gtid主从" />
<meta property="og:description" content="mysql通过xbk备份进行搭建gtid主从
注意点：新的从配置要跟主基本上相同，除了server_id，
master：192.128.232.130
slave：192.128.232.127
1：master操作，操作复制用户，如果存在，就无需创建。
(root@localhostostname) [(none)] CREATE USER &#39;repls&#39;@&#39;192.128.232.%&#39; IDENTIFIED BY &#39;repl123456&#39;;
Query OK, 0 rows affected (1.82 sec)
(root@localhostostname) [(none)] GRANT REPLICATION SLAVE ON *.* TO &#39;repls&#39;@&#39;192.128.232.%&#39;;
Query OK, 0 rows affected (0.06 sec)
2.master使用xbk全量备份，如果用增量，那就先全部合并后，再使用，这里不详细了，以最新的全量备份为准。--no-timestamp 自定义备份名称。
[root@mysql-130 full]# innobackupex --user=root --password=1111aaA_ -S /tmp/mysql.sock --no-timestamp /tmp/full
210818 15:30:35 [00] ...done
xtrabackup: Transaction log of lsn (4051579) to (4051588) was copied.
210818 15:30:35 completed OK! #表示备份ok
3.master把备份文件拷贝到slave上
[root@mysql-130 tmp]# tar -zcf full." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/85fa7b53957446efae0ffe8e3e42aa89/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-08-18T17:25:58+08:00" />
<meta property="article:modified_time" content="2021-08-18T17:25:58+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">mysql通过xbk备份快速进行大数据量搭建gtid主从</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>mysql通过xbk备份进行搭建gtid主从</p> 
<p>注意点：新的从配置要跟主基本上相同，除了server_id，</p> 
<p>master：192.128.232.130<br> slave：192.128.232.127</p> 
<p>1：master操作，操作复制用户，如果存在，就无需创建。<br> (root@localhostostname) [(none)] CREATE USER 'repls'@'192.128.232.%' IDENTIFIED BY 'repl123456';<br> Query OK, 0 rows affected (1.82 sec)</p> 
<p>(root@localhostostname) [(none)] GRANT REPLICATION SLAVE ON *.* TO 'repls'@'192.128.232.%';<br> Query OK, 0 rows affected (0.06 sec)</p> 
<p>2.master使用xbk全量备份，如果用增量，那就先全部合并后，再使用，这里不详细了，以最新的全量备份为准。--no-timestamp 自定义备份名称。</p> 
<p>[root@mysql-130 full]# innobackupex --user=root --password=1111aaA_ -S /tmp/mysql.sock  --no-timestamp /tmp/full<br> 210818 15:30:35 [00]        ...done<br> xtrabackup: Transaction log of lsn (4051579) to (4051588) was copied.<br> 210818 15:30:35 completed OK!    #表示备份ok</p> 
<p><br> 3.master把备份文件拷贝到slave上<br> [root@mysql-130 tmp]# tar -zcf full.tar.gz full<br> [root@mysql-130 backup]# scp full.tar.gz 192.128.232.127:/tmp/</p> 
<p>4.slave进行解压，<br> [root@keepalived-127 tmp]# mkdir /backup<br> [root@keepalived-127 tmp]# cp full.tar.gz /backup/<br> [root@keepalived-127 tmp]# cd /backup/<br> [root@keepalived-127 backup]# tar -zxf full.tar.gz<br> [root@keepalived-127 backup]# cd full<br> [root@keepalived-127 full]# ll<br> 总用量 12340<br> -rw-r----- 1 root root      426 8月  18 15:30 backup-my.cnf<br> drwxr-x--- 2 root root       48 8月  18 15:30 haha<br> -rw-r----- 1 root root      321 8月  18 15:30 ib_buffer_pool<br> -rw-r----- 1 root root 12582912 8月  18 15:30 ibdata1<br> drwxr-x--- 2 root root       20 8月  18 15:30 jiji<br> drwxr-x--- 2 root root     4096 8月  18 15:30 mysql<br> drwxr-x--- 2 root root     8192 8月  18 15:30 performance_schema<br> drwxr-x--- 2 root root     8192 8月  18 15:30 sys<br> drwxr-x--- 2 root root       48 8月  18 15:30 world<br> -rw-r----- 1 root root      114 8月  18 15:30 xtrabackup_binlog_info<br> -rw-r----- 1 root root      113 8月  18 15:30 xtrabackup_checkpoints<br> -rw-r----- 1 root root      606 8月  18 15:30 xtrabackup_info<br> -rw-r----- 1 root root     2560 8月  18 15:30 xtrabackup_logfile</p> 
<p>#上面文件进行简单详解<br> xtrabackup_binlog_info　　　　　　# 能帮助我们确认binlog的起点<br> xtrabackup_checkpoints　　　　　　# 通过lsn号确认操作是否正常<br> xtrabackup_info　　　　　　　　　 #所有备份信息，一般不怎么关注这个<br> xtrabackup_logfile　　　　　　　　# 记录备份过程中的redo和undo文件，不用关注，也看不懂<br> xtrabackup_binlog_pos_innodb      # 记录内容相比第1个少了gtid号</p> 
<p><br> 解析：<br> xtrabackup_binlog_info ：（备份时刻的binlog位置）<br> [root@keepalived-127 mysql_data]# cat xtrabackup_binlog_info<br> mysql-binlog.000001     858     d3244a79-f8c1-11eb-b1d2-000c29f53b87:1-2<br> 记录的是备份时刻，binlog的文件名字和当时的结束的position，可以用来作为截取binlog时的起点。</p> 
<p>[root@keepalived-127 mysql_data]# cat xtrabackup_checkpoints<br> backup_type = full-backuped<br> from_lsn = 0            上次所到达的LSN号(对于全备就是从0开始,对于增量备份显示的是上次结束的last_lsn号减去9)<br> to_lsn = 160683027      备份开始时间(ckpt)点数据页的LSN    <br> last_lsn = 160683036    备份结束后，redo日志最终的LSN， 如果to和last数值差9个，可认为是一致的，这9个在5.7中是预留的，当做增量备份时会接27来进行<br> compact = 0<br> recover_binlog_info = 0<br> （1）备份时刻，立即将已经commit过的，内存中的数据页刷新到磁盘(CKPT).开始备份数据，数据文件的LSN会停留在to_lsn位置。<br> （2）备份时刻有可能会有其他的数据写入，已备走的数据文件就不会再发生变化了。<br> （3）在备份过程中，备份软件会一直监控着redo的undo，如果一旦有变化会将日志也一并备走，并记录LSN到last_lsn。<br> 从to_lsn  ----》last_lsn 就是，备份过程中产生的数据变化.</p> 
<p><br> 5.slave准备备份（Prepared）<br> 将redo进行重做，已提交的写到数据文件，未提交的使用undo回滚掉。模拟了CSR的过程<br> [root@keepalived-127 backup]# innobackupex --apply-log /backup/full<br> InnoDB: Shutdown completed; log sequence number 4052008<br> 210818 15:56:33 completed OK!</p> 
<p>6.slave恢复备份<br> 前提：<br> 1、被恢复的目录是空<br> 2、被恢复的数据库的实例是关闭</p> 
<p>#停止mysql服务<br> [root@keepalived-127 backup]# /etc/init.d/mysqld stop<br> Shutting down MySQL.... SUCCESS!</p> 
<p>#移除mysql的数据目录<br> [root@keepalived-127 data]# mv /data/mysql_data /tmp/</p> 
<p>#把xbk备份准备好的文件拷贝到/data/mysql_data 这个目录下。<br> [root@keepalived-127 data]# mv /backup/full /data/mysql_data<br> [root@keepalived-127 data]# chown -R mysql.mysql /data/mysql_data</p> 
<p>#启动slave的mysql服务<br> [root@keepalived-127 data]# /etc/init.d/mysqld start<br> Starting MySQL.Logging to '/data/mysql_data/error.log'.<br> ......................... SUCCESS!</p> 
<p>#配置gtid主从复制，在从库上将上一步获取到的这些gtid purge掉，因为这些实际上已经执行过了事务id。<br> [root@keepalived-127 mysql_data]# cat /data/mysql_data/xtrabackup_binlog_info<br> mysql-binlog.000001     858     d3244a79-f8c1-11eb-b1d2-000c29f53b87:1-2</p> 
<p>#重新配置slave<br> (root@localhostostname) [(none)] stop slave;<br> Query OK, 0 rows affected (0.00 sec)</p> 
<p>(root@localhostostname) [(none)] reset slave;<br> Query OK, 0 rows affected (0.01 sec)</p> 
<p>(root@localhostostname) [(none)] stop slave;<br> Query OK, 0 rows affected, 1 warning (0.00 sec)</p> 
<p>#重新连接master，这里需要注意的是，上面的/data/mysql_data/xtrabackup_binlog_info里面执行过了gtid是1-2这个事务id，因此要slave需要从事务id为3开始拉去master数据，<br> (root@localhostostname) [(none)] change master to master_host='192.128.232.130',master_user='repls',master_password='repl123456',master_port=3306,master_auto_position=3;<br> Query OK, 0 rows affected, 2 warnings (0.01 sec)</p> 
<p>(root@localhostostname) [(none)] start slave;<br> Query OK, 0 rows affected (0.05 sec)</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/a7/bb/JiTbsASw_o.png"></p> 
<p></p> 
<p>(root@localhostostname) [(none)] show slave status\G;</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/99/db/yYE5G31B_o.png"></p> 
<p style="text-align:center;"></p> 
<p></p> 
<p>7.重新测试主从复制<br> #master在haha库里创建一个表</p> 
<p>(root@localhostostname) [haha] create table h2 (id int);<br> Query OK, 0 rows affected (0.20 sec)</p> 
<p>#slave查看是否有同步<br> (root@localhostostname) [(none)] use haha;<br> Database changed<br> (root@localhostostname) [haha] show tables;<br> +----------------+<br> | Tables_in_haha |<br> +----------------+<br> | h1             |<br> | h2             |<br> +----------------+<br> 2 rows in set (0.00 sec)</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/345e280622e1239bb3319d2137892060/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">k8s中yaml文件详解</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b94cb7325a1d798344bca4d2172d9013/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">网络层协议</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>