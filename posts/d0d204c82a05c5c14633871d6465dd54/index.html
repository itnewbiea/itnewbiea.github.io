<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>RT-Thread学习1-tcp_modbus - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="RT-Thread学习1-tcp_modbus" />
<meta property="og:description" content="RT-Thread Studio实现以太网modbus功能：
1.创建芯片对应工程，STM32F407VGT6,这个网络很多。
2.添加文件stm32f4xx_hal_msp.c
3.stm32f4xx_hal_msp.c添加以太网管脚驱动代码,通过STM32CubeMX生成或直接在官网例程中复制。
管脚操作，包含文件：#include &lt;rtdevice.h&gt;
#ifdef BSP_USING_ETH #define RESET_IO GET_PIN(C, 0) void phy_reset(void) { rt_pin_mode(RESET_IO, PIN_MODE_OUTPUT); rt_pin_write(RESET_IO, PIN_HIGH); rt_thread_mdelay(50); rt_pin_write(RESET_IO, PIN_LOW); rt_thread_mdelay(50); rt_pin_write(RESET_IO, PIN_HIGH); } /** * @brief ETH MSP Initialization * This function configures the hardware resources used in this example * @param heth: ETH handle pointer * @retval None */ void HAL_ETH_MspInit(ETH_HandleTypeDef* heth) { GPIO_InitTypeDef GPIO_InitStruct = {0}; if(heth-&gt;Instance==ETH) { /* USER CODE BEGIN ETH_MspInit 0 */ /* USER CODE END ETH_MspInit 0 */ /* Peripheral clock enable */ __HAL_RCC_ETH_CLK_ENABLE(); __HAL_RCC_GPIOC_CLK_ENABLE(); __HAL_RCC_GPIOA_CLK_ENABLE(); __HAL_RCC_GPIOG_CLK_ENABLE(); /**ETH GPIO Configuration PC1 ------&gt; ETH_MDC PA1 ------&gt; ETH_REF_CLK PA2 ------&gt; ETH_MDIO PA7 ------&gt; ETH_CRS_DV PC4 ------&gt; ETH_RXD0 PC5 ------&gt; ETH_RXD1 PG11 ------&gt; ETH_TX_EN PG13 ------&gt; ETH_TXD0 PG14 ------&gt; ETH_TXD1 */ GPIO_InitStruct." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/d0d204c82a05c5c14633871d6465dd54/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-11-20T10:14:56+08:00" />
<meta property="article:modified_time" content="2020-11-20T10:14:56+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">RT-Thread学习1-tcp_modbus</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>RT-Thread Studio实现以太网modbus功能：</p> 
<p>1.创建芯片对应工程，STM32F407VGT6,这个网络很多。</p> 
<p>2.添加文件stm32f4xx_hal_msp.c</p> 
<p><img alt="" src="https://images2.imgbox.com/e3/c0/kE43XiB7_o.png"></p> 
<p>3.stm32f4xx_hal_msp.c添加以太网管脚驱动代码,通过STM32CubeMX生成或直接在官网例程中复制。</p> 
<p>  管脚操作，包含文件：#include &lt;rtdevice.h&gt;</p> 
<pre><code>#ifdef  BSP_USING_ETH

#define RESET_IO GET_PIN(C, 0)

void phy_reset(void)
{
    rt_pin_mode(RESET_IO, PIN_MODE_OUTPUT);
    rt_pin_write(RESET_IO, PIN_HIGH);
    rt_thread_mdelay(50);
    rt_pin_write(RESET_IO, PIN_LOW);
    rt_thread_mdelay(50);
    rt_pin_write(RESET_IO, PIN_HIGH);
}
/**
* @brief ETH MSP Initialization
* This function configures the hardware resources used in this example
* @param heth: ETH handle pointer
* @retval None
*/
void HAL_ETH_MspInit(ETH_HandleTypeDef* heth)
{
  GPIO_InitTypeDef GPIO_InitStruct = {0};
  if(heth-&gt;Instance==ETH)
  {
  /* USER CODE BEGIN ETH_MspInit 0 */

  /* USER CODE END ETH_MspInit 0 */
    /* Peripheral clock enable */
    __HAL_RCC_ETH_CLK_ENABLE();
  
    __HAL_RCC_GPIOC_CLK_ENABLE();
    __HAL_RCC_GPIOA_CLK_ENABLE();
    __HAL_RCC_GPIOG_CLK_ENABLE();
    /**ETH GPIO Configuration    
    PC1     ------&gt; ETH_MDC
    PA1     ------&gt; ETH_REF_CLK
    PA2     ------&gt; ETH_MDIO
    PA7     ------&gt; ETH_CRS_DV
    PC4     ------&gt; ETH_RXD0
    PC5     ------&gt; ETH_RXD1
    PG11     ------&gt; ETH_TX_EN
    PG13     ------&gt; ETH_TXD0
    PG14     ------&gt; ETH_TXD1 
    */
    GPIO_InitStruct.Pin = GPIO_PIN_1|GPIO_PIN_4|GPIO_PIN_5;
    GPIO_InitStruct.Mode = GPIO_MODE_AF_PP;
    GPIO_InitStruct.Pull = GPIO_NOPULL;
    GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_VERY_HIGH;
    GPIO_InitStruct.Alternate = GPIO_AF11_ETH;
    HAL_GPIO_Init(GPIOC, &amp;GPIO_InitStruct);

    GPIO_InitStruct.Pin = GPIO_PIN_1|GPIO_PIN_2|GPIO_PIN_7;
    GPIO_InitStruct.Mode = GPIO_MODE_AF_PP;
    GPIO_InitStruct.Pull = GPIO_NOPULL;
    GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_VERY_HIGH;
    GPIO_InitStruct.Alternate = GPIO_AF11_ETH;
    HAL_GPIO_Init(GPIOA, &amp;GPIO_InitStruct);

    GPIO_InitStruct.Pin = GPIO_PIN_11|GPIO_PIN_13|GPIO_PIN_14;
    GPIO_InitStruct.Mode = GPIO_MODE_AF_PP;
    GPIO_InitStruct.Pull = GPIO_NOPULL;
    GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_VERY_HIGH;
    GPIO_InitStruct.Alternate = GPIO_AF11_ETH;
    HAL_GPIO_Init(GPIOG, &amp;GPIO_InitStruct);

    /* ETH interrupt Init */
    HAL_NVIC_SetPriority(ETH_IRQn, 0, 0);
    HAL_NVIC_EnableIRQ(ETH_IRQn);
  /* USER CODE BEGIN ETH_MspInit 1 */

  /* USER CODE END ETH_MspInit 1 */
  }

}

#endif</code></pre> 
<p>4.开启以太网接口与以太网库文件：</p> 
<p>  board.h文件中，以太网PHY芯片按需求选择。</p> 
<pre><code>#define BSP_USING_ETH
#ifdef BSP_USING_ETH
#define PHY_USING_LAN8720A
/*#define PHY_USING_DM9161CEP*/
/*#define PHY_USING_DP83848C*/
#endif</code></pre> 
<p>stm32f4xx_hal_conf.h文件中打开库文件调用使能：#define HAL_ETH_MODULE_ENABLED</p> 
<p>5.双击1，在右边单击2，选择lwip，在3不要DHCP自动分配IP，选择4固定IP，更改需要的IP地址。保存配置，编译、下载程序到控制板，ping包OK。</p> 
<p><img alt="" src="https://images2.imgbox.com/5c/70/bISaWV25_o.png"><img alt="" src="https://images2.imgbox.com/4d/c4/Z5UJcG4W_o.png"></p> 
<p>6。软件包中心，搜索modbus,我选择的是libmodbus添加，</p> 
<p>.<img alt="" src="https://images2.imgbox.com/5b/95/tSlHKwrK_o.png"></p> 
<p>7.添加后点右键查看软件包详细信息，选择tcp mdde,使能示例程序，保存后会下载软件包，左边自动出现程序。</p> 
<p><img alt="" src="https://images2.imgbox.com/06/a3/E5UGMBP2_o.png"></p> 
<p>8.打开modbus_tcp_test.c程序，static void test_thread(void *param)函数中ctx = modbus_new_tcp(RT_NULL, 502, AF_INET);502是以太网连接端口，打开modbus poll软件测试通过。</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/408c5b6da8e2a850d41aae4d13fe651a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">秀米复制到公众号格式变了_如何从微信公众号下载MP4格式的视频</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9c15978e7b071f1aa12e1a9e691f1967/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Linux使用rmp安装tree</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>