<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>OpenWrt21 EC20 R2.0驱动添加 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="OpenWrt21 EC20 R2.0驱动添加" />
<meta property="og:description" content="1、OpenWrt21内核版本为5.4，EC20R2.0的VID、PID为0x2C7C, 0x0125，可以使用qmi拨号或者ppp拨号 2、内核修改 1、修改USB串口驱动 File : [KERNEL]/drivers/usb/serial/option.c
static const struct usb_device_id option_ids[] = { #if 1 //Added by Quectel { USB_DEVICE(0x05C6, 0x9090) }, /* Quectel UC15 */ { USB_DEVICE(0x05C6, 0x9003) }, /* Quectel UC20 */ { USB_DEVICE(0x05C6, 0x9215) }, /* Quectel EC20 */ { USB_DEVICE(0x2C7C, 0x0125) }, /* Quectel EC25/EC20 R2.0 */ { USB_DEVICE(0x2C7C, 0x0121) }, /* Quectel EC21 */ #endif 2.1、添加零包处理 File:[KERNEL]/drivers/usb/serial/usb_wwan.c
static struct urb*usb_wwan_setup_urb(struct usb_serial *serial, int endpoint, int dir, void *ctx, char *buf, int len,void(*callback) (struct urb *)) { …… #if 1 //Added by Quectelfor Zero Packet if (dir == USB_DIR_OUT) { struct usb_device_descriptor*desc = &amp;serial-&gt;dev-&gt;descriptor; if (desc-&gt;idVendor ==cpu_to_le16(0x05C6) &amp;&amp; desc-&gt;idProduct == cpu_to_le16(0x9090)) urb-&gt;transfer_flags|= URB_ZERO_PACKET; if (desc-&gt;idVendor ==cpu_to_le16(0x05C6) &amp;&amp; desc-&gt;idProduct == cpu_to_le16(0x9003)) urb-&gt;transfer_flags|= URB_ZERO_PACKET; if (desc-&gt;idVendor ==cpu_to_le16(0x05C6) &amp;&amp; desc-&gt;idProduct == cpu_to_le16(0x9215)) urb-&gt;transfer_flags|= URB_ZERO_PACKET; if (desc-&gt;idVendor ==cpu_to_le16(0x2C7C)) urb-&gt;transfer_flags|= URB_ZERO_PACKET; } #endif return urb; } 2." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/b1de47e2f966e240a28835fb144f4085/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-01T16:07:06+08:00" />
<meta property="article:modified_time" content="2022-04-01T16:07:06+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">OpenWrt21 EC20 R2.0驱动添加</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2>1、OpenWrt21内核版本为5.4，EC20R2.0的VID、PID为0x2C7C, 0x0125，可以使用qmi拨号或者ppp拨号</h2> 
<h2>2、内核修改</h2> 
<h3>        1、修改USB串口驱动</h3> 
<p>                File : [KERNEL]/drivers/usb/serial/option.c</p> 
<pre><code>static const struct usb_device_id option_ids[] = {
#if 1 //Added by Quectel
	{ USB_DEVICE(0x05C6, 0x9090) }, /* Quectel UC15 */
	{ USB_DEVICE(0x05C6, 0x9003) }, /* Quectel UC20 */
	{ USB_DEVICE(0x05C6, 0x9215) }, /* Quectel EC20 */
	{ USB_DEVICE(0x2C7C, 0x0125) }, /* Quectel EC25/EC20 R2.0 */
	{ USB_DEVICE(0x2C7C, 0x0121) }, /* Quectel EC21 */
#endif</code></pre> 
<h3>        2.1、添加零包处理</h3> 
<p>                File:[KERNEL]/drivers/usb/serial/usb_wwan.c</p> 
<pre><code>static struct urb*usb_wwan_setup_urb(struct usb_serial *serial, int endpoint,
int dir, void *ctx, char *buf, int len,void(*callback) (struct urb *))
{
……
#if 1 //Added by Quectelfor Zero Packet
	if (dir == USB_DIR_OUT) {
		struct usb_device_descriptor*desc = &amp;serial-&gt;dev-&gt;descriptor;
		if (desc-&gt;idVendor ==cpu_to_le16(0x05C6) &amp;&amp; desc-&gt;idProduct == cpu_to_le16(0x9090))
			urb-&gt;transfer_flags|= URB_ZERO_PACKET;
		if (desc-&gt;idVendor ==cpu_to_le16(0x05C6) &amp;&amp; desc-&gt;idProduct == cpu_to_le16(0x9003))
			urb-&gt;transfer_flags|= URB_ZERO_PACKET;
		if (desc-&gt;idVendor ==cpu_to_le16(0x05C6) &amp;&amp; desc-&gt;idProduct == cpu_to_le16(0x9215))
			urb-&gt;transfer_flags|= URB_ZERO_PACKET;
		if (desc-&gt;idVendor ==cpu_to_le16(0x2C7C))
			urb-&gt;transfer_flags|= URB_ZERO_PACKET;
 
}
#endif
	return urb;
}</code></pre> 
<h3>        2.2、<strong>Add Reset Resume</strong></h3> 
<p><strong>                </strong>File: [KERNEL]/drivers/usb/serial/option.c</p> 
<pre><code>static struct usb_serial_driveroption_1port_device = {
……

#ifdef CONFIG_PM
	.suspend           = usb_wwan_suspend,
	.resume            = usb_wwan_resume,
#if 1 //Added by Quectel
	.reset_resume 	   = usb_wwan_resume,
#endif
#endif
}</code></pre> 
<h3>        2.3、<strong>Use GobiNet or QMI WWAN</strong></h3> 
<p><strong>                </strong>File: [KERNEL]/drivers/usb/serial/option.c</p> 
<pre><code>static int option_probe(struct usb_serial*serial, const struct usb_device_id *id) {
struct usb_wwan_intf_private *data;
……

#if 1 //Added by Quectel
	//Quectel UC20'sinterface 4 can be used as USB Network device
	if (serial-&gt;dev-&gt;descriptor.idVendor  == cpu_to_le16(0x05C6)  &amp;&amp;
			serial-&gt;dev-&gt;descriptor.idProduct ==cpu_to_le16(0x9003)
			&amp;&amp;serial-&gt;interface-&gt;cur_altsetting-&gt;desc.bInterfaceNumber &gt;= 4)
		return -ENODEV;
	//Quectel EC20's interface4 can be used as USB Network device
	if (serial-&gt;dev-&gt;descriptor.idVendor  == cpu_to_le16(0x05C6)  &amp;&amp;
			serial-&gt;dev-&gt;descriptor.idProduct== cpu_to_le16(0x9215)
			&amp;&amp;serial-&gt;interface-&gt;cur_altsetting-&gt;desc.bInterfaceNumber &gt;= 4)
		return -ENODEV;
	//QuectelEC21&amp;EC25&amp;EC20 R2.0's interface 4 can be used as USB Network device
	if(serial-&gt;dev-&gt;descriptor.idVendor == cpu_to_le16(0x2C7C)
			&amp;&amp;serial-&gt;interface-&gt;cur_altsetting-&gt;desc.bInterfaceNumber &gt;= 4)
		return -ENODEV;
#endif
	/* Store the device flags so we can use them during attach. */
	usb_set_serial_data(serial, (void *)device_flags);

	return 0;
}</code></pre> 
<h3>        2.4、<strong>QMI WWAN Driver</strong></h3> 
<h4><strong>                        2.4.1        Add VID and PID</strong></h4> 
<p><strong>                                </strong>file is "[KERNEL]/drivers/net/usb/qmi_wwan.c".</p> 
<p>        </p> 
<pre><code>static const struct usb_device_id products[] = {
#if 1 //Added by Quectel
    #ifndef QMI_FIXED_INTF
    /* map QMI/wwan function by a fixed interface number */
    #define QMI_FIXED_INTF(vend, prod, num) \
    .match_flags  =  USB_DEVICE_ID_MATCH_DEVICE  |
    USB_DEVICE_ID_MATCH_INT_INFO, \
    .idVendor = vend, \
    .idProduct = prod, \
    .bInterfaceClass = 0xff, \
    .bInterfaceSubClass = 0xff, \
    .bInterfaceProtocol = 0xff, \
    .driver_info = (unsigned long)&amp;qmi_wwan_force_int##num,
#endif
    { QMI_FIXED_INTF(0x05C6, 0x9003, 4) }, /* Quectel UC20 */
    { QMI_FIXED_INTF(0x05C6, 0x9215, 4) }, /* Quectel EC20 */
    { QMI_FIXED_INTF(0x2C7C, 0x0125, 4) }, /* Quectel EC25/EC20R2.0 */
    { QMI_FIXED_INTF(0x2C7C, 0x0121, 4) }, /* Quectel EC21 */
#endif	</code></pre> 
<h4>                2.4.2        <strong>Add Support for Raw IP Modefor EC21/EC25/EC20 R2.0</strong></h4> 
<p><strong>                        </strong>file is"[KERNEL]/drivers/net/usb/qmi_wwan.c"</p> 
<pre><code>#include &lt;linux/usb/usbnet.h&gt;
#include &lt;linux/usb/cdc-wdm.h&gt;

#if 1 //Added by Quectel
#include &lt;linux/etherdevice.h&gt;
#include &lt;linux/version.h&gt;
#endif</code></pre> 
<pre><code>/* if follow function exist, modify itas below */
static int qmi_wwan_bind(struct usbnet*dev, struct usb_interface *intf)
{
……
#if 1 //Added by Quectel
    if(dev-&gt;udev-&gt;descriptor.idVendor == cpu_to_le16(0x2C7C)) {
       dev_info(&amp;intf-&gt;dev, "Quectel EC21&amp;EC25&amp;EC20 R2.0work on RawIP mode\n");
       dev-&gt;net-&gt;flags |= IFF_NOARP;
#if (LINUX_VERSION_CODE &lt; KERNEL_VERSION( 3,9,1 ))
/* make MAC addr easily distinguishable from an IP header */
    if (possibly_iphdr(dev-&gt;net-&gt;dev_addr)){
       dev-&gt;net-&gt;dev_addr[0] |= 0x02; /* set local assignment bit */
       dev-&gt;net-&gt;dev_addr[0] &amp;= 0xbf; /* clear "IP" bit */
    }
#endif
    usb_control_msg(
       interface_to_usbdev(intf),
       usb_sndctrlpipe(interface_to_usbdev(intf), 0),
        0x22,//USB_CDC_REQ_SET_CONTROL_LINE_STATE
        0x21,//USB_DIR_OUT | USB_TYPE_CLASS | USB_RECIP_INTERFACE
        1, //active CDCDTR
        intf-&gt;cur_altsetting-&gt;desc.bInterfaceNumber,
        NULL, 0, 100);
}
#endif
err:
    return status;
}

 </code></pre> 
<h2>3 make menuconfig配置选择</h2> 
<h3>        1、内核模块</h3> 
<pre><code>Kernel modules &gt;&gt;
    USB Support &gt;&gt;
        &lt;*&gt; Kmod -usb-core
        -*-Kmod -usb-net
        -*- kmod-usb-net-cdc-ether//【可选】
        &lt;*&gt; kmod-usb-net-cdc-mbim
        -*- kmod-usb-net-cdc-ncm
        &lt;*&gt; kmod-usb-net-cdc-subset//【可选】
        &lt;*&gt;kmod-usb-net-qmi-wwan
        &lt;*&gt;Kmod-usb-ohci     //这个选项一定要勾选，否则可能无法在系统中查看设备
        &lt;*&gt;Kmod-usb-serial
        &lt;*&gt;Kmod-usb-serial-option
        &lt;*&gt;Kmod-usb-serial-wwan
        &lt;*&gt;kmod-usb-uhci
        &lt;*&gt;Kmod-usb2</code></pre> 
<h3>        2、网络配置</h3> 
<pre><code>NetWork   &gt;&gt;
    &lt;*&gt;wwan
    &lt;*&gt;chat
    &lt;*&gt;ppp
    &lt;*&gt;uqmi
    &lt;*&gt;umbim</code></pre> 
<h3>        3、Utilities配置</h3> 
<pre><code>Utilities
  &lt;*&gt;comgt
  &lt;*&gt;usbutils//【可选，可查看usb设备】</code></pre> 
<h3>        4、Luci配置</h3> 
<pre><code>​
Luci
1. Collections
        &lt;*&gt; luci
3. Applications
        &lt;*&gt; luci-app-multiwan (optional to support multiple 3g dongles)//新版本为mwan3 【可选】
        &lt;*&gt; luci-app-qos (optional to provide QOS support)//【可选】
6. Protocols
        &lt;*&gt; luci-proto-3g
        -*- luci-proto-ppp

​</code></pre> 
<p>编译后可在打印信息处找到如下内容：</p> 
<pre><code>root@OpenWrt:/# 
[  636.398831] usb 1-1: new high-speed USB device number 2 using ehci-platform
[  636.571938] option 1-1:1.0: GSM modem (1-port) converter detected
[  636.578552] usb 1-1: GSM modem (1-port) converter now attached to ttyUSB0
[  636.586187] option 1-1:1.1: GSM modem (1-port) converter detected
[  636.592761] usb 1-1: GSM modem (1-port) converter now attached to ttyUSB1
[  636.600346] option 1-1:1.2: GSM modem (1-port) converter detected
[  636.606975] usb 1-1: GSM modem (1-port) converter now attached to ttyUSB2
[  636.614554] option 1-1:1.3: GSM modem (1-port) converter detected
[  636.621118] usb 1-1: GSM modem (1-port) converter now attached to ttyUSB3
[  636.699344] qmi_wwan 1-1:1.4: cdc-wdm0: USB WDM device
[  636.704626] qmi_wwan 1-1:1.4: Quectel EC21&amp;EC25&amp;EC20 R2.0work on RawIP mode
[  636.728069] qmi_wwan 1-1:1.4 wwan0: register 'qmi_wwan' at usb-101c0000.ehci-1, WWAN/QMI device, c2:dc:08:c1:a5:62</code></pre> 
<h2>        使用ls /dev/tty*命令可以看到</h2> 
<pre><code>root@OpenWrt:/# ls /dev/tty*
/dev/tty      /dev/ttyS1    /dev/ttyUSB0  /dev/ttyUSB2
/dev/ttyS0    /dev/ttyS2    /dev/ttyUSB1  /dev/ttyUSB3</code></pre> 
<h2>        使用ls /dev/c*命令可以看到</h2> 
<pre><code>root@OpenWrt:/# ls /dev/c*
/dev/cdc-wdm0         /dev/console          /dev/cpu_dma_latency
</code></pre> 
<h2>        使用lsusb命令可以看到</h2> 
<pre><code>root@OpenWrt:/# lsusb 
Bus 002 Device 001: ID 1d6b:0001 Linux 5.4.179 ohci_hcd Generic Platform OHCI controller
Bus 001 Device 002: ID 2c7c:0125 Android Android
Bus 001 Device 001: ID 1d6b:0002 Linux 5.4.179 ehci_hcd EHCI Host Controller</code></pre> 
<h2>4、拨号</h2> 
<h3>        1、quectel-CM</h3> 
<p>将quectel-CM文件夹放入openwrt根目录下package目录下</p> 
<p>make menuconfig选中quectel-CM包编译即可生成可执行文件</p> 
<p>在OpenWrt网页后台Network-Add New Interface选择DHCP Client选择新出现的wwan0，防火墙改为wan保存即可。</p> 
<h3>        2、ppp拨号</h3> 
<p>在OpenWrt网页后台Network-Add New Interface设置如下</p> 
<p><img alt="" height="1027" src="https://images2.imgbox.com/5b/a6/WIAzkocg_o.png" width="1200"></p> 
<p> 防火墙选择wan<img alt="" height="280" src="https://images2.imgbox.com/22/05/cKM2m2bb_o.png" width="1130"></p> 
<p></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b4d24b6ac7c7685ce36e78c95cdcb4a7/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Java Web 03 (页面跳转&amp;JDBC）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5a094a87ccaec34c1ea4618e118d7447/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">golang初级进阶（一）：顺序排序、冒泡算法、sort排序</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>