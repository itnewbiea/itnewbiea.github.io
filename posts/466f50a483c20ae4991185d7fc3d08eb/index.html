<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【设计模式之美】开闭原则方法论、开闭原则如何取舍 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【设计模式之美】开闭原则方法论、开闭原则如何取舍" />
<meta property="og:description" content="文章目录 一. 如何理解“对扩展开放、修改关闭”？二. 修改代码就意味着违背开闭原则吗？三. 如何做到“对扩展开放、修改关闭”？四. 如何在项目中灵活应用开闭原则？ 一. 如何理解“对扩展开放、修改关闭”？ 具体的说，添加一个新的功能应该是，在已有代码基础上扩展代码（新增模块、类、方法等），而非修改已有代码（修改模块、类、方法等）。
举例说明：
//业务逻辑主要集中在 check() 函数中。当接口的 TPS 超过某个预先设置的最大值时，以及当接口请求出错数大于某个最大允许值时，就会触发告警，通知接口的相关负责人或者团队。 public class Alert { private AlertRule rule; private Notification notification; public Alert(AlertRule rule, Notification notification) { this.rule = rule; this.notification = notification; } public void check(String api, long requestCount, long errorCount, long durationOfSeconds) { long tps = requestCount / durationOfSeconds; if (tps &gt; rule.getMatchedRule(api).getMaxTps()) { notification.notify(NotificationEmergencyLevel.URGENCY, &#34;...&#34;); } if (errorCount &gt; rule.getMatchedRule(api).getMaxErrorCount()) { notification.notify(NotificationEmergencyLevel.SEVERE, &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/466f50a483c20ae4991185d7fc3d08eb/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-05T13:38:48+08:00" />
<meta property="article:modified_time" content="2024-01-05T13:38:48+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【设计模式之美】开闭原则方法论、开闭原则如何取舍</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#__2" rel="nofollow">一. 如何理解“对扩展开放、修改关闭”？</a></li><li><a href="#__193" rel="nofollow">二. 修改代码就意味着违背开闭原则吗？</a></li><li><a href="#__223" rel="nofollow">三. 如何做到“对扩展开放、修改关闭”？</a></li><li><a href="#__270" rel="nofollow">四. 如何在项目中灵活应用开闭原则？</a></li></ul> 
</div> 
<p></p> 
<h2><a id="__2"></a>一. 如何理解“对扩展开放、修改关闭”？</h2> 
<p><strong>具体的说，添加一个新的功能应该是，在已有代码基础上扩展代码（新增模块、类、方法等），而非修改已有代码（修改模块、类、方法等）。</strong></p> 
<p>举例说明：</p> 
<pre><code class="prism language-java"><span class="token comment">//业务逻辑主要集中在 check() 函数中。当接口的 TPS 超过某个预先设置的最大值时，以及当接口请求出错数大于某个最大允许值时，就会触发告警，通知接口的相关负责人或者团队。</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Alert</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">private</span> <span class="token class-name">AlertRule</span> rule<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">Notification</span> notification<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token class-name">Alert</span><span class="token punctuation">(</span><span class="token class-name">AlertRule</span> rule<span class="token punctuation">,</span> <span class="token class-name">Notification</span> notification<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>rule <span class="token operator">=</span> rule<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>notification <span class="token operator">=</span> notification<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token class-name">String</span> api<span class="token punctuation">,</span> <span class="token keyword">long</span> requestCount<span class="token punctuation">,</span> <span class="token keyword">long</span> errorCount<span class="token punctuation">,</span> <span class="token keyword">long</span> durationOfSeconds<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">long</span> tps <span class="token operator">=</span> requestCount <span class="token operator">/</span> durationOfSeconds<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tps <span class="token operator">&gt;</span> rule<span class="token punctuation">.</span><span class="token function">getMatchedRule</span><span class="token punctuation">(</span>api<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxTps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      notification<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token class-name">NotificationEmergencyLevel</span><span class="token punctuation">.</span><span class="token constant">URGENCY</span><span class="token punctuation">,</span> <span class="token string">"..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>errorCount <span class="token operator">&gt;</span> rule<span class="token punctuation">.</span><span class="token function">getMatchedRule</span><span class="token punctuation">(</span>api<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxErrorCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      notification<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token class-name">NotificationEmergencyLevel</span><span class="token punctuation">.</span><span class="token constant">SEVERE</span><span class="token punctuation">,</span> <span class="token string">"..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>现在，如果我们需要添加一个功能，当每秒钟接口超时请求个数，超过某个预先设置的最大阈值时，我们也要触发告警发送通知。</p> 
<p> </p> 
<p><strong>通过修改已有代码来实现</strong></p> 
<pre><code class="prism language-c"><span class="token comment">//- 第一处是修改 check() 函数的入参，添加一个新的统计数据 timeoutCount，表示超时接口请求数；</span>
<span class="token comment">//- 第二处是在 check() 函数中添加新的告警逻辑。</span>
public class Alert <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  
  <span class="token comment">// 改动一：添加参数timeoutCount</span>
  public <span class="token keyword">void</span> <span class="token function">check</span><span class="token punctuation">(</span>String api<span class="token punctuation">,</span> <span class="token keyword">long</span> requestCount<span class="token punctuation">,</span> <span class="token keyword">long</span> errorCount<span class="token punctuation">,</span> <span class="token keyword">long</span> timeoutCount<span class="token punctuation">,</span> <span class="token keyword">long</span> durationOfSeconds<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">long</span> tps <span class="token operator">=</span> requestCount <span class="token operator">/</span> durationOfSeconds<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tps <span class="token operator">&gt;</span> rule<span class="token punctuation">.</span><span class="token function">getMatchedRule</span><span class="token punctuation">(</span>api<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxTps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      notification<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span>NotificationEmergencyLevel<span class="token punctuation">.</span>URGENCY<span class="token punctuation">,</span> <span class="token string">"..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>errorCount <span class="token operator">&gt;</span> rule<span class="token punctuation">.</span><span class="token function">getMatchedRule</span><span class="token punctuation">(</span>api<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxErrorCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      notification<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span>NotificationEmergencyLevel<span class="token punctuation">.</span>SEVERE<span class="token punctuation">,</span> <span class="token string">"..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 改动二：添加接口超时处理逻辑</span>
    <span class="token keyword">long</span> timeoutTps <span class="token operator">=</span> timeoutCount <span class="token operator">/</span> durationOfSeconds<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeoutTps <span class="token operator">&gt;</span> rule<span class="token punctuation">.</span><span class="token function">getMatchedRule</span><span class="token punctuation">(</span>api<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxTimeoutTps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      notification<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span>NotificationEmergencyLevel<span class="token punctuation">.</span>URGENCY<span class="token punctuation">,</span> <span class="token string">"..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这样的代码修改实际上存在挺多问题的。</p> 
<blockquote> 
 <ul><li>一方面，我们对接口进行了修改，这就意味着调用这个接口的代码都要做相应的修改。</li><li>另一方面，修改了 check() 函数，相应的单元测试都需要修改（关于单元测试的内容我们在重构那部分会详细介绍）。</li></ul> 
</blockquote> 
<p> <br> <strong>通过“扩展”的方式来实现同样的功能</strong></p> 
<p>先重构一下之前的 Alert 代码，<strong>让它的扩展性更好一些</strong>。</p> 
<blockquote> 
 <ul><li>重构一：将 check() 的入参封装到 ApiStatInfo 类；</li><li>重构二：引入 handler 的概念，将 if 判断逻辑分散在各个 handler 中。</li></ul> 
</blockquote> 
<pre><code class="prism language-c">public class Alert <span class="token punctuation">{<!-- --></span>
  private List<span class="token operator">&lt;</span>AlertHandler<span class="token operator">&gt;</span> alertHandlers <span class="token operator">=</span> new ArrayList<span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  public <span class="token keyword">void</span> <span class="token function">addAlertHandler</span><span class="token punctuation">(</span>AlertHandler alertHandler<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    this<span class="token punctuation">.</span>alertHandlers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>alertHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">//封装入参</span>
  public <span class="token keyword">void</span> <span class="token function">check</span><span class="token punctuation">(</span>ApiStatInfo apiStatInfo<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>AlertHandler handler <span class="token operator">:</span> alertHandlers<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      handler<span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>apiStatInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

public class ApiStatInfo <span class="token punctuation">{<!-- --></span><span class="token comment">//省略constructor/getter/setter方法</span>
  private String api<span class="token punctuation">;</span>
  private <span class="token keyword">long</span> requestCount<span class="token punctuation">;</span>
  private <span class="token keyword">long</span> errorCount<span class="token punctuation">;</span>
  private <span class="token keyword">long</span> durationOfSeconds<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">//2. 添加handler抽象类：定义公共属性和方法</span>
public abstract class AlertHandler <span class="token punctuation">{<!-- --></span>
  protected AlertRule rule<span class="token punctuation">;</span>
  protected Notification notification<span class="token punctuation">;</span>
  public <span class="token function">AlertHandler</span><span class="token punctuation">(</span>AlertRule rule<span class="token punctuation">,</span> Notification notification<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    this<span class="token punctuation">.</span>rule <span class="token operator">=</span> rule<span class="token punctuation">;</span>
    this<span class="token punctuation">.</span>notification <span class="token operator">=</span> notification<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  public abstract <span class="token keyword">void</span> <span class="token function">check</span><span class="token punctuation">(</span>ApiStatInfo apiStatInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

public class TpsAlertHandler extends AlertHandler <span class="token punctuation">{<!-- --></span>
  public <span class="token function">TpsAlertHandler</span><span class="token punctuation">(</span>AlertRule rule<span class="token punctuation">,</span> Notification notification<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">super</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> notification<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  @Override
  public <span class="token keyword">void</span> <span class="token function">check</span><span class="token punctuation">(</span>ApiStatInfo apiStatInfo<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">long</span> tps <span class="token operator">=</span> apiStatInfo<span class="token punctuation">.</span><span class="token function">getRequestCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span> apiStatInfo<span class="token punctuation">.</span><span class="token function">getDurationOfSeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tps <span class="token operator">&gt;</span> rule<span class="token punctuation">.</span><span class="token function">getMatchedRule</span><span class="token punctuation">(</span>apiStatInfo<span class="token punctuation">.</span><span class="token function">getApi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxTps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      notification<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span>NotificationEmergencyLevel<span class="token punctuation">.</span>URGENCY<span class="token punctuation">,</span> <span class="token string">"..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

public class ErrorAlertHandler extends AlertHandler <span class="token punctuation">{<!-- --></span>
  public <span class="token function">ErrorAlertHandler</span><span class="token punctuation">(</span>AlertRule rule<span class="token punctuation">,</span> Notification notification<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token function">super</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> notification<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  @Override
  public <span class="token keyword">void</span> <span class="token function">check</span><span class="token punctuation">(</span>ApiStatInfo apiStatInfo<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>apiStatInfo<span class="token punctuation">.</span><span class="token function">getErrorCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> rule<span class="token punctuation">.</span><span class="token function">getMatchedRule</span><span class="token punctuation">(</span>apiStatInfo<span class="token punctuation">.</span><span class="token function">getApi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxErrorCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      notification<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span>NotificationEmergencyLevel<span class="token punctuation">.</span>SEVERE<span class="token punctuation">,</span> <span class="token string">"..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在重构之后的代码中实现新的需求，有如下改动</p> 
<blockquote> 
 <ul><li>在 ApiStatInfo 类中添加新的属性 timeoutCount。</li><li>添加新的 TimeoutAlertHander 类。</li><li>在 ApplicationContext 类的 initializeBeans() 方法中，往 alert 对象中注册新的 timeoutAlertHandler。</li><li>在使用 Alert 类的时候，需要给 check() 函数的入参 apiStatInfo 对象设置 timeoutCount 的值。</li></ul> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Alert</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 代码未改动... }</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApiStatInfo</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//省略constructor/getter/setter方法</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> api<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">long</span> requestCount<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">long</span> errorCount<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">long</span> durationOfSeconds<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">long</span> timeoutCount<span class="token punctuation">;</span> <span class="token comment">// 改动一：添加新字段</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AlertHandler</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//代码未改动... }</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TpsAlertHandler</span> <span class="token keyword">extends</span> <span class="token class-name">AlertHandler</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//代码未改动...}</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ErrorAlertHandler</span> <span class="token keyword">extends</span> <span class="token class-name">AlertHandler</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//代码未改动...}</span>

<span class="token comment">// 改动二：添加新的handler</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TimeoutAlertHandler</span> <span class="token keyword">extends</span> <span class="token class-name">AlertHandler</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//省略代码...}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationContext</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">private</span> <span class="token class-name">AlertRule</span> alertRule<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">Notification</span> notification<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">Alert</span> alert<span class="token punctuation">;</span>
  
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initializeBeans</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    alertRule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AlertRule</span><span class="token punctuation">(</span><span class="token comment">/*.省略参数.*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//省略一些初始化代码</span>
    notification <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Notification</span><span class="token punctuation">(</span><span class="token comment">/*.省略参数.*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//省略一些初始化代码</span>
    alert <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Alert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    alert<span class="token punctuation">.</span><span class="token function">addAlertHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TpsAlertHandler</span><span class="token punctuation">(</span>alertRule<span class="token punctuation">,</span> notification<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    alert<span class="token punctuation">.</span><span class="token function">addAlertHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ErrorAlertHandler</span><span class="token punctuation">(</span>alertRule<span class="token punctuation">,</span> notification<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 改动三：注册handler</span>
    alert<span class="token punctuation">.</span><span class="token function">addAlertHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TimeoutAlertHandler</span><span class="token punctuation">(</span>alertRule<span class="token punctuation">,</span> notification<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//...省略其他未改动代码...</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">ApiStatInfo</span> apiStatInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApiStatInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...省略apiStatInfo的set字段代码</span>
    apiStatInfo<span class="token punctuation">.</span><span class="token function">setTimeoutCount</span><span class="token punctuation">(</span><span class="token number">289</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 改动四：设置tiemoutCount值</span>
    <span class="token class-name">ApplicationContext</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAlert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>apiStatInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>重构之后的代码更加灵活和易扩展。</p> 
 <p>如果我们要想添加新的告警逻辑，只需要基于扩展的方式创建新的 handler 类即可，不需要改动原来的 check() 函数的逻辑。而且，我们只需要为新的 handler 类添加单元测试，老的单元测试都不会失败，也不用修改。</p> 
</blockquote> 
<p> </p> 
<h2><a id="__193"></a>二. 修改代码就意味着违背开闭原则吗？</h2> 
<p>看了上面重构之后的代码，你可能还会有疑问：在添加新的告警逻辑的时候，尽管改动二（添加新的 handler 类）是基于扩展而非修改的方式来完成的，但改动一、三、四貌似不是基于扩展而是基于修改的方式来完成的，那改动一、三、四不就违背了开闭原则吗？<br>  </p> 
<hr> 
<p><em><strong>我们回到这条原则的设计初衷：只要它没有破坏原有的代码的正常运行，没有破坏原有的单元测试，我们就可以说，这是一个合格的代码改动。</strong></em></p> 
<hr> 
<p> </p> 
<p>分析一下改动三和改动四：这两处改动都是在方法内部进行的，不管从哪个层面（模块、类、方法）来讲，都不能算是“扩展”，而是地地道道的“修改”。不过，有些修改是在所难免的，是可以被接受的。</p> 
<hr> 
<blockquote> 
 <p><em><strong>如果我们把 Alert 类及各个 handler 类合起来看作一个“模块”，那模块本身在添加新的功能的时候，完全满足开闭原则。</strong></em></p> 
 <p> <br> 要认识到，添加一个新功能，不可能任何模块、类、方法的代码都不“修改”，这个是做不到的。类需要创建、组装、并且做一些初始化操作，才能构建成可运行的的程序，这部分代码的修改是在所难免的。<br>  <br> <em><strong>我们要做的是尽量让修改操作更集中、更少、更上层，尽量让最核心、最复杂的那部分逻辑代码满足开闭原则。</strong></em></p> 
</blockquote> 
<hr> 
<p> </p> 
<h2><a id="__223"></a>三. 如何做到“对扩展开放、修改关闭”？</h2> 
<p>实际上，开闭原则讲的就是代码的扩展性问题，是判断一段代码是否易扩展的“金标准”。如果某段代码在应对未来需求变化的时候，能够做到“对扩展开放、对修改关闭”，那就说明这段代码的扩展性比较好。</p> 
<p><em><strong>所以，问如何才能做到“对扩展开放、对修改关闭”，也就粗略地等同于在问，如何才能写出扩展性好的代码。</strong></em></p> 
<p>在讲具体的方法论之前，我们先来看一些更加偏向顶层的指导思想。为了尽量写出扩展性好的代码，我们要具备扩展意识、抽象意识、封装意识。</p> 
<p>支持开闭原则的一些更加具体的方法论。</p> 
<p>在众多的设计原则、思想、模式中，最常用来提高代码扩展性的方法有：多态、依赖注入、基于接口而非实现编程，以及大部分的设计模式（比如，装饰、策略、模板、职责链、状态等）。</p> 
<p>如何利用多态、依赖注入、基于接口而非实现编程，来实现“对扩展开放、对修改关闭”。</p> 
<p>比如，我们代码中通过 Kafka 来发送异步消息。对于这样一个功能的开发，我们要学会将其抽象成<strong>一组跟具体消息队列（Kafka）无关的异步消息接口</strong>。 <strong>所有上层系统都依赖这组抽象的接口编程，并且通过依赖注入的方式来调用。</strong></p> 
<p>当我们要替换新的消息队列的时候，比如将 Kafka 替换成 RocketMQ，可以很方便地拔掉老的消息队列实现，插入新的消息队列实现。具体代码如下所示：</p> 
<pre><code class="prism language-java"><span class="token comment">// 这一部分体现了抽象意识</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MessageQueue</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//... }</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaMessageQueue</span> <span class="token keyword">implements</span> <span class="token class-name">MessageQueue</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//... }</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RocketMQMessageQueue</span> <span class="token keyword">implements</span> <span class="token class-name">MessageQueue</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//...}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MessageFromatter</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//... }</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JsonMessageFromatter</span> <span class="token keyword">implements</span> <span class="token class-name">MessageFromatter</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//...}</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProtoBufMessageFromatter</span> <span class="token keyword">implements</span> <span class="token class-name">MessageFromatter</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//...}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">private</span> <span class="token class-name">MessageQueue</span> msgQueue<span class="token punctuation">;</span> <span class="token comment">// 基于接口而非实现编程</span>
  <span class="token keyword">public</span> <span class="token class-name">Demo</span><span class="token punctuation">(</span><span class="token class-name">MessageQueue</span> msgQueue<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 依赖注入</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>msgQueue <span class="token operator">=</span> msgQueue<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// msgFormatter：多态、依赖注入</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendNotification</span><span class="token punctuation">(</span><span class="token class-name">Notification</span> notification<span class="token punctuation">,</span> <span class="token class-name">MessageFormatter</span> msgFormatter<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//...    </span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p> </p> 
<h2><a id="__270"></a>四. 如何在项目中灵活应用开闭原则？</h2> 
<p>前面我们提到，写出支持“对扩展开放、对修改关闭”的代码的关键是预留扩展点。那问题是如何才能识别出所有可能的扩展点呢？</p> 
<p>最合理的做法</p> 
<blockquote> 
 <ul><li>对于一些比较确定的、短期内可能就会扩展，或者需求改动对代码结构影响比较大的情况，或者实现成本不高的扩展点，在编写代码的时候之后，我们就可以事先做些扩展性设计。</li><li>对于一些不确定未来是否要支持的需求，或者实现起来比较复杂的扩展点，我们可以等到有需求驱动的时候，再通过重构代码的方式来支持扩展的需求。</li></ul> 
</blockquote> 
<p> </p> 
<p>开闭原则增加了理解难度</p> 
<blockquote> 
 <p>我们之前举的 Alert 告警的例子。为了更好地支持扩展性，我们对代码进行了重构，重构之后的代码要比之前的代码复杂很多，理解起来也更加有难度。</p> 
</blockquote> 
<p> <br> 需要在扩展性和可读性之间做权衡</p> 
<blockquote> 
 <p>在某些场景下，代码的扩展性很重要，我们就可以适当地牺牲一些代码的可读性；在另一些场景下，代码的可读性更加重要，那我们就适当地牺牲一些代码的可扩展性。</p> 
</blockquote> 
<p>在 Alert 告警的例子中，如果告警规则并不是很多、也不复杂，那 check() 函数中的 if 语句就不会很多，代码逻辑也不复杂，代码行数也不多，那最初的第一种代码实现思路简单易读，就是比较合理的选择。</p> 
<p>相反，如果告警规则很多、很复杂，check() 函数的 if 语句、代码逻辑就会很多、很复杂，相应的代码行数也会很多，可读性、可维护性就会变差，那重构之后的第二种代码实现思路就是更加合理的选择了。</p> 
<p> </p> 
<p>参考：《设计模式之美》–王争</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/cb5f9e34d24688c97e9fa2beec79c0a5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">git 管理vivado工程， tcl 恢复vivado工程</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1d81c0cd60486eacc3d72a25af8c8b4d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">什么是DNS解析？DNS解析的详细过程是什么样的？</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>