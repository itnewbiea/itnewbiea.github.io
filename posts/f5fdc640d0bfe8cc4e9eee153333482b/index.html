<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>zabbix 自定义脚本 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="zabbix 自定义脚本" />
<meta property="og:description" content="这个脚本的思路，自定义一个key，然后就是通过查看文件 /proc/net/dev 里面的数值，来计算实时网卡流量，其实我算的是一个平均值。分为进和出。如果这个脚本每隔1分钟执行一次，那么算出来的流量值就是1分钟的平均值。最终得到网卡流量趋势图。
客户端操作
# vim /etc/zabbix/zabbix_agentd.conf # UnsafeUserParameters=0 取消注释并修改为1，在下面增加一行
UserParameter=my.net.if[*],/usr/local/sbin/zabbix/net.sh $1 $2
my.net.if[相当于命令名字，他是key
其中UserParameter用来自定义键值，（类似于net.if.in)，自己写的脚本往往会有参数，[*] 表示他有自己的参数，所以需要加[*]，这是固定写法，如果脚本压根就没有什么参数，那么这个就省了。逗号后面就是我们写的脚本的路径了，再后面就是要用到的参数，有几个就写几。如果没有参数，后面的 $1 $2 还有前面的 [*] 就都可以省略。
不足之处：
脚本需要工作中不断的进行改进。
并没有针对每个网卡设定单独的文件，所有网卡使用同一个日志文件
# vim /usr/local/sbin/zabbix/net.sh
#!/bin/bash
eth=$1
io=$2
net_file=&#34;/proc/net/dev&#34;
if [ $2 == &#34;in&#34; ]
then
n_new=`grep &#34;$eth&#34; $net_file|awk &#39;{print $2}&#39;`
n_old=`tail -1 /tmp/neti.log`
n=`echo &#34;$n_new-$n_old&#34;|bc`
d_new=`date &#43;%s`
d_old=`tail -2 /tmp/neti.log|head -1`
d=`echo &#34;$d_new-$d_old&#34;|bc`
if_net=`echo &#34;$n/$d&#34;|bc`
echo $if_net
date &#43;%s&gt;&gt;/tmp/neti.log
grep &#34;$eth&#34; $net_file|awk &#39;{print $2}&#39;&gt;&gt;/tmp/neti.log
elif [ $2 == &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/f5fdc640d0bfe8cc4e9eee153333482b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2017-05-16T10:09:00+08:00" />
<meta property="article:modified_time" content="2017-05-16T10:09:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">zabbix 自定义脚本</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div class="artical-content-bak main-content editor-side-new"> 
 <div class="con editor-preview-side" id="result"> 
  <p><span style="font-weight:bold;">这个脚本的思路，自定义一个key，然后就是通过查看文件 /proc/net/dev  里面的数值，来计算实时网卡流量，其实我算的是一个平均值。分为进和出。如果这个脚本每隔1分钟执行一次，那么算出来的流量值就是1分钟的平均值。最终得到</span><span style="font-family:'Courier New';font-weight:bold;">网卡流量趋势图。</span></p> 
  <p><span style="font-family:'Courier New';font-weight:bold;"><br></span></p> 
  <p><span style="font-family:'Courier New';font-weight:bold;">客户端操作</span></p> 
  <p># vim /etc/zabbix/zabbix_agentd.conf </p> 
  <p># UnsafeUserParameters=0 取消注释并修改为1，在下面增加一行</p> 
  <p>UserParameter=<span style="color:rgb(255,0,0);">my.net.if</span><span style="color:rgb(255,192,0);">[*]</span>,/usr/local/sbin/zabbix/net.sh <span style="color:rgb(255,192,0);">$1 $2</span></p> 
  <p><span style="color:rgb(255,0,0);">my.net.if[相当于命令名字，他是key</span></p> 
  <p>其中UserParameter用来自定义键值，（类似于net.if.in)，自己写的脚本往往会有参数，[*] 表示他有自己的参数，所以需要加[*]，这是固定写法，如果脚本压根就没有什么参数，那么这个就省了。逗号后面就是我们写的脚本的路径了，再后面就是要用到的参数，有几个就写几。如果没有参数，后面的 $1 $2 还有前面的 [*] 就都可以省略。</p> 
  <p>不足之处：</p> 
  <p>脚本需要工作中不断的进行改进。</p> 
  <p>并没有针对每个网卡设定单独的文件，所有网卡使用同一个日志文件</p> 
  <p># vim /usr/local/sbin/zabbix/net.sh</p> 
  <p>#!/bin/bash</p> 
  <p>eth=$1</p> 
  <p>io=$2</p> 
  <p>net_file="/proc/net/dev"</p> 
  <p>if [ $2 == "in" ]</p> 
  <p>then</p> 
  <p>n_new=`grep "$eth" $net_file|awk '{print $2}'`</p> 
  <p>n_old=`tail -1 /tmp/neti.log`</p> 
  <p>n=`echo "$n_new-$n_old"|bc`</p> 
  <p>d_new=`date +%s`</p> 
  <p>d_old=`tail -2 /tmp/neti.log|head -1`</p> 
  <p>d=`echo "$d_new-$d_old"|bc`</p> 
  <p>if_net=`echo "$n/$d"|bc`</p> 
  <p>echo $if_net</p> 
  <p>date +%s&gt;&gt;<span style="color:rgb(255,0,0);">/tmp/neti.log</span></p> 
  <p>grep "$eth" $net_file|awk '{print $2}'&gt;&gt;/tmp/neti.log</p> 
  <p>elif [ $2 == "out" ]</p> 
  <p>then</p> 
  <p>n_new=`grep "$eth" $net_file|awk '{print $10}'`</p> 
  <p>n_old=`tail -1 /tmp/neto.log`</p> 
  <p>n=`echo "$n_new-$n_old"|bc`</p> 
  <p>d_new=`date +%s`</p> 
  <p>d_old=`tail -2 /tmp/neto.log|head -1`</p> 
  <p>d=`echo "$d_new-$d_old"|bc`</p> 
  <p>if_net=`echo "$n/$d"|bc`</p> 
  <p>echo $if_net</p> 
  <p>date +%s&gt;&gt;<span style="color:rgb(255,0,0);">/tmp/neto.log</span></p> 
  <p>grep "$eth" $net_file|awk '{print $10}'&gt;&gt;/tmp/neto.log</p> 
  <p>else</p> 
  <p>echo 0</p> 
  <p>fi</p> 
  <p>----------------------------------------------------------------------------------------------------------------------------</p> 
  <p><strong>详解</strong></p> 
  <p>eth=$1 <span style="font-weight:bold;"># 第一个参数，网卡名字，脚本并不针对特定的网卡，可以监控很多网卡，监控进和出</span></p> 
  <p>io=$2 <span style="font-weight:bold;"># 第二个参数，并非io，而是in or out 的简写</span></p> 
  <p>net_file="<span style="color:rgb(255,0,0);">/proc/net/dev</span>" <span style="font-weight:bold;"># </span><span style="color:rgb(255,0,0);font-weight:bold;">最关键文件</span><span style="font-weight:bold;">，网卡流量就是从这个文件获得的。这个脚本的思路，就是通过查看文件 /proc/net/dev  里面的数值，来计算实时网卡流量，其实我算的是一个平均值。分为进和出。如果这个脚本每隔1分钟执行一次，那么算出来的流量值就是1分钟的平均值。</span></p> 
  <p>n_new=`grep "$eth" $net_file|awk '{print $2}'` <span style="font-weight:bold;"># 通过上面的文件，获得最新的一个数值</span></p> 
  <p>n_old=`tail -1 /tmp/neti.log` <span style="font-weight:bold;"># 查看上一次网卡流量多少</span></p> 
  <p>n=`echo "$n_new-$n_old"|bc` <span style="font-weight:bold;"># n 是两者的差值（上面二个新老网卡流量做减法）</span></p> 
  <p>d_new=`date +%s` <span style="font-weight:bold;"># 记录当前的时间戳</span></p> 
  <p>d_old=`tail -2 /tmp/neti.log|head -1` <span style="font-weight:bold;"># 查找上一次的时间戳</span></p> 
  <p>d=`echo "$d_new-$d_old"|bc` <span style="font-weight:bold;"># d 是两个时间间隔</span></p> 
  <p>if_net=`echo "$n/$d"|bc` <span style="font-weight:bold;"># 求平均值</span></p> 
  <p>echo $if_net <span style="font-weight:bold;"># 输出平均值</span></p> 
  <p>date +%s&gt;&gt;/tmp/neti.log <span style="font-weight:bold;"># 当前时间戳输入到日志中</span></p> 
  <p>grep "$eth" $net_file|awk '{print $2}'&gt;&gt;/tmp/neti.log <span style="font-weight:bold;"># 当前流量输入到日志中</span></p> 
  <p><span style="font-weight:bold;">----------------------------------------------------------------------------------------------------------------------------</span></p> 
  <p><br></p> 
  <p>值与上一次减一下然后除一下，求一个平均值</p> 
  <p># chmod a+x /usr/local/sbin/zabbix/net.sh <span style="font-weight:bold;"># 更改权限</span></p> 
  <p><span style="font-weight:bold;">执行操作执行，先创建脚本里面要使用的目录和文件</span></p> 
  <p><span style="font-size:13px;font-family:Arial;color:rgb(51,51,51);"># touch /tmp/net[io].log</span></p> 
  <p><span style="font-size:13px;font-family:Arial;color:rgb(51,51,51);"># date +%s &gt;&gt;/tmp/neti.log</span></p> 
  <p><span style="font-size:13px;font-family:Arial;color:rgb(51,51,51);"># </span><span style="font-size:13px;font-family:Arial;color:rgb(255,0,0);">grep eth0</span><span style="font-size:13px;font-family:Arial;color:rgb(51,51,51);"> /proc/net/dev |awk '{print $2}' &gt;&gt;/tmp/neti.log</span></p> 
  <p><span style="font-size:13px;font-family:Arial;color:rgb(51,51,51);"># date +%s &gt;&gt;/tmp/neto.log</span></p> 
  <p><span style="font-size:13px;font-family:Arial;color:rgb(51,51,51);"># </span><span style="font-size:13px;font-family:Arial;color:rgb(255,0,0);">grep eth0</span><span style="font-size:13px;font-family:Arial;color:rgb(51,51,51);"> /proc/net/dev |awk '{print $10}' &gt;&gt;/tmp/neto.log</span></p> 
  <p><span style="font-size:13px;font-family:Arial;color:rgb(51,51,51);"># chown zabbix  /tmp/net[io].log</span></p> 
  <p><span style="font-weight:bold;">执行脚本检测：</span></p> 
  <p># /usr/local/sbin/zabbix/net.sh eth0 in</p> 
  <p># /usr/local/sbin/zabbix/net.sh eth0 out</p> 
  <p>此时检测 eth1 或者其他网卡的流量会报错，因为执行脚本之前，grep 过滤出来的是 eth0 的流量，这里直接使用 eth1 得出的数字肯定是错误的。所以，如果是想检测 eth1 的流量，那么在 grep 和 touch 的时候，就应该使用 eth1。</p> 
  <p># /etc/init.d/zabbix-agent restart</p> 
  <p><span style="font-size:22px;font-weight:bold;">服务端</span></p> 
  <p># zabbix_get -s 192.168.32.150 -p10050 -k "my.net.if[eth0,out]"查看out网卡流量，单位字节</p> 
  <p>395</p> 
  <p># zabbix_get -s 192.168.32.150 -p10050 -k "my.net.if[eth0,in]" 查看in网卡流量，单位字节</p> 
  <p>308 </p> 
  <p><span style="font-size:22px;font-weight:bold;">WEB端</span></p> 
  <p><a href="https://s1.51cto.com/wyfs02/M02/95/D3/wKioL1kaYRbwfGqHAALCYyv45mU178.jpg-wh_500x0-wm_3-wmp_4-s_3942182189.jpg" rel="nofollow"><img src="https://images2.imgbox.com/76/d2/AHhutrRR_o.jpg" title="1.jpg" alt="wKioL1kaYRbwfGqHAALCYyv45mU178.jpg-wh_50"></a></p> 
  <p>下图的 key 只能手写，并不能选择。</p> 
  <p>创建eth0_net_in和eth0_net_out</p> 
  <p><br></p> 
  <p>查看是否添加成功</p> 
  <p><br></p> 
  <p>需求：统计每分钟的在线人数，通过数据库获得在线人数。</p> 
  <p>思路：</p> 
  <p>1、客户端增加 key</p> 
  <p>UserParameter=my.online,/usr/local/sbin/zabbix/online.sh </p> 
  <p><span style="font-weight:bold;">#因为这个需求没有参数，所以去掉参数选项</span></p> 
  <p>2、编写脚本</p> 
  <p>从数据库里面获得每分钟的在线人数</p> 
  <p>3、测试</p> 
  <p>服务端进行操作</p> 
  <p># zabbix_get -s 192.168.32.150 -p10050 -k "my.online"</p> 
  <p>如果返回了参数，那么就代表成功。</p> 
  <p><br></p> 
 </div> 
</div> 
<p>转载于:https://blog.51cto.com/jishan/1926109</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9bde1e6894640318c6f188b8eaea0b3d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">shell 练习题  1-10</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/47e89500b0fed1fd5d8922bcc881a12b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">树学习（2）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>