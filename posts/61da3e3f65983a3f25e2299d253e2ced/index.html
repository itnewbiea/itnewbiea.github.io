<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Androidæ’ä»¶åŒ–åŸç†ï¼ˆä¸€ï¼‰â€”â€” æ’ä»¶ç±»åŠ è½½ã€ç±»åŠ è½½åŸç†ã€ï¼ˆåŒäº²å§”æ‰˜æœºåˆ¶) - ITå­¦ä¹ è€…åšå®¢</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Androidæ’ä»¶åŒ–åŸç†ï¼ˆä¸€ï¼‰â€”â€” æ’ä»¶ç±»åŠ è½½ã€ç±»åŠ è½½åŸç†ã€ï¼ˆåŒäº²å§”æ‰˜æœºåˆ¶)" />
<meta property="og:description" content="è®°å½•ä¸€ä¸‹ï¼Œè¿™æ˜¯2020å¹´ç¬¬ä¸€ç¯‡å¸–å­ï¼Œä»Šå¹´ç«‹äº†ä¸€ä¸ªflagâ€“ç»å¸¸å†™å¸–å­ã€‚å› ä¸ºç–«æƒ…çš„åŸå› ï¼Œåªèƒ½æ¯å¤©åœ¨å®¶å…»è‚šçš®ï¼ŒèººåºŠä¸Šä¸ºç¤¾ä¼šåšè´¡çŒ®ã€‚å®åœ¨æ˜¯åä¸ä½äº†ï¼Œå°±å¼€å§‹å†™è¿™ç¯‡æ–‡ç« å§ã€‚å¸Œæœ›æ–°çš„ä¸€å¹´è‡ªå·±è¶Šæ¥è¶Šå‰å®³ï¼Œä¹Ÿå¸Œæœ›ç–«æƒ…æ—©ç‚¹è¿‡å»
ï¼ˆä¸€ï¼‰ä»€ä¹ˆæ˜¯æ’ä»¶åŒ– æ’ä»¶åŒ–æŠ€æœ¯æœ€åˆæºäºå…å®‰è£…è¿è¡Œapkçš„æƒ³æ³•ï¼Œè¿™ä¸ªå…å®‰è£…çš„apkå°±å¯ä»¥ç†è§£ä¸ºæ’ä»¶ï¼Œè€Œæ”¯æŒæ’ä»¶çš„appæˆ‘ä»¬ä¸€èˆ¬ç§°ä¹‹ä¸ºå®¿ä¸»
ï¼ˆäºŒï¼‰ä¸ºä»€ä¹ˆè¦æ’ä»¶åŒ– 1.appåŠŸèƒ½æ¨¡å—è¶Šæ¥è¶Šå¤šï¼Œä½“ç§¯è¶Šæ¥è¶Šå¤§ï¼Œç»´æŠ¤å˜å¾—å›°éš¾ï¼›
2.æ¨¡å—ä¹‹é—´çš„è€¦åˆåº¦é«˜ï¼ŒååŒå¼€å‘æ²Ÿé€šæˆæœ¬è¶Šæ¥è¶Šé«˜ï¼›
3.æ–¹æ³•æ•°ç›®å¯èƒ½è¶…è¿‡65535ï¼ŒAPPå ç”¨çš„å†…å­˜è¶Šæ¥è¶Šå¤§ï¼›
4.å¢åŠ åŠŸèƒ½åªæ•¢åšåŠ æ³•ã€‚
ï¼ˆä¸‰ï¼‰æ’ä»¶åŒ–å’Œæ¨¡å—ï¼ˆæ¨¡å—ï¼‰åŒ–çš„çˆ±æ¨çº è‘› ç»„ä»¶åŒ–å¼€å‘ä¸»è¦æ˜¯é€šè¿‡gradleé…ç½®ï¼Œå°†ä¸€ä¸ªappåˆ†æˆå¤šä¸ªæ¨¡å—ï¼Œæ¯ä¸ªæ¨¡å—éƒ½æ˜¯ä¸€ä¸ªç»„ä»¶ï¼Œå¼€å‘çš„è¿‡ç¨‹ä¸­æˆ‘ä»¬å¯ä»¥è®©è¿™äº›ç»„ä»¶ç›¸äº’ä¾èµ–æˆ–è€…å•ç‹¬è°ƒè¯•éƒ¨åˆ†ç»„ä»¶ç­‰ï¼Œä½†æ˜¯æœ€ç»ˆå‘å¸ƒçš„æ—¶å€™æ˜¯å°†è¿™äº›ç»„ä»¶åŒæ„åˆå¹¶æˆä¸€ä¸ªapkï¼Œè¿™å°±æ˜¯ç»„ä»¶åŒ–å¼€å‘ã€‚æ’ä»¶åŒ–å’Œç»„ä»¶åŒ–ç•¥æœ‰ä¸åŒï¼Œæ’ä»¶åŒ–å¼€å‘æ˜¯å°†æ•´ä¸ªapkæ‹†åˆ†æˆå¤šä¸ªæ¨¡å—ï¼Œè¿™äº›æ¨¡å—åŒ…æ‹¬ä¸€ä¸ªå®¿ä¸»å’Œå¤šä¸ªæ’ä»¶ï¼Œæ¯ä¸ªæ¨¡å—éƒ½æ˜¯ä¸€ä¸ªapkï¼Œæœ€ç»ˆæ‰“åŒ…çš„æ—¶å€™å®¿ä¸»apkå’Œæ’ä»¶apkåˆ†å¼€æ‰“åŒ…ã€‚æ’ä»¶åŒ–å…¶å®æ˜¯å»ºç«‹åœ¨æ¨¡å—åŒ–åŸºç¡€ä¸Šçš„ï¼Œæ’ä»¶åŒ–åœ¨å®æ–½ä¹‹å‰éœ€è¦å…ˆè¿›æ€§æ¨¡å—åŒ–ã€‚ ï¼ˆå››ï¼‰æ ¸å¿ƒ-æ’ä»¶åŒ–åŸç†ï¼ˆæ–¹æ¡ˆä¹‹ä¸€ï¼‰ å„å¤§å¹³å°æ–¹æ¡ˆå¯¹æ¯”
[å¤–é“¾å›¾ç‰‡è½¬å­˜å¤±è´¥,æºç«™å¯èƒ½æœ‰é˜²ç›—é“¾æœºåˆ¶,å»ºè®®å°†å›¾ç‰‡ä¿å­˜ä¸‹æ¥ç›´æ¥ä¸Šä¼ 
ä¸å†ä¸€ä¸€ä»‹ç»åŸç†ï¼Œæœ¬æ¬¡ä¸»é¢˜æ˜¯åŸºäº 360çš„DroidPlugin
æ¥ä¸‹æ¥æ˜¯æ’ä»¶åŒ–çš„æ ¸å¿ƒï¼š
å¦‚ä½•åŠ è½½æ’ä»¶çš„ç±»ï¼Ÿå¦‚ä½•åŠ è½½æ’ä»¶çš„èµ„æºï¼Ÿå¦‚ä½•è°ƒç”¨æ’ä»¶çš„ç±»(å››å¤§ç»„ä»¶)ï¼Ÿ ä¸€. å¦‚ä½•åŠ è½½æ’ä»¶çš„ç±» 1. ç±»åŠ è½½å™¨ æ¯«æ— ç–‘é—®ï¼Œç±»æ˜¯é€šè¿‡ç±»åŠ è½½å™¨classLoaderåŠ è½½çš„ï¼Œæˆ‘ä»¬å…ˆçœ‹å‡ ç§ç±»åŠ è½½å™¨.
1.1 PathClassLoaderå’ŒDexClassLoaderåŒºåˆ« é¦–å…ˆæˆ‘ä»¬æ¥çœ‹DexClassLoader:
DexClassLoader ç”¨äºåŠ è½½.jar .apk .dexä¸­çš„ç±»ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥åŠ è½½ä¸æ˜¯åº”ç”¨ç¨‹åºä¸­çš„ä»£ç 
api-25-7.1 --&gt;
api-26-8.0 --&gt;
api-28-9.0 --&gt;
å¯ä»¥å‘ç°ï¼ŒDexClassLoaderé‡Œä»€ä¹ˆä¹Ÿæ²¡æœ‰åšï¼Œåªæ˜¯é‡å†™äº†BaseDexClassLoaderçš„æ„é€ å‡½æ•°,æ³¨æ„api28é‡Œé¢çš„è¿™æ®µæ ‡çº¢æ³¨é‡Šï¼šè¯¥å‚æ•°åœ¨api 26ä¹‹åå°±åºŸå¼ƒäº†ï¼Œåé¢ä¼šè®²åˆ°ã€‚
å†çœ‹BaseDexClassLoaderï¼š
api-25-7.1 --&gt;
api-26-8.0 &amp; api-28-9.0 --&gt;
æˆ‘ä»¬æŠŠç„¦ç‚¹æ”¾åœ¨optimizedDirectoryä¸Š:åº”è¯¥è¢«å†™å…¥çš„dexæ‰€åœ¨çš„ç›®å½•ã€‚é€šè¿‡æ„é€ ä¸‰ä¸ªç‰ˆæœ¬çš„å‡½æ•°å¯ä»¥çœ‹å‡ºï¼š8.0ä¹‹å‰ä½¿ç”¨äº†optimizedDirectoryå‚æ•°ï¼Œ8.0åŠ8.0ä¹‹åä¸å†ä½¿ç”¨è¯¥å‚æ•°ã€‚
æˆ‘ä»¬å†ç§»æ­¥çœ‹ä¸€ä¸‹PathClassLoaderï¼šPathClassLoaderæ˜¯ç³»ç»Ÿç±»å’Œç³»ç»Ÿåº”ç”¨çš„ç±»åŠ è½½å™¨:
PathClassLoader8.0å‰åå¹¶æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼ŒåŒæ ·é‡å†™äº†å››ä¸ªå‚æ•°çš„æ„é€ å‡½æ•°ï¼ŒoptimizedDirectoryä¸ºnullã€‚
æ€»ç»“ï¼š
8.0ä¹‹å‰ï¼ŒDexClassLoaderä¾›ç³»ç»Ÿï¼ˆè°·æ­Œå·¥ç¨‹å¸ˆï¼‰ä½¿ç”¨ï¼ŒPathClassLoaderæä¾›ç»™å¼€å‘è€…ä½¿ç”¨ï¼›8.0åŠä¹‹åå¹¶æ— åŒºåˆ«ã€‚åæ¥è°·æ­Œå·¥ç¨‹å¸ˆè¶Šæ¥è¶Šè§‰å¾—å†™ä¸¤ä¸ªåŠ è½½å™¨ç®€ç›´æ˜¯é—²å¾—è›‹ç–¼ï¼Œå¹²è„†å°±ä¸å†åŒºåˆ†äº†ã€‚ åŒºåˆ«ï¼š åœ¨8.0ä¹‹åå¹¶æ— åŒºåˆ«ï¼Œ
1.2 BootClassLoader å’ŒPathClassLoader /** *æ³¨æ„è¿™ä¸ªç±»æ´¾ç”Ÿè‡ªAppCompatActivityï¼Œè€ŒéActivity */ public class MainActivity extends AppCompatActivity { private static final String TAG = &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/61da3e3f65983a3f25e2299d253e2ced/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-11-23T00:33:13+08:00" />
<meta property="article:modified_time" content="2022-11-23T00:33:13+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="ITå­¦ä¹ è€…åšå®¢" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">ITå­¦ä¹ è€…åšå®¢</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Androidæ’ä»¶åŒ–åŸç†ï¼ˆä¸€ï¼‰â€”â€” æ’ä»¶ç±»åŠ è½½ã€ç±»åŠ è½½åŸç†ã€ï¼ˆåŒäº²å§”æ‰˜æœºåˆ¶)</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>è®°å½•ä¸€ä¸‹ï¼Œè¿™æ˜¯2020å¹´ç¬¬ä¸€ç¯‡å¸–å­ï¼Œä»Šå¹´ç«‹äº†ä¸€ä¸ªflagâ€“ç»å¸¸å†™å¸–å­ã€‚å› ä¸ºç–«æƒ…çš„åŸå› ï¼Œåªèƒ½æ¯å¤©åœ¨å®¶å…»è‚šçš®ï¼ŒèººåºŠä¸Šä¸ºç¤¾ä¼šåšè´¡çŒ®ã€‚å®åœ¨æ˜¯åä¸ä½äº†ï¼Œå°±å¼€å§‹å†™è¿™ç¯‡æ–‡ç« å§ã€‚å¸Œæœ›æ–°çš„ä¸€å¹´è‡ªå·±è¶Šæ¥è¶Šå‰å®³ï¼Œä¹Ÿå¸Œæœ›ç–«æƒ…æ—©ç‚¹è¿‡å»</p> 
<hr> 
<h3><a id="_5"></a>ï¼ˆä¸€ï¼‰ä»€ä¹ˆæ˜¯æ’ä»¶åŒ–</h3> 
<p>æ’ä»¶åŒ–æŠ€æœ¯æœ€åˆæºäºå…å®‰è£…è¿è¡Œapkçš„æƒ³æ³•ï¼Œè¿™ä¸ªå…å®‰è£…çš„apkå°±å¯ä»¥ç†è§£ä¸º<strong>æ’ä»¶</strong>ï¼Œè€Œæ”¯æŒæ’ä»¶çš„appæˆ‘ä»¬ä¸€èˆ¬ç§°ä¹‹ä¸º<strong>å®¿ä¸»</strong></p> 
<h3><a id="_8"></a>ï¼ˆäºŒï¼‰ä¸ºä»€ä¹ˆè¦æ’ä»¶åŒ–</h3> 
<p>1.appåŠŸèƒ½æ¨¡å—è¶Šæ¥è¶Šå¤šï¼Œä½“ç§¯è¶Šæ¥è¶Šå¤§ï¼Œç»´æŠ¤å˜å¾—å›°éš¾ï¼›<br> 2.æ¨¡å—ä¹‹é—´çš„è€¦åˆåº¦é«˜ï¼ŒååŒå¼€å‘æ²Ÿé€šæˆæœ¬è¶Šæ¥è¶Šé«˜ï¼›<br> 3.æ–¹æ³•æ•°ç›®å¯èƒ½è¶…è¿‡65535ï¼ŒAPPå ç”¨çš„å†…å­˜è¶Šæ¥è¶Šå¤§ï¼›<br> 4.å¢åŠ åŠŸèƒ½åªæ•¢åšåŠ æ³•ã€‚</p> 
<h3><a id="_14"></a>ï¼ˆä¸‰ï¼‰æ’ä»¶åŒ–å’Œæ¨¡å—ï¼ˆæ¨¡å—ï¼‰åŒ–çš„çˆ±æ¨çº è‘›</h3> 
<ul><li>ç»„ä»¶åŒ–å¼€å‘ä¸»è¦æ˜¯<strong>é€šè¿‡gradleé…ç½®</strong>ï¼Œå°†ä¸€ä¸ªappåˆ†æˆå¤šä¸ªæ¨¡å—ï¼Œæ¯ä¸ªæ¨¡å—éƒ½æ˜¯ä¸€ä¸ªç»„ä»¶ï¼Œå¼€å‘çš„è¿‡ç¨‹ä¸­æˆ‘ä»¬å¯ä»¥è®©è¿™äº›ç»„ä»¶ç›¸äº’ä¾èµ–æˆ–è€…å•ç‹¬è°ƒè¯•éƒ¨åˆ†ç»„ä»¶ç­‰ï¼Œä½†æ˜¯æœ€ç»ˆå‘å¸ƒçš„æ—¶å€™æ˜¯å°†è¿™äº›ç»„ä»¶åŒæ„åˆå¹¶æˆä¸€ä¸ªapkï¼Œè¿™å°±æ˜¯ç»„ä»¶åŒ–å¼€å‘ã€‚</li><li>æ’ä»¶åŒ–å’Œç»„ä»¶åŒ–ç•¥æœ‰ä¸åŒï¼Œæ’ä»¶åŒ–å¼€å‘æ˜¯å°†æ•´ä¸ªapkæ‹†åˆ†æˆå¤šä¸ªæ¨¡å—ï¼Œè¿™äº›æ¨¡å—åŒ…æ‹¬ä¸€ä¸ªå®¿ä¸»å’Œå¤šä¸ªæ’ä»¶ï¼Œæ¯ä¸ªæ¨¡å—éƒ½æ˜¯ä¸€ä¸ªapkï¼Œæœ€ç»ˆæ‰“åŒ…çš„æ—¶å€™å®¿ä¸»apkå’Œæ’ä»¶apkåˆ†å¼€æ‰“åŒ…ã€‚</li><li>æ’ä»¶åŒ–å…¶å®æ˜¯å»ºç«‹åœ¨æ¨¡å—åŒ–åŸºç¡€ä¸Šçš„ï¼Œæ’ä»¶åŒ–åœ¨å®æ–½ä¹‹å‰éœ€è¦å…ˆè¿›æ€§æ¨¡å—åŒ–ã€‚</li></ul> 
<hr> 
<h3><a id="_21"></a>ï¼ˆå››ï¼‰æ ¸å¿ƒ-æ’ä»¶åŒ–åŸç†ï¼ˆæ–¹æ¡ˆä¹‹ä¸€ï¼‰</h3> 
<p>å„å¤§å¹³å°æ–¹æ¡ˆå¯¹æ¯”<br> [å¤–é“¾å›¾ç‰‡è½¬å­˜å¤±è´¥,æºç«™å¯èƒ½æœ‰é˜²ç›—é“¾æœºåˆ¶,å»ºè®®å°†å›¾ç‰‡ä¿å­˜ä¸‹æ¥ç›´æ¥ä¸Šä¼ <br> <img src="https://images2.imgbox.com/0d/89/0FqxT4r7_o.png" alt="å„å¤§å¹³å°æ’ä»¶åŒ–æ–¹æ¡ˆå¯¹æ¯”"><br> ä¸å†ä¸€ä¸€ä»‹ç»åŸç†ï¼Œæœ¬æ¬¡ä¸»é¢˜æ˜¯åŸºäº <strong>360çš„DroidPlugin</strong></p> 
<p><strong>æ¥ä¸‹æ¥æ˜¯æ’ä»¶åŒ–çš„æ ¸å¿ƒï¼š</strong></p> 
<blockquote> 
 <ul><li>å¦‚ä½•åŠ è½½æ’ä»¶çš„ç±»ï¼Ÿ</li><li>å¦‚ä½•åŠ è½½æ’ä»¶çš„èµ„æºï¼Ÿ</li><li>å¦‚ä½•è°ƒç”¨æ’ä»¶çš„ç±»(å››å¤§ç»„ä»¶)ï¼Ÿ</li></ul> 
</blockquote> 
<h4><a id="__32"></a>ä¸€. å¦‚ä½•åŠ è½½æ’ä»¶çš„ç±»</h4> 
<h5><a id="1__33"></a>1. ç±»åŠ è½½å™¨</h5> 
<p>æ¯«æ— ç–‘é—®ï¼Œç±»æ˜¯é€šè¿‡ç±»åŠ è½½å™¨classLoaderåŠ è½½çš„ï¼Œæˆ‘ä»¬å…ˆçœ‹å‡ ç§ç±»åŠ è½½å™¨.</p> 
<h6><a id="11_PathClassLoaderDexClassLoader_36"></a>1.1 <strong>PathClassLoaderå’ŒDexClassLoader</strong>åŒºåˆ«</h6> 
<p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹<strong>DexClassLoader</strong>:</p> 
<blockquote> 
 <p><strong>DexClassLoader ç”¨äºåŠ è½½.jar .apk .dexä¸­çš„ç±»ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥åŠ è½½ä¸æ˜¯åº”ç”¨ç¨‹åºä¸­çš„ä»£ç </strong></p> 
</blockquote> 
<p><strong>api-25-7.1 --&gt;</strong><br> <img src="https://images2.imgbox.com/7e/0a/Qvh1jLTe_o.jpg" alt="DexClassLoader-api-25"></p> 
<p><strong>api-26-8.0 --&gt;</strong></p> 
<p><img src="https://images2.imgbox.com/f9/61/mjZYv2yh_o.jpg" alt="DexClassLoader-api-26"></p> 
<p><strong>api-28-9.0 --&gt;</strong></p> 
<p><img src="https://images2.imgbox.com/67/54/2nTcQLbz_o.jpg" alt="DexClassLoader-api-28"></p> 
<p>å¯ä»¥å‘ç°ï¼ŒDexClassLoaderé‡Œä»€ä¹ˆä¹Ÿæ²¡æœ‰åšï¼Œåªæ˜¯é‡å†™äº†BaseDexClassLoaderçš„æ„é€ å‡½æ•°,æ³¨æ„api28é‡Œé¢çš„è¿™æ®µæ ‡çº¢æ³¨é‡Šï¼šè¯¥å‚æ•°åœ¨api 26ä¹‹åå°±åºŸå¼ƒäº†ï¼Œåé¢ä¼šè®²åˆ°ã€‚</p> 
<p>å†çœ‹<strong>BaseDexClassLoader</strong>ï¼š</p> 
<p><strong>api-25-7.1 --&gt;</strong><br> <img src="https://images2.imgbox.com/6c/fd/YxFEkkXC_o.jpg" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<p><strong>api-26-8.0 &amp; api-28-9.0 --&gt;</strong><br> <img src="https://images2.imgbox.com/80/92/60OA1RGB_o.jpg" alt="BaseDexClassLoader-api26"></p> 
<p>æˆ‘ä»¬æŠŠç„¦ç‚¹æ”¾åœ¨<strong>optimizedDirectory</strong>ä¸Š:åº”è¯¥è¢«å†™å…¥çš„dexæ‰€åœ¨çš„ç›®å½•ã€‚é€šè¿‡æ„é€ ä¸‰ä¸ªç‰ˆæœ¬çš„å‡½æ•°å¯ä»¥çœ‹å‡ºï¼š<strong>8.0ä¹‹å‰ä½¿ç”¨äº†optimizedDirectoryå‚æ•°ï¼Œ8.0åŠ8.0ä¹‹åä¸å†ä½¿ç”¨è¯¥å‚æ•°</strong>ã€‚</p> 
<p>æˆ‘ä»¬å†ç§»æ­¥çœ‹ä¸€ä¸‹<strong>PathClassLoader</strong>ï¼šPathClassLoaderæ˜¯ç³»ç»Ÿç±»å’Œç³»ç»Ÿåº”ç”¨çš„ç±»åŠ è½½å™¨:<br> <img src="https://images2.imgbox.com/40/97/AW8V6aNt_o.jpg" alt="PathClassLoader"><br> PathClassLoader8.0å‰åå¹¶æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼ŒåŒæ ·é‡å†™äº†å››ä¸ªå‚æ•°çš„æ„é€ å‡½æ•°ï¼ŒoptimizedDirectoryä¸ºnullã€‚</p> 
<p><strong>æ€»ç»“ï¼š</strong></p> 
<blockquote> 
 <ul><li>8.0ä¹‹å‰ï¼ŒDexClassLoaderä¾›ç³»ç»Ÿï¼ˆè°·æ­Œå·¥ç¨‹å¸ˆï¼‰ä½¿ç”¨ï¼ŒPathClassLoaderæä¾›ç»™å¼€å‘è€…ä½¿ç”¨ï¼›</li><li>8.0åŠä¹‹åå¹¶æ— åŒºåˆ«ã€‚åæ¥è°·æ­Œå·¥ç¨‹å¸ˆè¶Šæ¥è¶Šè§‰å¾—å†™ä¸¤ä¸ªåŠ è½½å™¨ç®€ç›´æ˜¯é—²å¾—è›‹ç–¼ï¼Œå¹²è„†å°±ä¸å†åŒºåˆ†äº†ã€‚</li></ul> 
</blockquote> 
<p><strong>åŒºåˆ«ï¼š</strong> åœ¨8.0ä¹‹åå¹¶æ— åŒºåˆ«ï¼Œ</p> 
<h6><a id="12_BootClassLoader_PathClassLoader_77"></a>1.2 BootClassLoader å’ŒPathClassLoader</h6> 
<pre><code class="prism language-java"><span class="token comment">/**
*æ³¨æ„è¿™ä¸ªç±»æ´¾ç”Ÿè‡ªAppCompatActivityï¼Œè€ŒéActivity
*/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainActivity</span> <span class="token keyword">extends</span> <span class="token class-name">AppCompatActivity</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TAG</span> <span class="token operator">=</span> <span class="token string">"MainActivity"</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token class-name">Bundle</span> savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setContentView</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">findClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">findClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ClassLoader</span> classLoader <span class="token operator">=</span> <span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>classLoader <span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"findClassLoader: classLoader : "</span><span class="token operator">+</span>classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
            classLoader <span class="token operator">=</span> classLoader<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"findClassLoader: classLoader : "</span><span class="token operator">+</span> <span class="token class-name">Activity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>è®©æˆ‘çš„å°åŠ©ç†è¿è¡Œä¸€ä¸‹ä»£ç ï¼Œå°æ‰‹é‚£ä¹ˆä¸€ç‚¹ï¼Œè¿è¡Œç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š</p> 
<p><img src="https://images2.imgbox.com/71/21/Whf6kVHz_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<p>é€šè¿‡ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥å¾—çŸ¥ï¼š<br> MainActivity çš„classLoaderæ˜¯ PathClassLoaderï¼›Activity çš„classLoaderæ˜¯BootClassLoaderï¼› PathClassLoaderçš„parentæ˜¯BootClassLoaderã€‚</p> 
<p>å…¶å®ä»–ä»¬ä¸¤ä¸ªçš„ä½œç”¨</p> 
<blockquote> 
 <ul><li>BootClassLoader â€“ åŠ è½½FramWorkçš„classæ–‡ä»¶ï¼›</li><li>PathClassLoader â€“ åŠ è½½åº”ç”¨å†…çš„classæ–‡ä»¶ï¼ŒåŒ…å«implementationåˆ°çš„ç¬¬ä¸‰æ–¹åº“ä»¥åŠ.jarã€.aarç­‰ã€‚</li></ul> 
</blockquote> 
<hr> 
<h5><a id="2__114"></a>2. ç±»çš„ç”Ÿå‘½å‘¨æœŸ</h5> 
<p><img src="https://images2.imgbox.com/cf/8a/YshhcI9I_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<p>è¿™é‡Œæˆ‘ä»¬é‡ç‚¹äº†è§£ä¸€ä¸‹<strong>ç±»åŠ è½½</strong>é˜¶æ®µä¸»è¦åšçš„äº‹æƒ…ï¼š</p> 
<blockquote> 
 <ul><li>é€šè¿‡ä¸€ä¸ªç±»çš„å…¨é™å®šåæ¥è·å–å®šä¹‰æ­¤ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµï¼›</li><li>å°†è¿™ä¸ªå­—èŠ‚æµæ‰€ä»£è¡¨çš„é™æ€å­˜å‚¨ç»“æ„è½¬åŒ–ä¸ºæ–¹æ³•åŒºåŸŸçš„è¿è¡Œæ—¶æ•°æ®ç»“æ„ã€‚</li><li>åœ¨javaå †ä¸­ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¿™ä¸ªç±»çš„Classå¯¹è±¡ï¼Œä½œä¸ºæ–¹æ³•åŒºåŸŸæ•°æ®çš„è®¿é—®å…¥å£ã€‚</li></ul> 
</blockquote> 
<p>å…¶å®ƒé˜¶æ®µä¸æ˜¯æˆ‘ä»¬æœ¬ç« çš„é‡ç‚¹ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ï¼Œå¯å‚è€ƒ<a href="https://www.cnblogs.com/ipetergo/p/6441310.html" rel="nofollow">Javaç±»çš„ç”Ÿå‘½å‘¨æœŸ</a>ã€‚</p> 
<hr> 
<h5><a id="3__127"></a>3 åŠ è½½ä¸€ä¸ªç±»</h5> 
<blockquote> 
 <p>æ³¨ï¼šæ¼”ç¤ºä»£ç æ˜¯åŸºäºAndroid API 9.0çš„<br> æ³¨ï¼šæ¼”ç¤ºä»£ç æ˜¯åŸºäºAndroid API 9.0çš„<br> æ³¨ï¼šæ¼”ç¤ºä»£ç æ˜¯åŸºäºAndroid API 9.0çš„</p> 
</blockquote> 
<p>é‡è¦çš„è¯è¯´ä¸‰é</p> 
<h6><a id="31__136"></a>3.1 <strong>ã€ŒåŒäº²å§”æ‰˜ã€</strong></h6> 
<p>é¦–å…ˆé€šè¿‡ä»£ç æ¼”ç¤ºå¦‚ä½•åŠ è½½ä¸€ä¸ªç±»æ¥è¯·å‡ºä¸€ä¸ªä¼ è¯´ä¸­çš„å¤§â€œäººç‰©â€â€”â€”<strong>åŒäº²å§”æ‰˜æœºåˆ¶</strong>ï¼š</p> 
<pre><code class="prism language-java">       <span class="token class-name">String</span> dexPath <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
       <span class="token class-name">DexClassLoader</span> dexClassLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DexClassLoader</span><span class="token punctuation">(</span>dexPath<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCacheDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz <span class="token operator">=</span> dexClassLoader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">"com.margin.plugin.ProxyActivity"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>è¿™æ ·ï¼Œä¸€ä¸ªç±»ï¼ˆæ’ä»¶ä¸­çš„ç±»ï¼‰å°±è¢«åŠ è½½æˆåŠŸäº†ã€‚é‚£ä¹ˆï¼Œç±»ç©¶ç«Ÿæ˜¯å¦‚ä½•åŠ è½½çš„å‘¢ï¼Œè¯·å°åŠ©ç†ä½äºClassLoaderä¸­çš„loadClassæŠŠæºç æ‹¿è¿‡æ¥ï¼š</p> 
<ul><li><strong>loadClass-1 :</strong><br> <img src="https://images2.imgbox.com/27/3c/tYTVkj9b_o.jpg" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></li></ul> 
<p>é¦–å…ˆé€šè¿‡findLoadedClassæ£€æŸ¥æ˜¯å¦å·²ç»åŠ è½½è¿‡äº†ï¼›å¦‚æœæ²¡æœ‰åŠ è½½è¿‡ï¼Œæ£€æŸ¥æ˜¯å¦å­˜åœ¨parentï¼ˆæ³¨æ„è¿™ä¸ªparentçˆ¶æ¯å³åŒäº²ï¼Œå¹¶ä¸æ˜¯æŒ‡çˆ¶ç±»ï¼Œè€Œæ˜¯ä¸Šä¸€çº§ï¼‰ï¼Œå¦‚æœåŒäº²å­˜åœ¨åˆ™è°ƒç”¨parentçš„loadClassï¼ˆï¼‰æ–¹æ³•,ä¾æ¬¡é€’å½’ï¼›</p> 
<p>æ¸…æ¥šæ­¤æµç¨‹äº†ï¼Œé‚£ä¹ˆä¸€ä¸ªå‡ ä¹æ‰€æœ‰å°å­©å­éƒ½é—®è¿‡çš„é—®é¢˜æ¥äº†â€”â€”æˆ‘æ˜¯ä»å“ªé‡Œæ¥çš„ï¼Ÿä¸ä¸ä¸ï¼Œæ˜¯<strong>parentä»å“ªé‡Œæ¥çš„</strong>ğŸ˜³ğŸ˜³ğŸ˜³ï¼Ÿï¼Ÿï¼Ÿ</p> 
<pre><code class="prism language-java"> <span class="token class-name">DexClassLoader</span> dexClassLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DexClassLoader</span><span class="token punctuation">(</span>dexPath<span class="token punctuation">,</span>     <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCacheDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>æˆ‘ä»¬åœ¨new DexClassLoaderçš„æ—¶å€™ä¼ é€’çš„ç¬¬å››ä¸ªå‚æ•°å°±æ˜¯parentï¼Œé€šè¿‡1.2å’Œ1.3å¾—çŸ¥ï¼Œè¿™ä¸ªgetClassLoaderå¾—åˆ°çš„æ˜¯PathClassLoaderï¼Œæ‰€ä»¥è¿™é‡Œçš„classLoaderå±‚çº§å…³ç³»ä¸ºï¼š</p> 
<p><img src="https://images2.imgbox.com/7c/f0/7ZXVPQ3G_o.png" alt="ç±»åŠ è½½å™¨parentå±‚çº§å…³ç³»"></p> 
<p>è¿™æ ·ï¼Œä¸€å±‚ä¸€å±‚å‘ä¸ŠæŸ¥æ‰¾çš„è¿‡ç¨‹ï¼Œæœ€ç»ˆåˆ°äº†BootClassLoaderçš„loadClassæ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å°åŠ©ç†å†æ¥ä¸Šä¸€ä¸‹ä»£ç :</p> 
<ul><li><strong>loadClass-2 :</strong> <img src="https://images2.imgbox.com/dd/50/z2b8yHFh_o.jpg" alt="bcl-loadClass"></li></ul> 
<blockquote> 
 <p>æ³¨ï¼šBootClassLoader æ˜¯ClassLoaderçš„ä¸€ä¸ªå†…éƒ¨ç±»ã€‚</p> 
</blockquote> 
<p>åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œä»ç„¶æ˜¯å…ˆé€šè¿‡findLoadedClassåˆ¤æ–­æ˜¯å¦å·²ç»åŠ è½½è¿‡ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±ä¸å†æ‰¾parentï¼Œè€Œæ˜¯ç›´æ¥è°ƒç”¨findClassæ–¹æ³•å¹¶è¿”å›class</p> 
<p><img src="https://images2.imgbox.com/32/65/fMpbpke2_o.jpg" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<p>åŒäº²å°†åŠ è½½åˆ°çš„classä¾æ¬¡å‘ä¸‹è¿”å›ï¼Œç¬¬ä¸€å±‚çº§çš„parentæ£€æŸ¥æ˜¯å¦ä¸ºnullï¼Œå¦‚æœä¸ºnullåˆ™è°ƒç”¨è‡ªå·±çš„findClassæ–¹æ³•ï¼Œå°†ç»“æœå†æ¬¡å‘ä¸‹è¿”å›ç›´è‡³æœ€åˆçš„DexClassLoaderä¸­çš„loadClassæ–¹æ³•ä¸­ï¼ˆä»£ç  loadClass-1ï¼‰ï¼Œæ­¤æ—¶ï¼Œå¦‚æœåŒäº²æ‰¾åˆ°çš„classä»ç„¶ä¸ºnullï¼Œé‚£ä¹ˆï¼Œå°±è°ƒç”¨è‡ªå·±çš„findClassæ–¹æ³•æŸ¥æ‰¾class</p> 
<p><strong>åŒäº²å§”æ‰˜æœºåˆ¶çš„æµç¨‹å›¾</strong></p> 
<p><img src="https://images2.imgbox.com/df/7b/JuF8pvnH_o.png" alt="åŒäº²å§”æ‰˜æœºåˆ¶"></p> 
<p><strong>æ€»ç»“ã€åŒäº²å§”æ‰˜æœºåˆ¶ã€</strong></p> 
<blockquote> 
 <ul><li>1.é¦–å…ˆé€šè¿‡findLoadedClassæ£€æŸ¥æ˜¯å¦å·²ç»åŠ è½½è¿‡äº†ï¼›</li><li>2.å¦‚æœæ²¡æœ‰åŠ è½½è¿‡ï¼Œæ£€æŸ¥æ˜¯å¦å­˜åœ¨parentï¼ˆæ³¨æ„è¿™ä¸ªparentçˆ¶æ¯å³åŒäº²ï¼Œå¹¶ä¸æ˜¯æŒ‡çˆ¶ç±»ï¼Œè€Œæ˜¯ä¸Šä¸€çº§ï¼‰ï¼Œå¦‚æœåŒäº²å­˜åœ¨åˆ™è°ƒç”¨parentçš„loadClassï¼ˆï¼‰æ–¹æ³•,ä¾æ¬¡é€’å½’è°ƒç”¨ï¼Œå½“åˆ°è¾¾é¡¶éƒ¨çš„æ—¶å€™ä¸å†æ£€æŸ¥åŒäº²è€Œæ˜¯è°ƒç”¨findClassæ–¹æ³•å¹¶ä½å±‚è¿”å›ç»“æœï¼›</li><li>3.å¦‚æœæœ€ç»ˆéƒ½æ²¡æœ‰æŸ¥æ‰¾åˆ°æˆ–åŠ è½½æˆåŠŸåˆ™è°ƒç”¨è‡ªèº«çš„findClasså¹¶è¿”å›ç»“æœã€‚</li></ul> 
</blockquote> 
<p>ä¸ºä»€ä¹ˆä½¿ç”¨åŒäº²å§”æ‰˜æœºåˆ¶ï¼Ÿ</p> 
<blockquote> 
 <ul><li>1.é¿å…é‡å¤åŠ è½½ï¼Œå½“åŒäº²åŠ è½½å™¨å·²ç»åŠ è½½äº†è¯¥ç±»çš„æ—¶å€™ï¼Œå°±æ²¡æœ‰å¿…è¦å­ClassLoaderå†æ¬¡åŠ è½½ï¼›</li><li>2.å®‰å…¨æ€§è€ƒè™‘ï¼Œé˜²æ­¢æ ¸å¿ƒAPIåº“è¢«éšæ„ç¯¡æ”¹ã€‚</li></ul> 
</blockquote> 
<p>è‡³æ­¤ï¼ŒåŒäº²å§”æ‰˜æœºåˆ¶ä»‹ç»å®Œæ¯•ã€‚</p> 
<h6><a id="32__190"></a>3.2 åŠ è½½ç±»</h6> 
<h6><a id="321_findLoadedClass_191"></a>3.2.1 æŸ¥æ‰¾å·²åŠ è½½çš„ç±»findLoadedClass</h6> 
<p><img src="https://images2.imgbox.com/24/4f/15hgt7wz_o.png" alt="cl-findLoadedClass2"><br> <img src="https://images2.imgbox.com/1d/da/wBlKFcPD_o.png" alt="vm-findLoadedClass"></p> 
<p>æœ€ç»ˆåˆ°è¾¾Nativeå±‚ï¼Œç„¶åå…ˆè¿™æ ·å†è¿™æ ·åœ¨é‚£æ ·ï¼Œå°±å®Œæˆäº†ï¼Œå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆ</p> 
<h6><a id="322_findClass_197"></a>3.2.2 æŸ¥æ‰¾ç±»findClass</h6> 
<p>æŸ¥çœ‹BootClassLoaderçš„findClassæ–¹æ³•ï¼š<br> <img src="https://images2.imgbox.com/ca/15/DDcdTEdg_o.png" alt="bcl-findClass-2"><br> æ­¤å¤„åªæ˜¯é‡å†™äº†ClassLoaderçš„findClassæ–¹æ³•ï¼Œè°ƒç”¨äº†Classçš„nativeæ–¹æ³•ã€‚</p> 
<p>æˆ‘ä»¬åœ¨çœ‹DexClassLoaderå’ŒPathClassLoaderï¼Œä»–ä»¬çš„findClassç”±å…¶çˆ¶ç±»BaseDexClassLoaderé‡å†™ï¼š</p> 
<ul><li> <p>ä»£ç å—1<br> <img src="https://images2.imgbox.com/4f/e4/80lrly2c_o.png" alt="bdcl-findClass"><br> è¿™é‡Œæ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„ï¼Œæ ¸å¿ƒæ˜¯é€šè¿‡pathList.findClass()æŸ¥æ‰¾classï¼ŒpathListæ˜¯DexPathListçš„å®ä¾‹ï¼Œæˆ‘ä»¬æ¥ç€çœ‹è¿™ä¸ªæ–¹æ³•ï¼š</p> </li><li> <p>ä»£ç å—2<br> <img src="https://images2.imgbox.com/ee/99/mk6usjXy_o.jpg" alt="DexPathList-findClass"></p> </li></ul> 
<p>è¿™ä¸ªæ–¹æ³•è¿­ä»£dexElementsï¼Œé€šè¿‡ElementæŸ¥æ‰¾ç›®æ ‡classï¼ŒElementæ˜¯DexPathListçš„ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œå’±ä»¬å†çœ‹çœ‹å…¶æ–¹æ³•:</p> 
<ul><li>ä»£ç å—3<br> <img src="https://images2.imgbox.com/b2/0c/XsYx4w9e_o.png" alt="Element-findClass"></li></ul> 
<p>å¦‚æœdexFileä¸ä¸ºç©ºï¼Œåˆ™è°ƒç”¨dexFile.loadClassBinaryNameè¿”å›classã€‚dexFileæ˜¯Elementçš„ä¸€ä¸ªå˜é‡ï¼Œç”±æ„é€ å™¨ä¼ å…¥ã€‚é‚£ä¹ˆæˆ‘ä»¬å°±å¾—çœ‹çœ‹Elementä»ä½•è€Œæ¥ï¼Œä»ä¸Šé¢å¯çŸ¥ï¼ŒElementç”±dexElementsè€Œæ¥ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¾—çœ‹dexElementsæ˜¯æ€ä¹ˆæ¥çš„ã€‚</p> 
<p>DexPathListçš„è¿‡ä¸ªæ„é€ å‡½æ•°ä¸­éƒ½æœ‰dexElementsçš„åˆ›å»ºï¼š<br> <img src="https://images2.imgbox.com/6d/5f/EbC0iIp1_o.png" alt="DexPathList-constructor-dexElements"></p> 
<p>å…³é”®æ˜¯è¿™ä¸€è¡Œï¼š</p> 
<pre><code class="prism language-java">    <span class="token keyword">this</span><span class="token punctuation">.</span>dexElements <span class="token operator">=</span> <span class="token function">makeDexElements</span><span class="token punctuation">(</span><span class="token function">splitDexPath</span><span class="token punctuation">(</span>dexPath<span class="token punctuation">)</span><span class="token punctuation">,</span>optimizedDirectory<span class="token punctuation">,</span>suppressedExceptions<span class="token punctuation">,</span> definingContext<span class="token punctuation">,</span> isTrusted<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>å¯è§dexElementsç”±è¯¥æ–¹æ³•åˆ›å»ºçš„ï¼Œæˆ‘ä»¬æ¥ç€æŸ¥çœ‹è¯¥æ–¹æ³•ï¼Œåœ¨çœ‹ä¸€ä¸‹ï¼Œä¸å¦¨å…ˆçœ‹ä¸€ä¸‹ç¬¬ä¸€ä¸ªå‚æ•°çš„æ–¹æ³•splitDexPathæ–¹æ³•ï¼š<br> <img src="https://images2.imgbox.com/44/0c/NZbaSqDJ_o.png" alt="DexPathList-splitDexPath"></p> 
<p>splitDexPathï¼ˆï¼‰æ–¹æ³•ä¸»è¦ä½œç”¨ï¼šé€šè¿‡åˆ†éš”ç¬¦æŠŠç»™å®šçš„pathåˆ†æˆä¸€ä¸ªä¸ªFileï¼Œå¹¶å°†ç»“æœä»¥Listçš„å½¢å¼è¿”å›ï¼Œå®ƒå»é™¤ä¸å¯è¯»ï¼Œä¸å¯ç”¨çš„ã€å¸¸è§„çš„æ–‡ä»¶ç­‰ç­‰ã€‚ çŸ¥é“äº†splitDexPathï¼ˆï¼‰çš„ä½œç”¨ï¼Œæˆ‘ä»¬å†è¿”å›æŸ¥çœ‹makeDexElementsï¼ˆï¼‰æ–¹æ³•ï¼š</p> 
<pre><code class="prism language-java">       <span class="token comment">/**
     * Makes an array of dex/resource path elements, one per element of
     * the given array.
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Element</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">makeDexElements</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">File</span><span class="token punctuation">&gt;</span></span> files<span class="token punctuation">,</span> <span class="token class-name">File</span> optimizedDirectory<span class="token punctuation">,</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IOException</span><span class="token punctuation">&gt;</span></span> suppressedExceptions<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> loader<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">makeDexElements</span><span class="token punctuation">(</span>files<span class="token punctuation">,</span> optimizedDirectory<span class="token punctuation">,</span> suppressedExceptions<span class="token punctuation">,</span> loader<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Element</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">makeDexElements</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">File</span><span class="token punctuation">&gt;</span></span> files<span class="token punctuation">,</span> <span class="token class-name">File</span> optimizedDirectory<span class="token punctuation">,</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IOException</span><span class="token punctuation">&gt;</span></span> suppressedExceptions<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> loader<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isTrusted<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token class-name">Element</span><span class="token punctuation">[</span><span class="token punctuation">]</span> elements <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Element</span><span class="token punctuation">[</span>files<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">int</span> elementsPos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token comment">/*
       * Open all files and load the (direct or contained) dex files up front.
       */</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">File</span> file <span class="token operator">:</span> files<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token comment">// We support directories for looking up resources. Looking up resources in</span>
              <span class="token comment">// directories is useful for running libcore tests.</span>
              elements<span class="token punctuation">[</span>elementsPos<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Element</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">isFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token class-name">String</span> name <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

              <span class="token class-name">DexFile</span> dex <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token constant">DEX_SUFFIX</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                  <span class="token comment">// Raw dex file (not inside a zip/jar).</span>
                  <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                      dex <span class="token operator">=</span> <span class="token function">loadDexFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> optimizedDirectory<span class="token punctuation">,</span> loader<span class="token punctuation">,</span> elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token keyword">if</span> <span class="token punctuation">(</span>dex <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                          elements<span class="token punctuation">[</span>elementsPos<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Element</span><span class="token punctuation">(</span>dex<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token punctuation">}</span>
                  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> suppressed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                      <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">logE</span><span class="token punctuation">(</span><span class="token string">"Unable to load dex file: "</span> <span class="token operator">+</span> file<span class="token punctuation">,</span> suppressed<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      suppressedExceptions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>suppressed<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>
              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                  <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                      dex <span class="token operator">=</span> <span class="token function">loadDexFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> optimizedDirectory<span class="token punctuation">,</span> loader<span class="token punctuation">,</span> elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> suppressed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                      <span class="token comment">/*
                       * IOException might get thrown "legitimately" by the DexFile constructor if
                       * the zip file turns out to be resource-only (that is, no classes.dex file
                       * in it).
                       * Let dex == null and hang on to the exception to add to the tea-leaves for
                       * when findClass returns null.
                       */</span>
                      suppressedExceptions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>suppressed<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>

                  <span class="token keyword">if</span> <span class="token punctuation">(</span>dex <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                      elements<span class="token punctuation">[</span>elementsPos<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Element</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                      elements<span class="token punctuation">[</span>elementsPos<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Element</span><span class="token punctuation">(</span>dex<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>
              <span class="token punctuation">}</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>dex <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> isTrusted<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                dex<span class="token punctuation">.</span><span class="token function">setTrusted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
              <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">logW</span><span class="token punctuation">(</span><span class="token string">"ClassLoader referenced unknown path: "</span> <span class="token operator">+</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>elementsPos <span class="token operator">!=</span> elements<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          elements <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span>elements<span class="token punctuation">,</span> elementsPos<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> elements<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre> 
<p>è¿™ä¸ªæ–¹æ³•é‡Œé¢å°±æ˜¯è¿­ä»£splitDexPathæ‰€è¿”å›çš„Listï¼Œé€šè¿‡fileæŸ¥æ‰¾åˆ°dexFileï¼Œç„¶ååˆ›å»ºä¸€ä¸ªElementçš„å®ä¾‹å¹¶å°†dexFileæ”¾å…¥ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªdexå¯¹åº”ä¸€ä¸ªElementï¼Œå†å°†Elementæ”¾å…¥elementsæ•°ç»„ä¸­ï¼Œæœ€åè¿”å›elementsï¼Œè¿™ä¸ªelementså°±å¯¹åº”äº†ä¸€ä¸ªapkä¸­çš„æ‰€æœ‰æ–‡ä»¶ã€‚</p> 
<p><img src="https://images2.imgbox.com/c5/7f/Z1Zl3Adv_o.png" alt="class.dex"></p> 
<p>å¦‚æœclassLoaderæ˜¯PathClassLoaderï¼Œelementså°±æ˜¯åº”ç”¨å†…çš„æ‰€æœ‰ç±»ï¼Œå¦‚æœclassLoaderæ˜¯DexClassLoaderï¼Œåˆ™éœ€è¦çœ‹åˆ›å»ºå®ä¾‹æ—¶ä¼ é€’çš„ç¬¬ä¸€ä¸ªå‚æ•°pathè·¯å¾„ä¸‹çš„ã€‚</p> 
<h5><a id="4__312"></a>4. åŠ è½½æ’ä»¶ä¸­çš„ç±»</h5> 
<p>1.åˆ›å»ºä¸€ä¸ªæ’ä»¶ï¼š</p> 
<ul><li>step1ï¼šåœ¨é¡¹ç›®ä¸­æ–°å»ºä¸€ä¸ªmodule:plugin,éšä¾¿æ–°å»ºä¸€ä¸ªç±»ï¼š</li></ul> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TAG</span> <span class="token operator">=</span> <span class="token string">"Test"</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">sayHi</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"sayHi: Hello , this is Plug-in"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>step2ï¼šå°†Test.classæ‰“åŒ…æˆdexæ–‡ä»¶ï¼š<br> ç»ˆç«¯å®šä½åˆ°ï¼šmoduleä¸‹javacä¸­çš„build/intermediates/javac/debug/classes<br> ç„¶åæ‰§è¡Œå‘½ä»¤ï¼š dx --dex --output=test.dex com/margin/plugin/Test.class<br> æ‰§è¡Œå®Œä¹‹åå¯ä»¥çœ‹åˆ°classesç›®å½•ä¸‹å¤šäº†ä¸€ä¸ªtest.dexæ–‡ä»¶ã€‚<br> -step3ï¼šå°†dexæ–‡ä»¶æ”¾åˆ°sdå¡ä¸­ï¼š</li></ul> 
<p><img src="https://images2.imgbox.com/8a/24/T0EVm5rN_o.jpg" alt="class.dex"><br> -step4:åœ¨å®¿ä¸»appä¸­ç¼–å†™ä»£ç å¹¶è¿è¡Œï¼Œåˆ«å¿˜äº†åœ¨æ¸…å•æ–‡ä»¶ä¸­æ·»åŠ æ–‡ä»¶è¯»å†™æƒé™ï¼Œä»£ç ä¸­ä¸è¦å¿˜äº†å†™è¿è¡Œæ—¶æƒé™æ£€æŸ¥ï¼š</p> 
<pre><code class="prism language-java"> <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">luanchClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> <span class="token class-name">String</span> dexPath <span class="token operator">=</span> <span class="token string">"/sdcard/test.dex"</span><span class="token punctuation">;</span>
        <span class="token class-name">PathClassLoader</span> dexClassLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PathClassLoader</span><span class="token punctuation">(</span>dexPath<span class="token punctuation">,</span> <span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//ç±»çš„è·¯å¾„</span>
            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> testClazz <span class="token operator">=</span> dexClassLoader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">"com.margin.plugin.Test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//åŠ è½½åˆ°ç±»ä¹‹åï¼Œåå°„è°ƒç”¨å…¶æ–¹æ³•</span>
            <span class="token class-name">Method</span> sayHiMethod <span class="token operator">=</span> testClazz<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"sayHi"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sayHiMethod<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMethodException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalAccessException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InvocationTargetException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
</code></pre> 
<p>åŠ è½½åˆ°ç±»ä¹‹åï¼Œåå°„è°ƒç”¨æ–¹æ³•ï¼Œï¼ˆåˆ«å¿˜äº†æ·»åŠ æ–‡ä»¶è®¿é—®æƒé™ï¼‰ï¼Œç»“æœå¦‚ä¸‹ï¼š<br> <img src="https://images2.imgbox.com/c2/b1/fCXLUBxt_o.jpg" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<p>çœ‹åˆ°æ—¥å¿—çš„é‚£ä¸€ç¬é—´ï¼Œæ³ªç›®äº†ï¼Œç»ˆäºç±»åŠ è½½æˆåŠŸäº†ï¼Œè¾›è¾›è‹¦è‹¦å…»äº†å¤šå¹´çš„çŒªï¼Œç»ˆäºä¼šæ‹±ç™½èœäº†ğŸ˜€ğŸ˜€ğŸ˜€ã€‚<br> å¯æ˜¯ï¼Œè¿™å°±å®Œäº†å˜›ï¼Ÿå½“ç„¶ä¸æ˜¯ï¼Œå¦‚æœæ˜¯è¿™ä¹ˆç®€å•ï¼Œæˆ‘ä»¬å°±ä¸ä¼šåœ¨å‰é¢é•¿ç¯‡å¤§è®ºè®²ç±»åŠ è½½è¿œç¦»äº†ï¼Œè€Œä¸”è¿™ç§æ–¹å¼æ¯æ¬¡è°ƒç”¨éƒ½è¦ä½¿ç”¨ç±»åŠ è½½å™¨åŠ è½½åŠå…¶ä¸æ–¹ä¾¿ï¼Œæ€ä¹ˆåŠå‘¢ï¼Œè¯·çœ‹ä¸‹æ–‡ã€‚</p> 
<h5><a id="5_363"></a>5.å°†æ’ä»¶ä¸å®¿ä¸»çš„ç±»åˆå¹¶</h5> 
<p>ä¸Šé¢ç¬¬4æ­¥ï¼Œæ˜¯ä½¿ç”¨æ—¶åŠ è½½çš„æ–¹å¼ï¼Œè¿™ç§æ–¹å¼å¾ˆä¸æ–¹ä¾¿ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¢ä¸€ç§æ–¹å¼ï¼ŒåŠ è½½åˆå¹¶æ’ä»¶ï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯åœ¨appå¯åŠ¨ï¼ˆå½“ç„¶æ—¶æœºæ˜¯è‡ªå®šçš„ï¼‰æ—¶å°†æ’ä»¶å…¨éƒ¨åŠ è½½å¹¶åˆå¹¶åˆ°å®¿ä¸»ä¸­ã€‚</p> 
<p>è¿™ç§æ–¹å¼çš„æ ¸å¿ƒæ€æƒ³å°±æ˜¯ï¼Œ<strong>å°†æ’ä»¶çš„ç±»åˆå¹¶åˆ°å®¿ä¸»</strong>ä¸­ï¼Œå…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š</p> 
<blockquote> 
 <ul><li>æ–°å»ºä¸€ä¸ªç±»åŠ è½½å‡æœŸï¼Œç”¨äºåŠ è½½æ’ä»¶ï¼›</li><li>åå°„è·å–æ’ä»¶çš„ç±»åŠ è½½å™¨çš„çš„pathListä¸­çš„dexElementsï¼›</li><li>è·å–å½“å‰å®¿ä¸»appçš„ç±»åŠ è½½å™¨ï¼Œç„¶ååŒä¸Šä¸€æ­¥åå°„è·å–å…¶dexElementsï¼›</li><li>å°†å®¿ä¸»å’Œæ’ä»¶çš„dexElementsæ•°ç»„åˆå¹¶ï¼›</li><li>å°†åˆå¹¶åçš„dexElementsåå°„è®¾ç½®åˆ°å®¿ä¸»çš„ç±»åŠ è½½å™¨ï¼ˆDexPathListï¼‰ä¸­ã€‚<br> ä»£ç å¦‚ä¸‹ï¼š</li></ul> 
</blockquote> 
<pre><code class="prism language-java">  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//Element[] dexElements æ˜¯DexPathListçš„ä¸€ä¸ªå˜é‡ï¼›</span>
        <span class="token comment">//DexPathList pathList æ˜¯BaseDexClassesLoaderçš„ä¸€ä¸ªå˜é‡ï¼›</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>

            <span class="token comment">//åå°„è·å–BaseDexClassLoader</span>
            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> baseDexClassLoaderClazz <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"dalvik.system.BaseDexClassLoader"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//1.è·å–å…¬å…±çš„ DexPathList pathList Field</span>
            <span class="token class-name">Field</span> pathListField <span class="token operator">=</span> baseDexClassLoaderClazz<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"pathList"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            pathListField<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//2.è·å–å…¬å…±çš„ Elementp[] elements Field</span>
            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> dexPathListClazz <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"dalvik.system.DexPathList"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Field</span> dexElementField <span class="token operator">=</span> dexPathListClazz<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"dexElements"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            dexElementField<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//3.åˆ›å»ºæ–°æ’ä»¶çš„ç±»åŠ è½½å™¨,åå°„è·å–æ’ä»¶ ç±»åŠ è½½å™¨çš„elements</span>
            <span class="token class-name">DexClassLoader</span> dexClassLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DexClassLoader</span><span class="token punctuation">(</span>apkPath<span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">getCacheDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token keyword">null</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Object</span> pluginPathList <span class="token operator">=</span> pathListField<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>dexClassLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> pluginElements <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> dexElementField<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pluginPathList<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//4.è·å–å®¿ä¸»baseDexClassLoaderçš„elements</span>
            <span class="token class-name">PathClassLoader</span> hostClassLoader <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">PathClassLoader</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Object</span> hostPathList <span class="token operator">=</span> pathListField<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>hostClassLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hostDexElements <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> dexElementField<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>hostPathList<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//5.å°†æ’ä»¶çš„elementsåˆå¹¶åˆ°å®¿ä¸»elementsä¸­ï¼Œç„¶ååå°„é‡æ–°è®¾ç½®å®¿ä¸»dexElementsçš„å€¼</span>
            <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> compoundElements <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token class-name">Array</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>hostDexElements<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getComponentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    hostDexElements<span class="token punctuation">.</span>length <span class="token operator">+</span> pluginElements<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>hostDexElements<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> compoundElements<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> hostDexElements<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>pluginElements<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> compoundElements<span class="token punctuation">,</span> hostDexElements<span class="token punctuation">.</span>length<span class="token punctuation">,</span> pluginElements<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

            dexElementField<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>hostPathList<span class="token punctuation">,</span> compoundElements<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"loadClass: "</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>åœ¨Applicaionä¸­åŠ è½½ï¼Œåˆ«å¿˜äº†æŠŠè¿™ä¸ªApplicaitonå†™åˆ°æ¸…å•æ–‡ä»¶é‡Œ</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HostApplication</span> <span class="token keyword">extends</span> <span class="token class-name">Application</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LoadUtil</span><span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>ç„¶åå°±å¯ä»¥è°ƒç”¨ç›®æ ‡ç±»äº†ï¼š</p> 
<pre><code class="prism language-java">   <span class="token comment">/**
     * å°†æ’ä»¶çš„ç±»åˆå¹¶åˆ°å®¿ä¸»å†…åçš„åŠ è½½æ–¹å¼
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">launchCompoundClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> testClazz <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"com.margin.plugin.Test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Method</span> sayHiMethod <span class="token operator">=</span> testClazz<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"sayHi"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sayHiMethod<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMethodException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalAccessException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InvocationTargetException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>ç„¶åè¿è¡Œå°±å¯ä»¥çœ‹åˆ°ç»“æœäº†ï¼Œæˆ‘å°±ä¸å†è´´ç»“æœäº†ã€‚</p> 
<p>è‡³æ­¤ï¼Œæ’ä»¶åŒ–ç¬¬ä¸€æ­¥ï¼Œç±»åŠ è½½å°±å®Œæˆäº†ã€‚</p> 
<p><strong>æ‰€æœ‰ä»£ç è§ <a href="https://github.com/crykid/Magic-Plugin-in">github: Magic-plug-in</a></strong></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f5fe8e8b823de2e12e42a4bef8f498e6/" rel="prev">
			<span class="pager__subtitle">Â«&thinsp;Previous</span>
			<p class="pager__title">åœ¨windowsç¯å¢ƒä¸‹ï¼Œç”¨vscodeå¯¹c&#43;&#43;çš„è¿è¡Œå’Œè°ƒè¯•</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b1fd9cbb1ee00d526df474cce7d30ab0/" rel="next">
			<span class="pager__subtitle">Next&thinsp;Â»</span>
			<p class="pager__title">[Android Material Design]ç»„ä»¶17 - RecyclerView</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 ITå­¦ä¹ è€…åšå®¢.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>