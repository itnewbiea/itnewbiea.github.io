<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android插件化原理（一）—— 插件类加载、类加载原理、（双亲委托机制) - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android插件化原理（一）—— 插件类加载、类加载原理、（双亲委托机制)" />
<meta property="og:description" content="记录一下，这是2020年第一篇帖子，今年立了一个flag–经常写帖子。因为疫情的原因，只能每天在家养肚皮，躺床上为社会做贡献。实在是坐不住了，就开始写这篇文章吧。希望新的一年自己越来越厉害，也希望疫情早点过去
（一）什么是插件化 插件化技术最初源于免安装运行apk的想法，这个免安装的apk就可以理解为插件，而支持插件的app我们一般称之为宿主
（二）为什么要插件化 1.app功能模块越来越多，体积越来越大，维护变得困难；
2.模块之间的耦合度高，协同开发沟通成本越来越高；
3.方法数目可能超过65535，APP占用的内存越来越大；
4.增加功能只敢做加法。
（三）插件化和模块（模块）化的爱恨纠葛 组件化开发主要是通过gradle配置，将一个app分成多个模块，每个模块都是一个组件，开发的过程中我们可以让这些组件相互依赖或者单独调试部分组件等，但是最终发布的时候是将这些组件同意合并成一个apk，这就是组件化开发。插件化和组件化略有不同，插件化开发是将整个apk拆分成多个模块，这些模块包括一个宿主和多个插件，每个模块都是一个apk，最终打包的时候宿主apk和插件apk分开打包。插件化其实是建立在模块化基础上的，插件化在实施之前需要先进性模块化。 （四）核心-插件化原理（方案之一） 各大平台方案对比
[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传
不再一一介绍原理，本次主题是基于 360的DroidPlugin
接下来是插件化的核心：
如何加载插件的类？如何加载插件的资源？如何调用插件的类(四大组件)？ 一. 如何加载插件的类 1. 类加载器 毫无疑问，类是通过类加载器classLoader加载的，我们先看几种类加载器.
1.1 PathClassLoader和DexClassLoader区别 首先我们来看DexClassLoader:
DexClassLoader 用于加载.jar .apk .dex中的类，也可以用来加载不是应用程序中的代码
api-25-7.1 --&gt;
api-26-8.0 --&gt;
api-28-9.0 --&gt;
可以发现，DexClassLoader里什么也没有做，只是重写了BaseDexClassLoader的构造函数,注意api28里面的这段标红注释：该参数在api 26之后就废弃了，后面会讲到。
再看BaseDexClassLoader：
api-25-7.1 --&gt;
api-26-8.0 &amp; api-28-9.0 --&gt;
我们把焦点放在optimizedDirectory上:应该被写入的dex所在的目录。通过构造三个版本的函数可以看出：8.0之前使用了optimizedDirectory参数，8.0及8.0之后不再使用该参数。
我们再移步看一下PathClassLoader：PathClassLoader是系统类和系统应用的类加载器:
PathClassLoader8.0前后并没有什么区别，同样重写了四个参数的构造函数，optimizedDirectory为null。
总结：
8.0之前，DexClassLoader供系统（谷歌工程师）使用，PathClassLoader提供给开发者使用；8.0及之后并无区别。后来谷歌工程师越来越觉得写两个加载器简直是闲得蛋疼，干脆就不再区分了。 区别： 在8.0之后并无区别，
1.2 BootClassLoader 和PathClassLoader /** *注意这个类派生自AppCompatActivity，而非Activity */ public class MainActivity extends AppCompatActivity { private static final String TAG = &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/61da3e3f65983a3f25e2299d253e2ced/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-11-23T00:33:13+08:00" />
<meta property="article:modified_time" content="2022-11-23T00:33:13+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android插件化原理（一）—— 插件类加载、类加载原理、（双亲委托机制)</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>记录一下，这是2020年第一篇帖子，今年立了一个flag–经常写帖子。因为疫情的原因，只能每天在家养肚皮，躺床上为社会做贡献。实在是坐不住了，就开始写这篇文章吧。希望新的一年自己越来越厉害，也希望疫情早点过去</p> 
<hr> 
<h3><a id="_5"></a>（一）什么是插件化</h3> 
<p>插件化技术最初源于免安装运行apk的想法，这个免安装的apk就可以理解为<strong>插件</strong>，而支持插件的app我们一般称之为<strong>宿主</strong></p> 
<h3><a id="_8"></a>（二）为什么要插件化</h3> 
<p>1.app功能模块越来越多，体积越来越大，维护变得困难；<br> 2.模块之间的耦合度高，协同开发沟通成本越来越高；<br> 3.方法数目可能超过65535，APP占用的内存越来越大；<br> 4.增加功能只敢做加法。</p> 
<h3><a id="_14"></a>（三）插件化和模块（模块）化的爱恨纠葛</h3> 
<ul><li>组件化开发主要是<strong>通过gradle配置</strong>，将一个app分成多个模块，每个模块都是一个组件，开发的过程中我们可以让这些组件相互依赖或者单独调试部分组件等，但是最终发布的时候是将这些组件同意合并成一个apk，这就是组件化开发。</li><li>插件化和组件化略有不同，插件化开发是将整个apk拆分成多个模块，这些模块包括一个宿主和多个插件，每个模块都是一个apk，最终打包的时候宿主apk和插件apk分开打包。</li><li>插件化其实是建立在模块化基础上的，插件化在实施之前需要先进性模块化。</li></ul> 
<hr> 
<h3><a id="_21"></a>（四）核心-插件化原理（方案之一）</h3> 
<p>各大平台方案对比<br> [外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传<br> <img src="https://images2.imgbox.com/0d/89/0FqxT4r7_o.png" alt="各大平台插件化方案对比"><br> 不再一一介绍原理，本次主题是基于 <strong>360的DroidPlugin</strong></p> 
<p><strong>接下来是插件化的核心：</strong></p> 
<blockquote> 
 <ul><li>如何加载插件的类？</li><li>如何加载插件的资源？</li><li>如何调用插件的类(四大组件)？</li></ul> 
</blockquote> 
<h4><a id="__32"></a>一. 如何加载插件的类</h4> 
<h5><a id="1__33"></a>1. 类加载器</h5> 
<p>毫无疑问，类是通过类加载器classLoader加载的，我们先看几种类加载器.</p> 
<h6><a id="11_PathClassLoaderDexClassLoader_36"></a>1.1 <strong>PathClassLoader和DexClassLoader</strong>区别</h6> 
<p>首先我们来看<strong>DexClassLoader</strong>:</p> 
<blockquote> 
 <p><strong>DexClassLoader 用于加载.jar .apk .dex中的类，也可以用来加载不是应用程序中的代码</strong></p> 
</blockquote> 
<p><strong>api-25-7.1 --&gt;</strong><br> <img src="https://images2.imgbox.com/7e/0a/Qvh1jLTe_o.jpg" alt="DexClassLoader-api-25"></p> 
<p><strong>api-26-8.0 --&gt;</strong></p> 
<p><img src="https://images2.imgbox.com/f9/61/mjZYv2yh_o.jpg" alt="DexClassLoader-api-26"></p> 
<p><strong>api-28-9.0 --&gt;</strong></p> 
<p><img src="https://images2.imgbox.com/67/54/2nTcQLbz_o.jpg" alt="DexClassLoader-api-28"></p> 
<p>可以发现，DexClassLoader里什么也没有做，只是重写了BaseDexClassLoader的构造函数,注意api28里面的这段标红注释：该参数在api 26之后就废弃了，后面会讲到。</p> 
<p>再看<strong>BaseDexClassLoader</strong>：</p> 
<p><strong>api-25-7.1 --&gt;</strong><br> <img src="https://images2.imgbox.com/6c/fd/YxFEkkXC_o.jpg" alt="在这里插入图片描述"></p> 
<p><strong>api-26-8.0 &amp; api-28-9.0 --&gt;</strong><br> <img src="https://images2.imgbox.com/80/92/60OA1RGB_o.jpg" alt="BaseDexClassLoader-api26"></p> 
<p>我们把焦点放在<strong>optimizedDirectory</strong>上:应该被写入的dex所在的目录。通过构造三个版本的函数可以看出：<strong>8.0之前使用了optimizedDirectory参数，8.0及8.0之后不再使用该参数</strong>。</p> 
<p>我们再移步看一下<strong>PathClassLoader</strong>：PathClassLoader是系统类和系统应用的类加载器:<br> <img src="https://images2.imgbox.com/40/97/AW8V6aNt_o.jpg" alt="PathClassLoader"><br> PathClassLoader8.0前后并没有什么区别，同样重写了四个参数的构造函数，optimizedDirectory为null。</p> 
<p><strong>总结：</strong></p> 
<blockquote> 
 <ul><li>8.0之前，DexClassLoader供系统（谷歌工程师）使用，PathClassLoader提供给开发者使用；</li><li>8.0及之后并无区别。后来谷歌工程师越来越觉得写两个加载器简直是闲得蛋疼，干脆就不再区分了。</li></ul> 
</blockquote> 
<p><strong>区别：</strong> 在8.0之后并无区别，</p> 
<h6><a id="12_BootClassLoader_PathClassLoader_77"></a>1.2 BootClassLoader 和PathClassLoader</h6> 
<pre><code class="prism language-java"><span class="token comment">/**
*注意这个类派生自AppCompatActivity，而非Activity
*/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainActivity</span> <span class="token keyword">extends</span> <span class="token class-name">AppCompatActivity</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TAG</span> <span class="token operator">=</span> <span class="token string">"MainActivity"</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token class-name">Bundle</span> savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setContentView</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">findClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">findClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ClassLoader</span> classLoader <span class="token operator">=</span> <span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>classLoader <span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"findClassLoader: classLoader : "</span><span class="token operator">+</span>classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
            classLoader <span class="token operator">=</span> classLoader<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"findClassLoader: classLoader : "</span><span class="token operator">+</span> <span class="token class-name">Activity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>让我的小助理运行一下代码，小手那么一点，运行结果如下所示：</p> 
<p><img src="https://images2.imgbox.com/71/21/Whf6kVHz_o.png" alt="在这里插入图片描述"></p> 
<p>通过代码，我们可以得知：<br> MainActivity 的classLoader是 PathClassLoader；Activity 的classLoader是BootClassLoader； PathClassLoader的parent是BootClassLoader。</p> 
<p>其实他们两个的作用</p> 
<blockquote> 
 <ul><li>BootClassLoader – 加载FramWork的class文件；</li><li>PathClassLoader – 加载应用内的class文件，包含implementation到的第三方库以及.jar、.aar等。</li></ul> 
</blockquote> 
<hr> 
<h5><a id="2__114"></a>2. 类的生命周期</h5> 
<p><img src="https://images2.imgbox.com/cf/8a/YshhcI9I_o.png" alt="在这里插入图片描述"></p> 
<p>这里我们重点了解一下<strong>类加载</strong>阶段主要做的事情：</p> 
<blockquote> 
 <ul><li>通过一个类的全限定名来获取定义此类的二进制字节流；</li><li>将这个字节流所代表的静态存储结构转化为方法区域的运行时数据结构。</li><li>在java堆中生成一个代表这个类的Class对象，作为方法区域数据的访问入口。</li></ul> 
</blockquote> 
<p>其它阶段不是我们本章的重点，这里不再赘述，可参考<a href="https://www.cnblogs.com/ipetergo/p/6441310.html" rel="nofollow">Java类的生命周期</a>。</p> 
<hr> 
<h5><a id="3__127"></a>3 加载一个类</h5> 
<blockquote> 
 <p>注：演示代码是基于Android API 9.0的<br> 注：演示代码是基于Android API 9.0的<br> 注：演示代码是基于Android API 9.0的</p> 
</blockquote> 
<p>重要的话说三遍</p> 
<h6><a id="31__136"></a>3.1 <strong>「双亲委托」</strong></h6> 
<p>首先通过代码演示如何加载一个类来请出一个传说中的大“人物”——<strong>双亲委托机制</strong>：</p> 
<pre><code class="prism language-java">       <span class="token class-name">String</span> dexPath <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
       <span class="token class-name">DexClassLoader</span> dexClassLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DexClassLoader</span><span class="token punctuation">(</span>dexPath<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCacheDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz <span class="token operator">=</span> dexClassLoader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">"com.margin.plugin.ProxyActivity"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>这样，一个类（插件中的类）就被加载成功了。那么，类究竟是如何加载的呢，请小助理位于ClassLoader中的loadClass把源码拿过来：</p> 
<ul><li><strong>loadClass-1 :</strong><br> <img src="https://images2.imgbox.com/27/3c/tYTVkj9b_o.jpg" alt="在这里插入图片描述"></li></ul> 
<p>首先通过findLoadedClass检查是否已经加载过了；如果没有加载过，检查是否存在parent（注意这个parent父母即双亲，并不是指父类，而是上一级），如果双亲存在则调用parent的loadClass（）方法,依次递归；</p> 
<p>清楚此流程了，那么一个几乎所有小孩子都问过的问题来了——我是从哪里来的？不不不，是<strong>parent从哪里来的</strong>😳😳😳？？？</p> 
<pre><code class="prism language-java"> <span class="token class-name">DexClassLoader</span> dexClassLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DexClassLoader</span><span class="token punctuation">(</span>dexPath<span class="token punctuation">,</span>     <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCacheDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>我们在new DexClassLoader的时候传递的第四个参数就是parent，通过1.2和1.3得知，这个getClassLoader得到的是PathClassLoader，所以这里的classLoader层级关系为：</p> 
<p><img src="https://images2.imgbox.com/7c/f0/7ZXVPQ3G_o.png" alt="类加载器parent层级关系"></p> 
<p>这样，一层一层向上查找的过程，最终到了BootClassLoader的loadClass方法中，我们小助理再来上一下代码:</p> 
<ul><li><strong>loadClass-2 :</strong> <img src="https://images2.imgbox.com/dd/50/z2b8yHFh_o.jpg" alt="bcl-loadClass"></li></ul> 
<blockquote> 
 <p>注：BootClassLoader 是ClassLoader的一个内部类。</p> 
</blockquote> 
<p>在这个方法中，仍然是先通过findLoadedClass判断是否已经加载过，如果没有，就不再找parent，而是直接调用findClass方法并返回class</p> 
<p><img src="https://images2.imgbox.com/32/65/fMpbpke2_o.jpg" alt="在这里插入图片描述"></p> 
<p>双亲将加载到的class依次向下返回，第一层级的parent检查是否为null，如果为null则调用自己的findClass方法，将结果再次向下返回直至最初的DexClassLoader中的loadClass方法中（代码 loadClass-1），此时，如果双亲找到的class仍然为null，那么，就调用自己的findClass方法查找class</p> 
<p><strong>双亲委托机制的流程图</strong></p> 
<p><img src="https://images2.imgbox.com/df/7b/JuF8pvnH_o.png" alt="双亲委托机制"></p> 
<p><strong>总结『双亲委托机制』</strong></p> 
<blockquote> 
 <ul><li>1.首先通过findLoadedClass检查是否已经加载过了；</li><li>2.如果没有加载过，检查是否存在parent（注意这个parent父母即双亲，并不是指父类，而是上一级），如果双亲存在则调用parent的loadClass（）方法,依次递归调用，当到达顶部的时候不再检查双亲而是调用findClass方法并低层返回结果；</li><li>3.如果最终都没有查找到或加载成功则调用自身的findClass并返回结果。</li></ul> 
</blockquote> 
<p>为什么使用双亲委托机制？</p> 
<blockquote> 
 <ul><li>1.避免重复加载，当双亲加载器已经加载了该类的时候，就没有必要子ClassLoader再次加载；</li><li>2.安全性考虑，防止核心API库被随意篡改。</li></ul> 
</blockquote> 
<p>至此，双亲委托机制介绍完毕。</p> 
<h6><a id="32__190"></a>3.2 加载类</h6> 
<h6><a id="321_findLoadedClass_191"></a>3.2.1 查找已加载的类findLoadedClass</h6> 
<p><img src="https://images2.imgbox.com/24/4f/15hgt7wz_o.png" alt="cl-findLoadedClass2"><br> <img src="https://images2.imgbox.com/1d/da/wBlKFcPD_o.png" alt="vm-findLoadedClass"></p> 
<p>最终到达Native层，然后先这样再这样在那样，就完成了，哈哈哈哈哈哈</p> 
<h6><a id="322_findClass_197"></a>3.2.2 查找类findClass</h6> 
<p>查看BootClassLoader的findClass方法：<br> <img src="https://images2.imgbox.com/ca/15/DDcdTEdg_o.png" alt="bcl-findClass-2"><br> 此处只是重写了ClassLoader的findClass方法，调用了Class的native方法。</p> 
<p>我们在看DexClassLoader和PathClassLoader，他们的findClass由其父类BaseDexClassLoader重写：</p> 
<ul><li> <p>代码块1<br> <img src="https://images2.imgbox.com/4f/e4/80lrly2c_o.png" alt="bdcl-findClass"><br> 这里没有什么特别的，核心是通过pathList.findClass()查找class，pathList是DexPathList的实例，我们接着看这个方法：</p> </li><li> <p>代码块2<br> <img src="https://images2.imgbox.com/ee/99/mk6usjXy_o.jpg" alt="DexPathList-findClass"></p> </li></ul> 
<p>这个方法迭代dexElements，通过Element查找目标class，Element是DexPathList的一个内部类，咱们再看看其方法:</p> 
<ul><li>代码块3<br> <img src="https://images2.imgbox.com/b2/0c/XsYx4w9e_o.png" alt="Element-findClass"></li></ul> 
<p>如果dexFile不为空，则调用dexFile.loadClassBinaryName返回class。dexFile是Element的一个变量，由构造器传入。那么我们就得看看Element从何而来，从上面可知，Element由dexElements而来，那么我们就得看dexElements是怎么来的。</p> 
<p>DexPathList的过个构造函数中都有dexElements的创建：<br> <img src="https://images2.imgbox.com/6d/5f/EbC0iIp1_o.png" alt="DexPathList-constructor-dexElements"></p> 
<p>关键是这一行：</p> 
<pre><code class="prism language-java">    <span class="token keyword">this</span><span class="token punctuation">.</span>dexElements <span class="token operator">=</span> <span class="token function">makeDexElements</span><span class="token punctuation">(</span><span class="token function">splitDexPath</span><span class="token punctuation">(</span>dexPath<span class="token punctuation">)</span><span class="token punctuation">,</span>optimizedDirectory<span class="token punctuation">,</span>suppressedExceptions<span class="token punctuation">,</span> definingContext<span class="token punctuation">,</span> isTrusted<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>可见dexElements由该方法创建的，我们接着查看该方法，在看一下，不妨先看一下第一个参数的方法splitDexPath方法：<br> <img src="https://images2.imgbox.com/44/0c/NZbaSqDJ_o.png" alt="DexPathList-splitDexPath"></p> 
<p>splitDexPath（）方法主要作用：通过分隔符把给定的path分成一个个File，并将结果以List的形式返回，它去除不可读，不可用的、常规的文件等等。 知道了splitDexPath（）的作用，我们再返回查看makeDexElements（）方法：</p> 
<pre><code class="prism language-java">       <span class="token comment">/**
     * Makes an array of dex/resource path elements, one per element of
     * the given array.
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Element</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">makeDexElements</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">File</span><span class="token punctuation">&gt;</span></span> files<span class="token punctuation">,</span> <span class="token class-name">File</span> optimizedDirectory<span class="token punctuation">,</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IOException</span><span class="token punctuation">&gt;</span></span> suppressedExceptions<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> loader<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">makeDexElements</span><span class="token punctuation">(</span>files<span class="token punctuation">,</span> optimizedDirectory<span class="token punctuation">,</span> suppressedExceptions<span class="token punctuation">,</span> loader<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Element</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">makeDexElements</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">File</span><span class="token punctuation">&gt;</span></span> files<span class="token punctuation">,</span> <span class="token class-name">File</span> optimizedDirectory<span class="token punctuation">,</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IOException</span><span class="token punctuation">&gt;</span></span> suppressedExceptions<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> loader<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isTrusted<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token class-name">Element</span><span class="token punctuation">[</span><span class="token punctuation">]</span> elements <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Element</span><span class="token punctuation">[</span>files<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">int</span> elementsPos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token comment">/*
       * Open all files and load the (direct or contained) dex files up front.
       */</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">File</span> file <span class="token operator">:</span> files<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token comment">// We support directories for looking up resources. Looking up resources in</span>
              <span class="token comment">// directories is useful for running libcore tests.</span>
              elements<span class="token punctuation">[</span>elementsPos<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Element</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">isFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token class-name">String</span> name <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

              <span class="token class-name">DexFile</span> dex <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token constant">DEX_SUFFIX</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                  <span class="token comment">// Raw dex file (not inside a zip/jar).</span>
                  <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                      dex <span class="token operator">=</span> <span class="token function">loadDexFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> optimizedDirectory<span class="token punctuation">,</span> loader<span class="token punctuation">,</span> elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token keyword">if</span> <span class="token punctuation">(</span>dex <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                          elements<span class="token punctuation">[</span>elementsPos<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Element</span><span class="token punctuation">(</span>dex<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token punctuation">}</span>
                  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> suppressed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                      <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">logE</span><span class="token punctuation">(</span><span class="token string">"Unable to load dex file: "</span> <span class="token operator">+</span> file<span class="token punctuation">,</span> suppressed<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      suppressedExceptions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>suppressed<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>
              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                  <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                      dex <span class="token operator">=</span> <span class="token function">loadDexFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> optimizedDirectory<span class="token punctuation">,</span> loader<span class="token punctuation">,</span> elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> suppressed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                      <span class="token comment">/*
                       * IOException might get thrown "legitimately" by the DexFile constructor if
                       * the zip file turns out to be resource-only (that is, no classes.dex file
                       * in it).
                       * Let dex == null and hang on to the exception to add to the tea-leaves for
                       * when findClass returns null.
                       */</span>
                      suppressedExceptions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>suppressed<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>

                  <span class="token keyword">if</span> <span class="token punctuation">(</span>dex <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                      elements<span class="token punctuation">[</span>elementsPos<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Element</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                      elements<span class="token punctuation">[</span>elementsPos<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Element</span><span class="token punctuation">(</span>dex<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>
              <span class="token punctuation">}</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>dex <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> isTrusted<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                dex<span class="token punctuation">.</span><span class="token function">setTrusted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
              <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">logW</span><span class="token punctuation">(</span><span class="token string">"ClassLoader referenced unknown path: "</span> <span class="token operator">+</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>elementsPos <span class="token operator">!=</span> elements<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          elements <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span>elements<span class="token punctuation">,</span> elementsPos<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> elements<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre> 
<p>这个方法里面就是迭代splitDexPath所返回的List，通过file查找到dexFile，然后创建一个Element的实例并将dexFile放入，也就是说，一个dex对应一个Element，再将Element放入elements数组中，最后返回elements，这个elements就对应了一个apk中的所有文件。</p> 
<p><img src="https://images2.imgbox.com/c5/7f/Z1Zl3Adv_o.png" alt="class.dex"></p> 
<p>如果classLoader是PathClassLoader，elements就是应用内的所有类，如果classLoader是DexClassLoader，则需要看创建实例时传递的第一个参数path路径下的。</p> 
<h5><a id="4__312"></a>4. 加载插件中的类</h5> 
<p>1.创建一个插件：</p> 
<ul><li>step1：在项目中新建一个module:plugin,随便新建一个类：</li></ul> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TAG</span> <span class="token operator">=</span> <span class="token string">"Test"</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">sayHi</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"sayHi: Hello , this is Plug-in"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>step2：将Test.class打包成dex文件：<br> 终端定位到：module下javac中的build/intermediates/javac/debug/classes<br> 然后执行命令： dx --dex --output=test.dex com/margin/plugin/Test.class<br> 执行完之后可以看到classes目录下多了一个test.dex文件。<br> -step3：将dex文件放到sd卡中：</li></ul> 
<p><img src="https://images2.imgbox.com/8a/24/T0EVm5rN_o.jpg" alt="class.dex"><br> -step4:在宿主app中编写代码并运行，别忘了在清单文件中添加文件读写权限，代码中不要忘了写运行时权限检查：</p> 
<pre><code class="prism language-java"> <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">luanchClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> <span class="token class-name">String</span> dexPath <span class="token operator">=</span> <span class="token string">"/sdcard/test.dex"</span><span class="token punctuation">;</span>
        <span class="token class-name">PathClassLoader</span> dexClassLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PathClassLoader</span><span class="token punctuation">(</span>dexPath<span class="token punctuation">,</span> <span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//类的路径</span>
            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> testClazz <span class="token operator">=</span> dexClassLoader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">"com.margin.plugin.Test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//加载到类之后，反射调用其方法</span>
            <span class="token class-name">Method</span> sayHiMethod <span class="token operator">=</span> testClazz<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"sayHi"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sayHiMethod<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMethodException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalAccessException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InvocationTargetException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
</code></pre> 
<p>加载到类之后，反射调用方法，（别忘了添加文件访问权限），结果如下：<br> <img src="https://images2.imgbox.com/c2/b1/fCXLUBxt_o.jpg" alt="在这里插入图片描述"></p> 
<p>看到日志的那一瞬间，泪目了，终于类加载成功了，辛辛苦苦养了多年的猪，终于会拱白菜了😀😀😀。<br> 可是，这就完了嘛？当然不是，如果是这么简单，我们就不会在前面长篇大论讲类加载远离了，而且这种方式每次调用都要使用类加载器加载及其不方便，怎么办呢，请看下文。</p> 
<h5><a id="5_363"></a>5.将插件与宿主的类合并</h5> 
<p>上面第4步，是使用时加载的方式，这种方式很不方便，所以我们换一种方式，加载合并插件，顾名思义，就是在app启动（当然时机是自定的）时将插件全部加载并合并到宿主中。</p> 
<p>这种方式的核心思想就是，<strong>将插件的类合并到宿主</strong>中，具体步骤如下：</p> 
<blockquote> 
 <ul><li>新建一个类加载假期，用于加载插件；</li><li>反射获取插件的类加载器的的pathList中的dexElements；</li><li>获取当前宿主app的类加载器，然后同上一步反射获取其dexElements；</li><li>将宿主和插件的dexElements数组合并；</li><li>将合并后的dexElements反射设置到宿主的类加载器（DexPathList）中。<br> 代码如下：</li></ul> 
</blockquote> 
<pre><code class="prism language-java">  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//Element[] dexElements 是DexPathList的一个变量；</span>
        <span class="token comment">//DexPathList pathList 是BaseDexClassesLoader的一个变量；</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>

            <span class="token comment">//反射获取BaseDexClassLoader</span>
            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> baseDexClassLoaderClazz <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"dalvik.system.BaseDexClassLoader"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//1.获取公共的 DexPathList pathList Field</span>
            <span class="token class-name">Field</span> pathListField <span class="token operator">=</span> baseDexClassLoaderClazz<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"pathList"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            pathListField<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//2.获取公共的 Elementp[] elements Field</span>
            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> dexPathListClazz <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"dalvik.system.DexPathList"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Field</span> dexElementField <span class="token operator">=</span> dexPathListClazz<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"dexElements"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            dexElementField<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//3.创建新插件的类加载器,反射获取插件 类加载器的elements</span>
            <span class="token class-name">DexClassLoader</span> dexClassLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DexClassLoader</span><span class="token punctuation">(</span>apkPath<span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">getCacheDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token keyword">null</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Object</span> pluginPathList <span class="token operator">=</span> pathListField<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>dexClassLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> pluginElements <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> dexElementField<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pluginPathList<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//4.获取宿主baseDexClassLoader的elements</span>
            <span class="token class-name">PathClassLoader</span> hostClassLoader <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">PathClassLoader</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Object</span> hostPathList <span class="token operator">=</span> pathListField<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>hostClassLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hostDexElements <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> dexElementField<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>hostPathList<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//5.将插件的elements合并到宿主elements中，然后反射重新设置宿主dexElements的值</span>
            <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> compoundElements <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token class-name">Array</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>hostDexElements<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getComponentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    hostDexElements<span class="token punctuation">.</span>length <span class="token operator">+</span> pluginElements<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>hostDexElements<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> compoundElements<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> hostDexElements<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>pluginElements<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> compoundElements<span class="token punctuation">,</span> hostDexElements<span class="token punctuation">.</span>length<span class="token punctuation">,</span> pluginElements<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

            dexElementField<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>hostPathList<span class="token punctuation">,</span> compoundElements<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"loadClass: "</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>在Applicaion中加载，别忘了把这个Applicaiton写到清单文件里</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HostApplication</span> <span class="token keyword">extends</span> <span class="token class-name">Application</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LoadUtil</span><span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>然后就可以调用目标类了：</p> 
<pre><code class="prism language-java">   <span class="token comment">/**
     * 将插件的类合并到宿主内后的加载方式
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">launchCompoundClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> testClazz <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"com.margin.plugin.Test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Method</span> sayHiMethod <span class="token operator">=</span> testClazz<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"sayHi"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sayHiMethod<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMethodException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalAccessException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InvocationTargetException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>然后运行就可以看到结果了，我就不再贴结果了。</p> 
<p>至此，插件化第一步，类加载就完成了。</p> 
<p><strong>所有代码见 <a href="https://github.com/crykid/Magic-Plugin-in">github: Magic-plug-in</a></strong></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f5fe8e8b823de2e12e42a4bef8f498e6/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">在windows环境下，用vscode对c&#43;&#43;的运行和调试</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b1fd9cbb1ee00d526df474cce7d30ab0/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">[Android Material Design]组件17 - RecyclerView</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>