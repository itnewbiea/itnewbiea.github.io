<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>即席查询调研报告 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="即席查询调研报告" />
<meta property="og:description" content="即席查询调研报告 什么是即席查询 即席查询（Ad Hoc）是用户根据自己的需求，灵活的选择查询条件，系统能够根据用户的选择生成相应的统计报表。即席查询与普通应用查询最大的不同是普通的应用查询是定制开发的，而即席查询是指那些用户在使用系统时，根据自己当时的需求自定义的查询。
测试组件介绍 Apache Doris 是一个现代化的MPP分析型数据库产品。仅需亚秒级响应时间即可获得查询结果，有效地支持实时数据分析。支持数据实时导入和实时查询，并且可以支持10PB以上的超大数据集。提供 OLAP 数据分析。（同时支持聚合和明细查询分析）
starRocks fork于 Apache Doris，在此基础上做了一些增强
特性
1、联邦查询
StarRocks支持使用外表的方式进行联邦查询，当前可以支持Hive，MySQL，Elasticserach三种类型的外表，用户无需通过数据导入，可以直接进行数据查询加速。
2、全面向量化引擎
CPU需要支持AVX2指令集， cat /proc/cpuinfo |grep avx2有结果输出表明CPU支持，如果没有支持，建议更换机器，StarRocks使用向量化技术需要一定的指令集支持才能发挥效果。
3、智能查询优化
StarRocks通过CBO优化器(Cost Based Optimizer)可以对复杂查询自动优化。无需人工干预，就可以通过统计信息合理估算执行成本，生成更优的执行计划，大大提高了Adhoc和ETL场景的数据分析效率。
4、智能物化视图
StarRocks支持智能的物化视图。用户可以通过创建物化视图，预先计算生成预聚合表用于加速聚合类查询请求。
StarRocks的物化视图能够在数据导入时自动完成汇聚，与原始表数据保持一致。并且在查询的时候，用户无需指定物化视图，StarRocks能够自动选择最优的物化视图来满足查询请求。
5、标准SQL
StarRocks支持标准的SQL语法，包括聚合，JOIN，排序，窗口函数，自定义函数等功能。StarRocks可以完整支持TPC-H的22个SQL和TPC-DS的99个SQL。此外，StarRocks还兼容MySQL协议语法，可使用现有 的各种客户端工具、BI软件访问StarRocks，
对StarRocks中的数据进行拖拽式分析。
6、流批一体
StarRocks支持实时和批量两种数据导入方式，支持的数据源有Kafka， HDFS， 本地文件，支持的数据格式有ORC， Parquet和CSV等，StarRocks可以实时消费Kafka数据来完成数据导入，保证数据不丢不重（exactly once）。StarRocks也可以从本地或者远程（HDFS）批量导入数据。
Presto Presto是一个分布式SQL查询引擎， 它被设计为用来专门进行高速、实时的数据分析。它支持标准的ANSI SQL，包括复杂查询、聚合（aggregation）、连接（join）和窗口函数（window functions)，动态编译/利用cpu的指令集并行化执行。它的产生是为了解决hive的MR太慢的问题，Presto 本身并不存储数据，但是可以接入多种数据源，并且支持跨数据源的级联查询。Presto是一个OLAP的工具，擅长对海量数据进行复杂的分析。
ClickHouse Clickhouse由俄罗斯yandex公司开发。是一款用于大数据实时分析的列式数据库管理系统。通过向量化的执行以及对cpu底层指令集的使用，可以对海量数据进行并行处理，从而加快数据的处理速度。
除此之外，adhoc还有Impala，但经社区反馈其多表查询性能和presto差不多，但是单表查询方面却不如presto好。而且Impala有很多不支持的地方，例如：不支持Date数据类型，不支持ORC文件格式等等，需要采用parquet格式进行查询，而且Impala在查询时占用的内存很大。因此直接pass掉
测试方法 TPC-H基准压测
TPC-H 基准测试是由TPC-D发展而来的，是面向商品零售业的决策支持系统测试基准，它定义了8张表，22个查询，遵循SQL92；基准的数据库模式遵循第三范式；新兴的数据仓库开始采用新的模型，如星型模型、雪花模型。
表的信息：2个事实表：lineorder，orders 6个维度表：customer，part，parsupp，supplier，region，nation
数据查询：22条标准SQL查询测试语句：统计查询、多表关联、sum、复杂条件、group by、order by等组合方式
TPC-H基准sql
SSB基准压测
SSB（Star Schema Benchmark）是在TPC-H基础之上，麻省州立大学波士顿校区的研究人员定义的基于现实商业应用的数据模型，是学术界和工业界广泛使用的一个星型模型测试集（来源论文），比较公正和中立。
表的信息：1张大宽表：lineorder_flat；1张事实表：lineorder4张维度表：customer，part，dates，supplier
数据查询：2类查询场景（单表和多表join）每类场景下有13条标准SQL查询测试语句：统计查询、多表关联、sum、复杂条件、group by、order by等组合方式
本次主要通过ssb基准进行测试，通过这个测试集合可以方便的对比各种OLAP产品的基础性能指标。Clickhouse 通过改写SSB，将星型模型打平转化成宽表，改造成了一个单表测试benchmark。本报告记进行了StarRocks、ApacheDoris和Clickhouse在SSB单表测试，以及StarRocks和ApacheDoris的多表测试，由于Clickhouse对多表Join支持有限，这也不是clickhouse的强项，所以在多表测试中并未将Clickhouse加入测试。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/2a83ca0f6830ff98da889cbab3cd181e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-06T14:43:18+08:00" />
<meta property="article:modified_time" content="2023-05-06T14:43:18+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">即席查询调研报告</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>即席查询调研报告</h2> 
<h3><a id="_2"></a>什么是即席查询</h3> 
<blockquote> 
 <p>即席查询（Ad Hoc）是用户根据自己的需求，灵活的选择查询条件，系统能够根据用户的选择生成相应的统计报表。即席查询与普通应用查询最大的不同是普通的应用查询是定制开发的，而即席查询是指那些用户在使用系统时，根据自己当时的需求自定义的查询。</p> 
</blockquote> 
<h3><a id="_6"></a>测试组件介绍</h3> 
<h4><a id="Apache_Doris_8"></a>Apache Doris</h4> 
<blockquote> 
 <p>是一个现代化的MPP分析型数据库产品。仅需亚秒级响应时间即可获得查询结果，有效地支持实时数据分析。支持数据实时导入和实时查询，并且可以支持10PB以上的超大数据集。提供 OLAP 数据分析。（同时支持聚合和明细查询分析）</p> 
</blockquote> 
<h4><a id="starRocks_12"></a>starRocks</h4> 
<blockquote> 
 <p>fork于 Apache Doris，在此基础上做了一些增强</p> 
 <p>特性<br> 1、联邦查询<br> StarRocks支持使用外表的方式进行联邦查询，当前可以支持Hive，MySQL，Elasticserach三种类型的外表，用户无需通过数据导入，可以直接进行数据查询加速。<br> 2、全面向量化引擎<br> CPU需要支持AVX2指令集， cat /proc/cpuinfo |grep avx2有结果输出表明CPU支持，如果没有支持，建议更换机器，StarRocks使用向量化技术需要一定的指令集支持才能发挥效果。<br> 3、智能查询优化<br> StarRocks通过CBO优化器(Cost Based Optimizer)可以对复杂查询自动优化。无需人工干预，就可以通过统计信息合理估算执行成本，生成更优的执行计划，大大提高了Adhoc和ETL场景的数据分析效率。<br> 4、智能物化视图<br> StarRocks支持智能的物化视图。用户可以通过创建物化视图，预先计算生成预聚合表用于加速聚合类查询请求。<br> StarRocks的物化视图能够在数据导入时自动完成汇聚，与原始表数据保持一致。并且在查询的时候，用户无需指定物化视图，StarRocks能够自动选择最优的物化视图来满足查询请求。<br> 5、标准SQL<br> StarRocks支持标准的SQL语法，包括聚合，JOIN，排序，窗口函数，自定义函数等功能。StarRocks可以完整支持TPC-H的22个SQL和TPC-DS的99个SQL。此外，StarRocks还兼容MySQL协议语法，可使用现有 的各种客户端工具、BI软件访问StarRocks，<br> 对StarRocks中的数据进行拖拽式分析。<br> 6、流批一体<br> StarRocks支持实时和批量两种数据导入方式，支持的数据源有Kafka， HDFS， 本地文件，支持的数据格式有ORC， Parquet和CSV等，StarRocks可以实时消费Kafka数据来完成数据导入，保证数据不丢不重（exactly once）。StarRocks也可以从本地或者远程（HDFS）批量导入数据。</p> 
</blockquote> 
<h4><a id="Presto_32"></a>Presto</h4> 
<blockquote> 
 <p><a href="https://tech.meituan.com/2014/06/16/presto.html" rel="nofollow">Presto</a>是一个分布式SQL查询引擎， 它被设计为用来专门进行高速、实时的数据分析。它支持标准的ANSI SQL，包括复杂查询、聚合（aggregation）、连接（join）和窗口函数（window functions)，动态编译/利用cpu的指令集并行化执行。它的产生是为了解决hive的MR太慢的问题，Presto 本身并不存储数据，但是可以接入多种数据源，并且支持跨数据源的级联查询。Presto是一个OLAP的工具，擅长对海量数据进行复杂的分析。</p> 
</blockquote> 
<h4><a id="ClickHouse_36"></a>ClickHouse</h4> 
<blockquote> 
 <p>Clickhouse由俄罗斯yandex公司开发。是一款用于大数据实时分析的列式数据库管理系统。通过向量化的执行以及对cpu底层指令集的使用，可以对海量数据进行并行处理，从而加快数据的处理速度。</p> 
</blockquote> 
<p>除此之外，adhoc还有Impala，但经社区反馈其多表查询性能和presto差不多，但是单表查询方面却不如presto好。而且Impala有很多不支持的地方，例如：不支持Date数据类型，不支持ORC文件格式等等，需要采用parquet格式进行查询，而且Impala在查询时占用的内存很大。因此直接pass掉</p> 
<h3><a id="_44"></a>测试方法</h3> 
<p><strong>TPC-H基准压测</strong><br> TPC-H 基准测试是由TPC-D发展而来的，是面向商品零售业的决策支持系统测试基准，它定义了8张表，22个查询，遵循SQL92；基准的数据库模式遵循第三范式；新兴的数据仓库开始采用新的模型，如星型模型、雪花模型。</p> 
<p>表的信息：2个事实表：lineorder，orders 6个维度表：customer，part，parsupp，supplier，region，nation<br> 数据查询：22条标准SQL查询测试语句：统计查询、多表关联、sum、复杂条件、group by、order by等组合方式</p> 
<p><a href="https://github.com/valuko/presto-tpch-tpcds/tree/master/sql/presto/tpch">TPC-H基准sql</a></p> 
<p><strong>SSB基准压测</strong><br> SSB（Star Schema Benchmark）是在TPC-H基础之上，麻省州立大学波士顿校区的研究人员定义的基于现实商业应用的数据模型，是学术界和工业界广泛使用的一个星型模型测试集（来源<a href="https://www.cs.umb.edu/~poneil/StarSchemaB.PDF" rel="nofollow">论文</a>），比较公正和中立。</p> 
<p>表的信息：1张大宽表：lineorder_flat；1张事实表：lineorder4张维度表：customer，part，dates，supplier<br> 数据查询：2类查询场景（单表和多表join）每类场景下有13条标准SQL查询测试语句：统计查询、多表关联、sum、复杂条件、group by、order by等组合方式</p> 
<p>本次主要通过ssb基准进行测试，通过这个测试集合可以方便的对比各种OLAP产品的基础性能指标。Clickhouse 通过改写SSB，将星型模型打平转化成宽表，改造成了一个单表测试benchmark。本报告记进行了StarRocks、ApacheDoris和Clickhouse在SSB单表测试，以及StarRocks和ApacheDoris的多表测试，由于Clickhouse对多表Join支持有限，这也不是clickhouse的强项，所以在多表测试中并未将Clickhouse加入测试。</p> 
<h3><a id="_62"></a>测试环境</h3> 
<h4><a id="_64"></a>硬件环境</h4> 
<table><thead><tr><th>机器</th><th>1台腾讯云主机</th></tr></thead><tbody><tr><td>CPU</td><td>16核（超线程）</td></tr><tr><td>内存</td><td>64G</td></tr></tbody></table> 
<h4><a id="_71"></a>软件环境</h4> 
<p>容器化环境部署，StarRocks，Apache Doris和Clickhouse容器分别部署在相同的机器上进行测试，都为standalone模式。</p> 
<p><a href="https://hub.docker.com/repository/docker/ponylee/starrocks" rel="nofollow">StarRocks</a>和<a href="https://hub.docker.com/repository/docker/ponylee/doris" rel="nofollow">Apache Doris</a>的基础镜像为centos：7.9，<a href="https://hub.docker.com/r/clickhouse/clickhouse-server/" rel="nofollow">Clickhouse</a>基础镜像为Ubuntu 20，考虑到容器本身对资源的消耗很小，可以忽略不计。</p> 
<p>软件版本：StarRocks community 1.18.2 ，Aapche Doris 0.14.0，Clickhouse 21.8.6.15</p> 
<h3><a id="_79"></a>测试数据</h3> 
<h4><a id="_81"></a>测试数据生成</h4> 
<h5><a id="StarRocksApache_Doris_83"></a>StarRocks和Apache Doris测试数据生成</h5> 
<p>编译 :</p> 
<blockquote> 
 <p>wget https://starrocks-public.oss-cn-beijing.aliyuncs.com/ssb-poc-0.9.2.zip<br> unzip ssb-poc-0.9.2.zip<br> cd ssb-poc<br> make &amp;&amp; make install</p> 
</blockquote> 
<p>生成数据：</p> 
<blockquote> 
 <p>cd output</p> 
 <p>bin/gen-ssb.sh 10 data_dir</p> 
</blockquote> 
<p><strong>注意：</strong> 如果使用因子100，生成6亿条记录的初始文件，约59G;使用因子1000，生成60亿条记录的初始文件，约600G;本次使用因子10，生成6千万条记录的初始文件，约6G。</p> 
<p>创建表结构:</p> 
<p>修改配置文件conf/starrocks.conf，指定脚本操作的集群地址</p> 
<pre><code class="prism language-shell"> <span class="token comment"># for mysql cmd</span>
 mysql_host: <span class="token number">192.168</span>.1.1 <span class="token comment">#fe地址</span>
 mysql_port: <span class="token number">9030</span>
 mysql_user: root
 mysql_password:
 database: ssb
 
<span class="token comment"># cluster ports</span>
  http_port: <span class="token number">8030</span>
  be_heartbeat_port: <span class="token number">9050</span>
  broker_port: <span class="token number">8000</span>

<span class="token comment"># parallel_fragment_exec_instance_num</span>
parallel_num: <span class="token number">1</span>

 <span class="token punctuation">..</span>.
</code></pre> 
<p>使用Stream load导入单表数据</p> 
<blockquote> 
 <p>bin/stream_load.sh data_dir</p> 
</blockquote> 
<p>插入数据到宽表lineorder_flat</p> 
<blockquote> 
 <p>bin/flat_insert.sh</p> 
</blockquote> 
<p>或者创建分区宽表lineorder_flat</p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>lineorder_flat<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>lo_orderdate<span class="token punctuation">`</span></span> <span class="token keyword">date</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>lo_orderkey<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>lo_linenumber<span class="token punctuation">`</span></span> <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>lo_custkey<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>lo_partkey<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>lo_suppkey<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>lo_orderpriority<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>lo_shippriority<span class="token punctuation">`</span></span> <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>lo_quantity<span class="token punctuation">`</span></span> <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>lo_extendedprice<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>lo_ordtotalprice<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>lo_discount<span class="token punctuation">`</span></span> <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>lo_revenue<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>lo_supplycost<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>lo_tax<span class="token punctuation">`</span></span> <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>lo_commitdate<span class="token punctuation">`</span></span> <span class="token keyword">date</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>lo_shipmode<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>c_name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>c_address<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>c_city<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>c_nation<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>c_region<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>c_phone<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>c_mktsegment<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>s_region<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>s_nation<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>s_city<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>s_name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>s_address<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>s_phone<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>p_name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>p_mfgr<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>p_category<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>p_brand<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>p_color<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>p_type<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>p_size<span class="token punctuation">`</span></span> <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>p_container<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">""</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span>OLAP
<span class="token keyword">DUPLICATE</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>lo_orderdate<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>lo_orderkey<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token keyword">COMMENT</span> <span class="token string">"OLAP"</span>
<span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> RANGE<span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>lo_orderdate<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token keyword">PARTITION</span> p1 <span class="token keyword">VALUES</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'0000-01-01'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'1993-01-01'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token keyword">PARTITION</span> p2 <span class="token keyword">VALUES</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'1993-01-01'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'1994-01-01'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token keyword">PARTITION</span> p3 <span class="token keyword">VALUES</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'1994-01-01'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'1995-01-01'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token keyword">PARTITION</span> p4 <span class="token keyword">VALUES</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'1995-01-01'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'1996-01-01'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token keyword">PARTITION</span> p5 <span class="token keyword">VALUES</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'1996-01-01'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'1997-01-01'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token keyword">PARTITION</span> p6 <span class="token keyword">VALUES</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'1997-01-01'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'1998-01-01'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token keyword">PARTITION</span> p7 <span class="token keyword">VALUES</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'1998-01-01'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'1999-01-01'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">DISTRIBUTED</span> <span class="token keyword">BY</span> <span class="token keyword">HASH</span><span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>lo_orderkey<span class="token punctuation">`</span></span><span class="token punctuation">)</span> BUCKETS <span class="token number">48</span>
PROPERTIES <span class="token punctuation">(</span>
<span class="token string">"replication_num"</span> <span class="token operator">=</span> <span class="token string">"1"</span><span class="token punctuation">,</span>
<span class="token string">"in_memory"</span> <span class="token operator">=</span> <span class="token string">"false"</span><span class="token punctuation">,</span>
<span class="token string">"storage_format"</span> <span class="token operator">=</span> <span class="token string">"DEFAULT"</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="clickhouse_192"></a>clickhouse测试数据生成</h5> 
<p>编译 :</p> 
<blockquote> 
 <p>git clone https://github.com/vadimtk/ssb-dbgen.git<br> cd ssb-dbgen<br> make</p> 
</blockquote> 
<p>其他参考<a href="https://clickhouse.com/docs/en/getting-started/example-datasets/star-schema/" rel="nofollow">链接</a>，使用因子10，生成6千万条测试数据。</p> 
<h4><a id="_202"></a>测试数据详情</h4> 
<table><thead><tr><th>表名</th><th>行数</th><th>解释</th></tr></thead><tbody><tr><td>lineorder</td><td>6千万</td><td>SSB商品订单表</td></tr><tr><td>customer</td><td>30万</td><td>SSB客户表</td></tr><tr><td>part</td><td>80万</td><td>SSB 零部件表</td></tr><tr><td>supplier</td><td>2万</td><td>SSB 供应商表</td></tr><tr><td>dates</td><td>2556</td><td>日期表</td></tr><tr><td>lineorder_flat</td><td>6千万</td><td>SSB打平后的宽表</td></tr></tbody></table> 
<h4><a id="sql_213"></a>测试sql</h4> 
<h5><a id="SQL_215"></a>单表测试SQL</h5> 
<pre><code class="prism language-sql"><span class="token comment">--Q1.1 </span>
<span class="token keyword">SELECT</span> <span class="token function">sum</span><span class="token punctuation">(</span>lo_extendedprice <span class="token operator">*</span> lo_discount<span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>revenue<span class="token punctuation">`</span></span> 
<span class="token keyword">FROM</span> lineorder_flat 
<span class="token keyword">WHERE</span> lo_orderdate <span class="token operator">&gt;=</span> <span class="token string">'1993-01-01'</span> <span class="token operator">and</span> lo_orderdate <span class="token operator">&lt;=</span> <span class="token string">'1993-12-31'</span> <span class="token operator">AND</span> lo_discount <span class="token operator">BETWEEN</span> <span class="token number">1</span> <span class="token operator">AND</span> <span class="token number">3</span> <span class="token operator">AND</span> lo_quantity <span class="token operator">&lt;</span> <span class="token number">25</span><span class="token punctuation">;</span> 
 
<span class="token comment">--Q1.2 </span>
<span class="token keyword">SELECT</span> <span class="token function">sum</span><span class="token punctuation">(</span>lo_extendedprice <span class="token operator">*</span> lo_discount<span class="token punctuation">)</span> <span class="token keyword">AS</span> revenue <span class="token keyword">FROM</span> lineorder_flat  
<span class="token keyword">WHERE</span> lo_orderdate <span class="token operator">&gt;=</span> <span class="token string">'1994-01-01'</span> <span class="token operator">and</span> lo_orderdate <span class="token operator">&lt;=</span> <span class="token string">'1994-01-31'</span> <span class="token operator">AND</span> lo_discount <span class="token operator">BETWEEN</span> <span class="token number">4</span> <span class="token operator">AND</span> <span class="token number">6</span> <span class="token operator">AND</span> lo_quantity <span class="token operator">BETWEEN</span> <span class="token number">26</span> <span class="token operator">AND</span> <span class="token number">35</span><span class="token punctuation">;</span> 
 
<span class="token comment">--Q1.3 </span>
<span class="token keyword">SELECT</span> <span class="token function">sum</span><span class="token punctuation">(</span>lo_extendedprice <span class="token operator">*</span> lo_discount<span class="token punctuation">)</span> <span class="token keyword">AS</span> revenue 
<span class="token keyword">FROM</span> lineorder_flat 
<span class="token keyword">WHERE</span> weekofyear<span class="token punctuation">(</span>lo_orderdate<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">6</span> <span class="token operator">AND</span> lo_orderdate <span class="token operator">&gt;=</span> <span class="token string">'1994-01-01'</span> <span class="token operator">and</span> lo_orderdate <span class="token operator">&lt;=</span> <span class="token string">'1994-12-31'</span> 
 <span class="token operator">AND</span> lo_discount <span class="token operator">BETWEEN</span> <span class="token number">5</span> <span class="token operator">AND</span> <span class="token number">7</span> <span class="token operator">AND</span> lo_quantity <span class="token operator">BETWEEN</span> <span class="token number">26</span> <span class="token operator">AND</span> <span class="token number">35</span><span class="token punctuation">;</span> 
 
 
<span class="token comment">--Q2.1 </span>
<span class="token keyword">SELECT</span> <span class="token function">sum</span><span class="token punctuation">(</span>lo_revenue<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">year</span><span class="token punctuation">(</span>lo_orderdate<span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">year</span><span class="token punctuation">,</span>  p_brand 
<span class="token keyword">FROM</span> lineorder_flat 
<span class="token keyword">WHERE</span> p_category <span class="token operator">=</span> <span class="token string">'MFGR#12'</span> <span class="token operator">AND</span> s_region <span class="token operator">=</span> <span class="token string">'AMERICA'</span> 
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token keyword">year</span><span class="token punctuation">,</span>  p_brand 
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token keyword">year</span><span class="token punctuation">,</span> p_brand<span class="token punctuation">;</span> 
 
<span class="token comment">--Q2.2 </span>
<span class="token keyword">SELECT</span> 
<span class="token function">sum</span><span class="token punctuation">(</span>lo_revenue<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">year</span><span class="token punctuation">(</span>lo_orderdate<span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">year</span><span class="token punctuation">,</span> p_brand 
<span class="token keyword">FROM</span> lineorder_flat 
<span class="token keyword">WHERE</span> p_brand <span class="token operator">&gt;=</span> <span class="token string">'MFGR#2221'</span> <span class="token operator">AND</span> p_brand <span class="token operator">&lt;=</span> <span class="token string">'MFGR#2228'</span> <span class="token operator">AND</span> s_region <span class="token operator">=</span> <span class="token string">'ASIA'</span> 
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token keyword">year</span><span class="token punctuation">,</span>  p_brand 
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token keyword">year</span><span class="token punctuation">,</span> p_brand<span class="token punctuation">;</span> 
  
<span class="token comment">--Q2.3 </span>
<span class="token keyword">SELECT</span> <span class="token function">sum</span><span class="token punctuation">(</span>lo_revenue<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">year</span><span class="token punctuation">(</span>lo_orderdate<span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">year</span><span class="token punctuation">,</span> p_brand 
<span class="token keyword">FROM</span> lineorder_flat 
<span class="token keyword">WHERE</span> p_brand <span class="token operator">=</span> <span class="token string">'MFGR#2239'</span> <span class="token operator">AND</span> s_region <span class="token operator">=</span> <span class="token string">'EUROPE'</span> 
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span>  <span class="token keyword">year</span><span class="token punctuation">,</span>  p_brand 
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token keyword">year</span><span class="token punctuation">,</span> p_brand<span class="token punctuation">;</span> 
 
 
<span class="token comment">--Q3.1 </span>
<span class="token keyword">SELECT</span> c_nation<span class="token punctuation">,</span> s_nation<span class="token punctuation">,</span>  <span class="token keyword">year</span><span class="token punctuation">(</span>lo_orderdate<span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">year</span><span class="token punctuation">,</span> <span class="token function">sum</span><span class="token punctuation">(</span>lo_revenue<span class="token punctuation">)</span> <span class="token keyword">AS</span> revenue <span class="token keyword">FROM</span> lineorder_flat 
<span class="token keyword">WHERE</span> c_region <span class="token operator">=</span> <span class="token string">'ASIA'</span> <span class="token operator">AND</span> s_region <span class="token operator">=</span> <span class="token string">'ASIA'</span> <span class="token operator">AND</span> lo_orderdate  <span class="token operator">&gt;=</span> <span class="token string">'1992-01-01'</span> <span class="token operator">AND</span> lo_orderdate   <span class="token operator">&lt;=</span> <span class="token string">'1997-12-31'</span> 
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> c_nation<span class="token punctuation">,</span> s_nation<span class="token punctuation">,</span> <span class="token keyword">year</span> 
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span>  <span class="token keyword">year</span> <span class="token keyword">ASC</span><span class="token punctuation">,</span> revenue <span class="token keyword">DESC</span><span class="token punctuation">;</span> 
 
<span class="token comment">--Q3.2 </span>
<span class="token keyword">SELECT</span>  c_city<span class="token punctuation">,</span> s_city<span class="token punctuation">,</span> <span class="token keyword">year</span><span class="token punctuation">(</span>lo_orderdate<span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">year</span><span class="token punctuation">,</span> <span class="token function">sum</span><span class="token punctuation">(</span>lo_revenue<span class="token punctuation">)</span> <span class="token keyword">AS</span> revenue
<span class="token keyword">FROM</span> lineorder_flat 
<span class="token keyword">WHERE</span> c_nation <span class="token operator">=</span> <span class="token string">'UNITED STATES'</span> <span class="token operator">AND</span> s_nation <span class="token operator">=</span> <span class="token string">'UNITED STATES'</span> <span class="token operator">AND</span> lo_orderdate  <span class="token operator">&gt;=</span> <span class="token string">'1992-01-01'</span> <span class="token operator">AND</span> lo_orderdate <span class="token operator">&lt;=</span> <span class="token string">'1997-12-31'</span> 
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> c_city<span class="token punctuation">,</span> s_city<span class="token punctuation">,</span> <span class="token keyword">year</span> 
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token keyword">year</span> <span class="token keyword">ASC</span><span class="token punctuation">,</span> revenue <span class="token keyword">DESC</span><span class="token punctuation">;</span> 
 
<span class="token comment">--Q3.3 </span>
<span class="token keyword">SELECT</span> c_city<span class="token punctuation">,</span> s_city<span class="token punctuation">,</span> <span class="token keyword">year</span><span class="token punctuation">(</span>lo_orderdate<span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">year</span><span class="token punctuation">,</span> <span class="token function">sum</span><span class="token punctuation">(</span>lo_revenue<span class="token punctuation">)</span> <span class="token keyword">AS</span> revenue 
<span class="token keyword">FROM</span> lineorder_flat 
<span class="token keyword">WHERE</span> c_city <span class="token operator">in</span> <span class="token punctuation">(</span> <span class="token string">'UNITED KI1'</span> <span class="token punctuation">,</span><span class="token string">'UNITED KI5'</span><span class="token punctuation">)</span> <span class="token operator">AND</span> s_city <span class="token operator">in</span> <span class="token punctuation">(</span> <span class="token string">'UNITED KI1'</span> <span class="token punctuation">,</span><span class="token string">'UNITED KI5'</span><span class="token punctuation">)</span> <span class="token operator">AND</span> lo_orderdate  <span class="token operator">&gt;=</span> <span class="token string">'1992-01-01'</span> <span class="token operator">AND</span> lo_orderdate <span class="token operator">&lt;=</span> <span class="token string">'1997-12-31'</span> 
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> c_city<span class="token punctuation">,</span> s_city<span class="token punctuation">,</span> <span class="token keyword">year</span> 
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token keyword">year</span> <span class="token keyword">ASC</span><span class="token punctuation">,</span> revenue <span class="token keyword">DESC</span><span class="token punctuation">;</span> 
 
<span class="token comment">--Q3.4 </span>
<span class="token keyword">SELECT</span> c_city<span class="token punctuation">,</span> s_city<span class="token punctuation">,</span> <span class="token keyword">year</span><span class="token punctuation">(</span>lo_orderdate<span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">year</span><span class="token punctuation">,</span> <span class="token function">sum</span><span class="token punctuation">(</span>lo_revenue<span class="token punctuation">)</span> <span class="token keyword">AS</span> revenue 
<span class="token keyword">FROM</span> lineorder_flat 
<span class="token keyword">WHERE</span> c_city <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'UNITED KI1'</span><span class="token punctuation">,</span> <span class="token string">'UNITED KI5'</span><span class="token punctuation">)</span> <span class="token operator">AND</span> s_city <span class="token operator">in</span> <span class="token punctuation">(</span> <span class="token string">'UNITED KI1'</span><span class="token punctuation">,</span>  <span class="token string">'UNITED KI5'</span><span class="token punctuation">)</span> <span class="token operator">AND</span>  lo_orderdate  <span class="token operator">&gt;=</span> <span class="token string">'1997-12-01'</span> <span class="token operator">AND</span> lo_orderdate <span class="token operator">&lt;=</span> <span class="token string">'1997-12-31'</span> 
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> c_city<span class="token punctuation">,</span>  s_city<span class="token punctuation">,</span> <span class="token keyword">year</span> 
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token keyword">year</span> <span class="token keyword">ASC</span><span class="token punctuation">,</span> revenue <span class="token keyword">DESC</span><span class="token punctuation">;</span> 
 
 
<span class="token comment">--Q4.1 </span>
<span class="token keyword">set</span> vectorized_engine_enable <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">;</span> 
<span class="token keyword">SELECT</span> <span class="token keyword">year</span><span class="token punctuation">(</span>lo_orderdate<span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">year</span><span class="token punctuation">,</span> c_nation<span class="token punctuation">,</span>  <span class="token function">sum</span><span class="token punctuation">(</span>lo_revenue <span class="token operator">-</span> lo_supplycost<span class="token punctuation">)</span> <span class="token keyword">AS</span> profit <span class="token keyword">FROM</span> lineorder_flat 
<span class="token keyword">WHERE</span> c_region <span class="token operator">=</span> <span class="token string">'AMERICA'</span> <span class="token operator">AND</span> s_region <span class="token operator">=</span> <span class="token string">'AMERICA'</span> <span class="token operator">AND</span> p_mfgr <span class="token operator">in</span> <span class="token punctuation">(</span> <span class="token string">'MFGR#1'</span> <span class="token punctuation">,</span> <span class="token string">'MFGR#2'</span><span class="token punctuation">)</span> 
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token keyword">year</span><span class="token punctuation">,</span> c_nation 
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token keyword">year</span> <span class="token keyword">ASC</span><span class="token punctuation">,</span> c_nation <span class="token keyword">ASC</span><span class="token punctuation">;</span> 
 
<span class="token comment">--Q4.2 </span>
<span class="token keyword">SELECT</span> <span class="token keyword">year</span><span class="token punctuation">(</span>lo_orderdate<span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">year</span><span class="token punctuation">,</span> 
    s_nation<span class="token punctuation">,</span> p_category<span class="token punctuation">,</span> <span class="token function">sum</span><span class="token punctuation">(</span>lo_revenue <span class="token operator">-</span> lo_supplycost<span class="token punctuation">)</span> <span class="token keyword">AS</span> profit 
<span class="token keyword">FROM</span> lineorder_flat 
<span class="token keyword">WHERE</span> c_region <span class="token operator">=</span> <span class="token string">'AMERICA'</span> <span class="token operator">AND</span> s_region <span class="token operator">=</span> <span class="token string">'AMERICA'</span> <span class="token operator">AND</span> lo_orderdate <span class="token operator">&gt;=</span> <span class="token string">'1997-01-01'</span> <span class="token operator">and</span> lo_orderdate <span class="token operator">&lt;=</span> <span class="token string">'1998-12-31'</span> <span class="token operator">AND</span>  p_mfgr <span class="token operator">in</span> <span class="token punctuation">(</span> <span class="token string">'MFGR#1'</span> <span class="token punctuation">,</span> <span class="token string">'MFGR#2'</span><span class="token punctuation">)</span> 
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token keyword">year</span><span class="token punctuation">,</span> s_nation<span class="token punctuation">,</span>  p_category 
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span>  <span class="token keyword">year</span> <span class="token keyword">ASC</span><span class="token punctuation">,</span> s_nation <span class="token keyword">ASC</span><span class="token punctuation">,</span> p_category <span class="token keyword">ASC</span><span class="token punctuation">;</span> 
 
<span class="token comment">--Q4.3 </span>
<span class="token keyword">SELECT</span> <span class="token keyword">year</span><span class="token punctuation">(</span>lo_orderdate<span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">year</span><span class="token punctuation">,</span> s_city<span class="token punctuation">,</span> p_brand<span class="token punctuation">,</span> 
    <span class="token function">sum</span><span class="token punctuation">(</span>lo_revenue <span class="token operator">-</span> lo_supplycost<span class="token punctuation">)</span> <span class="token keyword">AS</span> profit 
<span class="token keyword">FROM</span> lineorder_flat 
<span class="token keyword">WHERE</span> s_nation <span class="token operator">=</span> <span class="token string">'UNITED STATES'</span> <span class="token operator">AND</span> lo_orderdate <span class="token operator">&gt;=</span> <span class="token string">'1997-01-01'</span> <span class="token operator">and</span> lo_orderdate <span class="token operator">&lt;=</span> <span class="token string">'1998-12-31'</span> <span class="token operator">AND</span> p_category <span class="token operator">=</span> <span class="token string">'MFGR#14'</span> 
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span>  <span class="token keyword">year</span><span class="token punctuation">,</span>  s_city<span class="token punctuation">,</span> p_brand 
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token keyword">year</span> <span class="token keyword">ASC</span><span class="token punctuation">,</span>  s_city <span class="token keyword">ASC</span><span class="token punctuation">,</span>  p_brand <span class="token keyword">ASC</span><span class="token punctuation">;</span> 
</code></pre> 
<h5><a id="SQL_309"></a>多表测试SQL</h5> 
<pre><code class="prism language-sql"><span class="token comment">--Q1.1 </span>
<span class="token keyword">select</span> <span class="token function">sum</span><span class="token punctuation">(</span>lo_revenue<span class="token punctuation">)</span> <span class="token keyword">as</span> revenue
<span class="token keyword">from</span> lineorder <span class="token keyword">join</span> dates <span class="token keyword">on</span> lo_orderdate <span class="token operator">=</span> d_datekey
<span class="token keyword">where</span> d_year <span class="token operator">=</span> <span class="token number">1993</span> <span class="token operator">and</span> lo_discount <span class="token operator">between</span> <span class="token number">1</span> <span class="token operator">and</span> <span class="token number">3</span> <span class="token operator">and</span> lo_quantity <span class="token operator">&lt;</span> <span class="token number">25</span><span class="token punctuation">;</span>

<span class="token comment">--Q1.2</span>
<span class="token keyword">select</span> <span class="token function">sum</span><span class="token punctuation">(</span>lo_revenue<span class="token punctuation">)</span> <span class="token keyword">as</span> revenue
<span class="token keyword">from</span> lineorder
<span class="token keyword">join</span> dates <span class="token keyword">on</span> lo_orderdate <span class="token operator">=</span> d_datekey
<span class="token keyword">where</span> d_yearmonthnum <span class="token operator">=</span> <span class="token number">199401</span>
<span class="token operator">and</span> lo_discount <span class="token operator">between</span> <span class="token number">4</span> <span class="token operator">and</span> <span class="token number">6</span>
<span class="token operator">and</span> lo_quantity <span class="token operator">between</span> <span class="token number">26</span> <span class="token operator">and</span> <span class="token number">35</span><span class="token punctuation">;</span>

<span class="token comment">--Q1.3</span>
<span class="token keyword">select</span> <span class="token function">sum</span><span class="token punctuation">(</span>lo_revenue<span class="token punctuation">)</span> <span class="token keyword">as</span> revenue
<span class="token keyword">from</span> lineorder
<span class="token keyword">join</span> dates <span class="token keyword">on</span> lo_orderdate <span class="token operator">=</span> d_datekey
<span class="token keyword">where</span> d_weeknuminyear <span class="token operator">=</span> <span class="token number">6</span> <span class="token operator">and</span> d_year <span class="token operator">=</span> <span class="token number">1994</span>
<span class="token operator">and</span> lo_discount <span class="token operator">between</span> <span class="token number">5</span> <span class="token operator">and</span> <span class="token number">7</span>
<span class="token operator">and</span> lo_quantity <span class="token operator">between</span> <span class="token number">26</span> <span class="token operator">and</span> <span class="token number">35</span><span class="token punctuation">;</span>


<span class="token comment">--Q2.1</span>
<span class="token keyword">select</span> <span class="token function">sum</span><span class="token punctuation">(</span>lo_revenue<span class="token punctuation">)</span> <span class="token keyword">as</span> lo_revenue<span class="token punctuation">,</span> d_year<span class="token punctuation">,</span> p_brand
<span class="token keyword">from</span> lineorder
<span class="token keyword">inner</span> <span class="token keyword">join</span> dates <span class="token keyword">on</span> lo_orderdate <span class="token operator">=</span> d_datekey
<span class="token keyword">join</span> part <span class="token keyword">on</span> lo_partkey <span class="token operator">=</span> p_partkey
<span class="token keyword">join</span> supplier <span class="token keyword">on</span> lo_suppkey <span class="token operator">=</span> s_suppkey
<span class="token keyword">where</span> p_category <span class="token operator">=</span> <span class="token string">'MFGR#12'</span> <span class="token operator">and</span> s_region <span class="token operator">=</span> <span class="token string">'AMERICA'</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> d_year<span class="token punctuation">,</span> p_brand
<span class="token keyword">order</span> <span class="token keyword">by</span> d_year<span class="token punctuation">,</span> p_brand<span class="token punctuation">;</span>

<span class="token comment">--Q2.2</span>
<span class="token keyword">select</span> <span class="token function">sum</span><span class="token punctuation">(</span>lo_revenue<span class="token punctuation">)</span> <span class="token keyword">as</span> lo_revenue<span class="token punctuation">,</span> d_year<span class="token punctuation">,</span> p_brand
<span class="token keyword">from</span> lineorder
<span class="token keyword">join</span> dates <span class="token keyword">on</span> lo_orderdate <span class="token operator">=</span> d_datekey
<span class="token keyword">join</span> part <span class="token keyword">on</span> lo_partkey <span class="token operator">=</span> p_partkey
<span class="token keyword">join</span> supplier <span class="token keyword">on</span> lo_suppkey <span class="token operator">=</span> s_suppkey
<span class="token keyword">where</span> p_brand <span class="token operator">between</span> <span class="token string">'MFGR#2221'</span> <span class="token operator">and</span> <span class="token string">'MFGR#2228'</span> <span class="token operator">and</span> s_region <span class="token operator">=</span> <span class="token string">'ASIA'</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> d_year<span class="token punctuation">,</span> p_brand
<span class="token keyword">order</span> <span class="token keyword">by</span> d_year<span class="token punctuation">,</span> p_brand<span class="token punctuation">;</span>

<span class="token comment">--Q2.3</span>
<span class="token keyword">select</span> <span class="token function">sum</span><span class="token punctuation">(</span>lo_revenue<span class="token punctuation">)</span> <span class="token keyword">as</span> lo_revenue<span class="token punctuation">,</span> d_year<span class="token punctuation">,</span> p_brand
<span class="token keyword">from</span> lineorder
<span class="token keyword">join</span> dates <span class="token keyword">on</span> lo_orderdate <span class="token operator">=</span> d_datekey
<span class="token keyword">join</span> part <span class="token keyword">on</span> lo_partkey <span class="token operator">=</span> p_partkey
<span class="token keyword">join</span> supplier <span class="token keyword">on</span> lo_suppkey <span class="token operator">=</span> s_suppkey
<span class="token keyword">where</span> p_brand <span class="token operator">=</span> <span class="token string">'MFGR#2239'</span> <span class="token operator">and</span> s_region <span class="token operator">=</span> <span class="token string">'EUROPE'</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> d_year<span class="token punctuation">,</span> p_brand
<span class="token keyword">order</span> <span class="token keyword">by</span> d_year<span class="token punctuation">,</span> p_brand<span class="token punctuation">;</span>


<span class="token comment">--Q3.1</span>
<span class="token keyword">select</span> c_nation<span class="token punctuation">,</span> s_nation<span class="token punctuation">,</span> d_year<span class="token punctuation">,</span> <span class="token function">sum</span><span class="token punctuation">(</span>lo_revenue<span class="token punctuation">)</span> <span class="token keyword">as</span> lo_revenue
<span class="token keyword">from</span> lineorder
<span class="token keyword">join</span> dates <span class="token keyword">on</span> lo_orderdate <span class="token operator">=</span> d_datekey
<span class="token keyword">join</span> customer <span class="token keyword">on</span> lo_custkey <span class="token operator">=</span> c_custkey
<span class="token keyword">join</span> supplier <span class="token keyword">on</span> lo_suppkey <span class="token operator">=</span> s_suppkey
<span class="token keyword">where</span> c_region <span class="token operator">=</span> <span class="token string">'ASIA'</span> <span class="token operator">and</span> s_region <span class="token operator">=</span> <span class="token string">'ASIA'</span><span class="token operator">and</span> d_year <span class="token operator">&gt;=</span> <span class="token number">1992</span> <span class="token operator">and</span> d_year <span class="token operator">&lt;=</span> <span class="token number">1997</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> c_nation<span class="token punctuation">,</span> s_nation<span class="token punctuation">,</span> d_year
<span class="token keyword">order</span> <span class="token keyword">by</span> d_year <span class="token keyword">asc</span><span class="token punctuation">,</span> lo_revenue <span class="token keyword">desc</span><span class="token punctuation">;</span>

<span class="token comment">--Q3.2</span>
<span class="token keyword">select</span> c_city<span class="token punctuation">,</span> s_city<span class="token punctuation">,</span> d_year<span class="token punctuation">,</span> <span class="token function">sum</span><span class="token punctuation">(</span>lo_revenue<span class="token punctuation">)</span> <span class="token keyword">as</span> lo_revenue
<span class="token keyword">from</span> lineorder
<span class="token keyword">join</span> dates <span class="token keyword">on</span> lo_orderdate <span class="token operator">=</span> d_datekey
<span class="token keyword">join</span> customer <span class="token keyword">on</span> lo_custkey <span class="token operator">=</span> c_custkey
<span class="token keyword">join</span> supplier <span class="token keyword">on</span> lo_suppkey <span class="token operator">=</span> s_suppkey
<span class="token keyword">where</span> c_nation <span class="token operator">=</span> <span class="token string">'UNITED STATES'</span> <span class="token operator">and</span> s_nation <span class="token operator">=</span> <span class="token string">'UNITED STATES'</span>
<span class="token operator">and</span> d_year <span class="token operator">&gt;=</span> <span class="token number">1992</span> <span class="token operator">and</span> d_year <span class="token operator">&lt;=</span> <span class="token number">1997</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> c_city<span class="token punctuation">,</span> s_city<span class="token punctuation">,</span> d_year
<span class="token keyword">order</span> <span class="token keyword">by</span> d_year <span class="token keyword">asc</span><span class="token punctuation">,</span> lo_revenue <span class="token keyword">desc</span><span class="token punctuation">;</span>

<span class="token comment">--Q3.3</span>
<span class="token keyword">select</span> c_city<span class="token punctuation">,</span> s_city<span class="token punctuation">,</span> d_year<span class="token punctuation">,</span> <span class="token function">sum</span><span class="token punctuation">(</span>lo_revenue<span class="token punctuation">)</span> <span class="token keyword">as</span> lo_revenue
<span class="token keyword">from</span> lineorder
<span class="token keyword">join</span> dates <span class="token keyword">on</span> lo_orderdate <span class="token operator">=</span> d_datekey
<span class="token keyword">join</span> customer <span class="token keyword">on</span> lo_custkey <span class="token operator">=</span> c_custkey
<span class="token keyword">join</span> supplier <span class="token keyword">on</span> lo_suppkey <span class="token operator">=</span> s_suppkey
<span class="token keyword">where</span> <span class="token punctuation">(</span>c_city<span class="token operator">=</span><span class="token string">'UNITED KI1'</span> <span class="token operator">or</span> c_city<span class="token operator">=</span><span class="token string">'UNITED KI5'</span><span class="token punctuation">)</span>
<span class="token operator">and</span> <span class="token punctuation">(</span>s_city<span class="token operator">=</span><span class="token string">'UNITED KI1'</span> <span class="token operator">or</span> s_city<span class="token operator">=</span><span class="token string">'UNITED KI5'</span><span class="token punctuation">)</span>
<span class="token operator">and</span> d_year <span class="token operator">&gt;=</span> <span class="token number">1992</span> <span class="token operator">and</span> d_year <span class="token operator">&lt;=</span> <span class="token number">1997</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> c_city<span class="token punctuation">,</span> s_city<span class="token punctuation">,</span> d_year
<span class="token keyword">order</span> <span class="token keyword">by</span> d_year <span class="token keyword">asc</span><span class="token punctuation">,</span> lo_revenue <span class="token keyword">desc</span><span class="token punctuation">;</span>

<span class="token comment">--Q3.4</span>
<span class="token keyword">select</span> c_city<span class="token punctuation">,</span> s_city<span class="token punctuation">,</span> d_year<span class="token punctuation">,</span> <span class="token function">sum</span><span class="token punctuation">(</span>lo_revenue<span class="token punctuation">)</span> <span class="token keyword">as</span> lo_revenue
<span class="token keyword">from</span> lineorder
<span class="token keyword">join</span> dates <span class="token keyword">on</span> lo_orderdate <span class="token operator">=</span> d_datekey
<span class="token keyword">join</span> customer <span class="token keyword">on</span> lo_custkey <span class="token operator">=</span> c_custkey
<span class="token keyword">join</span> supplier <span class="token keyword">on</span> lo_suppkey <span class="token operator">=</span> s_suppkey
<span class="token keyword">where</span> <span class="token punctuation">(</span>c_city<span class="token operator">=</span><span class="token string">'UNITED KI1'</span> <span class="token operator">or</span> c_city<span class="token operator">=</span><span class="token string">'UNITED KI5'</span><span class="token punctuation">)</span> <span class="token operator">and</span> <span class="token punctuation">(</span>s_city<span class="token operator">=</span><span class="token string">'UNITED KI1'</span> <span class="token operator">or</span> s_city<span class="token operator">=</span><span class="token string">'UNITED KI5'</span><span class="token punctuation">)</span> <span class="token operator">and</span> d_yearmonth
 <span class="token operator">=</span> <span class="token string">'Dec1997'</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> c_city<span class="token punctuation">,</span> s_city<span class="token punctuation">,</span> d_year
<span class="token keyword">order</span> <span class="token keyword">by</span> d_year <span class="token keyword">asc</span><span class="token punctuation">,</span> lo_revenue <span class="token keyword">desc</span><span class="token punctuation">;</span>


<span class="token comment">--Q4.1</span>
<span class="token keyword">select</span> d_year<span class="token punctuation">,</span> c_nation<span class="token punctuation">,</span> <span class="token function">sum</span><span class="token punctuation">(</span>lo_revenue<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">sum</span><span class="token punctuation">(</span>lo_supplycost<span class="token punctuation">)</span> <span class="token keyword">as</span> profit
<span class="token keyword">from</span> lineorder
<span class="token keyword">join</span> dates <span class="token keyword">on</span> lo_orderdate <span class="token operator">=</span> d_datekey
<span class="token keyword">join</span> customer <span class="token keyword">on</span> lo_custkey <span class="token operator">=</span> c_custkey
<span class="token keyword">join</span> supplier <span class="token keyword">on</span> lo_suppkey <span class="token operator">=</span> s_suppkey
<span class="token keyword">join</span> part <span class="token keyword">on</span> lo_partkey <span class="token operator">=</span> p_partkey
<span class="token keyword">where</span> c_region <span class="token operator">=</span> <span class="token string">'AMERICA'</span> <span class="token operator">and</span> s_region <span class="token operator">=</span> <span class="token string">'AMERICA'</span> <span class="token operator">and</span> <span class="token punctuation">(</span>p_mfgr <span class="token operator">=</span> <span class="token string">'MFGR#1'</span> <span class="token operator">or</span> p_mfgr <span class="token operator">=</span> <span class="token string">'MFGR#2'</span><span class="token punctuation">)</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> d_year<span class="token punctuation">,</span> c_nation
<span class="token keyword">order</span> <span class="token keyword">by</span> d_year<span class="token punctuation">,</span> c_nation<span class="token punctuation">;</span>

<span class="token comment">--Q4.2</span>
<span class="token keyword">select</span> d_year<span class="token punctuation">,</span> s_nation<span class="token punctuation">,</span> p_category<span class="token punctuation">,</span> <span class="token function">sum</span><span class="token punctuation">(</span>lo_revenue<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">sum</span><span class="token punctuation">(</span>lo_supplycost<span class="token punctuation">)</span> <span class="token keyword">as</span> profit
<span class="token keyword">from</span> lineorder
<span class="token keyword">join</span> dates <span class="token keyword">on</span> lo_orderdate <span class="token operator">=</span> d_datekey
<span class="token keyword">join</span> customer <span class="token keyword">on</span> lo_custkey <span class="token operator">=</span> c_custkey
<span class="token keyword">join</span> supplier <span class="token keyword">on</span> lo_suppkey <span class="token operator">=</span> s_suppkey
<span class="token keyword">join</span> part <span class="token keyword">on</span> lo_partkey <span class="token operator">=</span> p_partkey
<span class="token keyword">where</span> c_region <span class="token operator">=</span> <span class="token string">'AMERICA'</span><span class="token operator">and</span> s_region <span class="token operator">=</span> <span class="token string">'AMERICA'</span>
<span class="token operator">and</span> <span class="token punctuation">(</span>d_year <span class="token operator">=</span> <span class="token number">1997</span> <span class="token operator">or</span> d_year <span class="token operator">=</span> <span class="token number">1998</span><span class="token punctuation">)</span>
<span class="token operator">and</span> <span class="token punctuation">(</span>p_mfgr <span class="token operator">=</span> <span class="token string">'MFGR#1'</span> <span class="token operator">or</span> p_mfgr <span class="token operator">=</span> <span class="token string">'MFGR#2'</span><span class="token punctuation">)</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> d_year<span class="token punctuation">,</span> s_nation<span class="token punctuation">,</span> p_category
<span class="token keyword">order</span> <span class="token keyword">by</span> d_year<span class="token punctuation">,</span> s_nation<span class="token punctuation">,</span> p_category<span class="token punctuation">;</span>

<span class="token comment">--Q4.3</span>
<span class="token keyword">select</span> d_year<span class="token punctuation">,</span> s_city<span class="token punctuation">,</span> p_brand<span class="token punctuation">,</span> <span class="token function">sum</span><span class="token punctuation">(</span>lo_revenue<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">sum</span><span class="token punctuation">(</span>lo_supplycost<span class="token punctuation">)</span> <span class="token keyword">as</span> profit
<span class="token keyword">from</span> lineorder
<span class="token keyword">join</span> dates <span class="token keyword">on</span> lo_orderdate <span class="token operator">=</span> d_datekey
<span class="token keyword">join</span> customer <span class="token keyword">on</span> lo_custkey <span class="token operator">=</span> c_custkey
<span class="token keyword">join</span> supplier <span class="token keyword">on</span> lo_suppkey <span class="token operator">=</span> s_suppkey
<span class="token keyword">join</span> part <span class="token keyword">on</span> lo_partkey <span class="token operator">=</span> p_partkey
<span class="token keyword">where</span> c_region <span class="token operator">=</span> <span class="token string">'AMERICA'</span><span class="token operator">and</span> s_nation <span class="token operator">=</span> <span class="token string">'UNITED STATES'</span>
<span class="token operator">and</span> <span class="token punctuation">(</span>d_year <span class="token operator">=</span> <span class="token number">1997</span> <span class="token operator">or</span> d_year <span class="token operator">=</span> <span class="token number">1998</span><span class="token punctuation">)</span>
<span class="token operator">and</span> p_category <span class="token operator">=</span> <span class="token string">'MFGR#14'</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> d_year<span class="token punctuation">,</span> s_city<span class="token punctuation">,</span> p_brand
<span class="token keyword">order</span> <span class="token keyword">by</span> d_year<span class="token punctuation">,</span> s_city<span class="token punctuation">,</span> p_brand<span class="token punctuation">;</span>
</code></pre> 
<h4><a id="_448"></a>运行测试用例</h4> 
<p>本测试采用单核测试</p> 
<h5><a id="clickhouse_452"></a>clickhouse</h5> 
<p>在客户端执行命令</p> 
<blockquote> 
 <p>set max_threads=1;</p> 
</blockquote> 
<p>clickhouse 使用上面单表测试SQL进行单表性能测试</p> 
<h5><a id="starrocksApache_doris_460"></a>starrocks和Apache doris</h5> 
<p>在客户端执行命令</p> 
<blockquote> 
 <p>set global parallel_fragment_exec_instance_num = 1;</p> 
</blockquote> 
<p>starrocks和Apache doris分别单表和多表测试，执行上面的SQL</p> 
<p>或者执行上面生成测试数据生成的脚本分别进行单表和多表测试</p> 
<p>执行SQL:</p> 
<blockquote> 
 <p>bin/benchmark.sh -p -d ssb<br> bin/benchmark.sh -p -d ssb-flat</p> 
</blockquote> 
<h3><a id="_475"></a>测试结果</h3> 
<h4><a id="_477"></a>单表测试结果</h4> 
<table><thead><tr><th>SQL</th><th>StarRocks 用时（ms）fisrt</th><th>StarRocks 用时（ms）</th><th>Apache Doris 用时（ms）first</th><th>Apache Doris 用时（ms）</th><th>Clickhouse用时（ms）first</th><th>Clickhouse用时（ms）</th></tr></thead><tbody><tr><td>Q1.1</td><td>6882</td><td>155</td><td>398</td><td>416</td><td>479</td><td>213</td></tr><tr><td>Q1.2</td><td>129</td><td>90</td><td>206</td><td>203</td><td>62</td><td>24</td></tr><tr><td>Q1.3</td><td>98</td><td>95</td><td>187</td><td>200</td><td>7</td><td>7</td></tr><tr><td>Q2.1</td><td>1715</td><td>529</td><td>7869</td><td>7678</td><td>2856</td><td>1199</td></tr><tr><td>Q2.2</td><td>405</td><td>437</td><td>6151</td><td>6329</td><td>965</td><td>984</td></tr><tr><td>Q2.3</td><td>183</td><td>160</td><td>796</td><td>724</td><td>935</td><td>952</td></tr><tr><td>Q3.1</td><td>993</td><td>1056</td><td>8170</td><td>8034</td><td>1710</td><td>1342</td></tr><tr><td>Q3.2</td><td>213</td><td>218</td><td>1127</td><td>1001</td><td>971</td><td>655</td></tr><tr><td>Q3.3</td><td>175</td><td>118</td><td>575</td><td>565</td><td>417</td><td>429</td></tr><tr><td>Q3.4</td><td>119</td><td>163</td><td>217</td><td>268</td><td>25</td><td>19</td></tr><tr><td>Q4.1</td><td>1134</td><td>1100</td><td>9730</td><td>8981</td><td>2158</td><td>1656</td></tr><tr><td>Q4.2</td><td>383</td><td>359</td><td>2905</td><td>2694</td><td>346</td><td>323</td></tr><tr><td>Q4.3</td><td>284</td><td>263</td><td>802</td><td>1019</td><td>330</td><td>298</td></tr></tbody></table> 
<p><img src="https://images2.imgbox.com/15/a4/p8WhoIYs_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_498"></a>多表测试结果</h4> 
<table><thead><tr><th>SQL</th><th>StarRocks 用时（ms）first</th><th>StarRocks 用时（ms）</th><th>Apache Doris 用时（ms）fisrt</th><th>Apache Doris 用时（ms）</th></tr></thead><tbody><tr><td>Q1.1</td><td>2349</td><td>46</td><td>5066</td><td>247</td></tr><tr><td>Q1.2</td><td>3775</td><td>42</td><td>165</td><td>114</td></tr><tr><td>Q1.3</td><td>47</td><td>45</td><td>141</td><td>174</td></tr><tr><td>Q2.1</td><td>11486</td><td>126</td><td>3450</td><td>505</td></tr><tr><td>Q2.2</td><td>204</td><td>177</td><td>513</td><td>501</td></tr><tr><td>Q2.3</td><td>103</td><td>92</td><td>428</td><td>422</td></tr><tr><td>Q3.1</td><td>569</td><td>245</td><td>2714</td><td>954</td></tr><tr><td>Q3.2</td><td>995</td><td>160</td><td>697</td><td>451</td></tr><tr><td>Q3.3</td><td>129</td><td>86</td><td>487</td><td>413</td></tr><tr><td>Q3.4</td><td>46</td><td>46</td><td>397</td><td>404</td></tr><tr><td>Q4.1</td><td>1335</td><td>261</td><td>837</td><td>825</td></tr><tr><td>Q4.2</td><td>122</td><td>96</td><td>741</td><td>744</td></tr><tr><td>Q4.3</td><td>89</td><td>79</td><td>504</td><td>515</td></tr></tbody></table> 
<p><img src="https://images2.imgbox.com/c5/16/jDEQxJQM_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_519"></a>结果分析</h3> 
<h4><a id="Linux__523"></a>从Linux 系统缓存命中率方面分析</h4> 
<p>从测试结果可以看出同一个查询引擎，第一次运行的结果都会比再次运行的时间要长。因此<a href="https://www.cnblogs.com/yinzhengjie/p/9994207.html" rel="nofollow">禁用系统交换分区</a>和<a href="https://zhuanlan.zhihu.com/p/190983603" rel="nofollow">提高缓存命中率</a>可以有效地提高分析引擎的查询效率。</p> 
<h4><a id="_529"></a>从不同查询引擎方面分析</h4> 
<ul><li> <p>从单表测试结果分析，StarRocks 的性能以微弱的优势领先于 Clickhouse，但都明显高于Apache Doris。</p> </li><li> <p>从多表测试结果分析，StarRocks 的性能明显高于Apache Doris。</p> </li><li> <p>另外从社区反馈分析，Clickhouse的性能在单表性能方面明显高于presto，参考<a href="https://www.cnblogs.com/bonelee/p/12878451.html" rel="nofollow">链接</a>; Presto和DorisDB在同等环境下性能对比，ORC格式下StarRocks 查询Hive外表的性能大约是Presto的3.35倍，参考<a href="https://blog.csdn.net/DorisDB/article/details/118760268">链接</a></p> </li></ul> 
<h3><a id="_539"></a>结论</h3> 
<p>采用满分为5来比较各方面性能</p> 
<table><thead><tr><th></th><th>StarRocks</th><th>Apache Doris</th><th>Clickhouse</th><th>presto</th></tr></thead><tbody><tr><td>单表查询性能</td><td>5</td><td>4</td><td>5</td><td>4</td></tr><tr><td>多表查询性能</td><td>5</td><td>4</td><td>1</td><td>3</td></tr><tr><td>外表支持</td><td>3（有限支持）</td><td>2（有限支持）</td><td>0（不支持）</td><td>5（丰富）</td></tr><tr><td>社区活跃度</td><td>1 （1.2k）</td><td>2 （3.3k）</td><td>5 (19.5k)</td><td>4 (12.4k)</td></tr></tbody></table> 
<p>时间：2021-09-23</p> 
<p>基于以上结论，得出以下各自使用场景</p> 
<p><strong>clickhouse场景</strong></p> 
<ul><li>海量数据，但又不希望单节点的存储空间消耗太高。</li><li>宽表，为了业务方便，可能会把很多相关数据列都整合到一个表里。</li></ul> 
<p><strong>StarRocks场景</strong></p> 
<ul><li>同时存在大量单表查询和多表聚合的需求</li><li>存在实时增量的场景（例如：kafka实时接入）</li></ul> 
<p><strong>presto场景</strong></p> 
<ul><li>同时存在大量单表查询和多表聚合的需求,同时对性能要求不是太高</li><li>存在多种数据源级联查询的场景</li><li>可以与hive/hdfs深入绑定，利用hdfs本地化计算的优势</li></ul> 
<p>由于StarRocks 是Apache Doris的加强版，因此推荐直接使用 StarRocks</p> 
<h3><a id="_574"></a>附件</h3> 
<p>StarRocks docker-compose参考<a href="https://hub.docker.com/repository/docker/ponylee/starrocks" rel="nofollow">链接</a></p> 
<p>Apache doris docker-compose参考<a href="https://hub.docker.com/repository/docker/ponylee/doris" rel="nofollow">链接</a></p> 
<p>clickhouse部署参考<a href="https://blog.csdn.net/weixin_38251332/article/details/120440495">链接</a></p> 
<p>presto部署参考<a href="https://blog.csdn.net/weixin_38251332/article/details/120440760">链接</a></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0f47458823078a810c736d7234b46f4d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【c语言】字符串输出方式 | API仿真</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e4803acb87733ce7f7eede692f3c1b39/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">vue中checkbox组件的@change事件触发父组件的冒泡事件</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>