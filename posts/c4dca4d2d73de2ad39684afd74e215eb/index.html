<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>怎样轻松实现一个 EventEmitter？ - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="怎样轻松实现一个 EventEmitter？" />
<meta property="og:description" content="怎样轻松实现一个 EventEmitter？ 之所以要特地讲解这部分知识，是因为虽然严格意义上来说，events模块属于 Node.js 服务端的知识，但是由于大多数 Node.js 核心 API构建用的是异步事件驱动架构。
在开始前请先思考几个问题：
EventEmitter采用什么样的设计模式？EventEmitter常用的API是怎样实现的？ Events 基本介绍 Node.js的events模块对外提供了一个 EventEmitter 对象，用于对 Node.js 中的事件进行统一管理。因为 Node.js 采用了事件驱动机制，而 EventEmitter就是 Node.js 实现事件驱动的基础。在 EventEmitter的基础上，Node.js中几乎所有的模块都继承了这个类，以实现异步事件驱动架构。
为了对此有一个大概的了解，先来看下 EventEmitter的简单使用情况，代码如下。
const events = require(&#39;events&#39;); const eventEmitter = new events.EventEmitter(); eventEmitter.on(&#39;say&#39;,(name)=&gt;{ console.log(&#39;hello&#39;,name); }) eventEmitter.emit(&#39;say&#39;,&#39;mark&#39;); // hello mark 以上代码中，新定义的eventEmitter是接收 events.EventEmitter模块 new之后返回的一个实例，eventEmitter的 emit方法，发出 say事件，通过 eventEmitter的 on方法监听，从而执行相应的函数。
常用的 EventEmitter 模块的 API 除了上面的那段代码中已经使用的 on和emit这两个 API，EventEmitter还提供了其他的 API方法，我通过一个表格简单整理了一下对应的方法和功能总结。
方法名方法描述addListener(event,listener)为指定事件添加一个监听器到监听器数组的尾部prependListener(event,listener)与addListener相对，为指定事件添加一个监听器到监听器数组的头部on(event,listener)其实就是addListener的别名removeListener(event,listener)移除指定事件的某个监听器，监听器必须是该事件已经标注过的监听器off(event,listener)removeListener的别名removeAllListeners([event])移除所有事件的所有监听器，如果指定事件，则移除指定事件的所有监听器setMaxListeners(n)默认情况下，EventEmitters中如果添加的监听器超过10个就会输出警告信息；setMaxListeners函数用于提高监听器的默认限制的数量。listeners(event)返回指定事件的监听器数组emit(event,[arg1],[arg2],[…])按参数的顺序执行每个监听器，如果事件有注册监听返回true,否则返回falseonce(event,listener)为指定事件注册一个单次监听器，即监听器最多只会触发一次，触发后立刻解除该监听器 除此之外，还有两个特殊的事件，不需要额外手动添加，下表所示的就是 Node.js 的 EventEmitter模块自带的特殊事件。
事件名事件描述newListener该事件在添加新事件监听器的时候触发removeListener从指定监听器数组中删除一个监听器，需要注意的是，此操作会改变处于被删监听器之后的那些监听器的索引。 addListener 和 removeListener、on 和 off 方法对比 addListener方法的作用是为指定事件添加一个监听器，其实和 on方法实现的功能是一样的，on其实就是 addListener方法的一个别名。二者实现的作用是一样的，同时 removeListener方法的作用是为移除某个事件的监听器，同样 off也是 removeListener的别名。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/c4dca4d2d73de2ad39684afd74e215eb/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-11-04T17:20:39+08:00" />
<meta property="article:modified_time" content="2021-11-04T17:20:39+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">怎样轻松实现一个 EventEmitter？</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_EventEmitter_0"></a>怎样轻松实现一个 EventEmitter？</h2> 
<p>  之所以要特地讲解这部分知识，是因为虽然严格意义上来说，<code>events</code>模块属于 <code>Node.js</code> 服务端的知识，但是由于大多数 <code>Node.js</code> 核心 <code>API</code>构建用的是异步事件驱动架构。</p> 
<p>在开始前请先思考几个问题：</p> 
<ol><li><code>EventEmitter</code>采用什么样的设计模式？</li><li><code>EventEmitter</code>常用的<code>API</code>是怎样实现的？</li></ol> 
<h3><a id="Events__9"></a>Events 基本介绍</h3> 
<p>  <code>Node.js</code>的<code>events</code>模块对外提供了一个 <code>EventEmitter</code> 对象，用于对 <code>Node.js</code> 中的事件进行统一管理。因为 <code>Node.js</code> 采用了事件驱动机制，而 <code>EventEmitter</code>就是 <code>Node.js</code> 实现事件驱动的基础。在 <code>EventEmitter</code>的基础上，<code>Node.js</code>中几乎所有的模块都继承了这个类，以实现异步事件驱动架构。</p> 
<p>  为了对此有一个大概的了解，先来看下 <code>EventEmitter</code>的简单使用情况，代码如下。</p> 
<pre><code class="prism language-js"><span class="token keyword">const</span> events <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> eventEmitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">events<span class="token punctuation">.</span>EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
eventEmitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'say'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
eventEmitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'say'</span><span class="token punctuation">,</span><span class="token string">'mark'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// hello mark</span>
</code></pre> 
<p>  以上代码中，新定义的<code>eventEmitter</code>是接收 <code>events.EventEmitter</code>模块 <code>new</code>之后返回的一个实例，<code>eventEmitter</code>的 <code>emit</code>方法，发出 <code>say</code>事件，通过 <code>eventEmitter</code>的 <code>on</code>方法监听，从而执行相应的函数。</p> 
<h3><a id="_EventEmitter__API_26"></a>常用的 EventEmitter 模块的 API</h3> 
<p>  除了上面的那段代码中已经使用的 <code>on</code>和<code>emit</code>这两个 <code>API</code>，<code>EventEmitter</code>还提供了其他的 <code>API</code>方法，我通过一个表格简单整理了一下对应的方法和功能总结。</p> 
<table><thead><tr><th>方法名</th><th>方法描述</th></tr></thead><tbody><tr><td>addListener(event,listener)</td><td>为指定事件添加一个监听器到监听器数组的尾部</td></tr><tr><td>prependListener(event,listener)</td><td>与<code>addListener</code>相对，为指定事件添加一个监听器到监听器数组的头部</td></tr><tr><td>on(event,listener)</td><td>其实就是<code>addListener</code>的别名</td></tr><tr><td>removeListener(event,listener)</td><td>移除指定事件的某个监听器，监听器必须是该事件已经标注过的监听器</td></tr><tr><td>off(event,listener)</td><td>removeListener的别名</td></tr><tr><td>removeAllListeners([event])</td><td>移除所有事件的所有监听器，如果指定事件，则移除指定事件的所有监听器</td></tr><tr><td>setMaxListeners(n)</td><td>默认情况下，<code>EventEmitters</code>中如果添加的监听器超过10个就会输出警告信息；<code>setMaxListeners</code>函数用于提高监听器的默认限制的数量。</td></tr><tr><td>listeners(event)</td><td>返回指定事件的监听器数组</td></tr><tr><td>emit(event,[arg1],[arg2],[…])</td><td>按参数的顺序执行每个监听器，如果事件有注册监听返回true,否则返回false</td></tr><tr><td>once(event,listener)</td><td>为指定事件注册一个单次监听器，即监听器最多只会触发一次，触发后立刻解除该监听器</td></tr></tbody></table> 
<p>  除此之外，还有两个特殊的事件，不需要额外手动添加，下表所示的就是 <code>Node.js</code> 的 <code>EventEmitter</code>模块自带的特殊事件。</p> 
<table><thead><tr><th>事件名</th><th>事件描述</th></tr></thead><tbody><tr><td>newListener</td><td>该事件在添加新事件监听器的时候触发</td></tr><tr><td>removeListener</td><td>从指定监听器数组中删除一个监听器，需要注意的是，此操作会改变处于被删监听器之后的那些监听器的索引。</td></tr></tbody></table> 
<h4><a id="addListener__removeListeneron__off__50"></a>addListener 和 removeListener、on 和 off 方法对比</h4> 
<p>  <code>addListener</code>方法的作用是为指定事件添加一个监听器，其实和 <code>on</code>方法实现的功能是一样的，<code>on</code>其实就是 <code>addListener</code>方法的一个别名。二者实现的作用是一样的，同时 <code>removeListener</code>方法的作用是为移除某个事件的监听器，同样 <code>off</code>也是 <code>removeListener</code>的别名。</p> 
<p>  下面我们来看看<code>addListener</code>和<code>removeListener</code>的用法，请看下面一段示例代码。</p> 
<pre><code class="prism language-js"><span class="token keyword">const</span> events <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> emitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">events<span class="token punctuation">.</span>EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">hello1</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"hello 1"</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">hello2</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"hello 2"</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

emitter<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token string">'say'</span><span class="token punctuation">,</span>hello1<span class="token punctuation">)</span><span class="token punctuation">;</span>
emitter<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token string">'say'</span><span class="token punctuation">,</span>hello2<span class="token punctuation">)</span><span class="token punctuation">;</span>
emitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'say'</span><span class="token punctuation">,</span><span class="token string">'mark'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

emitter<span class="token punctuation">.</span><span class="token function">removeListener</span><span class="token punctuation">(</span><span class="token string">'say'</span><span class="token punctuation">,</span>hello1<span class="token punctuation">)</span><span class="token punctuation">;</span>
emitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'say'</span><span class="token punctuation">,</span><span class="token string">'lpb'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token comment">/* 
执行结果：  
hello 1 mark
hello 2 mark
hello 2 lpb
*/</span>
</code></pre> 
<p>  结合代码和注释来理解我上面的描述，是不是对于 <code>addListener</code>和 <code>removeListener</code>、<code>on</code>和 <code>off</code>这两组方法的对比就一目了然了呢？</p> 
<h4><a id="removeListener__removeAllListeners_85"></a>removeListener 和 removeAllListeners</h4> 
<p>  <code>removeListener</code> 方法是指移除一个指定事件的某一个监听器，而 <code>removeAllListeners</code>指的是移除某一个指定事件的全部监听器。</p> 
<p>这里举一个<code>removeAllListeners</code>的代码例子，请看。</p> 
<pre><code class="prism language-js"><span class="token keyword">const</span> events <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> emitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">events<span class="token punctuation">.</span>EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">hello1</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"hello 1"</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">hello2</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"hello 2"</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

emitter<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token string">'say'</span><span class="token punctuation">,</span>hello1<span class="token punctuation">)</span><span class="token punctuation">;</span>
emitter<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token string">'say'</span><span class="token punctuation">,</span>hello2<span class="token punctuation">)</span><span class="token punctuation">;</span>
emitter<span class="token punctuation">.</span><span class="token function">removeAllListeners</span><span class="token punctuation">(</span><span class="token string">'say'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
emitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'say'</span><span class="token punctuation">,</span><span class="token string">'John'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//removeAllListeners 移除了所有关于 say 事件的监听</span>
<span class="token comment">//因此没有任何输出</span>

</code></pre> 
<h4><a id="on__once__113"></a>on 和 once 方法区别</h4> 
<p>  <code>on</code> 和 <code>once</code> 的区别是：<code>on</code>的方法对于某一指定事件添加的监听器可以持续不断地监听相应的事件；而 <code>once</code>方法添加的监听器，监听一次后，就会被消除。</p> 
<pre><code class="prism language-js"><span class="token keyword">const</span> events <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"events"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> emitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">events<span class="token punctuation">.</span>EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">hello</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

emitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"say"</span><span class="token punctuation">,</span> hello<span class="token punctuation">)</span><span class="token punctuation">;</span>

emitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">"say"</span><span class="token punctuation">,</span> <span class="token string">"John"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

emitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">"say"</span><span class="token punctuation">,</span> <span class="token string">"Lily"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

emitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">"say"</span><span class="token punctuation">,</span> <span class="token string">"Lucy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//会输出 hello John、hello Lily、hello Lucy，之后还要加也可以继续触发</span>

emitter<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">"see"</span><span class="token punctuation">,</span> hello<span class="token punctuation">)</span><span class="token punctuation">;</span>

emitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">"see"</span><span class="token punctuation">,</span> <span class="token string">"Tom"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//只会输出一次 hello Tom</span>

<span class="token comment">/* 执行结果：
hello John
hello Lily
hello Lucy
hello Tom
*/</span>

</code></pre> 
<p>  也就是说，<code>on</code>方法监听的事件，可以持续不断地被触发，而 <code>once</code>方法只会触发一次。</p> 
<h3><a id="_EventEmitter_153"></a>带你实现一个 EventEmitter</h3> 
<p>  <code>EventEmitter</code> 是在<code>Node.js</code> 中 <code>events</code>模块里封装的，那么在浏览器端实现一个这样的 <code>EventEmitter</code>是否可以呢？其实自己封装一个能在浏览器中跑的<code>EventEmitter</code>，并应用在你的业务代码中还是能带来不少方便的，它可以帮你实现自定义事件的订阅和发布，从而提升业务开发的便利性。</p> 
<p>  那么结合上面介绍的内容，我们一起来实现一个基础版本的<code>EventEmitter</code>，包含基础的<code>on</code>、 <code>of</code>、<code>emit</code>、<code>once</code>、<code>allof</code>这几个方法。</p> 
<p>首先，请看一下 <code>EventEmitter</code>的初始化代码。</p> 
<pre><code class="prism language-js"><span class="token keyword">function</span> <span class="token function">EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>__events <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

<span class="token punctuation">}</span>

EventEmitter<span class="token punctuation">.</span><span class="token constant">VERSION</span> <span class="token operator">=</span> <span class="token string">'1.0.0'</span><span class="token punctuation">;</span>

</code></pre> 
<p>  从上面的代码中可以看到，先初始化了一个内部的<code>__events</code>的对象，用来存放自定义事件，以及自定义事件的回调函数。</p> 
<p>  如何实现 <code>EventEmitter</code>的 <code>on</code>的方法，请看下面的代码</p> 
<pre><code class="prism language-js"><span class="token keyword">function</span> <span class="token function">EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>__events <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
EventEmitter<span class="token punctuation">.</span><span class="token constant">VERSION</span> <span class="token operator">=</span> <span class="token string">"1.0.0"</span><span class="token punctuation">;</span>

<span class="token class-name">EventEmitter</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">on</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">eventName<span class="token punctuation">,</span> listener</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 验证参数</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>eventName <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>listener<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 回调的litener是否是函数</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isValidKistener</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">"listener must be a function"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> events <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>__evnets<span class="token punctuation">;</span>
  <span class="token keyword">const</span> listeners <span class="token operator">=</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span> <span class="token operator">=</span> evnets<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> listenerIsWrapped <span class="token operator">=</span> <span class="token keyword">typeof</span> listener <span class="token operator">===</span> <span class="token string">"object"</span><span class="token punctuation">;</span>
  <span class="token comment">// 不重复添加事件，判断是否有相同</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">indexOf</span><span class="token punctuation">(</span>listeners<span class="token punctuation">.</span>listener<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    listeners<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
      listenerIsWrapped
        <span class="token operator">?</span> listener
        <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            listener<span class="token operator">:</span> listener<span class="token punctuation">,</span>
            once<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//判断是否是合法的listener</span>
<span class="token keyword">const</span> <span class="token function-variable function">isValidListener</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">listener</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> listener <span class="token operator">===</span> <span class="token string">"function"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>listener <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> listener <span class="token operator">===</span> <span class="token string">"object"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">isValidListener</span><span class="token punctuation">(</span>listener<span class="token punctuation">.</span>listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 判断新增自定义事件是否存在</span>
<span class="token keyword">const</span> <span class="token function-variable function">indexOf</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">array<span class="token punctuation">,</span> item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  item <span class="token operator">=</span> <span class="token keyword">typeof</span> item <span class="token operator">===</span> <span class="token string">"object"</span> <span class="token operator">?</span> item<span class="token punctuation">.</span>listener <span class="token operator">:</span> item<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> array<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>array<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>listener <span class="token operator">===</span> item<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      result <span class="token operator">=</span> i<span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>  从上面的代码中可以看出，<code>on</code>方法的核心思路就是，当调用订阅一个自定义事件的时候，只要该事件通过校验合法之后，就把该自定义事件 <code>push</code>到 <code>this.__events</code> 这个对象中存储，等需要出发的时候，则直接从通过获取 <code>__events</code> 中对应事件的 <code>listener</code>回调函数，而后直接执行该回调方法就能实现想要的效果。</p> 
<p>  再看看 <code>emit</code>方法是怎么实现触发效果的，请看下面的代码实现逻辑。</p> 
<pre><code class="prism language-js"><span class="token class-name">EventEmitter</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">emit</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">eventName<span class="token punctuation">,</span>args</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 直接通过内部对象获取对应自定义事件的回调函数</span>
    <span class="token keyword">let</span> listeners <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>__events<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>listeners<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token punctuation">;</span>
    <span class="token comment">// 需要考虑多个listener 的情况  </span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>listeners<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">let</span> listener <span class="token operator">=</span> listeners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>listener<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            listener<span class="token punctuation">.</span><span class="token function">listener</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>args<span class="token operator">||</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 给listener中once为true的进行特殊处理  </span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>listener<span class="token punctuation">.</span>once<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span>eventName<span class="token punctuation">,</span>listener<span class="token punctuation">.</span>litener<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token class-name">EventEmitter</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">off</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">eventName<span class="token punctuation">,</span>listener</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> listeners <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>__events<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>listener<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> index<span class="token punctuation">;</span> 
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>listeners<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>listeners<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> listeners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>listener <span class="token operator">===</span> listener<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            index <span class="token operator">=</span> i<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// off的关键  </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> index <span class="token operator">!==</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        listeners<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  从上面的代码中可以看出 <code>emit</code>的处理方式，其实就是拿到对应自定义事件进行 <code>apply</code>执行，在执行过程中对于一开始 <code>once</code>方法绑定的自定义事件进行特殊的处理，当<code>once</code>为 <code>true</code>的时候，再触发 <code>off</code>方法对该自定义事件进行解绑，从而实现自定义事件一次执行的效果。</p> 
<p>  最后，再看下 <code>once</code>方法和 <code>alloff</code>的实现。</p> 
<pre><code class="prism language-js"><span class="token class-name">EventEmitter</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">once</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">eventName<span class="token punctuation">,</span>listener</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 直接调用on方法，once参数传入true，待执行后进行once处理</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span>eventName<span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span>
        listener<span class="token operator">:</span>listener<span class="token punctuation">,</span>
        once<span class="token operator">:</span><span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">EventEmitter</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">allOff</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">eventName<span class="token punctuation">,</span>listener</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 如果该eventName存在，则将其对应的listener的数组直接清空  </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>eventName <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>__events<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>__events<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>__events <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>  从上面的代码中可以看到，<code>once</code>方法的本质还是调用 <code>on</code>方法，只不过传入的参数区分和非一次执行的情况。当再次触发 <code>emit</code>方法的时候，<code>once</code>绑定的执行一次之后再进行解绑。</p> 
<p>  <code>alloff</code> 方法也很好理解了，其实就是对内部的<code>__events</code>对象进行清空，清空之后如果再次触发自定义事件，也就无法触发回调函数了。</p> 
<h2><a id="_300"></a>总结</h2> 
<p>  现在，可以回过头思考一下在开篇提到的问题：<code>EventEmitter</code>采用的是什么样的设计模式？其实通过上面的学习不难发现，<code>EventEmitter</code>采用的正是发布-订阅模式。</p> 
<p>  另外，观察者模式和发布-订阅模式有些类似的地方，但是在细节方面还是有一些区别的，要注意别把这两个模式搞混了。发布-订阅模式其实是观察者模式的一种变形，区别在于：<strong>发布-订阅模式在观察者模式的基础上，在目标和观察者之间增加了一个调度中心</strong>。</p> 
<p>  单就浏览器端使用场景来说，其实也有运用同样的思路解决问题的工具，在 <code>Vue</code>框架中不同组件之间的通讯里，有一种解决方案叫 <code>EventBus</code>。和 <code>EventEmitter</code>的思路类似，它的基本用途是将 <code>EventBus</code>作为组件传递数据的桥梁，所有组件共用相同的事件中心，可以向该中心注册发送事件或接收事件，所有组件都可以收到通知，使用起来非常便利，其核心其实就是发布-订阅模式的落地实现。</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/281b4fbcdef3a6e2e18cc8642c016292/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">00后确实卷，公司新来的卷王，我们这帮老油条真干不过.....</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8e02c4a3c73e68ca438d61fce0c22f97/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">win10 conda 虚拟环境迁移到不能联网的主机</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>