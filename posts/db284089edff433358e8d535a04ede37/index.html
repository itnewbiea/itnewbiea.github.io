<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>从零开始Cubemx配置STM32搭载freeRTOS以及lwip实现tcp网络通信（二） - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="从零开始Cubemx配置STM32搭载freeRTOS以及lwip实现tcp网络通信（二）" />
<meta property="og:description" content="从零开始Cubemx配置STM32搭载freeRTOS以及lwip实现网络通信 引言CubeMX配置以太网以及LWIP实现一个回环功能（裸机）ETH配置LWIP配置 CubeMX配置以太网以及LWIP实现一个回环功能（freeRTOS）结论 引言 看见名字自己就笑了，标题的长度已经快赶上日本轻小说了，正好最近在追无职转生。
说回正题，上篇文章介绍了如何从零开始使用CubeMX生成一个带有freeRTOS操作系统的程序，嵌入式进阶指南以及必备知识学习路线，朋友们可以去看一下，这篇文章我将开始重头戏，如何在STM32F407上移植lwip实现TCP通信，最终实现一个httpd服务器。
自己写的另外两篇文章
从零开始Cubemx配置STM32搭载freeRTOS实现多路ADC（一）
从零开始使用CubeMX配置STM32使用lwip实现httpd服务器（三）
CubeMX配置STM32实现httpd服务器CGI功能并使用网页控制STM32单片机（四）
CubeMX配置以太网以及LWIP实现一个回环功能（裸机） 实现这个功能需要配置2部分，一部分的EHT也就是以太网的配置，另一部分是lwip协议栈的配置
ETH配置 ETH的配置主要有三个器件，单片机，物理网卡（在本文中我们使用的是LAN8720A芯片）以及网口。在这里面最重要的是物理网卡，单片机ETH的配置主要以物理网卡为主，与其电路连接有关系。LAN8720A的知识主要看这一篇文章 https://blog.csdn.net/sinat_20265495/article/details/79628283?spm=1001.2014.3001.5506
现在开始使用Cubemx配置ETH，在Connectivity选择中选择ETH
MII(Medium Independent Interface)是IEEE802．3u规定的一种介质无关接口，主要作用是连接介质访问控制层(MAC)子层与物理层(PH-Y)之间的标准以太网接口，负责MAC和PHY之间的通信。由于MII需要多达16根信号线，由此产生的I／O口需求及功耗较大，有必要对MII引脚数进行简化，因此提出了RMII(Reduced Medium Independent Interface，精简的介质无关接口)，即简化了的MII。更详细的看这篇文章 https://blog.csdn.net/fun_tion/article/details/70270632
采用MII接口，PYH的时钟频率要求25M，不需要与MAC层时钟一致。
采用RMII接口，PYH的时钟频率要求50M，需与MAC层时钟一致，通常从MAC层获取该时钟源。
现在一般都用RMII模式
LWIP配置 接下来生成代码就可以了
在主函数中，添加这两个函数
实现回环代码，新建一个tcpecho.c文件，代码
#include &#34;tcpecho.h&#34; #include &#34;lwip/netif.h&#34; #include &#34;lwip/ip.h&#34; #include &#34;lwip/tcp.h&#34; #include &#34;lwip/init.h&#34; #include &#34;netif/etharp.h&#34; #include &#34;lwip/udp.h&#34; #include &#34;lwip/pbuf.h&#34; #include &lt;stdio.h&gt;	#include &lt;string.h&gt; static err_t tcpecho_recv(void *arg, struct tcp_pcb *tpcb, struct pbuf *p, err_t err) { if (p != NULL) { /* 更新窗口*/ tcp_recved(tpcb, p-&gt;tot_len); /* 返回接收到的数据*/ tcp_write(tpcb, p-&gt;payload, p-&gt;tot_len, 1); memset(p-&gt;payload, 0 , p-&gt;tot_len); pbuf_free(p); } else if (err == ERR_OK) { return tcp_close(tpcb); } return ERR_OK; } static err_t tcpecho_accept(void *arg, struct tcp_pcb *newpcb, err_t err) { tcp_recv(newpcb, tcpecho_recv); return ERR_OK; } void TCP_Echo_Init(void) { struct tcp_pcb *pcb = NULL;	/* 创建一个TCP控制块 */ pcb = tcp_new();	/* 绑定TCP控制块 */ tcp_bind(pcb, IP_ADDR_ANY, TCP_ECHO_PORT); /* 进入监听状态 */ pcb = tcp_listen(pcb);	/* 处理连接 */	tcp_accept(pcb, tcpecho_accept); } 这样裸机就成功了，可以ping成功" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/db284089edff433358e8d535a04ede37/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-12-16T16:41:41+08:00" />
<meta property="article:modified_time" content="2021-12-16T16:41:41+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">从零开始Cubemx配置STM32搭载freeRTOS以及lwip实现tcp网络通信（二）</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>从零开始Cubemx配置STM32搭载freeRTOS以及lwip实现网络通信</h4> 
 <ul><li><a href="#_2" rel="nofollow">引言</a></li><li><a href="#CubeMXLWIP_11" rel="nofollow">CubeMX配置以太网以及LWIP实现一个回环功能（裸机）</a></li><li><ul><li><a href="#ETH_13" rel="nofollow">ETH配置</a></li><li><a href="#LWIP_25" rel="nofollow">LWIP配置</a></li></ul> 
  </li><li><a href="#CubeMXLWIPfreeRTOS_96" rel="nofollow">CubeMX配置以太网以及LWIP实现一个回环功能（freeRTOS）</a></li><li><a href="#_204" rel="nofollow">结论</a></li></ul> 
</div> 
<p></p> 
<h2><a id="_2"></a>引言</h2> 
<p>看见名字自己就笑了，标题的长度已经快赶上日本轻小说了，正好最近在追无职转生。<br> 说回正题，上篇文章介绍了如何从零开始使用CubeMX生成一个带有freeRTOS操作系统的程序，<a href="https://blog.csdn.net/qq_30623327/article/details/121696855?spm=1001.2014.3001.5501">嵌入式进阶指南以及必备知识学习路线</a>，朋友们可以去看一下，这篇文章我将开始重头戏，如何在STM32F407上移植lwip实现TCP通信，最终实现一个httpd服务器。</p> 
<p>自己写的另外两篇文章<br> <a href="https://blog.csdn.net/qq_30623327/article/details/121975230?spm=1001.2014.3001.5501">从零开始Cubemx配置STM32搭载freeRTOS实现多路ADC（一）</a><br> <a href="https://blog.csdn.net/qq_30623327/article/details/121978370?spm=1001.2014.3001.5501">从零开始使用CubeMX配置STM32使用lwip实现httpd服务器（三）</a><br> <a href="https://blog.csdn.net/qq_30623327/article/details/122055933">CubeMX配置STM32实现httpd服务器CGI功能并使用网页控制STM32单片机（四）</a></p> 
<h2><a id="CubeMXLWIP_11"></a>CubeMX配置以太网以及LWIP实现一个回环功能（裸机）</h2> 
<p>实现这个功能需要配置2部分，一部分的EHT也就是以太网的配置，另一部分是lwip协议栈的配置</p> 
<h3><a id="ETH_13"></a>ETH配置</h3> 
<p>ETH的配置主要有三个器件，单片机，物理网卡（在本文中我们使用的是LAN8720A芯片）以及网口。在这里面最重要的是物理网卡，单片机ETH的配置主要以物理网卡为主，与其电路连接有关系。LAN8720A的知识主要看这一篇文章 <a href="https://blog.csdn.net/sinat_20265495/article/details/79628283?spm=1001.2014.3001.5506">https://blog.csdn.net/sinat_20265495/article/details/79628283?spm=1001.2014.3001.5506</a><br> <img src="https://images2.imgbox.com/cc/f4/sUTqejDA_o.png" alt="在这里插入图片描述"><br> 现在开始使用Cubemx配置ETH，在Connectivity选择中选择ETH<br> <img src="https://images2.imgbox.com/a1/29/QvMdUm5W_o.png" alt="在这里插入图片描述"><br> MII(Medium Independent Interface)是IEEE802．3u规定的一种介质无关接口，主要作用是连接介质访问控制层(MAC)子层与物理层(PH-Y)之间的标准以太网接口，负责MAC和PHY之间的通信。由于MII需要多达16根信号线，由此产生的I／O口需求及功耗较大，有必要对MII引脚数进行简化，因此提出了RMII(Reduced Medium Independent Interface，精简的介质无关接口)，即简化了的MII。更详细的看这篇文章 <a href="https://blog.csdn.net/fun_tion/article/details/70270632">https://blog.csdn.net/fun_tion/article/details/70270632</a><br> 采用MII接口，PYH的时钟频率要求25M，不需要与MAC层时钟一致。<br> 采用RMII接口，PYH的时钟频率要求50M，需与MAC层时钟一致，通常从MAC层获取该时钟源。<br> 现在一般都用RMII模式<br> <img src="https://images2.imgbox.com/30/db/PuufTF9c_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/f0/cc/k1CS3Ng4_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/58/23/mtcWyQek_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="LWIP_25"></a>LWIP配置</h3> 
<p><img src="https://images2.imgbox.com/61/30/1ORjNvGe_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/d8/36/nVzZTAsK_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/b1/0d/djuunON4_o.png" alt="在这里插入图片描述"><br> 接下来生成代码就可以了<br> 在主函数中，添加这两个函数<br> <img src="https://images2.imgbox.com/56/4e/54qWNoGu_o.png" alt="在这里插入图片描述"><br> 实现回环代码，新建一个tcpecho.c文件，代码</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"tcpecho.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"lwip/netif.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"lwip/ip.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"lwip/tcp.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"lwip/init.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"netif/etharp.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"lwip/udp.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"lwip/pbuf.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span>	</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>


<span class="token keyword">static</span> <span class="token class-name">err_t</span> <span class="token function">tcpecho_recv</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">tcp_pcb</span> <span class="token operator">*</span>tpcb<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">pbuf</span> <span class="token operator">*</span>p<span class="token punctuation">,</span> <span class="token class-name">err_t</span> err<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{<!-- --></span>        
	<span class="token comment">/* 更新窗口*/</span>
	<span class="token function">tcp_recved</span><span class="token punctuation">(</span>tpcb<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>tot_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* 返回接收到的数据*/</span>  
  <span class="token function">tcp_write</span><span class="token punctuation">(</span>tpcb<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>payload<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>tot_len<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
  <span class="token function">memset</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>payload<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>tot_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">pbuf_free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
  <span class="token punctuation">}</span> 
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> ERR_OK<span class="token punctuation">)</span> 
  <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">tcp_close</span><span class="token punctuation">(</span>tpcb<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> ERR_OK<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token class-name">err_t</span> <span class="token function">tcpecho_accept</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">tcp_pcb</span> <span class="token operator">*</span>newpcb<span class="token punctuation">,</span> <span class="token class-name">err_t</span> err<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>     

  <span class="token function">tcp_recv</span><span class="token punctuation">(</span>newpcb<span class="token punctuation">,</span> tcpecho_recv<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> ERR_OK<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">TCP_Echo_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">struct</span> <span class="token class-name">tcp_pcb</span> <span class="token operator">*</span>pcb <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>	            		
  
  <span class="token comment">/* 创建一个TCP控制块  */</span>
  pcb <span class="token operator">=</span> <span class="token function">tcp_new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	  
  
  <span class="token comment">/* 绑定TCP控制块 */</span>
  <span class="token function">tcp_bind</span><span class="token punctuation">(</span>pcb<span class="token punctuation">,</span> IP_ADDR_ANY<span class="token punctuation">,</span> TCP_ECHO_PORT<span class="token punctuation">)</span><span class="token punctuation">;</span>       


  <span class="token comment">/* 进入监听状态 */</span>
  pcb <span class="token operator">=</span> <span class="token function">tcp_listen</span><span class="token punctuation">(</span>pcb<span class="token punctuation">)</span><span class="token punctuation">;</span>				

  <span class="token comment">/* 处理连接 */</span>	
  <span class="token function">tcp_accept</span><span class="token punctuation">(</span>pcb<span class="token punctuation">,</span> tcpecho_accept<span class="token punctuation">)</span><span class="token punctuation">;</span>   
<span class="token punctuation">}</span>

</code></pre> 
<p>这样裸机就成功了，可以ping成功<br> <img src="https://images2.imgbox.com/74/a3/JWeCjowh_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/da/76/1HoJWEBZ_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="CubeMXLWIPfreeRTOS_96"></a>CubeMX配置以太网以及LWIP实现一个回环功能（freeRTOS）</h2> 
<p>在CubeMX中打开freeRTOS后，lwip会自动切换到带有os的模式，其他的和裸机一样。不懂如何移植freeRTOS的去看我上一篇文章。<br> <img src="https://images2.imgbox.com/da/b4/o2dyaYSa_o.png" alt="在这里插入图片描述"><br> 生成代码，可以看到LWIP初始化函数以及被加入默认线程中了。<br> <img src="https://images2.imgbox.com/0f/e7/GHBwApRh_o.png" alt="在这里插入图片描述"><br> 搭载freeRTOS后就可以使用我们最熟悉的socket编程了，这时tcpecho.c可以写成，这个代码，使用过socket编程的人应该就很熟悉了，实验效果和裸机一样。<strong>推荐使用带操作系统的框架进行网络编程。</strong></p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"tcpecho.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"lwip/opt.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_SOCKET</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;lwip/sockets.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"lwip/sys.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"lwip/api.h"</span></span>
<span class="token comment">/*-----------------------------------------------------------------------------------*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RECV_DATA</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span></span></span>


<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">tcpecho_thread</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">int</span> sock <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>connected<span class="token punctuation">;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>recv_data<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> server_addr<span class="token punctuation">,</span>client_addr<span class="token punctuation">;</span>
  <span class="token class-name">socklen_t</span> sin_size<span class="token punctuation">;</span>
  <span class="token keyword">int</span> recv_data_len<span class="token punctuation">;</span>
  
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"本地端口号是%d\n\n"</span><span class="token punctuation">,</span>LOCAL_PORT<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  recv_data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">pvPortMalloc</span><span class="token punctuation">(</span>RECV_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>recv_data <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"No memory\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">goto</span> __exit<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  sock <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>sock <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Socket error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">goto</span> __exit<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  server_addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
  server_addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> INADDR_ANY<span class="token punctuation">;</span>
  server_addr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>LOCAL_PORT<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>server_addr<span class="token punctuation">.</span>sin_zero<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>server_addr<span class="token punctuation">.</span>sin_zero<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>server_addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Unable to bind\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">goto</span> __exit<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">listen</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Listen error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">goto</span> __exit<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    sin_size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    connected <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>client_addr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sin_size<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"new client connected from (%s, %d)\n"</span><span class="token punctuation">,</span>
            <span class="token function">inet_ntoa</span><span class="token punctuation">(</span>client_addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>client_addr<span class="token punctuation">.</span>sin_port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">int</span> flag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
      
      <span class="token function">setsockopt</span><span class="token punctuation">(</span>connected<span class="token punctuation">,</span>
                 IPPROTO_TCP<span class="token punctuation">,</span>     <span class="token comment">/* set option at TCP level */</span>
                 TCP_NODELAY<span class="token punctuation">,</span>     <span class="token comment">/* name of option */</span>
                 <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>flag<span class="token punctuation">,</span>  <span class="token comment">/* the cast is historical cruft */</span>
                 <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/* length of option value */</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      recv_data_len <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>connected<span class="token punctuation">,</span> recv_data<span class="token punctuation">,</span> RECV_DATA<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token keyword">if</span> <span class="token punctuation">(</span>recv_data_len <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> 
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recv %d len data\n"</span><span class="token punctuation">,</span>recv_data_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token function">write</span><span class="token punctuation">(</span>connected<span class="token punctuation">,</span>recv_data<span class="token punctuation">,</span>recv_data_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
      
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>connected <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> 
      <span class="token function">closesocket</span><span class="token punctuation">(</span>connected<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    connected <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
__exit<span class="token operator">:</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>sock <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">closesocket</span><span class="token punctuation">(</span>sock<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>recv_data<span class="token punctuation">)</span> <span class="token function">free</span><span class="token punctuation">(</span>recv_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*-----------------------------------------------------------------------------------*/</span>
<span class="token keyword">void</span> <span class="token function">tcpecho_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token function">sys_thread_new</span><span class="token punctuation">(</span><span class="token string">"tcpecho_thread"</span><span class="token punctuation">,</span> tcpecho_thread<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="_204"></a>结论</h2> 
<p>还是那个观点，在进行stm32开发的时候cubemx可以省去大量的库移植的操作，可以大幅缩减开发周期，把时间更集中在任务上，在这篇文章中，本文分别在裸机以及带有freeRTOS的情况下实现了TCP连接，并简单做了回环，推荐使用操作系统进行网络开发，因为可以用socket编程，方便在Linux等系统上进行使用。<br> 在下一篇文章中，我将实现一个httpd服务器，可以用浏览器直接访问。</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d945f35aa47efca71cc14ee80026dd34/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Ubuntu18.04 离线安装 Docker</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8830b6f65318eeb780146bbc072d00e7/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">（pytorch）如何用yolov3训练自己的数据集（亲测有效）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>