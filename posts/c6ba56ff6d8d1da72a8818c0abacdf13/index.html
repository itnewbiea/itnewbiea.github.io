<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>X86汇编调试环境搭建 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="X86汇编调试环境搭建" />
<meta property="og:description" content="最近毕设需要做一个基于X86的微型OS内核，一直在学习汇编，前来记录一下
汇编环境搭建 本次使用vscode搭建的，需要的插件有X86 and X86_64 Assembly（也可以使用masm插件）,还有一个hexdump for VSCode。
安装NASM，并添加到环境变量
安装QEMU,并将其添加到环境变量下
编写代码：（代码来自30天自制操作系统）
; hello-os ; TAB=4 ; 标准FAT12格式软盘专用的代码 Stand FAT12 format floppy code DB 0xeb, 0x4e, 0x90 DB &#34;HELLOIPL&#34; ; 启动扇区名称（8字节） DW 512 ; 每个扇区（sector）大小（必须512字节） DB 1 ; 簇（cluster）大小（必须为1个扇区） DW 1 ; FAT起始位置（一般为第一个扇区） DB 2 ; FAT个数（必须为2） DW 224 ; 根目录大小（一般为224项） DW 2880 ; 该磁盘大小（必须为2880扇区1440*1024/512） DB 0xf0 ; 磁盘类型（必须为0xf0） DW 9 ; FAT的长度（必须是9扇区） DW 18 ; 一个磁道（track）有几个扇区（必须为18） DW 2 ; 磁头数（必须是2） DD 0 ; 不使用分区，必须是0 DD 2880 ; 重写一次磁盘大小 ; 书中作者说原因不明的两行代码我查到了，see https://www." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/c6ba56ff6d8d1da72a8818c0abacdf13/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-11-09T22:13:19+08:00" />
<meta property="article:modified_time" content="2021-11-09T22:13:19+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">X86汇编调试环境搭建</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>最近毕设需要做一个基于X86的微型OS内核，一直在学习汇编，前来记录一下</p> 
<h2><a id="_2"></a>汇编环境搭建</h2> 
<p>本次使用vscode搭建的，需要的插件有X86 and X86_64 Assembly（也可以使用masm插件）,还有一个hexdump for VSCode。<br> 安装<a href="https://www.nasm.us/pub/nasm/releasebuilds/" rel="nofollow">NASM</a>，并添加到环境变量<br> 安装<a href="https://www.qemu.org/download/" rel="nofollow">QEMU</a>,并将其添加到环境变量下</p> 
<p>编写代码：（代码来自30天自制操作系统）</p> 
<pre><code class="prism language-bash"><span class="token punctuation">;</span> hello-os
<span class="token punctuation">;</span> <span class="token assign-left variable">TAB</span><span class="token operator">=</span><span class="token number">4</span>

<span class="token punctuation">;</span> 标准FAT12格式软盘专用的代码 Stand FAT12 <span class="token function">format</span> floppy code

        DB      0xeb, 0x4e, 0x90
        DB      <span class="token string">"HELLOIPL"</span>      <span class="token punctuation">;</span> 启动扇区名称（8字节）
        DW      <span class="token number">512</span>             <span class="token punctuation">;</span> 每个扇区（sector）大小（必须512字节）
        DB      <span class="token number">1</span>               <span class="token punctuation">;</span> 簇（cluster）大小（必须为1个扇区）
        DW      <span class="token number">1</span>               <span class="token punctuation">;</span> FAT起始位置（一般为第一个扇区）
        DB      <span class="token number">2</span>               <span class="token punctuation">;</span> FAT个数（必须为2）
        DW      <span class="token number">224</span>             <span class="token punctuation">;</span> 根目录大小（一般为224项）
        DW      <span class="token number">2880</span>            <span class="token punctuation">;</span> 该磁盘大小（必须为2880扇区1440*1024/512）
        DB      0xf0            <span class="token punctuation">;</span> 磁盘类型（必须为0xf0）
        DW      <span class="token number">9</span>               <span class="token punctuation">;</span> FAT的长度（必须是9扇区）
        DW      <span class="token number">18</span>              <span class="token punctuation">;</span> 一个磁道（track）有几个扇区（必须为18）
        DW      <span class="token number">2</span>               <span class="token punctuation">;</span> 磁头数（必须是2）
        DD      <span class="token number">0</span>               <span class="token punctuation">;</span> 不使用分区，必须是0
        DD      <span class="token number">2880</span>            <span class="token punctuation">;</span> 重写一次磁盘大小

        <span class="token punctuation">;</span> 书中作者说原因不明的两行代码我查到了，see https://www.ntfs.com/fat-partition-sector.htm
        DB      <span class="token number">0</span>               <span class="token punctuation">;</span> BPB_Physical_Disk_Number    DB   <span class="token punctuation">(</span>This is related to the BIOS physical disk number. Floppy drives are numbered starting with 0x00 <span class="token keyword">for</span> the A disk. Physical hard disks are numbered starting with 0x80. The value is typically 0x80 <span class="token keyword">for</span> hard disks, regardless of how many physical disk drives exist, because the value is only relevant <span class="token keyword">if</span> the device is the startup disk.<span class="token punctuation">)</span>
        DB      <span class="token number">0</span>               <span class="token punctuation">;</span> BPB_Current_Head            DB   <span class="token punctuation">(</span>Not used by FAT <span class="token function">file</span> system<span class="token punctuation">)</span>
        DB      0x29            <span class="token punctuation">;</span> BPB_Signature               DB   <span class="token punctuation">(</span>Must be either 0x28 or 0x29 <span class="token keyword">in</span> order to be recognized by Windows NT.<span class="token punctuation">)</span>
        DD      0xffffffff      <span class="token punctuation">;</span> BPB_Volume_Serial_Number    DD



        DB      <span class="token string">"HELLO-OS   "</span>   <span class="token punctuation">;</span> 磁盘的名称（必须为11字节，不足填空格）
        DB      <span class="token string">"FAT12   "</span>      <span class="token punctuation">;</span> 磁盘格式名称（必须是8字节，不足填空格）
        TIMES   <span class="token number">18</span>  DB <span class="token number">0</span>        <span class="token punctuation">;</span> 先空出18字节

<span class="token punctuation">;</span> 程序主体

        DB      0xb8, 0x00, 0x00, 0x8e, 0xd0, 0xbc, 0x00, 0x7c
        DB      0x8e, 0xd8, 0x8e, 0xc0, 0xbe, 0x74, 0x7c, 0x8a
        DB      0x04, 0x83, 0xc6, 0x01, 0x3c, 0x00, 0x74, 0x09
        DB      0xb4, 0x0e, 0xbb, 0x0f, 0x00, 0xcd, 0x10, 0xeb
        DB      0xee, 0xf4, 0xeb, 0xfd

<span class="token punctuation">;</span> 信息显示部分

        DB      0x0a, 0x0a      <span class="token punctuation">;</span> 换行两次
        DB      <span class="token string">"hello, world"</span>
        DB      0x0a         <span class="token punctuation">;</span> 换行
        DB      <span class="token number">0</span>

        TIMES   0x1fe-<span class="token punctuation">(</span>$-<span class="token variable">$$</span><span class="token punctuation">)</span> DB 0x00         <span class="token punctuation">;</span> 填写0x00直到0x001fe

        DB      0x55, 0xaa

<span class="token punctuation">;</span> 启动扇区以外部分输出

        DB      0xf0, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00
        TIMES   <span class="token number">4600</span>    DB <span class="token number">0</span>
        DB      0xf0, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00
        TIMES   <span class="token number">1469432</span> DB <span class="token number">0</span>
<span class="token punctuation">;</span> 只是把 RESB <span class="token number">20</span> 改成了 TIMES <span class="token number">20</span> DB <span class="token number">0</span>

</code></pre> 
<p>编译命令<br> vscode写好后直接终端运行</p> 
<pre><code class="prism language-bash">nasm -f bin day1.asm -o day1.img
</code></pre> 
<p>-f指定输出格式为bin，本次生成的是img文件，因为后续调试要用，当然也可以生成其他类型文件</p> 
<p>运行命令</p> 
<pre><code class="prism language-bash">qemu-system-i386 day1.img
</code></pre> 
<p>运行结果：<br> <img src="https://images2.imgbox.com/b2/50/BuVg21FJ_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_84"></a>调试环境搭建</h2> 
<p>调试汇编我们一般用bochs软件调试<br> <a href="https://bochs.sourceforge.io/" rel="nofollow">下载链接</a></p> 
<p>进入安装目录找到一个叫bochsdbg。exe的程序，我们调试主要用到这个程序<br> 打开即可看到如下界面<br> <img src="https://images2.imgbox.com/28/8d/BZm167dN_o.png" alt="在这里插入图片描述"><br> 在白色<em>menu</em>框中点击<em>Disk &amp; Boot</em>选项，选择<em>ATA channel 0</em>下的<em>First HD/CD on channel</em><br> <img src="https://images2.imgbox.com/09/bd/YTfra8mo_o.png" alt="在这里插入图片描述"><br> 修改如下参数<br> <img src="https://images2.imgbox.com/d3/15/nYvQnY6Z_o.png" alt="在这里插入图片描述"><br> 第一个指定为磁盘<br> 第二个指定img文件路径<br> Heads：磁头数<br> Sectors per track :每磁道有几个扇区<br> 这些参数其实是由上文的程序指定的程序指定的</p> 
<pre><code class="prism language-bash">DW      <span class="token number">18</span>              <span class="token punctuation">;</span> 一个磁道（track）有几个扇区（必须为18）
DW      <span class="token number">2</span>               <span class="token punctuation">;</span> 磁头数（必须是2）
</code></pre> 
<p>之后点击Boot Options中的boot drive设置为disk即可<br> <img src="https://images2.imgbox.com/6d/cd/e0YmKn1h_o.png" alt="在这里插入图片描述"><br> 点击ok后会退到Bochs start menu菜单， 点击start即可启动调试<br> 这里展示了一下<br> <img src="https://images2.imgbox.com/98/df/OwSjkCpY_o.png" alt="在这里插入图片描述"><br> 注意最下面的s 其实就是单步调试的意思，还有注意的是展示的一行汇编代码实际是未运行的，是下次运行的，比如这里的</p> 
<pre><code class="prism language-bash">jmpf 0xf000:e05b
</code></pre> 
<p>实际未运行，需要输入s才能运行这一步</p> 
<p>如果想要跳转个某个地址呢 比如0x7c00，该怎么办呢？<br> 输入 b 0x7c00 b就是打断点 运行一下<br> 再输入c就是continue继续的意思即可跳转到这<br> 想要退出的话需要输入2次q即可<br> 后续有什么命令在继续补充吧</p> 
<p>需要注意的是汇编代码必须加前面那个fat代码，不然bochs无法调试，还有另一种方法是用FixVhdw，这个方法可以去参考B站UP谭玉刚的视频。这个软件是X86汇编 从实模式到保护模式的作者写的。</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e206e1c2c320e9d9245d96bde7a4a64b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Python读取json文件</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7ed3599cf5b29c55784d899f1bd1e7ab/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">LDR2001电脑免驱USB转串口芯片方案</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>