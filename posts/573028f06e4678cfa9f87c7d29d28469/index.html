<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>GAMES101：作业5记录 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="GAMES101：作业5记录" />
<meta property="og:description" content="总览 在这部分的课程中,我们将专注于使用光线追踪来渲染图像。在光线追踪中最重要的操作之一就是找到光线与物体的交点。一旦找到光线与物体的交点,就可以执行着色并返回像素颜色。在这次作业中,我们需要实现两个部分:光线的生成和光线与三角的相交。本次代码框架的工作流程为:
从 main 函数开始。我们定义场景的参数,添加物体(球体或三角形)到场景中,并设置其材质,然后将光源添加到场景中。
调用 Render(scene) 函数。在遍历所有像素的循环里,生成对应的光线并将返回的颜色保存在帧缓冲区(framebuffer)中。在渲染过程结束后,帧缓冲区中的信息将被保存为图像。
在生成像素对应的光线后,我们调用 CastRay 函数,该函数调用 trace 来查询光线与场景中最近的对象的交点。
然后,我们在此交点执行着色。我们设置了三种不同的着色情况,并且已经为你提供了代码。
你需要修改的函数是:
• Renderer.cpp 中的 Render():这里你需要为每个像素生成一条对应的光线,然后调用函数 castRay() 来得到颜色,最后将颜色存储在帧缓冲区的相应像素中。
• Triangle.hpp 中的 rayTriangleIntersect(): v0, v1, v2 是三角形的三个顶点,orig 是光线的起点,dir 是光线单位化的方向向量。tnear, u, v 是你需要使用我们课上推导的 Moller-Trumbore 算法来更新的参数。
实现 Renderer.cpp-&gt;Render()的实现 建议先把这个文章看一下：
Ray-Tracing: Generating Camera Rays
在作业3里我们的坐标变换是正向的，从世界坐标到相机坐标到NDC坐标到渲染的像素坐标，而在光线追踪里我们要把光线从相机原点发射光线到屏幕上的每一个像素（知道的是像素坐标），我们需要做逆向的操作从渲染的像素坐标（注意左上角为原点）到NDC坐标到世界坐标，因为我们计算交点比较深度都是在世界坐标系里计算的。
渲染像素坐标-&gt;NDC坐标（[0,1]的正方形）
NDC坐标-&gt;屏幕像素坐标（[-1,1]的正方形【原点在左下角】） 因为原点在左上角，所以第二个式子需要乘一个负号：
我们的渲染图像的纵横比不一定是1，考虑到这一点我们需要对公式进行校正（这样使得每个分隔的方格都是正方形）
屏幕像素坐标-&gt;相机坐标
这里第二行和第三行右边应该是 P i x e l N D C x PixelNDC_x PixelNDCx​和 P i x e l N D C y PixelNDC_y PixelNDCy​" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/573028f06e4678cfa9f87c7d29d28469/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-05T09:40:55+08:00" />
<meta property="article:modified_time" content="2024-01-05T09:40:55+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">GAMES101：作业5记录</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-github-gist">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>总览</h2> 
<p>在这部分的课程中,我们将专注于使用光线追踪来渲染图像。在光线追踪中最重要的操作之一就是找到光线与物体的交点。一旦找到光线与物体的交点,就可以执行着色并返回像素颜色。在这次作业中,我们需要实现两个部分:光线的生成和光线与三角的相交。本次代码框架的工作流程为:</p> 
<ol><li> <p>从 <code>main</code> 函数开始。我们定义场景的参数,添加物体(球体或三角形)到场景中,并设置其材质,然后将光源添加到场景中。</p> </li><li> <p>调用 <code>Render(scene)</code> 函数。在遍历所有像素的循环里,生成对应的光线并将返回的颜色保存在帧缓冲区(framebuffer)中。在渲染过程结束后,帧缓冲区中的信息将被保存为图像。</p> </li><li> <p>在生成像素对应的光线后,我们调用 <code>CastRay</code> 函数,该函数调用 <code>trace</code> 来查询光线与场景中最近的对象的交点。</p> </li><li> <p>然后,我们在此交点执行着色。我们设置了三种不同的着色情况,并且已经为你提供了代码。</p> </li></ol> 
<p>你需要修改的函数是:<br> • <code>Renderer.cpp</code> 中的 <code>Render()</code>:这里你需要为每个像素生成一条对应的光线,然后调用函数 castRay() 来得到颜色,最后将颜色存储在帧缓冲区的相应像素中。</p> 
<p>• <code>Triangle.hpp</code> 中的 <code>rayTriangleIntersect()</code>: v0, v1, v2 是三角形的三个顶点,orig 是光线的起点,dir 是光线单位化的方向向量。tnear, u, v 是你需要使用我们课上推导的 Moller-Trumbore 算法来更新的参数。</p> 
<p><img src="https://images2.imgbox.com/14/68/gcYhZkPq_o.png" alt=""></p> 
<h2><a id="_19"></a>实现</h2> 
<h3><a id="RenderercppRender_20"></a>Renderer.cpp-&gt;Render()的实现</h3> 
<p>建议先把这个文章看一下：</p> 
<p><a href="https://www.scratchapixel.com/lessons/3d-basic-rendering/ray-tracing-generating-camera-rays/generating-camera-rays.html" rel="nofollow">Ray-Tracing: Generating Camera Rays</a></p> 
<p>在作业3里我们的坐标变换是正向的，从世界坐标到相机坐标到NDC坐标到渲染的像素坐标，而在光线追踪里我们要把光线从相机原点发射光线到屏幕上的每一个像素（知道的是像素坐标），我们需要做逆向的操作从渲染的像素坐标（注意左上角为原点）到NDC坐标到世界坐标，因为我们计算交点比较深度都是在世界坐标系里计算的。</p> 
<p><img src="https://images2.imgbox.com/c7/73/fDaokYaA_o.png" alt="在这里插入图片描述"></p> 
<ul><li><strong>渲染像素坐标-&gt;NDC坐标</strong>（[0,1]的正方形）<br> <img src="https://images2.imgbox.com/37/bb/4rtGkpZ9_o.png" alt="在这里插入图片描述"></li><li><strong>NDC坐标-&gt;屏幕像素坐标</strong>（[-1,1]的正方形【原点在左下角】）</li></ul> 
<p><img src="https://images2.imgbox.com/8f/d3/7RzEW8sD_o.png" alt="在这里插入图片描述"><br> 因为原点在左上角，所以第二个式子需要乘一个负号：</p> 
<p><img src="https://images2.imgbox.com/e7/a0/yBbTyOGc_o.png" alt="在这里插入图片描述"></p> 
<p>我们的渲染图像的纵横比不一定是1，考虑到这一点我们需要对公式进行校正（这样使得每个分隔的方格都是正方形）</p> 
<p><img src="https://images2.imgbox.com/f6/e1/JmRmfXUS_o.png" alt="在这里插入图片描述"></p> 
<ul><li><strong>屏幕像素坐标-&gt;相机坐标</strong><br> 这里第二行和第三行右边应该是<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          P 
         
        
          i 
         
        
          x 
         
        
          e 
         
        
          l 
         
        
          N 
         
        
          D 
         
         
         
           C 
          
         
           x 
          
         
        
       
         PixelNDC_x 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8444em; vertical-align: -0.15em;"></span><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mord mathnormal">i</span><span class="mord mathnormal">x</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right: 0.109em;">lN</span><span class="mord mathnormal" style="margin-right: 0.0278em;">D</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0715em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span class="" style="top: -2.55em; margin-left: -0.0715em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>和<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          P 
         
        
          i 
         
        
          x 
         
        
          e 
         
        
          l 
         
        
          N 
         
        
          D 
         
         
         
           C 
          
         
           y 
          
         
        
       
         PixelNDC_y 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.9805em; vertical-align: -0.2861em;"></span><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mord mathnormal">i</span><span class="mord mathnormal">x</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right: 0.109em;">lN</span><span class="mord mathnormal" style="margin-right: 0.0278em;">D</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0715em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span class="" style="top: -2.55em; margin-left: -0.0715em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0359em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span class=""></span></span></span></span></span></span></span></span></span></span><br> <img src="https://images2.imgbox.com/04/a1/68SvO8Q8_o.png" alt="在这里插入图片描述"><br> 我们把相机放在原点，相机朝z轴负向看物体，然后渲染图像的平面(z=n)离原点的距离是1：</li></ul> 
<p><img src="https://images2.imgbox.com/1a/68/M6SkIv4a_o.png" alt="在这里插入图片描述"><br> 由几何关系</p> 
<p><img src="https://images2.imgbox.com/3b/45/zNOsKdKn_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/f3/df/C5wbbJYH_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/93/82/4eXsv6Pb_o.png" alt="在这里插入图片描述"><br> 所以相机空间的位置为：</p> 
<p><img src="https://images2.imgbox.com/2a/de/2AKpDPnn_o.png" alt="在这里插入图片描述"><br> 这里相机坐标系是和世界坐标系是重合的，如果要再进一步到世界坐标系我们还需要进行一个矩阵的映射</p> 
<p><img src="https://images2.imgbox.com/f0/0d/wI7Y6rDS_o.png" alt="在这里插入图片描述"><br> 在本作业中，我们使用的公式整合一下即：</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          P 
         
        
          i 
         
        
          x 
         
        
          e 
         
        
          l 
         
        
          C 
         
        
          a 
         
        
          m 
         
        
          e 
         
        
          r 
         
         
         
           a 
          
         
           x 
          
         
        
          = 
         
         
         
           ( 
          
         
           2 
          
         
           ∗ 
          
          
           
           
             P 
            
           
             i 
            
           
             x 
            
           
             e 
            
            
            
              l 
             
            
              x 
             
            
           
             + 
            
           
             0.5 
            
           
           
           
             I 
            
           
             m 
            
           
             a 
            
           
             g 
            
           
             e 
            
           
             W 
            
           
             i 
            
           
             d 
            
           
             t 
            
           
             h 
            
           
          
         
           − 
          
         
           1 
          
         
           ) 
          
         
        
          ∗ 
         
        
          I 
         
        
          m 
         
        
          a 
         
        
          g 
         
        
          e 
         
        
          A 
         
        
          s 
         
        
          p 
         
        
          e 
         
        
          c 
         
        
          t 
         
        
          R 
         
        
          a 
         
        
          t 
         
        
          i 
         
        
          o 
         
        
          ∗ 
         
        
          t 
         
        
          a 
         
        
          n 
         
        
          ( 
         
        
          α 
         
        
          / 
         
        
          2 
         
        
          ) 
         
         
        
          P 
         
        
          I 
         
        
          x 
         
        
          e 
         
        
          l 
         
        
          C 
         
        
          a 
         
        
          m 
         
        
          e 
         
        
          r 
         
         
         
           a 
          
         
           y 
          
         
        
          = 
         
         
         
           ( 
          
         
           1 
          
         
           − 
          
         
           2 
          
         
           ∗ 
          
          
           
           
             P 
            
           
             i 
            
           
             x 
            
           
             e 
            
            
            
              l 
             
            
              y 
             
            
           
             + 
            
           
             0.5 
            
           
           
           
             I 
            
           
             m 
            
           
             a 
            
           
             g 
            
           
             e 
            
           
             H 
            
           
             e 
            
           
             i 
            
           
             g 
            
           
             h 
            
           
             t 
            
           
          
         
           ) 
          
         
        
          ∗ 
         
        
          t 
         
        
          a 
         
        
          n 
         
        
          ( 
         
        
          α 
         
        
          / 
         
        
          2 
         
        
          ) 
         
        
       
         PixelCamera_x = \left(2*\frac{Pixel_x + 0.5}{ImageWidth}-1\right)*ImageAspectRatio*tan(\alpha/2)\\ PIxelCamera_y = \left(1 - 2 * \frac{Pixel_y + 0.5}{ImageHeight}\right) * tan(\alpha/2) 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8444em; vertical-align: -0.15em;"></span><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mord mathnormal">i</span><span class="mord mathnormal">x</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right: 0.0715em;">lC</span><span class="mord mathnormal">am</span><span class="mord mathnormal" style="margin-right: 0.0278em;">er</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 2.4em; vertical-align: -0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;"><span class="delimsizing size3">(</span></span><span class="mord">2</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.3714em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0785em;">I</span><span class="mord mathnormal">ma</span><span class="mord mathnormal" style="margin-right: 0.0359em;">g</span><span class="mord mathnormal">e</span><span class="mord mathnormal">Wi</span><span class="mord mathnormal">d</span><span class="mord mathnormal">t</span><span class="mord mathnormal">h</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mord mathnormal">i</span><span class="mord mathnormal">x</span><span class="mord mathnormal">e</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span class="" style="top: -2.55em; margin-left: -0.0197em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">0.5</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.8804em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">1</span><span class="mclose delimcenter" style="top: 0em;"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;"></span><span class="mord mathnormal" style="margin-right: 0.0785em;">I</span><span class="mord mathnormal">ma</span><span class="mord mathnormal" style="margin-right: 0.0359em;">g</span><span class="mord mathnormal">e</span><span class="mord mathnormal">A</span><span class="mord mathnormal">s</span><span class="mord mathnormal">p</span><span class="mord mathnormal">ec</span><span class="mord mathnormal" style="margin-right: 0.0077em;">tR</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">an</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0037em;">α</span><span class="mord">/2</span><span class="mclose">)</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height: 0.9805em; vertical-align: -0.2861em;"></span><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mord mathnormal" style="margin-right: 0.0785em;">I</span><span class="mord mathnormal">x</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right: 0.0715em;">lC</span><span class="mord mathnormal">am</span><span class="mord mathnormal" style="margin-right: 0.0278em;">er</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0359em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 2.4em; vertical-align: -0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;"><span class="delimsizing size3">(</span></span><span class="mord">1</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">2</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.3714em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0785em;">I</span><span class="mord mathnormal">ma</span><span class="mord mathnormal" style="margin-right: 0.0359em;">g</span><span class="mord mathnormal">eHe</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right: 0.0359em;">g</span><span class="mord mathnormal">h</span><span class="mord mathnormal">t</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mord mathnormal">i</span><span class="mord mathnormal">x</span><span class="mord mathnormal">e</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span class="" style="top: -2.55em; margin-left: -0.0197em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0359em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">0.5</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.8804em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top: 0em;"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">an</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0037em;">α</span><span class="mord">/2</span><span class="mclose">)</span></span></span></span></span></span></p> 
<p>这样我们就可以写出我们的代码了，一个是修改x和y，一个是对dir使用normalize归一化：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">Renderer</span><span class="token double-colon punctuation">::</span><span class="token function">Render</span><span class="token punctuation">(</span><span class="token keyword">const</span> Scene<span class="token operator">&amp;</span> scene<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>Vector3f<span class="token operator">&gt;</span> <span class="token function">framebuffer</span><span class="token punctuation">(</span>scene<span class="token punctuation">.</span>width <span class="token operator">*</span> scene<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">float</span> scale <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">tan</span><span class="token punctuation">(</span><span class="token function">deg2rad</span><span class="token punctuation">(</span>scene<span class="token punctuation">.</span>fov <span class="token operator">*</span> <span class="token number">0.5f</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> imageAspectRatio <span class="token operator">=</span> scene<span class="token punctuation">.</span>width <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>scene<span class="token punctuation">.</span>height<span class="token punctuation">;</span>

    <span class="token comment">// Use this variable as the eye position to start your rays.</span>
    Vector3f <span class="token function">eye_pos</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> m <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> scene<span class="token punctuation">.</span>height<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> scene<span class="token punctuation">.</span>width<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// generate primary ray direction</span>
            <span class="token keyword">float</span> x <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>i <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token operator">/</span> scene<span class="token punctuation">.</span>width <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> scale <span class="token operator">*</span> imageAspectRatio<span class="token punctuation">;</span>
            <span class="token keyword">float</span> y <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>j <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token operator">/</span> scene<span class="token punctuation">.</span>height<span class="token punctuation">)</span> <span class="token operator">*</span> scale<span class="token punctuation">;</span>
            <span class="token comment">// TODO: Find the x and y positions of the current pixel to get the direction</span>
            <span class="token comment">// vector that passes through it.</span>
            <span class="token comment">// Also, don't forget to multiply both of them with the variable *scale*, and</span>
            <span class="token comment">// x (horizontal) variable with the *imageAspectRatio*            </span>
            
            Vector3f dir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">Vector3f</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Don't forget to normalize this direction!</span>
            framebuffer<span class="token punctuation">[</span>m<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">castRay</span><span class="token punctuation">(</span>eye_pos<span class="token punctuation">,</span> dir<span class="token punctuation">,</span> scene<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">UpdateProgress</span><span class="token punctuation">(</span>j <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>scene<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// save framebuffer to file</span>
    FILE<span class="token operator">*</span> fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"binary.ppm"</span><span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token function">fprintf</span><span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token string">"P6\n%d %d\n255\n"</span><span class="token punctuation">,</span> scene<span class="token punctuation">.</span>width<span class="token punctuation">,</span> scene<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> scene<span class="token punctuation">.</span>height <span class="token operator">*</span> scene<span class="token punctuation">.</span>width<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> color<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        color<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">255</span> <span class="token operator">*</span> <span class="token function">clamp</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> framebuffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        color<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">255</span> <span class="token operator">*</span> <span class="token function">clamp</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> framebuffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        color<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">255</span> <span class="token operator">*</span> <span class="token function">clamp</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> framebuffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">fwrite</span><span class="token punctuation">(</span>color<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>    
<span class="token punctuation">}</span>

</code></pre> 
<h3><a id="TrianglecpprayTriangleIntersect_114"></a>Triangle.cpp-&gt;rayTriangleIntersect()的实现</h3> 
<p>详细的推导可以看：<a href="https://www.scratchapixel.com/lessons/3d-basic-rendering/ray-tracing-rendering-a-triangle/moller-trumbore-ray-triangle-intersection.html" rel="nofollow">Möller-Trumbore algorithm</a></p> 
<p><img src="https://images2.imgbox.com/0b/ff/owmKM9iY_o.png" alt="在这里插入图片描述"><br> 按照公式写代码即可，这里使用了Vector.hpp的<code>dotProduct</code>和<code>crossProduct</code>函数，判断相交的条件是射线的t大于等于0且和三角形平面的三个重心插值坐标也都大于等于0：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">bool</span> <span class="token function">rayTriangleIntersect</span><span class="token punctuation">(</span><span class="token keyword">const</span> Vector3f<span class="token operator">&amp;</span> v0<span class="token punctuation">,</span> <span class="token keyword">const</span> Vector3f<span class="token operator">&amp;</span> v1<span class="token punctuation">,</span> <span class="token keyword">const</span> Vector3f<span class="token operator">&amp;</span> v2<span class="token punctuation">,</span> <span class="token keyword">const</span> Vector3f<span class="token operator">&amp;</span> orig<span class="token punctuation">,</span>
                          <span class="token keyword">const</span> Vector3f<span class="token operator">&amp;</span> dir<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">&amp;</span> tnear<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">&amp;</span> u<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">&amp;</span> v<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// TODO: Implement this function that tests whether the triangle</span>
    <span class="token comment">// that's specified bt v0, v1 and v2 intersects with the ray (whose</span>
    <span class="token comment">// origin is *orig* and direction is *dir*)</span>
    <span class="token comment">// Also don't forget to update tnear, u and v.</span>
    Vector3f E1 <span class="token operator">=</span> v1 <span class="token operator">-</span> v0<span class="token punctuation">;</span>
    Vector3f E2 <span class="token operator">=</span> v2 <span class="token operator">-</span> v0<span class="token punctuation">;</span>
    Vector3f S <span class="token operator">=</span> orig <span class="token operator">-</span> v0<span class="token punctuation">;</span>
    Vector3f S1 <span class="token operator">=</span> <span class="token function">crossProduct</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> E2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Vector3f S2 <span class="token operator">=</span> <span class="token function">crossProduct</span><span class="token punctuation">(</span>S<span class="token punctuation">,</span> E1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dotProduct</span><span class="token punctuation">(</span>S1<span class="token punctuation">,</span> E1<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    tnear <span class="token operator">=</span> <span class="token function">dotProduct</span><span class="token punctuation">(</span>S2<span class="token punctuation">,</span> E2<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">dotProduct</span><span class="token punctuation">(</span>S1<span class="token punctuation">,</span> E1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    u <span class="token operator">=</span> <span class="token function">dotProduct</span><span class="token punctuation">(</span>S1<span class="token punctuation">,</span> S<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">dotProduct</span><span class="token punctuation">(</span>S1<span class="token punctuation">,</span> E1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    v <span class="token operator">=</span> <span class="token function">dotProduct</span><span class="token punctuation">(</span>S2<span class="token punctuation">,</span> dir<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">dotProduct</span><span class="token punctuation">(</span>S1<span class="token punctuation">,</span> E1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tnear <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> u <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> v <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> u <span class="token operator">-</span> v<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>效果</p> 
<p><img src="https://images2.imgbox.com/1e/55/Ly9WQY06_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_149"></a>其他代码批注</h2> 
<h3><a id="RenderercppcastRay_151"></a>Renderer.cpp-&gt;castRay()</h3> 
<pre><code class="prism language-cpp">Vector3f <span class="token function">castRay</span><span class="token punctuation">(</span>
        <span class="token keyword">const</span> Vector3f <span class="token operator">&amp;</span>orig<span class="token punctuation">,</span> <span class="token keyword">const</span> Vector3f <span class="token operator">&amp;</span>dir<span class="token punctuation">,</span> <span class="token keyword">const</span> Scene<span class="token operator">&amp;</span> scene<span class="token punctuation">,</span>
        <span class="token keyword">int</span> depth<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>depth <span class="token operator">&gt;</span> scene<span class="token punctuation">.</span>maxDepth<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">Vector3f</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token comment">//深度大于最大深度，这里的maxDepth是5，返回黑色</span>

    Vector3f hitColor <span class="token operator">=</span> scene<span class="token punctuation">.</span>backgroundColor<span class="token punctuation">;</span><span class="token comment">//设置hitColor是背景色，这里是Vector3f(0.235294, 0.67451, 0.843137)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> payload <span class="token operator">=</span> <span class="token function">trace</span><span class="token punctuation">(</span>orig<span class="token punctuation">,</span> dir<span class="token punctuation">,</span> scene<span class="token punctuation">.</span><span class="token function">get_objects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> payload<span class="token punctuation">)</span><span class="token comment">//找到了和物体的交点</span>
    <span class="token punctuation">{<!-- --></span>
        Vector3f hitPoint <span class="token operator">=</span> orig <span class="token operator">+</span> dir <span class="token operator">*</span> payload<span class="token operator">-&gt;</span>tNear<span class="token punctuation">;</span><span class="token comment">//交点的位置</span>
        Vector3f N<span class="token punctuation">;</span> <span class="token comment">// normal</span>
        Vector2f st<span class="token punctuation">;</span> <span class="token comment">// st coordinates</span>
        payload<span class="token operator">-&gt;</span>hit_obj<span class="token operator">-&gt;</span><span class="token function">getSurfaceProperties</span><span class="token punctuation">(</span>hitPoint<span class="token punctuation">,</span> dir<span class="token punctuation">,</span> payload<span class="token operator">-&gt;</span>index<span class="token punctuation">,</span> payload<span class="token operator">-&gt;</span>uv<span class="token punctuation">,</span> N<span class="token punctuation">,</span> st<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//得到表面的信息</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>payload<span class="token operator">-&gt;</span>hit_obj<span class="token operator">-&gt;</span>materialType<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> REFLECTION_AND_REFRACTION<span class="token comment">//考虑反射和折射</span>
            <span class="token punctuation">{<!-- --></span>
                Vector3f reflectionDirection <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">reflect</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//反射方向</span>
                Vector3f refractionDirection <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">refract</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> N<span class="token punctuation">,</span> payload<span class="token operator">-&gt;</span>hit_obj<span class="token operator">-&gt;</span>ior<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//折射方向</span>
                <span class="token comment">//为避免浮点误差反射和折射的作用点是hitPoint加减一个小的epsilon，这里是0.00001</span>
                <span class="token comment">//反射光在物体内反射点移动到物体内，反之移动到物体外</span>
                Vector3f reflectionRayOrig <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">dotProduct</span><span class="token punctuation">(</span>reflectionDirection<span class="token punctuation">,</span> N<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span>
                                             hitPoint <span class="token operator">-</span> N <span class="token operator">*</span> scene<span class="token punctuation">.</span>epsilon <span class="token operator">:</span>
                                             hitPoint <span class="token operator">+</span> N <span class="token operator">*</span> scene<span class="token punctuation">.</span>epsilon<span class="token punctuation">;</span>
                <span class="token comment">//折射光在物体内折射点移动到物体内，反之移动到物体外</span>
                Vector3f refractionRayOrig <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">dotProduct</span><span class="token punctuation">(</span>refractionDirection<span class="token punctuation">,</span> N<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span>
                                             hitPoint <span class="token operator">-</span> N <span class="token operator">*</span> scene<span class="token punctuation">.</span>epsilon <span class="token operator">:</span>
                                             hitPoint <span class="token operator">+</span> N <span class="token operator">*</span> scene<span class="token punctuation">.</span>epsilon<span class="token punctuation">;</span>
                <span class="token comment">//递归找到反射的颜色</span>
                Vector3f reflectionColor <span class="token operator">=</span> <span class="token function">castRay</span><span class="token punctuation">(</span>reflectionRayOrig<span class="token punctuation">,</span> reflectionDirection<span class="token punctuation">,</span> scene<span class="token punctuation">,</span> depth <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//递归找到折射的颜色</span>
                Vector3f refractionColor <span class="token operator">=</span> <span class="token function">castRay</span><span class="token punctuation">(</span>refractionRayOrig<span class="token punctuation">,</span> refractionDirection<span class="token punctuation">,</span> scene<span class="token punctuation">,</span> depth <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//使用fresnel公式计算反射率</span>
                <span class="token keyword">float</span> kr <span class="token operator">=</span> <span class="token function">fresnel</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> N<span class="token punctuation">,</span> payload<span class="token operator">-&gt;</span>hit_obj<span class="token operator">-&gt;</span>ior<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//颜色是反射和折射的颜色的加权和</span>
                hitColor <span class="token operator">=</span> reflectionColor <span class="token operator">*</span> kr <span class="token operator">+</span> refractionColor <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> kr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">case</span> REFLECTION<span class="token operator">:</span><span class="token comment">//考虑反射，没有折射</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">float</span> kr <span class="token operator">=</span> <span class="token function">fresnel</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> N<span class="token punctuation">,</span> payload<span class="token operator">-&gt;</span>hit_obj<span class="token operator">-&gt;</span>ior<span class="token punctuation">)</span><span class="token punctuation">;</span>
                Vector3f reflectionDirection <span class="token operator">=</span> <span class="token function">reflect</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">;</span>
                Vector3f reflectionRayOrig <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">dotProduct</span><span class="token punctuation">(</span>reflectionDirection<span class="token punctuation">,</span> N<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span>
                                             hitPoint <span class="token operator">+</span> N <span class="token operator">*</span> scene<span class="token punctuation">.</span>epsilon <span class="token operator">:</span>
                                             hitPoint <span class="token operator">-</span> N <span class="token operator">*</span> scene<span class="token punctuation">.</span>epsilon<span class="token punctuation">;</span>
                hitColor <span class="token operator">=</span> <span class="token function">castRay</span><span class="token punctuation">(</span>reflectionRayOrig<span class="token punctuation">,</span> reflectionDirection<span class="token punctuation">,</span> scene<span class="token punctuation">,</span> depth <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> kr<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// [comment]</span>
                <span class="token comment">// We use the Phong illumation model int the default case. The phong model</span>
                <span class="token comment">// is composed of a diffuse and a specular reflection component.</span>
                <span class="token comment">// [/comment]</span>
                <span class="token comment">// 设置环境光和镜面反射光</span>
                Vector3f lightAmt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> specularColor <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token comment">//相机发出的dir作用线在物体外部，阴影的作用点移动到物体交点的外部，反之移动到内部</span>
                Vector3f shadowPointOrig <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">dotProduct</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> N<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span>
                                           hitPoint <span class="token operator">+</span> N <span class="token operator">*</span> scene<span class="token punctuation">.</span>epsilon <span class="token operator">:</span>
                                           hitPoint <span class="token operator">-</span> N <span class="token operator">*</span> scene<span class="token punctuation">.</span>epsilon<span class="token punctuation">;</span>
                <span class="token comment">// [comment]</span>
                <span class="token comment">// Loop over all lights in the scene and sum their contribution up</span>
                <span class="token comment">// We also apply the lambert cosine law</span>
                <span class="token comment">// [/comment]</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> light <span class="token operator">:</span> scene<span class="token punctuation">.</span><span class="token function">get_lights</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                	<span class="token comment">//从光源和物体的交点指向光源的矢量</span>
                    Vector3f lightDir <span class="token operator">=</span> light<span class="token operator">-&gt;</span>position <span class="token operator">-</span> hitPoint<span class="token punctuation">;</span>
                    <span class="token comment">// square of the distance between hitPoint and the light：光源和物体的交点指向光源的矢量的长度</span>
                    <span class="token keyword">float</span> lightDistance2 <span class="token operator">=</span> <span class="token function">dotProduct</span><span class="token punctuation">(</span>lightDir<span class="token punctuation">,</span> lightDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//归一化</span>
                    lightDir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>lightDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">float</span> LdotN <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0.f</span><span class="token punctuation">,</span> <span class="token function">dotProduct</span><span class="token punctuation">(</span>lightDir<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// is the point in shadow, and is the nearest occluding object closer to the object than the light itself?</span>
                    <span class="token comment">//判断光源和物体是否相交（是否有遮挡）</span>
                    <span class="token keyword">auto</span> shadow_res <span class="token operator">=</span> <span class="token function">trace</span><span class="token punctuation">(</span>shadowPointOrig<span class="token punctuation">,</span> lightDir<span class="token punctuation">,</span> scene<span class="token punctuation">.</span><span class="token function">get_objects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//有遮挡且【阴影点和遮挡物交点的距离（变化了一个小epsilon）】小于【光源和物体交点的距离（没有变化一个xnepsilon）】</span>
                    <span class="token keyword">bool</span> inShadow <span class="token operator">=</span> shadow_res <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>shadow_res<span class="token operator">-&gt;</span>tNear <span class="token operator">*</span> shadow_res<span class="token operator">-&gt;</span>tNear <span class="token operator">&lt;</span> lightDistance2<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token comment">// 如果没有阴影说明光打得到这个物体，加上散射光项（Phong模型），但是没有除距离的平方</span>
                    lightAmt <span class="token operator">+=</span> inShadow <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> light<span class="token operator">-&gt;</span>intensity <span class="token operator">*</span> LdotN<span class="token punctuation">;</span>
                    <span class="token comment">//计算反射方向</span>
                    Vector3f reflectionDirection <span class="token operator">=</span> <span class="token function">reflect</span><span class="token punctuation">(</span><span class="token operator">-</span>lightDir<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token comment">//计算镜面反射</span>
                    specularColor <span class="token operator">+=</span> <span class="token function">powf</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0.f</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token function">dotProduct</span><span class="token punctuation">(</span>reflectionDirection<span class="token punctuation">,</span> dir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        payload<span class="token operator">-&gt;</span>hit_obj<span class="token operator">-&gt;</span>specularExponent<span class="token punctuation">)</span> <span class="token operator">*</span> light<span class="token operator">-&gt;</span>intensity<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
				<span class="token comment">//最终的颜色好药乘系数，环境光要乘payload-&gt;hit_obj-&gt;evalDiffuseColor(st)为0.2</span>
                hitColor <span class="token operator">=</span> lightAmt <span class="token operator">*</span> payload<span class="token operator">-&gt;</span>hit_obj<span class="token operator">-&gt;</span><span class="token function">evalDiffuseColor</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span> <span class="token operator">*</span> payload<span class="token operator">-&gt;</span>hit_obj<span class="token operator">-&gt;</span>Kd <span class="token operator">+</span> specularColor <span class="token operator">*</span> payload<span class="token operator">-&gt;</span>hit_obj<span class="token operator">-&gt;</span>Ks<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> hitColor<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="Renderercppreflect__Renderercpprrefract_Renderercppfresnel_253"></a>Renderer.cpp-&gt;reflect(), Renderer.cpp-&gt;rrefract(), Renderer.cpp-&gt;fresnel()</h3> 
<p>这几个函数涉及光的折射和反射，推导见：</p> 
<p><a href="https://blog.csdn.net/qq_38065509/article/details/106299336?spm=1001.2014.3001.5502">计算机图形学十二：Whitted-Style光线追踪原理详解及实现细节-4 反射与折射</a><br> <img src="https://images2.imgbox.com/50/88/6wkUuh8N_o.png" alt="在这里插入图片描述"></p> 
<p>相关代码为：</p> 
<pre><code class="prism language-cpp"><span class="token comment">// Compute reflection direction</span>
Vector3f <span class="token function">reflect</span><span class="token punctuation">(</span><span class="token keyword">const</span> Vector3f <span class="token operator">&amp;</span>I<span class="token punctuation">,</span> <span class="token keyword">const</span> Vector3f <span class="token operator">&amp;</span>N<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> I <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token function">dotProduct</span><span class="token punctuation">(</span>I<span class="token punctuation">,</span> N<span class="token punctuation">)</span> <span class="token operator">*</span> N<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/cb/60/CPAQGQKV_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/af/46/sQhgd4LQ_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-cpp"><span class="token comment">// [comment]</span>
<span class="token comment">// Compute refraction direction using Snell's law</span>
<span class="token comment">//</span>
<span class="token comment">// We need to handle with care the two possible situations:</span>
<span class="token comment">//</span>
<span class="token comment">//    - When the ray is inside the object</span>
<span class="token comment">//</span>
<span class="token comment">//    - When the ray is outside.</span>
<span class="token comment">//</span>
<span class="token comment">// If the ray is outside, you need to make cosi positive cosi = -N.I</span>
<span class="token comment">//</span>
<span class="token comment">// If the ray is inside, you need to invert the refractive indices and negate the normal N</span>
<span class="token comment">// [/comment]</span>
Vector3f <span class="token function">refract</span><span class="token punctuation">(</span><span class="token keyword">const</span> Vector3f <span class="token operator">&amp;</span>I<span class="token punctuation">,</span> <span class="token keyword">const</span> Vector3f <span class="token operator">&amp;</span>N<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">float</span> <span class="token operator">&amp;</span>ior<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">float</span> cosi <span class="token operator">=</span> <span class="token function">clamp</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">dotProduct</span><span class="token punctuation">(</span>I<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> etai <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> etat <span class="token operator">=</span> ior<span class="token punctuation">;</span>
    Vector3f n <span class="token operator">=</span> N<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cosi <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> cosi <span class="token operator">=</span> <span class="token operator">-</span>cosi<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span> std<span class="token double-colon punctuation">::</span><span class="token function">swap</span><span class="token punctuation">(</span>etai<span class="token punctuation">,</span> etat<span class="token punctuation">)</span><span class="token punctuation">;</span> n<span class="token operator">=</span> <span class="token operator">-</span>N<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">float</span> eta <span class="token operator">=</span> etai <span class="token operator">/</span> etat<span class="token punctuation">;</span>
    <span class="token keyword">float</span> k <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> eta <span class="token operator">*</span> eta <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> cosi <span class="token operator">*</span> cosi<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> k <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> eta <span class="token operator">*</span> I <span class="token operator">+</span> <span class="token punctuation">(</span>eta <span class="token operator">*</span> cosi <span class="token operator">-</span> <span class="token function">sqrtf</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> n<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>fresnel公式计算反射率，</p> 
<p><img src="https://images2.imgbox.com/6d/ba/zg2vy1al_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-cpp"><span class="token comment">// [comment]</span>
<span class="token comment">// Compute Fresnel equation</span>
<span class="token comment">//</span>
<span class="token comment">// \param I is the incident view direction</span>
<span class="token comment">//</span>
<span class="token comment">// \param N is the normal at the intersection point</span>
<span class="token comment">//</span>
<span class="token comment">// \param ior is the material refractive index</span>
<span class="token comment">// [/comment]</span>
<span class="token keyword">float</span> <span class="token function">fresnel</span><span class="token punctuation">(</span><span class="token keyword">const</span> Vector3f <span class="token operator">&amp;</span>I<span class="token punctuation">,</span> <span class="token keyword">const</span> Vector3f <span class="token operator">&amp;</span>N<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">float</span> <span class="token operator">&amp;</span>ior<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">float</span> cosi <span class="token operator">=</span> <span class="token function">clamp</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">dotProduct</span><span class="token punctuation">(</span>I<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> etai <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> etat <span class="token operator">=</span> ior<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cosi <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  std<span class="token double-colon punctuation">::</span><span class="token function">swap</span><span class="token punctuation">(</span>etai<span class="token punctuation">,</span> etat<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token comment">// Compute sini using Snell's law</span>
    <span class="token keyword">float</span> sint <span class="token operator">=</span> etai <span class="token operator">/</span> etat <span class="token operator">*</span> <span class="token function">sqrtf</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0.f</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">-</span> cosi <span class="token operator">*</span> cosi<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Total internal reflection，全反射</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sint <span class="token operator">&gt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">float</span> cost <span class="token operator">=</span> <span class="token function">sqrtf</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0.f</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">-</span> sint <span class="token operator">*</span> sint<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cosi <span class="token operator">=</span> <span class="token function">fabsf</span><span class="token punctuation">(</span>cosi<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span> Rs <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>etat <span class="token operator">*</span> cosi<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>etai <span class="token operator">*</span> cost<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>etat <span class="token operator">*</span> cosi<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>etai <span class="token operator">*</span> cost<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span> Rp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>etai <span class="token operator">*</span> cosi<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>etat <span class="token operator">*</span> cost<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>etai <span class="token operator">*</span> cosi<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>etat <span class="token operator">*</span> cost<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>Rs <span class="token operator">*</span> Rs <span class="token operator">+</span> Rp <span class="token operator">*</span> Rp<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// As a consequence of the conservation of energy, transmittance is given by:</span>
    <span class="token comment">// kt = 1 - kr;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="Renderercpptrace_337"></a>Renderer.cpp-&gt;trace()</h3> 
<p>std::optional返回一个hit_payload类型，这里的初始化是空，如果找到最近的相交的物体则返回一个有效的hit_payload的值，关于std::optional详情见：<a href="https://blog.csdn.net/hhdshg/article/details/103433781">C++17之std::optional全方位详解</a></p> 
<pre><code class="prism language-cpp"><span class="token comment">// [comment]</span>
<span class="token comment">// Returns true if the ray intersects an object, false otherwise.</span>
<span class="token comment">//</span>
<span class="token comment">// \param orig is the ray origin</span>
<span class="token comment">// \param dir is the ray direction</span>
<span class="token comment">// \param objects is the list of objects the scene contains</span>
<span class="token comment">// \param[out] tNear contains the distance to the cloesest intersected object.</span>
<span class="token comment">// \param[out] index stores the index of the intersect triangle if the interesected object is a mesh.</span>
<span class="token comment">// \param[out] uv stores the u and v barycentric coordinates of the intersected point</span>
<span class="token comment">// \param[out] *hitObject stores the pointer to the intersected object (used to retrieve material information, etc.)</span>
<span class="token comment">// \param isShadowRay is it a shadow ray. We can return from the function sooner as soon as we have found a hit.</span>
<span class="token comment">// [/comment]</span>
std<span class="token double-colon punctuation">::</span>optional<span class="token operator">&lt;</span>hit_payload<span class="token operator">&gt;</span> <span class="token function">trace</span><span class="token punctuation">(</span>
        <span class="token keyword">const</span> Vector3f <span class="token operator">&amp;</span>orig<span class="token punctuation">,</span> <span class="token keyword">const</span> Vector3f <span class="token operator">&amp;</span>dir<span class="token punctuation">,</span>
        <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> <span class="token operator">&gt;</span> <span class="token operator">&amp;</span>objects<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">float</span> tNear <span class="token operator">=</span> kInfinity<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>optional<span class="token operator">&lt;</span>hit_payload<span class="token operator">&gt;</span> payload<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span> <span class="token operator">&amp;</span> object <span class="token operator">:</span> objects<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">float</span> tNearK <span class="token operator">=</span> kInfinity<span class="token punctuation">;</span>
        <span class="token keyword">uint32_t</span> indexK<span class="token punctuation">;</span>
        Vector2f uvK<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>object<span class="token operator">-&gt;</span><span class="token function">intersect</span><span class="token punctuation">(</span>orig<span class="token punctuation">,</span> dir<span class="token punctuation">,</span> tNearK<span class="token punctuation">,</span> indexK<span class="token punctuation">,</span> uvK<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> tNearK <span class="token operator">&lt;</span> tNear<span class="token punctuation">)</span><span class="token comment">//寻找最近的物体然后让返回值有效</span>
        <span class="token punctuation">{<!-- --></span>
            payload<span class="token punctuation">.</span><span class="token function">emplace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            payload<span class="token operator">-&gt;</span>hit_obj <span class="token operator">=</span> object<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            payload<span class="token operator">-&gt;</span>tNear <span class="token operator">=</span> tNearK<span class="token punctuation">;</span>
            payload<span class="token operator">-&gt;</span>index <span class="token operator">=</span> indexK<span class="token punctuation">;</span>
            payload<span class="token operator">-&gt;</span>uv <span class="token operator">=</span> uvK<span class="token punctuation">;</span>
            tNear <span class="token operator">=</span> tNearK<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> payload<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="Spherehppintersect_381"></a>Sphere.hpp-&gt;intersect()</h3> 
<p>判断是否和所有球相交</p> 
<pre><code class="prism language-cpp"><span class="token keyword">bool</span> <span class="token function">intersect</span><span class="token punctuation">(</span><span class="token keyword">const</span> Vector3f<span class="token operator">&amp;</span> orig<span class="token punctuation">,</span> <span class="token keyword">const</span> Vector3f<span class="token operator">&amp;</span> dir<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">&amp;</span> tnear<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span><span class="token operator">&amp;</span><span class="token punctuation">,</span> Vector2f<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">override</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// analytic solution</span>
        Vector3f L <span class="token operator">=</span> orig <span class="token operator">-</span> center<span class="token punctuation">;</span>
        <span class="token keyword">float</span> a <span class="token operator">=</span> <span class="token function">dotProduct</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span> b <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token function">dotProduct</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> L<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span> c <span class="token operator">=</span> <span class="token function">dotProduct</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> L<span class="token punctuation">)</span> <span class="token operator">-</span> radius2<span class="token punctuation">;</span>
        <span class="token keyword">float</span> t0<span class="token punctuation">,</span> t1<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">solveQuadratic</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> t0<span class="token punctuation">,</span> t1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//解一元二次方程</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>t0 <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            t0 <span class="token operator">=</span> t1<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>t0 <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        tnear <span class="token operator">=</span> t0<span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="Trianglehppintersect_405"></a>Triangle.hpp-&gt;intersect()</h3> 
<p>判断是否和所有三角形相交</p> 
<pre><code class="prism language-cpp"><span class="token keyword">bool</span> <span class="token function">intersect</span><span class="token punctuation">(</span><span class="token keyword">const</span> Vector3f<span class="token operator">&amp;</span> orig<span class="token punctuation">,</span> <span class="token keyword">const</span> Vector3f<span class="token operator">&amp;</span> dir<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">&amp;</span> tnear<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span><span class="token operator">&amp;</span> index<span class="token punctuation">,</span>
                   Vector2f<span class="token operator">&amp;</span> uv<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">override</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">bool</span> intersect <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">uint32_t</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> numTriangles<span class="token punctuation">;</span> <span class="token operator">++</span>k<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">const</span> Vector3f<span class="token operator">&amp;</span> v0 <span class="token operator">=</span> vertices<span class="token punctuation">[</span>vertexIndex<span class="token punctuation">[</span>k <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> Vector3f<span class="token operator">&amp;</span> v1 <span class="token operator">=</span> vertices<span class="token punctuation">[</span>vertexIndex<span class="token punctuation">[</span>k <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> Vector3f<span class="token operator">&amp;</span> v2 <span class="token operator">=</span> vertices<span class="token punctuation">[</span>vertexIndex<span class="token punctuation">[</span>k <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">float</span> t<span class="token punctuation">,</span> u<span class="token punctuation">,</span> v<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rayTriangleIntersect</span><span class="token punctuation">(</span>v0<span class="token punctuation">,</span> v1<span class="token punctuation">,</span> v2<span class="token punctuation">,</span> orig<span class="token punctuation">,</span> dir<span class="token punctuation">,</span> t<span class="token punctuation">,</span> u<span class="token punctuation">,</span> v<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> t <span class="token operator">&lt;</span> tnear<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                tnear <span class="token operator">=</span> t<span class="token punctuation">;</span>
                uv<span class="token punctuation">.</span>x <span class="token operator">=</span> u<span class="token punctuation">;</span>
                uv<span class="token punctuation">.</span>y <span class="token operator">=</span> v<span class="token punctuation">;</span>
                index <span class="token operator">=</span> k<span class="token punctuation">;</span>
                intersect <span class="token operator">|=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> intersect<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="SPherehppgetSurfaceProperties_434"></a>SPhere.hpp-&gt;getSurfaceProperties()</h3> 
<pre><code class="prism language-cpp">    <span class="token keyword">void</span> <span class="token function">getSurfaceProperties</span><span class="token punctuation">(</span><span class="token keyword">const</span> Vector3f<span class="token operator">&amp;</span> P<span class="token punctuation">,</span> <span class="token keyword">const</span> Vector3f<span class="token operator">&amp;</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">uint32_t</span><span class="token operator">&amp;</span><span class="token punctuation">,</span> <span class="token keyword">const</span> Vector2f<span class="token operator">&amp;</span><span class="token punctuation">,</span>
                              Vector3f<span class="token operator">&amp;</span> N<span class="token punctuation">,</span> Vector2f<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">override</span>
    <span class="token punctuation">{<!-- --></span>
        N <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>P <span class="token operator">-</span> center<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获得法线</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="TrianglehppgetSurfaceProperties_444"></a>Triangle.hpp-&gt;getSurfaceProperties()</h3> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">getSurfaceProperties</span><span class="token punctuation">(</span><span class="token keyword">const</span> Vector3f<span class="token operator">&amp;</span><span class="token punctuation">,</span> <span class="token keyword">const</span> Vector3f<span class="token operator">&amp;</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">uint32_t</span><span class="token operator">&amp;</span> index<span class="token punctuation">,</span> <span class="token keyword">const</span> Vector2f<span class="token operator">&amp;</span> uv<span class="token punctuation">,</span> Vector3f<span class="token operator">&amp;</span> N<span class="token punctuation">,</span>
                              Vector2f<span class="token operator">&amp;</span> st<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">override</span>
    <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">//获得三角形的顶点</span>
        <span class="token keyword">const</span> Vector3f<span class="token operator">&amp;</span> v0 <span class="token operator">=</span> vertices<span class="token punctuation">[</span>vertexIndex<span class="token punctuation">[</span>index <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> Vector3f<span class="token operator">&amp;</span> v1 <span class="token operator">=</span> vertices<span class="token punctuation">[</span>vertexIndex<span class="token punctuation">[</span>index <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> Vector3f<span class="token operator">&amp;</span> v2 <span class="token operator">=</span> vertices<span class="token punctuation">[</span>vertexIndex<span class="token punctuation">[</span>index <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">//三角形两条边的矢量</span>
        Vector3f e0 <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>v1 <span class="token operator">-</span> v0<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Vector3f e1 <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>v2 <span class="token operator">-</span> v1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//三角形平面的法矢量</span>
        N <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">crossProduct</span><span class="token punctuation">(</span>e0<span class="token punctuation">,</span> e1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//st坐标的插值</span>
        <span class="token keyword">const</span> Vector2f<span class="token operator">&amp;</span> st0 <span class="token operator">=</span> stCoordinates<span class="token punctuation">[</span>vertexIndex<span class="token punctuation">[</span>index <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> Vector2f<span class="token operator">&amp;</span> st1 <span class="token operator">=</span> stCoordinates<span class="token punctuation">[</span>vertexIndex<span class="token punctuation">[</span>index <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> Vector2f<span class="token operator">&amp;</span> st2 <span class="token operator">=</span> stCoordinates<span class="token punctuation">[</span>vertexIndex<span class="token punctuation">[</span>index <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        st <span class="token operator">=</span> st0 <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> uv<span class="token punctuation">.</span>x <span class="token operator">-</span> uv<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token operator">+</span> st1 <span class="token operator">*</span> uv<span class="token punctuation">.</span>x <span class="token operator">+</span> st2 <span class="token operator">*</span> uv<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/154ea86c0a140626391e3105055669cd/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【51单片机】LED灯的进阶操作（闪烁、流水）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2cdef8b7b84317222ead5c7119d91fbb/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">asp.net core使用gb2312编码</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>