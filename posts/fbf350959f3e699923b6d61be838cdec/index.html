<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>深度学习应用篇-计算机视觉-图像分类[3]：ResNeXt、Res2Net、Swin Transformer、Vision Transformer等模型结构、实现、模型特点详细介绍 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="深度学习应用篇-计算机视觉-图像分类[3]：ResNeXt、Res2Net、Swin Transformer、Vision Transformer等模型结构、实现、模型特点详细介绍" />
<meta property="og:description" content="&lt;link rel=&#34;stylesheet&#34; href=&#34;https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/kdoc_html_views-1a98987dfd.css&#34;&gt; &lt;link rel=&#34;stylesheet&#34; href=&#34;https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-25cebea3f9.css&#34;&gt; &lt;div id=&#34;content_views&#34; class=&#34;markdown_views prism-atom-one-dark&#34;&gt; &lt;svg xmlns=&#34;http://www.w3.org/2000/svg&#34; style=&#34;display: none;&#34;&gt; &lt;path stroke-linecap=&#34;round&#34; d=&#34;M5,0 0,2.5 5,5z&#34; id=&#34;raphael-marker-block&#34; style=&#34;-webkit-tap-highlight-color: rgba(0, 0, 0, 0);&#34;&gt;&lt;/path&gt; &lt;/svg&gt; &lt;p&gt;&lt;img src=&#34;https://img-blog.csdnimg.cn/63a67cd7f8504a1d8411cc2f4a233385.png#pic_center&#34; alt=&#34;在这里插入图片描述&#34;&gt;&lt;br&gt; &lt;strong&gt;【深度学习入门到进阶】必看系列，含激活函数、优化策略、损失函数、模型调优、归一化算法、卷积模型、序列模型、预训练模型、对抗神经网络等&lt;/strong&gt;&lt;/p&gt; 专栏详细介绍：【深度学习入门到进阶】必看系列，含激活函数、优化策略、损失函数、模型调优、归一化算法、卷积模型、序列模型、预训练模型、对抗神经网络等
本专栏主要方便入门同学快速掌握相关知识。后续会持续把深度学习涉及知识原理分析给大家，让大家在项目实操的同时也能知识储备，知其然、知其所以然、知何由以知其所以然。
声明：部分项目为网络经典项目方便大家快速学习，后续会不断增添实战环节（比赛、论文、现实应用等）
专栏订阅：
深度学习入门到进阶专栏深度学习应用项目实战篇 深度学习应用篇-计算机视觉-图像分类[3]：ResNeXt、Res2Net、Swin Transformer、Vision Transformer等模型结构、实现、模型特点详细介绍 1.ResNet 相较于VGG的19层和GoogLeNet的22层，ResNet可以提供18、34、50、101、152甚至更多层的网络，同时获得更好的精度。但是为什么要使用更深层次的网络呢？同时，如果只是网络层数的堆叠，那么为什么前人没有获得ResNet一样的成功呢？
1.1. 更深层次的网络？ 从理论上来讲，加深深度学习网络可以提升性能。深度网络以端到端的多层方式集成了低/中/高层特征和分类器，且特征的层次可通过加深网络层次的方式来丰富。举一个例子，当深度学习网络只有一层时，要学习的特征会非常复杂，但如果有多层，就可以分层进行学习，如 图1 所示，网络的第一层学习到了边缘和颜色，第二层学习到了纹理，第三层学习到了局部的形状，而第五层已逐渐学习到全局特征。网络的加深，理论上可以提供更好的表达能力，使每一层可以学习到更细化的特征。
1.2. 为什么深度网络不仅仅是层数的堆叠？ 1.2.1 梯度消失 or 爆炸 但网络加深真的只有堆叠层数这么简单么？当然不是！首先，最显著的问题就是梯度消失/梯度爆炸。我们都知道神经网络的参数更新依靠梯度反向传播（Back Propagation），那么为什么会出现梯度的消失和爆炸呢？举一个例子解释。如 图2 所示，假设每层只有一个神经元，且激活函数使用Sigmoid函数，则有：
z i &#43; 1 = w i a i &#43; b i a i &#43; 1 = σ ( z i &#43; 1 ) z_{i&#43;1} = w_ia_i&#43;b_i\\ a_{i&#43;1} = \sigma(z_{i&#43;1}) &lt;/span&gt;&lt;span class=&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/fbf350959f3e699923b6d61be838cdec/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-17T21:35:34+08:00" />
<meta property="article:modified_time" content="2023-07-17T21:35:34+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">深度学习应用篇-计算机视觉-图像分类[3]：ResNeXt、Res2Net、Swin Transformer、Vision Transformer等模型结构、实现、模型特点详细介绍</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <pre><code>    &lt;link rel="stylesheet" href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/kdoc_html_views-1a98987dfd.css"&gt;
    &lt;link rel="stylesheet" href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-25cebea3f9.css"&gt;
            &lt;div id="content_views" class="markdown_views prism-atom-one-dark"&gt;
                &lt;svg xmlns="http://www.w3.org/2000/svg" style="display: none;"&gt;
                    &lt;path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"&gt;&lt;/path&gt;
                &lt;/svg&gt;
                &lt;p&gt;&lt;img src="https://img-blog.csdnimg.cn/63a67cd7f8504a1d8411cc2f4a233385.png#pic_center" alt="在这里插入图片描述"&gt;&lt;br&gt; &lt;strong&gt;【深度学习入门到进阶】必看系列，含激活函数、优化策略、损失函数、模型调优、归一化算法、卷积模型、序列模型、预训练模型、对抗神经网络等&lt;/strong&gt;&lt;/p&gt; 
</code></pre> 
<p><img src="https://images2.imgbox.com/03/82/gu4ARApj_o.png" alt="在这里插入图片描述" width="400"><br> 专栏详细介绍：<a href="https://blog.csdn.net/sinat_39620217/article/details/130231648">【深度学习入门到进阶】必看系列，含激活函数、优化策略、损失函数、模型调优、归一化算法、卷积模型、序列模型、预训练模型、对抗神经网络等</a></p> 
<p><strong>本专栏主要方便入门同学快速掌握相关知识。后续会持续把深度学习涉及知识原理分析给大家，让大家在项目实操的同时也能知识储备，知其然、知其所以然、知何由以知其所以然。</strong></p> 
<p>声明：部分项目为网络经典项目方便大家快速学习，后续会不断增添实战环节（比赛、论文、现实应用等）</p> 
<p>专栏订阅：</p> 
<ul><li><a href="https://blog.csdn.net/sinat_39620217/category_12274202.html">深度学习入门到进阶专栏</a></li><li><a href="https://blog.csdn.net/sinat_39620217/category_11057499.html">深度学习应用项目实战篇</a></li></ul> 
<h2><a id="3ResNeXtRes2NetSwin_TransformerVision_Transformer_15"></a>深度学习应用篇-计算机视觉-图像分类[3]：ResNeXt、Res2Net、Swin Transformer、Vision Transformer等模型结构、实现、模型特点详细介绍</h2> 
<h2><a id="1ResNet_17"></a>1.ResNet</h2> 
<p>相较于VGG的19层和GoogLeNet的22层，ResNet可以提供18、34、50、101、152甚至更多层的网络，同时获得更好的精度。但是为什么要使用更深层次的网络呢？同时，如果只是网络层数的堆叠，那么为什么前人没有获得ResNet一样的成功呢？</p> 
<h3><a id="11__21"></a>1.1. 更深层次的网络？</h3> 
<p>从理论上来讲，加深深度学习网络可以提升性能。深度网络以端到端的多层方式集成了低/中/高层特征和分类器，且特征的层次可通过加深网络层次的方式来丰富。举一个例子，当深度学习网络只有一层时，要学习的特征会非常复杂，但如果有多层，就可以分层进行学习，如 <strong>图1</strong> 所示，网络的第一层学习到了边缘和颜色，第二层学习到了纹理，第三层学习到了局部的形状，而第五层已逐渐学习到全局特征。网络的加深，理论上可以提供更好的表达能力，使每一层可以学习到更细化的特征。</p> 
<p><img src="https://images2.imgbox.com/8d/93/BASgb43h_o.png" alt=""></p> 
<h3><a id="12__30"></a>1.2. 为什么深度网络不仅仅是层数的堆叠？</h3> 
<h4><a id="121__or__32"></a>1.2.1 梯度消失 or 爆炸</h4> 
<p>但网络加深真的只有堆叠层数这么简单么？当然不是！首先，最显著的问题就是梯度消失/梯度爆炸。我们都知道神经网络的参数更新依靠梯度反向传播（Back Propagation），那么为什么会出现梯度的消失和爆炸呢？举一个例子解释。如 <strong>图2</strong> 所示，假设每层只有一个神经元，且激活函数使用Sigmoid函数，则有：</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
        
       
     </span><span class="katex-html"></span></span></span></span></p> 
<pre><code>       z 
      
      
      
        i 
       
      
        + 
       
      
        1 
       
      
     
    
      = 
     
     
     
       w 
      
     
       i 
      
     
     
     
       a 
      
     
       i 
      
     
    
      + 
     
     
     
       b 
      
     
       i 
      
     
     
     
     
       a 
      
      
      
        i 
       
      
        + 
       
      
        1 
       
      
     
    
      = 
     
    
      σ 
     
    
      ( 
     
     
     
       z 
      
      
      
        i 
       
      
        + 
       
      
        1 
       
      
     
    
      ) 
     
    
   
     z_{i+1} = w_ia_i+b_i\\ a_{i+1} = \sigma(z_{i+1}) 
    
   
 &lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.6389em; vertical-align: -0.2083em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal" style="margin-right: 0.044em;"&gt;z&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t vlist-t2"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.3117em;"&gt;&lt;span class="" style="top: -2.55em; margin-left: -0.044em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;&lt;span class="mord mathnormal mtight"&gt;i&lt;/span&gt;&lt;span class="mbin mtight"&gt;+&lt;/span&gt;&lt;span class="mord mtight"&gt;1&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-s"&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.2083em;"&gt;&lt;span class=""&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2778em;"&gt;&lt;/span&gt;&lt;span class="mrel"&gt;=&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2778em;"&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.7333em; vertical-align: -0.15em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0269em;"&gt;w&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t vlist-t2"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.3117em;"&gt;&lt;span class="" style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mathnormal mtight"&gt;i&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-s"&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.15em;"&gt;&lt;span class=""&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal"&gt;a&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t vlist-t2"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.3117em;"&gt;&lt;span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mathnormal mtight"&gt;i&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-s"&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.15em;"&gt;&lt;span class=""&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2222em;"&gt;&lt;/span&gt;&lt;span class="mbin"&gt;+&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2222em;"&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.8444em; vertical-align: -0.15em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal"&gt;b&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t vlist-t2"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.3117em;"&gt;&lt;span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mathnormal mtight"&gt;i&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-s"&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.15em;"&gt;&lt;span class=""&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="mspace newline"&gt;&lt;/span&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.6389em; vertical-align: -0.2083em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal"&gt;a&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t vlist-t2"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.3117em;"&gt;&lt;span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;&lt;span class="mord mathnormal mtight"&gt;i&lt;/span&gt;&lt;span class="mbin mtight"&gt;+&lt;/span&gt;&lt;span class="mord mtight"&gt;1&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-s"&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.2083em;"&gt;&lt;span class=""&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2778em;"&gt;&lt;/span&gt;&lt;span class="mrel"&gt;=&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2778em;"&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 1em; vertical-align: -0.25em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0359em;"&gt;σ&lt;/span&gt;&lt;span class="mopen"&gt;(&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal" style="margin-right: 0.044em;"&gt;z&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t vlist-t2"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.3117em;"&gt;&lt;span class="" style="top: -2.55em; margin-left: -0.044em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;&lt;span class="mord mathnormal mtight"&gt;i&lt;/span&gt;&lt;span class="mbin mtight"&gt;+&lt;/span&gt;&lt;span class="mord mtight"&gt;1&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-s"&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.2083em;"&gt;&lt;span class=""&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="mclose"&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt; 
</code></pre> 
<p></p> 
<p>其中，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
       
      
    </span><span class="katex-html"></span></span></span></p> 
<pre><code>     σ 
    
   
     ( 
    
   
     ⋅ 
    
   
     ) 
    
   
  
    \sigma(\cdot) 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 1em; vertical-align: -0.25em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0359em;"&gt;σ&lt;/span&gt;&lt;span class="mopen"&gt;(&lt;/span&gt;&lt;span class="mord"&gt;⋅&lt;/span&gt;&lt;span class="mclose"&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; 为sigmoid函数。&lt;/p&gt; 
</code></pre> 
<p></p> 
<p><img src="https://images2.imgbox.com/b7/75/4bjhQyOx_o.png" alt=""></p> 
<p>根据链式求导和反向传播，我们可以得到：</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
        
       
     </span><span class="katex-html"></span></span></span></span></p> 
<pre><code>        ∂ 
       
      
        y 
       
      
      
      
        ∂ 
       
       
       
         a 
        
       
         1 
        
       
      
     
    
      = 
     
     
      
      
        ∂ 
       
      
        y 
       
      
      
      
        ∂ 
       
       
       
         a 
        
       
         4 
        
       
      
     
     
      
      
        ∂ 
       
       
       
         a 
        
       
         4 
        
       
      
      
      
        ∂ 
       
       
       
         z 
        
       
         4 
        
       
      
     
     
      
      
        ∂ 
       
       
       
         z 
        
       
         4 
        
       
      
      
      
        ∂ 
       
       
       
         a 
        
       
         3 
        
       
      
     
     
      
      
        ∂ 
       
       
       
         a 
        
       
         3 
        
       
      
      
      
        ∂ 
       
       
       
         z 
        
       
         3 
        
       
      
     
     
      
      
        ∂ 
       
       
       
         z 
        
       
         3 
        
       
      
      
      
        ∂ 
       
       
       
         a 
        
       
         2 
        
       
      
     
     
      
      
        ∂ 
       
       
       
         a 
        
       
         2 
        
       
      
      
      
        ∂ 
       
       
       
         z 
        
       
         2 
        
       
      
     
     
      
      
        ∂ 
       
       
       
         z 
        
       
         2 
        
       
      
      
      
        ∂ 
       
       
       
         a 
        
       
         1 
        
       
      
     
     
    
      = 
     
     
      
      
        ∂ 
       
      
        y 
       
      
      
      
        ∂ 
       
       
       
         a 
        
       
         4 
        
       
      
     
     
     
       σ 
      
      
       
      
        ′ 
       
      
     
    
      ( 
     
     
     
       z 
      
     
       4 
      
     
    
      ) 
     
     
     
       w 
      
     
       3 
      
     
     
     
       σ 
      
      
       
      
        ′ 
       
      
     
    
      ( 
     
     
     
       z 
      
     
       3 
      
     
    
      ) 
     
     
     
       w 
      
     
       2 
      
     
     
     
       σ 
      
      
       
      
        ′ 
       
      
     
    
      ( 
     
     
     
       z 
      
     
       2 
      
     
    
      ) 
     
     
     
       w 
      
     
       1 
      
     
    
   
     \frac{\partial y}{\partial a_1} = \frac{\partial y}{\partial a_4}\frac{\partial a_4}{\partial z_4}\frac{\partial z_4}{\partial a_3}\frac{\partial a_3}{\partial z_3}\frac{\partial z_3}{\partial a_2}\frac{\partial a_2}{\partial z_2}\frac{\partial z_2}{\partial a_1} \\ = \frac{\partial y}{\partial a_4}\sigma^{'}(z_4)w_3\sigma^{'}(z_3)w_2\sigma^{'}(z_2)w_1 
    
   
 &lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 2.2074em; vertical-align: -0.836em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mopen nulldelimiter"&gt;&lt;/span&gt;&lt;span class="mfrac"&gt;&lt;span class="vlist-t vlist-t2"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 1.3714em;"&gt;&lt;span class="" style="top: -2.314em;"&gt;&lt;span class="pstrut" style="height: 3em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord" style="margin-right: 0.0556em;"&gt;∂&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal"&gt;a&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t vlist-t2"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.3011em;"&gt;&lt;span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;1&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-s"&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.15em;"&gt;&lt;span class=""&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="" style="top: -3.23em;"&gt;&lt;span class="pstrut" style="height: 3em;"&gt;&lt;/span&gt;&lt;span class="frac-line" style="border-bottom-width: 0.04em;"&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="" style="top: -3.677em;"&gt;&lt;span class="pstrut" style="height: 3em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord" style="margin-right: 0.0556em;"&gt;∂&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0359em;"&gt;y&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-s"&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.836em;"&gt;&lt;span class=""&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="mclose nulldelimiter"&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2778em;"&gt;&lt;/span&gt;&lt;span class="mrel"&gt;=&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2778em;"&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 2.2074em; vertical-align: -0.836em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mopen nulldelimiter"&gt;&lt;/span&gt;&lt;span class="mfrac"&gt;&lt;span class="vlist-t vlist-t2"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 1.3714em;"&gt;&lt;span class="" style="top: -2.314em;"&gt;&lt;span class="pstrut" style="height: 3em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord" style="margin-right: 0.0556em;"&gt;∂&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal"&gt;a&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t vlist-t2"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.3011em;"&gt;&lt;span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;4&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-s"&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.15em;"&gt;&lt;span class=""&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="" style="top: -3.23em;"&gt;&lt;span class="pstrut" style="height: 3em;"&gt;&lt;/span&gt;&lt;span class="frac-line" style="border-bottom-width: 0.04em;"&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="" style="top: -3.677em;"&gt;&lt;span class="pstrut" style="height: 3em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord" style="margin-right: 0.0556em;"&gt;∂&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0359em;"&gt;y&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-s"&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.836em;"&gt;&lt;span class=""&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="mclose nulldelimiter"&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mopen nulldelimiter"&gt;&lt;/span&gt;&lt;span class="mfrac"&gt;&lt;span class="vlist-t vlist-t2"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 1.3714em;"&gt;&lt;span class="" style="top: -2.314em;"&gt;&lt;span class="pstrut" style="height: 3em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord" style="margin-right: 0.0556em;"&gt;∂&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal" style="margin-right: 0.044em;"&gt;z&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t vlist-t2"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.3011em;"&gt;&lt;span class="" style="top: -2.55em; margin-left: -0.044em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;4&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-s"&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.15em;"&gt;&lt;span class=""&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="" style="top: -3.23em;"&gt;&lt;span class="pstrut" style="height: 3em;"&gt;&lt;/span&gt;&lt;span class="frac-line" style="border-bottom-width: 0.04em;"&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="" style="top: -3.677em;"&gt;&lt;span class="pstrut" style="height: 3em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord" style="margin-right: 0.0556em;"&gt;∂&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal"&gt;a&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t vlist-t2"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.3011em;"&gt;&lt;span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;4&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-s"&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.15em;"&gt;&lt;span class=""&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-s"&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.836em;"&gt;&lt;span class=""&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="mclose nulldelimiter"&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mopen nulldelimiter"&gt;&lt;/span&gt;&lt;span class="mfrac"&gt;&lt;span class="vlist-t vlist-t2"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 1.3714em;"&gt;&lt;span class="" style="top: -2.314em;"&gt;&lt;span class="pstrut" style="height: 3em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord" style="margin-right: 0.0556em;"&gt;∂&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal"&gt;a&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t vlist-t2"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.3011em;"&gt;&lt;span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;3&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-s"&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.15em;"&gt;&lt;span class=""&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="" style="top: -3.23em;"&gt;&lt;span class="pstrut" style="height: 3em;"&gt;&lt;/span&gt;&lt;span class="frac-line" style="border-bottom-width: 0.04em;"&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="" style="top: -3.677em;"&gt;&lt;span class="pstrut" style="height: 3em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord" style="margin-right: 0.0556em;"&gt;∂&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal" style="margin-right: 0.044em;"&gt;z&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t vlist-t2"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.3011em;"&gt;&lt;span class="" style="top: -2.55em; margin-left: -0.044em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;4&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-s"&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.15em;"&gt;&lt;span class=""&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-s"&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.836em;"&gt;&lt;span class=""&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="mclose nulldelimiter"&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mopen nulldelimiter"&gt;&lt;/span&gt;&lt;span class="mfrac"&gt;&lt;span class="vlist-t vlist-t2"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 1.3714em;"&gt;&lt;span class="" style="top: -2.314em;"&gt;&lt;span class="pstrut" style="height: 3em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord" style="margin-right: 0.0556em;"&gt;∂&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal" style="margin-right: 0.044em;"&gt;z&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t vlist-t2"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.3011em;"&gt;&lt;span class="" style="top: -2.55em; margin-left: -0.044em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;3&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-s"&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.15em;"&gt;&lt;span class=""&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="" style="top: -3.23em;"&gt;&lt;span class="pstrut" style="height: 3em;"&gt;&lt;/span&gt;&lt;span class="frac-line" style="border-bottom-width: 0.04em;"&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="" style="top: -3.677em;"&gt;&lt;span class="pstrut" style="height: 3em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord" style="margin-right: 0.0556em;"&gt;∂&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal"&gt;a&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t vlist-t2"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.3011em;"&gt;&lt;span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;3&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-s"&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.15em;"&gt;&lt;span class=""&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-s"&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.836em;"&gt;&lt;span class=""&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="mclose nulldelimiter"&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mopen nulldelimiter"&gt;&lt;/span&gt;&lt;span class="mfrac"&gt;&lt;span class="vlist-t vlist-t2"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 1.3714em;"&gt;&lt;span class="" style="top: -2.314em;"&gt;&lt;span class="pstrut" style="height: 3em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord" style="margin-right: 0.0556em;"&gt;∂&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal"&gt;a&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t vlist-t2"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.3011em;"&gt;&lt;span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;2&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-s"&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.15em;"&gt;&lt;span class=""&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="" style="top: -3.23em;"&gt;&lt;span class="pstrut" style="height: 3em;"&gt;&lt;/span&gt;&lt;span class="frac-line" style="border-bottom-width: 0.04em;"&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="" style="top: -3.677em;"&gt;&lt;span class="pstrut" style="height: 3em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord" style="margin-right: 0.0556em;"&gt;∂&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal" style="margin-right: 0.044em;"&gt;z&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t vlist-t2"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.3011em;"&gt;&lt;span class="" style="top: -2.55em; margin-left: -0.044em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;3&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-s"&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.15em;"&gt;&lt;span class=""&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-s"&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.836em;"&gt;&lt;span class=""&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="mclose nulldelimiter"&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mopen nulldelimiter"&gt;&lt;/span&gt;&lt;span class="mfrac"&gt;&lt;span class="vlist-t vlist-t2"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 1.3714em;"&gt;&lt;span class="" style="top: -2.314em;"&gt;&lt;span class="pstrut" style="height: 3em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord" style="margin-right: 0.0556em;"&gt;∂&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal" style="margin-right: 0.044em;"&gt;z&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t vlist-t2"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.3011em;"&gt;&lt;span class="" style="top: -2.55em; margin-left: -0.044em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;2&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-s"&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.15em;"&gt;&lt;span class=""&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="" style="top: -3.23em;"&gt;&lt;span class="pstrut" style="height: 3em;"&gt;&lt;/span&gt;&lt;span class="frac-line" style="border-bottom-width: 0.04em;"&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="" style="top: -3.677em;"&gt;&lt;span class="pstrut" style="height: 3em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord" style="margin-right: 0.0556em;"&gt;∂&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal"&gt;a&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t vlist-t2"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.3011em;"&gt;&lt;span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;2&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-s"&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.15em;"&gt;&lt;span class=""&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-s"&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.836em;"&gt;&lt;span class=""&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="mclose nulldelimiter"&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mopen nulldelimiter"&gt;&lt;/span&gt;&lt;span class="mfrac"&gt;&lt;span class="vlist-t vlist-t2"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 1.3714em;"&gt;&lt;span class="" style="top: -2.314em;"&gt;&lt;span class="pstrut" style="height: 3em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord" style="margin-right: 0.0556em;"&gt;∂&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal"&gt;a&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t vlist-t2"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.3011em;"&gt;&lt;span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;1&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-s"&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.15em;"&gt;&lt;span class=""&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="" style="top: -3.23em;"&gt;&lt;span class="pstrut" style="height: 3em;"&gt;&lt;/span&gt;&lt;span class="frac-line" style="border-bottom-width: 0.04em;"&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="" style="top: -3.677em;"&gt;&lt;span class="pstrut" style="height: 3em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord" style="margin-right: 0.0556em;"&gt;∂&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal" style="margin-right: 0.044em;"&gt;z&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t vlist-t2"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.3011em;"&gt;&lt;span class="" style="top: -2.55em; margin-left: -0.044em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;2&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-s"&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.15em;"&gt;&lt;span class=""&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-s"&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.836em;"&gt;&lt;span class=""&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="mclose nulldelimiter"&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="mspace newline"&gt;&lt;/span&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.3669em;"&gt;&lt;/span&gt;&lt;span class="mrel"&gt;=&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2778em;"&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 2.2074em; vertical-align: -0.836em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mopen nulldelimiter"&gt;&lt;/span&gt;&lt;span class="mfrac"&gt;&lt;span class="vlist-t vlist-t2"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 1.3714em;"&gt;&lt;span class="" style="top: -2.314em;"&gt;&lt;span class="pstrut" style="height: 3em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord" style="margin-right: 0.0556em;"&gt;∂&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal"&gt;a&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t vlist-t2"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.3011em;"&gt;&lt;span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;4&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-s"&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.15em;"&gt;&lt;span class=""&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="" style="top: -3.23em;"&gt;&lt;span class="pstrut" style="height: 3em;"&gt;&lt;/span&gt;&lt;span class="frac-line" style="border-bottom-width: 0.04em;"&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="" style="top: -3.677em;"&gt;&lt;span class="pstrut" style="height: 3em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord" style="margin-right: 0.0556em;"&gt;∂&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0359em;"&gt;y&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-s"&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.836em;"&gt;&lt;span class=""&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="mclose nulldelimiter"&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0359em;"&gt;σ&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.9925em;"&gt;&lt;span class="" style="top: -2.9925em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.5795em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;&lt;span class="mord mtight"&gt;&lt;span class=""&gt;&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.8278em;"&gt;&lt;span class="" style="top: -2.931em; margin-right: 0.0714em;"&gt;&lt;span class="pstrut" style="height: 2.5em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size3 size1 mtight"&gt;&lt;span class="mord mtight"&gt;&lt;span class="mord mtight"&gt;′&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="mopen"&gt;(&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal" style="margin-right: 0.044em;"&gt;z&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t vlist-t2"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.3011em;"&gt;&lt;span class="" style="top: -2.55em; margin-left: -0.044em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;4&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-s"&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.15em;"&gt;&lt;span class=""&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="mclose"&gt;)&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0269em;"&gt;w&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t vlist-t2"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.3011em;"&gt;&lt;span class="" style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;3&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-s"&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.15em;"&gt;&lt;span class=""&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0359em;"&gt;σ&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.9925em;"&gt;&lt;span class="" style="top: -2.9925em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.5795em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;&lt;span class="mord mtight"&gt;&lt;span class=""&gt;&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.8278em;"&gt;&lt;span class="" style="top: -2.931em; margin-right: 0.0714em;"&gt;&lt;span class="pstrut" style="height: 2.5em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size3 size1 mtight"&gt;&lt;span class="mord mtight"&gt;&lt;span class="mord mtight"&gt;′&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="mopen"&gt;(&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal" style="margin-right: 0.044em;"&gt;z&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t vlist-t2"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.3011em;"&gt;&lt;span class="" style="top: -2.55em; margin-left: -0.044em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;3&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-s"&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.15em;"&gt;&lt;span class=""&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="mclose"&gt;)&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0269em;"&gt;w&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t vlist-t2"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.3011em;"&gt;&lt;span class="" style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;2&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-s"&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.15em;"&gt;&lt;span class=""&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0359em;"&gt;σ&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.9925em;"&gt;&lt;span class="" style="top: -2.9925em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.5795em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;&lt;span class="mord mtight"&gt;&lt;span class=""&gt;&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.8278em;"&gt;&lt;span class="" style="top: -2.931em; margin-right: 0.0714em;"&gt;&lt;span class="pstrut" style="height: 2.5em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size3 size1 mtight"&gt;&lt;span class="mord mtight"&gt;&lt;span class="mord mtight"&gt;′&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="mopen"&gt;(&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal" style="margin-right: 0.044em;"&gt;z&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t vlist-t2"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.3011em;"&gt;&lt;span class="" style="top: -2.55em; margin-left: -0.044em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;2&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-s"&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.15em;"&gt;&lt;span class=""&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="mclose"&gt;)&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0269em;"&gt;w&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t vlist-t2"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.3011em;"&gt;&lt;span class="" style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;1&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-s"&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.15em;"&gt;&lt;span class=""&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt; Sigmoid 函数的导数 &lt;span class="katex--inline"&gt;&lt;span class="katex"&gt;&lt;span class="katex-mathml"&gt; 
 
  
   
    
    
      σ 
     
     
      
     
       ′ 
      
     
    
   
     ( 
    
   
     x 
    
   
     ) 
    
   
  
    \sigma^{'}(x) 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 1.1925em; vertical-align: -0.25em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0359em;"&gt;σ&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.9425em;"&gt;&lt;span class="" style="top: -2.9425em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.5795em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;&lt;span class="mord mtight"&gt;&lt;span class=""&gt;&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.8278em;"&gt;&lt;span class="" style="top: -2.931em; margin-right: 0.0714em;"&gt;&lt;span class="pstrut" style="height: 2.5em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size3 size1 mtight"&gt;&lt;span class="mord mtight"&gt;&lt;span class="mord mtight"&gt;′&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="mopen"&gt;(&lt;/span&gt;&lt;span class="mord mathnormal"&gt;x&lt;/span&gt;&lt;span class="mclose"&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; 如 &lt;strong&gt;图3&lt;/strong&gt; 所示：&lt;/p&gt; 
</code></pre> 
<p></p> 
<p><img src="https://images2.imgbox.com/c4/16/zM2aLtA1_o.png" alt=""></p> 
<p>我们可以看到sigmoid的导数最大值为0.25，那么随着网络层数的增加，小于1的小数不断相乘导致 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
       
      
    </span><span class="katex-html"></span></span></span></p> 
<pre><code>       ∂ 
      
     
       y 
      
     
     
     
       ∂ 
      
      
      
        a 
       
      
        1 
       
      
     
    
   
  
    \frac{\partial y}{\partial a_1} 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 1.3773em; vertical-align: -0.4451em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mopen nulldelimiter"&gt;&lt;/span&gt;&lt;span class="mfrac"&gt;&lt;span class="vlist-t vlist-t2"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.9322em;"&gt;&lt;span class="" style="top: -2.655em;"&gt;&lt;span class="pstrut" style="height: 3em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;&lt;span class="mord mtight" style="margin-right: 0.0556em;"&gt;∂&lt;/span&gt;&lt;span class="mord mtight"&gt;&lt;span class="mord mathnormal mtight"&gt;a&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t vlist-t2"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.3173em;"&gt;&lt;span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;"&gt;&lt;span class="pstrut" style="height: 2.5em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size3 size1 mtight"&gt;&lt;span class="mord mtight"&gt;1&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-s"&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.143em;"&gt;&lt;span class=""&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="" style="top: -3.23em;"&gt;&lt;span class="pstrut" style="height: 3em;"&gt;&lt;/span&gt;&lt;span class="frac-line" style="border-bottom-width: 0.04em;"&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="" style="top: -3.4461em;"&gt;&lt;span class="pstrut" style="height: 3em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;&lt;span class="mord mtight" style="margin-right: 0.0556em;"&gt;∂&lt;/span&gt;&lt;span class="mord mathnormal mtight" style="margin-right: 0.0359em;"&gt;y&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-s"&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.4451em;"&gt;&lt;span class=""&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="mclose nulldelimiter"&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; 逐渐趋近于零，从而产生梯度消失。&lt;/p&gt; 
</code></pre> 
<p></p> 
<p>那么梯度爆炸又是怎么引起的呢？同样的道理，当权重初始化为一个较大值时，虽然和激活函数的导数相乘会减小这个值，但是随着神经网络的加深，梯度呈指数级增长，就会引发梯度爆炸。但是从AlexNet开始，神经网络中就使用ReLU函数替换了Sigmoid，同时BN（Batch Normalization)层的加入，也基本解决了梯度消失/爆炸问题。</p> 
<h4><a id="122__67"></a>1.2.2 网络退化</h4> 
<p>现在，梯度消失/爆炸的问题解决了是不是就可以通过堆叠层数来加深网络了呢？Still no！</p> 
<p>我们来看看ResNet论文中提到的例子（见 <strong>图4</strong>），很明显，56层的深层网络，在训练集和测试集上的表现都远不如20层的浅层网络，这种随着网络层数加深，accuracy逐渐饱和，然后出现急剧下降，具体表现为深层网络的训练效果反而不如浅层网络好的现象，被称为网络退化（degradation）。</p> 
<p><img src="https://images2.imgbox.com/98/db/gCJ7gysS_o.png" alt=""></p> 
<p>为什么会引起网络退化呢？按照理论上的想法，当浅层网络效果不错的时候，网络层数的增加即使不会引起精度上的提升也不该使模型效果变差。但事实上非线性的激活函数的存在，会造成很多不可逆的信息损失，网络加深到一定程度，过多的信息损失就会造成网络的退化。</p> 
<p>而ResNet就是提出一种方法让网络拥有<strong>恒等映射</strong>能力，即随着网络层数的增加，深层网络至少不会差于浅层网络。</p> 
<h3><a id="13__81"></a>1…3. 残差块</h3> 
<p>现在我们明白了，为了加深网络结构，使每一次能够学到更细化的特征从而提高网络精度，需要实现的一点是<strong>恒等映射</strong>。那么残差网络如何能够做到这一点呢？</p> 
<p>恒等映射即为 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
       
      
    </span><span class="katex-html"></span></span></span></p> 
<pre><code>     H 
    
   
     ( 
    
   
     x 
    
   
     ) 
    
   
     = 
    
   
     x 
    
   
  
    H(x) = x 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 1em; vertical-align: -0.25em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0813em;"&gt;H&lt;/span&gt;&lt;span class="mopen"&gt;(&lt;/span&gt;&lt;span class="mord mathnormal"&gt;x&lt;/span&gt;&lt;span class="mclose"&gt;)&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2778em;"&gt;&lt;/span&gt;&lt;span class="mrel"&gt;=&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2778em;"&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.4306em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal"&gt;x&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;，已有的神经网络结构很难做到这一点，但是如果我们将网络设计成 &lt;span class="katex--inline"&gt;&lt;span class="katex"&gt;&lt;span class="katex-mathml"&gt; 
 
  
   
   
     H 
    
   
     ( 
    
   
     x 
    
   
     ) 
    
   
     = 
    
   
     F 
    
   
     ( 
    
   
     x 
    
   
     ) 
    
   
     + 
    
   
     x 
    
   
  
    H(x) = F(x) + x 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 1em; vertical-align: -0.25em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0813em;"&gt;H&lt;/span&gt;&lt;span class="mopen"&gt;(&lt;/span&gt;&lt;span class="mord mathnormal"&gt;x&lt;/span&gt;&lt;span class="mclose"&gt;)&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2778em;"&gt;&lt;/span&gt;&lt;span class="mrel"&gt;=&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2778em;"&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 1em; vertical-align: -0.25em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.1389em;"&gt;F&lt;/span&gt;&lt;span class="mopen"&gt;(&lt;/span&gt;&lt;span class="mord mathnormal"&gt;x&lt;/span&gt;&lt;span class="mclose"&gt;)&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2222em;"&gt;&lt;/span&gt;&lt;span class="mbin"&gt;+&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2222em;"&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.4306em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal"&gt;x&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;，即 &lt;span class="katex--inline"&gt;&lt;span class="katex"&gt;&lt;span class="katex-mathml"&gt; 
 
  
   
   
     F 
    
   
     ( 
    
   
     x 
    
   
     ) 
    
   
     = 
    
   
     H 
    
   
     ( 
    
   
     x 
    
   
     ) 
    
   
     − 
    
   
     x 
    
   
  
    F(x) = H(x) - x 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 1em; vertical-align: -0.25em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.1389em;"&gt;F&lt;/span&gt;&lt;span class="mopen"&gt;(&lt;/span&gt;&lt;span class="mord mathnormal"&gt;x&lt;/span&gt;&lt;span class="mclose"&gt;)&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2778em;"&gt;&lt;/span&gt;&lt;span class="mrel"&gt;=&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2778em;"&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 1em; vertical-align: -0.25em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0813em;"&gt;H&lt;/span&gt;&lt;span class="mopen"&gt;(&lt;/span&gt;&lt;span class="mord mathnormal"&gt;x&lt;/span&gt;&lt;span class="mclose"&gt;)&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2222em;"&gt;&lt;/span&gt;&lt;span class="mbin"&gt;−&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2222em;"&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.4306em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal"&gt;x&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;，那么只需要使残差函数 &lt;span class="katex--inline"&gt;&lt;span class="katex"&gt;&lt;span class="katex-mathml"&gt; 
 
  
   
   
     F 
    
   
     ( 
    
   
     x 
    
   
     ) 
    
   
     = 
    
   
     0 
    
   
  
    F(x) = 0 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 1em; vertical-align: -0.25em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.1389em;"&gt;F&lt;/span&gt;&lt;span class="mopen"&gt;(&lt;/span&gt;&lt;span class="mord mathnormal"&gt;x&lt;/span&gt;&lt;span class="mclose"&gt;)&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2778em;"&gt;&lt;/span&gt;&lt;span class="mrel"&gt;=&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2778em;"&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.6444em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;0&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;，就构成了恒等映射 &lt;span class="katex--inline"&gt;&lt;span class="katex"&gt;&lt;span class="katex-mathml"&gt; 
 
  
   
   
     H 
    
   
     ( 
    
   
     x 
    
   
     ) 
    
   
     = 
    
   
     F 
    
   
     ( 
    
   
     x 
    
   
     ) 
    
   
  
    H(x) = F(x) 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 1em; vertical-align: -0.25em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0813em;"&gt;H&lt;/span&gt;&lt;span class="mopen"&gt;(&lt;/span&gt;&lt;span class="mord mathnormal"&gt;x&lt;/span&gt;&lt;span class="mclose"&gt;)&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2778em;"&gt;&lt;/span&gt;&lt;span class="mrel"&gt;=&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2778em;"&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 1em; vertical-align: -0.25em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.1389em;"&gt;F&lt;/span&gt;&lt;span class="mopen"&gt;(&lt;/span&gt;&lt;span class="mord mathnormal"&gt;x&lt;/span&gt;&lt;span class="mclose"&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;。&lt;/p&gt; 
</code></pre> 
<p></p> 
<p><img src="https://images2.imgbox.com/39/1f/ztgmK9p8_o.png" alt=""></p> 
<p>残差结构的目的是，随着网络的加深，使 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
       
      
    </span><span class="katex-html"></span></span></span></p> 
<pre><code>     F 
    
   
     ( 
    
   
     x 
    
   
     ) 
    
   
  
    F(x) 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 1em; vertical-align: -0.25em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.1389em;"&gt;F&lt;/span&gt;&lt;span class="mopen"&gt;(&lt;/span&gt;&lt;span class="mord mathnormal"&gt;x&lt;/span&gt;&lt;span class="mclose"&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; 逼近于0，使得深度网络的精度在最优浅层网络的基础上不会下降。看到这里你或许会有疑问，既然如此为什么不直接选取最优的浅层网络呢？这是因为最优的浅层网络结构并不易找寻，而ResNet可以通过增加深度，找到最优的浅层网络并保证深层网络不会因为层数的叠加而发生网络退化。&lt;/p&gt; 
</code></pre> 
<p></p> 
<ul><li>参考文献</li></ul> 
<p>[1] <a href="https://arxiv.org/pdf/1311.2901.pdf" rel="nofollow">Visualizing and Understanding Convolutional Networks</a></p> 
<p>[2] <a href="https://arxiv.org/pdf/1512.03385.pdf" rel="nofollow">Deep Residual Learning for Image Recognition</a></p> 
<h2><a id="2_ResNeXt2017_100"></a>2. ResNeXt（2017）</h2> 
<p>ResNeXt是由何凯明团队在2017年CVPR会议上提出来的新型图像分类网络。ResNeXt是ResNet的升级版，在ResNet的基础上，引入了cardinality的概念，类似于ResNet，ResNeXt也有ResNeXt-50，ResNeXt-101的版本。那么相较于ResNet，ResNeXt的创新点在哪里？既然是分类网络，那么在ImageNet数据集上的指标相较于ResNet有何变化？之后的ResNeXt_WSL又是什么东西？下面我和大家一起分享一下这些知识。</p> 
<h3><a id="21_ResNeXt_103"></a>2.1 ResNeXt模型结构</h3> 
<p>在ResNeXt的论文中，作者提出了当时普遍存在的一个问题，如果要提高模型的准确率，往往采取加深网络或者加宽网络的方法。虽然这种方法是有效的，但是随之而来的，是网络设计的难度和计算开销的增加。为了一点精度的提升往往需要付出更大的代价。因此，需要一个更好的策略，在不额外增加计算代价的情况下，提升网络的精度。由此，何等人提出了cardinality的概念。</p> 
<p>下图是ResNet（左）与ResNeXt（右）block的差异。在ResNet中，输入的具有256个通道的特征经过1×1卷积压缩4倍到64个通道，之后3×3的卷积核用于处理特征，经1×1卷积扩大通道数与原特征残差连接后输出。ResNeXt也是相同的处理策略，但在ResNeXt中，输入的具有256个通道的特征被分为32个组，每组被压缩64倍到4个通道后进行处理。32个组相加后与原特征残差连接后输出。这里cardinatity指的是一个block中所具有的相同分支的数目。</p> 
<p><img src="https://images2.imgbox.com/64/9d/rHm6GiJm_o.jpg" alt=""></p> 
<p>下图是InceptionNet的两种inception module结构，左边是inception module的naive版本，右边是使用了降维方法的inception module。相较于右边，左边很明显的缺点就是参数大，计算量巨大。使用不同大小的卷积核目的是为了提取不同尺度的特征信息，对于图像而言，多尺度的信息有助于网络更好地对图像信息进行选择，并且使得网络对于不同尺寸的图像输入有更好的适应能力，但多尺度带来的问题就是计算量的增加。因此在右边的模型中，InceptionNet很好地解决了这个问题，首先是1×1的卷积用于特征降维，减小特征的通道数后再采取多尺度的结构提取特征信息，在降低参数量的同时捕获到多尺度的特征信息。</p> 
<p>ResNeXt正是借鉴了这种“分割-变换-聚合”的策略，但用相同的拓扑结构组建ResNeXt模块。每个结构都是相同的卷积核，保持了结构的简洁，使得模型在编程上更方便更容易，而InceptionNet则需要更为复杂的设计。</p> 
<p><img src="https://images2.imgbox.com/30/67/KM5sQzsX_o.jpg" alt=""></p> 
<h3><a id="22_ResNeXt_120"></a>2.2 ResNeXt模型实现</h3> 
<p>ResNeXt与ResNet的模型结构一致，主要差别在于block的搭建，因此这里用paddle框架来实现block的代码</p> 
<pre class="set-code-hide prettyprint"><code class="prism language-python has-numbering"><span class="token keyword">class</span> <span class="token class-name">ConvBNLayer</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Layer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> num_channels<span class="token punctuation">,</span> num_filters<span class="token punctuation">,</span> filter_size<span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
                 groups<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> act<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> data_format<span class="token operator">=</span><span class="token string">"NCHW"</span>
                <span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>ConvBNLayer<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_conv <span class="token operator">=</span> Conv2D<span class="token punctuation">(</span>
            in_channels<span class="token operator">=</span>num_channels<span class="token punctuation">,</span> out_channels<span class="token operator">=</span>num_filters<span class="token punctuation">,</span>
            kernel_size<span class="token operator">=</span>filter_size<span class="token punctuation">,</span> stride<span class="token operator">=</span>stride<span class="token punctuation">,</span>
            padding<span class="token operator">=</span><span class="token punctuation">(</span>filter_size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">2</span><span class="token punctuation">,</span> groups<span class="token operator">=</span>groups<span class="token punctuation">,</span>
            weight_attr<span class="token operator">=</span>ParamAttr<span class="token punctuation">(</span>name<span class="token operator">=</span>name <span class="token operator">+</span> <span class="token string">"_weights"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bias_attr<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
            data_format<span class="token operator">=</span>data_format
        <span class="token punctuation">)</span>
        <span class="token keyword">if</span> name <span class="token operator">==</span> <span class="token string">"conv1"</span><span class="token punctuation">:</span>
            bn_name <span class="token operator">=</span> <span class="token string">"bn_"</span> <span class="token operator">+</span> name
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            bn_name <span class="token operator">=</span> <span class="token string">"bn"</span> <span class="token operator">+</span> name<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>_batch_norm <span class="token operator">=</span> BatchNorm<span class="token punctuation">(</span>
            num_filters<span class="token punctuation">,</span> act<span class="token operator">=</span>act<span class="token punctuation">,</span> param_attr<span class="token operator">=</span>ParamAttr<span class="token punctuation">(</span>name<span class="token operator">=</span>bn_name <span class="token operator">+</span> <span class="token string">'_scale'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            bias_attr<span class="token operator">=</span>ParamAttr<span class="token punctuation">(</span>bn_name <span class="token operator">+</span> <span class="token string">'_offset'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> moving_mean_name<span class="token operator">=</span>bn_name <span class="token operator">+</span> <span class="token string">'_mean'</span><span class="token punctuation">,</span>
            moving_variance_name<span class="token operator">=</span>bn_name <span class="token operator">+</span> <span class="token string">'_variance'</span><span class="token punctuation">,</span> data_layout<span class="token operator">=</span>data_format
        <span class="token punctuation">)</span>
</code><pre><code>&lt;span class="token keyword"&gt;def&lt;/span&gt; &lt;span class="token function"&gt;forward&lt;/span&gt;&lt;span class="token punctuation"&gt;(&lt;/span&gt;self&lt;span class="token punctuation"&gt;,&lt;/span&gt; inputs&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;
    y &lt;span class="token operator"&gt;=&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;_conv&lt;span class="token punctuation"&gt;(&lt;/span&gt;inputs&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    y &lt;span class="token operator"&gt;=&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;_batch_norm&lt;span class="token punctuation"&gt;(&lt;/span&gt;y&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    &lt;span class="token keyword"&gt;return&lt;/span&gt; y
</code></pre>
</pre> 
<p><span class="token keyword">class</span> <span class="token class-name">BottleneckBlock</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Layer<span class="token punctuation">)</span><span class="token punctuation">:</span><br> <span class="token keyword">def</span> <span class="token function"><strong>init</strong></span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> num_channels<span class="token punctuation">,</span> num_filters<span class="token punctuation">,</span> stride<span class="token punctuation">,</span> cardinality<span class="token punctuation">,</span> shortcut<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span><br> name<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> data_format<span class="token operator">=</span><span class="token string">“NCHW”</span><br> <span class="token punctuation">)</span><span class="token punctuation">:</span><br> <span class="token builtin">super</span><span class="token punctuation">(</span>BottleneckBlock<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span><strong>init</strong><span class="token punctuation">(</span><span class="token punctuation">)</span><br> self<span class="token punctuation">.</span>conv0 <span class="token operator">=</span> ConvBNLayer<span class="token punctuation">(</span>num_channels<span class="token operator">=</span>num_channels<span class="token punctuation">,</span> num_filters<span class="token operator">=</span>num_filters<span class="token punctuation">,</span><br> filter_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> act<span class="token operator">=</span><span class="token string">‘relu’</span><span class="token punctuation">,</span> name<span class="token operator">=</span>name <span class="token operator">+</span> <span class="token string">“_branch2a”</span><span class="token punctuation">,</span><br> data_format<span class="token operator">=</span>data_format<br> <span class="token punctuation">)</span><br> self<span class="token punctuation">.</span>conv1 <span class="token operator">=</span> ConvBNLayer<span class="token punctuation">(</span><br> num_channels<span class="token operator">=</span>num_filters<span class="token punctuation">,</span> num_filters<span class="token operator">=</span>num_filters<span class="token punctuation">,</span><br> filter_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> groups<span class="token operator">=</span>cardinality<span class="token punctuation">,</span><br> stride<span class="token operator">=</span>stride<span class="token punctuation">,</span> act<span class="token operator">=</span><span class="token string">‘relu’</span><span class="token punctuation">,</span> name<span class="token operator">=</span>name <span class="token operator">+</span> <span class="token string">“_branch2b”</span><span class="token punctuation">,</span><br> data_format<span class="token operator">=</span>data_format<br> <span class="token punctuation">)</span></p> 
<pre><code>    self&lt;span class="token punctuation"&gt;.&lt;/span&gt;conv2 &lt;span class="token operator"&gt;=&lt;/span&gt; ConvBNLayer&lt;span class="token punctuation"&gt;(&lt;/span&gt;
        num_channels&lt;span class="token operator"&gt;=&lt;/span&gt;num_filters&lt;span class="token punctuation"&gt;,&lt;/span&gt;
        num_filters&lt;span class="token operator"&gt;=&lt;/span&gt;num_filters &lt;span class="token operator"&gt;*&lt;/span&gt; &lt;span class="token number"&gt;2&lt;/span&gt; &lt;span class="token keyword"&gt;if&lt;/span&gt; cardinality &lt;span class="token operator"&gt;==&lt;/span&gt; &lt;span class="token number"&gt;32&lt;/span&gt; &lt;span class="token keyword"&gt;else&lt;/span&gt; num_filters&lt;span class="token punctuation"&gt;,&lt;/span&gt;
        filter_size&lt;span class="token operator"&gt;=&lt;/span&gt;&lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; act&lt;span class="token operator"&gt;=&lt;/span&gt;&lt;span class="token boolean"&gt;None&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt;
        name&lt;span class="token operator"&gt;=&lt;/span&gt;name &lt;span class="token operator"&gt;+&lt;/span&gt; &lt;span class="token string"&gt;"_branch2c"&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt;
        data_format&lt;span class="token operator"&gt;=&lt;/span&gt;data_format
    &lt;span class="token punctuation"&gt;)&lt;/span&gt;

    &lt;span class="token keyword"&gt;if&lt;/span&gt; &lt;span class="token keyword"&gt;not&lt;/span&gt; shortcut&lt;span class="token punctuation"&gt;:&lt;/span&gt;
        self&lt;span class="token punctuation"&gt;.&lt;/span&gt;short &lt;span class="token operator"&gt;=&lt;/span&gt; ConvBNLayer&lt;span class="token punctuation"&gt;(&lt;/span&gt;
            num_channels&lt;span class="token operator"&gt;=&lt;/span&gt;num_channels&lt;span class="token punctuation"&gt;,&lt;/span&gt; num_filters&lt;span class="token operator"&gt;=&lt;/span&gt;num_filters &lt;span class="token operator"&gt;*&lt;/span&gt; &lt;span class="token number"&gt;2&lt;/span&gt;
            &lt;span class="token keyword"&gt;if&lt;/span&gt; cardinality &lt;span class="token operator"&gt;==&lt;/span&gt; &lt;span class="token number"&gt;32&lt;/span&gt; &lt;span class="token keyword"&gt;else&lt;/span&gt; num_filters&lt;span class="token punctuation"&gt;,&lt;/span&gt;
            filter_size&lt;span class="token operator"&gt;=&lt;/span&gt;&lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; stride&lt;span class="token operator"&gt;=&lt;/span&gt;stride&lt;span class="token punctuation"&gt;,&lt;/span&gt;
            name&lt;span class="token operator"&gt;=&lt;/span&gt;name &lt;span class="token operator"&gt;+&lt;/span&gt; &lt;span class="token string"&gt;"_branch1"&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; data_format&lt;span class="token operator"&gt;=&lt;/span&gt;data_format
        &lt;span class="token punctuation"&gt;)&lt;/span&gt;

    self&lt;span class="token punctuation"&gt;.&lt;/span&gt;shortcut &lt;span class="token operator"&gt;=&lt;/span&gt; shortcut

&lt;span class="token keyword"&gt;def&lt;/span&gt; &lt;span class="token function"&gt;forward&lt;/span&gt;&lt;span class="token punctuation"&gt;(&lt;/span&gt;self&lt;span class="token punctuation"&gt;,&lt;/span&gt; inputs&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;
    y &lt;span class="token operator"&gt;=&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;conv0&lt;span class="token punctuation"&gt;(&lt;/span&gt;inputs&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    conv1 &lt;span class="token operator"&gt;=&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;conv1&lt;span class="token punctuation"&gt;(&lt;/span&gt;y&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    conv2 &lt;span class="token operator"&gt;=&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;conv2&lt;span class="token punctuation"&gt;(&lt;/span&gt;conv1&lt;span class="token punctuation"&gt;)&lt;/span&gt;

    &lt;span class="token keyword"&gt;if&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;shortcut&lt;span class="token punctuation"&gt;:&lt;/span&gt;
        short &lt;span class="token operator"&gt;=&lt;/span&gt; inputs
    &lt;span class="token keyword"&gt;else&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;
        short &lt;span class="token operator"&gt;=&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;short&lt;span class="token punctuation"&gt;(&lt;/span&gt;inputs&lt;span class="token punctuation"&gt;)&lt;/span&gt;

    y &lt;span class="token operator"&gt;=&lt;/span&gt; paddle&lt;span class="token punctuation"&gt;.&lt;/span&gt;add&lt;span class="token punctuation"&gt;(&lt;/span&gt;x&lt;span class="token operator"&gt;=&lt;/span&gt;short&lt;span class="token punctuation"&gt;,&lt;/span&gt; y&lt;span class="token operator"&gt;=&lt;/span&gt;conv2&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    y &lt;span class="token operator"&gt;=&lt;/span&gt; F&lt;span class="token punctuation"&gt;.&lt;/span&gt;relu&lt;span class="token punctuation"&gt;(&lt;/span&gt;y&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    &lt;span class="token keyword"&gt;return&lt;/span&gt; y
</code></pre> 
<div class="hljs-button {2}"></div> 
<div class="hide-preCode-box"> 
 <span class="hide-preCode-bt"><img class="look-more-preCode contentImg-no-view" src="https://images2.imgbox.com/f6/cd/S1dCEZfr_o.png" alt="" title=""></span> 
</div> 
<ul class="pre-numbering"><li>1</li><li>2</li><li>3</li><li>4</li><li>5</li><li>6</li><li>7</li><li>8</li><li>9</li><li>10</li><li>11</li><li>12</li><li>13</li><li>14</li><li>15</li><li>16</li><li>17</li><li>18</li><li>19</li><li>20</li><li>21</li><li>22</li><li>23</li><li>24</li><li>25</li><li>26</li><li>27</li><li>28</li><li>29</li><li>30</li><li>31</li><li>32</li><li>33</li><li>34</li><li>35</li><li>36</li><li>37</li><li>38</li><li>39</li><li>40</li><li>41</li><li>42</li><li>43</li><li>44</li><li>45</li><li>46</li><li>47</li><li>48</li><li>49</li><li>50</li><li>51</li><li>52</li><li>53</li><li>54</li><li>55</li><li>56</li><li>57</li><li>58</li><li>59</li><li>60</li><li>61</li><li>62</li><li>63</li><li>64</li><li>65</li><li>66</li><li>67</li><li>68</li><li>69</li><li>70</li><li>71</li><li>72</li><li>73</li><li>74</li><li>75</li></ul> 
<h3><a id="23_ResNeXt_200"></a>2.3 ResNeXt模型特点</h3> 
<ol><li>ResNeXt通过控制cardinality的数量，使得ResNeXt的参数量和GFLOPs与ResNet几乎相同。</li><li>通过cardinality的分支结构，为网络提供更多的非线性，从而获得更精确的分类效果。</li></ol> 
<h3><a id="24_ResNeXt_204"></a>2.4 ResNeXt模型指标</h3> 
<p><img src="https://images2.imgbox.com/1a/bd/tCIQRuuP_o.jpg" alt=""></p> 
<p>上图是ResNet与ResNeXt的参数对比，可以看出，ResNeXt与ResNet几乎是一模一样的参数量和计算量，然而两者在ImageNet上的表现却不一样。</p> 
<p><img src="https://images2.imgbox.com/f5/f4/gfcj8QII_o.jpg" alt=""></p> 
<p>从图中可以看出，ResNeXt除了可以增加block中3×3卷积核的通道数，还可以增加cardinality的分支数来提升模型的精度。ResNeXt-50和ResNeXt-101都大大降低了对应ResNet的错误率。图中，ResNeXt-101从32×4d变为64×4d，虽然增加了两倍的计算量，但也能有效地降低分类错误率。</p> 
<p>在2019年何凯明团队开源了ResNeXt_WSL，ResNeXt_WSL是何凯明团队使用弱监督学习训练的ResNeXt，ResNeXt_WSL中的WSL就表示Weakly Supervised Learning（弱监督学习)。</p> 
<p>ResNeXt101_32×48d_WSL有8亿+的参数，是通过弱监督学习预训练的方法在Instagram数据集上训练，然后用ImageNet数据集做微调，Instagram有9.4亿张图片，没有经过特别的标注，只带着用户自己加的话题标签。<br> ResNeXt_WSL与ResNeXt是一样的结构，只是训练方式有所改变。下图是ResNeXt_WSL的训练效果。</p> 
<p><img src="https://images2.imgbox.com/51/80/J0Aa1bRR_o.jpg" alt=""></p> 
<ul><li> 
  <ol start="6"><li>参考文献<br> <a href="https://arxiv.org/pdf/1512.03385" rel="nofollow">ResNet</a></li></ol> </li></ul> 
<p><a href="https://arxiv.org/abs/1611.05431" rel="nofollow">ResNeXt</a></p> 
<p><a href="https://arxiv.org/abs/1409.4842" rel="nofollow">GoogLeNet</a></p> 
<h2><a id="3Res2Net2020_233"></a>3.Res2Net（2020）</h2> 
<p>2020年，南开大学程明明组提出了一种面向目标检测任务的新模块Res2Net。并且其论文已被TPAMI2020录用。Res2Net和ResNeXt一样，是ResNet的变体形式，只不过Res2Net不止提高了分类任务的准确率，还提高了检测任务的精度。Res2Net的新模块可以和现有其他优秀模块轻松整合，在不增加计算负载量的情况下，在ImageNet、CIFAR-100等数据集上的测试性能超过了ResNet。因为模型的残差块里又有残差连接，所以取名为Res2Net。</p> 
<h3><a id="31_Res2Net_237"></a>3.1 Res2Net模型结构</h3> 
<p><img src="https://images2.imgbox.com/a7/84/K1vOALFT_o.png" alt=""></p> 
<p>模型结构看起来很简单，将输入的特征x，split为k个特征，第i+1（i = 0， 1， 2,…,k-1) 个特征经过3×3卷积后以残差连接的方式融合到第 i+2 个特征中。这就是Res2Net的主要结构。那么这样做的目的是为什么呢？能够有什么好处呢？<br> 答案就是多尺度卷积。多尺度特征在检测任务中一直是很重要的，自从空洞卷积提出以来，基于空洞卷积搭建的多尺度金字塔模型在检测任务上取得里程碑式的效果。不同感受野下获取的物体的信息是不同的，小的感受野可能会看到更多的物体细节，对于检测小目标也有很大的好处，而大的感受野可以感受物体的整体结构，方便网络定位物体的位置，细节与位置的结合可以更好地得到具有清晰边界的物体信息，因此，结合了多尺度金字塔的模型往往能获得很好地效果。在Res2Net中，特征k2经过3×3卷积后被送入x3所在的处理流中，k2再次被3×3的卷积优化信息，两个3×3的卷积相当于一个5×5的卷积。那么，k3就想当然与融合了3×3的感受野和5×5的感受野处理后的特征。以此类推，7×7的感受野被应用在k4中。就这样，Res2Net提取多尺度特征用于检测任务，以提高模型的准确率。在这篇论文中，s是比例尺寸的控制参数，也就是可以将输入通道数平均等分为多个特征通道。s越大表明多尺度能力越强，此外一些额外的计算开销也可以忽略。</p> 
<h3><a id="32_Res2Net_247"></a>3.2 Res2Net模型实现</h3> 
<p>Res2Net与ResNet的模型结构一致，主要差别在于block的搭建，因此这里用paddle框架来实现block的代码</p> 
<pre class="set-code-hide prettyprint"><code class="prism language-python has-numbering"><span class="token keyword">class</span> <span class="token class-name">ConvBNLayer</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Layer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>
            self<span class="token punctuation">,</span>
            num_channels<span class="token punctuation">,</span>
            num_filters<span class="token punctuation">,</span>
            filter_size<span class="token punctuation">,</span>
            stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
            groups<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
            is_vd_mode<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
            act<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
            name<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>ConvBNLayer<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code><pre><code>    self&lt;span class="token punctuation"&gt;.&lt;/span&gt;is_vd_mode &lt;span class="token operator"&gt;=&lt;/span&gt; is_vd_mode
    self&lt;span class="token punctuation"&gt;.&lt;/span&gt;_pool2d_avg &lt;span class="token operator"&gt;=&lt;/span&gt; AvgPool2D&lt;span class="token punctuation"&gt;(&lt;/span&gt;
        kernel_size&lt;span class="token operator"&gt;=&lt;/span&gt;&lt;span class="token number"&gt;2&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; stride&lt;span class="token operator"&gt;=&lt;/span&gt;&lt;span class="token number"&gt;2&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; padding&lt;span class="token operator"&gt;=&lt;/span&gt;&lt;span class="token number"&gt;0&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; ceil_mode&lt;span class="token operator"&gt;=&lt;/span&gt;&lt;span class="token boolean"&gt;True&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    self&lt;span class="token punctuation"&gt;.&lt;/span&gt;_conv &lt;span class="token operator"&gt;=&lt;/span&gt; Conv2D&lt;span class="token punctuation"&gt;(&lt;/span&gt;
        in_channels&lt;span class="token operator"&gt;=&lt;/span&gt;num_channels&lt;span class="token punctuation"&gt;,&lt;/span&gt;
        out_channels&lt;span class="token operator"&gt;=&lt;/span&gt;num_filters&lt;span class="token punctuation"&gt;,&lt;/span&gt;
        kernel_size&lt;span class="token operator"&gt;=&lt;/span&gt;filter_size&lt;span class="token punctuation"&gt;,&lt;/span&gt;
        stride&lt;span class="token operator"&gt;=&lt;/span&gt;stride&lt;span class="token punctuation"&gt;,&lt;/span&gt;
        padding&lt;span class="token operator"&gt;=&lt;/span&gt;&lt;span class="token punctuation"&gt;(&lt;/span&gt;filter_size &lt;span class="token operator"&gt;-&lt;/span&gt; &lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt; &lt;span class="token operator"&gt;//&lt;/span&gt; &lt;span class="token number"&gt;2&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt;
        groups&lt;span class="token operator"&gt;=&lt;/span&gt;groups&lt;span class="token punctuation"&gt;,&lt;/span&gt;
        weight_attr&lt;span class="token operator"&gt;=&lt;/span&gt;ParamAttr&lt;span class="token punctuation"&gt;(&lt;/span&gt;name&lt;span class="token operator"&gt;=&lt;/span&gt;name &lt;span class="token operator"&gt;+&lt;/span&gt; &lt;span class="token string"&gt;"_weights"&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt;
        bias_attr&lt;span class="token operator"&gt;=&lt;/span&gt;&lt;span class="token boolean"&gt;False&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    &lt;span class="token keyword"&gt;if&lt;/span&gt; name &lt;span class="token operator"&gt;==&lt;/span&gt; &lt;span class="token string"&gt;"conv1"&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;
        bn_name &lt;span class="token operator"&gt;=&lt;/span&gt; &lt;span class="token string"&gt;"bn_"&lt;/span&gt; &lt;span class="token operator"&gt;+&lt;/span&gt; name
    &lt;span class="token keyword"&gt;else&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;
        bn_name &lt;span class="token operator"&gt;=&lt;/span&gt; &lt;span class="token string"&gt;"bn"&lt;/span&gt; &lt;span class="token operator"&gt;+&lt;/span&gt; name&lt;span class="token punctuation"&gt;[&lt;/span&gt;&lt;span class="token number"&gt;3&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;&lt;span class="token punctuation"&gt;]&lt;/span&gt;
    self&lt;span class="token punctuation"&gt;.&lt;/span&gt;_batch_norm &lt;span class="token operator"&gt;=&lt;/span&gt; BatchNorm&lt;span class="token punctuation"&gt;(&lt;/span&gt;
        num_filters&lt;span class="token punctuation"&gt;,&lt;/span&gt;
        act&lt;span class="token operator"&gt;=&lt;/span&gt;act&lt;span class="token punctuation"&gt;,&lt;/span&gt;
        param_attr&lt;span class="token operator"&gt;=&lt;/span&gt;ParamAttr&lt;span class="token punctuation"&gt;(&lt;/span&gt;name&lt;span class="token operator"&gt;=&lt;/span&gt;bn_name &lt;span class="token operator"&gt;+&lt;/span&gt; &lt;span class="token string"&gt;'_scale'&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt;
        bias_attr&lt;span class="token operator"&gt;=&lt;/span&gt;ParamAttr&lt;span class="token punctuation"&gt;(&lt;/span&gt;bn_name &lt;span class="token operator"&gt;+&lt;/span&gt; &lt;span class="token string"&gt;'_offset'&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt;
        moving_mean_name&lt;span class="token operator"&gt;=&lt;/span&gt;bn_name &lt;span class="token operator"&gt;+&lt;/span&gt; &lt;span class="token string"&gt;'_mean'&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt;
        moving_variance_name&lt;span class="token operator"&gt;=&lt;/span&gt;bn_name &lt;span class="token operator"&gt;+&lt;/span&gt; &lt;span class="token string"&gt;'_variance'&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;

&lt;span class="token keyword"&gt;def&lt;/span&gt; &lt;span class="token function"&gt;forward&lt;/span&gt;&lt;span class="token punctuation"&gt;(&lt;/span&gt;self&lt;span class="token punctuation"&gt;,&lt;/span&gt; inputs&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;
    &lt;span class="token keyword"&gt;if&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;is_vd_mode&lt;span class="token punctuation"&gt;:&lt;/span&gt;
        inputs &lt;span class="token operator"&gt;=&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;_pool2d_avg&lt;span class="token punctuation"&gt;(&lt;/span&gt;inputs&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    y &lt;span class="token operator"&gt;=&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;_conv&lt;span class="token punctuation"&gt;(&lt;/span&gt;inputs&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    y &lt;span class="token operator"&gt;=&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;_batch_norm&lt;span class="token punctuation"&gt;(&lt;/span&gt;y&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    &lt;span class="token keyword"&gt;return&lt;/span&gt; y
</code></pre>
</pre> 
<p><span class="token keyword">class</span> <span class="token class-name">BottleneckBlock</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Layer<span class="token punctuation">)</span><span class="token punctuation">:</span><br> <span class="token keyword">def</span> <span class="token function"><strong>init</strong></span><span class="token punctuation">(</span>self<span class="token punctuation">,</span><br> num_channels1<span class="token punctuation">,</span><br> num_channels2<span class="token punctuation">,</span><br> num_filters<span class="token punctuation">,</span><br> stride<span class="token punctuation">,</span><br> scales<span class="token punctuation">,</span><br> shortcut<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span><br> if_first<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span><br> name<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span><br> <span class="token builtin">super</span><span class="token punctuation">(</span>BottleneckBlock<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span><strong>init</strong><span class="token punctuation">(</span><span class="token punctuation">)</span><br> self<span class="token punctuation">.</span>stride <span class="token operator">=</span> stride<br> self<span class="token punctuation">.</span>scales <span class="token operator">=</span> scales<br> self<span class="token punctuation">.</span>conv0 <span class="token operator">=</span> ConvBNLayer<span class="token punctuation">(</span><br> num_channels<span class="token operator">=</span>num_channels1<span class="token punctuation">,</span><br> num_filters<span class="token operator">=</span>num_filters<span class="token punctuation">,</span><br> filter_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span><br> act<span class="token operator">=</span><span class="token string">‘relu’</span><span class="token punctuation">,</span><br> name<span class="token operator">=</span>name <span class="token operator">+</span> <span class="token string">“_branch2a”</span><span class="token punctuation">)</span><br> self<span class="token punctuation">.</span>conv1_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><br> <span class="token keyword">for</span> s <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>scales <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span><br> conv1 <span class="token operator">=</span> self<span class="token punctuation">.</span>add_sublayer<span class="token punctuation">(</span><br> name <span class="token operator">+</span> <span class="token string">‘<em>branch2b</em>’</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>s <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br> ConvBNLayer<span class="token punctuation">(</span><br> num_channels<span class="token operator">=</span>num_filters <span class="token operator">//</span> scales<span class="token punctuation">,</span><br> num_filters<span class="token operator">=</span>num_filters <span class="token operator">//</span> scales<span class="token punctuation">,</span><br> filter_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span><br> stride<span class="token operator">=</span>stride<span class="token punctuation">,</span><br> act<span class="token operator">=</span><span class="token string">‘relu’</span><span class="token punctuation">,</span><br> name<span class="token operator">=</span>name <span class="token operator">+</span> <span class="token string">‘<em>branch2b</em>’</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>s <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br> self<span class="token punctuation">.</span>conv1_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>conv1<span class="token punctuation">)</span><br> self<span class="token punctuation">.</span>pool2d_avg <span class="token operator">=</span> AvgPool2D<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span>stride<span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span></p> 
<pre><code>    self&lt;span class="token punctuation"&gt;.&lt;/span&gt;conv2 &lt;span class="token operator"&gt;=&lt;/span&gt; ConvBNLayer&lt;span class="token punctuation"&gt;(&lt;/span&gt;
        num_channels&lt;span class="token operator"&gt;=&lt;/span&gt;num_filters&lt;span class="token punctuation"&gt;,&lt;/span&gt;
        num_filters&lt;span class="token operator"&gt;=&lt;/span&gt;num_channels2&lt;span class="token punctuation"&gt;,&lt;/span&gt;
        filter_size&lt;span class="token operator"&gt;=&lt;/span&gt;&lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt;
        act&lt;span class="token operator"&gt;=&lt;/span&gt;&lt;span class="token boolean"&gt;None&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt;
        name&lt;span class="token operator"&gt;=&lt;/span&gt;name &lt;span class="token operator"&gt;+&lt;/span&gt; &lt;span class="token string"&gt;"_branch2c"&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;

    &lt;span class="token keyword"&gt;if&lt;/span&gt; &lt;span class="token keyword"&gt;not&lt;/span&gt; shortcut&lt;span class="token punctuation"&gt;:&lt;/span&gt;
        self&lt;span class="token punctuation"&gt;.&lt;/span&gt;short &lt;span class="token operator"&gt;=&lt;/span&gt; ConvBNLayer&lt;span class="token punctuation"&gt;(&lt;/span&gt;
            num_channels&lt;span class="token operator"&gt;=&lt;/span&gt;num_channels1&lt;span class="token punctuation"&gt;,&lt;/span&gt;
            num_filters&lt;span class="token operator"&gt;=&lt;/span&gt;num_channels2&lt;span class="token punctuation"&gt;,&lt;/span&gt;
            filter_size&lt;span class="token operator"&gt;=&lt;/span&gt;&lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt;
            stride&lt;span class="token operator"&gt;=&lt;/span&gt;&lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt;
            is_vd_mode&lt;span class="token operator"&gt;=&lt;/span&gt;&lt;span class="token boolean"&gt;False&lt;/span&gt; &lt;span class="token keyword"&gt;if&lt;/span&gt; if_first &lt;span class="token keyword"&gt;else&lt;/span&gt; &lt;span class="token boolean"&gt;True&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt;
            name&lt;span class="token operator"&gt;=&lt;/span&gt;name &lt;span class="token operator"&gt;+&lt;/span&gt; &lt;span class="token string"&gt;"_branch1"&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;

    self&lt;span class="token punctuation"&gt;.&lt;/span&gt;shortcut &lt;span class="token operator"&gt;=&lt;/span&gt; shortcut

&lt;span class="token keyword"&gt;def&lt;/span&gt; &lt;span class="token function"&gt;forward&lt;/span&gt;&lt;span class="token punctuation"&gt;(&lt;/span&gt;self&lt;span class="token punctuation"&gt;,&lt;/span&gt; inputs&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;
    y &lt;span class="token operator"&gt;=&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;conv0&lt;span class="token punctuation"&gt;(&lt;/span&gt;inputs&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    xs &lt;span class="token operator"&gt;=&lt;/span&gt; paddle&lt;span class="token punctuation"&gt;.&lt;/span&gt;split&lt;span class="token punctuation"&gt;(&lt;/span&gt;y&lt;span class="token punctuation"&gt;,&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;scales&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    ys &lt;span class="token operator"&gt;=&lt;/span&gt; &lt;span class="token punctuation"&gt;[&lt;/span&gt;&lt;span class="token punctuation"&gt;]&lt;/span&gt;
    &lt;span class="token keyword"&gt;for&lt;/span&gt; s&lt;span class="token punctuation"&gt;,&lt;/span&gt; conv1 &lt;span class="token keyword"&gt;in&lt;/span&gt; &lt;span class="token builtin"&gt;enumerate&lt;/span&gt;&lt;span class="token punctuation"&gt;(&lt;/span&gt;self&lt;span class="token punctuation"&gt;.&lt;/span&gt;conv1_list&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;
        &lt;span class="token keyword"&gt;if&lt;/span&gt; s &lt;span class="token operator"&gt;==&lt;/span&gt; &lt;span class="token number"&gt;0&lt;/span&gt; &lt;span class="token keyword"&gt;or&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;stride &lt;span class="token operator"&gt;==&lt;/span&gt; &lt;span class="token number"&gt;2&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;
            ys&lt;span class="token punctuation"&gt;.&lt;/span&gt;append&lt;span class="token punctuation"&gt;(&lt;/span&gt;conv1&lt;span class="token punctuation"&gt;(&lt;/span&gt;xs&lt;span class="token punctuation"&gt;[&lt;/span&gt;s&lt;span class="token punctuation"&gt;]&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;
        &lt;span class="token keyword"&gt;else&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;
            ys&lt;span class="token punctuation"&gt;.&lt;/span&gt;append&lt;span class="token punctuation"&gt;(&lt;/span&gt;conv1&lt;span class="token punctuation"&gt;(&lt;/span&gt;xs&lt;span class="token punctuation"&gt;[&lt;/span&gt;s&lt;span class="token punctuation"&gt;]&lt;/span&gt; &lt;span class="token operator"&gt;+&lt;/span&gt; ys&lt;span class="token punctuation"&gt;[&lt;/span&gt;&lt;span class="token operator"&gt;-&lt;/span&gt;&lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;]&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    &lt;span class="token keyword"&gt;if&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;stride &lt;span class="token operator"&gt;==&lt;/span&gt; &lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;
        ys&lt;span class="token punctuation"&gt;.&lt;/span&gt;append&lt;span class="token punctuation"&gt;(&lt;/span&gt;xs&lt;span class="token punctuation"&gt;[&lt;/span&gt;&lt;span class="token operator"&gt;-&lt;/span&gt;&lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;]&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    &lt;span class="token keyword"&gt;else&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;
        ys&lt;span class="token punctuation"&gt;.&lt;/span&gt;append&lt;span class="token punctuation"&gt;(&lt;/span&gt;self&lt;span class="token punctuation"&gt;.&lt;/span&gt;pool2d_avg&lt;span class="token punctuation"&gt;(&lt;/span&gt;xs&lt;span class="token punctuation"&gt;[&lt;/span&gt;&lt;span class="token operator"&gt;-&lt;/span&gt;&lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;]&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    conv1 &lt;span class="token operator"&gt;=&lt;/span&gt; paddle&lt;span class="token punctuation"&gt;.&lt;/span&gt;concat&lt;span class="token punctuation"&gt;(&lt;/span&gt;ys&lt;span class="token punctuation"&gt;,&lt;/span&gt; axis&lt;span class="token operator"&gt;=&lt;/span&gt;&lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    conv2 &lt;span class="token operator"&gt;=&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;conv2&lt;span class="token punctuation"&gt;(&lt;/span&gt;conv1&lt;span class="token punctuation"&gt;)&lt;/span&gt;

    &lt;span class="token keyword"&gt;if&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;shortcut&lt;span class="token punctuation"&gt;:&lt;/span&gt;
        short &lt;span class="token operator"&gt;=&lt;/span&gt; inputs
    &lt;span class="token keyword"&gt;else&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;
        short &lt;span class="token operator"&gt;=&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;short&lt;span class="token punctuation"&gt;(&lt;/span&gt;inputs&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    y &lt;span class="token operator"&gt;=&lt;/span&gt; paddle&lt;span class="token punctuation"&gt;.&lt;/span&gt;add&lt;span class="token punctuation"&gt;(&lt;/span&gt;x&lt;span class="token operator"&gt;=&lt;/span&gt;short&lt;span class="token punctuation"&gt;,&lt;/span&gt; y&lt;span class="token operator"&gt;=&lt;/span&gt;conv2&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    y &lt;span class="token operator"&gt;=&lt;/span&gt; F&lt;span class="token punctuation"&gt;.&lt;/span&gt;relu&lt;span class="token punctuation"&gt;(&lt;/span&gt;y&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    &lt;span class="token keyword"&gt;return&lt;/span&gt; y
</code></pre> 
<div class="hljs-button {2}"></div> 
<div class="hide-preCode-box"> 
 <span class="hide-preCode-bt"><img class="look-more-preCode contentImg-no-view" src="https://images2.imgbox.com/33/67/njvbFxcA_o.png" alt="" title=""></span> 
</div> 
<ul class="pre-numbering"><li>1</li><li>2</li><li>3</li><li>4</li><li>5</li><li>6</li><li>7</li><li>8</li><li>9</li><li>10</li><li>11</li><li>12</li><li>13</li><li>14</li><li>15</li><li>16</li><li>17</li><li>18</li><li>19</li><li>20</li><li>21</li><li>22</li><li>23</li><li>24</li><li>25</li><li>26</li><li>27</li><li>28</li><li>29</li><li>30</li><li>31</li><li>32</li><li>33</li><li>34</li><li>35</li><li>36</li><li>37</li><li>38</li><li>39</li><li>40</li><li>41</li><li>42</li><li>43</li><li>44</li><li>45</li><li>46</li><li>47</li><li>48</li><li>49</li><li>50</li><li>51</li><li>52</li><li>53</li><li>54</li><li>55</li><li>56</li><li>57</li><li>58</li><li>59</li><li>60</li><li>61</li><li>62</li><li>63</li><li>64</li><li>65</li><li>66</li><li>67</li><li>68</li><li>69</li><li>70</li><li>71</li><li>72</li><li>73</li><li>74</li><li>75</li><li>76</li><li>77</li><li>78</li><li>79</li><li>80</li><li>81</li><li>82</li><li>83</li><li>84</li><li>85</li><li>86</li><li>87</li><li>88</li><li>89</li><li>90</li><li>91</li><li>92</li><li>93</li><li>94</li><li>95</li><li>96</li><li>97</li><li>98</li><li>99</li><li>100</li><li>101</li><li>102</li><li>103</li><li>104</li><li>105</li><li>106</li><li>107</li><li>108</li><li>109</li><li>110</li><li>111</li><li>112</li><li>113</li><li>114</li><li>115</li><li>116</li><li>117</li><li>118</li><li>119</li></ul> 
<h3><a id="33__370"></a>3.3 模型特点</h3> 
<ol><li>可与其他结构整合，如SENEt， ResNeXt， DLA等，从而增加准确率。</li><li>计算负载不增加，特征提取能力更强大。</li></ol> 
<h3><a id="34__374"></a>3.4 模型指标</h3> 
<p>ImageNet分类效果如下图</p> 
<p><img src="https://images2.imgbox.com/60/b6/1dY1oYLD_o.png" alt=""></p> 
<p>Res2Net-50就是对标ResNet50的版本。</p> 
<p>Res2Net-50-299指的是将输入图片裁剪到299×299进行预测的Res2Net-50，因为一般都是裁剪或者resize到224×224。</p> 
<p>Res2NeXt-50为融合了ResNeXt的Res2Net-50。</p> 
<p>Res2Net-DLA-60指的是融合了DLA-60的Res2Net-50。</p> 
<p>Res2NeXt-DLA-60为融合了ResNeXt和DLA-60的Res2Net-50。</p> 
<p>SE-Res2Net-50 为融合了SENet的Res2Net-50。</p> 
<p>blRes2Net-50为融合了Big-Little Net的Res2Net-50。</p> 
<p>Res2Net-v1b-50为采取和ResNet-vd-50一样的处理方法的Res2Net-50。</p> 
<p>Res2Net-200-SSLD为Paddle使用简单的半监督标签知识蒸馏（SSLD，Simple Semi-supervised Label Distillation）的方法来提升模型效果得到的。</p> 
<p>可见，Res2Net都取得了十分不错的成绩。</p> 
<p>COCO数据集效果如下图</p> 
<p><img src="https://images2.imgbox.com/46/ff/aDDkKUJd_o.png" alt=""></p> 
<p>Res2Net-50的各种配置都比ResNet-50高。</p> 
<p>显著目标检测数据集指标效果如下图</p> 
<p><img src="https://images2.imgbox.com/78/56/Gu8EpgAY_o.png" alt=""></p> 
<p>ECSSD、PASCAL-S、DUT-OMRON、HKU-IS都是显著目标检测任务中现在最为常用的测试集，显著目标检测任务的目的就是分割出图片中的显著物体，并用白色像素点表示，其他背景用黑色像素点表示。从图中可以看出来，使用Res2Net作为骨干网络，效果比ResNet有了很大的提升。</p> 
<ul><li>参考文献<br> <a href="https://arxiv.org/pdf/1904.01169.pdf" rel="nofollow">Res2Net</a></li></ul> 
<h2><a id="4Swin_Trasnformer2021_423"></a>4.Swin Trasnformer（2021）</h2> 
<p>Swin Transformer是由微软亚洲研究院在今年公布的一篇利用transformer架构处理计算机视觉任务的论文。Swin Transformer 在图像分类，图像分割，目标检测等各个领域已经屠榜，在论文中，作者分析表明，Transformer从NLP迁移到CV上没有大放异彩主要有两点原因：1. 两个领域涉及的scale不同，NLP的token是标准固定的大小，而CV的特征尺度变化范围非常大。2. CV比起NLP需要更大的分辨率，而且CV中使用Transformer的计算复杂度是图像尺度的平方，这会导致计算量过于庞大。为了解决这两个问题，Swin Transformer相比之前的ViT做了两个改进：1.引入CNN中常用的层次化构建方式构建层次化Transformer 2.引入locality思想，对无重合的window区域内进行self-attention计算。另外，Swin Transformer可以作为图像分类、目标检测和语义分割等任务的通用骨干网络，可以说，Swin Transformer可能是CNN的完美替代方案。</p> 
<h3><a id="41_Swin_Trasnformer_427"></a>4.1 Swin Trasnformer模型结构</h3> 
<p>下图为Swin Transformer与ViT在处理图片方式上的对比，可以看出，Swin Transformer有着ResNet一样的残差结构和CNN具有的多尺度图片结构。</p> 
<p><img src="https://images2.imgbox.com/d1/31/aYgNJDkz_o.jpg" alt=""></p> 
<p>整体概括：</p> 
<p>下图为Swin Transformer的网络结构，输入的图像先经过一层卷积进行patch映射，将图像先分割成4 × 4的小块，图片是224×224输入，那么就是56个path块，如果是384×384的尺寸，则是96个path块。这里以224 × 224的输入为例，输入图像经过这一步操作，每个patch的特征维度为4x4x3=48的特征图。因此，输入的图像变成了H/4×W/4×48的特征图。然后，特征图开始输入到stage1，stage1中linear embedding将path特征维度变成C，因此变成了H/4×W/4×C。然后送入Swin Transformer Block，在进入stage2前，接下来先通过Patch Merging操作，Patch Merging和CNN中stride=2的1×1卷积十分相似，Patch Merging在每个Stage开始前做降采样，用于缩小分辨率，调整通道数，当H/4×W/4×C的特征图输送到Patch Merging，将输入按照2x2的相邻patches合并，这样子patch块的数量就变成了H/8 x W/8，特征维度就变成了4C，之后经过一个MLP，将特征维度降为2C。因此变为H/8×W/8×2C。接下来的stage就是重复上面的过程。</p> 
<p><img src="https://images2.imgbox.com/9b/11/7BqiSgJG_o.jpg" alt=""></p> 
<p>每步细说：</p> 
<p>Linear embedding</p> 
<p>下面用Paddle代码逐步讲解Swin Transformer的架构。 以下代码为Linear embedding的操作，整个操作可以看作一个patch大小的卷积核和patch大小的步长的卷积对输入的B，C，H，W的图片进行卷积，得到的自然就是大小为 B，C，H/patch，W/patch的特征图，如果放在第一个Linear embedding中，得到的特征图就为 B，96，56，56的大小。Paddle核心代码如下。</p> 
<pre class="set-code-hide prettyprint"><code class="prism language-python has-numbering"><span class="token keyword">class</span> <span class="token class-name">PatchEmbed</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Layer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">""" Image to Patch Embedding
    Args:
        img_size (int): Image size.  Default: 224.
        patch_size (int): Patch token size. Default: 4.
        in_chans (int): Number of input image channels. Default: 3.
        embed_dim (int): Number of linear projection output channels. Default: 96.
        norm_layer (nn.Layer, optional): Normalization layer. Default: None
    """</span>
</code><pre><code>&lt;span class="token keyword"&gt;def&lt;/span&gt; &lt;span class="token function"&gt;__init__&lt;/span&gt;&lt;span class="token punctuation"&gt;(&lt;/span&gt;self&lt;span class="token punctuation"&gt;,&lt;/span&gt;
             img_size&lt;span class="token operator"&gt;=&lt;/span&gt;&lt;span class="token number"&gt;224&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt;
             patch_size&lt;span class="token operator"&gt;=&lt;/span&gt;&lt;span class="token number"&gt;4&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt;
             in_chans&lt;span class="token operator"&gt;=&lt;/span&gt;&lt;span class="token number"&gt;3&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt;
             embed_dim&lt;span class="token operator"&gt;=&lt;/span&gt;&lt;span class="token number"&gt;96&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt;
             norm_layer&lt;span class="token operator"&gt;=&lt;/span&gt;&lt;span class="token boolean"&gt;None&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;
    &lt;span class="token builtin"&gt;super&lt;/span&gt;&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;.&lt;/span&gt;__init__&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    img_size &lt;span class="token operator"&gt;=&lt;/span&gt; to_2tuple&lt;span class="token punctuation"&gt;(&lt;/span&gt;img_size&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    patch_size &lt;span class="token operator"&gt;=&lt;/span&gt; to_2tuple&lt;span class="token punctuation"&gt;(&lt;/span&gt;patch_size&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    patches_resolution &lt;span class="token operator"&gt;=&lt;/span&gt; &lt;span class="token punctuation"&gt;[&lt;/span&gt;
        img_size&lt;span class="token punctuation"&gt;[&lt;/span&gt;&lt;span class="token number"&gt;0&lt;/span&gt;&lt;span class="token punctuation"&gt;]&lt;/span&gt; &lt;span class="token operator"&gt;//&lt;/span&gt; patch_size&lt;span class="token punctuation"&gt;[&lt;/span&gt;&lt;span class="token number"&gt;0&lt;/span&gt;&lt;span class="token punctuation"&gt;]&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; img_size&lt;span class="token punctuation"&gt;[&lt;/span&gt;&lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;]&lt;/span&gt; &lt;span class="token operator"&gt;//&lt;/span&gt; patch_size&lt;span class="token punctuation"&gt;[&lt;/span&gt;&lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;]&lt;/span&gt;
    &lt;span class="token punctuation"&gt;]&lt;/span&gt;
    self&lt;span class="token punctuation"&gt;.&lt;/span&gt;img_size &lt;span class="token operator"&gt;=&lt;/span&gt; img_size
    self&lt;span class="token punctuation"&gt;.&lt;/span&gt;patch_size &lt;span class="token operator"&gt;=&lt;/span&gt; patch_size
    self&lt;span class="token punctuation"&gt;.&lt;/span&gt;patches_resolution &lt;span class="token operator"&gt;=&lt;/span&gt; patches_resolution
    self&lt;span class="token punctuation"&gt;.&lt;/span&gt;num_patches &lt;span class="token operator"&gt;=&lt;/span&gt; patches_resolution&lt;span class="token punctuation"&gt;[&lt;/span&gt;&lt;span class="token number"&gt;0&lt;/span&gt;&lt;span class="token punctuation"&gt;]&lt;/span&gt; &lt;span class="token operator"&gt;*&lt;/span&gt; patches_resolution&lt;span class="token punctuation"&gt;[&lt;/span&gt;&lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;]&lt;/span&gt; &lt;span class="token comment"&gt;#patch个数&lt;/span&gt;

    self&lt;span class="token punctuation"&gt;.&lt;/span&gt;in_chans &lt;span class="token operator"&gt;=&lt;/span&gt; in_chans
    self&lt;span class="token punctuation"&gt;.&lt;/span&gt;embed_dim &lt;span class="token operator"&gt;=&lt;/span&gt; embed_dim

    self&lt;span class="token punctuation"&gt;.&lt;/span&gt;proj &lt;span class="token operator"&gt;=&lt;/span&gt; nn&lt;span class="token punctuation"&gt;.&lt;/span&gt;Conv2D&lt;span class="token punctuation"&gt;(&lt;/span&gt;
        in_chans&lt;span class="token punctuation"&gt;,&lt;/span&gt; embed_dim&lt;span class="token punctuation"&gt;,&lt;/span&gt; kernel_size&lt;span class="token operator"&gt;=&lt;/span&gt;patch_size&lt;span class="token punctuation"&gt;,&lt;/span&gt; stride&lt;span class="token operator"&gt;=&lt;/span&gt;patch_size&lt;span class="token punctuation"&gt;)&lt;/span&gt; &lt;span class="token comment"&gt;#将stride和kernel_size设置为patch_size大小&lt;/span&gt;
    &lt;span class="token keyword"&gt;if&lt;/span&gt; norm_layer &lt;span class="token keyword"&gt;is&lt;/span&gt; &lt;span class="token keyword"&gt;not&lt;/span&gt; &lt;span class="token boolean"&gt;None&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;
        self&lt;span class="token punctuation"&gt;.&lt;/span&gt;norm &lt;span class="token operator"&gt;=&lt;/span&gt; norm_layer&lt;span class="token punctuation"&gt;(&lt;/span&gt;embed_dim&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    &lt;span class="token keyword"&gt;else&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;
        self&lt;span class="token punctuation"&gt;.&lt;/span&gt;norm &lt;span class="token operator"&gt;=&lt;/span&gt; &lt;span class="token boolean"&gt;None&lt;/span&gt;

&lt;span class="token keyword"&gt;def&lt;/span&gt; &lt;span class="token function"&gt;forward&lt;/span&gt;&lt;span class="token punctuation"&gt;(&lt;/span&gt;self&lt;span class="token punctuation"&gt;,&lt;/span&gt; x&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;
    B&lt;span class="token punctuation"&gt;,&lt;/span&gt; C&lt;span class="token punctuation"&gt;,&lt;/span&gt; H&lt;span class="token punctuation"&gt;,&lt;/span&gt; W &lt;span class="token operator"&gt;=&lt;/span&gt; x&lt;span class="token punctuation"&gt;.&lt;/span&gt;shape
    
    x &lt;span class="token operator"&gt;=&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;proj&lt;span class="token punctuation"&gt;(&lt;/span&gt;x&lt;span class="token punctuation"&gt;)&lt;/span&gt; &lt;span class="token comment"&gt;# B, 96, H/4, W4 &lt;/span&gt;

    x &lt;span class="token operator"&gt;=&lt;/span&gt; x&lt;span class="token punctuation"&gt;.&lt;/span&gt;flatten&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token number"&gt;2&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;.&lt;/span&gt;transpose&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token punctuation"&gt;[&lt;/span&gt;&lt;span class="token number"&gt;0&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token number"&gt;2&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;]&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;  &lt;span class="token comment"&gt;# B Ph*Pw 96&lt;/span&gt;
    &lt;span class="token keyword"&gt;if&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;norm &lt;span class="token keyword"&gt;is&lt;/span&gt; &lt;span class="token keyword"&gt;not&lt;/span&gt; &lt;span class="token boolean"&gt;None&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;
        x &lt;span class="token operator"&gt;=&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;norm&lt;span class="token punctuation"&gt;(&lt;/span&gt;x&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    &lt;span class="token keyword"&gt;return&lt;/span&gt; x
</code></pre>
</pre> 
<div class="hljs-button {2}"></div> 
<div class="hide-preCode-box"> 
 <span class="hide-preCode-bt"><img class="look-more-preCode contentImg-no-view" src="https://images2.imgbox.com/f6/e8/YMP2iHw6_o.png" alt="" title=""></span> 
</div> 
<ul class="pre-numbering"><li>1</li><li>2</li><li>3</li><li>4</li><li>5</li><li>6</li><li>7</li><li>8</li><li>9</li><li>10</li><li>11</li><li>12</li><li>13</li><li>14</li><li>15</li><li>16</li><li>17</li><li>18</li><li>19</li><li>20</li><li>21</li><li>22</li><li>23</li><li>24</li><li>25</li><li>26</li><li>27</li><li>28</li><li>29</li><li>30</li><li>31</li><li>32</li><li>33</li><li>34</li><li>35</li><li>36</li><li>37</li><li>38</li><li>39</li><li>40</li><li>41</li><li>42</li><li>43</li><li>44</li><li>45</li><li>46</li></ul> 
<p>Patch Merging</p> 
<p>以下为PatchMerging的操作。该操作以2为步长，对输入的图片进行采样，总共得到4张下采样的特征图，H和W降低2倍，因此，通道级拼接后得到的是B，4C，H/2，W/2的特征图。然而这样的拼接不能够提取有用的特征信息，于是，一个线性层将4C的通道筛选为2C, 特征图变为了B，2C， H/2， W/2。细细体会可以发现，该操作像极了<br> 卷积常用的Pooling操作和步长为2的卷积操作。Poling用于下采样，步长为2的卷积同样可以下采样，另外还起到了特征筛选的效果。总结一下，经过这个操作原本B，C，H，W的特征图就变为了B，2C，H/2，W/2的特征图，完成了下采样操作。</p> 
<pre class="set-code-hide prettyprint"><code class="prism language-python has-numbering"><span class="token keyword">class</span> <span class="token class-name">PatchMerging</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Layer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">r""" Patch Merging Layer.
    Args:
        input_resolution (tuple[int]): Resolution of input feature.
        dim (int): Number of input channels.
        norm_layer (nn.Layer, optional): Normalization layer.  Default: nn.LayerNorm
    """</span>
</code><pre><code>&lt;span class="token keyword"&gt;def&lt;/span&gt; &lt;span class="token function"&gt;__init__&lt;/span&gt;&lt;span class="token punctuation"&gt;(&lt;/span&gt;self&lt;span class="token punctuation"&gt;,&lt;/span&gt; input_resolution&lt;span class="token punctuation"&gt;,&lt;/span&gt; dim&lt;span class="token punctuation"&gt;,&lt;/span&gt; norm_layer&lt;span class="token operator"&gt;=&lt;/span&gt;nn&lt;span class="token punctuation"&gt;.&lt;/span&gt;LayerNorm&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;
    &lt;span class="token builtin"&gt;super&lt;/span&gt;&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;.&lt;/span&gt;__init__&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    self&lt;span class="token punctuation"&gt;.&lt;/span&gt;input_resolution &lt;span class="token operator"&gt;=&lt;/span&gt; input_resolution
    self&lt;span class="token punctuation"&gt;.&lt;/span&gt;dim &lt;span class="token operator"&gt;=&lt;/span&gt; dim
    self&lt;span class="token punctuation"&gt;.&lt;/span&gt;reduction &lt;span class="token operator"&gt;=&lt;/span&gt; nn&lt;span class="token punctuation"&gt;.&lt;/span&gt;Linear&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token number"&gt;4&lt;/span&gt; &lt;span class="token operator"&gt;*&lt;/span&gt; dim&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token number"&gt;2&lt;/span&gt; &lt;span class="token operator"&gt;*&lt;/span&gt; dim&lt;span class="token punctuation"&gt;,&lt;/span&gt; bias_attr&lt;span class="token operator"&gt;=&lt;/span&gt;&lt;span class="token boolean"&gt;False&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    self&lt;span class="token punctuation"&gt;.&lt;/span&gt;norm &lt;span class="token operator"&gt;=&lt;/span&gt; norm_layer&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token number"&gt;4&lt;/span&gt; &lt;span class="token operator"&gt;*&lt;/span&gt; dim&lt;span class="token punctuation"&gt;)&lt;/span&gt;

&lt;span class="token keyword"&gt;def&lt;/span&gt; &lt;span class="token function"&gt;forward&lt;/span&gt;&lt;span class="token punctuation"&gt;(&lt;/span&gt;self&lt;span class="token punctuation"&gt;,&lt;/span&gt; x&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;
    &lt;span class="token triple-quoted-string string"&gt;"""
    x: B, H*W, C
    """&lt;/span&gt;
    H&lt;span class="token punctuation"&gt;,&lt;/span&gt; W &lt;span class="token operator"&gt;=&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;input_resolution
    B&lt;span class="token punctuation"&gt;,&lt;/span&gt; L&lt;span class="token punctuation"&gt;,&lt;/span&gt; C &lt;span class="token operator"&gt;=&lt;/span&gt; x&lt;span class="token punctuation"&gt;.&lt;/span&gt;shape
    &lt;span class="token keyword"&gt;assert&lt;/span&gt; L &lt;span class="token operator"&gt;==&lt;/span&gt; H &lt;span class="token operator"&gt;*&lt;/span&gt; W&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token string"&gt;"input feature has wrong size"&lt;/span&gt;
    &lt;span class="token keyword"&gt;assert&lt;/span&gt; H &lt;span class="token operator"&gt;%&lt;/span&gt; &lt;span class="token number"&gt;2&lt;/span&gt; &lt;span class="token operator"&gt;==&lt;/span&gt; &lt;span class="token number"&gt;0&lt;/span&gt; &lt;span class="token keyword"&gt;and&lt;/span&gt; W &lt;span class="token operator"&gt;%&lt;/span&gt; &lt;span class="token number"&gt;2&lt;/span&gt; &lt;span class="token operator"&gt;==&lt;/span&gt; &lt;span class="token number"&gt;0&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token string"&gt;"x size ({}*{}) are not even."&lt;/span&gt;&lt;span class="token punctuation"&gt;.&lt;/span&gt;&lt;span class="token builtin"&gt;format&lt;/span&gt;&lt;span class="token punctuation"&gt;(&lt;/span&gt;
        H&lt;span class="token punctuation"&gt;,&lt;/span&gt; W&lt;span class="token punctuation"&gt;)&lt;/span&gt;

    x &lt;span class="token operator"&gt;=&lt;/span&gt; x&lt;span class="token punctuation"&gt;.&lt;/span&gt;reshape&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token punctuation"&gt;[&lt;/span&gt;B&lt;span class="token punctuation"&gt;,&lt;/span&gt; H&lt;span class="token punctuation"&gt;,&lt;/span&gt; W&lt;span class="token punctuation"&gt;,&lt;/span&gt; C&lt;span class="token punctuation"&gt;]&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    &lt;span class="token comment"&gt;# 每次降采样是两倍，因此在行方向和列方向上，间隔2选取元素。&lt;/span&gt;
    x0 &lt;span class="token operator"&gt;=&lt;/span&gt; x&lt;span class="token punctuation"&gt;[&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token number"&gt;0&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;&lt;span class="token number"&gt;2&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token number"&gt;0&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;&lt;span class="token number"&gt;2&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token punctuation"&gt;:&lt;/span&gt;&lt;span class="token punctuation"&gt;]&lt;/span&gt;  &lt;span class="token comment"&gt;# B H/2 W/2 C&lt;/span&gt;
    x1 &lt;span class="token operator"&gt;=&lt;/span&gt; x&lt;span class="token punctuation"&gt;[&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;&lt;span class="token number"&gt;2&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token number"&gt;0&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;&lt;span class="token number"&gt;2&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token punctuation"&gt;:&lt;/span&gt;&lt;span class="token punctuation"&gt;]&lt;/span&gt;  &lt;span class="token comment"&gt;# B H/2 W/2 C&lt;/span&gt;
    x2 &lt;span class="token operator"&gt;=&lt;/span&gt; x&lt;span class="token punctuation"&gt;[&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token number"&gt;0&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;&lt;span class="token number"&gt;2&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;&lt;span class="token number"&gt;2&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token punctuation"&gt;:&lt;/span&gt;&lt;span class="token punctuation"&gt;]&lt;/span&gt;  &lt;span class="token comment"&gt;# B H/2 W/2 C&lt;/span&gt;
    x3 &lt;span class="token operator"&gt;=&lt;/span&gt; x&lt;span class="token punctuation"&gt;[&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;&lt;span class="token number"&gt;2&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;&lt;span class="token number"&gt;2&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token punctuation"&gt;:&lt;/span&gt;&lt;span class="token punctuation"&gt;]&lt;/span&gt;  &lt;span class="token comment"&gt;# B H/2 W/2 C&lt;/span&gt;
    &lt;span class="token comment"&gt;# 拼接在一起作为一整个张量，展开。通道维度会变成原先的4倍（因为H,W各缩小2倍）&lt;/span&gt;
    x &lt;span class="token operator"&gt;=&lt;/span&gt; paddle&lt;span class="token punctuation"&gt;.&lt;/span&gt;concat&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token punctuation"&gt;[&lt;/span&gt;x0&lt;span class="token punctuation"&gt;,&lt;/span&gt; x1&lt;span class="token punctuation"&gt;,&lt;/span&gt; x2&lt;span class="token punctuation"&gt;,&lt;/span&gt; x3&lt;span class="token punctuation"&gt;]&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token operator"&gt;-&lt;/span&gt;&lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;  &lt;span class="token comment"&gt;# B H/2 W/2 4*C&lt;/span&gt;
    x &lt;span class="token operator"&gt;=&lt;/span&gt; x&lt;span class="token punctuation"&gt;.&lt;/span&gt;reshape&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token punctuation"&gt;[&lt;/span&gt;B&lt;span class="token punctuation"&gt;,&lt;/span&gt; H &lt;span class="token operator"&gt;*&lt;/span&gt; W &lt;span class="token operator"&gt;//&lt;/span&gt; &lt;span class="token number"&gt;4&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token number"&gt;4&lt;/span&gt; &lt;span class="token operator"&gt;*&lt;/span&gt; C&lt;span class="token punctuation"&gt;]&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;  &lt;span class="token comment"&gt;# B H/2*W/2 4*C &lt;/span&gt;

    x &lt;span class="token operator"&gt;=&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;norm&lt;span class="token punctuation"&gt;(&lt;/span&gt;x&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    &lt;span class="token comment"&gt;# 通过一个全连接层再调整通道维度为原来的两倍&lt;/span&gt;
    x &lt;span class="token operator"&gt;=&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;reduction&lt;span class="token punctuation"&gt;(&lt;/span&gt;x&lt;span class="token punctuation"&gt;)&lt;/span&gt;

    &lt;span class="token keyword"&gt;return&lt;/span&gt; x
</code></pre>
</pre> 
<div class="hljs-button {2}"></div> 
<div class="hide-preCode-box"> 
 <span class="hide-preCode-bt"><img class="look-more-preCode contentImg-no-view" src="https://images2.imgbox.com/89/f6/eqC5sW6y_o.png" alt="" title=""></span> 
</div> 
<ul class="pre-numbering"><li>1</li><li>2</li><li>3</li><li>4</li><li>5</li><li>6</li><li>7</li><li>8</li><li>9</li><li>10</li><li>11</li><li>12</li><li>13</li><li>14</li><li>15</li><li>16</li><li>17</li><li>18</li><li>19</li><li>20</li><li>21</li><li>22</li><li>23</li><li>24</li><li>25</li><li>26</li><li>27</li><li>28</li><li>29</li><li>30</li><li>31</li><li>32</li><li>33</li><li>34</li><li>35</li><li>36</li><li>37</li><li>38</li><li>39</li><li>40</li></ul> 
<p>Swin Transformer Block：</p> 
<p>下面的操作是根据window_size划分特征图的操作和还原的操作，原理很简单就是并排划分即可。</p> 
<pre class="set-code-hide prettyprint"><code class="prism language-python has-numbering"><span class="token keyword">def</span> <span class="token function">window_partition</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> window_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token string">""</span>"
    Args<span class="token punctuation">:</span>
        x<span class="token punctuation">:</span> <span class="token punctuation">(</span>B<span class="token punctuation">,</span> H<span class="token punctuation">,</span> W<span class="token punctuation">,</span> C<span class="token punctuation">)</span>
        window_size <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span> window size
</code><pre><code>Returns:
    windows: (num_windows*B, window_size, window_size, C)
"""&lt;/span&gt;
B&lt;span class="token punctuation"&gt;,&lt;/span&gt; H&lt;span class="token punctuation"&gt;,&lt;/span&gt; W&lt;span class="token punctuation"&gt;,&lt;/span&gt; C &lt;span class="token operator"&gt;=&lt;/span&gt; x&lt;span class="token punctuation"&gt;.&lt;/span&gt;shape
x &lt;span class="token operator"&gt;=&lt;/span&gt; x&lt;span class="token punctuation"&gt;.&lt;/span&gt;reshape&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token punctuation"&gt;[&lt;/span&gt;B&lt;span class="token punctuation"&gt;,&lt;/span&gt; H &lt;span class="token operator"&gt;//&lt;/span&gt; window_size&lt;span class="token punctuation"&gt;,&lt;/span&gt; window_size&lt;span class="token punctuation"&gt;,&lt;/span&gt; W &lt;span class="token operator"&gt;//&lt;/span&gt; window_size&lt;span class="token punctuation"&gt;,&lt;/span&gt; window_size&lt;span class="token punctuation"&gt;,&lt;/span&gt; C&lt;span class="token punctuation"&gt;]&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;
windows &lt;span class="token operator"&gt;=&lt;/span&gt; x&lt;span class="token punctuation"&gt;.&lt;/span&gt;transpose&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token punctuation"&gt;[&lt;/span&gt;&lt;span class="token number"&gt;0&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token number"&gt;3&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token number"&gt;2&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token number"&gt;4&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token number"&gt;5&lt;/span&gt;&lt;span class="token punctuation"&gt;]&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;.&lt;/span&gt;reshape&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token punctuation"&gt;[&lt;/span&gt;&lt;span class="token operator"&gt;-&lt;/span&gt;&lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; window_size&lt;span class="token punctuation"&gt;,&lt;/span&gt; window_size&lt;span class="token punctuation"&gt;,&lt;/span&gt; C&lt;span class="token punctuation"&gt;]&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;
&lt;span class="token keyword"&gt;return&lt;/span&gt; windows
</code></pre>
</pre> 
<p><span class="token keyword">def</span> <span class="token function">window_reverse</span><span class="token punctuation">(</span>windows<span class="token punctuation">,</span> window_size<span class="token punctuation">,</span> H<span class="token punctuation">,</span> W<span class="token punctuation">)</span><span class="token punctuation">:</span><br> <span class="token triple-quoted-string string">“”"<br> Args:<br> windows: (num_windows*B, window_size, window_size, C)<br> window_size (int): Window size<br> H (int): Height of image<br> W (int): Width of image</span></p> 
<pre><code>Returns:
    x: (B, H, W, C)
"""&lt;/span&gt;
B &lt;span class="token operator"&gt;=&lt;/span&gt; &lt;span class="token builtin"&gt;int&lt;/span&gt;&lt;span class="token punctuation"&gt;(&lt;/span&gt;windows&lt;span class="token punctuation"&gt;.&lt;/span&gt;shape&lt;span class="token punctuation"&gt;[&lt;/span&gt;&lt;span class="token number"&gt;0&lt;/span&gt;&lt;span class="token punctuation"&gt;]&lt;/span&gt; &lt;span class="token operator"&gt;/&lt;/span&gt; &lt;span class="token punctuation"&gt;(&lt;/span&gt;H &lt;span class="token operator"&gt;*&lt;/span&gt; W &lt;span class="token operator"&gt;/&lt;/span&gt; window_size &lt;span class="token operator"&gt;/&lt;/span&gt; window_size&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;
x &lt;span class="token operator"&gt;=&lt;/span&gt; windows&lt;span class="token punctuation"&gt;.&lt;/span&gt;reshape&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token punctuation"&gt;[&lt;/span&gt;B&lt;span class="token punctuation"&gt;,&lt;/span&gt; H &lt;span class="token operator"&gt;//&lt;/span&gt; window_size&lt;span class="token punctuation"&gt;,&lt;/span&gt; W &lt;span class="token operator"&gt;//&lt;/span&gt; window_size&lt;span class="token punctuation"&gt;,&lt;/span&gt; window_size&lt;span class="token punctuation"&gt;,&lt;/span&gt; window_size&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token operator"&gt;-&lt;/span&gt;&lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;]&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;
x &lt;span class="token operator"&gt;=&lt;/span&gt; x&lt;span class="token punctuation"&gt;.&lt;/span&gt;transpose&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token punctuation"&gt;[&lt;/span&gt;&lt;span class="token number"&gt;0&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token number"&gt;3&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token number"&gt;2&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token number"&gt;4&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token number"&gt;5&lt;/span&gt;&lt;span class="token punctuation"&gt;]&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;.&lt;/span&gt;reshape&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token punctuation"&gt;[&lt;/span&gt;B&lt;span class="token punctuation"&gt;,&lt;/span&gt; H&lt;span class="token punctuation"&gt;,&lt;/span&gt; W&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token operator"&gt;-&lt;/span&gt;&lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;]&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;
&lt;span class="token keyword"&gt;return&lt;/span&gt; x
</code></pre> 
<div class="hljs-button {2}"></div> 
<div class="hide-preCode-box"> 
 <span class="hide-preCode-bt"><img class="look-more-preCode contentImg-no-view" src="https://images2.imgbox.com/21/02/keptSJaB_o.png" alt="" title=""></span> 
</div> 
<ul class="pre-numbering"><li>1</li><li>2</li><li>3</li><li>4</li><li>5</li><li>6</li><li>7</li><li>8</li><li>9</li><li>10</li><li>11</li><li>12</li><li>13</li><li>14</li><li>15</li><li>16</li><li>17</li><li>18</li><li>19</li><li>20</li><li>21</li><li>22</li><li>23</li><li>24</li><li>25</li><li>26</li><li>27</li><li>28</li><li>29</li><li>30</li></ul> 
<p>Swin Transformer中重要的当然是Swin Transformer Block了，下面解释一下Swin Transformer Block的原理。<br> 先看一下MLP和LN，MLP和LN为多层感知机和相对于BatchNorm的LayerNorm。原理较为简单，因此直接看paddle代码即可。</p> 
<pre class="set-code-hide prettyprint"><code class="prism language-python has-numbering"><span class="token keyword">class</span> <span class="token class-name">Mlp</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Layer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_features<span class="token punctuation">,</span> hidden_features<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> out_features<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> act_layer<span class="token operator">=</span>nn<span class="token punctuation">.</span>GELU<span class="token punctuation">,</span> drop<span class="token operator">=</span><span class="token number">0.</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        out_features <span class="token operator">=</span> out_features <span class="token keyword">or</span> in_features
        hidden_features <span class="token operator">=</span> hidden_features <span class="token keyword">or</span> in_features
        self<span class="token punctuation">.</span>fc1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_features<span class="token punctuation">,</span> hidden_features<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>act <span class="token operator">=</span> act_layer<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fc2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>hidden_features<span class="token punctuation">,</span> out_features<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>drop <span class="token operator">=</span> nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span>drop<span class="token punctuation">)</span>
</code><pre><code>&lt;span class="token keyword"&gt;def&lt;/span&gt; &lt;span class="token function"&gt;forward&lt;/span&gt;&lt;span class="token punctuation"&gt;(&lt;/span&gt;self&lt;span class="token punctuation"&gt;,&lt;/span&gt; x&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;
    x &lt;span class="token operator"&gt;=&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;fc1&lt;span class="token punctuation"&gt;(&lt;/span&gt;x&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    x &lt;span class="token operator"&gt;=&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;act&lt;span class="token punctuation"&gt;(&lt;/span&gt;x&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    x &lt;span class="token operator"&gt;=&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;drop&lt;span class="token punctuation"&gt;(&lt;/span&gt;x&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    x &lt;span class="token operator"&gt;=&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;fc2&lt;span class="token punctuation"&gt;(&lt;/span&gt;x&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    x &lt;span class="token operator"&gt;=&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;drop&lt;span class="token punctuation"&gt;(&lt;/span&gt;x&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    &lt;span class="token keyword"&gt;return&lt;/span&gt; x
</code></pre>
</pre> 
<div class="hljs-button {2}"></div> 
<div class="hide-preCode-box"> 
 <span class="hide-preCode-bt"><img class="look-more-preCode contentImg-no-view" src="https://images2.imgbox.com/a5/d2/O9rsROt4_o.png" alt="" title=""></span> 
</div> 
<ul class="pre-numbering"><li>1</li><li>2</li><li>3</li><li>4</li><li>5</li><li>6</li><li>7</li><li>8</li><li>9</li><li>10</li><li>11</li><li>12</li><li>13</li><li>14</li><li>15</li><li>16</li><li>17</li></ul> 
<p>下图就是Shifted Window based MSA是Swin Transformer的核心部分。Shifted Window based MSA包括了两部分，一个是W-MSA（窗口多头注意力），另一个就是SW-MSA（移位窗口多头自注意力）。这两个是一同出现的。</p> 
<p><img src="https://images2.imgbox.com/b7/e5/780z3p3S_o.jpg" alt=""></p> 
<p>一开始，Swin Transformer 将一张图片分割为4份，也叫4个Window，然后独立地计算每一部分的MSA。由于每一个Window都是独立的，缺少了信息之间的交流，因此作者又提出了SW-MSA的算法，即采用规则的移动窗口的方法。通过不同窗口的交互，来达到特征的信息交流。注意，这一部分是本论文的精华，想要了解的同学必须要看懂源代码</p> 
<pre class="set-code-hide prettyprint"><code class="prism language-python has-numbering"><span class="token keyword">class</span> <span class="token class-name">WindowAttention</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Layer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token string">""</span>" Window based multi<span class="token operator">-</span>head self attention <span class="token punctuation">(</span>W<span class="token operator">-</span>MSA<span class="token punctuation">)</span> module <span class="token keyword">with</span> relative position bias<span class="token punctuation">.</span>
    It supports both of shifted <span class="token keyword">and</span> non<span class="token operator">-</span>shifted window<span class="token punctuation">.</span>
</code><pre><code>Args:
    dim (int): Number of input channels.
    window_size (tuple[int]): The height and width of the window.
    num_heads (int): Number of attention heads.
    qkv_bias (bool, optional):  If True, add a learnable bias to query, key, value. Default: True
    qk_scale (float | None, optional): Override default qk scale of head_dim ** -0.5 if set
    attn_drop (float, optional): Dropout ratio of attention weight. Default: 0.0
    proj_drop (float, optional): Dropout ratio of output. Default: 0.0
"""&lt;/span&gt;

&lt;span class="token keyword"&gt;def&lt;/span&gt; &lt;span class="token function"&gt;__init__&lt;/span&gt;&lt;span class="token punctuation"&gt;(&lt;/span&gt;self&lt;span class="token punctuation"&gt;,&lt;/span&gt; dim&lt;span class="token punctuation"&gt;,&lt;/span&gt; window_size&lt;span class="token punctuation"&gt;,&lt;/span&gt; num_heads&lt;span class="token punctuation"&gt;,&lt;/span&gt; qkv_bias&lt;span class="token operator"&gt;=&lt;/span&gt;&lt;span class="token boolean"&gt;True&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; qk_scale&lt;span class="token operator"&gt;=&lt;/span&gt;&lt;span class="token boolean"&gt;None&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; attn_drop&lt;span class="token operator"&gt;=&lt;/span&gt;&lt;span class="token number"&gt;0.&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; proj_drop&lt;span class="token operator"&gt;=&lt;/span&gt;&lt;span class="token number"&gt;0.&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;

    &lt;span class="token builtin"&gt;super&lt;/span&gt;&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;.&lt;/span&gt;__init__&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    self&lt;span class="token punctuation"&gt;.&lt;/span&gt;dim &lt;span class="token operator"&gt;=&lt;/span&gt; dim
    self&lt;span class="token punctuation"&gt;.&lt;/span&gt;window_size &lt;span class="token operator"&gt;=&lt;/span&gt; window_size  &lt;span class="token comment"&gt;# Wh, Ww&lt;/span&gt;
    self&lt;span class="token punctuation"&gt;.&lt;/span&gt;num_heads &lt;span class="token operator"&gt;=&lt;/span&gt; num_heads
    head_dim &lt;span class="token operator"&gt;=&lt;/span&gt; dim &lt;span class="token operator"&gt;//&lt;/span&gt; num_heads
    self&lt;span class="token punctuation"&gt;.&lt;/span&gt;scale &lt;span class="token operator"&gt;=&lt;/span&gt; qk_scale &lt;span class="token keyword"&gt;or&lt;/span&gt; head_dim &lt;span class="token operator"&gt;**&lt;/span&gt; &lt;span class="token operator"&gt;-&lt;/span&gt;&lt;span class="token number"&gt;0.5&lt;/span&gt;

    &lt;span class="token comment"&gt;# define a parameter table of relative position bias&lt;/span&gt;
    relative_position_bias_table &lt;span class="token operator"&gt;=&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;create_parameter&lt;span class="token punctuation"&gt;(&lt;/span&gt;
        shape&lt;span class="token operator"&gt;=&lt;/span&gt;&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token number"&gt;2&lt;/span&gt; &lt;span class="token operator"&gt;*&lt;/span&gt; window_size&lt;span class="token punctuation"&gt;[&lt;/span&gt;&lt;span class="token number"&gt;0&lt;/span&gt;&lt;span class="token punctuation"&gt;]&lt;/span&gt; &lt;span class="token operator"&gt;-&lt;/span&gt; &lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt; &lt;span class="token operator"&gt;*&lt;/span&gt; &lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token number"&gt;2&lt;/span&gt; &lt;span class="token operator"&gt;*&lt;/span&gt; window_size&lt;span class="token punctuation"&gt;[&lt;/span&gt;&lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;]&lt;/span&gt; &lt;span class="token operator"&gt;-&lt;/span&gt; &lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; num_heads&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; default_initializer&lt;span class="token operator"&gt;=&lt;/span&gt;nn&lt;span class="token punctuation"&gt;.&lt;/span&gt;initializer&lt;span class="token punctuation"&gt;.&lt;/span&gt;Constant&lt;span class="token punctuation"&gt;(&lt;/span&gt;value&lt;span class="token operator"&gt;=&lt;/span&gt;&lt;span class="token number"&gt;0&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;  &lt;span class="token comment"&gt;# 2*Wh-1 * 2*Ww-1, nH&lt;/span&gt;
    self&lt;span class="token punctuation"&gt;.&lt;/span&gt;add_parameter&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token string"&gt;"relative_position_bias_table"&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; relative_position_bias_table&lt;span class="token punctuation"&gt;)&lt;/span&gt;

    &lt;span class="token comment"&gt;# get pair-wise relative position index for each token inside the window&lt;/span&gt;
    coords_h &lt;span class="token operator"&gt;=&lt;/span&gt; paddle&lt;span class="token punctuation"&gt;.&lt;/span&gt;arange&lt;span class="token punctuation"&gt;(&lt;/span&gt;self&lt;span class="token punctuation"&gt;.&lt;/span&gt;window_size&lt;span class="token punctuation"&gt;[&lt;/span&gt;&lt;span class="token number"&gt;0&lt;/span&gt;&lt;span class="token punctuation"&gt;]&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    coords_w &lt;span class="token operator"&gt;=&lt;/span&gt; paddle&lt;span class="token punctuation"&gt;.&lt;/span&gt;arange&lt;span class="token punctuation"&gt;(&lt;/span&gt;self&lt;span class="token punctuation"&gt;.&lt;/span&gt;window_size&lt;span class="token punctuation"&gt;[&lt;/span&gt;&lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;]&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    coords &lt;span class="token operator"&gt;=&lt;/span&gt; paddle&lt;span class="token punctuation"&gt;.&lt;/span&gt;stack&lt;span class="token punctuation"&gt;(&lt;/span&gt;paddle&lt;span class="token punctuation"&gt;.&lt;/span&gt;meshgrid&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token punctuation"&gt;[&lt;/span&gt;coords_h&lt;span class="token punctuation"&gt;,&lt;/span&gt; coords_w&lt;span class="token punctuation"&gt;]&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;                   &lt;span class="token comment"&gt;# 2, Wh, Ww&lt;/span&gt;
    coords_flatten &lt;span class="token operator"&gt;=&lt;/span&gt; paddle&lt;span class="token punctuation"&gt;.&lt;/span&gt;flatten&lt;span class="token punctuation"&gt;(&lt;/span&gt;coords&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;                                     &lt;span class="token comment"&gt;# 2, Wh*Ww&lt;/span&gt;
    relative_coords &lt;span class="token operator"&gt;=&lt;/span&gt; coords_flatten&lt;span class="token punctuation"&gt;.&lt;/span&gt;unsqueeze&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token operator"&gt;-&lt;/span&gt;&lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt; &lt;span class="token operator"&gt;-&lt;/span&gt; coords_flatten&lt;span class="token punctuation"&gt;.&lt;/span&gt;unsqueeze&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;   &lt;span class="token comment"&gt;# 2, Wh*Ww, Wh*Ww&lt;/span&gt;
    relative_coords &lt;span class="token operator"&gt;=&lt;/span&gt; relative_coords&lt;span class="token punctuation"&gt;.&lt;/span&gt;transpose&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token punctuation"&gt;[&lt;/span&gt;&lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token number"&gt;2&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token number"&gt;0&lt;/span&gt;&lt;span class="token punctuation"&gt;]&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;                         &lt;span class="token comment"&gt;# Wh*Ww, Wh*Ww, 2&lt;/span&gt;
    relative_coords&lt;span class="token punctuation"&gt;[&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token punctuation"&gt;:&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token number"&gt;0&lt;/span&gt;&lt;span class="token punctuation"&gt;]&lt;/span&gt; &lt;span class="token operator"&gt;+=&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;window_size&lt;span class="token punctuation"&gt;[&lt;/span&gt;&lt;span class="token number"&gt;0&lt;/span&gt;&lt;span class="token punctuation"&gt;]&lt;/span&gt; &lt;span class="token operator"&gt;-&lt;/span&gt; &lt;span class="token number"&gt;1&lt;/span&gt;                            &lt;span class="token comment"&gt;# shift to start from 0&lt;/span&gt;
    relative_coords&lt;span class="token punctuation"&gt;[&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token punctuation"&gt;:&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;]&lt;/span&gt; &lt;span class="token operator"&gt;+=&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;window_size&lt;span class="token punctuation"&gt;[&lt;/span&gt;&lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;]&lt;/span&gt; &lt;span class="token operator"&gt;-&lt;/span&gt; &lt;span class="token number"&gt;1&lt;/span&gt;
    relative_coords&lt;span class="token punctuation"&gt;[&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token punctuation"&gt;:&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token number"&gt;0&lt;/span&gt;&lt;span class="token punctuation"&gt;]&lt;/span&gt; &lt;span class="token operator"&gt;*=&lt;/span&gt; &lt;span class="token number"&gt;2&lt;/span&gt; &lt;span class="token operator"&gt;*&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;window_size&lt;span class="token punctuation"&gt;[&lt;/span&gt;&lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;]&lt;/span&gt; &lt;span class="token operator"&gt;-&lt;/span&gt; &lt;span class="token number"&gt;1&lt;/span&gt;
    self&lt;span class="token punctuation"&gt;.&lt;/span&gt;relative_position_index &lt;span class="token operator"&gt;=&lt;/span&gt; relative_coords&lt;span class="token punctuation"&gt;.&lt;/span&gt;&lt;span class="token builtin"&gt;sum&lt;/span&gt;&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token operator"&gt;-&lt;/span&gt;&lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;                         &lt;span class="token comment"&gt;# Wh*Ww, Wh*Ww&lt;/span&gt;
    self&lt;span class="token punctuation"&gt;.&lt;/span&gt;register_buffer&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token string"&gt;"relative_position_index"&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;relative_position_index&lt;span class="token punctuation"&gt;)&lt;/span&gt;

    self&lt;span class="token punctuation"&gt;.&lt;/span&gt;qkv &lt;span class="token operator"&gt;=&lt;/span&gt; nn&lt;span class="token punctuation"&gt;.&lt;/span&gt;Linear&lt;span class="token punctuation"&gt;(&lt;/span&gt;dim&lt;span class="token punctuation"&gt;,&lt;/span&gt; dim &lt;span class="token operator"&gt;*&lt;/span&gt; &lt;span class="token number"&gt;3&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; bias_attr&lt;span class="token operator"&gt;=&lt;/span&gt;qkv_bias&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    self&lt;span class="token punctuation"&gt;.&lt;/span&gt;attn_drop &lt;span class="token operator"&gt;=&lt;/span&gt; nn&lt;span class="token punctuation"&gt;.&lt;/span&gt;Dropout&lt;span class="token punctuation"&gt;(&lt;/span&gt;attn_drop&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    self&lt;span class="token punctuation"&gt;.&lt;/span&gt;proj &lt;span class="token operator"&gt;=&lt;/span&gt; nn&lt;span class="token punctuation"&gt;.&lt;/span&gt;Linear&lt;span class="token punctuation"&gt;(&lt;/span&gt;dim&lt;span class="token punctuation"&gt;,&lt;/span&gt; dim&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    self&lt;span class="token punctuation"&gt;.&lt;/span&gt;proj_drop &lt;span class="token operator"&gt;=&lt;/span&gt; nn&lt;span class="token punctuation"&gt;.&lt;/span&gt;Dropout&lt;span class="token punctuation"&gt;(&lt;/span&gt;proj_drop&lt;span class="token punctuation"&gt;)&lt;/span&gt;

    self&lt;span class="token punctuation"&gt;.&lt;/span&gt;softmax &lt;span class="token operator"&gt;=&lt;/span&gt; nn&lt;span class="token punctuation"&gt;.&lt;/span&gt;Softmax&lt;span class="token punctuation"&gt;(&lt;/span&gt;axis&lt;span class="token operator"&gt;=&lt;/span&gt;&lt;span class="token operator"&gt;-&lt;/span&gt;&lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;

&lt;span class="token keyword"&gt;def&lt;/span&gt; &lt;span class="token function"&gt;forward&lt;/span&gt;&lt;span class="token punctuation"&gt;(&lt;/span&gt;self&lt;span class="token punctuation"&gt;,&lt;/span&gt; x&lt;span class="token punctuation"&gt;,&lt;/span&gt; mask&lt;span class="token operator"&gt;=&lt;/span&gt;&lt;span class="token boolean"&gt;None&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;
    &lt;span class="token triple-quoted-string string"&gt;"""
    Args:
        x: input features with shape of (num_windows*B, N, C)
        mask: (0/-inf) mask with shape of (num_windows, Wh*Ww, Wh*Ww) or None
    """&lt;/span&gt;
    B_&lt;span class="token punctuation"&gt;,&lt;/span&gt; N&lt;span class="token punctuation"&gt;,&lt;/span&gt; C &lt;span class="token operator"&gt;=&lt;/span&gt; x&lt;span class="token punctuation"&gt;.&lt;/span&gt;shape
    qkv &lt;span class="token operator"&gt;=&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;qkv&lt;span class="token punctuation"&gt;(&lt;/span&gt;x&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;.&lt;/span&gt;reshape&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token punctuation"&gt;[&lt;/span&gt;B_&lt;span class="token punctuation"&gt;,&lt;/span&gt; N&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token number"&gt;3&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;num_heads&lt;span class="token punctuation"&gt;,&lt;/span&gt; C &lt;span class="token operator"&gt;//&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;num_heads&lt;span class="token punctuation"&gt;]&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;.&lt;/span&gt;transpose&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token punctuation"&gt;[&lt;/span&gt;&lt;span class="token number"&gt;2&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token number"&gt;0&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token number"&gt;3&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token number"&gt;4&lt;/span&gt;&lt;span class="token punctuation"&gt;]&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    q&lt;span class="token punctuation"&gt;,&lt;/span&gt; k&lt;span class="token punctuation"&gt;,&lt;/span&gt; v &lt;span class="token operator"&gt;=&lt;/span&gt; qkv&lt;span class="token punctuation"&gt;[&lt;/span&gt;&lt;span class="token number"&gt;0&lt;/span&gt;&lt;span class="token punctuation"&gt;]&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; qkv&lt;span class="token punctuation"&gt;[&lt;/span&gt;&lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;]&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; qkv&lt;span class="token punctuation"&gt;[&lt;/span&gt;&lt;span class="token number"&gt;2&lt;/span&gt;&lt;span class="token punctuation"&gt;]&lt;/span&gt;  &lt;span class="token comment"&gt;# make torchscript happy (cannot use tensor as tuple)&lt;/span&gt;

    q &lt;span class="token operator"&gt;=&lt;/span&gt; q &lt;span class="token operator"&gt;*&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;scale
    attn &lt;span class="token operator"&gt;=&lt;/span&gt; q @ swapdim&lt;span class="token punctuation"&gt;(&lt;/span&gt;k &lt;span class="token punctuation"&gt;,&lt;/span&gt;&lt;span class="token operator"&gt;-&lt;/span&gt;&lt;span class="token number"&gt;2&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token operator"&gt;-&lt;/span&gt;&lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;

    relative_position_bias &lt;span class="token operator"&gt;=&lt;/span&gt; paddle&lt;span class="token punctuation"&gt;.&lt;/span&gt;index_select&lt;span class="token punctuation"&gt;(&lt;/span&gt;self&lt;span class="token punctuation"&gt;.&lt;/span&gt;relative_position_bias_table&lt;span class="token punctuation"&gt;,&lt;/span&gt;
                                                 self&lt;span class="token punctuation"&gt;.&lt;/span&gt;relative_position_index&lt;span class="token punctuation"&gt;.&lt;/span&gt;reshape&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token operator"&gt;-&lt;/span&gt;&lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt;axis&lt;span class="token operator"&gt;=&lt;/span&gt;&lt;span class="token number"&gt;0&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;.&lt;/span&gt;reshape&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token punctuation"&gt;(&lt;/span&gt;self&lt;span class="token punctuation"&gt;.&lt;/span&gt;window_size&lt;span class="token punctuation"&gt;[&lt;/span&gt;&lt;span class="token number"&gt;0&lt;/span&gt;&lt;span class="token punctuation"&gt;]&lt;/span&gt; &lt;span class="token operator"&gt;*&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;window_size&lt;span class="token punctuation"&gt;[&lt;/span&gt;&lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;]&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt;self&lt;span class="token punctuation"&gt;.&lt;/span&gt;window_size&lt;span class="token punctuation"&gt;[&lt;/span&gt;&lt;span class="token number"&gt;0&lt;/span&gt;&lt;span class="token punctuation"&gt;]&lt;/span&gt; &lt;span class="token operator"&gt;*&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;window_size&lt;span class="token punctuation"&gt;[&lt;/span&gt;&lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;]&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token operator"&gt;-&lt;/span&gt;&lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;

    relative_position_bias &lt;span class="token operator"&gt;=&lt;/span&gt; relative_position_bias&lt;span class="token punctuation"&gt;.&lt;/span&gt;transpose&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token punctuation"&gt;[&lt;/span&gt;&lt;span class="token number"&gt;2&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token number"&gt;0&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;]&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;  &lt;span class="token comment"&gt;# nH, Wh*Ww, Wh*Ww&lt;/span&gt;
    attn &lt;span class="token operator"&gt;=&lt;/span&gt; attn &lt;span class="token operator"&gt;+&lt;/span&gt; relative_position_bias&lt;span class="token punctuation"&gt;.&lt;/span&gt;unsqueeze&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token number"&gt;0&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;

    &lt;span class="token keyword"&gt;if&lt;/span&gt; mask &lt;span class="token keyword"&gt;is&lt;/span&gt; &lt;span class="token keyword"&gt;not&lt;/span&gt; &lt;span class="token boolean"&gt;None&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;
        nW &lt;span class="token operator"&gt;=&lt;/span&gt; mask&lt;span class="token punctuation"&gt;.&lt;/span&gt;shape&lt;span class="token punctuation"&gt;[&lt;/span&gt;&lt;span class="token number"&gt;0&lt;/span&gt;&lt;span class="token punctuation"&gt;]&lt;/span&gt;
        attn &lt;span class="token operator"&gt;=&lt;/span&gt; attn&lt;span class="token punctuation"&gt;.&lt;/span&gt;reshape&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token punctuation"&gt;[&lt;/span&gt;B_ &lt;span class="token operator"&gt;//&lt;/span&gt; nW&lt;span class="token punctuation"&gt;,&lt;/span&gt; nW&lt;span class="token punctuation"&gt;,&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;num_heads&lt;span class="token punctuation"&gt;,&lt;/span&gt; N&lt;span class="token punctuation"&gt;,&lt;/span&gt; N&lt;span class="token punctuation"&gt;]&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt; &lt;span class="token operator"&gt;+&lt;/span&gt; mask&lt;span class="token punctuation"&gt;.&lt;/span&gt;unsqueeze&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;.&lt;/span&gt;unsqueeze&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token number"&gt;0&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;
        attn &lt;span class="token operator"&gt;=&lt;/span&gt; attn&lt;span class="token punctuation"&gt;.&lt;/span&gt;reshape&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token punctuation"&gt;[&lt;/span&gt;&lt;span class="token operator"&gt;-&lt;/span&gt;&lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;num_heads&lt;span class="token punctuation"&gt;,&lt;/span&gt; N&lt;span class="token punctuation"&gt;,&lt;/span&gt; N&lt;span class="token punctuation"&gt;]&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;
        attn &lt;span class="token operator"&gt;=&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;softmax&lt;span class="token punctuation"&gt;(&lt;/span&gt;attn&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    &lt;span class="token keyword"&gt;else&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;
        attn &lt;span class="token operator"&gt;=&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;softmax&lt;span class="token punctuation"&gt;(&lt;/span&gt;attn&lt;span class="token punctuation"&gt;)&lt;/span&gt;

    attn &lt;span class="token operator"&gt;=&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;attn_drop&lt;span class="token punctuation"&gt;(&lt;/span&gt;attn&lt;span class="token punctuation"&gt;)&lt;/span&gt;

    x &lt;span class="token operator"&gt;=&lt;/span&gt; swapdim&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token punctuation"&gt;(&lt;/span&gt;attn @ v&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt;&lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token number"&gt;2&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;.&lt;/span&gt;reshape&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token punctuation"&gt;[&lt;/span&gt;B_&lt;span class="token punctuation"&gt;,&lt;/span&gt; N&lt;span class="token punctuation"&gt;,&lt;/span&gt; C&lt;span class="token punctuation"&gt;]&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    x &lt;span class="token operator"&gt;=&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;proj&lt;span class="token punctuation"&gt;(&lt;/span&gt;x&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    x &lt;span class="token operator"&gt;=&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;proj_drop&lt;span class="token punctuation"&gt;(&lt;/span&gt;x&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    &lt;span class="token keyword"&gt;return&lt;/span&gt; x
</code></pre>
</pre> 
<div class="hljs-button {2}"></div> 
<div class="hide-preCode-box"> 
 <span class="hide-preCode-bt"><img class="look-more-preCode contentImg-no-view" src="https://images2.imgbox.com/0b/50/Pxbnyce5_o.png" alt="" title=""></span> 
</div> 
<ul class="pre-numbering"><li>1</li><li>2</li><li>3</li><li>4</li><li>5</li><li>6</li><li>7</li><li>8</li><li>9</li><li>10</li><li>11</li><li>12</li><li>13</li><li>14</li><li>15</li><li>16</li><li>17</li><li>18</li><li>19</li><li>20</li><li>21</li><li>22</li><li>23</li><li>24</li><li>25</li><li>26</li><li>27</li><li>28</li><li>29</li><li>30</li><li>31</li><li>32</li><li>33</li><li>34</li><li>35</li><li>36</li><li>37</li><li>38</li><li>39</li><li>40</li><li>41</li><li>42</li><li>43</li><li>44</li><li>45</li><li>46</li><li>47</li><li>48</li><li>49</li><li>50</li><li>51</li><li>52</li><li>53</li><li>54</li><li>55</li><li>56</li><li>57</li><li>58</li><li>59</li><li>60</li><li>61</li><li>62</li><li>63</li><li>64</li><li>65</li><li>66</li><li>67</li><li>68</li><li>69</li><li>70</li><li>71</li><li>72</li><li>73</li><li>74</li><li>75</li><li>76</li><li>77</li><li>78</li><li>79</li><li>80</li><li>81</li></ul> 
<p><img src="https://images2.imgbox.com/57/42/rHv50qbk_o.jpg" alt=""></p> 
<p><img src="https://images2.imgbox.com/ae/bc/gNLyjcRb_o.jpg" alt=""></p> 
<h3><a id="42_Swin_Trasnformer_706"></a>4.2 Swin Trasnformer模型实现</h3> 
<p>Swin Transformer涉及模型代码较多，所以建议完整的看Swin Transformer的代码，因此推荐一下桨的<a href="https://github.com/PaddlePaddle/PaddleClas/blob/release/2.2/ppcls/arch/backbone/model_zoo/swin_transformer.py">Swin Transformer</a>实现。</p> 
<h3><a id="43_Swin_Trasnformer_709"></a>4.3 Swin Trasnformer模型特点</h3> 
<ol><li> <p>首次在cv领域的transformer模型中采用了分层结构。分层结构因为其不同大小的尺度，使不同层特征有了更加不同的意义，较浅层的特征具有大尺度和细节信息，较深层的特征具有小尺度和物体的整体轮廓信息，在图像分类领域，深层特征具有更加有用的作用，只需要根据这个信息判定物体的类别即可，但是在像素级的分割和检测任务中，则需要更为精细的细节信息，因此，分层结构的模型往往更适用于分割和检测这样的像素级要求的任务中。Swin Transformer 模仿ResNet采取了分层的结构，使其成为了cv领域的通用框架。</p> </li><li> <p>引入locality思想，对无重合的window区域内进行self-attention计算。不仅减少了计算量，而且多了不同窗口之间的交互。</p> </li></ol> 
<h3><a id="44_Swin_Trasnformer_714"></a>4.4 Swin Trasnformer模型效果</h3> 
<p><img src="https://images2.imgbox.com/f1/56/ksYmmZo6_o.jpg" alt=""></p> 
<p>第一列为对比的方法，第二列为图片尺寸的大小（尺寸越大浮点运算量越大），第三列为参数量，第四列为浮点运算量，第五列为模型吞吐量。可以看出，Swin-T 在top1准确率上超过了大部分模型EffNet-B3确实是个优秀的网络，在参数量和FLOPs都比Swin-T少的情况下，略优于Swin-T,然而，基于ImageNet1K数据集，Swin-B在这些模型上取得了最优的效果。另外，Swin-L在ImageNet-22K上的top1准确率达到了87.3%的高度，这是以往的模型都没有达到的。并且Swin Transformer的其他配置也取得了优秀的成绩。图中不同配置的Swin Transformer解释如下。</p> 
<p><img src="https://images2.imgbox.com/76/17/Z9wbuChj_o.jpg" alt=""></p> 
<p>C就是上面提到的类似于通道数的值，layer numbers就是Swin Transformer Block的数量了。这两个都是值越大，效果越好。和ResNet十分相似。</p> 
<p>下图为COCO数据集上目标检测与实例分割的表现。都是相同网络在不同骨干网络下的对比。可以看出在不同AP下，Swin Transformer都有大约5%的提升，这已经是很优秀的水平了。怪不得能成为ICCV2021最佳paer。</p> 
<p><img src="https://images2.imgbox.com/1b/07/N4cAefVP_o.jpg" alt=""></p> 
<p>下图为语义分割数据集ADE20K上的表现。相较于同为transformer的DeiT-S, Swin Transformer-S有了5%的性能提升。相较于ResNeSt-200，Swin Transformer-L也有5%的提升。另外可以看到，在UNet的框架下，Swin Transformer的各个版本都有十分优秀的成绩，这充分说明了Swin Transformer是CV领域的通用骨干网络。</p> 
<p><img src="https://images2.imgbox.com/6c/3f/GAZJRMLE_o.jpg" alt=""></p> 
<ul><li>参考文献<br> <a href="https://arxiv.org/pdf/2103.14030.pdf" rel="nofollow">Swin Transformer</a></li></ul> 
<h2><a id="5ViT_Vision_Transformer2020_748"></a>5.ViT( Vision Transformer-2020)</h2> 
<p>在计算机视觉领域中，多数算法都是保持CNN整体结构不变，在CNN中增加attention模块或者使用attention模块替换CNN中的某些部分。有研究者提出，没有必要总是依赖于CNN。因此，作者提出ViT<sup>[1]</sup>算法，仅仅使用Transformer结构也能够在图像分类任务中表现很好。</p> 
<p>受到NLP领域中Transformer成功应用的启发，ViT算法中尝试将标准的Transformer结构直接应用于图像，并对整个图像分类流程进行最少的修改。具体来讲，ViT算法中，会将整幅图像拆分成小图像块，然后把这些小图像块的线性嵌入序列作为Transformer的输入送入网络，然后使用监督学习的方式进行图像分类的训练。</p> 
<p>该算法在中等规模（例如ImageNet）以及大规模（例如ImageNet-21K、JFT-300M）数据集上进行了实验验证，发现：</p> 
<ul><li>Transformer相较于CNN结构，缺少一定的平移不变性和局部感知性，因此在数据量不充分时，很难达到同等的效果。具体表现为使用中等规模的ImageNet训练的Transformer会比ResNet在精度上低几个百分点。</li><li>当有大量的训练样本时，结果则会发生改变。使用大规模数据集进行预训练后，再使用迁移学习的方式应用到其他数据集上，可以达到或超越当前的SOTA水平。</li></ul> 
<h3><a id="51_ViT_759"></a>5.1 ViT模型结构与实现</h3> 
<p>ViT算法的整体结构如 <strong>图1</strong> 所示。</p> 
<p><img src="https://images2.imgbox.com/06/6c/D5uBnaAn_o.png" alt=""></p> 
<h4><a id="511_ViT_768"></a>5.1.1. ViT图像分块嵌入</h4> 
<p>考虑到在Transformer结构中，输入是一个二维的矩阵，矩阵的形状可以表示为 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
       
      
    </span><span class="katex-html"></span></span></span></p> 
<pre><code>     ( 
    
   
     N 
    
   
     , 
    
   
     D 
    
   
     ) 
    
   
  
    (N,D) 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 1em; vertical-align: -0.25em;"&gt;&lt;/span&gt;&lt;span class="mopen"&gt;(&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.109em;"&gt;N&lt;/span&gt;&lt;span class="mpunct"&gt;,&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.1667em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0278em;"&gt;D&lt;/span&gt;&lt;span class="mclose"&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;，其中 &lt;span class="katex--inline"&gt;&lt;span class="katex"&gt;&lt;span class="katex-mathml"&gt; 
 
  
   
   
     N 
    
   
  
    N 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.6833em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.109em;"&gt;N&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; 是sequence的长度，而 &lt;span class="katex--inline"&gt;&lt;span class="katex"&gt;&lt;span class="katex-mathml"&gt; 
 
  
   
   
     D 
    
   
  
    D 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.6833em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0278em;"&gt;D&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; 是sequence中每个向量的维度。因此，在ViT算法中，首先需要设法将 &lt;span class="katex--inline"&gt;&lt;span class="katex"&gt;&lt;span class="katex-mathml"&gt; 
 
  
   
   
     H 
    
   
     × 
    
   
     W 
    
   
     × 
    
   
     C 
    
   
  
    H \times W \times C 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.7667em; vertical-align: -0.0833em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0813em;"&gt;H&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2222em;"&gt;&lt;/span&gt;&lt;span class="mbin"&gt;×&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2222em;"&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.7667em; vertical-align: -0.0833em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.1389em;"&gt;W&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2222em;"&gt;&lt;/span&gt;&lt;span class="mbin"&gt;×&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2222em;"&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.6833em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0715em;"&gt;C&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; 的三维图像转化为 &lt;span class="katex--inline"&gt;&lt;span class="katex"&gt;&lt;span class="katex-mathml"&gt; 
 
  
   
   
     ( 
    
   
     N 
    
   
     , 
    
   
     D 
    
   
     ) 
    
   
  
    (N,D) 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 1em; vertical-align: -0.25em;"&gt;&lt;/span&gt;&lt;span class="mopen"&gt;(&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.109em;"&gt;N&lt;/span&gt;&lt;span class="mpunct"&gt;,&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.1667em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0278em;"&gt;D&lt;/span&gt;&lt;span class="mclose"&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; 的二维输入。&lt;/p&gt; 
</code></pre> 
<p></p> 
<p>ViT中的具体实现方式为：将 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
       
      
    </span><span class="katex-html"></span></span></span></p> 
<pre><code>     H 
    
   
     × 
    
   
     W 
    
   
     × 
    
   
     C 
    
   
  
    H \times W \times C 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.7667em; vertical-align: -0.0833em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0813em;"&gt;H&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2222em;"&gt;&lt;/span&gt;&lt;span class="mbin"&gt;×&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2222em;"&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.7667em; vertical-align: -0.0833em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.1389em;"&gt;W&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2222em;"&gt;&lt;/span&gt;&lt;span class="mbin"&gt;×&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2222em;"&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.6833em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0715em;"&gt;C&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; 的图像，变为一个 &lt;span class="katex--inline"&gt;&lt;span class="katex"&gt;&lt;span class="katex-mathml"&gt; 
 
  
   
   
     N 
    
   
     × 
    
   
     ( 
    
    
    
      P 
     
    
      2 
     
    
   
     ∗ 
    
   
     C 
    
   
     ) 
    
   
  
    N \times (P^2 * C) 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.7667em; vertical-align: -0.0833em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.109em;"&gt;N&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2222em;"&gt;&lt;/span&gt;&lt;span class="mbin"&gt;×&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2222em;"&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 1.0641em; vertical-align: -0.25em;"&gt;&lt;/span&gt;&lt;span class="mopen"&gt;(&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal" style="margin-right: 0.1389em;"&gt;P&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.8141em;"&gt;&lt;span class="" style="top: -3.063em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;2&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2222em;"&gt;&lt;/span&gt;&lt;span class="mbin"&gt;∗&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2222em;"&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 1em; vertical-align: -0.25em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0715em;"&gt;C&lt;/span&gt;&lt;span class="mclose"&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; 的序列。这个序列可以看作是一系列展平的图像块，也就是将图像切分成小块后，再将其展平。该序列中一共包含了 &lt;span class="katex--inline"&gt;&lt;span class="katex"&gt;&lt;span class="katex-mathml"&gt; 
 
  
   
   
     N 
    
   
     = 
    
   
     H 
    
   
     W 
    
   
     / 
    
    
    
      P 
     
    
      2 
     
    
   
  
    N=HW/P^2 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.6833em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.109em;"&gt;N&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2778em;"&gt;&lt;/span&gt;&lt;span class="mrel"&gt;=&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2778em;"&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 1.0641em; vertical-align: -0.25em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0813em;"&gt;H&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.1389em;"&gt;W&lt;/span&gt;&lt;span class="mord"&gt;/&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal" style="margin-right: 0.1389em;"&gt;P&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.8141em;"&gt;&lt;span class="" style="top: -3.063em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;2&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; 个图像块，每个图像块的维度则是 &lt;span class="katex--inline"&gt;&lt;span class="katex"&gt;&lt;span class="katex-mathml"&gt; 
 
  
   
   
     ( 
    
    
    
      P 
     
    
      2 
     
    
   
     ∗ 
    
   
     C 
    
   
     ) 
    
   
  
    (P^2*C) 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 1.0641em; vertical-align: -0.25em;"&gt;&lt;/span&gt;&lt;span class="mopen"&gt;(&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal" style="margin-right: 0.1389em;"&gt;P&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.8141em;"&gt;&lt;span class="" style="top: -3.063em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;2&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2222em;"&gt;&lt;/span&gt;&lt;span class="mbin"&gt;∗&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2222em;"&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 1em; vertical-align: -0.25em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0715em;"&gt;C&lt;/span&gt;&lt;span class="mclose"&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;。其中 &lt;span class="katex--inline"&gt;&lt;span class="katex"&gt;&lt;span class="katex-mathml"&gt; 
 
  
   
   
     P 
    
   
  
    P 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.6833em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.1389em;"&gt;P&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; 是图像块的大小，&lt;span class="katex--inline"&gt;&lt;span class="katex"&gt;&lt;span class="katex-mathml"&gt; 
 
  
   
   
     C 
    
   
  
    C 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.6833em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0715em;"&gt;C&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; 是通道数量。经过如上变换，就可以将 &lt;span class="katex--inline"&gt;&lt;span class="katex"&gt;&lt;span class="katex-mathml"&gt; 
 
  
   
   
     N 
    
   
  
    N 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.6833em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.109em;"&gt;N&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; 视为sequence的长度了。&lt;/p&gt; 
</code></pre> 
<p></p> 
<p>但是，此时每个图像块的维度是 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
       
      
    </span><span class="katex-html"></span></span></span></p> 
<pre><code>     ( 
    
    
    
      P 
     
    
      2 
     
    
   
     ∗ 
    
   
     C 
    
   
     ) 
    
   
  
    (P^2*C) 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 1.0641em; vertical-align: -0.25em;"&gt;&lt;/span&gt;&lt;span class="mopen"&gt;(&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal" style="margin-right: 0.1389em;"&gt;P&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.8141em;"&gt;&lt;span class="" style="top: -3.063em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;2&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2222em;"&gt;&lt;/span&gt;&lt;span class="mbin"&gt;∗&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2222em;"&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 1em; vertical-align: -0.25em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0715em;"&gt;C&lt;/span&gt;&lt;span class="mclose"&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;，而我们实际需要的向量维度是 &lt;span class="katex--inline"&gt;&lt;span class="katex"&gt;&lt;span class="katex-mathml"&gt; 
 
  
   
   
     D 
    
   
  
    D 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.6833em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0278em;"&gt;D&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;，因此我们还需要对图像块进行 Embedding。这里 Embedding 的方式非常简单，只需要对每个 &lt;span class="katex--inline"&gt;&lt;span class="katex"&gt;&lt;span class="katex-mathml"&gt; 
 
  
   
   
     ( 
    
    
    
      P 
     
    
      2 
     
    
   
     ∗ 
    
   
     C 
    
   
     ) 
    
   
  
    (P^2*C) 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 1.0641em; vertical-align: -0.25em;"&gt;&lt;/span&gt;&lt;span class="mopen"&gt;(&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal" style="margin-right: 0.1389em;"&gt;P&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.8141em;"&gt;&lt;span class="" style="top: -3.063em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;2&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2222em;"&gt;&lt;/span&gt;&lt;span class="mbin"&gt;∗&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2222em;"&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 1em; vertical-align: -0.25em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0715em;"&gt;C&lt;/span&gt;&lt;span class="mclose"&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; 的图像块做一个线性变换，将维度压缩为 &lt;span class="katex--inline"&gt;&lt;span class="katex"&gt;&lt;span class="katex-mathml"&gt; 
 
  
   
   
     D 
    
   
  
    D 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.6833em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0278em;"&gt;D&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; 即可。&lt;/p&gt; 
</code></pre> 
<p></p> 
<p>上述对图像进行分块以及 Embedding 的具体方式如 <strong>图2</strong> 所示。</p> 
<p><img src="https://images2.imgbox.com/45/99/IZVr5sgJ_o.png" alt=""></p> 
<p>具体代码实现如下所示。本文中将每个大小为 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
       
      
    </span><span class="katex-html"></span></span></span></p> 
<pre><code>     P 
    
   
  
    P 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.6833em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.1389em;"&gt;P&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; 的图像块经过大小为 &lt;span class="katex--inline"&gt;&lt;span class="katex"&gt;&lt;span class="katex-mathml"&gt; 
 
  
   
   
     P 
    
   
  
    P 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.6833em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.1389em;"&gt;P&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; 的卷积核来代替原文中将大小为 &lt;span class="katex--inline"&gt;&lt;span class="katex"&gt;&lt;span class="katex-mathml"&gt; 
 
  
   
   
     P 
    
   
  
    P 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.6833em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.1389em;"&gt;P&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; 的图像块展平后接全连接运算的操作。&lt;/p&gt; 
</code></pre> 
<p></p> 
<pre class="set-code-hide prettyprint"><code class="prism language-python has-numbering"><span class="token comment">#图像分块、Embedding</span>
<span class="token keyword">class</span> <span class="token class-name">PatchEmbed</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Layer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> img_size<span class="token operator">=</span><span class="token number">224</span><span class="token punctuation">,</span> patch_size<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span> in_chans<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> embed_dim<span class="token operator">=</span><span class="token number">768</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 原始大小为int，转为tuple，即：img_size原始输入224，变换后为[224,224]</span>
        img_size <span class="token operator">=</span> to_2tuple<span class="token punctuation">(</span>img_size<span class="token punctuation">)</span>
        patch_size <span class="token operator">=</span> to_2tuple<span class="token punctuation">(</span>patch_size<span class="token punctuation">)</span>
        <span class="token comment"># 图像块的个数</span>
        num_patches <span class="token operator">=</span> <span class="token punctuation">(</span>img_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">//</span> patch_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> \
            <span class="token punctuation">(</span>img_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">//</span> patch_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>img_size <span class="token operator">=</span> img_size
        self<span class="token punctuation">.</span>patch_size <span class="token operator">=</span> patch_size
        self<span class="token punctuation">.</span>num_patches <span class="token operator">=</span> num_patches
        <span class="token comment"># kernel_size=块大小，即每个块输出一个值，类似每个块展平后使用相同的全连接层进行处理</span>
        <span class="token comment"># 输入维度为3，输出维度为块向量长度</span>
        <span class="token comment"># 与原文中：分块、展平、全连接降维保持一致</span>
        <span class="token comment"># 输出为[B, C, H, W]</span>
        self<span class="token punctuation">.</span>proj <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2D<span class="token punctuation">(</span>
            in_chans<span class="token punctuation">,</span> embed_dim<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span>patch_size<span class="token punctuation">,</span> stride<span class="token operator">=</span>patch_size<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        B<span class="token punctuation">,</span> C<span class="token punctuation">,</span> H<span class="token punctuation">,</span> W <span class="token operator">=</span> x<span class="token punctuation">.</span>shape
        <span class="token keyword">assert</span> H <span class="token operator">==</span> self<span class="token punctuation">.</span>img_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">and</span> W <span class="token operator">==</span> self<span class="token punctuation">.</span>img_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> \
            <span class="token string">"Input image size ({H}*{W}) doesn't match model ({self.img_size[0]}*{self.img_size[1]})."</span>
        <span class="token comment"># [B, C, H, W] -&gt; [B, C, H*W] -&gt;[B, H*W, C]</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>proj<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span>flatten<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> x
</code>
 
 <div class="hljs-button {2}"></div>
 
 <div class="hide-preCode-box">
  
  <span class="hide-preCode-bt"><img class="look-more-preCode contentImg-no-view" src="https://images2.imgbox.com/3d/e6/tb7kmmAF_o.png" alt="" title=""></span>
 
 </div>
 
 </pre><ul class="pre-numbering"><li>1</li><li>2</li><li>3</li><li>4</li><li>5</li><li>6</li><li>7</li><li>8</li><li>9</li><li>10</li><li>11</li><li>12</li><li>13</li><li>14</li><li>15</li><li>16</li><li>17</li><li>18</li><li>19</li><li>20</li><li>21</li><li>22</li><li>23</li><li>24</li><li>25</li><li>26</li><li>27</li></ul> 
<h4><a id="512_ViT_816"></a>5.1.2. ViT多头注意力</h4> 
<p>将图像转化为 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
       
      
    </span><span class="katex-html"></span></span></span></p> 
<pre><code>     N 
    
   
     × 
    
   
     ( 
    
    
    
      P 
     
    
      2 
     
    
   
     ∗ 
    
   
     C 
    
   
     ) 
    
   
  
    N \times (P^2 * C) 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.7667em; vertical-align: -0.0833em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.109em;"&gt;N&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2222em;"&gt;&lt;/span&gt;&lt;span class="mbin"&gt;×&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2222em;"&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 1.0641em; vertical-align: -0.25em;"&gt;&lt;/span&gt;&lt;span class="mopen"&gt;(&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal" style="margin-right: 0.1389em;"&gt;P&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.8141em;"&gt;&lt;span class="" style="top: -3.063em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;2&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2222em;"&gt;&lt;/span&gt;&lt;span class="mbin"&gt;∗&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2222em;"&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 1em; vertical-align: -0.25em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0715em;"&gt;C&lt;/span&gt;&lt;span class="mclose"&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; 的序列后，就可以将其输入到 Transformer 结构中进行特征提取了，如 &lt;strong&gt;图3&lt;/strong&gt; 所示。&lt;/p&gt; 
</code></pre> 
<p></p> 
<p><img src="https://images2.imgbox.com/cc/ca/TFt6lg5z_o.png" alt=""></p> 
<p>Transformer 结构中最重要的结构就是 Multi-head Attention，即多头注意力结构。具有2个head的 Multi-head Attention 结构如 <strong>图4</strong> 所示。输入 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
       
      
    </span><span class="katex-html"></span></span></span></p> 
<pre><code>      a 
     
    
      i 
     
    
   
  
    a^i 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.8247em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal"&gt;a&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.8247em;"&gt;&lt;span class="" style="top: -3.063em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mathnormal mtight"&gt;i&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; 经过转移矩阵，并切分生成 &lt;span class="katex--inline"&gt;&lt;span class="katex"&gt;&lt;span class="katex-mathml"&gt; 
 
  
   
    
    
      q 
     
     
     
       ( 
      
     
       i 
      
     
       , 
      
     
       1 
      
     
       ) 
      
     
    
   
  
    q^{(i,1)} 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 1.0824em; vertical-align: -0.1944em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0359em;"&gt;q&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.888em;"&gt;&lt;span class="" style="top: -3.063em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;&lt;span class="mopen mtight"&gt;(&lt;/span&gt;&lt;span class="mord mathnormal mtight"&gt;i&lt;/span&gt;&lt;span class="mpunct mtight"&gt;,&lt;/span&gt;&lt;span class="mord mtight"&gt;1&lt;/span&gt;&lt;span class="mclose mtight"&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;、&lt;span class="katex--inline"&gt;&lt;span class="katex"&gt;&lt;span class="katex-mathml"&gt; 
 
  
   
    
    
      q 
     
     
     
       ( 
      
     
       i 
      
     
       , 
      
     
       2 
      
     
       ) 
      
     
    
   
  
    q^{(i,2)} 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 1.0824em; vertical-align: -0.1944em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0359em;"&gt;q&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.888em;"&gt;&lt;span class="" style="top: -3.063em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;&lt;span class="mopen mtight"&gt;(&lt;/span&gt;&lt;span class="mord mathnormal mtight"&gt;i&lt;/span&gt;&lt;span class="mpunct mtight"&gt;,&lt;/span&gt;&lt;span class="mord mtight"&gt;2&lt;/span&gt;&lt;span class="mclose mtight"&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;、&lt;span class="katex--inline"&gt;&lt;span class="katex"&gt;&lt;span class="katex-mathml"&gt; 
 
  
   
    
    
      k 
     
     
     
       ( 
      
     
       i 
      
     
       , 
      
     
       1 
      
     
       ) 
      
     
    
   
  
    k^{(i,1)} 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.888em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0315em;"&gt;k&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.888em;"&gt;&lt;span class="" style="top: -3.063em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;&lt;span class="mopen mtight"&gt;(&lt;/span&gt;&lt;span class="mord mathnormal mtight"&gt;i&lt;/span&gt;&lt;span class="mpunct mtight"&gt;,&lt;/span&gt;&lt;span class="mord mtight"&gt;1&lt;/span&gt;&lt;span class="mclose mtight"&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;、&lt;span class="katex--inline"&gt;&lt;span class="katex"&gt;&lt;span class="katex-mathml"&gt; 
 
  
   
    
    
      k 
     
     
     
       ( 
      
     
       i 
      
     
       , 
      
     
       2 
      
     
       ) 
      
     
    
   
  
    k^{(i,2)} 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.888em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0315em;"&gt;k&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.888em;"&gt;&lt;span class="" style="top: -3.063em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;&lt;span class="mopen mtight"&gt;(&lt;/span&gt;&lt;span class="mord mathnormal mtight"&gt;i&lt;/span&gt;&lt;span class="mpunct mtight"&gt;,&lt;/span&gt;&lt;span class="mord mtight"&gt;2&lt;/span&gt;&lt;span class="mclose mtight"&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;、&lt;span class="katex--inline"&gt;&lt;span class="katex"&gt;&lt;span class="katex-mathml"&gt; 
 
  
   
    
    
      v 
     
     
     
       ( 
      
     
       i 
      
     
       , 
      
     
       1 
      
     
       ) 
      
     
    
   
  
    v^{(i,1)} 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.888em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0359em;"&gt;v&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.888em;"&gt;&lt;span class="" style="top: -3.063em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;&lt;span class="mopen mtight"&gt;(&lt;/span&gt;&lt;span class="mord mathnormal mtight"&gt;i&lt;/span&gt;&lt;span class="mpunct mtight"&gt;,&lt;/span&gt;&lt;span class="mord mtight"&gt;1&lt;/span&gt;&lt;span class="mclose mtight"&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;、&lt;span class="katex--inline"&gt;&lt;span class="katex"&gt;&lt;span class="katex-mathml"&gt; 
 
  
   
    
    
      v 
     
     
     
       ( 
      
     
       i 
      
     
       , 
      
     
       2 
      
     
       ) 
      
     
    
   
  
    v^{(i,2)} 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.888em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0359em;"&gt;v&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.888em;"&gt;&lt;span class="" style="top: -3.063em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;&lt;span class="mopen mtight"&gt;(&lt;/span&gt;&lt;span class="mord mathnormal mtight"&gt;i&lt;/span&gt;&lt;span class="mpunct mtight"&gt;,&lt;/span&gt;&lt;span class="mord mtight"&gt;2&lt;/span&gt;&lt;span class="mclose mtight"&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;，然后 &lt;span class="katex--inline"&gt;&lt;span class="katex"&gt;&lt;span class="katex-mathml"&gt; 
 
  
   
    
    
      q 
     
     
     
       ( 
      
     
       i 
      
     
       , 
      
     
       1 
      
     
       ) 
      
     
    
   
  
    q^{(i,1)} 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 1.0824em; vertical-align: -0.1944em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0359em;"&gt;q&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.888em;"&gt;&lt;span class="" style="top: -3.063em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;&lt;span class="mopen mtight"&gt;(&lt;/span&gt;&lt;span class="mord mathnormal mtight"&gt;i&lt;/span&gt;&lt;span class="mpunct mtight"&gt;,&lt;/span&gt;&lt;span class="mord mtight"&gt;1&lt;/span&gt;&lt;span class="mclose mtight"&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; 与 &lt;span class="katex--inline"&gt;&lt;span class="katex"&gt;&lt;span class="katex-mathml"&gt; 
 
  
   
    
    
      k 
     
     
     
       ( 
      
     
       i 
      
     
       , 
      
     
       1 
      
     
       ) 
      
     
    
   
  
    k^{(i,1)} 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.888em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0315em;"&gt;k&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.888em;"&gt;&lt;span class="" style="top: -3.063em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;&lt;span class="mopen mtight"&gt;(&lt;/span&gt;&lt;span class="mord mathnormal mtight"&gt;i&lt;/span&gt;&lt;span class="mpunct mtight"&gt;,&lt;/span&gt;&lt;span class="mord mtight"&gt;1&lt;/span&gt;&lt;span class="mclose mtight"&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; 做 attention，得到权重向量 &lt;span class="katex--inline"&gt;&lt;span class="katex"&gt;&lt;span class="katex-mathml"&gt; 
 
  
   
   
     α 
    
   
  
    \alpha 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.4306em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0037em;"&gt;α&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;，将 &lt;span class="katex--inline"&gt;&lt;span class="katex"&gt;&lt;span class="katex-mathml"&gt; 
 
  
   
   
     α 
    
   
  
    \alpha 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.4306em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0037em;"&gt;α&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; 与 &lt;span class="katex--inline"&gt;&lt;span class="katex"&gt;&lt;span class="katex-mathml"&gt; 
 
  
   
    
    
      v 
     
     
     
       ( 
      
     
       i 
      
     
       , 
      
     
       1 
      
     
       ) 
      
     
    
   
  
    v^{(i,1)} 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.888em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0359em;"&gt;v&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.888em;"&gt;&lt;span class="" style="top: -3.063em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;&lt;span class="mopen mtight"&gt;(&lt;/span&gt;&lt;span class="mord mathnormal mtight"&gt;i&lt;/span&gt;&lt;span class="mpunct mtight"&gt;,&lt;/span&gt;&lt;span class="mord mtight"&gt;1&lt;/span&gt;&lt;span class="mclose mtight"&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; 进行加权求和，得到最终的 &lt;span class="katex--inline"&gt;&lt;span class="katex"&gt;&lt;span class="katex-mathml"&gt; 
 
  
   
    
    
      b 
     
     
     
       ( 
      
     
       i 
      
     
       , 
      
     
       1 
      
     
       ) 
      
     
    
   
     ( 
    
   
     i 
    
   
     = 
    
   
     1 
    
   
     , 
    
   
     2 
    
   
     , 
    
   
     … 
    
   
     , 
    
   
     N 
    
   
     ) 
    
   
  
    b^{(i,1)}(i=1,2,…,N) 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 1.138em; vertical-align: -0.25em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal"&gt;b&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.888em;"&gt;&lt;span class="" style="top: -3.063em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;&lt;span class="mopen mtight"&gt;(&lt;/span&gt;&lt;span class="mord mathnormal mtight"&gt;i&lt;/span&gt;&lt;span class="mpunct mtight"&gt;,&lt;/span&gt;&lt;span class="mord mtight"&gt;1&lt;/span&gt;&lt;span class="mclose mtight"&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="mopen"&gt;(&lt;/span&gt;&lt;span class="mord mathnormal"&gt;i&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2778em;"&gt;&lt;/span&gt;&lt;span class="mrel"&gt;=&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2778em;"&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 1em; vertical-align: -0.25em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;1&lt;/span&gt;&lt;span class="mpunct"&gt;,&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.1667em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;2&lt;/span&gt;&lt;span class="mpunct"&gt;,&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.1667em;"&gt;&lt;/span&gt;&lt;span class="minner"&gt;…&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.1667em;"&gt;&lt;/span&gt;&lt;span class="mpunct"&gt;,&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.1667em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.109em;"&gt;N&lt;/span&gt;&lt;span class="mclose"&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;，同理可以得到 &lt;span class="katex--inline"&gt;&lt;span class="katex"&gt;&lt;span class="katex-mathml"&gt; 
 
  
   
    
    
      b 
     
     
     
       ( 
      
     
       i 
      
     
       , 
      
     
       2 
      
     
       ) 
      
     
    
   
     ( 
    
   
     i 
    
   
     = 
    
   
     1 
    
   
     , 
    
   
     2 
    
   
     , 
    
   
     … 
    
   
     , 
    
   
     N 
    
   
     ) 
    
   
  
    b^{(i,2)}(i=1,2,…,N) 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 1.138em; vertical-align: -0.25em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal"&gt;b&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.888em;"&gt;&lt;span class="" style="top: -3.063em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;&lt;span class="mopen mtight"&gt;(&lt;/span&gt;&lt;span class="mord mathnormal mtight"&gt;i&lt;/span&gt;&lt;span class="mpunct mtight"&gt;,&lt;/span&gt;&lt;span class="mord mtight"&gt;2&lt;/span&gt;&lt;span class="mclose mtight"&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="mopen"&gt;(&lt;/span&gt;&lt;span class="mord mathnormal"&gt;i&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2778em;"&gt;&lt;/span&gt;&lt;span class="mrel"&gt;=&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2778em;"&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 1em; vertical-align: -0.25em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;1&lt;/span&gt;&lt;span class="mpunct"&gt;,&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.1667em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;2&lt;/span&gt;&lt;span class="mpunct"&gt;,&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.1667em;"&gt;&lt;/span&gt;&lt;span class="minner"&gt;…&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.1667em;"&gt;&lt;/span&gt;&lt;span class="mpunct"&gt;,&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.1667em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.109em;"&gt;N&lt;/span&gt;&lt;span class="mclose"&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;。接着将它们拼接起来，通过一个线性层进行处理，得到最终的结果。&lt;/p&gt; 
</code></pre> 
<p></p> 
<p><img src="https://images2.imgbox.com/2e/48/EOdqRVMu_o.jpg" alt=""></p> 
<p>其中，使用 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
       
      
    </span><span class="katex-html"></span></span></span></p> 
<pre><code>      q 
     
     
     
       ( 
      
     
       i 
      
     
       , 
      
     
       j 
      
     
       ) 
      
     
    
   
  
    q^{(i,j)} 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 1.0824em; vertical-align: -0.1944em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0359em;"&gt;q&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.888em;"&gt;&lt;span class="" style="top: -3.063em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;&lt;span class="mopen mtight"&gt;(&lt;/span&gt;&lt;span class="mord mathnormal mtight"&gt;i&lt;/span&gt;&lt;span class="mpunct mtight"&gt;,&lt;/span&gt;&lt;span class="mord mathnormal mtight" style="margin-right: 0.0572em;"&gt;j&lt;/span&gt;&lt;span class="mclose mtight"&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;、&lt;span class="katex--inline"&gt;&lt;span class="katex"&gt;&lt;span class="katex-mathml"&gt; 
 
  
   
    
    
      k 
     
     
     
       ( 
      
     
       i 
      
     
       , 
      
     
       j 
      
     
       ) 
      
     
    
   
  
    k^{(i,j)} 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.888em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0315em;"&gt;k&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.888em;"&gt;&lt;span class="" style="top: -3.063em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;&lt;span class="mopen mtight"&gt;(&lt;/span&gt;&lt;span class="mord mathnormal mtight"&gt;i&lt;/span&gt;&lt;span class="mpunct mtight"&gt;,&lt;/span&gt;&lt;span class="mord mathnormal mtight" style="margin-right: 0.0572em;"&gt;j&lt;/span&gt;&lt;span class="mclose mtight"&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; 与 &lt;span class="katex--inline"&gt;&lt;span class="katex"&gt;&lt;span class="katex-mathml"&gt; 
 
  
   
    
    
      v 
     
     
     
       ( 
      
     
       i 
      
     
       , 
      
     
       j 
      
     
       ) 
      
     
    
   
  
    v^{(i,j)} 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.888em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0359em;"&gt;v&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.888em;"&gt;&lt;span class="" style="top: -3.063em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;&lt;span class="mopen mtight"&gt;(&lt;/span&gt;&lt;span class="mord mathnormal mtight"&gt;i&lt;/span&gt;&lt;span class="mpunct mtight"&gt;,&lt;/span&gt;&lt;span class="mord mathnormal mtight" style="margin-right: 0.0572em;"&gt;j&lt;/span&gt;&lt;span class="mclose mtight"&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; 计算 &lt;span class="katex--inline"&gt;&lt;span class="katex"&gt;&lt;span class="katex-mathml"&gt; 
 
  
   
    
    
      b 
     
     
     
       ( 
      
     
       i 
      
     
       , 
      
     
       j 
      
     
       ) 
      
     
    
   
     ( 
    
   
     i 
    
   
     = 
    
   
     1 
    
   
     , 
    
   
     2 
    
   
     , 
    
   
     … 
    
   
     , 
    
   
     N 
    
   
     ) 
    
   
  
    b^{(i,j)}(i=1,2,…,N) 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 1.138em; vertical-align: -0.25em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal"&gt;b&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.888em;"&gt;&lt;span class="" style="top: -3.063em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;&lt;span class="mopen mtight"&gt;(&lt;/span&gt;&lt;span class="mord mathnormal mtight"&gt;i&lt;/span&gt;&lt;span class="mpunct mtight"&gt;,&lt;/span&gt;&lt;span class="mord mathnormal mtight" style="margin-right: 0.0572em;"&gt;j&lt;/span&gt;&lt;span class="mclose mtight"&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="mopen"&gt;(&lt;/span&gt;&lt;span class="mord mathnormal"&gt;i&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2778em;"&gt;&lt;/span&gt;&lt;span class="mrel"&gt;=&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2778em;"&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 1em; vertical-align: -0.25em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;1&lt;/span&gt;&lt;span class="mpunct"&gt;,&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.1667em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;2&lt;/span&gt;&lt;span class="mpunct"&gt;,&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.1667em;"&gt;&lt;/span&gt;&lt;span class="minner"&gt;…&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.1667em;"&gt;&lt;/span&gt;&lt;span class="mpunct"&gt;,&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.1667em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.109em;"&gt;N&lt;/span&gt;&lt;span class="mclose"&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; 的方法是缩放点积注意力 (Scaled Dot-Product Attention)。 结构如 &lt;strong&gt;图5&lt;/strong&gt; 所示。首先使用每个 &lt;span class="katex--inline"&gt;&lt;span class="katex"&gt;&lt;span class="katex-mathml"&gt; 
 
  
   
    
    
      q 
     
     
     
       ( 
      
     
       i 
      
     
       , 
      
     
       j 
      
     
       ) 
      
     
    
   
  
    q^{(i,j)} 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 1.0824em; vertical-align: -0.1944em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0359em;"&gt;q&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.888em;"&gt;&lt;span class="" style="top: -3.063em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;&lt;span class="mopen mtight"&gt;(&lt;/span&gt;&lt;span class="mord mathnormal mtight"&gt;i&lt;/span&gt;&lt;span class="mpunct mtight"&gt;,&lt;/span&gt;&lt;span class="mord mathnormal mtight" style="margin-right: 0.0572em;"&gt;j&lt;/span&gt;&lt;span class="mclose mtight"&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; 去与 &lt;span class="katex--inline"&gt;&lt;span class="katex"&gt;&lt;span class="katex-mathml"&gt; 
 
  
   
    
    
      k 
     
     
     
       ( 
      
     
       i 
      
     
       , 
      
     
       j 
      
     
       ) 
      
     
    
   
  
    k^{(i,j)} 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.888em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0315em;"&gt;k&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.888em;"&gt;&lt;span class="" style="top: -3.063em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;&lt;span class="mopen mtight"&gt;(&lt;/span&gt;&lt;span class="mord mathnormal mtight"&gt;i&lt;/span&gt;&lt;span class="mpunct mtight"&gt;,&lt;/span&gt;&lt;span class="mord mathnormal mtight" style="margin-right: 0.0572em;"&gt;j&lt;/span&gt;&lt;span class="mclose mtight"&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; 做 attention，这里说的 attention 就是匹配这两个向量有多接近，具体的方式就是计算向量的加权内积，得到 &lt;span class="katex--inline"&gt;&lt;span class="katex"&gt;&lt;span class="katex-mathml"&gt; 
 
  
   
    
    
      α 
     
     
     
       ( 
      
     
       i 
      
     
       , 
      
     
       j 
      
     
       ) 
      
     
    
   
  
    \alpha_{(i,j)} 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.7858em; vertical-align: -0.3552em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0037em;"&gt;α&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t vlist-t2"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.3448em;"&gt;&lt;span class="" style="top: -2.5198em; margin-left: -0.0037em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;&lt;span class="mopen mtight"&gt;(&lt;/span&gt;&lt;span class="mord mathnormal mtight"&gt;i&lt;/span&gt;&lt;span class="mpunct mtight"&gt;,&lt;/span&gt;&lt;span class="mord mathnormal mtight" style="margin-right: 0.0572em;"&gt;j&lt;/span&gt;&lt;span class="mclose mtight"&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-s"&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.3552em;"&gt;&lt;span class=""&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;。这里的加权内积计算方式如下所示：&lt;/p&gt; 
</code></pre> 
<p></p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
        
       
     </span><span class="katex-html"></span></span></span></span></p> 
<pre><code>       α 
      
      
      
        ( 
       
      
        1 
       
      
        , 
       
      
        i 
       
      
        ) 
       
      
     
    
      = 
     
     
     
       q 
      
     
       1 
      
     
    
      ∗ 
     
     
     
       k 
      
     
       i 
      
     
    
      / 
     
     
     
       d 
      
     
    
   
     \alpha_{(1,i)} = q^1 * k^i / \sqrt{d} 
    
   
 &lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.7858em; vertical-align: -0.3552em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0037em;"&gt;α&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t vlist-t2"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.3448em;"&gt;&lt;span class="" style="top: -2.5198em; margin-left: -0.0037em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;&lt;span class="mopen mtight"&gt;(&lt;/span&gt;&lt;span class="mord mtight"&gt;1&lt;/span&gt;&lt;span class="mpunct mtight"&gt;,&lt;/span&gt;&lt;span class="mord mathnormal mtight"&gt;i&lt;/span&gt;&lt;span class="mclose mtight"&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-s"&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.3552em;"&gt;&lt;span class=""&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2778em;"&gt;&lt;/span&gt;&lt;span class="mrel"&gt;=&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2778em;"&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 1.0585em; vertical-align: -0.1944em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0359em;"&gt;q&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.8641em;"&gt;&lt;span class="" style="top: -3.113em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;1&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2222em;"&gt;&lt;/span&gt;&lt;span class="mbin"&gt;∗&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2222em;"&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 1.2311em; vertical-align: -0.25em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0315em;"&gt;k&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.8747em;"&gt;&lt;span class="" style="top: -3.113em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mathnormal mtight"&gt;i&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="mord"&gt;/&lt;/span&gt;&lt;span class="mord sqrt"&gt;&lt;span class="vlist-t vlist-t2"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.9811em;"&gt;&lt;span class="svg-align" style="top: -3em;"&gt;&lt;span class="pstrut" style="height: 3em;"&gt;&lt;/span&gt;&lt;span class="mord" style="padding-left: 0.833em;"&gt;&lt;span class="mord mathnormal"&gt;d&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="" style="top: -2.9411em;"&gt;&lt;span class="pstrut" style="height: 3em;"&gt;&lt;/span&gt;&lt;span class="hide-tail" style="min-width: 0.853em; height: 1.08em;"&gt; 
        &lt;svg width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"&gt; 
         &lt;path d="M95,702
</code></pre> 
<p></p> 
<p>c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14<br> c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54<br> c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10<br> s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429<br> c69,-144,104.5,-217.7,106.5,-221<br> l0 -0<br> c5.3,-9.3,12,-14,20,-14<br> H400000v40H845.2724<br> s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7<br> c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z<br> M834 80h400000v40h-400000z"&gt;<br> <span class="vlist-s">​</span><span class="vlist-r"><span class="vlist"><span class=""></span></span></span></p> 
<p>其中，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
       
      
    </span><span class="katex-html"></span></span></span></p> 
<pre><code>     d 
    
   
  
    d 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.6944em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal"&gt;d&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; 是 &lt;span class="katex--inline"&gt;&lt;span class="katex"&gt;&lt;span class="katex-mathml"&gt; 
 
  
   
   
     q 
    
   
  
    q 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0359em;"&gt;q&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; 和 &lt;span class="katex--inline"&gt;&lt;span class="katex"&gt;&lt;span class="katex-mathml"&gt; 
 
  
   
   
     k 
    
   
  
    k 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.6944em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0315em;"&gt;k&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; 的维度，因为 &lt;span class="katex--inline"&gt;&lt;span class="katex"&gt;&lt;span class="katex-mathml"&gt; 
 
  
   
   
     q 
    
   
     ∗ 
    
   
     k 
    
   
  
    q*k 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.6597em; vertical-align: -0.1944em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0359em;"&gt;q&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2222em;"&gt;&lt;/span&gt;&lt;span class="mbin"&gt;∗&lt;/span&gt;&lt;span class="mspace" style="margin-right: 0.2222em;"&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.6944em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0315em;"&gt;k&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; 的数值会随着维度的增大而增大，因此除以 &lt;span class="katex--inline"&gt;&lt;span class="katex"&gt;&lt;span class="katex-mathml"&gt; 
 
  
   
    
    
      d 
     
    
   
  
    \sqrt{d} 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 1.04em; vertical-align: -0.1078em;"&gt;&lt;/span&gt;&lt;span class="mord sqrt"&gt;&lt;span class="vlist-t vlist-t2"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.9322em;"&gt;&lt;span class="svg-align" style="top: -3em;"&gt;&lt;span class="pstrut" style="height: 3em;"&gt;&lt;/span&gt;&lt;span class="mord" style="padding-left: 0.833em;"&gt;&lt;span class="mord mathnormal"&gt;d&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="" style="top: -2.8922em;"&gt;&lt;span class="pstrut" style="height: 3em;"&gt;&lt;/span&gt;&lt;span class="hide-tail" style="min-width: 0.853em; height: 1.08em;"&gt; 
       &lt;svg width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"&gt; 
        &lt;path d="M95,702
</code></pre> 
<p></p> 
<p>c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14<br> c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54<br> c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10<br> s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429<br> c69,-144,104.5,-217.7,106.5,-221<br> l0 -0<br> c5.3,-9.3,12,-14,20,-14<br> H400000v40H845.2724<br> s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7<br> c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z<br> M834 80h400000v40h-400000z"&gt;<br> <span class="vlist-s">​</span><span class="vlist-r"><span class="vlist"><span class=""></span></span></span> 的值也就相当于归一化的效果。</p> 
<p>接下来，把计算得到的 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
       
      
    </span><span class="katex-html"></span></span></span></p> 
<pre><code>      α 
     
     
     
       ( 
      
     
       i 
      
     
       , 
      
     
       j 
      
     
       ) 
      
     
    
   
  
    \alpha_{(i,j)} 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.7858em; vertical-align: -0.3552em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0037em;"&gt;α&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t vlist-t2"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.3448em;"&gt;&lt;span class="" style="top: -2.5198em; margin-left: -0.0037em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;&lt;span class="mopen mtight"&gt;(&lt;/span&gt;&lt;span class="mord mathnormal mtight"&gt;i&lt;/span&gt;&lt;span class="mpunct mtight"&gt;,&lt;/span&gt;&lt;span class="mord mathnormal mtight" style="margin-right: 0.0572em;"&gt;j&lt;/span&gt;&lt;span class="mclose mtight"&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-s"&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.3552em;"&gt;&lt;span class=""&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; 取 softmax 操作，再将其与 &lt;span class="katex--inline"&gt;&lt;span class="katex"&gt;&lt;span class="katex-mathml"&gt; 
 
  
   
    
    
      v 
     
     
     
       ( 
      
     
       i 
      
     
       , 
      
     
       j 
      
     
       ) 
      
     
    
   
  
    v^{(i,j)} 
   
  
&lt;/span&gt;&lt;span class="katex-html"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height: 0.888em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal" style="margin-right: 0.0359em;"&gt;v&lt;/span&gt;&lt;span class="msupsub"&gt;&lt;span class="vlist-t"&gt;&lt;span class="vlist-r"&gt;&lt;span class="vlist" style="height: 0.888em;"&gt;&lt;span class="" style="top: -3.063em; margin-right: 0.05em;"&gt;&lt;span class="pstrut" style="height: 2.7em;"&gt;&lt;/span&gt;&lt;span class="sizing reset-size6 size3 mtight"&gt;&lt;span class="mord mtight"&gt;&lt;span class="mopen mtight"&gt;(&lt;/span&gt;&lt;span class="mord mathnormal mtight"&gt;i&lt;/span&gt;&lt;span class="mpunct mtight"&gt;,&lt;/span&gt;&lt;span class="mord mathnormal mtight" style="margin-right: 0.0572em;"&gt;j&lt;/span&gt;&lt;span class="mclose mtight"&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; 相乘。&lt;/p&gt; 
</code></pre> 
<p></p> 
<p><img src="https://images2.imgbox.com/ed/0d/qfxYZDcA_o.png" alt=""></p> 
<p>具体代码实现如下所示。</p> 
<pre class="set-code-hide prettyprint"><code class="prism language-python has-numbering"><span class="token comment">#Multi-head Attention</span>
<span class="token keyword">class</span> <span class="token class-name">Attention</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Layer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
                 dim<span class="token punctuation">,</span>
                 num_heads<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span>
                 qkv_bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                 qk_scale<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 attn_drop<span class="token operator">=</span><span class="token number">0.</span><span class="token punctuation">,</span>
                 proj_drop<span class="token operator">=</span><span class="token number">0.</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>num_heads <span class="token operator">=</span> num_heads
        head_dim <span class="token operator">=</span> dim <span class="token operator">//</span> num_heads
        self<span class="token punctuation">.</span>scale <span class="token operator">=</span> qk_scale <span class="token keyword">or</span> head_dim<span class="token operator">**</span><span class="token operator">-</span><span class="token number">0.5</span>
        <span class="token comment"># 计算 q,k,v 的转移矩阵</span>
        self<span class="token punctuation">.</span>qkv <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>dim<span class="token punctuation">,</span> dim <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">,</span> bias_attr<span class="token operator">=</span>qkv_bias<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>attn_drop <span class="token operator">=</span> nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span>attn_drop<span class="token punctuation">)</span>
        <span class="token comment"># 最终的线性层</span>
        self<span class="token punctuation">.</span>proj <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>dim<span class="token punctuation">,</span> dim<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>proj_drop <span class="token operator">=</span> nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span>proj_drop<span class="token punctuation">)</span>
</code><pre><code>&lt;span class="token keyword"&gt;def&lt;/span&gt; &lt;span class="token function"&gt;forward&lt;/span&gt;&lt;span class="token punctuation"&gt;(&lt;/span&gt;self&lt;span class="token punctuation"&gt;,&lt;/span&gt; x&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;
    N&lt;span class="token punctuation"&gt;,&lt;/span&gt; C &lt;span class="token operator"&gt;=&lt;/span&gt; x&lt;span class="token punctuation"&gt;.&lt;/span&gt;shape&lt;span class="token punctuation"&gt;[&lt;/span&gt;&lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;&lt;span class="token punctuation"&gt;]&lt;/span&gt;
    &lt;span class="token comment"&gt;# 线性变换&lt;/span&gt;
    qkv &lt;span class="token operator"&gt;=&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;qkv&lt;span class="token punctuation"&gt;(&lt;/span&gt;x&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;.&lt;/span&gt;reshape&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token operator"&gt;-&lt;/span&gt;&lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; N&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token number"&gt;3&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;num_heads&lt;span class="token punctuation"&gt;,&lt;/span&gt; C &lt;span class="token operator"&gt;//&lt;/span&gt;
                               self&lt;span class="token punctuation"&gt;.&lt;/span&gt;num_heads&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;.&lt;/span&gt;transpose&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token number"&gt;2&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token number"&gt;0&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token number"&gt;3&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token number"&gt;4&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    &lt;span class="token comment"&gt;# 分割 query key value&lt;/span&gt;
    q&lt;span class="token punctuation"&gt;,&lt;/span&gt; k&lt;span class="token punctuation"&gt;,&lt;/span&gt; v &lt;span class="token operator"&gt;=&lt;/span&gt; qkv&lt;span class="token punctuation"&gt;[&lt;/span&gt;&lt;span class="token number"&gt;0&lt;/span&gt;&lt;span class="token punctuation"&gt;]&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; qkv&lt;span class="token punctuation"&gt;[&lt;/span&gt;&lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;]&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; qkv&lt;span class="token punctuation"&gt;[&lt;/span&gt;&lt;span class="token number"&gt;2&lt;/span&gt;&lt;span class="token punctuation"&gt;]&lt;/span&gt;
    &lt;span class="token comment"&gt;# Scaled Dot-Product Attention&lt;/span&gt;
    &lt;span class="token comment"&gt;# Matmul + Scale&lt;/span&gt;
    attn &lt;span class="token operator"&gt;=&lt;/span&gt; &lt;span class="token punctuation"&gt;(&lt;/span&gt;q&lt;span class="token punctuation"&gt;.&lt;/span&gt;matmul&lt;span class="token punctuation"&gt;(&lt;/span&gt;k&lt;span class="token punctuation"&gt;.&lt;/span&gt;transpose&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token number"&gt;0&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token number"&gt;3&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token number"&gt;2&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt; &lt;span class="token operator"&gt;*&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;scale
    &lt;span class="token comment"&gt;# SoftMax&lt;/span&gt;
    attn &lt;span class="token operator"&gt;=&lt;/span&gt; nn&lt;span class="token punctuation"&gt;.&lt;/span&gt;functional&lt;span class="token punctuation"&gt;.&lt;/span&gt;softmax&lt;span class="token punctuation"&gt;(&lt;/span&gt;attn&lt;span class="token punctuation"&gt;,&lt;/span&gt; axis&lt;span class="token operator"&gt;=&lt;/span&gt;&lt;span class="token operator"&gt;-&lt;/span&gt;&lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    attn &lt;span class="token operator"&gt;=&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;attn_drop&lt;span class="token punctuation"&gt;(&lt;/span&gt;attn&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    &lt;span class="token comment"&gt;# Matmul&lt;/span&gt;
    x &lt;span class="token operator"&gt;=&lt;/span&gt; &lt;span class="token punctuation"&gt;(&lt;/span&gt;attn&lt;span class="token punctuation"&gt;.&lt;/span&gt;matmul&lt;span class="token punctuation"&gt;(&lt;/span&gt;v&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;.&lt;/span&gt;transpose&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token number"&gt;0&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token number"&gt;2&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; &lt;span class="token number"&gt;3&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;.&lt;/span&gt;reshape&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token punctuation"&gt;(&lt;/span&gt;&lt;span class="token operator"&gt;-&lt;/span&gt;&lt;span class="token number"&gt;1&lt;/span&gt;&lt;span class="token punctuation"&gt;,&lt;/span&gt; N&lt;span class="token punctuation"&gt;,&lt;/span&gt; C&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    &lt;span class="token comment"&gt;# 线性变换&lt;/span&gt;
    x &lt;span class="token operator"&gt;=&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;proj&lt;span class="token punctuation"&gt;(&lt;/span&gt;x&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    x &lt;span class="token operator"&gt;=&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;proj_drop&lt;span class="token punctuation"&gt;(&lt;/span&gt;x&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    &lt;span class="token keyword"&gt;return&lt;/span&gt; x
</code></pre>
</pre> 
<div class="hljs-button {2}"></div> 
<div class="hide-preCode-box"> 
 <span class="hide-preCode-bt"><img class="look-more-preCode contentImg-no-view" src="https://images2.imgbox.com/e4/cf/8LnI4qvV_o.png" alt="" title=""></span> 
</div> 
<ul class="pre-numbering"><li>1</li><li>2</li><li>3</li><li>4</li><li>5</li><li>6</li><li>7</li><li>8</li><li>9</li><li>10</li><li>11</li><li>12</li><li>13</li><li>14</li><li>15</li><li>16</li><li>17</li><li>18</li><li>19</li><li>20</li><li>21</li><li>22</li><li>23</li><li>24</li><li>25</li><li>26</li><li>27</li><li>28</li><li>29</li><li>30</li><li>31</li><li>32</li><li>33</li><li>34</li><li>35</li><li>36</li><li>37</li><li>38</li><li>39</li></ul> 
<h4><a id="513_MLP_890"></a>5.1.3. 多层感知机（MLP）</h4> 
<p>Transformer 结构中还有一个重要的结构就是 MLP，即多层感知机，如 <strong>图6</strong> 所示。</p> 
<p><img src="https://images2.imgbox.com/bc/b8/RXwNQWAO_o.png" alt=""></p> 
<p>多层感知机由输入层、输出层和至少一层的隐藏层构成。网络中各个隐藏层中神经元可接收相邻前序隐藏层中所有神经元传递而来的信息，经过加工处理后将信息输出给相邻后续隐藏层中所有神经元。在多层感知机中，相邻层所包含的神经元之间通常使用“全连接”方式进行连接。多层感知机可以模拟复杂非线性函数功能，所模拟函数的复杂性取决于网络隐藏层数目和各层中神经元数目。多层感知机的结构如 <strong>图7</strong> 所示。</p> 
<p><img src="https://images2.imgbox.com/c7/e9/BaDru8qw_o.png" alt=""></p> 
<p>具体代码实现如下所示。</p> 
<pre class="set-code-hide prettyprint"><code class="prism language-python has-numbering"><span class="token keyword">class</span> <span class="token class-name">Mlp</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Layer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
                 in_features<span class="token punctuation">,</span>
                 hidden_features<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 out_features<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 act_layer<span class="token operator">=</span>nn<span class="token punctuation">.</span>GELU<span class="token punctuation">,</span>
                 drop<span class="token operator">=</span><span class="token number">0.</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        out_features <span class="token operator">=</span> out_features <span class="token keyword">or</span> in_features
        hidden_features <span class="token operator">=</span> hidden_features <span class="token keyword">or</span> in_features
        self<span class="token punctuation">.</span>fc1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_features<span class="token punctuation">,</span> hidden_features<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>act <span class="token operator">=</span> act_layer<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fc2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>hidden_features<span class="token punctuation">,</span> out_features<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>drop <span class="token operator">=</span> nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span>drop<span class="token punctuation">)</span>
</code><pre><code>&lt;span class="token keyword"&gt;def&lt;/span&gt; &lt;span class="token function"&gt;forward&lt;/span&gt;&lt;span class="token punctuation"&gt;(&lt;/span&gt;self&lt;span class="token punctuation"&gt;,&lt;/span&gt; x&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;
    &lt;span class="token comment"&gt;# 输入层：线性变换&lt;/span&gt;
    x &lt;span class="token operator"&gt;=&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;fc1&lt;span class="token punctuation"&gt;(&lt;/span&gt;x&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    &lt;span class="token comment"&gt;# 应用激活函数&lt;/span&gt;
    x &lt;span class="token operator"&gt;=&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;act&lt;span class="token punctuation"&gt;(&lt;/span&gt;x&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    &lt;span class="token comment"&gt;# Dropout&lt;/span&gt;
    x &lt;span class="token operator"&gt;=&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;drop&lt;span class="token punctuation"&gt;(&lt;/span&gt;x&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    &lt;span class="token comment"&gt;# 输出层：线性变换&lt;/span&gt;
    x &lt;span class="token operator"&gt;=&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;fc2&lt;span class="token punctuation"&gt;(&lt;/span&gt;x&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    &lt;span class="token comment"&gt;# Dropout&lt;/span&gt;
    x &lt;span class="token operator"&gt;=&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;drop&lt;span class="token punctuation"&gt;(&lt;/span&gt;x&lt;span class="token punctuation"&gt;)&lt;/span&gt;
    &lt;span class="token keyword"&gt;return&lt;/span&gt; x
</code></pre>
</pre> 
<div class="hljs-button {2}"></div> 
<div class="hide-preCode-box"> 
 <span class="hide-preCode-bt"><img class="look-more-preCode contentImg-no-view" src="https://images2.imgbox.com/f2/4a/1u0WbDz0_o.png" alt="" title=""></span> 
</div> 
<ul class="pre-numbering"><li>1</li><li>2</li><li>3</li><li>4</li><li>5</li><li>6</li><li>7</li><li>8</li><li>9</li><li>10</li><li>11</li><li>12</li><li>13</li><li>14</li><li>15</li><li>16</li><li>17</li><li>18</li><li>19</li><li>20</li><li>21</li><li>22</li><li>23</li><li>24</li><li>25</li><li>26</li><li>27</li></ul> 
<h4><a id="514_DropPath_939"></a>5.1.4. DropPath</h4> 
<p>除了以上重要模块意外，代码实现过程中还使用了DropPath（Stochastic Depth）来代替传统的Dropout结构，DropPath可以理解为一种特殊的 Dropout。其作用是在训练过程中随机丢弃子图层（randomly drop a subset of layers），而在预测时正常使用完整的 Graph。</p> 
<p>具体实现如下：</p> 
<pre class="set-code-hide prettyprint"><code class="prism language-python has-numbering"><span class="token keyword">def</span> <span class="token function">drop_path</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> drop_prob<span class="token operator">=</span><span class="token number">0.</span><span class="token punctuation">,</span> training<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> drop_prob <span class="token operator">==</span> <span class="token number">0.</span> <span class="token keyword">or</span> <span class="token keyword">not</span> training<span class="token punctuation">:</span>
        <span class="token keyword">return</span> x
    keep_prob <span class="token operator">=</span> paddle<span class="token punctuation">.</span>to_tensor<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> drop_prob<span class="token punctuation">)</span>
    shape <span class="token operator">=</span> <span class="token punctuation">(</span>paddle<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>ndim <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
    random_tensor <span class="token operator">=</span> keep_prob <span class="token operator">+</span> paddle<span class="token punctuation">.</span>rand<span class="token punctuation">(</span>shape<span class="token punctuation">,</span> dtype<span class="token operator">=</span>x<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span>
    random_tensor <span class="token operator">=</span> paddle<span class="token punctuation">.</span>floor<span class="token punctuation">(</span>random_tensor<span class="token punctuation">)</span>
    output <span class="token operator">=</span> x<span class="token punctuation">.</span>divide<span class="token punctuation">(</span>keep_prob<span class="token punctuation">)</span> <span class="token operator">*</span> random_tensor
    <span class="token keyword">return</span> output
</code></pre> 
<p><span class="token keyword">class</span> <span class="token class-name">DropPath</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Layer<span class="token punctuation">)</span><span class="token punctuation">:</span><br> <span class="token keyword">def</span> <span class="token function"><strong>init</strong></span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> drop_prob<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span><br> <span class="token builtin">super</span><span class="token punctuation">(</span>DropPath<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span><strong>init</strong><span class="token punctuation">(</span><span class="token punctuation">)</span><br> self<span class="token punctuation">.</span>drop_prob <span class="token operator">=</span> drop_prob</p> 
<pre><code>&lt;span class="token keyword"&gt;def&lt;/span&gt; &lt;span class="token function"&gt;forward&lt;/span&gt;&lt;span class="token punctuation"&gt;(&lt;/span&gt;self&lt;span class="token punctuation"&gt;,&lt;/span&gt; x&lt;span class="token punctuation"&gt;)&lt;/span&gt;&lt;span class="token punctuation"&gt;:&lt;/span&gt;
    &lt;span class="token keyword"&gt;return&lt;/span&gt; drop_path&lt;span class="token punctuation"&gt;(&lt;/span&gt;x&lt;span class="token punctuation"&gt;,&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;drop_prob&lt;span class="token punctuation"&gt;,&lt;/span&gt; self&lt;span class="token punctuation"&gt;.&lt;/span&gt;training&lt;sp
</code></pre>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f421388617d2bf9ad35ef94e5728212b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【BP分类】基于BP神经网络的数据分类预测附matlab代码</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2f27522fe293c7d3a245768b673525f2/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【信道容量】基于QPSK&#43;8PSK&#43;16PSK&#43;16QAM数字信号调制信道容量仿真附Matlab代码</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>