<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>3.2【微信小程序全栈开发课程】登录功能（一）--实现登录功能 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="3.2【微信小程序全栈开发课程】登录功能（一）--实现登录功能" />
<meta property="og:description" content="在本地搭建好后端环境之后，我们来实现登录功能
1、安装SDK插件 SDK插件用来获取用户的openId
SDK是server端（也就是后端）的插件，帮助我们很容易的获取openId。openId是微信中用户身份的唯一标识，我们通过openId来识别用户，方便后期的用户管理
~/WeChatProjects/truth_hold$ npm install --save wafer2-client-sdk //系统返回信息 &#43; wafer2-client-sdk@2.1.0 added 1 package from 1 contributor and audited 10626 packages in 10.382s &gt; wafer2-client-sdk应用文档 https://github.com/tencentyun/wafer2-client-sdk 2、添加授权登录按钮 编辑src/pages/index/index.vue文件的template部分，添加授权登录的按钮
登录按钮是小程序小程序集成的API，规定的登录按钮的写法
&lt;!-- 参考代码，无需粘贴 &lt;template&gt; &lt;div&gt; —&gt; &lt;!-- 需要粘贴的部分 --&gt; &lt;button open-type=&#34;getUserInfo&#34; lang=&#34;zh_CN&#34; class=&#39;btn&#39; @getuserinfo=&#34;login&#34;&gt;授权登录&lt;/button&gt; 3、配置登录链接 编辑src/config.js文件，config.js文件我们用来放配置型的代码，用下面的代码替换掉原先的代码
登录链接为什么是http://localhost:5757/weapp/login，后面的课程会具体分析
//域名，通过域名来找到服务器，在这里我们将本地电脑当成服务器 //所以现在配置的域名是本地的，当项目实际上线，这里需要换成已备案的域名 const host = &#39;http://localhost:5757&#39; const config = { host, loginUrl: `${host}/weapp/login` } //我们在【ES6知识点详解】中讲过export的意思是向外暴露接口 //这样在其他文件中可以通过import config from &#39;@/config&#39;引用 //然后通过config.loginUrl就能得到在本文件中配置的值&#39;http://localhost:5757/weapp/login&#39; export default config 4、删除测试代码 在第二章学习ES6时，我们在index." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/9fd9eccafc829c8861d5fe8f0b3386b9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-10-16T11:32:45+08:00" />
<meta property="article:modified_time" content="2019-10-16T11:32:45+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">3.2【微信小程序全栈开发课程】登录功能（一）--实现登录功能</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-dracula">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>在本地搭建好后端环境之后，我们来实现登录功能</p> 
<h5><a id="1SDK_2"></a>1、安装SDK插件</h5> 
<p>SDK插件用来获取用户的openId</p> 
<p>SDK是server端（也就是后端）的插件，帮助我们很容易的获取openId。openId是微信中用户身份的唯一标识，我们通过openId来识别用户，方便后期的用户管理</p> 
<pre><code class="prism language-shell">~/WeChatProjects/truth_hold$ <span class="token function">npm</span> <span class="token function">install</span> --save wafer2-client-sdk

//系统返回信息
+ wafer2-client-sdk@2.1.0
added 1 package from 1 contributor and audited 10626 packages <span class="token keyword">in</span> 10.382s
<span class="token operator">&gt;</span> wafer2-client-sdk应用文档
https://github.com/tencentyun/wafer2-client-sdk
</code></pre> 
<h5><a id="2_16"></a>2、添加授权登录按钮</h5> 
<p>编辑src/pages/index/index.vue文件的template部分，添加授权登录的按钮</p> 
<p>登录按钮是小程序小程序集成的API，规定的登录按钮的写法</p> 
<pre><code class="prism language-html"><span class="token comment">&lt;!-- 参考代码，无需粘贴
&lt;template&gt;
  &lt;div&gt; —&gt;


    &lt;!-- 需要粘贴的部分 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">open-type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>getUserInfo<span class="token punctuation">"</span></span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>zh_CN<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>btn<span class="token punctuation">'</span></span> <span class="token attr-name">@getuserinfo</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>login<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>授权登录<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h5><a id="3_30"></a>3、配置登录链接</h5> 
<p>编辑src/config.js文件，config.js文件我们用来放配置型的代码，用下面的代码替换掉原先的代码</p> 
<p>登录链接为什么是<code>http://localhost:5757/weapp/login</code>，后面的课程会具体分析</p> 
<pre><code class="prism language-js"><span class="token comment">//域名，通过域名来找到服务器，在这里我们将本地电脑当成服务器</span>
<span class="token comment">//所以现在配置的域名是本地的，当项目实际上线，这里需要换成已备案的域名</span>
<span class="token keyword">const</span> host <span class="token operator">=</span> <span class="token string">'http://localhost:5757'</span>

<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
  host<span class="token punctuation">,</span>
  loginUrl<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/weapp/login`</span></span>
<span class="token punctuation">}</span>

<span class="token comment">//我们在【ES6知识点详解】中讲过export的意思是向外暴露接口</span>
<span class="token comment">//这样在其他文件中可以通过import config from '@/config'引用</span>
<span class="token comment">//然后通过config.loginUrl就能得到在本文件中配置的值'http://localhost:5757/weapp/login'</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> config
</code></pre> 
<h5><a id="4_50"></a>4、删除测试代码</h5> 
<p>在第二章学习ES6时，我们在index.vue界面添加了一些代码，现在将这些测试代码删除，删除后</p> 
<pre><code class="prism language-js"><span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
  <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">data</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
        mark<span class="token punctuation">:</span><span class="token number">0</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    methods<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">addMark</span> <span class="token punctuation">(</span>add<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>mark <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mark <span class="token operator">+</span> add
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"mark为："</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>mark<span class="token punctuation">)</span>  
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre> 
<h5><a id="5_71"></a>5、引用配置文件</h5> 
<p>在src/pages/index/index.vue文件中添加import引用SDK插件、config.js文件</p> 
<pre><code class="prism language-js"><span class="token comment">//参考代码，无需粘贴</span>
<span class="token comment">//&lt;script&gt;</span>


  <span class="token comment">//需要粘贴的部分</span>
  <span class="token keyword">import</span> qcloud <span class="token keyword">from</span> <span class="token string">'wafer2-client-sdk'</span>
  <span class="token keyword">import</span> config <span class="token keyword">from</span> <span class="token string">'@/config'</span>


  <span class="token comment">//参考代码，无需粘贴</span>
  <span class="token comment">//export default {<!-- --></span>
</code></pre> 
<h5><a id="6_87"></a>6、添加登录方法</h5> 
<p>编辑index.vue文件，在script的methods对象中添加方法loginSuccess和login</p> 
<pre><code class="prism language-js"><span class="token comment">//参考代码，无需粘贴</span>
<span class="token comment">//methods: {<!-- --></span>
  <span class="token comment">//addMark (add) {<!-- --></span>
    <span class="token operator">...</span>
  <span class="token comment">//},</span>


  <span class="token comment">//需要粘贴的部分</span>
  <span class="token comment">//登录成功会调用loginSuccess方法</span>
  <span class="token function">loginSuccess</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//将用户信息保存到缓存中，wx.setStorageSync是小程序的一个API，用来将信息添加到缓存中</span>
    wx<span class="token punctuation">.</span><span class="token function">setStorageSync</span><span class="token punctuation">(</span><span class="token string">'userinfo'</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token function">login</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//wx.showToast是小程序的消息提示框</span>
    wx<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      title<span class="token punctuation">:</span> <span class="token string">'登录中'</span><span class="token punctuation">,</span>
      icon<span class="token punctuation">:</span> <span class="token string">'loading'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">//通过SDK插件，请求config.js中配置的loginUrl路径（http://localhost:5757/weapp/login）</span>
    qcloud<span class="token punctuation">.</span><span class="token function">setLoginUrl</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>loginUrl<span class="token punctuation">)</span>
    qcloud<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      success<span class="token punctuation">:</span> res <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//登录成功后，显示底部导航栏</span>
        wx<span class="token punctuation">.</span><span class="token function">showTabBar</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'登录成功'</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span>
        <span class="token comment">//调用loginSuccess方法，并将用户信息作为参数</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">loginSuccess</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>

      fail<span class="token punctuation">:</span> err <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'登录失败'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>


<span class="token comment">//参考代码，无需粘贴</span>
<span class="token comment">//},</span>
</code></pre> 
<h5><a id="7_132"></a>7、授权本地域名</h5> 
<p>我们在src/config.js文件中定义的域名http://localhost:5757，不是一个真正的域名，只有在我们自己电脑上才有效</p> 
<p>真正的域名如http://baidu.com是可以通过网络访问的</p> 
<p>对于这种不合法的域名，在微信开发者工具中，需要授权一下</p> 
<p>点击右上角&gt;&gt;图标，点击详情—本地设置，选中不校验合法域名，就可以了~</p> 
<p><img src="https://images2.imgbox.com/45/27/Y2AQm5OM_o.png" alt=""></p> 
<p><img src="https://images2.imgbox.com/7e/19/HGs2KYPi_o.png" alt=""></p> 
<h5><a id="8_146"></a>8、测试</h5> 
<h6><a id="1npm_run_dev_148"></a>（1）打开终端，进入项目目录，打开两个窗口同时运行npm run dev</h6> 
<p>第一个窗口，在项目目录下运行<code>npm run dev</code>用来启动前端代码</p> 
<pre><code class="prism language-js"><span class="token operator">~</span><span class="token operator">/</span>WeChatProjects<span class="token operator">/</span>truth_hold$ npm run dev
</code></pre> 
<p>第二个窗口，在server目录下运行<code>npm run dev</code>用来启动后端代码</p> 
<pre><code class="prism language-js"><span class="token operator">~</span><span class="token operator">/</span>WeChatProjects<span class="token operator">/</span>truth_hold<span class="token operator">/</span>server$ npm run dev
</code></pre> 
<p>然后点击授权登录按钮，右侧控制台出现下列信息，说明登录成功了</p> 
<p>控制台中出现的，就是登录接口获取到的当前登录用户的微信昵称、城市、openId等信息</p> 
<p><img src="https://images2.imgbox.com/0f/29/8KQ0sxlN_o.png" alt=""></p> 
<h6><a id="2_Error__164"></a>（2）登录可能出现错误–登录失败 Error: 响应错误</h6> 
<p><img src="https://images2.imgbox.com/c9/bf/LQtp58YP_o.png" alt=""><br> <strong>解决方法：</strong><br> 完善server/config.js文件中的下列字段</p> 
<pre><code class="prism language-json">qcloudAppId<span class="token punctuation">:</span> <span class="token string">'必填'</span><span class="token punctuation">,</span>
qcloudSecretId<span class="token punctuation">:</span> <span class="token string">'必填'</span><span class="token punctuation">,</span>
qcloudSecretKey<span class="token punctuation">:</span> <span class="token string">'必填'</span><span class="token punctuation">,</span>
<span class="token comment">// 微信小程序 App ID</span>
appId<span class="token punctuation">:</span> <span class="token string">'必填'</span><span class="token punctuation">,</span>
<span class="token comment">// 微信小程序 App Secret</span>
appSecret<span class="token punctuation">:</span> <span class="token string">'必填'</span><span class="token punctuation">,</span>
<span class="token comment">// 是否使用腾讯云代理登录小程序，设置为false</span>
useQcloudLogin<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
</code></pre> 
<ul><li> <p>qcloudAppId、qcloudSecretId、qcloudSecretKey这三个参数，我们在上一节已经配置过了。</p> </li><li> <p>appId、appSecret这两个参数需要在微信公众平台（<a href="https://mp.weixin.qq.com/" rel="nofollow">https://mp.weixin.qq.com/</a>）登录小程序账号—开发—开发设置中查看。</p> </li><li> <p>useQcloudLogin参数改为false<br> <img src="https://images2.imgbox.com/67/54/qgIIPHnQ_o.png" alt=""></p> </li></ul> 
<h5><a id="9_186"></a>9、查看数据库</h5> 
<p>登录mysql，可以看到cSessionInfo表中已经有一条客户信息了</p> 
<p>我们主要会用到user_info字段，里面包含了openId、nickName等用户基本的信息</p> 
<pre><code class="prism language-mysql">mysql&gt; use cAuth;

mysql&gt; select * from cSessionInfo;
| open_id                      | uuid                                 | skey                                     | create_time         | last_visit_time     | session_key              | user_info                                                                                                                                                                                                                                                                                                                                                         
+------------------------------+--------------------------------------+--------------------
| oqURH46cYrMV3IwrrflosChndRTI | 88d1f834-bd64-491e-9779-18f3653528cc | dcd4a49ed87a0f4ebdff0f40ee4a53ed5572aa01 | 2019-06-16 11:19:43 | 2019-06-16 20:13:53 | aZha8RCFtrY1mp98kj9hSg== | {"openId":"oqURH46cYrMV3IwrrflosChndRTI","nickName":"ww","gender":2,"language":"zh_CN","city":"Qingdao","province":"Shandong","country":"China","avatarUrl":"https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJ2Te6nOOqiaeiae0WCWxRHKedpM7ZOs8AIU6og0ia1WChutbiaaaibthT7GbrewG0licrkbps8XajcHXzQ/132","watermark":{"timestamp":1560687233,"appid":"wxd2a52ff3594d8d7d"}} |
+------------------------------+--------------------------------------+--------------------
1 row in set (0.00 sec)
</code></pre> 
<blockquote> 
 <p><strong>作者：猫宁一</strong><br> 95后全栈程序媛₍ᐢ •⌄• ᐢ₎一枚~ 热爱学习！热爱编程！<br> 可关注【猫宁一】公众号领取我所有全栈项目代码哦~</p> 
 <p><strong>点击查看课程目录：</strong><a href="https://blog.csdn.net/shine_a/article/details/102566724">微信小程序全栈开发课程目录</a></p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/8e/c2/FYpEAf7D_o.png" alt=""></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/646b5f5e1ba29ffc0d1eaffe9c49ecd8/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">利用jieba对已爬取好的中国地名信息进行分词</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f409f07d02d02e9c1a7c3fa5134b37b8/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">JSTL fn函数使用总结</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>