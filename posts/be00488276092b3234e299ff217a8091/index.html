<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>pytest自动化测试两种执行环境切换的解决方案 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="pytest自动化测试两种执行环境切换的解决方案" />
<meta property="og:description" content="目录
一、痛点分析
方法一：Hook方法pytest_addoption注册命令行参数
1、Hook方法注解
2、使用方法
方法二：使用插件pytest-base-url进行命令行传参
一、痛点分析 在实际企业的项目中，自动化测试的代码往往需要在不同的环境中进行切换，比如多套测试环境、预上线环境、UAT环境、线上环境等等，并且在DevOps理念中，往往自动化都会与Jenkins进行CI/CD，不论是定时执行策略还是迭代测试，那么问题来了，难道每次切换环境都需要提供一套测试代码？或者每次切换都要需修改我们的自动化环境配置？答案当然不是，不然怎么能叫测试自动化呢！　在未使用pytest的Hook相关方法之前，切换环境我们一般会使用python的内置模块sys，它有一个argv的方法，可以从我们的命令行接收参数，通过它也可以实现上面的需求，就像如下部分代码这样：
try: if sys.argv[1] == &#39;-p&#39;: # 预上线环境 conf_url.write_value(filename=CONFIGS_FILE_PATH_URL, data=p_api_address) modify_properties_url(filename=ENVIRONMENT_PROPERTIES_PATH, url=p_api_address[&#34;request&#34;][&#34;url&#34;]) elif sys.argv[1] in [f&#39;t{i}&#39; for i in range(1, 8)]: # 测试环境 conf_url.write_value(filename=CONFIGS_FILE_PATH_URL, data=test_api_address(sys.argv[1][1:])) modify_properties_url(filename=ENVIRONMENT_PROPERTIES_PATH, url=test_api_address(sys.argv[1][1:])[&#34;request&#34;][&#34;url&#34;]) else: case_logger.error(&#34;Please confirm the environmental information.&#34;) print(&#34;Please confirm the environmental information.&#34;) raise Exception except IndexError: # 生产环境 conf_url.write_value(filename=CONFIGS_FILE_PATH_URL, data=formal_api_address) modify_properties_url(filename=ENVIRONMENT_PROPERTIES_PATH, url=formal_api_address[&#34;request&#34;][&#34;url&#34;]) 这种方式我们需要使用 &#34;python xxx.py -p&#34; 这种方式进行环境切换，然后再执行pytest命令行去执行测试用例，但是这种方法能在pytest的命令行中使用吗？能不能将环境切换的命令行也集成到pytest的命令行中，执行整个自动化项目只使用一条命令行呢？
方法一：Hook方法pytest_addoption注册命令行参数 1、Hook方法注解 pytest_addoption：可以让用户注册一个自定义的命令行参数，方便用户将数据传递给 pytest这个 Hook 方法一般和内置 fixture pytestconfig 配合使用pytest_addoption 注册命令行参数，pytestconfig 通过配置对象读取参数的值 2、使用方法 1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/be00488276092b3234e299ff217a8091/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-09-03T19:31:54+08:00" />
<meta property="article:modified_time" content="2023-09-03T19:31:54+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">pytest自动化测试两种执行环境切换的解决方案</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="blogTitle0-toc" style="margin-left:40px;"><a href="#blogTitle0" rel="nofollow">一、痛点分析</a></p> 
<p id="blogTitle1-toc" style="margin-left:40px;"><a href="#blogTitle1" rel="nofollow">方法一：Hook方法pytest_addoption注册命令行参数</a></p> 
<p id="blogTitle2-toc" style="margin-left:80px;"><a href="#blogTitle2" rel="nofollow">1、Hook方法注解</a></p> 
<p id="blogTitle3-toc" style="margin-left:40px;"><a href="#blogTitle3" rel="nofollow">2、使用方法</a></p> 
<p id="blogTitle4-toc" style="margin-left:40px;"><a href="#blogTitle4" rel="nofollow">方法二：使用插件pytest-base-url进行命令行传参</a></p> 
<hr id="hr-toc"> 
<p></p> 
<h3 id="blogTitle0">一、痛点分析</h3> 
<p>　　在实际企业的项目中，自动化测试的代码往往需要在不同的环境中进行切换，比如多套测试环境、预上线环境、UAT环境、线上环境等等，并且在DevOps理念中，往往自动化都会与Jenkins进行CI/CD，不论是定时执行策略还是迭代测试，那么问题来了，难道每次切换环境都需要提供一套测试代码？或者每次切换都要需修改我们的自动化环境配置？答案当然不是，不然怎么能叫测试自动化呢！　　在未使用pytest的Hook相关方法之前，切换环境我们一般会使用python的内置模块sys，它有一个argv的方法，可以从我们的命令行接收参数，通过它也可以实现上面的需求，就像如下部分代码这样：</p> 
<pre><code class="hljs">
try:
    if sys.argv[1] == '-p':
        # 预上线环境
        conf_url.write_value(filename=CONFIGS_FILE_PATH_URL,
                             data=p_api_address)
        modify_properties_url(filename=ENVIRONMENT_PROPERTIES_PATH,
                              url=p_api_address["request"]["url"])
    elif sys.argv[1] in [f't{i}' for i in range(1, 8)]:
        # 测试环境
        conf_url.write_value(filename=CONFIGS_FILE_PATH_URL,
                             data=test_api_address(sys.argv[1][1:]))
        modify_properties_url(filename=ENVIRONMENT_PROPERTIES_PATH,
                              url=test_api_address(sys.argv[1][1:])["request"]["url"])
    else:
        case_logger.error("Please confirm the environmental information.")
        print("Please confirm the environmental information.")
        raise Exception
except IndexError:
    # 生产环境
    conf_url.write_value(filename=CONFIGS_FILE_PATH_URL,
                         data=formal_api_address)
    modify_properties_url(filename=ENVIRONMENT_PROPERTIES_PATH,
                          url=formal_api_address["request"]["url"])</code></pre> 
<p></p> 
<p>　　这种方式我们需要使用 "python xxx.py -p" 这种方式进行环境切换，然后再执行pytest命令行去执行测试用例，但是这种方法能在pytest的命令行中使用吗？能不能将环境切换的命令行也集成到pytest的命令行中，执行整个自动化项目只使用一条命令行呢？</p> 
<h3 id="blogTitle1">方法一：Hook方法pytest_addoption注册命令行参数</h3> 
<h4 id="blogTitle2">1、Hook方法注解</h4> 
<ul><li>pytest_addoption：可以让用户注册一个自定义的命令行参数，方便用户将数据传递给 pytest</li><li>这个 Hook 方法一般和内置 fixture pytestconfig 配合使用</li><li>pytest_addoption 注册命令行参数，pytestconfig 通过配置对象读取参数的值</li></ul> 
<h3 id="blogTitle3">2、使用方法</h3> 
<p>1.一般编写到conftest.py文件中</p> 
<p>2.定义pytest_addoption方法注册pytest命令行参数，函数名和参数保持一致</p> 
<pre>def pytest_addoption(parser):
    """注册自定义参数 env 到配置对象"""
    parser.addoption("--env", action="store",
                     default="https://www.cnblogs.com/",
                     help="将命令行参数 ’--env' 添加到 pytest 配置中")</pre> 
<p>parser.addoption参数说明：</p> 
<ul><li>name：自定义命令行参数的名字，可以是："xx"， "-xx" 或 "--xx"</li><li>action：在命令行中遇到此参数时要采取的基本操作类型 
  <ul><li>- store：默认，只存储参数的值，可以存储任何类型的值，此时 default 也可以是任何类型的值，而且命令行参数多次使用也只能生效一个，最后一个值覆盖之前的值</li><li>- append：存储一个列表，用 append 模式将可以同时多次使用自定义参数，并且 default  默认值必须是一个列表，pytest 会把 default  默认参数的值和多个自定义参数的值放在一个列表中</li><li>- store_const：用 const 为命令行参数指定一个常量值，必须和 const 参数同时使用，使用这个模式后命令行参数不能赋值</li></ul></li><li>- append_const：存储一个列表，使用 const 为命令行参数指定一个常量值，并将 default 默认值和 const  常量值添加到列表中，这个模式可以同时多次使用自定义参数，但是还是不能赋值，只能使用常量</li><li>nargs：应该使用的命令行参数的数量</li><li>const：某些操作和nargs选择所需的常量值</li><li>default：如果参数的值不在命令行中，则使用默认值</li><li>type：可以是 python 的基础类型，比如：int，str，float，list 等类型，如果不指定类型的话，pytest会把接受到的参数值都默认为 str 类型，所以我们有时需要指定参数的类型，在使用 type 指定类型时，也需要把 default 的类型修改为同样的类型！</li><li>choices：choices 可以指定几个值，自定义参数必须在这几个值中选择一个，否则会报错</li><li>required：命令行选项是否可以省略（仅可选）</li><li>help：对参数作用的简要说明</li><li>metavar：用法消息中参数的名称</li><li>dest：要添加到 parse_args() 返回的对象中的属性的名称</li></ul> 
<p>3.使用request.config.getoption("--命令行")获取命令行参数的值</p> 
<pre>@pytest.fixture(scope="session")
def get_env(request):
    """从配置对象中读取自定义参数的值"""
    return request.config.getoption("--env")</pre> 
<p>4.fixture继承，进行环境切换</p> 
<pre>@pytest.fixture(autouse=True)
def set_env(get_env):
    """将自定义参数的值写入全局配置文件"""
    with open(ENV_TXT_FILE, 'w', encoding='utf-8') as f:
        f.write(get_env)</pre> 
<p>5.通过pytest命令行传参一键化实现环境切换和测试用例执行</p> 
<p></p> 
<p class="img-center"><img alt="" height="657" src="https://images2.imgbox.com/d7/c0/Qutin9Oq_o.png" width="1200"></p> 
<p></p> 
<p class="img-center"><img alt="" height="128" src="https://images2.imgbox.com/ed/70/91j8X65t_o.png" width="438"></p> 
<h3 id="blogTitle4">方法二：使用插件pytest-base-url进行命令行传参</h3> 
<p>1.安装pytest-base-url</p> 
<pre>pip install pytest-base-url -i https://pypi.douban.com/simple</pre> 
<p>2.将base_url参数传入到fixture函数中</p> 
<p></p> 
<pre><code class="hljs">@pytest.fixture
def driver_setup(base_url):
    try:
        URL = base_url
        start_chrome(URL, options=browser_options(), headless=False)
        driver = get_driver()
    except Exception as e:
        log.error(e)
    else:
        yield driver</code></pre> 
<p></p> 
<p>3.pytest命令行传参</p> 
<p>　　使用 --base-url https://www.xxx.com/ 形式传参</p> 
<pre>pytest --base-url https://www.cnblogs.com/</pre> 
<p>第一种不局限于环境切换，任何想通过pytest命令行传入自定义的参数都可以通过方法一实现，因此杀鸡焉用牛刀，环境切换优先推荐方法二！</p> 
<div class="csdn-video-box"> 
 <iframe id="zK3vfmN4-1693740697714" frameborder="0" src="https://player.bilibili.com/player.html?aid=445639515" allowfullscreen="true" data-mediaembed="bilibili"></iframe> 
 <p>这可能是B站最详细的pytest自动化测试框架教程，整整100小时，全程实战！！！</p> 
</div>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d01488a66193fd1368cd39639511c54e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Vue-组件二次封装</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a09eb2081587ade3305d7257869b27fb/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">初识数据结构与算法篇</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>