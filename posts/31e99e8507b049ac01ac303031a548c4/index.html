<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Halcon DeepLearning初识 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Halcon DeepLearning初识" />
<meta property="og:description" content="Halcon提供三种类型神经网络： 1、Classification（分类） 2、Object Detection（目标检测） 3、Semantic Segmentation（语义分割） 工作流程： 一、准备网络和数据
使用的网络：可以使用预训练过的网络或者创建一个新的网络，我使用的是18.11.1.0版本有三种网络供选择：
&#39;pretrained_dl_classifier_compact.hdl&#39;：需要图像格式为&#39;real&#39;，该网络不包含全连接层，要求最小图片尺寸大于15*15
&#39;pretrained_dl_classifier_enhanced.hdl&#39;：比上个能处理更复杂的图像，需要图像格式为&#39;read&#39;，最小尺寸要求大于47*47，
&#39;pretrained_dl_classifier_resnet50.hdl&#39;：需要图像格式为&#39;real&#39;，最小尺寸要求大于32*32.
上述三种网络均需要设置基本参数：&#39;image_width&#39;，&#39;image_height&#39;，&#39;image_num_channels&#39;，&#39;image_range_min&#39;，&#39;image_range_max‘，即图像宽高、通道数、灰度范围。准备数据：分类好训练样本的种类准备对应需求的大量图片（例如：图像维度、灰度范围等），在原图基础上还需要进行预处理，剔除背景影响，最大程度突出主体部分。
预处理操作：阈值化，提取特征roi，转换图像格式到&#39;real&#39;，合成3通道图像等等。做好训练集、验证集、测试集：一般地按照70%，15%，15%比例分类。 二、训练网络和评估训练进度
设置超参数适用任务和系统
set_dl_classifier_param：设置&#39;batch_size&#39;，&#39;batch_size_device&#39;，&#39;classes&#39;，&#39;gpu&#39;，&#39;image_width&#39;，&#39;image_height‘，&#39;image_num_channels&#39;，&#39;image_dimensions&#39;，&#39;learning_rate&#39;，&#39;momentum’，&#39;runtime&#39;，&#39;runtime_init&#39;，&#39;weight_prior&#39; 参数名名称定义运用批量大小batch_size批处理中图像(和相应标签)的数量，即在一次训练迭代中同时处理的图像数量。 set_dl_classifier_param(DLClassifierHandle,&#39;batch_size‘,Batch_Size)
批量大小设备
batch_size_device传输到设备存储器的批处理中的图像数目。设置为小于等于批量大小。 set_dl_classifier_param
(DLClassifierHandle,&#39;batch_size_device‘,Batch_Size)
类名classes与要识别的对象类相对应的标签组。set_dl_classifier_param(DLClassifierHandle,&#39;classes‘,Classes)gpugpuGPU标识符 set_dl_classifier_param
(DLClassifierHandle,&#39;gpu&#39;,GPU)
图像宽度image_width过程处理图像宽度 set_dl_classifier_param(DLClassifierHandle,&#39;image_width‘,Width)
图像高度image_height过程处理图像高度 set_dl_classifier_param(DLClassifierHandle,&#39;image_height‘,Height)
图像通道数image_num_channels处理图像的通道数 set_dl_classifier_param
(DLClassifierHandle,&#39;image_num_channels‘,Channels)
图像维度image_dimensions包含图像尺寸“image_width”、“image_height”和通道数量“image_num_channels”的元组。 set_dl_classifier_param
(DLClassifierHandle,&#39;image_dimensions‘,Dimensions)
学习率learning_rate训练中决定梯度影响因素的初始值。默认0.001set_dl_classifier_param(DLClassifierHandle,&#39;learning_rate&#39;,Rate)动量momentum损失函数的动量参数。默认0.9set_dl_classifier_param(DLClassifierHandle,&#39;momentum‘,Momentum)运行环境runtime执行的设备。默认&#39;gpu‘ set_dl_classifier_param(DLClassifierHandle,&#39;runtime&#39;,&#39;cpu&#39;)
set_dl_classifier_param(DLClassifierHandle,&#39;runtime&#39;,&#39;gpu&#39;)
运行环境runtime_init执行环境初始化使用&#39;immediately&#39;，初始化GPU。否则不初始化。set_dl_classifier_param(DLClassifierHandle,&#39;runtime_init&#39;,&#39;immediately&#39;)正则化参数weight_prior用于损失函数防止过拟合，默认0非0，则使用set_dl_classifier_param(DLClassifierHandle,&#39;weight_prior&#39;,WeightPrior)一般的设置：
* ** 训练 Halcon语法** * * 读取训练模型 read_dl_classifier (&#39;pretrained_dl_classifier_compact.hdl&#39;, DLClassifierHandle) * 训练图像目录 RawDataFolder := &#39;food/&#39; &#43; [&#39;apple_braeburn&#39;,&#39;apple_golden_delicious&#39;,&#39;apple_topaz&#39;,&#39;peach&#39;,&#39;pear&#39;] * 获取图像内容和标签 read_dl_classifier_data_set (RawDataFolder, &#39;last_folder&#39;, RawImageFiles, Labels, LabelIndices, Classes) * 预处理数据集的输出目录路径 PreprocessedFolder := &#39;fruit_preprocessed&#39; * 关闭覆盖图像." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/31e99e8507b049ac01ac303031a548c4/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-11-02T14:13:14+08:00" />
<meta property="article:modified_time" content="2020-11-02T14:13:14+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Halcon DeepLearning初识</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2>Halcon提供三种类型神经网络：</h2> 
<h3>1、Classification（分类）</h3> 
<p><img alt="" height="94" src="https://images2.imgbox.com/a3/44/yJ2Eodv8_o.png" width="368"></p> 
<h3>2、Object Detection（目标检测）</h3> 
<p><img alt="" height="99" src="https://images2.imgbox.com/a8/15/JaDJXgZW_o.png" width="411"></p> 
<h3>3、Semantic Segmentation（语义分割）</h3> 
<p><img alt="" height="94" src="https://images2.imgbox.com/7a/39/jgZxKmwU_o.png" width="504"></p> 
<h3><strong>工作流程：</strong></h3> 
<p><strong>    一、准备网络和数据</strong></p> 
<ul><li>使用的网络：可以使用预训练过的网络或者创建一个新的网络，我使用的是18.11.1.0版本有三种网络供选择：<br>  'pretrained_dl_classifier_compact.hdl'：需要图像格式为'real'，该网络不包含全连接层，要求最小图片尺寸大于15*15<br> 'pretrained_dl_classifier_enhanced.hdl'：比上个能处理更复杂的图像，需要图像格式为'read'，最小尺寸要求大于47*47，<br> 'pretrained_dl_classifier_resnet50.hdl'：需要图像格式为'real'，最小尺寸要求大于32*32.<br> 上述三种网络均需要设置基本参数：'image_width'，'image_height'，'image_num_channels'，'image_range_min'，'image_range_max‘，即图像宽高、通道数、灰度范围。</li><li>准备数据：分类好训练样本的种类</li><li>准备对应需求的大量图片（例如：图像维度、灰度范围等），在原图基础上还需要进行预处理，剔除背景影响，最大程度突出主体部分。<br> 预处理操作：阈值化，提取特征roi，转换图像格式到'real'，合成3通道图像等等。</li><li>做好训练集、验证集、测试集：一般地按照70%，15%，15%比例分类。</li></ul> 
<p><strong>     二、训练网络和评估训练进度</strong></p> 
<ul><li>设置超参数适用任务和系统<br> set_dl_classifier_param：设置'batch_size'，'batch_size_device'，'classes'，'gpu'，'image_width'，'image_height‘，'image_num_channels'，'image_dimensions'，'learning_rate'，'momentum’，'runtime'，'runtime_init'，'weight_prior' 
  <table border="3" cellpadding="2" cellspacing="1" style="width:415px;"><tbody><tr><td style="width:144px;">参数名</td><td style="width:227px;">名称</td><td style="width:183px;">定义</td><td style="width:476px;">运用</td></tr><tr><td style="width:144px;">批量大小</td><td style="width:227px;">batch_size</td><td style="width:183px;">批处理中图像(和相应标签)的数量，即在一次训练迭代中同时处理的图像数量。</td><td style="width:476px;"> <p>set_dl_classifier_param(DLClassifierHandle,'batch_size‘,Batch_Size)</p> </td></tr><tr><td style="width:144px;"> <p>批量大小设备</p> </td><td style="width:227px;">batch_size_device</td><td style="width:183px;">传输到设备存储器的批处理中的图像数目。设置为小于等于批量大小。</td><td style="width:476px;"> <p>set_dl_classifier_param</p> <p>(DLClassifierHandle,'batch_size_device‘,Batch_Size)</p> </td></tr><tr><td style="width:144px;">类名</td><td style="width:227px;">classes</td><td style="width:183px;">与要识别的对象类相对应的标签组。</td><td style="width:476px;">set_dl_classifier_param(DLClassifierHandle,'classes‘,Classes)</td></tr><tr><td style="width:144px;">gpu</td><td style="width:227px;">gpu</td><td style="width:183px;">GPU标识符</td><td style="width:476px;"> <p>set_dl_classifier_param</p> <p>(DLClassifierHandle,'gpu',GPU)</p> </td></tr><tr><td style="width:144px;">图像宽度</td><td style="width:227px;">image_width</td><td style="width:183px;">过程处理图像宽度</td><td style="width:476px;"> <p>set_dl_classifier_param(DLClassifierHandle,'image_width‘,Width)</p> </td></tr><tr><td style="width:144px;">图像高度</td><td style="width:227px;">image_height</td><td style="width:183px;">过程处理图像高度</td><td style="width:476px;"> <p>set_dl_classifier_param(DLClassifierHandle,'image_height‘,Height)</p> </td></tr><tr><td style="width:144px;">图像通道数</td><td style="width:227px;">image_num_channels</td><td style="width:183px;">处理图像的通道数</td><td style="width:476px;"> <p>set_dl_classifier_param</p> <p>(DLClassifierHandle,'image_num_channels‘,Channels)</p> </td></tr><tr><td style="width:144px;">图像维度</td><td style="width:227px;">image_dimensions</td><td style="width:183px;">包含图像尺寸“image_width”、“image_height”和通道数量“image_num_channels”的元组。</td><td style="width:476px;"> <p>set_dl_classifier_param</p> <p>(DLClassifierHandle,'image_dimensions‘,Dimensions)</p> </td></tr><tr><td style="width:144px;">学习率</td><td style="width:227px;">learning_rate</td><td style="width:183px;">训练中决定梯度影响因素的初始值。默认0.001</td><td style="width:476px;">set_dl_classifier_param(DLClassifierHandle,'learning_rate',Rate)</td></tr><tr><td style="width:144px;">动量</td><td style="width:227px;">momentum</td><td style="width:183px;">损失函数的动量参数。默认0.9</td><td style="width:476px;">set_dl_classifier_param(DLClassifierHandle,'momentum‘,Momentum)</td></tr><tr><td style="width:144px;">运行环境</td><td style="width:227px;">runtime</td><td style="width:183px;">执行的设备。默认'gpu‘</td><td style="width:476px;"> <p>set_dl_classifier_param(DLClassifierHandle,'runtime','cpu')</p> <p>set_dl_classifier_param(DLClassifierHandle,'runtime','gpu')</p> </td></tr><tr><td style="width:144px;">运行环境</td><td style="width:227px;">runtime_init</td><td style="width:183px;">执行环境初始化</td><td style="width:476px;">使用'immediately'，初始化GPU。否则不初始化。set_dl_classifier_param(DLClassifierHandle,'runtime_init','immediately')</td></tr><tr><td style="width:144px;">正则化参数</td><td style="width:227px;">weight_prior</td><td style="width:183px;">用于损失函数防止过拟合，默认0</td><td style="width:476px;">非0，则使用set_dl_classifier_param(DLClassifierHandle,'weight_prior',WeightPrior)</td></tr></tbody></table><p><strong>一般的设置：</strong><br>  </p> <pre><code class="language-Go">* ** 训练 Halcon语法**
* 
* 读取训练模型
read_dl_classifier ('pretrained_dl_classifier_compact.hdl', DLClassifierHandle)
* 训练图像目录
RawDataFolder := 'food/' + ['apple_braeburn','apple_golden_delicious','apple_topaz','peach','pear']
* 获取图像内容和标签
read_dl_classifier_data_set (RawDataFolder, 'last_folder', RawImageFiles, Labels, LabelIndices, Classes)
* 预处理数据集的输出目录路径
PreprocessedFolder := 'fruit_preprocessed'
* 关闭覆盖图像.
OverwritePreprocessingFolder := false
* 移除预处理图像
RemovePreprocessingAfterExample := true

*分类图像和标签和种类
read_dl_classifier_data_set (PreprocessedFolder, 'last_folder', ImageFiles, Labels, LabelsIndices, Classes)
* 
* 将训练集、验证集和测试集以70%、15%、15%比例分类
TrainingPercent := 70
ValidationPercent := 15
split_dl_classifier_data_set (ImageFiles, Labels, TrainingPercent, ValidationPercent, TrainingImages, TrainingLabels, ValidationImages, ValidationLabels, TestImages, TestLabels)
* 
* 设置分类超参数
set_dl_classifier_param (DLClassifierHandle, 'classes', Classes)
* 设置训练块大小
BatchSize := 64
set_dl_classifier_param (DLClassifierHandle, 'batch_size', BatchSize)
* 初始化运行环境

set_dl_classifier_param (DLClassifierHandle, 'runtime_init', 'immediately')

* 设置初始学习率
InitialLearningRate := 0.001
set_dl_classifier_param (DLClassifierHandle, 'learning_rate', InitialLearningRate)
* 每30步降低90%学习率
LearningRateStepEveryNthEpoch := 30
LearningRateStepRatio := 0.1
* 迭代100次
NumEpochs := 100
* 
* 训练分类器
* 

* 每4次打印plot表
PlotEveryNthEpoch := 4
FileName := 'classifier_fruit.hdl' *训练模型文件
train_fruit_classifier (DLClassifierHandle, FileName, NumEpochs, TrainingImages, TrainingLabels, ValidationImages, ValidationLabels, LearningRateStepEveryNthEpoch, LearningRateStepRatio, PlotEveryNthEpoch, WindowHandle)</code></pre> <p><img alt="" height="600" src="https://images2.imgbox.com/3f/9f/tfG9Ntzr_o.png" width="800"><br> 图中两条不断下降的曲线分别是训练过程和验证过程中的错误率曲线，两条线的走势都向0趋近且较为平稳。验证错误率曲线呈现追随学习错误率的走势表明训练平稳运行，训练效果较好。</p> </li><li>可选择的指定数据扩充和增强</li><li>在训练中开始训练并且评估网络</li></ul> 
<p>    <strong>三、 评估最终网络（是否能较好解决实际问题，混淆矩阵）</strong><br><img alt="" height="274" src="https://images2.imgbox.com/f8/65/BAZkWbq4_o.png" width="942"></p> 
<pre><code class="language-bash">*读取训练好的文件
read_dl_classifier (FileName, DLClassifierHandle)
* 
* 计算验证集的混淆矩阵
get_predicted_classes (ValidationImages, DLClassifierHandle, PredictedClassesValidation)
*生成混淆矩阵
gen_confusion_matrix (ValidationLabels, PredictedClassesValidation, [], [], WindowHandle, ConfusionMatrix)
dev_disp_text ('Validation data', 'window', 'top', 'left', 'gray', 'box', 'false')
dev_disp_text ('Press Run (F5) to continue', 'window', 'bottom', 'right', 'black', [], [])</code></pre> 
<p><br><strong>   四、最终测试</strong></p> 
<pre><code class="language-bash">* 
* 推理
* 
* 读取训练网络文件
read_dl_classifier (FileName, DLClassifierHandle)
* 一次测试1张.
set_dl_classifier_param (DLClassifierHandle, 'batch_size', 1)
*设置网络环境
set_dl_classifier_param (DLClassifierHandle, 'runtime', 'gpu')

set_dl_classifier_param (DLClassifierHandle, 'runtime_init', 'immediately')

dev_resize_window_fit_size (0, 0, WindowWidth, WindowHeight, -1, -1)
dev_disp_inference_text (Runtime)

* Read / acquire images in a loop and classify them.
for Index := 0 to 20 by 1
    ImageFile := RawImageFiles[floor(rand(1) * |RawImageFiles|)]
    read_image (Image, ImageFile)
    dev_resize_window_fit_image (Image, 0, 0, -1, -1)
    *处理图像
    preprocess_dl_fruit_example (Image, ImagePreprocessed, DLClassifierHandle)
    *利用已经训练好的网络识别图像
    apply_dl_classifier (ImagePreprocessed, DLClassifierHandle, DLClassifierResultHandle)
    *得到检测结果
    get_dl_classifier_result (DLClassifierResultHandle, 'all', 'predicted_classes', PredictedClass)
    * 
    dev_display (Image)
    Text := 'Predicted class: ' + PredictedClass
    dev_disp_text (Text, 'window', 'top', 'left', 'white', 'box', 'false')
    dev_disp_text ('Press Run (F5) to continue', 'window', 'bottom', 'right', 'black', [], [])
    stop ()
endfor</code></pre> 
<h3 id="%E5%88%86%E7%B1%BB%E7%BD%91%E7%BB%9C%EF%BC%88Classification)%EF%BC%9A">分类网络（Classification)：</h3> 
<p><img alt="" height="97" src="https://images2.imgbox.com/2f/97/6PoDXq2Z_o.png" width="421"></p> 
<h4><strong>流程中可能使用到的算子：</strong></h4> 
<p><strong>一、准备网络和数据</strong></p> 
<ul><li>读取网络：read_dl_classifier</li><li>读取训练集：read_dl_classifier_data_set</li><li>获取超参数：get_dl_classifier_param</li><li>分离训练集（根据分类样本种类）：split_dl_classifier_data_set</li><li>设置超参数（例如'batch_size'、'learning_rate'）：set_dl_classifier_param</li></ul> 
<p><strong>二、训练网络和评估训练进度</strong></p> 
<ul><li>设置超参数：set_dl_classifier_param</li><li>训练数据块大小：train_dl_classifier_batch</li><li>可视化训练效果： 
  <ul><li>plot_dl_classifier_training_progress</li><li>select_percentage_dl_classifier_data</li><li>apply_dl_classifier_batchwise</li><li>evaluate_dl_classifier</li></ul></li></ul> 
<p><strong> 三、使用和评估最终分类器</strong></p> 
<ul><li>应用：apply_dl_classifier，获取预测结果：get_dl_classifier_result</li><li>评估网络： 
  <ul><li>混淆矩阵打分：gen_confusion_matrix</li><li>gen_interactive_confusion_matrix</li><li>获取测试图片结果:get_dl_classifier_image_results</li><li>显示检测分栏：dev_display_dl_classifier_heatmap</li></ul></li></ul> 
<p>工业检测样本（自己做的项目）：分类气泡、划伤、破损、翘脚等（从左到右）</p> 
<p><img alt="" height="224" src="https://images2.imgbox.com/78/d0/MkpDhUvs_o.jpg" width="224"><img alt="" height="224" src="https://images2.imgbox.com/78/22/cw6l3gVr_o.jpg" width="224"><img alt="" height="224" src="https://images2.imgbox.com/fd/2c/AAbkTjdS_o.jpg" width="224"><img alt="" height="224" src="https://images2.imgbox.com/f4/36/8K64dWhX_o.jpg" width="224"></p> 
<p><strong>训练过程： </strong></p> 
<p> <img alt="" height="600" src="https://images2.imgbox.com/ee/ee/GiZg6llf_o.png" width="800"></p> 
<p><strong>测试结果： </strong></p> 
<p> <img alt="" height="500" src="https://images2.imgbox.com/2a/2d/G3Ng7qx9_o.png" width="500"><img alt="" height="500" src="https://images2.imgbox.com/07/97/aaQ23POv_o.png" width="500"></p> 
<p><img alt="" height="500" src="https://images2.imgbox.com/98/91/bYCPpHoe_o.png" width="500"></p> 
<p><img alt="" height="500" src="https://images2.imgbox.com/fa/2d/5y41Qqrc_o.png" width="500"></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/067d2471badb1e654f9429a11fbf3c59/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">win10怎么更新显卡驱动_win10系统AMD显卡驱动安装失败的解决方法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/866812bab2b513c55554786e2a4726aa/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">c# spire.xls 设置文字为微软雅黑_微软自带de白板应用，超好用</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>