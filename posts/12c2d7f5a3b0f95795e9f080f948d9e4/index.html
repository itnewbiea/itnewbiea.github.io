<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>1、aigc图像相关 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="1、aigc图像相关" />
<meta property="og:description" content="aigc图像相关 一、Diffusion webui 在autodl上部署一些问题二、lora和kohyass（1）角色模型（2）风格模型（3）dreambooth（4）模型合并（5）Lora加Adetail其他 三、sd api四、ai视频模型五、换脸六、voice2face七、clash代理八、3090、cuda和tensorflow 1.x八、 Nvidia显卡驱动、CUDA、cuDNN、Anaconda及Tensorflow-GPU版本九、显卡信息命令/CPU内存/硬盘1.显卡2、CPU内存3、硬盘4、查看进程5、释放显存 十、文生视频十一、数字人十二、 flask socket十三、图像超分辨率模型（ video Super Resolution）十四、GUI十五、调试十六、ftp1、安装启动状态2、配置3、创建用户 与 目录的分配4、windows远程连接5、PASV模式6、报错 十七、TTSBert-VITS2训练 常用Linux命令1、 conda复制环境2、压缩3、ffmpeg4、conda换源5、conda相关命令6、shell启动python虚拟环境7、终端目录说明界面（terminal）8、修改huggingface 目录 Python 常用操作1.清空文件夹2.格式化字符串f() python中 r&#39;&#39;, b&#39;&#39;, u&#39;&#39;, f&#39;&#39; 的含义3、python设置临时环境变量4、vars将类转成字典5、交互窗口，jupy6、数据保存json7、任意路径导包8、Python 全局异常处理 sys.excepthook （路由和进程捕获不了）9、将Python控制台输出保存到文件的方法10、python info日志11、 traceback 异常信息 到控制台12、多队列线程13、python执行脚本当前相对目录附： python代码常用函数 python模型库1、accelerate2、os.system和subprocess（多进程模型训练1）3、多进程spawn、fork、forkserver （多进程模型训练2）4、python multiprocessing 如何在主进程中捕获子进程抛出的异常5、requests和request6、gradio UI库 一、Diffusion webui 在autodl上部署一些问题 1、虚拟环境中的pip要更新和换源
python -m pip install --upgrade pip
pip install pip -U
pip config set global.index-url https://mirrors.aliyun.com/pypi/simple/
python -m pip install --upgrade pip
pip config set global." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/12c2d7f5a3b0f95795e9f080f948d9e4/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-30T23:49:57+08:00" />
<meta property="article:modified_time" content="2023-12-30T23:49:57+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">1、aigc图像相关</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>aigc图像相关</h4> 
 <ul><li><a href="#Diffusion_webui_autodl_2" rel="nofollow">一、Diffusion webui 在autodl上部署一些问题</a></li><li><a href="#lorakohyass_120" rel="nofollow">二、lora和kohyass</a></li><li><ul><li><a href="#1_137" rel="nofollow">（1）角色模型</a></li><li><a href="#2_356" rel="nofollow">（2）风格模型</a></li><li><a href="#3dreambooth_483" rel="nofollow">（3）dreambooth</a></li><li><a href="#4_491" rel="nofollow">（4）模型合并</a></li><li><a href="#5LoraAdetail_508" rel="nofollow">（5）Lora加Adetail</a></li><li><a href="#_523" rel="nofollow">其他</a></li></ul> 
  </li><li><a href="#sd_api_658" rel="nofollow">三、sd api</a></li><li><a href="#ai_857" rel="nofollow">四、ai视频模型</a></li><li><a href="#_891" rel="nofollow">五、换脸</a></li><li><a href="#voice2face_991" rel="nofollow">六、voice2face</a></li><li><a href="#clash_1014" rel="nofollow">七、clash代理</a></li><li><a href="#3090cudatensorflow_1x_1098" rel="nofollow">八、3090、cuda和tensorflow 1.x</a></li><li><a href="#__NvidiaCUDAcuDNNAnacondaTensorflowGPU_1218" rel="nofollow">八、 Nvidia显卡驱动、CUDA、cuDNN、Anaconda及Tensorflow-GPU版本</a></li><li><a href="#CPU_1413" rel="nofollow">九、显卡信息命令/CPU内存/硬盘</a></li><li><ul><li><a href="#1_1414" rel="nofollow">1.显卡</a></li><li><a href="#2CPU_1481" rel="nofollow">2、CPU内存</a></li><li><a href="#3_1489" rel="nofollow">3、硬盘</a></li><li><a href="#4_1499" rel="nofollow">4、查看进程</a></li><li><a href="#5_1518" rel="nofollow">5、释放显存</a></li></ul> 
  </li><li><a href="#_1577" rel="nofollow">十、文生视频</a></li><li><a href="#_1603" rel="nofollow">十一、数字人</a></li><li><a href="#_flask_socket_1655" rel="nofollow">十二、 flask socket</a></li><li><a href="#_video_Super_Resolution_1791" rel="nofollow">十三、图像超分辨率模型（ video Super Resolution）</a></li><li><a href="#GUI_1829" rel="nofollow">十四、GUI</a></li><li><a href="#_1855" rel="nofollow">十五、调试</a></li><li><a href="#ftp_2008" rel="nofollow">十六、ftp</a></li><li><ul><li><a href="#1_2010" rel="nofollow">1、安装启动状态</a></li><li><a href="#2_2028" rel="nofollow">2、配置</a></li><li><a href="#3_____2315" rel="nofollow">3、创建用户 与 目录的分配</a></li><li><a href="#4windows_2389" rel="nofollow">4、windows远程连接</a></li><li><a href="#5PASV_2392" rel="nofollow">5、PASV模式</a></li><li><a href="#6_2439" rel="nofollow">6、报错</a></li></ul> 
  </li><li><a href="#TTS_2445" rel="nofollow">十七、TTS</a></li><li><ul><li><a href="#BertVITS2_2472" rel="nofollow">Bert-VITS2训练</a></li></ul> 
  </li><li><a href="#Linux_2480" rel="nofollow">常用Linux命令</a></li><li><ul><li><a href="#1_conda_2481" rel="nofollow">1、 conda复制环境</a></li><li><a href="#2_2551" rel="nofollow">2、压缩</a></li><li><a href="#3ffmpeg_2568" rel="nofollow">3、ffmpeg</a></li><li><a href="#4conda_2573" rel="nofollow">4、conda换源</a></li><li><a href="#5conda_2577" rel="nofollow">5、conda相关命令</a></li><li><a href="#6shellpython_2587" rel="nofollow">6、shell启动python虚拟环境</a></li><li><a href="#7terminal_2697" rel="nofollow">7、终端目录说明界面（terminal）</a></li><li><a href="#8huggingface__2705" rel="nofollow">8、修改huggingface 目录</a></li></ul> 
  </li><li><a href="#Python__2723" rel="nofollow">Python 常用操作</a></li><li><ul><li><a href="#1_2724" rel="nofollow">1.清空文件夹</a></li><li><a href="#2f_python_r_b_u_f__2726" rel="nofollow">2.格式化字符串f() python中 r'', b'', u'', f'' 的含义</a></li><li><a href="#3python_2730" rel="nofollow">3、python设置临时环境变量</a></li><li><a href="#4vars_2735" rel="nofollow">4、vars将类转成字典</a></li><li><a href="#5jupy_2739" rel="nofollow">5、交互窗口，jupy</a></li><li><a href="#6json_2742" rel="nofollow">6、数据保存json</a></li><li><a href="#7_2884" rel="nofollow">7、任意路径导包</a></li><li><a href="#8Python__sysexcepthook__2888" rel="nofollow">8、Python 全局异常处理 sys.excepthook （路由和进程捕获不了）</a></li><li><a href="#9Python_2895" rel="nofollow">9、将Python控制台输出保存到文件的方法</a></li><li><a href="#10python_info_3021" rel="nofollow">10、python info日志</a></li><li><a href="#11_traceback___3082" rel="nofollow">11、 traceback 异常信息 到控制台</a></li><li><a href="#12_3085" rel="nofollow">12、多队列线程</a></li><li><a href="#13python_3091" rel="nofollow">13、python执行脚本当前相对目录</a></li><li><a href="#_python_3097" rel="nofollow">附： python代码常用函数</a></li></ul> 
  </li><li><a href="#python_3109" rel="nofollow">python模型库</a></li><li><ul><li><a href="#1accelerate_3110" rel="nofollow">1、accelerate</a></li><li><a href="#2ossystemsubprocess1_3127" rel="nofollow">2、os.system和subprocess（多进程模型训练1）</a></li><li><a href="#3spawnforkforkserver_2_3233" rel="nofollow">3、多进程spawn、fork、forkserver （多进程模型训练2）</a></li><li><a href="#4python_multiprocessing__3262" rel="nofollow">4、python multiprocessing 如何在主进程中捕获子进程抛出的异常</a></li><li><a href="#5requestsrequest_3264" rel="nofollow">5、requests和request</a></li><li><a href="#6gradio_UI_3286" rel="nofollow">6、gradio UI库</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="Diffusion_webui_autodl_2"></a>一、Diffusion webui 在autodl上部署一些问题</h2> 
<p>1、虚拟环境中的pip要更新和换源<br> python -m pip install --upgrade pip</p> 
<p>pip install pip -U<br> pip config set global.index-url https://mirrors.aliyun.com/pypi/simple/</p> 
<p>python -m pip install --upgrade pip<br> pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple</p> 
<p>用设置代理export http_proxy=http:xxxxxxxxxxx，加速git和wget<br> 查看当前pip源pip config list</p> 
<p>使用pip命令从requirements.txt升级python包<br> pip install --upgrade -r requirements.txt<br> 更多查看https://www.codenong.com/24764549/</p> 
<pre><code class="prism language-python"><span class="token number">1.</span>临时换源：
<span class="token comment">#清华源</span>
pip install markdown <span class="token operator">-</span>i https<span class="token punctuation">:</span><span class="token operator">//</span>pypi<span class="token punctuation">.</span>tuna<span class="token punctuation">.</span>tsinghua<span class="token punctuation">.</span>edu<span class="token punctuation">.</span>cn<span class="token operator">/</span>simple
<span class="token comment"># 阿里源</span>
pip install markdown <span class="token operator">-</span>i https<span class="token punctuation">:</span><span class="token operator">//</span>mirrors<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>com<span class="token operator">/</span>pypi<span class="token operator">/</span>simple<span class="token operator">/</span>
<span class="token comment"># 腾讯源</span>
pip install markdown <span class="token operator">-</span>i http<span class="token punctuation">:</span><span class="token operator">//</span>mirrors<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>tencent<span class="token punctuation">.</span>com<span class="token operator">/</span>pypi<span class="token operator">/</span>simple
<span class="token comment"># 豆瓣源</span>
pip install markdown <span class="token operator">-</span>i http<span class="token punctuation">:</span><span class="token operator">//</span>pypi<span class="token punctuation">.</span>douban<span class="token punctuation">.</span>com<span class="token operator">/</span>simple<span class="token operator">/</span>

<span class="token number">2.</span>永久换源：
<span class="token comment"># 清华源</span>
pip config <span class="token builtin">set</span> <span class="token keyword">global</span><span class="token punctuation">.</span>index<span class="token operator">-</span>url https<span class="token punctuation">:</span><span class="token operator">//</span>pypi<span class="token punctuation">.</span>tuna<span class="token punctuation">.</span>tsinghua<span class="token punctuation">.</span>edu<span class="token punctuation">.</span>cn<span class="token operator">/</span>simple
<span class="token comment"># 阿里源</span>
pip config <span class="token builtin">set</span> <span class="token keyword">global</span><span class="token punctuation">.</span>index<span class="token operator">-</span>url https<span class="token punctuation">:</span><span class="token operator">//</span>mirrors<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>com<span class="token operator">/</span>pypi<span class="token operator">/</span>simple<span class="token operator">/</span>
<span class="token comment"># 腾讯源</span>
pip config <span class="token builtin">set</span> <span class="token keyword">global</span><span class="token punctuation">.</span>index<span class="token operator">-</span>url http<span class="token punctuation">:</span><span class="token operator">//</span>mirrors<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>tencent<span class="token punctuation">.</span>com<span class="token operator">/</span>pypi<span class="token operator">/</span>simple
<span class="token comment"># 豆瓣源</span>
pip config <span class="token builtin">set</span> <span class="token keyword">global</span><span class="token punctuation">.</span>index<span class="token operator">-</span>url http<span class="token punctuation">:</span><span class="token operator">//</span>pypi<span class="token punctuation">.</span>douban<span class="token punctuation">.</span>com<span class="token operator">/</span>simple<span class="token operator">/</span>
<span class="token comment"># 换回默认源</span>
pip config unset <span class="token keyword">global</span><span class="token punctuation">.</span>index<span class="token operator">-</span>url

<span class="token number">3</span>、常用源
阿里云 http<span class="token punctuation">:</span><span class="token operator">//</span>mirrors<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>com<span class="token operator">/</span>pypi<span class="token operator">/</span>simple<span class="token operator">/</span>
中国科技大学 https<span class="token punctuation">:</span><span class="token operator">//</span>pypi<span class="token punctuation">.</span>mirrors<span class="token punctuation">.</span>ustc<span class="token punctuation">.</span>edu<span class="token punctuation">.</span>cn<span class="token operator">/</span>simple<span class="token operator">/</span>
豆瓣<span class="token punctuation">(</span>douban<span class="token punctuation">)</span> http<span class="token punctuation">:</span><span class="token operator">//</span>pypi<span class="token punctuation">.</span>douban<span class="token punctuation">.</span>com<span class="token operator">/</span>simple<span class="token operator">/</span>
清华大学 https<span class="token punctuation">:</span><span class="token operator">//</span>pypi<span class="token punctuation">.</span>tuna<span class="token punctuation">.</span>tsinghua<span class="token punctuation">.</span>edu<span class="token punctuation">.</span>cn<span class="token operator">/</span>simple<span class="token operator">/</span>
中国科学技术大学 http<span class="token punctuation">:</span><span class="token operator">//</span>pypi<span class="token punctuation">.</span>mirrors<span class="token punctuation">.</span>ustc<span class="token punctuation">.</span>edu<span class="token punctuation">.</span>cn<span class="token operator">/</span>simple<span class="token operator">/</span>

</code></pre> 
<p>Ubuntu apt更新可用软件包列表<br> $ sudo apt update<br> 更新已安装的包<br> $ sudo apt upgrade<br> 通常安装完ubuntu之后， 可以先使用upgrade 更新一下当前系统中可以升级的的软件包<br> $ sudo apt update<br> $ sudo apt upgrade</p> 
<p>1.安装软件<br> $ sudo apt install 软件名<br> 2.卸载软件<br> $ sudo apt remove 软件名</p> 
<p>2、pytorch内存不足,安装pytorch被killed,根本原因就是虚拟机分配的内存不足以安装torch,1.9/1.9 GB 29.9 MB/s eta 0:00:01Killed。<br> du命令用来查看目录或文件所占用磁盘空间的大小。常用选项组合为：du -sh<br> conda删除虚拟环境conda env remove --name your_env_name<br> 切换有卡模式<br> 修改conda虚拟环境存贮位置<br> conda info<br> vim .condarc</p> 
<pre><code class="prism language-Python">envs_dirs:
  - /root/autodl-tmp/conda/envs
  - /usr/local/anaconda3/envs
  - /home/zth/.conda/envs
pkgs_dirs:
  - /root/autodl-tmp/conda/pkgs
  - /usr/local/anaconda3/pkgs
  - /home/zth/.conda/pkgs

</code></pre> 
<p>3、conda shell问题，<br> 重新进入虚拟环境： source activate<br> 退出虚拟环境：source deactivate或conda deactivate(直接 source activate 环境名)<br> 修改路径：conda info vim .condarc<br> 删除虚拟环境：conda env remove --name your_env_name<br> 复制虚拟环境：conda create -n newname --clone oldname<br> conda activate和source activate 的命令区别</p> 
<p>4、git submodule update失败<br> rm -r sd_scripts/ 删除失败的文件夹</p> 
<p>5、lanch.py --share等参数<br> python launch.py --share --xformers --enable-insecure-extension-access --port 6006</p> 
<p>6、下载慢，更换加速网址<br> 7、复制cp -r /root/stable-diffusion-webui/. /root/autodl-tmp/stable-diffusion-webui<br> 假设复制源目录 为 dir1 ,目标目录为dir2。怎样才能将dir1下所有文件复制到dir2下了<br> 如果dir2目录不存在，则可以直接使用<br> cp -r dir1 dir2<br> 即可。<br> 如果dir2目录已存在，则需要使用<br> cp -r dir1/. dir2</p> 
<p>8、–xformers参数报错（安装xformers导致包冲突）<br> /root/miniconda3/lib/python3.10/site-packages/torchvision/io/image.py:13: UserWarning: Failed to load image Python extension: libtorch_cuda_cu.so: cannot open shared object file: No such file or directory</p> 
<p>9、Something went wrong Expecting value: line 1 column 1 (char 0)<br> 运行<br> !python launch.py --share --autolaunch --deepdanbooru --xformers --no-gradio-queue --port 6006</p> 
<h2><a id="lorakohyass_120"></a>二、lora和kohyass</h2> 
<p>报错：<br> 1、ValueError: persistent_workers option needs num_workers &gt; 0<br> Enable buckets 没开，适应不同尺寸图片<br> 2、Caption Extension（开启才能读取标签，不然和没打标签一样）<br> .txt</p> 
<p>查看日志：tensorboard --logdir ./tensorboard --port 8080<br> 主要在数据集和基底模型一致</p> 
<p>1、LORA模型可以分类两类，角色模型和风格模型。</p> 
<p>参考：https://zhuanlan.zhihu.com/p/629303934<br> https://www.bilibili.com/read/cv22022392<br> https://zhuanlan.zhihu.com/p/612107375</p> 
<h3><a id="1_137"></a>（1）角色模型</h3> 
<p>人物背景要干净，选取头像部分，SDsam截取人物，用sd裁剪图片大小。<br> 注意：数据准备的质量决定了你最终模型的效果，如果你喂给模型的图是低质量的图，那么模型给你生成的图也是低质量的图，所以尽量保证图片清晰，分辨率较高，无遮挡。如果是角色训练集控制在20-50张图左右，太多会导致过拟合，如果是角色尽可能收集到头像，正视图，侧视图，背面等多角度的无背景素材。先我各种搜集训练对象的图片，去掉糊的，并且一概抠图改为白色背景，<br> 一定要挑光线好的，无遮挡的图，一定要抠图，无关东西一定要去掉，不然影响真的很大<br> 可以用一张图来分别做大头照，半身照，全身照来凑数，但出来的图也会很大程度上感觉似曾相识。</p> 
<p>一.图片要求<br> 至少15张图片，每张图片的训练步数不少于100<br> 照片人像要求多角度，特别是脸部特写（尽量高分辨率），多角度，多表情，不同灯光效果，不同姿势等<br> 图片构图尽量简单，避免复杂的其他因素干扰<br> 可以单张脸部特写+单张服装按比例组成的一组照片（这里比例是3:1）<br> 减少重复或高度相似的图片，避免造成过拟合</p> 
<p>（1）素材：<br> 对要用于训练的图片素材：例如在角色训练素材中，需要清晰的、多角度的、正脸的、侧脸的、最好是背景干净的、各种表情的、摆头的。就是需要各种角度（不要有俯视的，尽量都是平视图避免比例失调）、景别、姿势、光照。脸部不要有被遮挡的图片。这样增加训练集的多样性，提高模型的泛化性。<br> 如果是角色训练集控制在20-50张图左右，太多会导致过拟合，如果是训练其他风格，有说法是图片越多效果就越好，相应的训练时长也会增加，建议在50~80张。<br> 影响训练出的LoRa模型的好坏，训练集是最最最重要的~！</p> 
<p>如果是角色训练，也建议将需要训练的人物及相关的特征装饰都抠出来，背景尽量简单或直接是纯色背景，建议白底或黑底，但不要是透明底。<br> <em>素材可以少，但是质量一定要高。<br> <em>角色背景最好是白底网站上面可以选择换背景颜色<br> 搜集好训练用的图像后，需要进行大小的规范处理，需要是64的倍数。一般都处理为512</em>512，也可以是768</em>768，不建议超过1024，尺寸越大则越吃显存。<br> 推荐网站可以进行批量的图像尺寸处理：https://www.birme.net/</p> 
<p>（2）裁剪：把所有图片批量进行统一分辨率裁切，分辨率需要是64的倍数，至于说分辨率，其实512就可以了，可以调大一些，如果你显存够大，我用3090发现基本上拉到1024分辨率后就没有收益了，而低于512明显效果不好。理论上图片分辨率高一些好，此外图片质量解析力也应该高。并不一定必须要512*512，但是上下长宽像素必须要是64的倍数。</p> 
<p>(3)打标签<br> BLIP处理的提示词是如果想要保留的特征，就添加这个特征标签。<s>例如需要强调人物特征，会导致训练出的模型并不很像，所以需要加上突出人物特征的标签：</s><br> 常用特征标签：<br> Face<br> Nose<br> Lips<br> Hairstyle<br> Eyes<br> Ears<br> Forehead<br> breast</p> 
<p>face,nose,lips,hairstyle,eyes,ears,forehead,people</p> 
<p>（4）训练次数<br> (训练步数 × 素材总数 × 训练循环数Epoch) / 并行数量Bath size ≤ 训练总步数<br> LoRA训练总步数在1500至6000步，checkpoint训练总步数：至少30000步<br> 训练完成后，模型文件会保存到设置的输出目录。比如 epoch 训练循环数设置了 5，就会得到 5 个训练好的 LoRA 模型。</p> 
<p>LoRa的训练需要至少1500步，而每张图片至少需要训练100步。<br> 如果我们有15张或者15张以上张图片，文件夹就需要写上100_Hunzi。<br> 如果训练的图片不够15张，比如10张，就需要改为150_Hunzi，以此类推。<br> 这部分很重要，一定要算清楚。<br> 当然，这也正是LoRa强大的地方，用这么少的图片即可完成训练。<br> 训练时长，总的来说，不宜也不需训练过长时间。尽可能把训练时长控制在半小时到一小时内，时间过长容易导致过拟合，通过调整等参数控制训练时长。即便是batch size值为1，也是如此，这就意味着你的训练总步数其实是不需要过多。（当然，时长也跟显卡的功力也有一定关系，但时长不至于偏差得几倍去。）</p> 
<p>（4）参数设置：<br> 参考：<br> https://zhuanlan.zhihu.com/p/643550056<br> https://zhuanlan.zhihu.com/p/618758020<br> https://zhuanlan.zhihu.com/p/619348969</p> 
<p>https://www.bilibili.com/video/BV1UF411Q7cP/?spm_id_from=333.337.search-card.all.click&amp;vd_source=38e7fc10713eca999c22c7ff25f6e6d2<br> https://www.bilibili.com/video/BV1Ba4y1M7LD/?spm_id_from=333.337.search-card.all.click&amp;vd_source=38e7fc10713eca999c22c7ff25f6e6d2<br> https://www.bilibili.com/video/BV1GV4y1z7Fn/?spm_id_from=333.337.search-card.all.click&amp;vd_source=38e7fc10713eca999c22c7ff25f6e6d2<br> https://www.bilibili.com/video/BV1GP411U7fK/?spm_id_from=333.788.recommend_more_video.13&amp;vd_source=38e7fc10713eca999c22c7ff25f6e6d2</p> 
<p>clip_skip：用于控制clip_skip参数，这是一个训练层数的定义。一般情况下，真实模型的clip_skip都使用1，而动漫都使用2，当你选择是的时候这个值被更改为1。而否则改为2。（Clip用1似乎效果不佳，真是玄学，还是用回2吧，不管是真人还是二次元。）</p> 
<p>batch_size：较大的batch_size可以加快训练速度，但可能导致内存或显存不足的问题；较小的batch_size可以增加模型的泛化能力，但可能增加训练过程中的抖动和噪声。已经给出了一个参考参数，12g显存，在512分辨率下，可以最多处理6张图像。</p> 
<p>epoch：epoch的数量越多，模型的训练效果越好，但过多的epoch可能会导致模型过拟合训练数据，泛化能力下降。</p> 
<p>DIM：DIM是特征的数量，也就是输入数据的维度。在机器学习中，每个样本由多个特征组成，而这些特征就对应了输入数据的维度。这个值严重影响lora的质量，太低模型不像，太高容易过拟合。经过多方调试，128被认为是一个最为推荐的数值。它也直接影响输出的模型大小。 dim值和alpha值设定，训练人物一般都设32，64也是可以；训练风格可以用到128。network_dim表示我们训练出来的Lora模型大小，一般不要大于128，因为没收益，小一些的dim可以抗过拟合。</p> 
<p>resolution：请设置分辨率，大多数模型的分辨率都是正方形，因此只用提供一个数据。注意，你提供的数据需要为64的倍数设置图片分辨率为 512，640(和你训练的图片分辨率一致)。根据训练集的图片文件的像素来设定即可。resolution没动，因为我的训练图片就是512x512，所以没动。你如果自己的图片分辨率统一都比较大，比如都是1024x1024，你就改一下变成1024,1024。</p> 
<p>shuffle_captions ：打乱文本数据的操作是对于每个caption随机选择一个其他的caption，然后将它们交换位置，这样就完成了一次打乱操作。打乱操作可以多次进行，从而更大程度地增加数据的随机性”常常用于SD模型。在训练真人模型的时候与二次元模型不同，它的构成是caption + tag的形式。</p> 
<p>（5）具体设置：<br> clip_skip：人物选1,（Clip用1似乎效果不佳，真是玄学，还是用回2吧，不管是真人还是二次元。）<br> network_dimension：128（1024X1024）<br> 该参数不是越高越好。维度提升时有助于学会更多细节，但模型收敛速度变慢，需要的训练时间更长，也更容易过拟合。高分辨率训练集通常需要更高的维度。<br> 训练人物通常设置network_dimension = 32，也可设置16或64，画风可以考虑128。通常训练人物不超过2000 steps 即可完成训练。</p> 
<p>alpha ：alpha 被推荐设置为 network_dimension 的一半，一些封装的训练脚本也默认这么设置。当alpha设置为一半dim时，scale为0.5，可以放缩网络的权重。削弱上面网络维度的值。Alpha的值为0时相当于Alpha为128，即没有任何削弱。Alpha为1时，相当于削弱到128分之1。</p> 
<p>scheduler：cosine_with_restarts<br> noise_offset：有助于生成特别暗或特别亮的图像，通常设置为 0.1<br> max_data_loader_n_workers：指定数据加载的进程数。默认是"<code>8</code>或者<code>CPU并发执行线程数 - 1</code>，取小者"，</p> 
<p>enable_bucket：如果你的训练集有不同分辨率图像则开启，会略微多消耗显存。</p> 
<p>max_train_epoches ：最大循环训练的次数，通常在5-10，一般设置为6，防止过拟合，如果使用了镜像翻转，导致相同的图片实际训练了两次，可以改为三次</p> 
<p>Sample every n epochs： 每 N 轮采样一次，一般设置为 1<br> Sample prompt： 采样提示词，设置之后，LoRA 训练的同时会每隔设定的步数或轮次，生成一副图片，以此来直观观察 LoRA 训练的进展</p> 
<p>prior_loss_weight<br> 使用正则化时使用，该权重控制先验知识强度，默认为1。使用100张以上训练集有人推荐是5%-10%，不要设置更低了，那等于没有正则化，使用正则化权重1时模型收敛会非常困难。我在设置为1时多次炸炉，推荐训练画风时使用正则化。</p> 
<p><s>Min SNR gamma：优化损失函数增强训练过程的稳定性，建议值为5，</s><br> min_snr_gamma=0 # minimum signal-to-noise ratio (SNR) value for gamma-ray | 伽马射线事件的最小信噪比（SNR）值 默认为 0</p> 
<p>学习率（Learning rate）0.0001<br> Text Encoder学习率 5e–5</p> 
<p>Unet学习率 0.0001</p> 
<p>Network : 128和128</p> 
<p>模型像素：512x512以上尽量大<br> （3）epoch先用10，看一下loss，说是人物loss到0.08左右，二次元0.05左右就可以。从上面有个图也能看出，loss不是越低越好。</p> 
<p>（4）unet学习率1e-4。如果loss下不去，就提高学习率；如果loss太低或者没有得到一个特别像的模型，可能是设置高了，再降低些试试。</p> 
<p>（5）dim，直接上128就完事。还有个alpha参数，建议是128的一半，不要超过dim。</p> 
<p>（6）loss通常0.08左右是最优的，不过也比较玄学，还是用xyz图表测一下。</p> 
<p>学习率与优化器<br> 推荐优化器 lion<br> 搭配的学习率：<br> lr=“7e-5”<br> unet_lr=“7e-5”<br> text_encoder_lr=“8e-6”<br> 一般来说按这个设置就没啥问题，当然UP青龙圣者也提到过一个先用DA优化器跑一个最佳学习率再取三分之一是Lion的学习率的说法，但是我觉得这个太费事儿了，一般取这个数效果就挺好……<br> lora的dim与alpha</p> 
<p>Lora分层</p> 
<p>（6）注意：<br> 不像：学习率、repect</p> 
<p>Text 、Unet学习率设定后，learning rate不生效<br> Text Encoder学习率 ：为unet十分之一，多一位小数，或1/2<br> Unet学习率：<br> loss：0.08左右<br> 一般Loss值为0.08~0.1则模型训练的比较好，Loss值为0.08则最佳。</p> 
<p>dim<br> 学习率：用adapt寻找</p> 
<p>优化器：</p> 
<p>1）打标签：（没有的删掉）、不变的不打标签，变部分打标签、错误重复缺失、添加正则里面额外tag比如汉服，这里删除提示词，比如想要什么特征就删掉什么提示词，比如要保留船的特征，那就删掉船的提示词，删掉就是让AI去学习记住这个特征，背景的提示词一定不要删。<br> 于自定义tag和人脸<br> 其实机器是可以识别人脸的，不需要添加 eyes, nose, mouth 。 最多机器会给你有关发型或发色的tag，你是否要删除这些tag，取决于你对人物的需求。如果你需要人物不改变发型或发色，就要去掉这些标注，让机器把这个发型或发色当作人脸的一部分。如果认为以后需要更换发型等，就不要删除tag，甚至如果机器没有给你标注，你还应该自己标注出来。自定义tag我认为是一种补救措施，如果因为什么原因无法调用lora中的元素了，才需要使用自定义tag。</p> 
<p>关于自定义tag与1girl。这个问题我在前面帖子里面说过了。你输入1girl，机器优先找lora里面的1girl，如果有，就按照lora里描述的1girl来绘制1girl，如果没有，就到底模(Chillout之类的)里面找1girl来绘制。如果你要做一个人物的lora，第一个tag是1girl，就意味着你使用它生图时候输入1girl就可以了。如果你去掉了1girl，用了一个人物名称代替(比如mywaife)，那么你生图的时候第一个prompt就要输入 mywaife。https://g.nga.cn/read.php?&amp;tid=35850123</p> 
<p>2）token：触发词<br> Keep n tokens（保持N个tokens），这个参数是用来设置触发词数量的。在前面提示词打标的时候，你为你的LoRA模型设置了几个触发词，这里就填写几，常见的有1~3。</p> 
<p>3）学习率<br> <strong>use 8bit adapt和DAdaptation 不能同时开启</strong><br> 自动调整学习率,<strong>不要勾选8bit adam</strong>，其他照常，Learning rate直接填写1，epoch可以高一些比如说8或者10。Optimizer选择Adafactor（据GUI作者说这个效果最好，我测试下来text略微过拟合）。直接点击训练。如果使用dadaptation，那就让lr=unetlr=1，textlr=0.5（测试下来会有拟合不太够的情况，可能需要调整epoch）.<br> DAdaptation 时，应当将学习率设置在1附近，text_encoder_lr 可以设置成1，或者小一点，0.5之类。使用DAdaptation 时，推荐将学习率调整策略调整为 constant 。<br> D-Adaptation 优化器自动调整学习率。 学习率选项指定的值不是学习率本身，而是D-Adaptation决定的学习率的应用率，所以通常指定1.0。 如果您希望 Text Encoder 的学习率是 U-Net 的一半，请指定 <code>--text_encoder_lr=0.5 --unet_lr=1.0</code>。<br> Text Encoder learning rate（文本编码器学习率），一般为Unet learning rate的十分之一或者一半，比如设置为5e-5（1e-4的一半则为5e-5，十分之一则为1e-5）。<br> 使用DAdaptation时，需要把unet学习率设成1，text的学习率设成0.5，让它自动去跑，过一会就能获得一个最优学习率。接下来用AdamW8bit跑，或者Lion学习率调整为最优的1/3跑。</p> 
<p>lr_warmup_steps: 热身步数，仅在学习率调度策略为“constant_with_warmup”时需要设置，用来控制模型在训练前逐渐增加学习率的步数。一般不动<br> lr_restart_cycles: 余弦退火重启次数，仅在学习率调度策略为"cosine_with_restarts"时需要设置，用来控制余弦退火的重启次数。一般不动</p> 
<p>学习率<br> 预热比例（warm up ratio）吗？<br> 这是为了在训练开始时避免模型权重更新过于剧烈而采用的策略。学习率预热比例越高，就会有更多的迭代次数用于学习率的逐渐增加，以帮助模型更好地收敛。通常，学习率预热比例设置为训练迭代总数的一小部分，比如1/10或1/20。如果你的总步数为1000，在接下来的设置里请改为50-100。 作者：冬归初雪 https://www.bilibili.com/read/cv22022392 出处：bilibili</p> 
<p>lr_warmup_steps=0 # warmup steps | 学习率预热步数，lr_scheduler 为 constant 或 adafactor 时该值需要设为0。<br> lr_restart_cycles=1 # cosine_with_restarts restart cycles | 余弦退火重启次数，仅在 lr_scheduler 为 cosine_with_restarts 时起效。</p> 
<p>lr_warmup_steps：升温步数，仅在学习率调度策略为“constant_with_warmup”时设置，用来控制模型在训练前逐渐增加学习率的步数，一般不动。<br> lr_restart_cycles：退火重启次数，仅在学习率调度策略为“cosine_with_restarts”时设置，用来控制余弦退火的重启次数，一般不动。</p> 
<p>② 采样参数设置<br> Sample every n epochs：每 N 轮采样一次，一般设置为 1。<br> Sample every n steps：比如设置为 100，则代表每训练 100 步采样一次。<br> Sample prompt：采样提示词，设置之后，LoRA 训练的同时会每隔设定的步数或轮次，生成一副图片，以此来直观观察 LoRA 训练的进展。</p> 
<p>4）dim<br> Network Rank（Dimension）维度，代表模型的大小。数值越大模型越精细，常用4~128，如果设置为128，则最终LoRA模型大小为144M。一般现在主流的LoRA模型都是144M，所以根据模型大小便可知道Dimension设置的数值。设置的小，则生成的模型小。<br> Network Alpha，一般设置为比Network Rank（Dimension）小或者相同，常用的便是Network Rank设置为128，Network Alpha设置为64。<br> Dim影响学习的深度，也直接决定了文件的大小。dim越大，则学习的深度越深，高的dim更适合学习画风。<br> Alpha：根据大佬经验，推荐取dim的一半。更低的alpha总体上表现为一种对学习的抑制，比如alpha取1的话一般来说需要更高的学习率。<br> alpha的大小可以根据数据集和模型的复杂度来确定，通常情况下，alpha越大，模型的正则化程度就越高，复杂度越小，泛化能力越强。反之，alpha越小，模型的正则化程度就越低，复杂度越高，泛化能力越弱。”经过实验调试，这个值为0.25-0.5 dim最佳。</p> 
<p>5）loss：0.08左右<br> 一般Loss值为0.08~0.1则模型训练的比较好，Loss值为0.08则最佳。</p> 
<p>写错的地方：<br> 1、 DAdaptation 时，应当将学习率设置在1附近，text_encoder_lr 可以设置成1，或者小一点，0.5之类。使用DAdaptation 时，推荐将学习率调整策略调整为 constant 。（constant 设错）<br> 2、cosine_with_restarts设置成constant_with_warmup<br> <img src="https://images2.imgbox.com/25/3b/Tg41MeE1_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/de/fd/pFDK24lb_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/96/07/Ax6UzKlh_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/38/1c/mleubDdK_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/ff/8c/FhTULYzr_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/df/28/xr6JVLPJ_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/09/98/35WfqqQb_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/55/78/F1KhRA3P_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/47/af/6btJhe6v_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/4f/80/kUxKePvZ_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/33/73/O1yHtcWT_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/3f/bc/ANzKKHwi_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/c4/2f/fZ5YcgGe_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/9a/39/36aM1VLU_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/73/ee/hQ15o44M_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/52/ef/GK8KfTG3_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/da/ea/0LkYvUFK_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="2_356"></a>（2）风格模型</h3> 
<p>参考：<br> https://zhuanlan.zhihu.com/p/643550056<br> https://www.bilibili.com/video/BV1Lc411H7kz/?spm_id_from=333.788&amp;vd_source=38e7fc10713eca999c22c7ff25f6e6d2</p> 
<p>https://www.bilibili.com/video/BV1jh4y1Z77c/?spm_id_from=333.788.recommend_more_video.0&amp;vd_source=38e7fc10713eca999c22c7ff25f6e6d2</p> 
<p>1.打标<br> 打标优化<br> 预处理生成 tags 打标文件后，就需要对文件中的标签再进行优化，一般有两种优化方法：<br> 方法一：保留全部标签<br> 就是对这些标签不做删标处理, 直接用于训练。一般在训练画风，或想省事快速训练人物模型时使用。<br> 优点：不用处理 tags 省时省力，过拟合的出现情况低。<br> 缺点：风格变化大，需要输入大量 tag 来调用、训练时需要把 epoch 训练轮次调高，导致训练时间变长。</p> 
<p>方法二：删除部分特征标签<br> 比如训练某个特定角色，要保留蓝眼睛作为其自带特征，那么就要将 blue eyes 标签删除，以防止将基础模型中的 blue eyes 引导到训练的 LoRA 上。简单来说删除标签即将特征与 LoRA 做绑定，保留的话画面可调范围就大。<br> 一般需要删掉的标签：如人物特征 long hair，blue eyes 这类。<br> 不需要删掉的标签：如人物动作 stand，run 这类，人物表情 smile，open mouth 这类，背景 simple background，white background 这类，画幅位置等 full body，upper body，close up 这类。<br> 优点：调用方便，更精准还原特征。<br> 缺点：容易导致过拟合，泛化性降低。</p> 
<p>画风：训练集打标签，正则集不要打标签（数量多，重复次数少，不用打标，不用预处理）<br> <img src="https://images2.imgbox.com/d8/51/Bhag8dhu_o.png" alt="在这里插入图片描述"></p> 
<p>训练难易度<br> 不同风格的模型训练难易度不相同，原则就是画面越复杂训练越难，排序就是场景&gt;真人lora&gt;动漫二次元<br> 参考：https://zhuanlan.zhihu.com/p/643550056<br> <img src="https://images2.imgbox.com/a5/de/snti9iSv_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/81/6c/a3Lan62c_o.png" alt="在这里插入图片描述"></p> 
<p>3.lora分层<br> 分层训练和分层生成<br> https://www.bilibili.com/video/BV1jh4y1Z77c/?spm_id_from=333.788.recommend_more_video.0&amp;vd_source=38e7fc10713eca999c22c7ff25f6e6d2</p> 
<p>https://www.bilibili.com/video/BV1Cg4y1V7uA/?spm_id_from=333.788.recommend_more_video.0&amp;vd_source=38e7fc10713eca999c22c7ff25f6e6d2</p> 
<p>https://www.bilibili.com/video/BV1gV4y1r7e7/?spm_id_from=333.337.search-card.all.click&amp;vd_source=38e7fc10713eca999c22c7ff25f6e6d2</p> 
<p>https://www.bilibili.com/video/BV1Cg4y1V7uA/?spm_id_from=333.788&amp;vd_source=38e7fc10713eca999c22c7ff25f6e6d2<br> <img src="https://images2.imgbox.com/05/dc/QmmHCOc9_o.png" alt="在这里插入图片描述"><br> （1）人物和画风</p> 
<p>人物预设<br> MIDD:1,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0,0(插件自带)</p> 
<pre><code> 1,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0

 1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1
</code></pre> 
<p>只影响脸部<br> （强）1,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0</p> 
<p>（弱）1,0,0,0,0,0,0,0,1,1,1,0.2,0,0,0,0,0</p> 
<p>画风预设（慎用，可能造成画风偏移）<br> 1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,0,0</p> 
<p>1,0,0,0,0,0,0,0,0,0,0,0.8,1,1,1,1,1</p> 
<p>1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1</p> 
<p>1,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1</p> 
<p>（2）、服装加角色<br> 1.去除法（人物像服装不像）服装模型去除脸部，人物模型去除服装层<br> lora:serafuku:0.8:1,1,1,1,1,1,0,1,0,0,0,1,1,1,1,1,1, best quality, 1girl, long hair, blonde hair, blue eyes, (pink japanese school shirt), sailor collar, neckerchief, short sleeves, white skirt, ((upper body)), standing, outdoors, cityscape, streets, buildings, lora:xhcutdef512PH-000011:0.9:1,1,1,1,1,1,0,1,1,1,0,1,1,1,1,1,1</p> 
<p>2、去除法：</p> 
<p>1,0,0,0,1,1,0,1,1,1,0,1,1,1,1,1,1 去服装</p> 
<p>1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1 去脸</p> 
<p>3、保留法<br> 1,1,1,1,1,0,0.2,0,0.8,1,1,0.2,0,0,0,0,0 保留服装1</p> 
<p>1,1,1,1,0,0,1,0,0,0,1,0,0,0,0,0,0 保留服装2</p> 
<p>1,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0 保留脸</p> 
<p>参考：</p> 
<pre><code class="prism language-python"><span class="token number">2</span>、以下是一些我觉得还不错的预设及介绍：
https<span class="token punctuation">:</span><span class="token operator">//</span>www<span class="token punctuation">.</span>bilibili<span class="token punctuation">.</span>com<span class="token operator">/</span>video<span class="token operator">/</span>BV1Wv4y157NH<span class="token operator">/</span>?vd_source<span class="token operator">=</span>1bb2a1943a27115e193397576c3ef83e
影响除脸之外的部分（保持不变脸情况下改变其他部分）
（强）<span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span>
（弱）<span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0.2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0.2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0.8</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span>

影响脸部（脸型、发型、眼型、瞳色等）
（强）<span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span>
（弱）<span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0.8</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0.2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span>

服装（搭配tag使用）
<span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0.2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0.8</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0.2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span>


动作（搭配tag使用）
<span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0.2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span>

上色风格（搭配tag使用）
<span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0.8</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span>

角色（去风格化）
<span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span>

背景（去风格化）
<span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0.2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0.2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0.8</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span>

减弱过拟合（等同于OUTALL）
<span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span>
</code></pre> 
<p>4、服装<br> https://www.bilibili.com/video/BV1TV4y1o7rb/?spm_id_from=333.337.search-card.all.click&amp;vd_source=38e7fc10713eca999c22c7ff25f6e6d2</p> 
<p>打标时阈值设置</p> 
<p><img src="https://images2.imgbox.com/31/23/uAQEora1_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3dreambooth_483"></a>（3）dreambooth</h3> 
<p>首先，先尝试上述步骤去避免他，如果生成的图片依旧充满噪声。使用 DDIM 调度器或者运行更多推理步骤 (对于我们的实验大概 100 左右就很好了)。这里给出人物训练和物体训练两个不同的测试结果：在我们的实验中，学习率在 2e-6 同时 400 步对于物体已经很好了，但是脸部需要学习率在 1e-6 (或者 2e-6) 同时 1200 步才行。 在训练中使用 Class images 是为了 防止物体的特征 “渗透” 到同一 Class 的其他物体中。如果没有 Class images 作为参考点，AI 会将你的脸与 Class 中出现的其他脸合并。你的脸会渗透进模型生成的其他脸中。<br> https://zhuanlan.zhihu.com/p/611812910</p> 
<p>Set Ratio of Text Encoder Training ：面部最佳为0.7。风格最佳为0.2；如果显存不足则设置为0，一般训练 Unet 的效果会更好</p> 
<p>准备的图片越多越好，如果训练人像，尽量那个每张图片都不同背景，不同的角度，不同距离，让模型学习到只针对于人像的内容，而不是背景的内容。</p> 
<h3><a id="4_491"></a>（4）模型合并</h3> 
<p>Stablediffusion这个开源的t2i模型时，不可避免地会碰到两种模型权重的存储格式，即diffusers格式和ckpt格式。<br> 而diffusers格式其实包含：feature_extractor, scheduler, text_encoder, tokenizer, unet, vae这些文件夹以及model_index.json这个文件。大的二进制文件主要位于text_encoder，unet和vae文件夹下。</p> 
<p>safetensors是ckpt转换得到的，防止别有用心之人在ckpt文件中加入恶意代码。safetensor和ckpt文件都能直接用于AUTOMATIC111这个为T2I模型开发的WebUI上，而diffusers不行。而diffusers提供的一些代码example又非常有借鉴意义，但一旦使用，其存储类型是一系列目录，这就催生了两种各格式相互转化的需求。</p> 
<p><img src="https://images2.imgbox.com/d0/2e/CvRPmxJ5_o.png" alt="在这里插入图片描述"></p> 
<p>合并LoRA权重，生成全量模型权重<br> [New] 请优先使用新版合并脚本，所需内存显著降低，只需将以下命令中的脚本替换为scripts/merge_llama_with_chinese_lora_low_mem.py，参数相同。<br> 这一步骤会对原版LLaMA模型（HF格式）扩充中文词表，合并LoRA权重并生成全量模型权重。 <strong>此处可以选择输出PyTorch版本权重（.pth文件）或者输出HuggingFace版本权重（.bin文件）。</strong> 请优先转为pth文件，比对合并后模型的SHA256无误后按需再转成HF格式。<br> .pth文件可用于：使用llama.cpp工具进行量化和部署<br> .bin文件可用于：使用Transformers进行推理、使用text-generation-webui搭建界面</p> 
<h3><a id="5LoraAdetail_508"></a>（5）Lora加Adetail</h3> 
<p>一、风格 <br> 1、没用标签 <br> 触发词能出发所有数据特征，控制性不稳定，可用于多变风格 结合性不高 <br> 2、用标签 <br> 触发词只会出发reg正则集效果 要达到训练集效果，需要写具体标签和描述promt 稳定，结合性高</p> 
<p>二、人物 <br> 1、没用标签 <br> 测试一次，感觉相似度比较高，只加触发词 泛化性有限制 <br> 2、用标签 <br> 抗拟合性比较强，只用出发词，相似度下降一点 泛化性好</p> 
<p>三、提高人物相似度<br> adetail不用裁脸，提高dim训练维度，直接训练或扣除背景减少信息量损失。</p> 
<h3><a id="_523"></a>其他</h3> 
<p>2、文件权限，sh文件没权限<br> 查看linux文件的权限：ls -l 文件名称<br> chmod +x 和chmod a+x 是一样的，一般没有明确要求，可以就用chmod +x</p> 
<p>3、环境变量<br> no display name and no $DISPLAY environment variable<br> export DISPLAY=:6.0<br> xhost +</p> 
<p>说明：</p> 
<pre><code class="prism language-python"><span class="token comment"># 端口</span>
export DISPLAY<span class="token operator">=</span><span class="token punctuation">:</span><span class="token number">6.0</span>

<span class="token comment">#激活环境</span>
conda activate kohyass
<span class="token comment"># 运行</span>
<span class="token punctuation">.</span><span class="token operator">/</span>gui<span class="token punctuation">.</span>sh <span class="token operator">-</span><span class="token operator">-</span>listen <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span> <span class="token operator">-</span><span class="token operator">-</span>server_port <span class="token number">6006</span> <span class="token operator">-</span><span class="token operator">-</span>inbrowser <span class="token operator">-</span><span class="token operator">-</span>share

<span class="token comment"># 打标签</span>
勾选Overwrite existing captions <span class="token keyword">in</span> folder

<span class="token comment">#训练</span>
取消xformers

export http_proxy<span class="token operator">=</span>http<span class="token punctuation">:</span><span class="token operator">//</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.174</span><span class="token punctuation">:</span><span class="token number">12798</span> <span class="token operator">&amp;</span><span class="token operator">&amp;</span> export https_proxy<span class="token operator">=</span>http<span class="token punctuation">:</span><span class="token operator">//</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.174</span><span class="token punctuation">:</span><span class="token number">12798</span>
cd <span class="token operator">/</span>root<span class="token operator">/</span>autodl<span class="token operator">-</span>tmp<span class="token operator">/</span>Lora<span class="token operator">/</span>kohya_ss
export DISPLAY<span class="token operator">=</span><span class="token punctuation">:</span><span class="token number">6.0</span>
source activate kohyass
<span class="token punctuation">.</span><span class="token operator">/</span>gui<span class="token punctuation">.</span>sh <span class="token operator">-</span><span class="token operator">-</span>listen <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span> <span class="token operator">-</span><span class="token operator">-</span>server_port <span class="token number">6006</span> <span class="token operator">-</span><span class="token operator">-</span>inbrowser <span class="token operator">-</span><span class="token operator">-</span>share

</code></pre> 
<p>什么是CLI（命令行界面）、GUI(图形用户界面)、Terminal(终端)、Console（控制台）、Shell、TTY https://blog.csdn.net/csdn100861/article/details/116414786</p> 
<p>4、端口<br> netstat -a查看所有的服务端口（LISTEN，ESTABLISHED）<br> 查看指定端口，可以结合grep命令：<br> netstat -ap | grep 8080<br> 也可以使用lsof命令：lsof -i:8888<br> 若要关闭使用这个端口的程序，使用kill + 对应的pid<br> kill -9 PID号</p> 
<p>5、<br> wget下载文件，git 下载仓库<br> wget命令<br> 用来从指定的url下载文件，wget非常稳定，对带宽具有很强的适应性。<br> git clone<br> git clone 命令将存储库克隆到新目录中（专门用来下载github上东西使用的）<br> wget可以见用wget下载Github仓库中的脚本等文件</p> 
<p>换脸<br> Avatarify<br> SimSwap<br> DeepFaceLab<br> FaceSwap<br> Faceplay（app）</p> 
<p>换脸api<br> Face++的API</p> 
<p>换衣服<br> imagen<br> deepfloyd</p> 
<p>视频<br> TemporalKit</p> 
<p>技术：<br> 1、一张图替代 LoRa：ControlNet 发布重大更新 Reference Only<br> 2、多个controlnet<br> 3、control lite<br> 4、种子<br> 5、SD视频<br> mov2mov<br> controlnet M2M<br> multi-frame-rendering脚本<br> TemporalKit+EbSynth自动化拼接拆分生成风格视频<br> 图生图批量处理制作AI视频（脚本）<br> photoshop 将视频转成逐帧图片的方法<br> Deforum根据文本描述词自动生成视频<br> 注意：输出图片的像素也会影响生成效果</p> 
<ul><li> <p>mutil-control net<br> 1）对于以人物为主的AI动画来说，我们需要使用的就是depth和softedge 。<br> 2）Controlnet第一个选择depth_zoe，模型选择下载的depth新模型，权重为1，其他的不变；Controlnet第二个选择softedge_pidinet或者HED，模型选择softedge，权重在0.6起步，如果测试画面变化较大，则调大该数值，最高到1。</p> </li><li> <p>Lora<br> TAG： lora:fashionGirl_v50:1,fashi-g,red lips<br> 负面TAG：easy,nsfw<br> 采样器：Euler a ，DPM ++ SDE Karras 都可以<br> 采样步数：26-32，这里我选的是30<br> 面部修复：勾选<br> 宽度高度：跟随原图，我这里选的是 4K画质 1080*1980<br> 提示词引导系数：7-8 之间，我这里选了7<br> 重绘强度：0.45</p> </li></ul> 
<p>模型<br> 去civitai找，里面有分类和hugging face下载链接</p> 
<p>写实风模型 #<br> 说到万模型之母，不得不提原始版的Stable Diffusion了，简称SD，是CompVis与合作团队最初发表的模型，不断更新中。<br> 最初 Stable Diffusion v1是使用512x512像素的图片训练的，因此高于此尺寸的生图品质会变差。后来 Stable Diffusion v2的训练图片宽高提升到了768x768像素。<br> 网络上很多模型都基于此模型训练而来。适合画真人、动物、自然、科技、建筑的图像，亦学习过历史上许多画家的画风。<br> Chilloutmix：写实风格的模型，适合画出2.5次元，融合日韩真人与动漫风格的图像。<br> Deliberate：基于SD-1.5模型，适合生成精致写实风格的人物、动物、自然风景。<br> Realistic Vision v1.4：写实风人物与动物模型。</p> 
<p>动漫风模型 #<br> Anything万象熔炉 v4.5适合画动漫图，作者宣称不需要打一堆提示词也能出漂亮的图。<br> Waifu Diffusion v1.4是纯粹使用Danbooru图库训练而成，适合画动漫图。<br> Hentai Diffusion适合画动漫图，模型已使用大量负向提示词训练过以排除不良结果，另提供embeddings方便绘图时使用。<br> DreamShaper是基于SD-1.5模型，生成精细动漫人物与油画风格的模型。<br> OrangeMix3，混合多种风格的动漫绘图模型，偏写实。</p> 
<p>二次元<br> 底模型。一种不错的选择是，二次元选择novelai，训练三次元选择sd1.5，训练人物服装chilloutmix。也可以选择其他模型。使用 SD2.x based model 时，需要勾选 v2 参数。<br> 最近模型的迭代速度越来越快，截止目前效果比较好的二次元模型有：AOM2，pastelmix，anything-v3.0，Counterfeit-V2.5。<br> 推荐链接：https://www.bilibili.com/read/cv20538746</p> 
<p>meinaMIX meinaMIX大模型，这个模型非常万能，不需要VAE，不论是挂群机器人api生图，还是自己作图，不需要非常严格的tag都能出非常好的效果，同时对于AI动画来说，是我尝试过无数模型后选择的最优解。 作者：以太之尘丨 https://www.bilibili.com/read/cv23190880/</p> 
<p>写实</p> 
<h2><a id="sd_api_658"></a>三、sd api</h2> 
<p>1、风格模型和风格<br> “风格模型”不是“风格”，风格模型是指训练的Lora等风格模型；风格在prompt中直接写，逗号分隔即可。（不是先用生成文生成图，再用生成的图用风格模型生成不同风格）</p> 
<p>2、#api用listen<br> python launch.py --share --autolaunch --deepdanbooru --xformers --no-gradio-queue --port 6006 --nowebui --listen</p> 
<p>python launch.py --share --xformers --port 6006 --nowebui --listen --allow-code --enable-insecure-extension-access --api-log</p> 
<p>python launch.py --share --xformers --port 6006 --nowebui<br> python launch.py --share --xformers --port 6006 --listen --allow-code --enable-insecure-extension-access --api-log --api</p> 
<p>–allow-code 允许从web UI执行自定义脚本<br> –enable-insecure-extension-access 启用扩展选项卡，而不考虑其他选项。<br> –api-log 启用所有API请求的日志记录。</p> 
<p>1.texttoimg<br> 参数，要删掉或合理设置<br> “script_name”: “string”,<br> “sampler_name”: “string”,</p> 
<p>2、contronet、基底模型、Lora（只设置txt2img参数）<br> “module”: None,时input_image可以直接用姿势图<br> lora不生效：https://github.com/AUTOMATIC1111/stable-diffusion-webui/pull/12387/files<br> <img src="https://images2.imgbox.com/98/61/WvGwcDyH_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> io
<span class="token keyword">import</span> cv2
<span class="token keyword">import</span> base64
<span class="token keyword">import</span> requests


<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image


<span class="token comment"># A1111 URL</span>
<span class="token comment"># url = "https://u132133-9d45-09ef11c3.beijinga.seetacloud.com"</span>
url <span class="token operator">=</span> <span class="token string">"http://127.0.0.1:6006"</span>

<span class="token comment"># Read Image in RGB order</span>
img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">'./img/xue.jpg'</span><span class="token punctuation">)</span>
<span class="token comment"># img2 = cv2.imread('./img/mask2.png')</span>
<span class="token comment"># img3 = cv2.imread('./img/black.png')</span>

<span class="token comment"># Encode into PNG and send to ControlNet</span>
retval<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imencode<span class="token punctuation">(</span><span class="token string">'.png'</span><span class="token punctuation">,</span> img<span class="token punctuation">)</span>
encoded_image <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span><span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>

<span class="token comment"># retval2, bytes2 = cv2.imencode('.png', img2)</span>
<span class="token comment"># mask_image = base64.b64encode(bytes2).decode('utf-8')</span>
<span class="token comment">#</span>
<span class="token comment"># retval3, bytes3 = cv2.imencode('.png', img3)</span>
<span class="token comment"># black_image = base64.b64encode(bytes3).decode('utf-8')</span>

<span class="token comment"># A1111 payload</span>
payload <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"prompt"</span><span class="token punctuation">:</span> <span class="token string">'LYF@SEAN,(wearing a turtleneck sweater:1.2),(RAW photo, best quality), (realistic, photo-realistic:1.4), masterpiece, an extremely delicate and beautiful, extremely detailed, 2k wallpaper, Amazing, finely detail, extremely detailed CG unity 8k wallpaper, ultra-detailed, highres, soft light, beautiful detailed girl, extremely detailed eyes and face, beautiful detailed nose, beautiful detailed eyes,cinematic lighting,city lights at night,perfect anatomy,slender body,light smile,(close up:1.1) &lt;lora:minnielorashy:1&gt; '</span><span class="token punctuation">,</span>
    <span class="token string">"negative_prompt"</span><span class="token punctuation">:</span> <span class="token string">"paintings, sketches, (worst quality:2), (low quality:2), (normal quality:2), dot, mole, lowers, normal quality, monochrome, grayscale, lowers, text, error, cropped, worst quality, low quality, jpeg artifacts, ugly, duplicate, morbid, mutilated, out of frame, extra fingers, mutated hands, poorly drawn hands, poorly drawn face, mutation, deformed, blurry, dehydrated, bad anatomy, bad proportions, extra limbs, cloned face, disfigured, gross proportions, malformed limbs, missing arms, missing legs, extra arms, extra legs, fused fingers, too many fingers, long neck, username, watermark, signature"</span><span class="token punctuation">,</span>
    <span class="token comment">#</span>
    <span class="token comment"># "prompt":"cat",</span>
    <span class="token comment"># "styles": [</span>
    <span class="token comment">#     "liuyefeiwithLora"</span>
    <span class="token comment">#   ],</span>
    <span class="token string">"batch_size"</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
    <span class="token string">"steps"</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
    <span class="token string">"cfg_scale"</span><span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span>
    <span class="token string">"alwayson_scripts"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"controlnet"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"args"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{<!-- --></span>

                    <span class="token string">"input_image"</span><span class="token punctuation">:</span> encoded_image<span class="token punctuation">,</span>
                    <span class="token comment"># "input_image": mask_image,</span>
                    <span class="token comment"># "mask":black_image,</span>
                    <span class="token string">"module"</span><span class="token punctuation">:</span> <span class="token string">"openpose"</span><span class="token punctuation">,</span>
                    <span class="token string">"model"</span><span class="token punctuation">:</span> <span class="token string">"control_v11p_sd15_openpose [cab727d4]"</span><span class="token punctuation">,</span>
                    <span class="token string">"pixel_perfect"</span><span class="token punctuation">:</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">#"module": None,时input_image可以直接用姿势图</span>
    <span class="token comment"># "alwayson_scripts": {<!-- --></span>
    <span class="token comment">#     "controlnet": {<!-- --></span>
    <span class="token comment">#         "args": [</span>
    <span class="token comment">#             {<!-- --></span>
    <span class="token comment">#</span>
    <span class="token comment">#                 # "input_image": encoded_image,</span>
    <span class="token comment">#                 "input_image": mask_image,</span>
    <span class="token comment">#                 # "mask":black_image,</span>
    <span class="token comment">#                 "module": None,</span>
    <span class="token comment">#                 "model": "control_v11p_sd15_openpose [cab727d4]",</span>
    <span class="token comment">#                 "pixel_perfect":False,</span>
    <span class="token comment">#             }</span>
    <span class="token comment">#         ]</span>
    <span class="token comment">#     }</span>
    <span class="token comment"># },</span>


    <span class="token string">"override_settings"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"sd_model_checkpoint"</span><span class="token punctuation">:</span> <span class="token string">"v1-5-pruned-emaonly.safetensors [6ce0161689]"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment"># SakuraMix.safetensors [1fd567aac7]  RealisticAsians.safetensors [bc2f30f4ad]</span>
    <span class="token string">"override_settings_restore_afterwards"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>



<span class="token punctuation">}</span>


<span class="token comment"># Trigger Generation</span>
response <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>url<span class="token punctuation">}</span></span><span class="token string">/sdapi/v1/txt2img'</span></span><span class="token punctuation">,</span> json<span class="token operator">=</span>payload<span class="token punctuation">)</span>

<span class="token comment"># Read results</span>
r <span class="token operator">=</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'返回：'</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>r<span class="token punctuation">[</span><span class="token string">'images'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

result <span class="token operator">=</span> r<span class="token punctuation">[</span><span class="token string">'images'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token comment"># image = Image.open(io.BytesIO(base64.b64decode(result.split(",", 1)[0])))</span>
<span class="token comment"># image.save(f'./img/{key}output.png')</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'返回：'</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>r<span class="token punctuation">[</span><span class="token string">'images'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> key<span class="token punctuation">,</span>valu <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>r<span class="token punctuation">[</span><span class="token string">'images'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    image <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>io<span class="token punctuation">.</span>BytesIO<span class="token punctuation">(</span>base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>valu<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    image<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'./img/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>key<span class="token punctuation">}</span></span><span class="token string">output.png'</span></span><span class="token punctuation">)</span>
</code></pre> 
<p>3、api函数<br> create_model模型函数如何加入json<br> def text2imgapi(self, txt2imgreq: models.StableDiffusionTxt2ImgProcessingAPI):中的参数StableDiffusionTxt2ImgProcessingAPI返回值是create_model，该对象值设置格式txt2imgreq2(**data)<br> from pydantic import BaseModel</p> 
<pre><code class="prism language-python">
    data1<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
    <span class="token string">"prompt"</span><span class="token punctuation">:</span> <span class="token string">'LYF@SEAN,(wearing a turtleneck sweater:1.2),(RAW photo, best quality), (realistic, photo-realistic:1.4), masterpiece, an extremely delicate and beautiful, extremely detailed, 2k wallpaper, Amazing, finely detail, extremely detailed CG unity 8k wallpaper, ultra-detailed, highres, soft light, beautiful detailed girl, extremely detailed eyes and face, beautiful detailed nose, beautiful detailed eyes,cinematic lighting,city lights at night,perfect anatomy,slender body,light smile,(close up:1.1) &lt;lora:minnielorashy:1&gt; '</span><span class="token punctuation">,</span>
    <span class="token string">"negative_prompt"</span><span class="token punctuation">:</span> <span class="token string">"paintings, sketches, (worst quality:2), (low quality:2), (normal quality:2), dot, mole, lowers, normal quality, monochrome, grayscale, lowers, text, error, cropped, worst quality, low quality, jpeg artifacts, ugly, duplicate, morbid, mutilated, out of frame, extra fingers, mutated hands, poorly drawn hands, poorly drawn face, mutation, deformed, blurry, dehydrated, bad anatomy, bad proportions, extra limbs, cloned face, disfigured, gross proportions, malformed limbs, missing arms, missing legs, extra arms, extra legs, fused fingers, too many fingers, long neck, username, watermark, signature"</span><span class="token punctuation">,</span>
    <span class="token comment">#</span>
    <span class="token comment"># "prompt":"cat",</span>
    <span class="token comment"># "styles": [</span>
    <span class="token comment">#     "liuyefeiwithLora"</span>
    <span class="token comment">#   ],</span>

    <span class="token string">"alwayson_scripts"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"controlnet"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"args"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{<!-- --></span>
    
                    <span class="token string">"input_image"</span><span class="token punctuation">:</span> encoded_image<span class="token punctuation">,</span>
                    <span class="token comment"># "input_image": mask_image,</span>
                    <span class="token comment"># "mask":black_image,</span>
                    <span class="token string">"module"</span><span class="token punctuation">:</span> <span class="token string">"openpose_full"</span><span class="token punctuation">,</span>
                    <span class="token string">"model"</span><span class="token punctuation">:</span> <span class="token string">"control_v11p_sd15_openpose [cab727d4]"</span><span class="token punctuation">,</span>
                    <span class="token comment"># "pixel_perfect":False,</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"batch_size"</span><span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">,</span>
    <span class="token string">"steps"</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
    <span class="token string">"cfg_scale"</span><span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span>
    <span class="token string">"override_settings"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"sd_model_checkpoint"</span><span class="token punctuation">:</span> <span class="token string">"v1-5-pruned-emaonly.safetensors [6ce0161689]"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment"># SakuraMix.safetensors [1fd567aac7]  RealisticAsians.safetensors [bc2f30f4ad]</span>
    <span class="token string">"override_settings_restore_afterwards"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    data2<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">'enable_hr'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">'denoising_strength'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'firstphase_width'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'firstphase_height'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'hr_scale'</span><span class="token punctuation">:</span> <span class="token number">2.0</span><span class="token punctuation">,</span> <span class="token string">'hr_upscaler'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">'hr_second_pass_steps'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'hr_resize_x'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'hr_resize_y'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'hr_sampler_name'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">'hr_prompt'</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">'hr_negative_prompt'</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">'prompt'</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">'styles'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'liuyefeiwithLora'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'seed'</span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'subseed'</span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'subseed_strength'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'seed_resize_from_h'</span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'seed_resize_from_w'</span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'sampler_name'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">'batch_size'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">'n_iter'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'steps'</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">'cfg_scale'</span><span class="token punctuation">:</span> <span class="token number">7.0</span><span class="token punctuation">,</span> <span class="token string">'width'</span><span class="token punctuation">:</span> <span class="token number">512</span><span class="token punctuation">,</span> <span class="token string">'height'</span><span class="token punctuation">:</span> <span class="token number">512</span><span class="token punctuation">,</span> <span class="token string">'restore_faces'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">'tiling'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">'do_not_save_samples'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">'do_not_save_grid'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">'negative_prompt'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">'eta'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">'s_min_uncond'</span><span class="token punctuation">:</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token string">'s_churn'</span><span class="token punctuation">:</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token string">'s_tmax'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">'s_tmin'</span><span class="token punctuation">:</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token string">'s_noise'</span><span class="token punctuation">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token string">'override_settings'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">'sd_model_checkpoint'</span><span class="token punctuation">:</span> <span class="token string">'RealisticAsians.safetensors [bc2f30f4ad]'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'override_settings_restore_afterwards'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token string">'script_args'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'sampler_index'</span><span class="token punctuation">:</span> <span class="token string">'Euler'</span><span class="token punctuation">,</span> <span class="token string">'script_name'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">'send_images'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token string">'save_images'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">'alwayson_scripts'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">}</span>

    <span class="token keyword">from</span> modules<span class="token punctuation">.</span>api <span class="token keyword">import</span> models

    txt2imgreq<span class="token operator">=</span>models<span class="token punctuation">.</span>StableDiffusionTxt2ImgProcessingAPI

    <span class="token keyword">from</span> modules<span class="token punctuation">.</span>processing <span class="token keyword">import</span> StableDiffusionProcessingTxt2Img

    txt2imgreq2<span class="token operator">=</span>models<span class="token punctuation">.</span>PydanticModelGenerator<span class="token punctuation">(</span>
    <span class="token string">"StableDiffusionProcessingTxt2Img"</span><span class="token punctuation">,</span>
    StableDiffusionProcessingTxt2Img<span class="token punctuation">,</span>
    <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span><span class="token string">"key"</span><span class="token punctuation">:</span> <span class="token string">"sampler_index"</span><span class="token punctuation">,</span> <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token string">"default"</span><span class="token punctuation">:</span> <span class="token string">"Euler"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span><span class="token string">"key"</span><span class="token punctuation">:</span> <span class="token string">"script_name"</span><span class="token punctuation">,</span> <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token string">"default"</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span><span class="token string">"key"</span><span class="token punctuation">:</span> <span class="token string">"script_args"</span><span class="token punctuation">,</span> <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">,</span> <span class="token string">"default"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span><span class="token string">"key"</span><span class="token punctuation">:</span> <span class="token string">"send_images"</span><span class="token punctuation">,</span> <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token string">"default"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span><span class="token string">"key"</span><span class="token punctuation">:</span> <span class="token string">"save_images"</span><span class="token punctuation">,</span> <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token string">"default"</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span><span class="token string">"key"</span><span class="token punctuation">:</span> <span class="token string">"alwayson_scripts"</span><span class="token punctuation">,</span> <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">,</span> <span class="token string">"default"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span>generate_model<span class="token punctuation">(</span><span class="token punctuation">)</span>
    

    txt2imgreq3<span class="token operator">=</span>txt2imgreq2<span class="token punctuation">(</span><span class="token operator">**</span>data1<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'开始执行：'</span><span class="token punctuation">,</span>txt2imgreq3<span class="token punctuation">)</span>

    response<span class="token operator">=</span>api<span class="token punctuation">.</span>text2imgapi<span class="token punctuation">(</span>txt2imgreq3<span class="token punctuation">)</span>
    <span class="token comment"># response=vars(response)</span>
    <span class="token comment"># print('结果：',response)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'结果类型：'</span><span class="token punctuation">,</span><span class="token builtin">type</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre> 
<p><img src="https://images2.imgbox.com/55/4c/YI2lne9P_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/91/05/fOfxrApR_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="ai_857"></a>四、ai视频模型</h2> 
<p>视频风格：<br> 视频转动漫：AnimeGANv3<br> 视频转卡通：White-box-Cartoonization<br> WebtoonMe：Webtoon，web+cartoon，也就是“网页版漫画”，是漫画的一种呈现形式，出自韩国。<br> Gen-1的人工智能模型，可以通过应用文本提示或者参考图像所指定的任意风格，将现有视频转换为新视频。</p> 
<p>APP:<br> faceplay<br> StyleX<br> wink<br> illusion style</p> 
<p>文生视频<br> Stable Animation<br> Gen-2</p> 
<p>换脸<br> Avatarify<br> SimSwap<br> DeepFaceLab<br> FaceSwap</p> 
<p>1、deepfacelab<br> 其实知道了差别，就应该大概明白怎么选了。核心原则就是根据自身情况和应用场景选择。比如你的显卡显存只有2G，那么你就直接选择Quick96好了，其他基本没得选了。如果你需要能灵活设置参数，实现高质量的视频换脸，那么肯定用SAEHD。如果你训练模型是为了应用在DeepFaceLive中实现实时换脸，那么推荐AMP。当然，SAEHD其实也是可以用于DeepFaceLvie。</p> 
<ul><li>应用场景不一样。<br> Quick96适合入门，适合快速合成的项目。特点就是快，缺点就是质量一般般。<br> SAEHD用于高质量的视频合成，相应的学习和训练的时间也会被拉长。<br> AMP为了实时换脸而打造，为了这个目的而做了一些优化。</li></ul> 
<h2><a id="_891"></a>五、换脸</h2> 
<p>效果比较好的：facefusion、afterdetail、roop<br> AI Deepfakes 就是人工智能的深度换脸技术。简单来说就是脸部替换，可以将B的脸换到A的脸上。和PS不同的是，这项技术不仅可以生成图片，还是可以生成视频的，而且你并不需要懂得那么多的技术。只要你收集到足够素材，程序的AI就可以帮你自动完成。举个例子，你可以将自己的脸换到特朗普总统演讲的视频上，这样看上去像是你自己在总统演讲，只要你的脸部表情素材足够多，换完之后表情颜色和口型会非常自然。<br> Deepfake技术发展过程（截止2020.01，涵盖AI换脸）：<br> 2014.06：提出生成对抗网络（GAN），在图片创建方面取得重大突破，之前的AI算法可以较好的分类图片但创建图片困难；<br> 2017.07：提出一种使用RNN 的LSTM（Long Short-Term Memory）学习口腔形状和声音之间关联性的方法，仅通过音频即可合成对应的口部特征；<br> 2017.10：提出一种基于 GAN 的自动化实时换脸技术；<br> 2017.12：出现deepfake色情视频，名人的面孔被换成色情演员的面孔，由Reddit用户使用自动编码器-解码器配对结构开发（FakeApp前身）；<br> 2018.04：出现美国前总统奥巴马的deepfake演讲，将声优的口型（含模仿的配音）替换到奥巴马演讲视频中，使用了FakeApp；<br> 2018.08：提出一种将源视频中的运动转移到另一个视频中目标人的方法，而不仅是换脸（效果imperfect）；<br> 2019.03：提出一种控制图片生成器并能编辑造假图片各方面特性的方法，比如肤色、头发颜色和背景内容，不同于之前的假人图片生成方法，这是一种重大突破；<br> 2019.05：提出一种真实头部说话神经模型的少样本对抗学习，基于GAN元学习，该模型基于少量图像（few-shot）训练后，向其输入一张人物头像，可以生成人物头像开口说话的动图；<br> 2019.06：出现“一键式”智能脱衣软件 Deepnude，迫于舆论压力，开发者快速下架。<br> 2020：主要进展在提高原生分辨率、提升deepfake制作效果方面。</p> 
<p>deepfacelab、FaceSwap或ZAO哪个最适，对比</p> 
<ul><li>DeepFaceLab<br> 优点：<br> 可手动调整每帧中的脸部识别，减少提取脸部时的错误<br> mt模式下训练出的效果很好，脸部贴合度高<br> 可选择的训练模式较多<br> 有集成环境版本，只需正确安装驱动即可使用，无需单独搭建环境，对非专业人士较友好<br> 缺点：mt模式的训练时间较长，但最后效果最好</li><li>FaceSwap<br> 优点：<br> 模型训练速度较快，同样配置下更快的到达低loss值<br> 有gui界面版本<br> 缺点：<br> 安装环境较复杂，特别是安装vc++2015，如果电脑自带其他vc++版本，清理替换是个比较麻烦的过程<br> 总结<br> 推荐新人直接上手DeepFaceLab的集成环境版本</li></ul> 
<p>换脸<br> Avatarify<br> SimSwap<br> DeepFaceLab<br> FaceSwap<br> FaceApp和Avatarify<br> 新Make-A-Protagonist</p> 
<p>SimSwap：单张图视频换脸的项目（图–&gt;视频）<br> FaceShifter：一秒换脸的人脸交换模型（图–&gt;图）<br> DeepFaceLab：视频训练模型，再用模型转换视频（视—&gt;模—&gt;视）<br> DeepFacelive：直播换脸（模–&gt;视）<br> Make-A-Protagonist：一张照片即可换脸、换背景（图–&gt;背景）<br> Avatarify ：动画头像（图----&gt;动画）</p> 
<p>换脸相关算法：<br> 1、One-Shot Face Video Re-enactment using Hybrid Latent Spaces of StyleGAN2<br> 2、DiffFace: Diffusion-based Face Swapping with Facial Guidance<br> 3、FlowFace: Semantic Flow-guided Shape-aware Face Swapping<br> 4、Landmark Enforcement and Style Manipulation for Generative Morphing<br> 5、SimSwap: An Efficient Framework For High Fidelity Face Swapping<br> 6、FaceDancer: Pose- and Occlusion-Aware High Fidelity Face Swapping<br> 7、StyleMask: Disentangling the Style Space of StyleGAN2 for Neural<br> 8、StyleSwap: Style-Based Generator Empowers Robust Face Swapping<br> 9、Region-Aware Face Swapping<br> 10、MobileFaceSwap: A Lightweight F</p> 
<p>扩散模型<br> 【CVPR2022】DiffFace: Diffusion-based Face Swapping with Facial Guidance<br> GAN<br> 【ACM_2020】SimSwap: An Efficient Framework For High Fidelity Face Swapping<br> 【CVPR_2020(Oral)】FaceShifter: Towards High Fidelity And Occlusion Aware Face Swapping<br> 【CVPR_2021】HifiFace: 3D Shape and Semantic Prior Guided High Fidelity Face Swapping<br> 【PAMI_2022】FSGANv2: Improved Subject Agnostic Face Swapping and Reenactment<br> StyleGAN<br> 【CVPR_2022.6】Region-Aware Face Swapping<br> 【CVPR_2022】High-resolution Face Swapping via Latent Semantics Disentanglement<br> 【CVPR_2023】E4S: Fine-grained Face Swapping via Regional GAN Inversion<br> 【补充精读】Supplement for “ Fine-Grained Face Swapping via Regional GAN Inversion”</p> 
<p>测试效果：<br> 1、deepfacelab<br> 1。conda中shell问题<br> 修改shell文件中的conda虚拟环境</p> 
<p>2。SAEHD和AMP（Linux没有amp）<br> 维度参数要合理设置，内存比较小的时候，选最小维度dims<br> 结合gpu内存vram大小设置<img src="https://images2.imgbox.com/d8/6c/H7NiU5mb_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/ed/1b/eXt00n9C_o.png" alt="在这里插入图片描述"></p> 
<p>2、deepfacelive<br> 使用obs链接直播</p> 
<p>3、e4s<br> 效果很差</p> 
<h2><a id="voice2face_991"></a>六、voice2face</h2> 
<p>三维人脸重建技术</p> 
<p>语音驱动三维人脸<br> 简单介绍<br> Audio2Mesh<br> 2017 英伟达 Audio2Face<br> CVPR 2019 马普所 VOCA<br> CVPR 2021 Facebook MeshTalk<br> CVPR 2022 香港大学 Faceformer<br> Audio2ExpressionCoefficient<br> 2022 Facegood Audio2Face<br> 参考：https://zhuanlan.zhihu.com/p/484217988#Audio2ExpressionCoefficient</p> 
<p>2022 Facegood Audio2Face<br> Voice2Face是FACEGOOD（量子动力）在2022年年初，开源的一项关于语音驱动三维人脸的项目。</p> 
<p>APP<br> xpression camera</p> 
<p>基于视频的三维人脸重建<br> https://blog.csdn.net/qq_14845119/article/details/112325281</p> 
<h2><a id="clash_1014"></a>七、clash代理</h2> 
<p>查看系统架构，uname -a<br> x86_64 GNU/Linux</p> 
<p>选择你的猫：https://github.com/Dreamacro/clash/releases/tag/v1.16.0<br> x86_64 GNU/Linux的猫选clash-linux-amd64-v3-v1.16.0.gz</p> 
<p><img src="https://images2.imgbox.com/a4/dc/mxYmIMnO_o.png" alt="在这里插入图片描述"><br> 配置参考链接：<br> https://www.hengy1.top/article/3dadfa74.html<br> https://opclash.com/fenxiang/302.html<br> https://dantefung.github.io/2021/08/05/ubuntu20-4%E4%B8%8B%E4%BD%BF%E7%94%A8clash/</p> 
<p>.bashrc是home目录下的一个shell文件，用于储存用户的个性化设置。在bash每次启动时都会加载.bashrc文件中的内容，并根据内容定制当前bash的配置和环境。<br> <img src="https://images2.imgbox.com/71/94/IC4mjVqI_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/6a/5d/vi2ulfxI_o.png" alt="在这里插入图片描述"></p> 
<p>注意代理错误：alias proxy_on=“export https_proxy=127.0.0.1:7890 &amp;&amp; export http_proxy=127.0.0.1:7890”<br> 纠正：export http_proxy=http://代理IP:端口号<br> export https_proxy=http://代理IP:端口号</p> 
<pre><code class="prism language-python"><span class="token comment"># 创建环境</span>
$ mkdir clash
$ cd clash
<span class="token comment"># 拉取下来</span>
$ wget https<span class="token punctuation">:</span><span class="token operator">//</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>Dreamacro<span class="token operator">/</span>clash<span class="token operator">/</span>releases<span class="token operator">/</span>download<span class="token operator">/</span>v1<span class="token punctuation">.</span><span class="token number">9.0</span><span class="token operator">/</span>clash<span class="token operator">-</span>linux<span class="token operator">-</span>amd64<span class="token operator">-</span>v1<span class="token punctuation">.</span><span class="token number">9.0</span><span class="token punctuation">.</span>gz
$ gzip <span class="token operator">-</span>d clash<span class="token operator">-</span>linux<span class="token operator">-</span>amd64<span class="token operator">-</span>v1<span class="token punctuation">.</span><span class="token number">9.0</span><span class="token punctuation">.</span>gz
$ mv clash<span class="token operator">-</span>linux<span class="token operator">-</span>amd64<span class="token operator">-</span>v1<span class="token punctuation">.</span><span class="token number">9.0</span><span class="token punctuation">.</span>gz clash
<span class="token comment"># 这里clash为二进制可以运行文件了</span>
$ chomd <span class="token number">755</span> clash
chmod <span class="token operator">+</span>x clash


<span class="token comment"># 生成默认配置</span>
$ <span class="token punctuation">.</span><span class="token operator">/</span>clash <span class="token operator">-</span>d <span class="token punctuation">.</span>  <span class="token comment"># 默认配置</span>
<span class="token comment"># 拉取机场配置</span>
$ wget xxxx <span class="token comment"># 要么拉下来 要么自己拷贝上来</span>
<span class="token comment"># 注意： 名称为：config.yaml</span>
$ <span class="token punctuation">.</span><span class="token operator">/</span>clash <span class="token operator">-</span>d <span class="token punctuation">.</span> <span class="token comment"># 就开始加载你的配置了</span>

</code></pre> 
<pre><code class="prism language-python">vim <span class="token operator">~</span><span class="token operator">/</span><span class="token punctuation">.</span><span class="token punctuation">.</span>bashrc开始准备命令并把下面的写进入
alias clash_start<span class="token operator">=</span><span class="token string">"screen -S clash /home/xxx/clash/clash -d /home/xxx/clash/"</span> <span class="token comment">#-d /home/xxx/clash/配置文件位置confi.yaml</span>
alias clash_stop<span class="token operator">=</span><span class="token string">"pkill clash"</span>

<span class="token comment">#alias proxy_on="export https_proxy=127.0.0.1:7890 &amp;&amp; export http_proxy=127.0.0.1:7890"</span>
alias proxy_on<span class="token operator">=</span><span class="token string">"export https_proxy=http://127.0.0.1:7890 &amp;&amp; export http_proxy=http://127.0.0.1:7890"</span>
alias proxy_off<span class="token operator">=</span><span class="token string">"unset http_proxy https_proxy"</span>
</code></pre> 
<p>Screen 多窗口操作：通过 Screen 命令，你可以在同一个终端窗口中创建多个窗口，并在这些窗口中同时运行不同的应用程序，而不需要打开多个终端窗口。查看状态：screen -ls</p> 
<ul><li>临时有效<br> 1、添加代理<br> export http_proxy=http://proxyAddress:port<br> export https_proxy=http://proxyAddress:port<br> export https_proxy=http://127.0.0.1:7890 &amp;&amp; export http_proxy=http://127.0.0.1:7890<br> 2、查看代理<br> env |grep -i proxy<br> 3、清除代理<br> unset http_proxy<br> unset https_proxy<br> unset http_proxy https_proxy</li></ul> 
<p>1、Windows<br> 根据网上的文章，在Windows下使用全局代理方式也会对cmd生效（未经验证）。<br> cmd<br> set http_proxy=http://127.0.0.1:1080<br> set https_proxy=http://127.0.0.1:1080<br> 还原命令：<br> set http_proxy=<br> set https_proxy=<br> 2、Git Bash<br> 设置方法同"macOS &amp; Linux"<br> macOS &amp; Linux<br> 通过设置http_proxy、https_proxy，可以让终端走指定的代理。 配置脚本如下，在终端直接执行，只会临时生效：<br> export http_proxy=http://127.0.0.1:1080<br> export https_proxy=$http_proxy<br> 参考：https://zhuanlan.zhihu.com/p/357875811</p> 
<h2><a id="3090cudatensorflow_1x_1098"></a>八、3090、cuda和tensorflow 1.x</h2> 
<p>因为3090只支持cuda11.0+的版本，而tensorflow1.×已经不再维护，没有出支持cuda11.0+的版本了。<br> nvidia提供了TF1.x对RTX 3090、cuda11等新硬件的支持。卸载已有的tensorflow-gpu包和conda安装的cuda包，安装nvidia版本tensorflow:</p> 
<pre><code class="prism language-python">pip install nvidia<span class="token operator">-</span>pyindex
pip install nvidia<span class="token operator">-</span>tensorflow  <span class="token comment"># 会自动安装相关cuda依赖</span>

pip install tensorboard
<span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf 和 tf<span class="token punctuation">.</span>test<span class="token punctuation">.</span>is_gpu_available<span class="token punctuation">(</span><span class="token punctuation">)</span> 测试，如果出现以下内容WARNING<span class="token punctuation">:</span>root<span class="token punctuation">:</span>Limited tf<span class="token punctuation">.</span>compat<span class="token punctuation">.</span>v2<span class="token punctuation">.</span>summary API due to missing TensorBoard installation<span class="token punctuation">.</span>此时还需要再安装一个<span class="token punctuation">.</span>重新安装tensorboard。pip install tensorboard即可解决

</code></pre> 
<p>pip install tensorboard<br> import tensorflow as tf 和 tf.test.is_gpu_available() 测试，如果出现以下内容WARNING:root:Limited tf.compat.v2.summary API due to missing TensorBoard installation.此时还需要再安装一个。重新安装tensorboard。pip uninstall tensorboard、pip install tensorboard即可解决<br> 注：nvidia-tensorflow仓库提示需要使用Python3.8，但我使用Python3.6，可用。<br> 参考：<br> https://blog.csdn.net/qq_39543404/article/details/112171851<br> https://www.cnblogs.com/xikeguanyu/p/16269066.html<br> https://zhuanlan.zhihu.com/p/521957441<br> https://blog.csdn.net/znevegiveup1/article/details/115053563</p> 
<p>测试TF和cuda</p> 
<pre><code class="prism language-python"><span class="token number">1</span>、
<span class="token comment">#（1）查看TF版本</span>
<span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf
tf<span class="token punctuation">.</span>__version__        <span class="token comment"># 此命令为获取安装的tensorflow版本</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>tf<span class="token punctuation">.</span>__version__<span class="token punctuation">)</span> <span class="token comment"># 输出版本</span>
tf<span class="token punctuation">.</span>__path__			   <span class="token comment">#查看tensorflow安装路径</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>tf<span class="token punctuation">.</span>__path__<span class="token punctuation">)</span>

<span class="token comment">#（2）查看cuda是否可用</span>
<span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf
<span class="token keyword">print</span><span class="token punctuation">(</span>tf<span class="token punctuation">.</span>test<span class="token punctuation">.</span>is_gpu_available<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#如果结果是True，表示GPU可用</span>

<span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf
tf<span class="token punctuation">.</span>test<span class="token punctuation">.</span>is_gpu_available<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">#(3)查看cuda版本</span>
nvidia<span class="token operator">-</span>smi <span class="token comment">#系统中自带的cuda</span>

conda <span class="token builtin">list</span> <span class="token operator">|</span> grep cuda <span class="token comment">#虚拟环境的cuda或者用pip看包信息</span>


<span class="token number">2</span>、
<span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf
gpu_device_name <span class="token operator">=</span> tf<span class="token punctuation">.</span>test<span class="token punctuation">.</span>gpu_device_name<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>gpu_device_name<span class="token punctuation">)</span>
tf<span class="token punctuation">.</span>test<span class="token punctuation">.</span>is_gpu_available<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf
tf<span class="token punctuation">.</span>test<span class="token punctuation">.</span>is_built_with_cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>tf<span class="token punctuation">.</span>test<span class="token punctuation">.</span>is_built_with_cuda<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#返回true表示可用</span>


<span class="token number">3</span>、
<span class="token keyword">from</span> tensorflow<span class="token punctuation">.</span>python<span class="token punctuation">.</span>client <span class="token keyword">import</span> device_lib
 <span class="token comment"># 列出所有的本地机器设备</span>
local_device_protos <span class="token operator">=</span> device_lib<span class="token punctuation">.</span>list_local_devices<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 打印</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>local_device_protos<span class="token punctuation">)</span>
<span class="token comment"># 只打印GPU设备</span>
<span class="token punctuation">[</span><span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> local_device_protos <span class="token keyword">if</span> x<span class="token punctuation">.</span>device_type <span class="token operator">==</span> <span class="token string">'GPU'</span><span class="token punctuation">]</span>

</code></pre> 
<p>测试Pytorch和cuda</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">print</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>__version__<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li>CUDA版本<br> 1.查看当前安装的版本（nvcc -V）<br> 通过nvcc(NVIDIA Cuda compiler driver)命令可查看本机安装的CUDA版本：nvcc -V<br> nvcc -V查看的是系统自带的cuda的版本，要看虚拟环境中的版本，要导入pytorch和tensorflow库进行测试<br> <code>pytorch中：print(torch.__version__)</code> 与<br> <code>tensorflow中：conda list | grep cuda直接在终端里，打开相应环境，进行查看</code><br> 2.查看能支持的最高CUDA版本（nvidia-smi）<br> 通过nvidia-smi 命令可查看本机的Nvidia显卡驱动信息，以及该驱动支持的最高的CUDA版本。nvidia-smi，例如下面的CUDA Version就是我的电脑上面能够安装的最高版本的CUDA，并且该版本号是向下支持的，可以安装低于该版本号的所有CUDA套件</li></ul> 
<p>tenserflow卸载<br> 检查：<br> sudo pip show tensorflow<br> 卸载使用：<br> pip uninstall protobuf<br> pip uninstall tensorflow<br> pip uninstall tensorflow-gpu<br> pip uninstall tensorflow-cpu</p> 
<p>pip wheel 安装 TensorRT：<br> 安装 nvidia-pyindex 包用下面这条命令<br> pip install nvidia-pyindex<br> 安装装好之后，就可以开始安装 TensorRT 了。使用下面的命令：<br> pip install --upgrade nvidia-tensorrt</p> 
<pre><code class="prism language-python">pip install nvidia<span class="token operator">-</span>pyindex
pip install nvidia<span class="token operator">-</span>tensorrt<span class="token operator">==</span><span class="token number">8.2</span><span class="token number">.5</span><span class="token number">.1</span>

<span class="token keyword">import</span> tensorrt
<span class="token keyword">print</span><span class="token punctuation">(</span>tensorrt<span class="token punctuation">.</span>__version__<span class="token punctuation">)</span>
<span class="token keyword">assert</span> tensorrt<span class="token punctuation">.</span>Builder<span class="token punctuation">(</span>tensorrt<span class="token punctuation">.</span>Logger<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre> 
<p>参考：https://blog.csdn.net/qq_37541097/article/details/114847600<br> https://www.cnblogs.com/asnelin/p/15929442.html</p> 
<p><strong>同时安装tensorflow、pytorch</strong><br> 主要考虑cudnn、tensorflow、pytorch的版本问题，先选cuda的版本和显卡的匹配，再选tensorflow、pytorch的cuda对应版本。<br> cuda、cudnn、tensorflow（-gpu）、pytorch弄清版本。<br> 参考：https://blog.csdn.net/LIWEI940638093/article/details/113811563</p> 
<h2><a id="__NvidiaCUDAcuDNNAnacondaTensorflowGPU_1218"></a>八、 Nvidia显卡驱动、CUDA、cuDNN、Anaconda及Tensorflow-GPU版本</h2> 
<p>https://blog.csdn.net/qq_28256407/article/details/115548675?ydreferer=aHR0cHM6Ly9jbi5iaW5nLmNvbS8%3D?ydreferer=aHR0cHM6Ly9jbi5iaW5nLmNvbS8%3D<br> https://blog.csdn.net/m0_45447650/article/details/132058561</p> 
<p>2.查看cuda和torch的版本</p> 
<pre><code>python -c 'import torch;print(torch.__version__);print(torch.version.cuda)'
</code></pre> 
<p>1、CUDA与显卡驱动<br> https://www.nvidia.com/Download/index.aspx<br> <img src="https://images2.imgbox.com/e0/f8/Snx8ky8f_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/35/83/ogutNW54_o.png" alt="在这里插入图片描述"></p> 
<p>2、cuDNN Toolkit与CUDA版本<br> https://developer.nvidia.com/rdp/cudnn-archive<br> <img src="https://images2.imgbox.com/d0/8d/DkujXw5w_o.png" alt="在这里插入图片描述"><br> 3、TensorFlow与CUDA cuDNN<br> https://tensorflow.google.cn/install/source?hl=en</p> 
<p><img src="https://images2.imgbox.com/84/7e/Zcblltk0_o.png" alt="在这里插入图片描述"><br> 4、Pytorch与CUDA cuDNN<br> https://pytorch.org/<br> <img src="https://images2.imgbox.com/ab/e7/6bNvuaNt_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/3c/8d/DPYVd96e_o.png" alt="在这里插入图片描述"></p> 
<p>5、cudnn<br> https://zhuanlan.zhihu.com/p/639184948<br> https://blog.csdn.net/Williamcsj/article/details/123514435</p> 
<p>官方下载地址：https://developer.nvidia.com/rdp/cudnn-archive<br> <img src="https://images2.imgbox.com/12/4c/XuUakHPt_o.png" alt="在这里插入图片描述"></p> 
<p>安装TensorFlow</p> 
<ol><li>安装依赖包<br> 安装 TensorFlow 之前需要我们安装两个个依赖包，这里我的 cuda 版本为 11.1，cudnn 版本为 8.1.0，下载依赖包为<br> libcudnn8_8.1.0.77-1+cuda11.2_amd64.deb<br> libcudnn8-dev_8.1.0.77-1+cuda11.2_amd64.deb<br> 官网链接如下：https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64/<br> 这里我使用 wget 下载：<br> 参考链接：https://blog.csdn.net/weixin_46584887/article/details/122726278<br> 官方教程：https://docs.nvidia.com/deeplearning/cudnn/install-guide/index.html<br> <img src="https://images2.imgbox.com/fe/2b/XTfUmIMm_o.png" alt="在这里插入图片描述"></li></ol> 
<p>6、安装过程<br> 参考：<br> https://blog.csdn.net/m0_45447650/article/details/132058561<br> https://blog.csdn.net/weixin_46584887/article/details/122726278</p> 
<p>1.安装显卡驱动</p> 
<p>方法（1）在线安装</p> 
<pre><code class="prism language-python"><span class="token number">1.</span> 卸载旧版本nvidia驱动
如果没有安装nvidia驱动，可直接跳过。

$ sudo apt purge nvidia<span class="token operator">*</span>
<span class="token number">1</span>
<span class="token number">2.</span> 把显卡驱动加入PPA
$ sudo add<span class="token operator">-</span>apt<span class="token operator">-</span>repository ppa<span class="token punctuation">:</span>graphics<span class="token operator">-</span>drivers
$ sudo apt update
<span class="token number">1</span>
<span class="token number">2</span>
<span class="token number">3.</span> 查找版本库中显卡驱动
使用以下命令查看系统版本库中所有nvidia驱动的信息，根据需要选择合适的版本。

$ sudo apt<span class="token operator">-</span>cache search nvidia
<span class="token number">1</span>
推荐使用以下命令，查看Ubuntu推荐的驱动版本，从中选择合适的版本。

$ ubuntu<span class="token operator">-</span>drivers devices
参考链接：https<span class="token punctuation">:</span><span class="token operator">//</span>blog<span class="token punctuation">.</span>csdn<span class="token punctuation">.</span>net<span class="token operator">/</span>qq_28256407<span class="token operator">/</span>article<span class="token operator">/</span>details<span class="token operator">/</span><span class="token number">115548675</span>
</code></pre> 
<p>方法（2）下载安装<br> https://www.nvidia.com/Download/index.aspx<br> <img src="https://images2.imgbox.com/bc/69/uYF2Qu9w_o.png" alt="在这里插入图片描述"></p> 
<p>可以参考：https://blog.csdn.net/Perfect886/article/details/119109380，之前是run文件，现在是def文件，Debian安装命令一般sudo dpkg -i 命令。<br> 例如：sudo dpkg -i cuda-repo--X-Y-local_*_x86_64.deb</p> 
<p>2、安装CUDA<br> 方法一：用run方式，可以选择是否安装驱动，一般不选<br> https://developer.nvidia.com/cuda-downloads?<br> <img src="https://images2.imgbox.com/46/ea/2d45xDWD_o.png" alt="在这里插入图片描述"><br> 选择是否安装：https://zhuanlan.zhihu.com/p/501473091<br> <img src="https://images2.imgbox.com/7f/a1/9nHFae1X_o.png" alt="在这里插入图片描述"><br> 配置环境</p> 
<pre><code class="prism language-python">配置环境
gedit <span class="token operator">~</span><span class="token operator">/</span><span class="token punctuation">.</span>bashrc
在打开的文件中添加
export CUDA_HOME<span class="token operator">=</span><span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>cuda<span class="token operator">-</span><span class="token number">11.1</span>
export LD_LIBRARY_PATH<span class="token operator">=</span>$<span class="token punctuation">{<!-- --></span>CUDA_HOME<span class="token punctuation">}</span><span class="token operator">/</span>lib64
export PATH<span class="token operator">=</span>$<span class="token punctuation">{<!-- --></span>CUDA_HOME<span class="token punctuation">}</span><span class="token operator">/</span><span class="token builtin">bin</span><span class="token punctuation">:</span>$<span class="token punctuation">{<!-- --></span>PATH<span class="token punctuation">}</span>
链接：https<span class="token punctuation">:</span><span class="token operator">//</span>blog<span class="token punctuation">.</span>csdn<span class="token punctuation">.</span>net<span class="token operator">/</span>qq_39821101<span class="token operator">/</span>article<span class="token operator">/</span>details<span class="token operator">/</span><span class="token number">116092190</span>
</code></pre> 
<p>方法二：官方教程：https://docs.nvidia.com/cuda/cuda-installation-guide-linux/index.html#<br> <img src="https://images2.imgbox.com/24/24/4C1hvojn_o.png" alt="在这里插入图片描述"><br> 参考：https://blog.csdn.net/qq_39821101/article/details/116092190<br> https://blog.csdn.net/m0_45447650/article/details/132058561</p> 
<p>3、安装cudnn</p> 
<p>（1）下载安装：cudann<br> https://developer.nvidia.com/rdp/cudnn-archive<br> <img src="https://images2.imgbox.com/7f/62/TfaNwpwF_o.png" alt="在这里插入图片描述"></p> 
<p>2 安装deb文件（安装 TensorFlow 之前需要我们安装两个个依赖包）<br> 官方下载地址：https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64/<br> <img src="https://images2.imgbox.com/be/7e/x1WyRnS3_o.png" alt="在这里插入图片描述"></p> 
<p>使用如下语句依次安装：（debain命令，Ubuntu也可以）<br> sudo dpkg -i libcudnn8_8.0.3.33-1+cuda11.0_amd64.deb<br> sudo dpkg -i libcudnn8-dev_8.0.3.33-1+cuda11.0_amd64.deb<br> sudo dpkg -i libcudnn8-samples_8.0.3.33-1+cuda11.0_amd64.deb</p> 
<p>Ubuntu命令，作为参考</p> 
<pre><code class="prism language-python">执行以下命令：
sudo apt install <span class="token punctuation">.</span><span class="token operator">/</span>cudnn<span class="token operator">-</span>local<span class="token operator">-</span>repo<span class="token operator">-</span>ubuntu2004<span class="token operator">-</span><span class="token operator">*</span>amd64<span class="token punctuation">.</span>deb
sudo cp <span class="token operator">/</span>var<span class="token operator">/</span>cudnn<span class="token operator">-</span>local<span class="token operator">-</span>repo<span class="token operator">-</span>ubuntu2004<span class="token operator">-</span><span class="token number">8.4</span><span class="token number">.1</span><span class="token number">.88</span><span class="token operator">/</span>cudnn<span class="token operator">-</span>local<span class="token operator">-</span>4B348671<span class="token operator">-</span>keyring<span class="token punctuation">.</span>gpg <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>keyrings<span class="token operator">/</span>
sudo apt update
<span class="token comment">#下面自动匹配版本，注意版本不对会出错</span>
sudo apt install libcudnn8
sudo apt install libcudnn8<span class="token operator">-</span>dev
sudo apt install libcudnn8<span class="token operator">-</span>samples
</code></pre> 
<p>参考：https://zhuanlan.zhihu.com/p/126997172<br> https://zhuanlan.zhihu.com/p/639184948</p> 
<p>4、安装TensorFlow<br> pip install -i https://mirrors.aliyun.com/pypi/simple tensorflow</p> 
<pre><code class="prism language-python"><span class="token comment">#（2）查看cuda是否可用</span>
<span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf
<span class="token keyword">print</span><span class="token punctuation">(</span>tf<span class="token punctuation">.</span>test<span class="token punctuation">.</span>is_gpu_available<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#如果结果是True，表示GPU可用</span>
</code></pre> 
<p>6、其他相关操作</p> 
<p>卸载</p> 
<pre><code class="prism language-py"><span class="token number">1.</span> 卸载旧版本nvidia驱动
如果没有安装nvidia驱动，可直接跳过。
$ sudo apt purge nvidia<span class="token operator">*</span>


<span class="token number">2</span>、卸载cuda
<span class="token comment">#只执行这条可以</span>
sudo apt<span class="token operator">-</span>get autoremove nvidia<span class="token operator">-</span>cuda<span class="token operator">-</span>toolkit


cd <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>cuda<span class="token operator">-</span><span class="token number">11.1</span><span class="token operator">/</span><span class="token builtin">bin</span>
sudo <span class="token punctuation">.</span><span class="token operator">/</span>cuda<span class="token operator">-</span>uninstaller
sudo rm <span class="token operator">-</span>rf <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>cuda<span class="token operator">-</span><span class="token number">11.1</span>
从https<span class="token punctuation">:</span><span class="token operator">//</span>developer<span class="token punctuation">.</span>nvidia<span class="token punctuation">.</span>com<span class="token operator">/</span>cuda<span class="token operator">-</span>toolkit<span class="token operator">-</span>archive下载对应版本的cuda
如果你之前执行过sudo apt<span class="token operator">-</span>get install nvidia<span class="token operator">-</span>cuda<span class="token operator">-</span>toolkit<span class="token punctuation">,</span>需要卸载：sudo apt<span class="token operator">-</span>get autoremove nvidia<span class="token operator">-</span>cuda<span class="token operator">-</span>toolkit

sudo  apt<span class="token operator">-</span>get install nvidia<span class="token operator">-</span>cuda<span class="token operator">-</span>toolkit
<span class="token comment"># 卸载</span>
sudo apt<span class="token operator">-</span>get autoremove nvidia<span class="token operator">-</span>cuda<span class="token operator">-</span>toolkit
在终端输入
nvcc <span class="token operator">-</span>V
没有cuda版本信息，则卸载成功
链接：https<span class="token punctuation">:</span><span class="token operator">//</span>blog<span class="token punctuation">.</span>csdn<span class="token punctuation">.</span>net<span class="token operator">/</span>qq_39821101<span class="token operator">/</span>article<span class="token operator">/</span>details<span class="token operator">/</span><span class="token number">116092190</span>

<span class="token number">3</span>、卸载cudnn
查询：
sudo dpkg <span class="token operator">-</span>l <span class="token operator">|</span> grep cudnn
将其全部卸载：
sudo dpkg <span class="token operator">-</span>r libcudnn8<span class="token operator">-</span>samples
sudo dpkg <span class="token operator">-</span>r libcudnn8<span class="token operator">-</span>dev
sudo dpkg <span class="token operator">-</span>r libcudnn8

检查：
输入下面指令后，没有任何输出即卸载成功。
sudo dpkg <span class="token operator">-</span>l <span class="token operator">|</span> grep cudnn
接：https<span class="token punctuation">:</span><span class="token operator">//</span>blog<span class="token punctuation">.</span>csdn<span class="token punctuation">.</span>net<span class="token operator">/</span>Williamcsj<span class="token operator">/</span>article<span class="token operator">/</span>details<span class="token operator">/</span><span class="token number">123514435</span>

</code></pre> 
<h2><a id="CPU_1413"></a>九、显卡信息命令/CPU内存/硬盘</h2> 
<h3><a id="1_1414"></a>1.显卡</h3> 
<p>nvidia-smi<br> nvidia-smi（显示一次当前GPU占用情况）<br> nvidia-smi -l（每秒刷新一次并显示）<br> watch -n 5 nvidia-smi （其中，5表示每隔6秒刷新一次终端的显示结果）</p> 
<p>表头释义：<br> Fan：显示风扇转速，数值在0到100%之间，是计算机的期望转速，如果计算机不是通过风扇冷却或者风扇坏了，显示出来就是N/A；<br> Temp：显卡内部的温度，单位是摄氏度；<br> Perf：表征性能状态，从P0到P12，P0表示最大性能，P12表示状态最小性能；<br> Pwr：能耗表示；<br> Bus-Id：涉及GPU总线的相关信息；<br> Disp.A：是Display Active的意思，表示GPU的显示是否初始化；<br> Memory Usage：显存的使用率；<br> Volatile GPU-Util：浮动的GPU利用率；<br> Compute M：计算模式；<br> 下边的Processes显示每块GPU上每个进程所使用的显存情况。<br> <img src="https://images2.imgbox.com/34/e9/gLqFLtqG_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/44/e7/EhzJqvAV_o.png" alt="在这里插入图片描述"></p> 
<p>GPU：编号<br> Fan：风扇转速，在0到100%之间变动，这里是42%<br> Name：显卡名，这里是TITAN X<br> Temp：显卡温度，这里是69摄氏度<br> Perf：性能状态，从P0到P12，P0性能最大，P12最小<br> Persistence-M：持续模式的状态开关，该模式耗能大，但是启动新GPU应用时比较快，这里是off<br> Pwr：能耗<br> Bus-Id：涉及GPU总线的东西<br> Disp.A：表示GPU的显示是否初始化<br> Memory-Usage：现存使用率，这里已经快满了<br> GPU-Util：GPU利用率<br> Compute M.：计算模式</p> 
<p>参考查看Linux服务器内存、CPU、显卡、硬盘使用情况，链接：https://www.jianshu.com/p/0aed4feba213<br> https://www.cnblogs.com/wsnan/p/11769838.html</p> 
<ul><li>CUDA版本<br> 1.查看当前安装的版本（nvcc -V）<br> 系统自带：通过nvcc(NVIDIA Cuda compiler driver)命令可查看本机安装的CUDA版本:nvcc -V<br> nvcc -V查看的是系统自带的cuda的版本。<br> 虚拟环境中：要看虚拟环境中的版本，查看pip包或者要导入pytorch和tensorflow库进行测试 <code>pytorch中：print(torch.__version__)和tensorflow中：conda list | grep cuda直接在终端里，打开相应环境，进行查看</code><br> 2.查看能支持的最高CUDA版本（nvidia-smi）<br> 通过nvidia-smi 命令可查看本机的Nvidia显卡驱动信息，以及该驱动支持的最高的CUDA版本。nvidia-smi，例如下面的CUDA Version就是我的电脑上面能够安装的最高版本的CUDA，并且该版本号是向下支持的，可以安装低于该版本号的所有CUDA套件</li></ul> 
<p>释放显卡内存<br> 在Ubuntu运行代码的时候，有时会出现代码退出了，显存依然在占用的情况。</p> 
<pre><code class="prism language-python"><span class="token number">1</span>、<span class="token comment">#批量清理显卡中残留进程：(批量包含其他信息时不行，要用/dev/nvidia*设置成指定哪个进行批量kill如：/dev/nvidia0)</span>
sudo fuser <span class="token operator">-</span>v <span class="token operator">/</span>dev<span class="token operator">/</span>nvidia<span class="token operator">*</span> <span class="token operator">|</span>awk <span class="token string">'{for(i=1;i&lt;=NF;i++)print "kill -9 " $i;}'</span> <span class="token operator">|</span> sudo sh

<span class="token comment">#或</span>
lsof <span class="token operator">/</span>dev<span class="token operator">/</span>nvidia<span class="token operator">*</span> <span class="token operator">|</span> awk <span class="token string">'{print $2}'</span> <span class="token operator">|</span> xargs <span class="token operator">-</span>I <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> kill <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

<span class="token comment">#或</span>
fuser <span class="token operator">-</span>v <span class="token operator">/</span>dev<span class="token operator">/</span>nvidia<span class="token operator">*</span> <span class="token operator">|</span> awk <span class="token string">'{print $0}'</span> <span class="token operator">|</span>  xargs kill <span class="token operator">-</span><span class="token number">9</span>

<span class="token number">2</span>、手动
apt<span class="token operator">-</span>get install psmisc
<span class="token comment">#查找占用GPU资源的PID</span>
fuser <span class="token operator">-</span>v <span class="token operator">/</span>dev<span class="token operator">/</span>nvidia<span class="token operator">*</span>
<span class="token comment"># 解除显存占用</span>
kill <span class="token operator">-</span><span class="token number">9</span> <span class="token operator">**</span><span class="token operator">*</span><span class="token punctuation">(</span>PID<span class="token punctuation">)</span>  
</code></pre> 
<h3><a id="2CPU_1481"></a>2、CPU内存</h3> 
<ol><li>查看cup使用率、内存<br> （1）top<br> （2）htop<br> $ sudo apt-get install htop<br> $ htop<br> （3）free命令<br> free命令可以显示Linux系统中空闲的、已用的物理内存及swap内存,及被内核使用的buffer。在Linux系统监控的工具中，free命令是最经常使用的命令之一。</li></ol> 
<h3><a id="3_1489"></a>3、硬盘</h3> 
<p>（1）df命令<br> （2）df -h命令，df命令直接执行的效果不好，不能以mb或者gb的形式显示磁盘容量。为了以人性化显示，可以在后面加-h参数，h是human-reading的第一个字母，可以理解为人类能读的格式。<br> （3）查看分区：sudo fdisk -l</p> 
<p>（4）查看目录：du -h --max-depth=1<br> du -h -d 1： 显示当前目录下所有一级子目录的大小<br> du -sh: 显示当前目录的总大小<br> du -h: 显示当前目录下所有子目录的大小，递进到最大深度</p> 
<h3><a id="4_1499"></a>4、查看进程</h3> 
<p>ps命令：可以列出正在运行的进程。</p> 
<pre><code class="prism language-python">ps <span class="token operator">-</span>aux 查看所有进程，每行一个程序（常用）

ps <span class="token operator">-</span>A 查看当前系统所有的进程。（常用）

ps <span class="token operator">-</span>A <span class="token operator">|</span> grep chrome 命令去搜索某个指定进程。（常用）

ps <span class="token operator">-</span>A <span class="token operator">|</span> less  使用less命令对输出进行管道，可以按 q 退出。

执行ps的帮助命令“ps <span class="token operator">-</span><span class="token operator">-</span><span class="token builtin">help</span> a”查看ps命令支持的参数列表
使用ps命令“ps <span class="token operator">-</span>aux <span class="token operator">|</span> less”，查看当前系统正在运行的所有进程
使用ps命令“ps <span class="token operator">-</span>U root <span class="token operator">-</span>u root <span class="token operator">-</span>N”，查看当前系统中非root运行的所有进程
使用ps命令“ps <span class="token operator">-</span>u test”，查看当前系统中test用户运行的所有进程
链接：https<span class="token punctuation">:</span><span class="token operator">//</span>blog<span class="token punctuation">.</span>csdn<span class="token punctuation">.</span>net<span class="token operator">/</span>ITBigGod<span class="token operator">/</span>article<span class="token operator">/</span>details<span class="token operator">/</span><span class="token number">85676559</span>
</code></pre> 
<h3><a id="5_1518"></a>5、释放显存</h3> 
<p>1、程序中释放</p> 
<pre><code class="prism language-python"><span class="token comment">#1、tensorflow、pytorch强制关闭GPU释放显存</span>
<span class="token keyword">from</span> numba <span class="token keyword">import</span> cuda
device <span class="token operator">=</span> cuda<span class="token punctuation">.</span>get_current_device<span class="token punctuation">(</span><span class="token punctuation">)</span>
device<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>
cuda<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">#2、开启进程执行</span>
<span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process

<span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token punctuation">.</span>
    <span class="token punctuation">.</span>
    <span class="token punctuation">.</span>

<span class="token keyword">if</span> __name__<span class="token string">'__main__'</span><span class="token punctuation">:</span> <span class="token comment"># 在windows必须在这句话下面开启多进程</span>
    p <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>train<span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 进程结束后，GPU显存会自动释放</span>
    p <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>train<span class="token punctuation">)</span> <span class="token comment"># 重新训练</span>
    p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token comment">#3、杀死进程</span>
<span class="token keyword">import</span> os
pid <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">set</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>popen<span class="token punctuation">(</span><span class="token string">'fuser -v /dev/nvidia*'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
kill_cmd <span class="token operator">=</span> <span class="token string">'kill -9 '</span> <span class="token operator">+</span> <span class="token string">' '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>pid<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>kill_cmd<span class="token punctuation">)</span>
os<span class="token punctuation">.</span>popen<span class="token punctuation">(</span>kill_cmd<span class="token punctuation">)</span>

<span class="token comment">#4、Pytorch释放</span>
torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>empty_cache<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">del</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span>

</code></pre> 
<p>2、显存信息</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> pynvml
    pynvml<span class="token punctuation">.</span>nvmlInit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    handle <span class="token operator">=</span> pynvml<span class="token punctuation">.</span>nvmlDeviceGetHandleByIndex<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token comment"># 这里的0是GPU id</span>
    meminfo <span class="token operator">=</span> pynvml<span class="token punctuation">.</span>nvmlDeviceGetMemoryInfo<span class="token punctuation">(</span>handle<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'显卡信息：'</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>meminfo<span class="token punctuation">.</span>total <span class="token operator">/</span> <span class="token number">1024</span> <span class="token operator">/</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token comment">#第二块显卡总的显存大小</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>meminfo<span class="token punctuation">.</span>used <span class="token operator">/</span> <span class="token number">1024</span> <span class="token operator">/</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token comment">#这里是字节bytes，所以要想得到以兆M为单位就需要除以1024**2</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>meminfo<span class="token punctuation">.</span>free <span class="token operator">/</span> <span class="token number">1024</span> <span class="token operator">/</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token comment">#第二块显卡剩余显存大小</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>pynvml<span class="token punctuation">.</span>nvmlDeviceGetCount<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#显示有几块GPU</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'显卡信息end'</span><span class="token punctuation">)</span>
    os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">"nvidia-smi"</span><span class="token punctuation">)</span>
</code></pre> 
<h2><a id="_1577"></a>十、文生视频</h2> 
<p>早期研究主要使用基于 GAN 和 VAE 的方法在给定文本描述的情况下自回归地生成视频帧 (参见 Text2Filter 及 TGANs-C)。虽然这些工作为文生视频这一新计算机视觉任务奠定了基础，但它们的应用范围有限，仅限于低分辨率、短距以及视频中目标的运动比较单一、孤立的情况。<br> 受文本 (GPT-3) 和图像 (DALL-E) 中大规模预训练 Transformer 模型的成功启发，文生视频研究的第二波浪潮采用transformer 架构。Phenaki、Make-A-Vide、NUWA、VideoGPT 和 CogVideo 都提出了基于 transformer 的框架，而 TATS 提出了一种混合方法，从而将用于生成图像的 VQGAN 和用于顺序地生成帧的时间敏感 transformer 模块结合起来。<br> 第三波也就是当前这一波文生视频模型浪潮主要以基于扩散的架构为特征。扩散模型在生成多样化、超现实和上下文丰富的图像方面取得了显著成功，这引起了人们对将扩散模型推广到其他领域 (如音频、3D ，最近又拓展到了视频) 的兴趣。这一波模型是由 Video Diffusion Models (VDM) 开创的，它首次将扩散模型推广至视频领域。然后是 MagicVideo 提出了一个在低维隐空间中生成视频剪辑的框架，据其报告，新框架与 VDM 相比在效率上有巨大的提升。另一个值得一提的是 Tune-a-Video，它使用 单文本 - 视频对微调预训练的文生图模型，并允许在保留运动的同时改变视频内容。随后涌现出了越来越多的文生视频扩散模型，包括 Video LDM、Text2Video-Zero、Runway Gen1、Runway Gen2 以及 NUWA-XL。阿里达摩院：Text-to-video-synthesis<br> <img src="https://images2.imgbox.com/57/74/a9XhmRMX_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/eb/8d/vQLNNJjp_o.png" alt="在这里插入图片描述"></p> 
<p>Imagen-Video<br> 1、实现原理：Imagen-Video是在Imagen模型基础上开发的基于文本条件生成视频模型，模型通过多个扩散模型的组合，先根据文本prompt生成初始视频，再逐步提高视频的分辨率和帧数来生成视频。<br> 2、模型优缺点：所生成的视频具有高保真度、可控性和世界知识，支持生成各种艺术风格的各种视频和文本动画，并具有对3D对象理解能力，但级联模型采用的并行训练方式所需要计算资源较高。</p> 
<p>Gen<br> 1、实现原理：Gen模型通过潜在扩散模型学习文本-图像特征，可以根据给定的文本提示或参考图像生成新的视频，或根据原始视频+驱动图像进行视频风格转换等多种任务。<br> 2、模型优缺点：模型在视频渲染和风格转换方面具有较好的表现，生成的视频艺术性和图像结构保持能力较强，因此可以更好地适应模型定制要求，但Gen模型在生成结果的稳定性方面仍然存在局限。</p> 
<p>CogVideo<br> 1、实现原理：CogVideo是基于自回归方法的大规模文本-视频生成模型，将图像生成模型CogView2应用于文本-视频生成实现高效学习，通过预测并不断拼接前一帧的递归方式来生成视频。<br> 2、模型优缺点：模型支持中文prompt，多帧率分层训练的方法能够更好地理解文本-视频的关系，生成的视频看起来更加自然，但由于模型对输入序列长度存在限制。</p> 
<p>参考：<br> https://my.oschina.net/HuggingFace/blog/8796358<br> https://www.analysys.cn/article/detail/20021023</p> 
<h2><a id="_1603"></a>十一、数字人</h2> 
<p>matehuman和ue5数字人效果比较好<br> <img src="https://images2.imgbox.com/73/16/FJMyGj7S_o.png" alt="在这里插入图片描述"></p> 
<p>2D数字人和3D数字人</p> 
<p>方案一：<br> 原文：AI 数字人制作（方案一）_哔哩哔哩_bilibili<br> AI 文字和图片生成数字人(输入一张图片和一段文字即可生成数字人)<br> 《用三个开源项目整合成可以商用的数字人项目》<br> 文本生成语音开源地址：https://github.com/weineng-zhou/text2voice<br> 语音驱动表情和嘴型开源地址：https://github.com/YuanxunLu/LiveSpeechPortraits<br> 动作迁移开源地址：https://github.com/yoyo-nb/Thin-Plate-Spline-Motion-Model</p> 
<p>Text+Image2DigitalPerson （浪子之心科技 卢瑞 ）<br> 1、输入文字 ------ 输入" text-input"<br> 2、将文字转化成语音 ------ 输出 “voice-output”<br> 3、输入------"voice-output"到语音驱动嘴唇及表情<br> 4、用语音驱动嘴唇及表情（ LiveSpeechPortraits） ------ 输出“LiveSpeech-output”<br> 5、输入图片 ------ 输入“image-input”到Thin-Plate-Spline-Motion-Model 进行动作迁移<br> 6、动作迁移后 ------ 输出 “Moton-output”<br> 7、最后将声音和视频合成 ------ 输出 “result”</p> 
<p>备注： 如果要商业，还需要视频融合，超分辨率，界面设计，打包部署等。</p> 
<p>方案二：AI 数字人制作<br> 原文：AI 数字人制作(方案二)_哔哩哔哩_bilibili<br> AI 自制数字人(Wav2Lip-GFPGAN)<br> Wav2Lip代码地址：https://github.com/Rudrabha/Wav2Lip<br> GFPGAN代码地址：https://github.com/TencentARC/GFPGAN<br> Wav2Lip-GFPGAN代码地址：https://github.com/ajay-sainy/Wav2Lip-GFPGAN<br> 2D，2.5D数字人制作我已经出了好几个视频，制作方法也介绍了3个以上，后期将出3D数字人的制作方法视频。</p> 
<p>方案三：AI 数字人制作<br> 原文：AI 数字人制作（方案三）_哔哩哔哩_bilibili<br> AI 图片和语音生成数字人（国产版D_ID）<br> 只需要进行调参就可以平替换DID，效果很好。<br> 来自西安交大和腾讯的SadTalker，CVPR 2023年顶会论文。<br> 开源代码地址：https://github.com/Winfredy/SadTalker<br> 该论文是针对单张图片进行驱动的，涉及到3D人脸重建、wav2lip、face-vid2vid、GFPGAN超分等模块。</p> 
<p>连接：https://blog.csdn.net/javastart/article/details/130651625</p> 
<p>2023的talk系列：<br> StyleTalk清华（说话风格）<br> codetalker（3d）、sadtalker、retalking、wav2lip（基础）</p> 
<p>了解：Talking-Face-Generation系列<br> https://www.zhihu.com/column/c_1626536469543194624</p> 
<h2><a id="_flask_socket_1655"></a>十二、 flask socket</h2> 
<p>1、版本问题<br> 问题解决<br> 根据官方给定的兼容版本，从socket.io官网CDN下载最新的4.4.1版本js文件，https://cdn.socket.io/。<br> python-engineio使用版本。需要更新的javascript.socketio包，具体可对照官方文档Requirements部分末尾<br> https://flask-socketio.readthedocs.io/en/latest/intro.html#requirements<br> 前端加入</p> 
<p><img src="https://images2.imgbox.com/aa/a3/NkBa9mxl_o.png" alt="blog.csdnimg.cn/a93f6fea4779453fbf1ab5d565acf770.png)"></p> 
<pre><code class="prism language-python">
<span class="token number">1</span>、版本<span class="token number">1</span>（低版本推荐）
解决
以我本机为例，运行下列命令

pip3 install <span class="token operator">-</span><span class="token operator">-</span>upgrade Flask<span class="token operator">-</span>SocketIO<span class="token operator">==</span><span class="token number">4.3</span><span class="token number">.1</span>
pip3 install <span class="token operator">-</span><span class="token operator">-</span>upgrade python<span class="token operator">-</span>engineio<span class="token operator">==</span><span class="token number">3.13</span><span class="token number">.2</span>
pip3 install <span class="token operator">-</span><span class="token operator">-</span>upgrade python<span class="token operator">-</span>socketio<span class="token operator">==</span><span class="token number">4.6</span><span class="token number">.0</span>
如果出现
ImportError<span class="token punctuation">:</span> cannot <span class="token keyword">import</span> name ‘run_with_reloader’ <span class="token keyword">from</span> ‘werkzeug<span class="token punctuation">.</span>serving’
或
ImportError<span class="token punctuation">:</span> cannot <span class="token keyword">import</span> name ‘soft_unicode’ <span class="token keyword">from</span> ‘markupsafe’
则运行下面命令
pip3 install <span class="token operator">-</span><span class="token operator">-</span>upgrade flask<span class="token operator">==</span><span class="token number">1.1</span><span class="token number">.4</span>
pip3 install <span class="token operator">-</span><span class="token operator">-</span>upgrade Werkzeug<span class="token operator">==</span><span class="token number">1.0</span><span class="token number">.1</span>
pip3 install <span class="token operator">-</span><span class="token operator">-</span>upgrade itsdangerous<span class="token operator">==</span><span class="token number">1.1</span><span class="token number">.0</span>
pip3 install <span class="token operator">-</span><span class="token operator">-</span>upgrade Jinja2<span class="token operator">==</span><span class="token number">2.11</span><span class="token number">.2</span>
pip3 install <span class="token operator">-</span><span class="token operator">-</span>upgrade MarkupSafe<span class="token operator">==</span><span class="token number">2.0</span><span class="token number">.1</span>
参考链接：https<span class="token punctuation">:</span><span class="token operator">//</span>blog<span class="token punctuation">.</span>csdn<span class="token punctuation">.</span>net<span class="token operator">/</span>xiru9972<span class="token operator">/</span>article<span class="token operator">/</span>details<span class="token operator">/</span><span class="token number">125127955</span>

bidict<span class="token operator">==</span><span class="token number">0.22</span><span class="token number">.1</span>
blinker<span class="token operator">==</span><span class="token number">1.6</span><span class="token number">.2</span>
cachelib<span class="token operator">==</span><span class="token number">0.10</span><span class="token number">.2</span>
cffi<span class="token operator">==</span><span class="token number">1.15</span><span class="token number">.1</span>
click<span class="token operator">==</span><span class="token number">7.1</span><span class="token number">.2</span>
colorama<span class="token operator">==</span><span class="token number">0.4</span><span class="token number">.6</span>
coverage<span class="token operator">==</span><span class="token number">7.2</span><span class="token number">.7</span>
dnspython<span class="token operator">==</span><span class="token number">2.3</span><span class="token number">.0</span>
eventlet<span class="token operator">==</span><span class="token number">0.33</span><span class="token number">.3</span>
Flask<span class="token operator">==</span><span class="token number">1.1</span><span class="token number">.4</span>
Flask<span class="token operator">-</span>Cors<span class="token operator">==</span><span class="token number">3.0</span><span class="token number">.10</span>
Flask<span class="token operator">-</span>SocketIO<span class="token operator">==</span><span class="token number">5.2</span><span class="token number">.0</span>
gevent<span class="token operator">==</span><span class="token number">22.10</span><span class="token number">.2</span>
gevent<span class="token operator">-</span>websocket<span class="token operator">==</span><span class="token number">0.10</span><span class="token number">.1</span>
greenlet<span class="token operator">==</span><span class="token number">2.0</span><span class="token number">.2</span>
h11<span class="token operator">==</span><span class="token number">0.14</span><span class="token number">.0</span>
itsdangerous<span class="token operator">==</span><span class="token number">1.1</span><span class="token number">.0</span>
Jinja2<span class="token operator">==</span><span class="token number">2.11</span><span class="token number">.2</span>
MarkupSafe<span class="token operator">==</span><span class="token number">2.0</span><span class="token number">.1</span>
pycparser<span class="token operator">==</span><span class="token number">2.21</span>
python<span class="token operator">-</span>engineio<span class="token operator">==</span><span class="token number">4.4</span><span class="token number">.1</span>
python<span class="token operator">-</span>socketio<span class="token operator">==</span><span class="token number">5.8</span><span class="token number">.0</span>
simple<span class="token operator">-</span>websocket<span class="token operator">==</span><span class="token number">0.10</span><span class="token number">.1</span>
six<span class="token operator">==</span><span class="token number">1.16</span><span class="token number">.0</span>
websocket<span class="token operator">==</span><span class="token number">0.2</span><span class="token number">.1</span>
Werkzeug<span class="token operator">==</span><span class="token number">1.0</span><span class="token number">.1</span>
wsproto<span class="token operator">==</span><span class="token number">1.2</span><span class="token number">.0</span>
zope<span class="token punctuation">.</span>event<span class="token operator">==</span><span class="token number">4.6</span>
zope<span class="token punctuation">.</span>interface<span class="token operator">==</span><span class="token number">6.0</span>




前端：

    <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">"https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"</span> integrity<span class="token operator">=</span><span class="token string">"sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg=="</span> crossorigin<span class="token operator">=</span><span class="token string">"anonymous"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
    
    <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">"https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.4/socket.io.js"</span> integrity<span class="token operator">=</span><span class="token string">"sha512-aMGMvNYu8Ue4G+fHa359jcPb1u+ytAF+P2SCb+PxrjCdO3n3ZTxJ30zuH39rimUggmTwmh2u7wvQsDTHESnmfQ=="</span> crossorigin<span class="token operator">=</span><span class="token string">"anonymous"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>



<span class="token number">2</span>、版本<span class="token number">2</span>
Flask<span class="token operator">==</span><span class="token number">2.2</span><span class="token number">.2</span>
Flask<span class="token operator">-</span>SocketIO<span class="token operator">==</span><span class="token number">5.2</span><span class="token number">.0</span>
MarkupSafe<span class="token operator">==</span><span class="token number">2.1</span><span class="token number">.1</span>
Werkzeug<span class="token operator">==</span><span class="token number">2.2</span><span class="token number">.2</span>

pip install simple<span class="token operator">-</span>websocket
前端：
 <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">"https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"</span> integrity<span class="token operator">=</span><span class="token string">"sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg=="</span> crossorigin<span class="token operator">=</span><span class="token string">"anonymous"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">"https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.4/socket.io.js"</span> integrity<span class="token operator">=</span><span class="token string">"sha512-aMGMvNYu8Ue4G+fHa359jcPb1u+ytAF+P2SCb+PxrjCdO3n3ZTxJ30zuH39rimUggmTwmh2u7wvQsDTHESnmfQ=="</span> crossorigin<span class="token operator">=</span><span class="token string">"anonymous"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>



<span class="token number">3</span>、版本<span class="token number">3</span>
Flask<span class="token operator">-</span>SocketIO<span class="token operator">==</span><span class="token number">4.3</span><span class="token number">.1</span>
python<span class="token operator">-</span>engineio<span class="token operator">==</span><span class="token number">3.13</span><span class="token number">.2</span>
python<span class="token operator">-</span>socketio<span class="token operator">==</span><span class="token number">4.6</span><span class="token number">.0</span>
Flask<span class="token operator">==</span><span class="token number">2.0</span><span class="token number">.3</span>
Werkzeug<span class="token operator">==</span><span class="token number">2.0</span><span class="token number">.3</span>

pip install  gevent<span class="token operator">-</span>websocket gevent eventlet
前端
<span class="token operator">&lt;</span>script <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"text/javascript"</span> src<span class="token operator">=</span><span class="token string">"//code.jquery.com/jquery-1.4.2.min.js"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>script <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"text/javascript"</span> src<span class="token operator">=</span><span class="token string">"//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.5/socket.io.min.js"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>

bidict<span class="token operator">==</span><span class="token number">0.22</span><span class="token number">.1</span>
blinker<span class="token operator">==</span><span class="token number">1.6</span><span class="token number">.2</span>
cffi<span class="token operator">==</span><span class="token number">1.15</span><span class="token number">.1</span>
click<span class="token operator">==</span><span class="token number">8.1</span><span class="token number">.3</span>
colorama @ <span class="token builtin">file</span><span class="token punctuation">:</span><span class="token operator">//</span><span class="token operator">/</span>C<span class="token punctuation">:</span><span class="token operator">/</span>b<span class="token operator">/</span>abs_a9ozq0l032<span class="token operator">/</span>croot<span class="token operator">/</span>colorama_1672387194846<span class="token operator">/</span>work
coverage<span class="token operator">==</span><span class="token number">7.2</span><span class="token number">.7</span>
dnspython<span class="token operator">==</span><span class="token number">2.3</span><span class="token number">.0</span>
eventlet<span class="token operator">==</span><span class="token number">0.33</span><span class="token number">.3</span>
Flask<span class="token operator">==</span><span class="token number">2.0</span><span class="token number">.3</span>
Flask<span class="token operator">-</span>Cors<span class="token operator">==</span><span class="token number">3.0</span><span class="token number">.10</span>
Flask<span class="token operator">-</span>SocketIO<span class="token operator">==</span><span class="token number">4.3</span><span class="token number">.1</span>
gevent<span class="token operator">==</span><span class="token number">22.10</span><span class="token number">.2</span>
gevent<span class="token operator">-</span>websocket<span class="token operator">==</span><span class="token number">0.10</span><span class="token number">.1</span>
greenlet<span class="token operator">==</span><span class="token number">2.0</span><span class="token number">.2</span>
h<span class="token operator">==</span><span class="token number">0.99</span>
h11<span class="token operator">==</span><span class="token number">0.14</span><span class="token number">.0</span>
itsdangerous<span class="token operator">==</span><span class="token number">2.1</span><span class="token number">.2</span>
Jinja2 @ <span class="token builtin">file</span><span class="token punctuation">:</span><span class="token operator">//</span><span class="token operator">/</span>C<span class="token punctuation">:</span><span class="token operator">/</span>b<span class="token operator">/</span>abs_7cdis66kl9<span class="token operator">/</span>croot<span class="token operator">/</span>jinja2_1666908141852<span class="token operator">/</span>work
MarkupSafe @ <span class="token builtin">file</span><span class="token punctuation">:</span><span class="token operator">//</span><span class="token operator">/</span>C<span class="token punctuation">:</span><span class="token operator">/</span>ci<span class="token operator">/</span>markupsafe_1654508036328<span class="token operator">/</span>work
pycparser<span class="token operator">==</span><span class="token number">2.21</span>
python<span class="token operator">-</span>engineio<span class="token operator">==</span><span class="token number">3.13</span><span class="token number">.2</span>
python<span class="token operator">-</span>socketio<span class="token operator">==</span><span class="token number">4.6</span><span class="token number">.0</span>
simple<span class="token operator">-</span>websocket<span class="token operator">==</span><span class="token number">0.10</span><span class="token number">.1</span>
six<span class="token operator">==</span><span class="token number">1.16</span><span class="token number">.0</span>
Werkzeug<span class="token operator">==</span><span class="token number">2.0</span><span class="token number">.3</span>
wsproto<span class="token operator">==</span><span class="token number">1.2</span><span class="token number">.0</span>
zope<span class="token punctuation">.</span>event<span class="token operator">==</span><span class="token number">4.6</span>
zope<span class="token punctuation">.</span>interface<span class="token operator">==</span><span class="token number">6.0</span>



</code></pre> 
<p>2、跨域问题<br> 在实例化SocketIO时，加上 cors_allowed_origins="<em>"<br> #解决跨域问题<br> socketio.init_app(app, cors_allowed_origins='</em>')</p> 
<h2><a id="_video_Super_Resolution_1791"></a>十三、图像超分辨率模型（ video Super Resolution）</h2> 
<p>传统CNN<br> 从SRCNN到EDSR</p> 
<p>现在gan<br> SRGAN<br> ESRGAN<br> Real ESRGAN</p> 
<p>EGVSR<br> Real-ESRGAN：一种用于一般图像恢复的实用算法<br> GFPGAN：一种用于真实人脸修复的实用算法</p> 
<p>Real-ESRGAN是腾讯ARC实验室发表超分辨率算法</p> 
<p>基于ESPCN提出了针对视频重建任务的网络结构VESPCN</p> 
<p>Final2x：RealCUGAN, RealESRGAN, Waifu2x, and SRMD.</p> 
<p>视频超分：对齐、融合、特征提取、重建，EDVR、BasicVSR、BasicVSR++、RealBasicVSR</p> 
<p>视频修复：GFPGAN人脸、Real-ESRGAN图像/视频修复算法、人脸的清晰化算法：codeFormer，GPEN，GFPGAN</p> 
<p>CVPR 2023 | 南洋理工、商汤提出E3DGE：2D图片秒出3D形象<br> https://blog.csdn.net/qq_28941587/article/details/128553869?ydreferer=aHR0cHM6Ly93d3cuYmluZy5jb20v</p> 
<p>使用推荐：<br> codeFormer，GPEN，GFPGAN（对比，codeFormer和真实的比较像）<br> 1、GFPGAN：能修复人脸，包含Real-ESRGAN算法可以设置超分<br> 2、 Final2x：RealCUGAN, RealESRGAN, Waifu2x, and SRMD.这些超分效果都可以<br> 3、BasicVSR：处理慢，会出现胡快，分辨大小不能设置，只能找对应模型，效果4k的感觉还可以。（不推荐）</p> 
<h2><a id="GUI_1829"></a>十四、GUI</h2> 
<p>1、什么是CLI（命令行界面）、GUI(图形用户界面)、Terminal(终端)、Console（控制台）、Shell、TTY https://blog.csdn.net/csdn100861/article/details/116414786</p> 
<p>2、Windows/Linux 通过 ssh 打开 远程服务器 GUI程序（ssh远程显示gui）<br> 背景<br> 在 Windows + ssh(Cygwin) + Linux(运行在虚拟机中的Ubuntu) 是一个很舒服的方案，但是偶尔需要用到 图形界面。<br> 如果需要通过ssh打开远程服务器端的程序，需要X11 forwarding。否则，会显示：<br> 经过搜索，我找到了有关的解决方案，这个方案适用于：<br> Cygwin<br> MobaXterm<br> Putty<br> 从Linux连接到Linux<br> https://www.cnblogs.com/schips/p/12563373.html</p> 
<p>3、Xserver<br> 由于X server是监听在本地的，ssh服务端的远程client想连回本地必须使用remote tunnel，X11 forwarding则可以方便的将X11协议转发到远程主机。转发过程中会自动设置DISPLAY环境变量和Xauth授权信息。<br> https://www.jianshu.com/p/e6b45bb9c2e9</p> 
<p>4、Window下，使用Putty+Xming的方式实现X界面的接收。<br>  1.安装Putty和Xming<br>  2.配置Xming<br> 第一次运行Xming，使用开始菜单里面的XLaunch来启动，产生一个初始的配置文件。对于简单的使用来说，不需要任何特殊的配置，一切使用默认即可。Xming的具体配置和使用可以参考Xming的Manual。需要记住的是下图中标示出的“Display number”中的数字，此处使用默认的0。<br> https://www.jianshu.com/p/9279b2ed8821<br> https://blog.csdn.net/xxradon/article/details/86636340</p> 
<h2><a id="_1855"></a>十五、调试</h2> 
<p>参考：https://blog.csdn.net/jackailson/article/details/101129057</p> 
<p>1、 .env文件环境变量文件<br> 项目开发过程中，需要把 .env文件的内容导入到系统环境变量中，以方便程序调用。在 Python 中，可以使用 dotenv 库来读取 .env 文件中的环境变量。该库提供了两个主要的函数：load_dotenv() 和 dotenv_values()。</p> 
<p>2、编辑launch.json：将预定义的配置替换为以下内容：</p> 
<pre><code class="prism language-python"><span class="token punctuation">{<!-- --></span>
    <span class="token operator">//</span> 使用 IntelliSense 了解相关属性。 
    <span class="token operator">//</span> 悬停以查看现有属性的描述。
    <span class="token operator">//</span> 欲了解更多信息，请访问<span class="token punctuation">:</span> https<span class="token punctuation">:</span><span class="token operator">//</span>go<span class="token punctuation">.</span>microsoft<span class="token punctuation">.</span>com<span class="token operator">/</span>fwlink<span class="token operator">/</span>?linkid<span class="token operator">=</span><span class="token number">830387</span>
    <span class="token string">"version"</span><span class="token punctuation">:</span> <span class="token string">"0.2.0"</span><span class="token punctuation">,</span>
    <span class="token string">"configurations"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Python: 当前文件"</span><span class="token punctuation">,</span>
            <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"python"</span><span class="token punctuation">,</span>
            <span class="token string">"request"</span><span class="token punctuation">:</span> <span class="token string">"launch"</span><span class="token punctuation">,</span>
            <span class="token string">"program"</span><span class="token punctuation">:</span> <span class="token string">"${file}"</span><span class="token punctuation">,</span>
            <span class="token string">"console"</span><span class="token punctuation">:</span> <span class="token string">"integratedTerminal"</span><span class="token punctuation">,</span>
            <span class="token string">"justMyCode"</span><span class="token punctuation">:</span> true<span class="token punctuation">,</span>
            <span class="token string">"python"</span><span class="token punctuation">:</span> <span class="token string">"/root/autodl-tmp/conda/envs/webui/bin/python3"</span><span class="token punctuation">,</span>
            <span class="token string">"args"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                
                <span class="token operator">//</span> <span class="token string">"--train_dir"</span><span class="token punctuation">,</span> <span class="token string">"./input/train_data"</span><span class="token punctuation">,</span>   <span class="token operator">//</span> 命令行参数
                <span class="token operator">//</span> <span class="token string">"--dev_dir"</span><span class="token punctuation">,</span> <span class="token string">"./input/valid_data"</span><span class="token punctuation">,</span>

                <span class="token string">"--share"</span><span class="token punctuation">,</span>
                 <span class="token string">"--xformers"</span><span class="token punctuation">,</span>
                   <span class="token string">"--port"</span><span class="token punctuation">,</span> <span class="token string">"6006"</span><span class="token punctuation">,</span>
                    <span class="token string">"--nowebui"</span>
 
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-py"><span class="token punctuation">{<!-- --></span>
    <span class="token string">"version"</span><span class="token punctuation">:</span> <span class="token string">"0.2.0"</span><span class="token punctuation">,</span>
    <span class="token string">"configurations"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Python: Run My Module"</span><span class="token punctuation">,</span> <span class="token operator">//</span> 配置名称，将在调试配置下拉列表中显示
            <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"python"</span><span class="token punctuation">,</span> <span class="token operator">//</span> 调试类型，这里是Python
            <span class="token string">"request"</span><span class="token punctuation">:</span> <span class="token string">"launch"</span><span class="token punctuation">,</span> <span class="token operator">//</span> 请求类型，这里选择“launch”表示启动调试
            <span class="token string">"module"</span><span class="token punctuation">:</span> <span class="token string">"my_module"</span><span class="token punctuation">,</span> <span class="token operator">//</span> 要执行的Python模块名称，请替换为实际的模块名称
            <span class="token string">"cwd"</span><span class="token punctuation">:</span> <span class="token string">"${workspaceFolder}"</span><span class="token punctuation">,</span> <span class="token operator">//</span> 当前工作目录设置为项目文件夹
            <span class="token string">"console"</span><span class="token punctuation">:</span> <span class="token string">"integratedTerminal"</span><span class="token punctuation">,</span> <span class="token operator">//</span> 使用VSCode的集成终端显示输出
            <span class="token string">"args"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">//</span> 如果需要传递命令行参数，可以在这个列表中添加
            <span class="token string">"pythonPath"</span><span class="token punctuation">:</span> <span class="token string">"${config:python.pythonPath}"</span><span class="token punctuation">,</span> <span class="token operator">//</span> 指定Python解释器的路径
            <span class="token string">"env"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">//</span> 环境变量字典，可以在这里添加自定义环境变量
            <span class="token string">"envFile"</span><span class="token punctuation">:</span> <span class="token string">"${workspaceFolder}/.env"</span><span class="token punctuation">,</span> <span class="token operator">//</span> 如果需要从文件加载环境变量，可以指定<span class="token punctuation">.</span>env文件的路径
            <span class="token string">"stopOnEntry"</span><span class="token punctuation">:</span> false<span class="token punctuation">,</span> <span class="token operator">//</span> 是否在程序启动时立即暂停，以便在第一行代码之前设置断点
            <span class="token string">"showReturnValue"</span><span class="token punctuation">:</span> true<span class="token punctuation">,</span> <span class="token operator">//</span> 是否在调试过程中显示函数的返回值
            <span class="token string">"redirectOutput"</span><span class="token punctuation">:</span> true <span class="token operator">//</span> 是否将程序输出重定向到调试控制台，而不是终端
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
链接：https<span class="token punctuation">:</span><span class="token operator">//</span>blog<span class="token punctuation">.</span>csdn<span class="token punctuation">.</span>net<span class="token operator">/</span>qq_41236493<span class="token operator">/</span>article<span class="token operator">/</span>details<span class="token operator">/</span><span class="token number">130430899</span>
</code></pre> 
<pre><code class="prism language-py"><span class="token punctuation">{<!-- --></span>
  <span class="token operator">//</span> Use IntelliSense to learn about possible attributes<span class="token punctuation">.</span>
  <span class="token operator">//</span> Hover to view descriptions of existing attributes<span class="token punctuation">.</span>
  <span class="token operator">//</span> For more information<span class="token punctuation">,</span> visit<span class="token punctuation">:</span> https<span class="token punctuation">:</span><span class="token operator">//</span>go<span class="token punctuation">.</span>microsoft<span class="token punctuation">.</span>com<span class="token operator">/</span>fwlink<span class="token operator">/</span>?linkid<span class="token operator">=</span><span class="token number">830387</span>
  <span class="token string">"version"</span><span class="token punctuation">:</span> <span class="token string">"0.2.0"</span><span class="token punctuation">,</span>
  <span class="token string">"configurations"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{<!-- --></span>
          <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Python"</span><span class="token punctuation">,</span>
          <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"python"</span><span class="token punctuation">,</span>
          <span class="token string">"request"</span><span class="token punctuation">:</span> <span class="token string">"launch"</span><span class="token punctuation">,</span>
          <span class="token string">"stopOnEntry"</span><span class="token punctuation">:</span> false<span class="token punctuation">,</span>
          <span class="token string">"pythonPath"</span><span class="token punctuation">:</span> <span class="token string">"C:\\Users\\hetao\\anaconda3\\python.exe"</span><span class="token punctuation">,</span>
          <span class="token string">"program"</span><span class="token punctuation">:</span> <span class="token string">"${file}"</span><span class="token punctuation">,</span>
          <span class="token string">"cwd"</span><span class="token punctuation">:</span> <span class="token string">"${workspaceRoot}"</span><span class="token punctuation">,</span>
          <span class="token string">"env"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token string">"envFile"</span><span class="token punctuation">:</span> <span class="token string">"${workspaceRoot}/.env"</span><span class="token punctuation">,</span>
          <span class="token string">"debugOptions"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
              <span class="token string">"WaitOnAbnormalExit"</span><span class="token punctuation">,</span>
              <span class="token string">"WaitOnNormalExit"</span><span class="token punctuation">,</span>
              <span class="token string">"RedirectOutput"</span>
          <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>3、setting.json<br> ，在setting.json里加上：“python.envFile”: “${workspaceFolder}/.vscode/.env”，如：</p> 
<p>{<!-- --><br> “python.pythonPath”: “/path/python.exe”,<br> “python.envFile”: “${workspaceFolder}/.vscode/.env”<br> }</p> 
<p>“cwd”: "${fileDirname}"代码路径</p> 
<p>4、setting.json和launch.json<br> 感觉两者差补多,选择一个可以，launch.json一般配置调试，setting设置运行</p> 
<p>在vscode中配置Setting.json添加Python路径</p> 
<pre><code class="prism language-py">  <span class="token string">"python.pythonPath"</span><span class="token punctuation">:</span> <span class="token string">"D:\\Anaconda3\\envs\\py37_32\\python.exe"</span><span class="token punctuation">,</span>
  <span class="token string">"python.autoComplete.addBrackets"</span><span class="token punctuation">:</span> true<span class="token punctuation">,</span>
  <span class="token operator">//</span>忽略pylint检查代码时，出现无谓的波浪线的问题
  <span class="token string">"python.linting.pylintArgs"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token string">"--disable=W,C"</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
</code></pre> 
<p>在vscode中配置launch.json添加Python路径</p> 
<pre><code class="prism language-py"><span class="token punctuation">{<!-- --></span>
    <span class="token operator">//</span> 使用 IntelliSense 了解相关属性。 
    <span class="token operator">//</span> 悬停以查看现有属性的描述。
    <span class="token operator">//</span> 欲了解更多信息，请访问<span class="token punctuation">:</span> https<span class="token punctuation">:</span><span class="token operator">//</span>go<span class="token punctuation">.</span>microsoft<span class="token punctuation">.</span>com<span class="token operator">/</span>fwlink<span class="token operator">/</span>?linkid<span class="token operator">=</span><span class="token number">830387</span>
    <span class="token string">"version"</span><span class="token punctuation">:</span> <span class="token string">"0.2.0"</span><span class="token punctuation">,</span>
    <span class="token string">"configurations"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        
        <span class="token punctuation">{<!-- --></span>
            <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Python: 当前文件"</span><span class="token punctuation">,</span>
            <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"python"</span><span class="token punctuation">,</span>
            <span class="token string">"request"</span><span class="token punctuation">:</span> <span class="token string">"launch"</span><span class="token punctuation">,</span>
            <span class="token string">"program"</span><span class="token punctuation">:</span> <span class="token string">"${file}"</span><span class="token punctuation">,</span>
            <span class="token string">"console"</span><span class="token punctuation">:</span> <span class="token string">"integratedTerminal"</span><span class="token punctuation">,</span>
            <span class="token string">"justMyCode"</span><span class="token punctuation">:</span> true<span class="token punctuation">,</span>

            <span class="token string">"stopOnEntry"</span><span class="token punctuation">:</span> false<span class="token punctuation">,</span>
            <span class="token string">"python"</span><span class="token punctuation">:</span> <span class="token string">"D:/Program Files (x86)/Anoconda/envs/demo2/python.exe"</span><span class="token punctuation">,</span>

            <span class="token operator">//</span>不生效，是在setting<span class="token punctuation">.</span>json中设置的
            <span class="token operator">//</span> <span class="token string">"python.pythonPath"</span><span class="token punctuation">:</span> <span class="token string">"D:/Program Files (x86)/Anoconda/envs/demo2/python.exe"</span><span class="token punctuation">,</span>
            <span class="token operator">//</span> <span class="token string">"python.autoComplete.addBrackets"</span><span class="token punctuation">:</span> true<span class="token punctuation">,</span>
            <span class="token operator">//</span> <span class="token operator">//</span>忽略pylint检查代码时，出现无谓的波浪线的问题
            <span class="token operator">//</span> <span class="token string">"python.linting.pylintArgs"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token operator">//</span>   <span class="token string">"--disable=W,C"</span>
            <span class="token operator">//</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
          

        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>5、</p> 
<h2><a id="ftp_2008"></a>十六、ftp</h2> 
<p>参考链接：https://blog.csdn.net/qq_42992084/article/details/127717675</p> 
<h3><a id="1_2010"></a>1、安装启动状态</h3> 
<p>安装<br> 安装 FTP服务，命令行输入：<br> sudo apt-get install vsftpd</p> 
<p>重新加载配置文件<br> sudo /etc/init.d/vsftpd restart<br> 在加载完后，重启服务器：<br> sudo systemctl restart vsftpd<br> 查看服务启动状态：<br> sudo systemctl status vsftpd</p> 
<p>设置开机启动：<br> sudo systemctl enable vsftpd<br> 如果想关闭开机启动：<br> sudo systemctl disable vsftpd</p> 
<h3><a id="2_2028"></a>2、配置</h3> 
<p>先备份配置文件：<br> sudo cp /etc/vsftpd.conf /etc/vsftpd.conf.back<br> vim进入编辑信息：<br> sudo vim /etc/vsftpd.conf</p> 
<p>本地用户：anonymous_enable<br> 匿名用户：local_enable<br> 受限用户：chroot_list_enable<br> 参考：https://www.cnblogs.com/linuxws/p/11006293.html<br> https://blog.csdn.net/weixin_43759606/article/details/113582776</p> 
<pre><code class="prism language-html">1.匿名用户相关设置

anonymous_enable=YES              ,将YES改为NO, 禁止匿名用户登陆

#non_mkdir_write_enable=YES        ,将#注释去掉，允许匿名用户创建目录

#non_upload_enalbe=YES             ,将#去掉，允许匿名用户上传

anon_world_readable_only=YES       ,允许匿名用户下载，默认是禁止的，这个可以自行添加。

Anon_other_write_enable=YES        ,将其设为YES的话，就除了上传和创建目录外，还可以重命名，删除文件，默认是NO

no_anon_password=NO               ,将其设为YES,匿名用户不会查询用户密码直接登陆。

ftp_username=ftp                    ,匿名用户登陆系统的账号默认为ftp,此项最好不要改，否则设置不当会给系统的安全带来威胁。

2.FTP服务端口的指定

listen_port=8021                     ,指定命令通道为8021,默认为21

listen_data_port=8020                ,指定数据通道为8020,默认为20

3.上传模式的设置

pasv_enable=YES                    ,是否允使用被动模式，默认是允许的。

pasv_min_port=10000                 ，指定使用被动模式时打开端口的最小值

pasv_max_port=10004                ，指定使用被动模式时打开端口的最大值。

4.Vsftp服务器指定IP地址

listen_address=192.168.0.21           ，指定FTP，IP地址

注：只有当vsftp运行于独立模式时才允许使用指定IP,如果在/etc/xinetd.d目录下已经建立了vsfpd文件，就要将该文件中的disable设置为yes，方可。

5. 锁定用户，禁止用户离开用户主目录

chroot_local_user=YES               ,将其设为YES，就锁定在用户主目录，设为NO，可以切换

将指定用户设置为锁定用户主目录:

#chroot_list_enable=YES

#chroot_list_file=/etc/vsftpd.chroot_list

将其改为如下:

chroot_list_enable=NO

chroot_list_file=/etc/vsftpd/vsftpd.chroot_list

将上面保存，再做如下操作：

#touch /etc/vsftpd/vsftpd.chroot_list

#vi /etc/vsftpd/vsftpd.chroot_list   ,在该文件中加入用户名单，如：

netseek_com

6.FTP服务器的流量控制

max_clients=100             ;允许的最大连接数，定义为100，默认为0，表没有限制

max_per_ip=5               ;每个IP允许的连接数，0表没有限制，需要运行于独立模式方可

anon_max_rate=50000        ;匿名用户最大带宽，单位为bps

local_max_rate=200000       ;系统用户最大带宽

如何对指定用户进行流量限制呢？

#vi /etc/vsftpd/vsftpd.conf,添加一行：

user_config_dir=/etc/vsftpd/userconf

#touch /etc/vsftpd/userconf/netseek_com  为netseek_com这个用户建立一个netseek_com文件

#vi /etc/vsftpd/userconf/netseek_com  添加以下内容

local_max_rate=100000            

保存重启服务即可.

7.定制欢迎信息

  目录说明设置

  #vi /etc/vsftpd/vsftpd.conf

#dirmessage_enable=YES,前的#去掉。

然后我们定制一个.message,写上你想写的东西，然后把这个文件复制到各个用户的家目录中,就OK。

系统欢迎消息设置

ftpd_banner=Welcome to ftp.netseek.com , Yeah!!!

系统欢迎消息文件设置

banner_file=/etc/vsftpd/welcome   与ftpd_banner相类似，不同之处在于，banner_file指定欢迎文件.
</code></pre> 
<pre><code class="prism language-python"><span class="token comment"># Example config file /etc/vsftpd.conf</span>
<span class="token comment">#</span>
<span class="token comment"># The default compiled in settings are fairly paranoid. This sample file</span>
<span class="token comment"># loosens things up a bit, to make the ftp daemon more usable.</span>
<span class="token comment"># Please see vsftpd.conf.5 for all compiled in defaults.</span>
<span class="token comment">#</span>
<span class="token comment"># READ THIS: This example file is NOT an exhaustive list of vsftpd options.</span>
<span class="token comment"># Please read the vsftpd.conf.5 manual page to get a full idea of vsftpd's</span>
<span class="token comment"># capabilities.</span>
<span class="token comment">#</span>
<span class="token comment">#</span>
<span class="token comment"># Run standalone?  vsftpd can run either from an inetd or as a standalone</span>
<span class="token comment"># daemon started from an initscript.</span>
listen<span class="token operator">=</span>NO
<span class="token comment">#</span>
<span class="token comment"># This directive enables listening on IPv6 sockets. By default, listening</span>
<span class="token comment"># on the IPv6 "any" address (::) will accept connections from both IPv6</span>
<span class="token comment"># and IPv4 clients. It is not necessary to listen on *both* IPv4 and IPv6</span>
<span class="token comment"># sockets. If you want that (perhaps because you want to listen on specific</span>
<span class="token comment"># addresses) then you must run two copies of vsftpd with two configuration</span>
<span class="token comment"># files.</span>
listen_ipv6<span class="token operator">=</span>YES
<span class="token comment">#</span>
<span class="token comment"># Allow anonymous FTP? (Disabled by default).</span>
anonymous_enable<span class="token operator">=</span>NO
<span class="token comment">#</span>
<span class="token comment"># Uncomment this to allow local users to log in.</span>
local_enable<span class="token operator">=</span>YES
<span class="token comment">#</span>
<span class="token comment"># Uncomment this to enable any form of FTP write command.</span>
write_enable<span class="token operator">=</span>YES
<span class="token comment">#</span>
<span class="token comment"># Default umask for local users is 077. You may wish to change this to 022,</span>
<span class="token comment"># if your users expect that (022 is used by most other ftpd's)</span>
local_umask<span class="token operator">=</span><span class="token number">022</span>
<span class="token comment">#</span>
<span class="token comment"># Uncomment this to allow the anonymous FTP user to upload files. This only</span>
<span class="token comment"># has an effect if the above global write enable is activated. Also, you will</span>
<span class="token comment"># obviously need to create a directory writable by the FTP user.</span>
anon_upload_enable<span class="token operator">=</span>YES
<span class="token comment">#</span>
<span class="token comment"># Uncomment this if you want the anonymous FTP user to be able to create</span>
<span class="token comment"># new directories.</span>
anon_mkdir_write_enable<span class="token operator">=</span>YES
<span class="token comment">#</span>
<span class="token comment"># Activate directory messages - messages given to remote users when they</span>
<span class="token comment"># go into a certain directory.</span>
dirmessage_enable<span class="token operator">=</span>YES
<span class="token comment">#</span>
<span class="token comment"># If enabled, vsftpd will display directory listings with the time</span>
<span class="token comment"># in  your  local  time  zone.  The default is to display GMT. The</span>
<span class="token comment"># times returned by the MDTM FTP command are also affected by this</span>
<span class="token comment"># option.</span>
use_localtime<span class="token operator">=</span>YES
<span class="token comment">#</span>
<span class="token comment"># Activate logging of uploads/downloads.</span>
xferlog_enable<span class="token operator">=</span>YES
<span class="token comment">#</span>
<span class="token comment"># Make sure PORT transfer connections originate from port 20 (ftp-data).</span>
connect_from_port_20<span class="token operator">=</span>YES
<span class="token comment">#</span>
<span class="token comment"># If you want, you can arrange for uploaded anonymous files to be owned by</span>
<span class="token comment"># a different user. Note! Using "root" for uploaded files is not</span>
<span class="token comment"># recommended!</span>
<span class="token comment">#chown_uploads=YES</span>
<span class="token comment">#chown_username=whoever</span>
<span class="token comment">#</span>
<span class="token comment"># You may override where the log file goes if you like. The default is shown</span>
<span class="token comment"># below.</span>
<span class="token comment">#xferlog_file=/var/log/vsftpd.log</span>
<span class="token comment">#</span>
<span class="token comment"># If you want, you can have your log file in standard ftpd xferlog format.</span>
<span class="token comment"># Note that the default log file location is /var/log/xferlog in this case.</span>
xferlog_std_format<span class="token operator">=</span>YES
<span class="token comment">#</span>
<span class="token comment"># You may change the default value for timing out an idle session.</span>
<span class="token comment">#idle_session_timeout=600</span>
<span class="token comment">#</span>
<span class="token comment"># You may change the default value for timing out a data connection.</span>
<span class="token comment">#data_connection_timeout=120</span>
<span class="token comment">#</span>
<span class="token comment"># It is recommended that you define on your system a unique user which the</span>
<span class="token comment"># ftp server can use as a totally isolated and unprivileged user.</span>
<span class="token comment">#nopriv_user=ftpsecure</span>
<span class="token comment">#</span>
<span class="token comment"># Enable this and the server will recognise asynchronous ABOR requests. Not</span>
<span class="token comment"># recommended for security (the code is non-trivial). Not enabling it,</span>
<span class="token comment"># however, may confuse older FTP clients.</span>
<span class="token comment">#async_abor_enable=YES</span>
<span class="token comment">#</span>
<span class="token comment"># By default the server will pretend to allow ASCII mode but in fact ignore</span>
<span class="token comment"># the request. Turn on the below options to have the server actually do ASCII</span>
<span class="token comment"># mangling on files when in ASCII mode.</span>
<span class="token comment"># Beware that on some FTP servers, ASCII support allows a denial of service</span>
<span class="token comment"># attack (DoS) via the command "SIZE /big/file" in ASCII mode. vsftpd</span>
<span class="token comment"># predicted this attack and has always been safe, reporting the size of the</span>
<span class="token comment"># raw file.</span>
<span class="token comment"># ASCII mangling is a horrible feature of the protocol.</span>
<span class="token comment">#ascii_upload_enable=YES</span>
<span class="token comment">#ascii_download_enable=YES</span>
<span class="token comment">#</span>
<span class="token comment"># You may fully customise the login banner string:</span>
<span class="token comment">#ftpd_banner=Welcome to blah FTP service.</span>
<span class="token comment">#</span>
<span class="token comment"># You may specify a file of disallowed anonymous e-mail addresses. Apparently</span>
<span class="token comment"># useful for combatting certain DoS attacks.</span>
<span class="token comment">#deny_email_enable=YES</span>
<span class="token comment"># (default follows)</span>
<span class="token comment">#banned_email_file=/etc/vsftpd.banned_emails</span>
<span class="token comment">#</span>
<span class="token comment"># You may restrict local users to their home directories.  See the FAQ for</span>
<span class="token comment"># the possible risks in this before using chroot_local_user or</span>
<span class="token comment"># chroot_list_enable below.</span>
<span class="token comment">#chroot_local_user=YES</span>
<span class="token comment">#</span>
<span class="token comment"># You may specify an explicit list of local users to chroot() to their home</span>
<span class="token comment"># directory. If chroot_local_user is YES, then this list becomes a list of</span>
<span class="token comment"># users to NOT chroot().</span>
<span class="token comment"># (Warning! chroot'ing can be very dangerous. If using chroot, make sure that</span>
<span class="token comment"># the user does not have write access to the top level directory within the</span>
<span class="token comment"># chroot)</span>
chroot_local_user<span class="token operator">=</span>YES
<span class="token comment">#chroot_list_enable=YES</span>
<span class="token comment"># (default follows)</span>
<span class="token comment">#chroot_list_file=/etc/vsftpd.chroot_list</span>
<span class="token comment">#</span>
<span class="token comment">#allow_writeable_chroot=YES   ## 添加</span>


allow_writeable_chroot<span class="token operator">=</span>YES

<span class="token comment"># You may activate the "-R" option to the builtin ls. This is disabled by</span>
<span class="token comment"># default to avoid remote users being able to cause excessive I/O on large</span>
<span class="token comment"># sites. However, some broken FTP clients such as "ncftp" and "mirror" assume</span>
<span class="token comment"># the presence of the "-R" option, so there is a strong case for enabling it.</span>
<span class="token comment">#ls_recurse_enable=YES</span>
<span class="token comment">#</span>
<span class="token comment"># Customization</span>
<span class="token comment">#</span>
<span class="token comment"># Some of vsftpd's settings don't fit the filesystem layout by</span>
<span class="token comment"># default.</span>
<span class="token comment">#</span>
<span class="token comment"># This option should be the name of a directory which is empty.  Also, the</span>
<span class="token comment"># directory should not be writable by the ftp user. This directory is used</span>
<span class="token comment"># as a secure chroot() jail at times vsftpd does not require filesystem</span>
<span class="token comment"># access.</span>
secure_chroot_dir<span class="token operator">=</span><span class="token operator">/</span>var<span class="token operator">/</span>run<span class="token operator">/</span>vsftpd<span class="token operator">/</span>empty
<span class="token comment">#</span>
<span class="token comment"># This string is the name of the PAM service vsftpd will use.</span>
pam_service_name<span class="token operator">=</span>vsftpd
<span class="token comment">#</span>
<span class="token comment"># This option specifies the location of the RSA certificate to use for SSL</span>
<span class="token comment"># encrypted connections.</span>
rsa_cert_file<span class="token operator">=</span><span class="token operator">/</span>etc<span class="token operator">/</span>ssl<span class="token operator">/</span>certs<span class="token operator">/</span>ssl<span class="token operator">-</span>cert<span class="token operator">-</span>snakeoil<span class="token punctuation">.</span>pem
rsa_private_key_file<span class="token operator">=</span><span class="token operator">/</span>etc<span class="token operator">/</span>ssl<span class="token operator">/</span>private<span class="token operator">/</span>ssl<span class="token operator">-</span>cert<span class="token operator">-</span>snakeoil<span class="token punctuation">.</span>key
ssl_enable<span class="token operator">=</span>NO


<span class="token comment">#no_anon_password=YES #匿名登录是否需要密码</span>
anon_root<span class="token operator">=</span><span class="token operator">/</span>NAS<span class="token operator">/</span>ftp<span class="token operator">/</span>nologin
local_root<span class="token operator">=</span><span class="token operator">/</span>NAS<span class="token operator">/</span>ftp<span class="token operator">/</span>login

<span class="token comment">#</span>
<span class="token comment"># Uncomment this to indicate that vsftpd use a utf8 filesystem.</span>
<span class="token comment">#utf8_filesystem=YES</span>
<span class="token comment">#</span>
<span class="token comment">#</span>
</code></pre> 
<h3><a id="3_____2315"></a>3、创建用户 与 目录的分配</h3> 
<p>创建用户：Linux useradd 命令<br> 以多用户为例，单用户操作方法一样<br> 创建用户ming1，ming2和对应密码，-m创建该用户文件夹，-d指定该用户文件夹</p> 
<pre><code class="prism language-python">useradd <span class="token operator">-</span>m <span class="token operator">-</span>d <span class="token operator">/</span>home<span class="token operator">/</span>ming1 <span class="token operator">-</span>s <span class="token operator">/</span><span class="token builtin">bin</span><span class="token operator">/</span>bash ming1
passwd ming1
useradd <span class="token operator">-</span>m <span class="token operator">-</span>d <span class="token operator">/</span>home<span class="token operator">/</span>ming2 <span class="token operator">-</span>s <span class="token operator">/</span><span class="token builtin">bin</span><span class="token operator">/</span>bash ming2
passwd ming2


sudo useradd <span class="token operator">-</span>d <span class="token operator">/</span>home<span class="token operator">/</span>ftp<span class="token operator">/</span>ftp_root <span class="token operator">-</span>m ftpadmin
sudo passwd ftpadmin
输入密码：
再次输入密码：
chmod <span class="token operator">-</span>R <span class="token number">777</span> <span class="token operator">/</span>home<span class="token operator">/</span>ftp<span class="token operator">/</span>ftp_root


sudo useradd <span class="token operator">-</span>m ftpuser
sudo passwd ftpuser
New password<span class="token punctuation">:</span> 
Retype new password<span class="token punctuation">:</span> 
passwd<span class="token punctuation">:</span> password updated successfully

</code></pre> 
<p>本地用户：anonymous_enable<br> 匿名用户：local_enable<br> 受限用户：chroot_list_enable</p> 
<p>切换：<br> su 命令的基本格式如下：<br> [root@localhost ~]# su [选项] 用户名<br> 选项：<br> -：当前用户不仅切换为指定用户的身份，同时所用的工作环境也切换为此用户的环境（包括 PATH 变量、MAIL 变量等），使用 - 选项可省略用户名，默认会切换为 root 用户。<br> -l：同 - 的使用类似，也就是在切换用户身份的同时，完整切换工作环境，但后面需要添加欲切换的使用者账号。<br> -p：表示切换为指定用户的身份，但不改变当前的工作环境（不使用切换用户的配置文件）。<br> -m：和 -p 一样；<br> -c 命令：仅切换用户执行一次命令，执行后自动切换回来，该选项后通常会带有要执行的命令。</p> 
<p>查看：<br> cat /etc/passwd 可以查看所有用户的列表<br> w 可以查看当前活跃的用户列表<br> cat /etc/group 查看用户组</p> 
<p>groups 查看当前登录用户的组内成员<br> groups gliethttp 查看gliethttp用户所在的组,以及组内成员<br> whoami 查看当前登录用户名</p> 
<p>一个简明的layout命令</p> 
<p>cat /etc/passwd|grep -v nologin|grep -v halt|grep -v shutdown|awk -F":" ‘{ print $1"|“$3”|"$4 }’|more</p> 
<p>目录分配：</p> 
<p>1）若配置全部用户只访问同一目录，比如用户ming1和用户ming2都默认访问/home/ming的目录，则需要添加配置</p> 
<pre><code class="prism language-py">local_root<span class="token operator">=</span><span class="token operator">/</span>home<span class="token operator">/</span>ming<span class="token operator">/</span>
</code></pre> 
<p>并建立对应的目录给予权限</p> 
<pre><code class="prism language-py">mkdir <span class="token operator">/</span>home<span class="token operator">/</span>ming
chmod <span class="token operator">-</span>R <span class="token number">777</span> <span class="token operator">/</span>home<span class="token operator">/</span>ming
</code></pre> 
<p>以上也适用单个用户的配置</p> 
<p>2）若每个用户默认只访问自己对应的目录，比如用户ming1只访问/home/ming1目录，用户ming2只访问/home/ming2的目录,则需要删除local_root或在前面加#注释掉即可</p> 
<p>参考链接：https://blog.csdn.net/weixin_36185028/article/details/80969672</p> 
<h3><a id="4windows_2389"></a>4、windows远程连接</h3> 
<p><img src="https://images2.imgbox.com/93/13/xh8O62t7_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="5PASV_2392"></a>5、PASV模式</h3> 
<p>解决办法：<br> 1、首先确保服务器支持PASV模式，并且您的客户端正在设置PASV模式，如果服务器不支持被动模式，则防火墙必须支持主动模式FTP传输。<br> 2、或者加入以下代码ftp.set_pasv(False) # 如果被动模式由于某种原因失败，使用主动模式。</p> 
<pre><code class="prism language-py"><span class="token number">1.</span>被动模式
在<span class="token operator">/</span>etc<span class="token operator">/</span>vsftpd<span class="token operator">/</span>vsftpd<span class="token punctuation">.</span>conf中添加或修改：
pasv_enable<span class="token operator">=</span>YES
pasv_min_port<span class="token operator">=</span><span class="token number">3000</span>
pasv_max_port<span class="token operator">=</span><span class="token number">3005</span>

<span class="token number">2.</span>主动模式
在<span class="token operator">/</span>etc<span class="token operator">/</span>vsftpd<span class="token operator">/</span>vsftpd<span class="token punctuation">.</span>conf中添加或修改：
connect_from_port_20<span class="token operator">=</span>YES 
pasv_enable<span class="token operator">=</span>NO

</code></pre> 
<p>参考：https://blog.csdn.net/weixin_43759606/article/details/113582776</p> 
<pre><code class="prism language-python"><span class="token number">2</span><span class="token punctuation">.</span>FTP服务端口的指定

listen_port<span class="token operator">=</span><span class="token number">8021</span>                     <span class="token punctuation">,</span>指定命令通道为<span class="token number">8021</span><span class="token punctuation">,</span>默认为<span class="token number">21</span>

listen_data_port<span class="token operator">=</span><span class="token number">8020</span>                <span class="token punctuation">,</span>指定数据通道为<span class="token number">8020</span><span class="token punctuation">,</span>默认为<span class="token number">20</span>

<span class="token number">3.</span>上传模式的设置

pasv_enable<span class="token operator">=</span>YES                    <span class="token punctuation">,</span>是否允使用被动模式，默认是允许的。

pasv_min_port<span class="token operator">=</span><span class="token number">10000</span>                 ，指定使用被动模式时打开端口的最小值

pasv_max_port<span class="token operator">=</span><span class="token number">10004</span>                ，指定使用被动模式时打开端口的最大值。

<span class="token number">4</span><span class="token punctuation">.</span>Vsftp服务器指定IP地址

listen_address<span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.0</span><span class="token number">.21</span>           ，指定FTP，IP地址
</code></pre> 
<p>FTP port(主动模式) pasv(被动模式)，<br> FTP协议有两种工作方式：PORT方式和PASV方式，中文意思为主动式和被动式。<br> PORT（主动）方式的连接过程是：客户端向服务器的FTP端口（默认是21）发送连接请求，服务器接受连接，建立一条命令链路。当需要传送数据时，客户端在命令链路上用PORT命令告诉服务器：“我打开了XXXX端口，你过来连接我”。于是服务器从20端口向客户端的XXXX端口发送连接请求，建立一条数据链路来传送数据。<br> PASV（被动）方式的连接过程是：客户端向服务器的FTP端口（默认是21）发送连接请求，服务器接受连接，建立一条命令链路。当需要传送数据时，服务器在命令链路上用PASV命令告诉客户端：“我打开了XXXX端口，你过来连接我”。于是客户端向服务器的XXXX端口发送连接请求，建立一条数据链路来传送数据。<br> 从上面可以看出，两种方式的命令链路连接方法是一样的，而数据链路的建立方法就完全不同。而FTP的复杂性就在于此。</p> 
<h3><a id="6_2439"></a>6、报错</h3> 
<p>ftplib.error_perm: 553 Could not create file.<br> （1）文件路径没填对，检查路径 （2）目录权限</p> 
<h2><a id="TTS_2445"></a>十七、TTS</h2> 
<p>视频：https://www.bilibili.com/video/BV1Cg4y1X7J3/?spm_id_from=333.788&amp;vd_source=38e7fc10713eca999c22c7ff25f6e6d2</p> 
<p>https://search.bilibili.com/all?keyword=%E6%96%87%E5%AD%97%E8%BD%AC%E8%AF%AD%E9%9F%B3ai%E6%A8%A1%E5%9E%8B&amp;from_source=webtop_search&amp;spm_id_from=333.788&amp;search_source=2</p> 
<p>1、微软<br> https://github.com/coqui-ai/TTS<br> https://github.com/mozilla/TTS<br> https://github.com/Plachtaa/VALL-E-X（效果一般，操作方便，不用训练）<br> 2、Openai （效果最好）<br> openai api接口<br> Whisper模型<br> whisper是OpenAI公司出品的AI字幕神器，是目前最好的语音生成字幕工具之一，开源且支持本地部署，支持多种语言识别（英语识别准确率非常惊艳）。 作者：略懂的大龙猫 https://www.bilibili.com/read/cv23995720/ 出处：bilibili</p> 
<p>3、<br> https://github.com/Stardust-minus/Bert-VITS2</p> 
<p>4、Bark模型 （英语效果还可以，中文不行）<br> https://github.com/suno-ai/bark</p> 
<p>5、达摩院 （只能中文，效果中等）<br> 达摩院语音实验室设计了SAMBERT</p> 
<p>6、对比<br> https://github.com/KevinWang676/Bark-Voice-Cloning</p> 
<h3><a id="BertVITS2_2472"></a>Bert-VITS2训练</h3> 
<p>参考：https://blog.csdn.net/lsb2002/article/details/134294018<br> 预训练模型train_ms.py已有，或者从https://github.com/srcres258/Bert-VITS2下载</p> 
<p>1、训练前，还要生成emo文件，运行：python emo_gen.py<br> Emotional VITS情感控制项目：https://github.com/innnky/emotional-vits</p> 
<h2><a id="Linux_2480"></a>常用Linux命令</h2> 
<h3><a id="1_conda_2481"></a>1、 conda复制环境</h3> 
<p>复制环境</p> 
<p>一，在本机上，直接使用 conda create -n new_env --clone old_env 复制既有环境</p> 
<p>二，如果要复制到其他机器，就要考虑导出当前环境到文件，利用文件再次创建环境</p> 
<p>1） 首先需要进入某个环境中<br> 导出环境<br> conda env export &gt; ~/env.yaml<br> 或者 conda env export &gt; environment.yaml<br> 利用conda env export 导出的是个yaml格式的文件，该文件记录了环境名，软件源地址以及安装包列表</p> 
<p>2） 使用yaml配置文件创建新环境<br> conda env create -f ~/env.yaml<br> 或者 conda env create -f environment.yaml<br> 在新的机器中可直接执行上述命令，生成的环境与复制源完全一样（包括环境名），如果想在同一台机器上复制，需要把yaml文件中的环境名修改为一个新的名字，否则会冲突。<br> conda env create -f environment.yaml -n environment_name</p> 
<p>【注】还有一种复制环境的方式<br> conda list --explicit &gt; env.txt<br> conda create -n newenv -f env.txt<br> 这种方式只能复制环境中以conda install安装的包，不能复制pip install安装的包，因此不建议使用。<br> 参考https://zhuanlan.zhihu.com/p/153498612</p> 
<p>其他方法：<br> 复制包：pip3 freeze &gt; requirements.txt<br> pip list --format=freeze &gt; requirements.txt</p> 
<p>遇到问题：<br> yaml内部就是pip来，还是用pip方便解决版本问题<br> 设置environment.yaml源<br> 包版本会有问题，要修改<br> https://blog.csdn.net/NOVAglow646/article/details/126937509</p> 
<pre><code class="prism language-python">解决方案
可以尝试对environment<span class="token punctuation">.</span>yml文件进行以下修改，添加镜像源即可：
将channels改为（注意要把default去掉）：

channels<span class="token punctuation">:</span>
  <span class="token operator">-</span> conda<span class="token operator">-</span>forge
  <span class="token operator">-</span> https<span class="token punctuation">:</span><span class="token operator">//</span>mirrors<span class="token punctuation">.</span>tuna<span class="token punctuation">.</span>tsinghua<span class="token punctuation">.</span>edu<span class="token punctuation">.</span>cn<span class="token operator">/</span>anaconda<span class="token operator">/</span>pkgs<span class="token operator">/</span>main
  <span class="token operator">-</span> https<span class="token punctuation">:</span><span class="token operator">//</span>mirrors<span class="token punctuation">.</span>tuna<span class="token punctuation">.</span>tsinghua<span class="token punctuation">.</span>edu<span class="token punctuation">.</span>cn<span class="token operator">/</span>anaconda<span class="token operator">/</span>pkgs<span class="token operator">/</span>free
  <span class="token operator">-</span> https<span class="token punctuation">:</span><span class="token operator">//</span>mirrors<span class="token punctuation">.</span>tuna<span class="token punctuation">.</span>tsinghua<span class="token punctuation">.</span>edu<span class="token punctuation">.</span>cn<span class="token operator">/</span>anaconda<span class="token operator">/</span>pkgs<span class="token operator">/</span>r
  <span class="token operator">-</span> https<span class="token punctuation">:</span><span class="token operator">//</span>mirrors<span class="token punctuation">.</span>tuna<span class="token punctuation">.</span>tsinghua<span class="token punctuation">.</span>edu<span class="token punctuation">.</span>cn<span class="token operator">/</span>anaconda<span class="token operator">/</span>pkgs<span class="token operator">/</span>pro
  <span class="token operator">-</span> https<span class="token punctuation">:</span><span class="token operator">//</span>mirrors<span class="token punctuation">.</span>tuna<span class="token punctuation">.</span>tsinghua<span class="token punctuation">.</span>edu<span class="token punctuation">.</span>cn<span class="token operator">/</span>anaconda<span class="token operator">/</span>pkgs<span class="token operator">/</span>msys2
<span class="token number">1</span>
<span class="token number">2</span>
<span class="token number">3</span>
<span class="token number">4</span>
<span class="token number">5</span>
<span class="token number">6</span>
<span class="token number">7</span>
并在pip的依赖包里添加上镜像源（加上最后一行）。

  <span class="token operator">-</span> pip<span class="token punctuation">:</span>
    <span class="token operator">-</span> addict<span class="token operator">==</span><span class="token number">2.4</span><span class="token number">.0</span>
    <span class="token operator">-</span> anyio<span class="token operator">==</span><span class="token number">3.3</span><span class="token number">.0</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token operator">-</span> websocket<span class="token operator">-</span>client<span class="token operator">==</span><span class="token number">1.1</span><span class="token number">.0</span>
    <span class="token operator">-</span> widgetsnbextension<span class="token operator">==</span><span class="token number">3.5</span><span class="token number">.1</span>
    <span class="token operator">-</span> sapien<span class="token operator">==</span><span class="token number">1.1</span><span class="token number">.1</span>
    <span class="token operator">-</span> <span class="token operator">-</span>i https<span class="token punctuation">:</span><span class="token operator">//</span>pypi<span class="token punctuation">.</span>tuna<span class="token punctuation">.</span>tsinghua<span class="token punctuation">.</span>edu<span class="token punctuation">.</span>cn<span class="token operator">/</span>simple
————————————————
版权声明：本文为CSDN博主「NOVAglow646」的原创文章，遵循CC <span class="token number">4.0</span> BY<span class="token operator">-</span>SA版权协议，转载请附上原文出处链接及本声明。
原文链接：https<span class="token punctuation">:</span><span class="token operator">//</span>blog<span class="token punctuation">.</span>csdn<span class="token punctuation">.</span>net<span class="token operator">/</span>NOVAglow646<span class="token operator">/</span>article<span class="token operator">/</span>details<span class="token operator">/</span><span class="token number">126937509</span>
</code></pre> 
<h3><a id="2_2551"></a>2、压缩</h3> 
<p>zip 压缩命令的第一个参数指定压缩文件名, 后面的所有参数指定待压缩的文件或目录<br> 压缩文件: zip xxx.zip file …<br> 压缩目录: zip -r xxx.zip dir …</p> 
<p>把文件解压到当前目录下<br> unzip xxxxx.zip<br> 如果要把文件解压到指定的目录下，需要用到-d参数(-d指定目标路径,file.zip是需要解压的，destination_folder是指定的目录下)。</p> 
<p>unzip file.zip -d destination_folder</p> 
<p>2、hunggingface安装这个？sudo apt-get install git-lfs<br> git lfs install<br> git clone https://huggingface.co/runwayml/stable-diffusion-v1-5 models/StableDiffusion/<br> 参考：https://github.com/guoyww/animatediff/</p> 
<h3><a id="3ffmpeg_2568"></a>3、ffmpeg</h3> 
<p>$ sudo apt update<br> $ sudo apt upgrade<br> sudo apt-get install ffmpeg</p> 
<h3><a id="4conda_2573"></a>4、conda换源</h3> 
<p>https://blog.csdn.net/KIK9973/article/details/118776314<br> https://blog.csdn.net/weixin_44942303/article/details/121977449</p> 
<h3><a id="5conda_2577"></a>5、conda相关命令</h3> 
<p>升级：conda update -n base conda<br> 删除：<br> 1、：删除环境<br> conda remove -n 需要删除的环境名 --all<br> 2、：删除环境<br> conda env remove -p 要删除的虚拟环境路径<br> conda env remove -p /home/kuucoss/anaconda3/envs/tfpy36 #我的例子</p> 
<h3><a id="6shellpython_2587"></a>6、shell启动python虚拟环境</h3> 
<p>https://zhuanlan.zhihu.com/p/422365954<br> https://blog.csdn.net/weixin_44966641/article/details/119853359<br> #!/bin/sh<br> source /home/bruce/anaconda3/bin/activate your_env_name<br> python test.py</p> 
<p>run.sh</p> 
<pre><code class="prism language-python"><span class="token comment">#!/usr/bin/env bash</span>
source <span class="token operator">/</span>root<span class="token operator">/</span>miniconda3<span class="token operator">/</span><span class="token builtin">bin</span><span class="token operator">/</span>activate kohyass
python test<span class="token punctuation">.</span>py \
<span class="token operator">-</span>u 小红 \
<span class="token operator">-</span>p <span class="token number">12345</span> \
</code></pre> 
<p>test.py</p> 
<pre><code class="prism language-python"><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>

    <span class="token keyword">import</span> sys

    <span class="token keyword">print</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>path<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'当前 Python 解释器路径：'</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>executable<span class="token punctuation">)</span>

    <span class="token keyword">import</span> argparse
     <span class="token comment"># 定义一个ArgumentParser实例:</span>
    parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span>
        prog<span class="token operator">=</span><span class="token string">'backup'</span><span class="token punctuation">,</span> <span class="token comment"># 程序名</span>
        description<span class="token operator">=</span><span class="token string">'Backup MySQL database.'</span><span class="token punctuation">,</span> <span class="token comment"># 描述</span>
        epilog<span class="token operator">=</span><span class="token string">'Copyright(r), 2023'</span> <span class="token comment"># 说明信息</span>
    <span class="token punctuation">)</span>
   <span class="token comment"># 允许用户输入简写的-u:</span>
    <span class="token comment"># parser.add_argument( '--user',default='name')</span>
    <span class="token comment"># parser.add_argument('--password', default='word')</span>


    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'-u'</span><span class="token punctuation">,</span> <span class="token string">'--user'</span><span class="token punctuation">,</span>default<span class="token operator">=</span><span class="token string">'name'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'-p'</span><span class="token punctuation">,</span> <span class="token string">'--password'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">123</span><span class="token punctuation">,</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">)</span>

     <span class="token comment"># 解析参数:</span>
    args <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'解析完参数：'</span><span class="token punctuation">,</span>args<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'类型：'</span><span class="token punctuation">,</span><span class="token builtin">type</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span>
   


    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"python环境测试"</span><span class="token punctuation">)</span>
    python <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"优雅"</span><span class="token punctuation">,</span><span class="token string">"明确"</span><span class="token punctuation">,</span><span class="token string">"简单"</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> linian <span class="token keyword">in</span> <span class="token builtin">iter</span><span class="token punctuation">(</span>python<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>linian<span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token comment">#! /bin/bash</span>
<span class="token comment">#### 这里在/usr/local里面创建文件夹是想看是否有执行的权限</span>
<span class="token comment">#### 事实证明是有的</span>
mkdir <span class="token operator">/</span>home<span class="token operator">/</span>Meger<span class="token operator">/</span>shelltest<span class="token operator">/</span>temp
echo <span class="token string">"test auto bootstrap"</span> <span class="token operator">&gt;</span> <span class="token operator">/</span>home<span class="token operator">/</span>Meger<span class="token operator">/</span>shelltest<span class="token operator">/</span>temp<span class="token operator">/</span><span class="token number">2023</span><span class="token punctuation">.</span>log
echo <span class="token string">"test auto 开机测试"</span> <span class="token operator">&gt;</span> <span class="token operator">/</span>home<span class="token operator">/</span>Meger<span class="token operator">/</span>shelltest<span class="token operator">/</span>temp<span class="token operator">/</span><span class="token number">23</span><span class="token punctuation">.</span>log
echo <span class="token string">"输出完成"</span>

time3<span class="token operator">=</span>$<span class="token punctuation">(</span>date <span class="token string">"+%Y-%m-%d %H:%M:%S"</span><span class="token punctuation">)</span>
echo $time3 <span class="token operator">&gt;</span> <span class="token operator">/</span>home<span class="token operator">/</span>Meger<span class="token operator">/</span>shelltest<span class="token operator">/</span>temp<span class="token operator">/</span>test<span class="token punctuation">.</span>log

</code></pre> 
<p>方案一：（生效）<br> https://blog.csdn.net/Perfect886/article/details/117119231<br> 编辑 /etc/rc.local文件，在最后加上你的脚本即可。<br> 比如：我已经编写了一个脚本apk.sh,存放在/home/apk/下面<br> 在Ubuntu终端输入: sudo nano /etc/init.d/rc.local<br> 在结尾出加入： sh /home/apk/shell.sh //即可开机自动加载脚本<br> 注意：编辑时需要root权限，如果该方法没有正确启动，检查log内容。需要注意的一个点：rc.local中的脚本会在系统登录前执行，这是我们还没进入桌面，因此有可能会执行失败<br> 链接：https://blog.csdn.net/marujunyy/article/details/8466255</p> 
<pre><code class="prism language-python"><span class="token number">1</span>、修改system下的rc<span class="token operator">-</span>local<span class="token punctuation">.</span>service
vim <span class="token operator">/</span>lib<span class="token operator">/</span>systemd<span class="token operator">/</span>system<span class="token operator">/</span>rc<span class="token operator">-</span>local<span class="token punctuation">.</span>service
然后在  rc<span class="token operator">-</span>local<span class="token punctuation">.</span>service中最后面添加如下代码：
<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
WantedBy<span class="token operator">=</span>multi<span class="token operator">-</span>user<span class="token punctuation">.</span>target  
Alias<span class="token operator">=</span>rc<span class="token operator">-</span>local<span class="token punctuation">.</span>service

<span class="token number">2</span>、 <span class="token operator">/</span>etc<span class="token operator">/</span>rc<span class="token punctuation">.</span>local
<span class="token comment">#!/bin/sh</span>
echo <span class="token string">"看到这行字，说明添加自启动脚本成功。"</span> <span class="token operator">&gt;</span> <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>test<span class="token punctuation">.</span>log
<span class="token comment">#中间这一段就是脚本的内容</span>
exit <span class="token number">0</span>

<span class="token number">3</span>、systemd 默认读取 <span class="token operator">/</span>etc<span class="token operator">/</span>systemd<span class="token operator">/</span>system 下的配置文件<span class="token punctuation">,</span> 所以还需要在 <span class="token operator">/</span>etc<span class="token operator">/</span>systemd<span class="token operator">/</span>system 目录下创建软链接

</code></pre> 
<p>方案二：<br> /etc/init.d方法<br> sudo mv test.sh /etc/init.d/<br> sudo chmod 777 test.sh<br> sudo update-rc.d test.sh defaults<br> 如果需要设置启动优先级： <code>bash # 100表示优先级，数越大，执行的越晚 sudo update-rc.d test.sh defaults 100 </code><br> 如果要移除脚本：<br> cd /etc/init.d<br> sudo update-rc.d -f test.sh remove<br> 链接：https://blog.csdn.net/weixin_43455581/article/details/107815743</p> 
<h3><a id="7terminal_2697"></a>7、终端目录说明界面（terminal）</h3> 
<pre><code># 打开配置文件
vi ~/.bashrc
# 使配置文件生效
source ~/.bashrc
</code></pre> 
<h3><a id="8huggingface__2705"></a>8、修改huggingface 目录</h3> 
<p>参考：https://www.cnblogs.com/kongaobo/p/17528720.html</p> 
<pre><code>Huggingface 默认下载位置更改
Ubuntu 系统中 Huggingface 模型等默认的下载位置如下：

~\.cache\huggingface\hub
通过修改环境变量更改默认下载位置：

# 打开配置文件
vi ~/.bashrc
# 添加下述变量
export HF_HOME="目标地址"
# 使配置文件生效
source ~/.bashrc
</code></pre> 
<h2><a id="Python__2723"></a>Python 常用操作</h2> 
<h3><a id="1_2724"></a>1.清空文件夹</h3> 
<p>shutil.rmtree() 表示递归删除文件夹下的所有子文件夹和子文件。</p> 
<h3><a id="2f_python_r_b_u_f__2726"></a>2.格式化字符串f() python中 r’‘, b’‘, u’‘, f’’ 的含义</h3> 
<p>用法,f-string在功能方面不逊于传统的%-formatting语句和str.format()函数，同时性能又优于二者.<br> out_path = f’{output_dataset_dir}/{i:03d}.jpg’</p> 
<h3><a id="3python_2730"></a>3、python设置临时环境变量</h3> 
<p>PYTHONPATH=. sh train_lora.sh “ly261666/cv_portrait_model” “v2.0” “film/film” “./imgs” “./processed” “./output”</p> 
<p>https://blog.csdn.net/weixin_45019478/article/details/113574529</p> 
<h3><a id="4vars_2735"></a>4、vars将类转成字典</h3> 
<p>eavl转字符串<br> <img src="https://images2.imgbox.com/d2/5f/1otCoCxD_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="5jupy_2739"></a>5、交互窗口，jupy</h3> 
<p><img src="https://images2.imgbox.com/76/f0/sJDg5DTx_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="6json_2742"></a>6、数据保存json</h3> 
<p><strong>1、对象——pickle和json</strong><br> pickle模块是以二进制的形式序列化后保存到文件中（保存文件的后缀为".pkl"），不能直接打开进行预览。而python的另一个序列化标准模块 json，可以直接打开查看（例如在notepad++中查看）。<br> 使用总结：<br> pickle保存成二进制序列，json保存成json格式的可读文本，显然json文件可读性更强；<br> pickle保存的对象只能用于python，且不同版本可能不通用；<br> pickle用来载入自定义的类实例时，必须先导入相应类型；<br> dump、load用来操作文件流，dumps、loads用来操作对象<br> pickle操作文件时，要以’b’二进制打开文件；<br> json本身有自己定义的一些数据格式，所以存储时需要确保存储对象在json中有对应的类型<br> json使用时参照以下的对应表，如果想要序列化的数据类型不在这些里面，则保存时会报错<br> 参考链接：https://blog.csdn.net/jonathanzh/article/details/107382056</p> 
<p><strong>2、json存储问题</strong><br> 1、python去除字符串中的转义字符：<br> data = {“datas”: ‘[{“name”: “菜鸟”}]’}<br> 我们使用json的dumps方法将这个字典转为字符串，<br> res = json.dumps(data, ensure_ascii=False)<br> 再打印这个res的时候会发现输出的字符串里包含有转义字符，即反斜杠:<br> {“datas”: “[{\“name\”: \“菜鸟\”}]”}<br> 这里有两种方法可以去除反斜杠，首先第一种比较简单暴力，直接：<br> data = res.replace(“\”, “”)即可，但是各位在使用中要注意，处理之后的数据是否还能正常使用，因为当处理的数据量很大时，无法确定在其他地方反斜杠是否还有用处，所以这种方法适合数据量小，且没有特殊情况的问题使用。<br> 第二种方法使用eval函数处理，即：<br> data = eval(res)<br> 打印这个data，会发现{‘datas’: ‘[{“name”: “菜鸟”}]’}反斜杠没有了，原理是eval首先将res这个变量里的字符串引号剥去，然后得到的是一个字典，显然这个是不可以进行计算的，那么它就开始查找这个字典是否是一个变量，然后它一查找，找到了data，于是输出了data里的原始内容。<br> import json<br> data = {“datas”: ‘[{“name”: “菜鸟”}]’}<br> res = json.dumps(data, ensure_ascii=False)<br> print(res)<br> data = eval(res)<br> print(data)<br> 参考链接：https://blog.csdn.net/qq_20997219/article/details/116269570</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> json
<span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">""</span>
        self<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>causes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>


<span class="token keyword">class</span> <span class="token class-name">teacher</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>name<span class="token punctuation">,</span>age<span class="token punctuation">,</span>score<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name
        self<span class="token punctuation">.</span>age <span class="token operator">=</span> age
        self<span class="token punctuation">.</span>score <span class="token operator">=</span> score

<span class="token keyword">def</span> <span class="token function">ParseJsonToObj</span><span class="token punctuation">(</span>jsonStr<span class="token punctuation">,</span> yourCls<span class="token punctuation">)</span><span class="token punctuation">:</span>
    parseData <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>jsonStr<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">'\t\r\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    result <span class="token operator">=</span> yourCls<span class="token punctuation">(</span><span class="token punctuation">)</span>
    result<span class="token punctuation">.</span>__dict__ <span class="token operator">=</span> parseData
    <span class="token keyword">return</span> result


<span class="token keyword">def</span> <span class="token function">ParseObjToJson</span><span class="token punctuation">(</span>yourObj<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> yourObj<span class="token punctuation">.</span>__dict__<span class="token punctuation">.</span>__str__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"\'"</span><span class="token punctuation">,</span> <span class="token string">"\""</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>


    <span class="token comment">#1、没构造类测试</span>
    jsonStr <span class="token operator">=</span> <span class="token string">'{"name": "ww", "age": 99, "causes": ["A","B"]}'</span>
    stu <span class="token operator">=</span> ParseJsonToObj<span class="token punctuation">(</span>jsonStr<span class="token punctuation">,</span> Student<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"result={}, type={}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>stu<span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token punctuation">(</span>stu<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"name={}, age={}, causes={}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>stu<span class="token punctuation">.</span>name<span class="token punctuation">,</span>stu<span class="token punctuation">.</span>age<span class="token punctuation">,</span>stu<span class="token punctuation">.</span>causes<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># result=&lt;__main__.Student object at 0x0000028343AE2198&gt;, type=&lt;class '__main__.Student'&gt;</span>
    <span class="token comment"># name=ww, age=99, causes=['A', 'B']</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"stu json={}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>ParseObjToJson<span class="token punctuation">(</span>stu<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># stu json={"name": "ww", "age": 99, "causes": ["A", "B"]}</span>

    Stuobj <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token punctuation">)</span>
    Stuobj<span class="token punctuation">.</span>name<span class="token operator">=</span><span class="token string">"小红"</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>Stuobj<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"stu json={}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>ParseObjToJson<span class="token punctuation">(</span>Stuobj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    Stustr<span class="token operator">=</span>ParseObjToJson<span class="token punctuation">(</span>Stuobj<span class="token punctuation">)</span>

    <span class="token comment"># Stustr=Stustr.replace("\\", "/")</span>
    Stustr<span class="token operator">=</span><span class="token builtin">eval</span><span class="token punctuation">(</span>Stustr<span class="token punctuation">)</span>

    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"savejson/save2.json"</span><span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>  <span class="token comment">## 设置'utf-8'编码</span>
        <span class="token comment"># f.write(json.dumps(Stustr,ensure_ascii=False))</span>
        json<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>Stustr<span class="token punctuation">,</span> f<span class="token punctuation">,</span>ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>  <span class="token comment"># 保存到文件</span>
        <span class="token comment">## 如果ensure_ascii=True则会输出中文的ascii码，这里设为False</span>

    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"savejson/save2.json"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        load_dict <span class="token operator">=</span> json<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'load_dic值：'</span><span class="token punctuation">,</span>load_dict<span class="token punctuation">)</span>

    fr <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"savejson/save3.json"</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">,</span>encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    json<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>Stustr<span class="token punctuation">,</span> fr<span class="token punctuation">,</span>ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span> <span class="token comment"># 保存到文件</span>
    fr<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


    <span class="token comment">#2、构造类测试</span>
    <span class="token comment"># teaobj = teacher('hello', 20, 80)</span>
    <span class="token comment"># print("teacher json={}".format(ParseObjToJson(teaobj)))</span>
    <span class="token comment"># teastr = ParseObjToJson(teaobj)</span>
    <span class="token comment">#</span>
    <span class="token comment"># tobj = ParseJsonToObj(teastr, teacher) #报错，必须要实例化</span>
    <span class="token comment"># print("result={}, type={}".format(tobj, type(tobj)))</span>
    <span class="token comment"># print("name={}, age={}, causes={}".format(tobj.name, tobj.age, tobj.score))</span>

</code></pre> 
<p>7、python 环境变量设置PYTHONPATH<br> python sys.path.append()和sys.path.insert()<br> https://zhuanlan.zhihu.com/p/385287537</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> sys
<span class="token keyword">import</span> os

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'当前 Python 解释器路径：'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>executable<span class="token punctuation">)</span>
<span class="token triple-quoted-string string">r"""
当前 Python 解释器路径：
C:\Users\jpch89\AppData\Local\Programs\Python\Python36\python.EXE
"""</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'当前 Python 解释器目录：'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>executable<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token triple-quoted-string string">r"""
当前 Python 解释器目录：
C:\Users\jpch89\AppData\Local\Programs\Python\Python36
"""</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> sys

<span class="token comment"># 设置PYTHONPATH</span>
sys<span class="token punctuation">.</span>path<span class="token punctuation">.</span>insert<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"/path/to/your/module_or_package"</span><span class="token punctuation">)</span>

<span class="token keyword">import</span> sys
sys<span class="token punctuation">.</span>path<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">"/path/to/directory"</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="7_2884"></a>7、任意路径导包</h3> 
<p>sys.path.append(r"stable-diffusion-webui")<br> 注意：有同名文件会出错，这只是把路径名加入环境变量</p> 
<h3><a id="8Python__sysexcepthook__2888"></a>8、Python 全局异常处理 sys.excepthook （路由和进程捕获不了）</h3> 
<p>python中如何用sys.excepthook来对全局异常进行捕获、显示及输出到error日志中<br> python中logging(日志)配置三种方式<br> python logger 全局捕获异常/错误信息<br> Python中的traceback<br> 异常层次：https://cloud.tencent.com/developer/section/1366492</p> 
<h3><a id="9Python_2895"></a>9、将Python控制台输出保存到文件的方法</h3> 
<p>参考： https://blog.csdn.net/qq_39564555/article/details/112135970<br>  在 PyCharm 中或者说运行 python 程序时会使用 print 输出些过程信息、 traceback 异常信息 到控制台，但是程序运行结束后记录就没有了，所以想着每次运行将信息显示在控制台的同时记录到文件中。<br> 记录正常的 print 信息<br> sys.stdout = Logger(log_file_name)<br> # 记录 traceback 异常信息<br> sys.stderr = Logger(log_file_name)<br> 在sys模块中，stderr用来表示标准错误输出去向，stdout表示标准输出去向，通过修改这两个值，可以实现把程序的错误输出和标准输出的内容都写入文件。<br> sys.stdout = open(‘alog.txt’, ‘a’)<br> sys.stderr = open(‘aerrorlog.txt’, ‘a’) #将后续的报错信息写入对应的文件中，模式，有w和a，w就是写模式，每次都会重新写日志，覆盖之前的日志， a是追加模式，默认如果不写的话，就是追加模式</p> 
<ul><li>使用Python将Exception异常错误堆栈信息写入日志文件</li><li>python logger 全局捕获异常/错误信息</li></ul> 
<p>Python 将控制台输出另存为日志文件<br> 需求<br> 方法一：使用 Logger 类（推荐）<br> 方法二：仅使用 sys<br> 方法三：使用 logging 模块</p> 
<p>手动控制日志文件大小</p> 
<pre><code class="prism language-python">除了上述两种方法外，我们还可以通过编写代码手动控制日志文件的大小。我们可以在记录每条日志之前先检查日志文件的大小，如果超过了指定的限制，则将其备份并创建一个新的日志文件。
<span class="token keyword">import</span> logging
<span class="token keyword">import</span> os

<span class="token comment"># 创建日志记录器</span>
logger <span class="token operator">=</span> logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span><span class="token string">'my_logger'</span><span class="token punctuation">)</span>
logger<span class="token punctuation">.</span>setLevel<span class="token punctuation">(</span>logging<span class="token punctuation">.</span>DEBUG<span class="token punctuation">)</span>

<span class="token comment"># 设置日志文件路径和大小</span>
log_file <span class="token operator">=</span> <span class="token string">'my_log.log'</span>
max_log_size <span class="token operator">=</span> <span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span>  <span class="token comment"># 限制日志文件大小为1MB</span>

<span class="token comment"># 检查日志文件大小并备份</span>
<span class="token keyword">def</span> <span class="token function">check_log_file_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>log_file<span class="token punctuation">)</span><span class="token punctuation">:</span>
        log_size <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>getsize<span class="token punctuation">(</span>log_file<span class="token punctuation">)</span>
        <span class="token keyword">if</span> log_size <span class="token operator">&gt;=</span> max_log_size<span class="token punctuation">:</span>
            backup_file <span class="token operator">=</span> log_file <span class="token operator">+</span> <span class="token string">'.bak'</span>
            os<span class="token punctuation">.</span>rename<span class="token punctuation">(</span>log_file<span class="token punctuation">,</span> backup_file<span class="token punctuation">)</span>
            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>log_file<span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
                f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>

<span class="token comment"># 检查日志文件大小并备份</span>
check_log_file_size<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 创建FileHandler对象</span>
handler <span class="token operator">=</span> logging<span class="token punctuation">.</span>FileHandler<span class="token punctuation">(</span>log_file<span class="token punctuation">)</span>

<span class="token comment"># 设置日志记录的格式</span>
formatter <span class="token operator">=</span> logging<span class="token punctuation">.</span>Formatter<span class="token punctuation">(</span><span class="token string">'%(asctime)s - %(levelname)s - %(message)s'</span><span class="token punctuation">)</span>
handler<span class="token punctuation">.</span>setFormatter<span class="token punctuation">(</span>formatter<span class="token punctuation">)</span>

<span class="token comment"># 将handler添加到logger中</span>
logger<span class="token punctuation">.</span>addHandler<span class="token punctuation">(</span>handler<span class="token punctuation">)</span>

<span class="token comment"># 输出日志信息</span>
logger<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">'This is a debug message'</span><span class="token punctuation">)</span>
logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'This is an info message'</span><span class="token punctuation">)</span>
logger<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">'This is a warning message'</span><span class="token punctuation">)</span>
logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">'This is an error message'</span><span class="token punctuation">)</span>
logger<span class="token punctuation">.</span>critical<span class="token punctuation">(</span><span class="token string">'This is a critical message'</span><span class="token punctuation">)</span>
</code></pre> 
<p>限制大小保存日志</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> sys
<span class="token keyword">import</span> os
<span class="token keyword">import</span> time

<span class="token comment"># 控制台输出记录到文件</span>
<span class="token keyword">class</span> <span class="token class-name">Logger</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> file_name<span class="token operator">=</span><span class="token string">"Default.log"</span><span class="token punctuation">,</span> stream<span class="token operator">=</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>terminal <span class="token operator">=</span> stream
        self<span class="token punctuation">.</span>log <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_name<span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">write</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>terminal<span class="token punctuation">.</span>write<span class="token punctuation">(</span>message<span class="token punctuation">)</span> <span class="token comment">#输出到控制台</span>
        self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>write<span class="token punctuation">(</span>message<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">flush</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token comment"># 自定义目录存放日志文件</span>
    log_path <span class="token operator">=</span> <span class="token string">'./Logs/'</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>log_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>log_path<span class="token punctuation">)</span>
    <span class="token comment"># 日志文件名按照程序运行时间设置</span>
    <span class="token comment"># log_file_name = log_path + 'log-' + time.strftime("%Y%m%d-%H%M%S", time.localtime()) + '.log'</span>
    log_file_name1 <span class="token operator">=</span> log_path <span class="token operator">+</span> <span class="token string">'logyes-'</span> <span class="token operator">+</span> time<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">"%Y%m%d-%H%M%S"</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>localtime<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'.log'</span>
    log_file_name2 <span class="token operator">=</span> log_path <span class="token operator">+</span> <span class="token string">'logerro-'</span> <span class="token operator">+</span> time<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">"%Y%m%d-%H%M%S"</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>localtime<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'.log'</span>

    <span class="token comment"># 记录正常的 print 信息</span>
    sys<span class="token punctuation">.</span>stdout <span class="token operator">=</span> Logger<span class="token punctuation">(</span>log_file_name1<span class="token punctuation">)</span>
    <span class="token comment"># 记录 traceback 异常信息</span>
    sys<span class="token punctuation">.</span>stderr <span class="token operator">=</span> Logger<span class="token punctuation">(</span>log_file_name2<span class="token punctuation">)</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

        <span class="token keyword">try</span><span class="token punctuation">:</span>
            fsize <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>getsize<span class="token punctuation">(</span>log_file_name2<span class="token punctuation">)</span>  <span class="token comment"># 返回的是字节大小</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'文件大小：'</span><span class="token punctuation">,</span>fsize<span class="token punctuation">)</span>

            <span class="token keyword">if</span> fsize <span class="token operator">&gt;=</span> <span class="token number">1024</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'清空文件'</span><span class="token punctuation">)</span>
                backup_file <span class="token operator">=</span> log_file_name2 <span class="token operator">+</span> <span class="token string">'.bak'</span>
                <span class="token comment"># os.rename(log_file_name2, backup_file)</span>
                <span class="token keyword">import</span> shutil
                shutil<span class="token punctuation">.</span>copyfile<span class="token punctuation">(</span>log_file_name2<span class="token punctuation">,</span> backup_file<span class="token punctuation">)</span>
                <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>log_file_name2<span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
                    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
                    <span class="token comment"># f.truncate(0)</span>

            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">5555</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            sys<span class="token punctuation">.</span>stderr<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>e<span class="token punctuation">}</span></span><span class="token string">\n'</span></span><span class="token punctuation">)</span>
    fsize <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>getsize<span class="token punctuation">(</span>log_file_name2<span class="token punctuation">)</span>  <span class="token comment"># 返回的是字节大小</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'文件大小B：'</span><span class="token punctuation">,</span> fsize<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'文件大小KB：'</span><span class="token punctuation">,</span> fsize<span class="token operator">/</span><span class="token number">1024</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'文件大小M：'</span><span class="token punctuation">,</span> fsize<span class="token operator">/</span><span class="token number">1024</span><span class="token operator">/</span><span class="token number">1024</span><span class="token punctuation">)</span>

</code></pre> 
<h3><a id="10python_info_3021"></a>10、python info日志</h3> 
<p>1、longging保存日志到文件<br> https://blog.csdn.net/Runner1st/article/details/96481954<br> 方法一：使用 logging<br> 方法二：logger模块化<br> 2、Python 如何限制Python中的日志文件大小：<br> https://geek-docs.com/python/python-ask-answer/901_python_how_to_limit_log_file_size_in_python.html<br> 方法一：使用RotatingFileHandler模块<br> 方法二：使用TimedRotatingFileHandler模块<br> 方法三：手动控制日志文件大小</p> 
<p>3、logger 全局捕获异常/错误信息</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> sys
<span class="token keyword">import</span> logging
<span class="token keyword">import</span> os
<span class="token keyword">import</span> time


logger <span class="token operator">=</span> logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>


<span class="token comment"># handler = logging.StreamHandler(stream=sys.stdout)</span>
<span class="token comment"># logger.addHandler(handler)</span>


logger<span class="token punctuation">.</span>setLevel<span class="token punctuation">(</span>level<span class="token operator">=</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">)</span>
<span class="token comment"># 创建一个 handler，写入日志文件</span>
log_path <span class="token operator">=</span> <span class="token string">'./Logs/'</span>
<span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>log_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>log_path<span class="token punctuation">)</span>
log_file_name <span class="token operator">=</span> log_path <span class="token operator">+</span> <span class="token string">'log-'</span> <span class="token operator">+</span> time<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">"%Y%m%d-%H%M%S"</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>localtime<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'.log'</span>
logfile <span class="token operator">=</span> log_file_name
handler <span class="token operator">=</span> logging<span class="token punctuation">.</span>FileHandler<span class="token punctuation">(</span>logfile<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'a+'</span><span class="token punctuation">)</span>
<span class="token comment"># 输入到日志文件中的日志等级</span>
handler<span class="token punctuation">.</span>setLevel<span class="token punctuation">(</span>logging<span class="token punctuation">.</span>DEBUG<span class="token punctuation">)</span>
<span class="token comment"># 设置 handler 中日志记录格式</span>
formatter <span class="token operator">=</span> logging<span class="token punctuation">.</span>Formatter<span class="token punctuation">(</span><span class="token string">'%(asctime)s - %(name)s - %(levelname)s - %(message)s'</span><span class="token punctuation">)</span>
handler<span class="token punctuation">.</span>setFormatter<span class="token punctuation">(</span>formatter<span class="token punctuation">)</span>
<span class="token comment"># 将 handler 添加到 logger 里面</span>
logger<span class="token punctuation">.</span>addHandler<span class="token punctuation">(</span>handler<span class="token punctuation">)</span>



<span class="token keyword">def</span> <span class="token function">handle_exception</span><span class="token punctuation">(</span>exc_type<span class="token punctuation">,</span> exc_value<span class="token punctuation">,</span> exc_traceback<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token builtin">issubclass</span><span class="token punctuation">(</span>exc_type<span class="token punctuation">,</span> KeyboardInterrupt<span class="token punctuation">)</span><span class="token punctuation">:</span>
        sys<span class="token punctuation">.</span>__excepthook__<span class="token punctuation">(</span>exc_type<span class="token punctuation">,</span> exc_value<span class="token punctuation">,</span> exc_traceback<span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">"Uncaught exception"</span><span class="token punctuation">,</span> exc_info<span class="token operator">=</span><span class="token punctuation">(</span>exc_type<span class="token punctuation">,</span> exc_value<span class="token punctuation">,</span> exc_traceback<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 重点</span>

sys<span class="token punctuation">.</span>excepthook <span class="token operator">=</span> handle_exception <span class="token comment"># 重点</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token comment"># raise RuntimeError("Test unhandled")</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">5555555555</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">)</span>

</code></pre> 
<h3><a id="11_traceback___3082"></a>11、 traceback 异常信息 到控制台</h3> 
<h3><a id="12_3085"></a>12、多队列线程</h3> 
<p>用一个Queue来实现线程间数据共享，根据线程数和队列数，计算出每次喂给线程的数量。用一个长队实现多个队列。</p> 
<pre><code class="prism language-python">queue_per_future <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>temp_frame_paths<span class="token punctuation">)</span> <span class="token operator">//</span> facefusion<span class="token punctuation">.</span><span class="token builtin">globals</span><span class="token punctuation">.</span>execution_thread_count <span class="token operator">*</span> facefusion<span class="token punctuation">.</span><span class="token builtin">globals</span><span class="token punctuation">.</span>execution_queue_count<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">#取整：//;  对于//，是向下取整，即不会进行四舍五入</span>
</code></pre> 
<h3><a id="13python_3091"></a>13、python执行脚本当前相对目录</h3> 
<pre><code>export PYTHONPATH=$PYTHONPATH:${cur_dir}
</code></pre> 
<h3><a id="_python_3097"></a>附： python代码常用函数</h3> 
<p>1、importlib.import_module动态导入模块<br> hasattr判断对象是否包含对应的属性<br> 2、opennsfw2对图片/视频进行鉴黄识别<br> 3、insightface.app.FaceAnalysis识别脸，及其对应的性别、年龄<br> 4、subprocess 模块允许我们启动一个新进程，并连接到它们的输入/输出/错误管道，从而获取返回值。<br> 5、ffmpeg 压缩图片大小（压缩图片文件大小）<br> 注意：使用 -quality 选项的数值越小，图片的质量就越低，文件的大小也就越小。但是，过低的质量会导致图片质量下降，甚至出现噪点等现象。因此，你需要根据实际情况来决定使用的质量。</p> 
<p>6、ffmpeg处理视频的拆分<br> 7、ffmpeg处理音频和视频的拆分</p> 
<h2><a id="python_3109"></a>python模型库</h2> 
<h3><a id="1accelerate_3110"></a>1、accelerate</h3> 
<p>accelerate 是huggingface开源的一个方便将pytorch模型迁移到 GPU/multi-GPUs/TPU/fp16 模式下训练的小巧工具。和标准的 pytorch 方法相比，使用accelerate 进行多GPU DDP模式/TPU/fp16/bf16 训练你的模型变得非常简单(只需要在标准的pytorch训练代码中改动不几行代码就可以适应于cpu/单GPU/多GPU的DDP模式/TPU 等不同的训练环境)，而且速度与原生pytorch相当，非常之快。<br> 平时阅读大佬们的代码 (pytorch)，由于他们都是多机多卡训练的，代码中使用的都是分布式并行计算，需要定义一系列的参数，显得非常复杂。而HuggingFace的Accelerate就能很好的解决这个问题，只需要在平时用的DataParallel版代码中修改几行，就能实现多机多卡、单机多卡的分布式并行计算，另外还支持FP16半精度计算。<br> <img src="https://images2.imgbox.com/df/dd/6OsEIj3o_o.png" alt="在这里插入图片描述"></p> 
<p>加速参数设置：</p> 
<pre><code class="prism language-python">方法一：通过配置文件设置
设置加速的默认参数：accelerate config

方法二：命令行设置
accelerate launch <span class="token operator">-</span><span class="token operator">-</span>num_cpu_threads_per_process<span class="token operator">=</span><span class="token number">12</span> <span class="token string">"./train_network.py"</span> <span class="token operator">-</span><span class="token operator">-</span>enable_bucket

</code></pre> 
<h3><a id="2ossystemsubprocess1_3127"></a>2、os.system和subprocess（多进程模型训练1）</h3> 
<p>raise ValueError(‘参数错误’)抛出的异常不可以捕获，只能查看状态码</p> 
<p>(1)、os.system（捕获不了异常）<br> 该变量返回当前操作系统的类型，当前只注册了3个值：分别是posix , nt , java， 对应linux/windows/java虚拟机，print(os.name)。</p> 
<pre><code class="prism language-python"><span class="token keyword">if</span> os<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">'posix'</span><span class="token punctuation">:</span>
            os<span class="token punctuation">.</span>system<span class="token punctuation">(</span>run_cmd<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            subprocess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>run_cmd<span class="token punctuation">)</span>
</code></pre> 
<p>异常处理：<br> os.system方式<br> 返回值：0（成功）,1,2<br> 为同步调用，直到命令执行结束才会返回是否成功标志，并不能反馈信息。</p> 
<p>（2）subprocess.run（捕获不了异常）<br> subprocess.run() Python 3.5中新增的函数。执行指定的命令，等待命令执行完成后返回一个包含执行结果的CompletedProcess类的实。.check：如果该参数设置为 True，并且进程退出状态码不是 0，则弹 出 CalledProcessError 异常。如果 capture_output 设为 true，stdout 和 stderr 将会被捕获。在使用时，内置的 Popen 对象将自动用 stdout=PIPE 和 stderr=PIPE 创建。stdout 和 stderr 参数不应当与 capture_output 同时提供。如果你希望捕获并将两个流合并在一起，使用 stdout=PIPE 和 stderr=STDOUT 来代替 capture_output。</p> 
<p>subprocess.check_call() Python 2.5中新增的函数。 执行指定的命令，如果执行成功则返回状态码，否则抛出异常。其功能等价于subprocess.run(…, check=True)<br> 参考：<br> https://blog.csdn.net/mouday/article/details/86367256<br> https://www.cnblogs.com/ccorz/p/Python-subprocess-zhong-derun-fang-fa.html<br> https://www.runoob.com/w3cnote/python3-subprocess.html</p> 
<p>subprocess.run(args, *, stdin=None, input=None, stdout=None, stderr=None, shell=False, timeout=None, check=False)<br> args是所有调用所必需的，应该为一个字符串或一个程序参数序列。通常倾向提供参数序列，因为它允许这个模块来处理任何所需的转义和引用参数（例如，允许文件名中的空格）。如果传递单个字符串，shell必须为True（见下文），否则字符串必须简单地命名要执行的程序而不指定任何参数。</p> 
<pre><code class="prism language-python"> run_cmd<span class="token operator">=</span><span class="token string">'python apptest1.py'</span>  
    <span class="token keyword">print</span><span class="token punctuation">(</span>run_cmd<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'subprocess执行命令'</span><span class="token punctuation">)</span>
    subprocess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>run_cmd<span class="token punctuation">,</span>shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> check<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">异常捕获
（<span class="token number">1</span>）
<span class="token keyword">import</span> subprocess
<span class="token keyword">def</span> <span class="token function">runcmd</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ret <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>command<span class="token punctuation">,</span>shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span>stderr<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span>encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token punctuation">,</span>timeout<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> ret<span class="token punctuation">.</span>returncode <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"success:"</span><span class="token punctuation">,</span>ret<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"error:"</span><span class="token punctuation">,</span>ret<span class="token punctuation">)</span>


runcmd<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"dir"</span><span class="token punctuation">,</span><span class="token string">"/b"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment">#序列参数</span>
runcmd<span class="token punctuation">(</span><span class="token string">"exit 1"</span><span class="token punctuation">)</span><span class="token comment">#字符串参数</span>

（<span class="token number">2</span>）
  <span class="token keyword">try</span><span class="token punctuation">:</span>
        
        <span class="token comment"># print('subprocess执行命令')</span>
        <span class="token comment"># ret = subprocess.run(run_cmd,shell=True,stdout=subprocess.PIPE,stderr=subprocess.PIPE,encoding="utf-8",timeout=1)</span>
        <span class="token comment"># if ret.returncode == 0:</span>
        <span class="token comment">#         print("success:",ret)</span>
        <span class="token comment"># else:</span>
        <span class="token comment">#         print("error:",ret)</span>
        <span class="token comment"># print('sub执行结束,没有异常')</span>
        
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'subprocess执行命令'</span><span class="token punctuation">)</span>
        process <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>run_cmd<span class="token punctuation">,</span>shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span>
        <span class="token comment"># process = subprocess.run(run_cmd,shell=True, check=True, capture_output=True,encoding="utf-8")</span>
        
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'类型：'</span><span class="token punctuation">,</span><span class="token builtin">type</span><span class="token punctuation">(</span>process<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'process值:'</span><span class="token punctuation">,</span>process<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'状态码为0成功'</span><span class="token punctuation">,</span>process<span class="token punctuation">.</span>returncode<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'sub执行结束,没有异常'</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token comment"># process.kill()</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'捕获异常：'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> e<span class="token punctuation">.</span>__traceback__<span class="token punctuation">.</span>tb_lineno<span class="token punctuation">,</span> <span class="token string">'行'</span><span class="token punctuation">)</span>

</code></pre> 
<pre><code class="prism language-python">Python <span class="token keyword">try</span>块不会捕获os<span class="token punctuation">.</span>system异常
ut_eos 发布于 <span class="token number">2019</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">01</span> • 在 <span class="token keyword">except</span> • 最后更新 <span class="token number">2019</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">09</span><span class="token punctuation">:</span><span class="token number">20</span> • <span class="token number">983</span> 浏览

我有这个Python代码：

<span class="token keyword">import</span> os
<span class="token keyword">try</span><span class="token punctuation">:</span>
  os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">'wrongcommand'</span><span class="token punctuation">)</span>
<span class="token keyword">except</span><span class="token punctuation">:</span>
  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"command does not work"</span><span class="token punctuation">)</span>
代码打印：
wrongcommand<span class="token punctuation">:</span> command <span class="token keyword">not</span> found
而不是command does <span class="token keyword">not</span> work。有谁知道为什么它不打印我的错误信息？
<span class="token number">4</span> 个回复
reum <span class="token number">2019</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">01</span>

如果要在命令不存在时抛出异常，则应使用subprocess：

 <span class="token keyword">import</span> subprocess
 <span class="token keyword">try</span><span class="token punctuation">:</span>
     subprocess<span class="token punctuation">.</span>call<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'wrongcommand'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
 <span class="token keyword">except</span> OSError<span class="token punctuation">:</span>
     <span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">'wrongcommand does not exist'</span><span class="token punctuation">)</span>
想想看，你应该使用subprocess而不是os<span class="token punctuation">.</span>system <span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<h3><a id="3spawnforkforkserver_2_3233"></a>3、多进程spawn、fork、forkserver （多进程模型训练2）</h3> 
<p>raise ValueError(‘参数错误’)抛出的异常可以捕获</p> 
<p>Python 多进程编程：创建进程的三种模式之spawn、fork、forkserver<br> 首先fork和spawn都是构建子进程的不同方式，区别在于：<br> fork：除了必要的启动资源外，其他变量，包，数据等都继承自父进程，并且是copy-on-write的，也就是共享了父进程的一些内存页，因此启动较快，但是由于大部分都用的父进程数据，所以是不安全的进程<br> spawn：从头构建一个子进程，父进程的数据等拷贝到子进程空间内，拥有自己的Python解释器，所以需要重新加载一遍父进程的包，因此启动较慢，由于数据都是自己的，安全性较高</p> 
<p>raise ValueError(‘参数错误’)抛出的异常可以捕获<br> 多进程调用训练模型<br> 报错：Cannot re-initialize CUDA in forked subprocess. To use CUDA with multiprocessing, you must use the ‘spawn’ start method</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch
torch<span class="token punctuation">.</span>multiprocessing<span class="token punctuation">.</span>set_start_method<span class="token punctuation">(</span><span class="token string">'spawn'</span><span class="token punctuation">,</span>force<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token comment">#解决不了</span>
<span class="token comment"># print(multiprocessing.get_start_method())</span>
<span class="token comment"># multiprocessing.set_start_method('spawn', force=True)</span>

<span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'subprocess执行命令'</span><span class="token punctuation">)</span>
        core<span class="token punctuation">.</span>testtrain<span class="token punctuation">(</span><span class="token string">'我是主线程'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'sub执行结束,没有异常'</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Couldn't parse"</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'捕获异常Reason:'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
        

</code></pre> 
<h3><a id="4python_multiprocessing__3262"></a>4、python multiprocessing 如何在主进程中捕获子进程抛出的异常</h3> 
<p>https://blog.csdn.net/lixiaowang_327/article/details/81319923</p> 
<h3><a id="5requestsrequest_3264"></a>5、requests和request</h3> 
<p>（1）requests<br> Python request里面data、json、params传参方式的不同<br> 1、json.dumps()和json.loads()是json格式处理函数（可以这么理解，json是字符串）<br> 　　(1)json.dumps()函数是将一个Python数据类型列表进行json格式的编码（可以这么理解，json.dumps()函数是将字典转化为字符串）<br> 　　(2)json.loads()函数是将json格式数据转换为字典（可以这么理解，json.loads()函数是将字符串转化为字典）</p> 
<p>2、json.dump()和json.load()主要用来读写json文件函数</p> 
<p>requests模块发送请求有data、json、params三种携带参数的方法。</p> 
<p>params在get请求中使用，data、json在post请求中使用<br> 文链接：https://blog.csdn.net/Jason_WangYing/article/details/108256804</p> 
<p>（2）request<br> flask中request对象中的form、data、json这三个属性其实是flask根据不同的content-type类型将HTTP请求体进行转换而来的数据，这几个属性的类型一般都是字典或者是字典的子类。<br> https://zhuanlan.zhihu.com/p/551703472<br> 附：<br> 论文：cvpr</p> 
<h3><a id="6gradio_UI_3286"></a>6、gradio UI库</h3> 
<p>gradio Python项目常用的ui库<br> launch(server_name=“0.0.0.0”, server_port=1234)<br> ui.launch(show_api = False, share = True,server_port=6006)<br> 参数：https://www.gradio.app/docs/interface</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2f204c91eebf32814d3148b5778998df/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">网络安全试题——附答案</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e1148f7bc885e4e55a2bc7afb8610025/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">FPGA和DSP的区别</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>