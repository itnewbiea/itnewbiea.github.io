<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>DM9051--TCP通信实验（基于STM32CUBEMX） - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="DM9051--TCP通信实验（基于STM32CUBEMX）" />
<meta property="og:description" content="1.前言 最近作者一直在研究DM9051芯片的工作机理，在此过程中，上网上找了很多资料，但根据资料还是不能了解很通透。因此我直接开始实战，经过多番周折，终于调通了程序。再此篇文章分享下自己的调试过程，也把疑问分享一下！（写的比较潦草，资料在最后）
2.DM9051介绍 DM9051NP SPI接口网卡芯片是为了方便MCU单片机系统进行以太网通信而开发出的解决方案。DM9051NP芯片是带有行业标准串列外设接口（Serial Peripheral Interface，SPI）的独立以太网控制器。DM9051NP符合IEEE 802.3 规范，它还支持以DMA 模式來传输，以实现资料传送快速。DM9051NP通过1个中断引脚和SPI接口來进行与主控制器/MCU单片机的通信，资料传输规格为10/100 M。
3.主要实现的功能 作者想通过DM9051，实现STM32F103与网络调试助手进行通信。并且能够定时上传数据，或者能够连续传输数据。其中DM9051作为TCP服务器端。
4.单片机配置 SPI配置：
SPI通过DMA进行传输，其它配置根据自己的单片机设置就行。PB12是管脚是SPI-NSS（选择管脚），要通信的话，需要拉低这个管脚。
5.代码分析 1.此处代码是为了配置DM9051的IP地址 dm9051_init(); //DM9051初始化 uip_init();	//uIP初始化 uip_arp_init();	//arp表初始化 uip_ipaddr(ipaddr, 10,0,115,70);	//设置本地设置IP地址 uip_sethostaddr(ipaddr); uip_ipaddr(ipaddr, 10,0,115,1); //设置网关IP地址(其实就是你路由器的IP地址) uip_setdraddr(ipaddr); uip_ipaddr(ipaddr, 255,0,0,0);	//设置网络掩码 uip_setnetmask(ipaddr); uip_listen(HTONS(80));	//80端口,用于TCP Server 2.while循环 while (1) { uip_polling();	//处理uip任务 //开始传送30次数据帧的任务 if(flag_transdata == 1) { for(int i = 0; i&lt;30; i&#43;&#43;) { againa: tttt=0; //为了确保每次都会进入mtcp_appcall()函数 rrrr =1;//标志位，为了告诉DM9051需要处理数据了 uip_polling();//处理uip任务 delay_ms(5); if(tttt == 0) //如果没有进入mtcp_appcall()函数，则再来一次 { goto againa; } } rrrr= 0; //标志位清0 flag_transdata = 0;//30次数据发送完成 } delay_ms(20); } 3." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/c29589a2de431cdf2e5fb78f43b058ec/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-17T17:07:26+08:00" />
<meta property="article:modified_time" content="2023-03-17T17:07:26+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">DM9051--TCP通信实验（基于STM32CUBEMX）</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="1_0"></a>1.前言</h2> 
<p><strong>最近作者一直在研究DM9051芯片的工作机理，在此过程中，上网上找了很多资料，但根据资料还是不能了解很通透。因此我直接开始实战，经过多番周折，终于调通了程序。再此篇文章分享下自己的调试过程，也把疑问分享一下！（写的比较潦草，资料在最后）</strong></p> 
<h2><a id="2DM9051_2"></a>2.DM9051介绍</h2> 
<p>DM9051NP SPI接口网卡芯片是为了方便MCU单片机系统进行以太网通信而开发出的解决方案。DM9051NP芯片是带有行业标准串列外设接口（Serial Peripheral Interface，SPI）的独立以太网控制器。DM9051NP符合IEEE 802.3 规范，它还支持以DMA 模式來传输，以实现资料传送快速。DM9051NP通过1个中断引脚和SPI接口來进行与主控制器/MCU单片机的通信，资料传输规格为10/100 M。</p> 
<h2><a id="3_4"></a>3.主要实现的功能</h2> 
<p>作者想通过DM9051，实现STM32F103与网络调试助手进行通信。并且能够定时上传数据，或者能够连续传输数据。其中DM9051作为TCP服务器端。</p> 
<h2><a id="4_6"></a>4.单片机配置</h2> 
<p><img src="https://images2.imgbox.com/31/10/GyFmDNPJ_o.png" alt="在这里插入图片描述"><br> SPI配置：<br> <img src="https://images2.imgbox.com/a0/95/oJcYcmWZ_o.png" alt="在这里插入图片描述"><br> SPI通过DMA进行传输，其它配置根据自己的单片机设置就行。PB12是管脚是SPI-NSS（选择管脚），要通信的话，需要拉低这个管脚。</p> 
<h2><a id="5_12"></a>5.代码分析</h2> 
<h3><a id="1DM9051IP_13"></a>1.此处代码是为了配置DM9051的IP地址</h3> 
<pre><code class="prism language-c"> 	<span class="token function">dm9051_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">//DM9051初始化</span>
    <span class="token function">uip_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">//uIP初始化</span>
    <span class="token function">uip_arp_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//arp表初始化</span>
    <span class="token function">uip_ipaddr</span><span class="token punctuation">(</span>ipaddr<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">115</span><span class="token punctuation">,</span><span class="token number">70</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//设置本地设置IP地址</span>
    <span class="token function">uip_sethostaddr</span><span class="token punctuation">(</span>ipaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">uip_ipaddr</span><span class="token punctuation">(</span>ipaddr<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">115</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 	<span class="token comment">//设置网关IP地址(其实就是你路由器的IP地址)</span>
    <span class="token function">uip_setdraddr</span><span class="token punctuation">(</span>ipaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">uip_ipaddr</span><span class="token punctuation">(</span>ipaddr<span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//设置网络掩码</span>
    <span class="token function">uip_setnetmask</span><span class="token punctuation">(</span>ipaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>   
    <span class="token function">uip_listen</span><span class="token punctuation">(</span><span class="token function">HTONS</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//80端口,用于TCP Server</span>
</code></pre> 
<h3><a id="2while_26"></a>2.while循环</h3> 
<pre><code class="prism language-c">  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">uip_polling</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//处理uip任务</span>
			<span class="token comment">//开始传送30次数据帧的任务</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>flag_transdata <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">30</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
againa<span class="token operator">:</span>
                tttt<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//为了确保每次都会进入mtcp_appcall()函数</span>
                rrrr <span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//标志位，为了告诉DM9051需要处理数据了</span>
                <span class="token function">uip_polling</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//处理uip任务</span>
                <span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>tttt <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//如果没有进入mtcp_appcall()函数，则再来一次</span>
                <span class="token punctuation">{<!-- --></span>

                    <span class="token keyword">goto</span> againa<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

            <span class="token punctuation">}</span>
            rrrr<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//标志位清0</span>
            flag_transdata <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//30次数据发送完成</span>
        <span class="token punctuation">}</span>
        <span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="3DM9051_55"></a>3.DM9051代码</h3> 
<ol><li>初始化uIP协定栈：uip_init()<br> 2．处理输入包：uip_input()<br> 3．处理周期计时事件：uip_periodic()<br> 4．开始监听端口：uip_listen()<br> 5．连接到远程主机：uip_connect()<br> 6．接收到连接请求：uip_connected()<br> 7．主动关闭连接：uip_close()<br> 8．连接被关闭：uip_closed()<br> 9．发出去的数据被应答：uip_acked()<br> 10．在当前连接发送数据：uip_send()<br> 11．在当前连接上收到新的数据：uip_newdata()<br> 12．告诉对方要停止连接：uip_stop()<br> 13．连接被意外终止：uip_aborted()</li></ol> 
<pre><code class="prism language-c"><span class="token comment">//处理tcp消息接口</span>
<span class="token keyword">void</span> <span class="token function">mtcp_appcall</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">uip_newdata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//如果有新数据进来</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">968</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            rec<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span><span class="token number">0x00</span><span class="token operator">+</span>i<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        flag_transdata <span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//</span>

    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> rrrr <span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">uip_send</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>rec<span class="token punctuation">,</span><span class="token number">968</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tttt <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        dddd<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">uip_connected</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        d <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">uip_closed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        d <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="6_101"></a>6.资料链接</h2> 
<p><strong>网上的资料：</strong><br> <a href="https://bbs.21ic.com/icview-1148468-1-1.html" rel="nofollow">DM9051资料介绍以及代码编程</a><br> <strong>自己的代码：</strong><br> 链接：<a href="https://pan.baidu.com/s/1tHzC6nG2TiSftCsEItueOA?pwd=2022" rel="nofollow">https://pan.baidu.com/s/1tHzC6nG2TiSftCsEItueOA?pwd=2022</a><br> 提取码：2022</p> 
<h2><a id="7_109"></a>7.调试中的问题</h2> 
<p>1.如果在连续发射的时候，一帧与一帧的间隔为5ms，会发生传输到网络调试助手的数据包少一半，比如说，想传个30帧，但接收到的就是15帧了（保证每次都会进入mtcp_appcall()函数）。不知道为什么会这样？但如果改个20ms延迟的话，就能完全接收到!</p> 
<h2><a id="8_111"></a>8.总结</h2> 
<p>在过程中，需要两个时钟，一个是0.5S的心跳时钟，一个是10S的时钟，发现DM9051的工作方式为：0.5s时钟一到就会进行数据的交互，如果你想要传输数据，就可以再此进行。如果DM9051传输了一次数据，马上就会在轮询一次，检查是否还有数据要发，如果有的话，会一直轮询，如果没有数据要发送的话，就不会在轮询了。直到0.5s时间到了，进入TIMER，会进行数据交互。</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/823e309f5b7ab121955da281441d075b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">CPU使用率100%如何定位分析？</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/fcf3ebc13ff0b1ae18d65eaa4ec1dd21/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Log4j2修改转储日志文件权限</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>