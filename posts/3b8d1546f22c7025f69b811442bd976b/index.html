<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>vnpy_ctp源码下载后转变为python可用的处理过程 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="vnpy_ctp源码下载后转变为python可用的处理过程" />
<meta property="og:description" content="目录
写在前面 下载源码并解压
创建python项目
环境
过程
编译vnpy_ctp源码
验证可用性
写在前面 window系统中必须安装有Visual Studio ,后面源码安装时需要进行C&#43;&#43;编译
下载源码并解压 GitHub - vnpy/vnpy_ctp: VeighNa框架的CTP交易接口
下载zip压缩包
解压
要在python中能执行，要有.pyd文件，解压后的文件夹内没有.pyd文件
创建python项目 新建一个python项目，项目在一个新的虚拟环境中执行。
环境 操作系统：window10 64位
开发工具：pycharm
python版本：python3.8.10
过程 编译vnpy_ctp源码 打开项目下方的terminal面板
cd 到解压后setup.py 所在文件夹 执行 python setup.py build 大概2到3分钟，编译完毕，在setup.py所在文件夹下多出一个build文件夹
在build下找到与操作系统和python版本对应的文件夹，以本文为例，操作系统是64位，那文件夹名称中就会有amd64,python版本3.8，文件夹名称中就会包含3.8，所以本文的文件夹名为lib.win-amd64-3.8
我们需要的是 build&gt;lib.win-amd64-3.8&gt;vnpy_ctp文件夹下的api文件夹，我们把api文件夹复制到项目目录下
验证可用性 创建Md调用的类和Td调用的类
import datetime,sys,os,time,pytz from api import ( TdApi, MdApi ) class CtpMdApi(MdApi): def __init__(self)-&gt;None: super().__init__() self.reqid:int = 0 self.connect_status: bool = False self.login_status: bool = False self.subscribed: set = set() self." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/3b8d1546f22c7025f69b811442bd976b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-10T11:17:42+08:00" />
<meta property="article:modified_time" content="2023-11-10T11:17:42+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">vnpy_ctp源码下载后转变为python可用的处理过程</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2%C2%A0-toc" style="margin-left:0px;"><a href="#%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2%C2%A0" rel="nofollow">写在前面 </a></p> 
<p id="%E4%B8%8B%E8%BD%BD%E6%BA%90%E7%A0%81%E5%B9%B6%E8%A7%A3%E5%8E%8B-toc" style="margin-left:0px;"><a href="#%E4%B8%8B%E8%BD%BD%E6%BA%90%E7%A0%81%E5%B9%B6%E8%A7%A3%E5%8E%8B" rel="nofollow">下载源码并解压</a></p> 
<p id="%E5%88%9B%E5%BB%BApython%E9%A1%B9%E7%9B%AE-toc" style="margin-left:0px;"><a href="#%E5%88%9B%E5%BB%BApython%E9%A1%B9%E7%9B%AE" rel="nofollow">创建python项目</a></p> 
<p id="%E7%8E%AF%E5%A2%83-toc" style="margin-left:40px;"><a href="#%E7%8E%AF%E5%A2%83" rel="nofollow">环境</a></p> 
<p id="%E8%BF%87%E7%A8%8B-toc" style="margin-left:40px;"><a href="#%E8%BF%87%E7%A8%8B" rel="nofollow">过程</a></p> 
<p id="%E7%BC%96%E8%AF%91vnpy_ctp%E6%BA%90%E7%A0%81-toc" style="margin-left:0px;"><a href="#%E7%BC%96%E8%AF%91vnpy_ctp%E6%BA%90%E7%A0%81" rel="nofollow">编译vnpy_ctp源码</a></p> 
<p id="%E9%AA%8C%E8%AF%81%E5%8F%AF%E7%94%A8%E6%80%A7-toc" style="margin-left:0px;"><a href="#%E9%AA%8C%E8%AF%81%E5%8F%AF%E7%94%A8%E6%80%A7" rel="nofollow">验证可用性</a></p> 
<hr id="hr-toc"> 
<p></p> 
<h2 id="%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2%C2%A0">写在前面 </h2> 
<p>window系统中必须安装有Visual Studio ,后面源码安装时需要进行C++编译</p> 
<h2 id="%E4%B8%8B%E8%BD%BD%E6%BA%90%E7%A0%81%E5%B9%B6%E8%A7%A3%E5%8E%8B" style="background-color:transparent;">下载源码并解压</h2> 
<p><a href="https://github.com/vnpy/vnpy_ctp" title="GitHub - vnpy/vnpy_ctp: VeighNa框架的CTP交易接口">GitHub - vnpy/vnpy_ctp: VeighNa框架的CTP交易接口</a></p> 
<p><img alt="" height="490" src="https://images2.imgbox.com/e8/b1/Mzi2xk0M_o.png" width="1077">下载zip压缩包</p> 
<p><img alt="" height="40" src="https://images2.imgbox.com/e2/f7/6A0p3gV7_o.png" width="516"></p> 
<p>解压</p> 
<p><img alt="" height="59" src="https://images2.imgbox.com/37/c6/UFBETOEK_o.png" width="417"></p> 
<p><img alt="" height="300" src="https://images2.imgbox.com/92/bc/7wUczcvq_o.png" width="646"></p> 
<p><img alt="" height="294" src="https://images2.imgbox.com/b7/3d/wDFHS6U6_o.png" width="795"></p> 
<p>要在python中能执行，要有.pyd文件，解压后的文件夹内没有.pyd文件</p> 
<h2 id="%E5%88%9B%E5%BB%BApython%E9%A1%B9%E7%9B%AE">创建python项目</h2> 
<p>新建一个python项目，项目在一个新的虚拟环境中执行。</p> 
<h3 id="%E7%8E%AF%E5%A2%83">环境</h3> 
<p>操作系统：window10 64位</p> 
<p>开发工具：pycharm</p> 
<p>python版本：python3.8.10</p> 
<h3 id="%E8%BF%87%E7%A8%8B">过程</h3> 
<p><img alt="" height="472" src="https://images2.imgbox.com/46/b5/yo765A0K_o.png" width="974"></p> 
<p><img alt="" height="271" src="https://images2.imgbox.com/90/83/RyJtZQ2r_o.png" width="594"></p> 
<h2 id="%E7%BC%96%E8%AF%91vnpy_ctp%E6%BA%90%E7%A0%81">编译vnpy_ctp源码</h2> 
<p>打开项目下方的terminal面板</p> 
<p><img alt="" height="1012" src="https://images2.imgbox.com/1e/b7/KWaSKiKJ_o.png" width="1200"></p> 
<p>cd 到解压后setup.py 所在文件夹  </p> 
<p><img alt="" height="820" src="https://images2.imgbox.com/31/45/0BJCaC4h_o.png" width="1140"></p> 
<p>执行 python setup.py build </p> 
<p><img alt="" height="349" src="https://images2.imgbox.com/ad/f8/sRFNHbIZ_o.png" width="1200"></p> 
<p>大概2到3分钟，编译完毕，在setup.py所在文件夹下多出一个build文件夹</p> 
<p><img alt="" height="361" src="https://images2.imgbox.com/c2/be/xCGzJTv5_o.png" width="831"></p> 
<p><img alt="" height="342" src="https://images2.imgbox.com/71/0a/teNqrAY3_o.png" width="817">在build下找到与操作系统和python版本对应的文件夹，以本文为例，操作系统是64位，那文件夹名称中就会有amd64,python版本3.8，文件夹名称中就会包含3.8，所以本文的文件夹名为lib.win-amd64-3.8</p> 
<p>我们需要的是 build&gt;lib.win-amd64-3.8&gt;vnpy_ctp文件夹下的api文件夹，我们把api文件夹复制到项目目录下</p> 
<p><img alt="" height="530" src="https://images2.imgbox.com/35/46/ODNn8aVJ_o.png" width="496"></p> 
<h2 id="%E9%AA%8C%E8%AF%81%E5%8F%AF%E7%94%A8%E6%80%A7">验证可用性</h2> 
<p>创建Md调用的类和Td调用的类</p> 
<pre><code class="hljs">import datetime,sys,os,time,pytz
from api import (
    TdApi,
    MdApi
)
class CtpMdApi(MdApi):
    def __init__(self)-&gt;None:
        super().__init__()

        self.reqid:int = 0
        self.connect_status: bool = False
        self.login_status: bool = False
        self.subscribed: set = set()

        self.userid: str = ""
        self.password: str = ""
        self.brokerid: str = ""

        self.current_date: str = datetime.date.today().strftime('%Y%m%d')
        pass
    def connect(self, address: str, userid: str, password: str, brokerid: str)-&gt;None:
        self.userid = userid
        self.password = password
        self.brokerid = brokerid

        if not self.connect_status:
            con_body_path = CTP_MD_CON_DIR
            con_body_path = con_body_path.replace('/','\\')
            self.createFtdcMdApi(con_body_path)
            self.registerFront(address)
            self.init()

            self.connect_status = True
            pass
        pass

    def login(self)-&gt;None:
        ctp_req: dict = {
            'UserID':self.userid,
            'Password':self.password,
            'BrokerID':self.brokerid
        }
        self.reqid += 1
        self.reqUserLogin(ctp_req,self.reqid)
        pass
    def subscribe(self,req:dict):
        if self.login_status:
            self.subscribeMarketData(req['symbol'])
        self.subscribed.add(req['symbol'])
        pass
    def close(self)-&gt;None:
        if self.connect_status:
            self.exit()
        pass
    def update_date(self)-&gt;None:
        self.current_date = datetime.date.today().strftime('%Y%m%d')
        pass
    def onFrontConnected(self)-&gt;None:
        self.login()
        pass
    def onFrontDisconnected(self,reason:int)-&gt;None:
        self.login_status = False
        pass
    def onRspUserLogin(self,data:dict,error:dict,reqid:int,last:bool)-&gt;None:
        if not error['ErrorID']:
            self.login_status = True
            for symbol in self.subscribed:
                self.subscribeMarketData(symbol)
            pass
        else:
            print(f"行情服务器登录失败。{error['ErrorID']}.{error['ErrorMsg']}")
        pass
    def onRspError(self, error: dict, reqid: int, last: bool)-&gt;None:
        print('行情接口报错。', error['ErrorID'], error['ErrorMsg'])
        pass
    def onRspSubMarketData(self, data: dict, error: dict, reqid: int, last: bool):
        if not error or not error['ErrorID']:
            return
        print('行情订阅失败。',error['ErrorID'],error['ErrorMsg'])
        pass
    def onRtnDepthMarketData(self,data:dict)-&gt;None:
        if not data['UpdateTime']:
            return
        print('tick返回',data['InstrumentID'],data['LastPrice'])
        pass
    pass

class CtpTdApi(TdApi):
    def __init__(self)-&gt;None:
        super().__init__()
        self.reqid: int = 0
        self.order_ref: int = 0

        self.connect_status: bool = False
        self.login_status: bool = False
        self.auth_status: bool = False
        self.login_failed: bool = False
        self.auth_failed: bool = False
        self.contract_inited: bool = False

        self.userid: str = ""
        self.password: str = ""
        self.brokerid: str = ""
        self.auth_code: str = ""
        self.appid: str = ""

        self.frontid: int = 0
        self.sessionid: int = 0
        pass
    def connect(self,address:str,userid:str,password:str,brokerid:str,auth_code:str,appid:str)-&gt;None:
        self.userid = userid
        self.password = password
        self.brokerid = brokerid
        self.auth_code = auth_code
        self.appid = appid

        if not self.connect_status:
            con_body_path = CTP_TD_CON_DIR + self.userid + os.path.sep
            if not os.path.exists(con_body_path):
                os.mkdir(con_body_path)
            con_body_path = con_body_path.replace('/','\\')
            self.createFtdcTraderApi(con_body_path)

            self.subscribePrivateTopic(0)
            self.subscribePublicTopic(0)
            self.registerFront(address)
            self.init()

            self.connect_status = True
            pass
        else:
            self.authenticate()
        pass

    def authenticate(self)-&gt;None:
        if self.auth_failed:
            return
        ctp_req: dict = {
            "UserID": self.userid,
            "BrokerID": self.brokerid,
            "AuthCode": self.auth_code,
            "AppID": self.appid
        }

        self.reqid += 1
        self.reqAuthenticate(ctp_req, self.reqid)
        pass
    def login(self)-&gt;None:
        if self.login_failed:
            return
        ctp_req: dict = {
            "UserID": self.userid,
            "Password": self.password,
            "BrokerID": self.brokerid,
            "AppID": self.appid
        }

        self.reqid += 1
        self.reqUserLogin(ctp_req, self.reqid)
        pass
    def close(self)-&gt;None:
        if self.connect_status:
            self.exit()
        pass
    def onFrontConnected(self)-&gt;None:
        if self.auth_code:
            self.authenticate()
        else:
            self.login()
        pass
    def onFrontDisconnected(self,reason:int)-&gt;None:
        self.login_status = False
        pass
    def onRspAuthenticate(self, data: dict, error: dict, reqid: int, last: bool)-&gt;None:
        if not error['ErrorID']:
            self.auth_status = True
            self.login()
        else:
            self.auth_failed = True
            print('交易服务器验证失败。',error['ErrorID'],error['ErrorMsg'])
        pass
    def onRspUserLogin(self,data: dict, error: dict, reqid: int, last: bool)-&gt;None:
        if not error["ErrorID"]:
            self.frontid = data["FrontID"]
            self.sessionid = data["SessionID"]
            self.login_status = True

            # 自动确认结算单
            ctp_req: dict = {
                "BrokerID": self.brokerid,
                "InvestorID": self.userid
            }
            self.reqid += 1
            self.reqSettlementInfoConfirm(ctp_req, self.reqid)
        else:
            self.login_failed = True
            print("交易服务器登录失败", error['ErrorID'], error['ErrorMsg'])
        pass
    def onRspSettlementInfoConfirm(self,data: dict, error: dict, reqid: int, last: bool)-&gt;None:
        while True:
            self.reqid += 1
            n: int = self.reqQryInstrument({}, self.reqid)
            if not n:
                break
            else:
                time.sleep(1)
        pass
    def onRspQryInstrument(self, data: dict, error: dict, reqid: int, last: bool) -&gt; None:
        print(data['ProductClass'],data['InstrumentID'],data['ProductID'],reqid,last)
        if last:
            self.contract_inited = True
            print('合约信息查询完毕')
        pass
    pass</code></pre> 
<p>执行代码</p> 
<pre><code class="hljs">if __name__ == '__main__':
    investorid = ""
    brokerid=""
    password= ""
    appid= ""
    auth_code= "0000000000000000"
    md_ip= "180.168.146.187:10211"
    trader_ip= "180.168.146.187:10201"

    temp_api = CtpTdApi()
    address = f"tcp://{trader_ip}"
    temp_api.connect(address,investorid,password,brokerid,auth_code,appid)

    import keyboard
    keyboard.wait('esc')
    sys.exit()
    pass</code></pre> 
<p><img alt="" height="301" src="https://images2.imgbox.com/44/47/Sz4AjOy7_o.png" width="604"></p> 
<p>能登录td服务器，并正常查询合约，可用 </p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/45c7951cdb6188658a281414d2f74885/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">uniapp&#43;vue3&#43;ts&#43;vite&#43;echarts开发图表类小程序，将echarts导入项目使用的详细步骤，耗时一天终于弄好了</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4ad8a1cb076cb07e74cf391cdc8f7743/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Python合并拼接图片</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>