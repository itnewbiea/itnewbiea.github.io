<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>开放原子训练营（第四季）TobudOS——TobudOS内核移植（keil版） - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="开放原子训练营（第四季）TobudOS——TobudOS内核移植（keil版）" />
<meta property="og:description" content="前言 12月份参加了开放原第四季线下活动，觉得很有意义。通过这篇博文，记录一下这次活动进行的移植TobudOS内核的过程，下面就让我们开始吧。
开发板介绍 本次使用的开发板型号为STM32H750，当然了，其他型号的开发版也是可以的，只要是支持 ARM Cortex M 核芯片的都是可以的，移植方法都是类似的。
环境准备 2.1 STM32CubeMX STM32CubeMX是ST公司推出的一种自动创建单片机工程及初始化代码的工具，适用于旗下所有STM32系列产品。此软件可以作为eclipse插件形式安装，也可以单独运行，需要安装JAVA运行环境。软件可以在ST官网上找到，下载地址为：https://www.st.com/content/st_com/zh/products/development-tools/software-development-tools/stm32-software-development-tools/stm32-configurators-and-code-generators/stm32cubemx.html，安装过程非常简单，在此不详述。
建议采用管理员方式运行，因为ST对软件版本及其集成的库更新频繁，无管理员权限容易安装失败。
2.2 Keil编译器 本移植指南针对的是 Keil 编译器，所以我们移植内核前需要先安装 Keil 编译器，能编译 ARM Cortex M 核的 Keil 编译器，现在也叫 MDK，下载地址为：https://www.keil.com/demo/eval/arm.htm 填写注册信息即可下载，下载完成在 windows 环境下按照提示安装即可，安装完成后需要自行购买软件 License，避免 32K Flash 下载限制。 由于新版本的 MDK 编译器和芯片支持包是分离的，所以 MDK（Keil）安装完成后，还需要安装对应芯片的器件支持包（PACK 包）。
准备芯片的裸机工程 3.1 启动 STM32CubeMX，新建工程 3.2 选择MCU型号 双击后弹出工程配置界面，如图：
3.3 配置时钟源 3.4 配置串口 3.5 配置GPIO 3.6 配置总线时钟 3.7 工程配置 3.8 代码生成配置 3.9 点击Generate Code生成工程 生成代码后，在Keil 中打开该工程，编译运行，无报错，就说明裸机工程代码已经生成完毕啦！
接下来就是进行TobudOS内核移植的过程啦，让我们继续。
TobudOS简介 TobudOS是面向物联网领域开发的实时操作系统，早期版本基于腾讯自研的物联网操作系统TencentOS Tiny，2020年由腾讯捐赠到开放原子开源基金会进行孵化，2023年正式更名为TobudOS，TobudOS具有低功耗，低资源占用，模块化，安全可靠等特点，可有效提升物联网终端产品开发效率，提供精简的 RTOS 内核，内核组件可裁剪可配置，可快速移植到多种主流 MCU (如 STM32 全系列) 及模组芯片上。而且，基于 RTOS 内核提供了丰富的物联网组件，内部集成主流物联网协议栈（如 CoAP/MQTT/TLS/DTLS/LoRaWAN/NB-IoT 等），可助力物联网终端设备及业务快速接入物联网云平台。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/09a8373a74659a04b394e38ae83668ed/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-01T22:56:36+08:00" />
<meta property="article:modified_time" content="2024-01-01T22:56:36+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">开放原子训练营（第四季）TobudOS——TobudOS内核移植（keil版）</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h3>前言</h3> 
<p>12月份参加了开放原第四季线下活动，觉得很有意义。通过这篇博文，记录一下这次活动进行的移植TobudOS内核的过程，下面就让我们开始吧。</p> 
<h3>开发板介绍</h3> 
<p>本次使用的开发板型号为<a href="https://so.csdn.net/so/search?q=STM32H750&amp;spm=1001.2101.3001.7020" title="STM32H750">STM32H750</a>，当然了，其他型号的开发版也是可以的，只要是支持 ARM Cortex M 核芯片的都是可以的，移植方法都是类似的。</p> 
<h3>环境准备</h3> 
<h4>2.1 STM32CubeMX</h4> 
<p>STM32CubeMX是ST公司推出的一种自动创建单片机工程及初始化代码的工具，适用于旗下所有STM32系列产品。此软件可以作为eclipse插件形式安装，也可以单独运行，需要安装JAVA运行环境。软件可以在ST官网上找到，下载地址为：<a href="https://www.st.com/content/st_com/zh/products/development-tools/software-development-tools/stm32-software-development-tools/stm32-configurators-and-code-generators/stm32cubemx.html" rel="nofollow" title="https://www.st.com/content/st_com/zh/products/development-tools/software-development-tools/stm32-software-development-tools/stm32-configurators-and-code-generators/stm32cubemx.html">https://www.st.com/content/st_com/zh/products/development-tools/software-development-tools/stm32-software-development-tools/stm32-configurators-and-code-generators/stm32cubemx.html</a>，安装过程非常简单，在此不详述。</p> 
<p>建议采用管理员方式运行，因为ST对软件版本及其集成的库更新频繁，无管理员权限容易安装失败。</p> 
<h4>2.2 Keil编译器</h4> 
<p>本移植指南针对的是 Keil 编译器，所以我们移植内核前需要先安装 Keil 编译器，能编译 ARM Cortex M 核的 Keil 编译器，现在也叫 MDK，下载地址为：<a href="https://www.keil.com/demo/eval/arm.htm" rel="nofollow" title="https://www.keil.com/demo/eval/arm.htm">https://www.keil.com/demo/eval/arm.htm</a> 填写注册信息即可下载，下载完成在 windows 环境下按照提示安装即可，安装完成后需要自行购买软件 License，避免 32K Flash 下载限制。 由于新版本的 MDK 编译器和芯片支持包是分离的，所以 MDK（Keil）安装完成后，还需要安装对应芯片的器件支持包（PACK 包）。</p> 
<h3>准备芯片的裸机工程</h3> 
<h4>3.1 启动 STM32CubeMX，新建工程</h4> 
<p><img alt="" height="700" src="https://images2.imgbox.com/c4/47/EsiK9OtD_o.png" width="1070"></p> 
<h4>3.2 选择MCU型号</h4> 
<p><img alt="" height="704" src="https://images2.imgbox.com/be/55/eK0DAdJg_o.png" width="1200"></p> 
<p>双击后弹出工程配置界面，如图：</p> 
<p><img alt="" height="1054" src="https://images2.imgbox.com/61/50/hEdNwsSt_o.png" width="1200"></p> 
<h4>3.3 配置时钟源</h4> 
<p><img alt="" height="437" src="https://images2.imgbox.com/67/85/TVdQJWOs_o.png" width="958"></p> 
<h4>3.4 配置串口</h4> 
<p><img alt="" height="1002" src="https://images2.imgbox.com/ac/bf/aCBgDK6g_o.png" width="1200"></p> 
<h4>3.5 配置GPIO</h4> 
<p><img alt="" height="1003" src="https://images2.imgbox.com/45/39/5tRjrbFM_o.png" width="1200"></p> 
<h4>3.6 配置总线时钟</h4> 
<p><img alt="" height="1019" src="https://images2.imgbox.com/22/1d/Yo1GAj1H_o.png" width="1200"></p> 
<h4>3.7 工程配置</h4> 
<p><img alt="" height="717" src="https://images2.imgbox.com/f2/75/Q0DYds56_o.png" width="1200"></p> 
<h4>3.8 代码生成配置</h4> 
<p><img alt="" height="1026" src="https://images2.imgbox.com/e4/3a/E2Lg5cnt_o.png" width="1200"></p> 
<h4>3.9 点击Generate Code生成工程</h4> 
<p><img alt="" height="1027" src="https://images2.imgbox.com/92/df/WXU228y6_o.png" width="1200"></p> 
<p>生成代码后，在Keil 中打开该工程，编译运行，无报错，就说明裸机工程代码已经生成完毕啦！</p> 
<p><img alt="" height="736" src="https://images2.imgbox.com/1e/c8/XJtT6ok0_o.png" width="1200"></p> 
<p>接下来就是进行TobudOS内核移植的过程啦，让我们继续。</p> 
<h3></h3> 
<h3>TobudOS简介</h3> 
<p>TobudOS是面向物联网领域开发的实时操作系统，早期版本基于腾讯自研的物联网操作系统TencentOS Tiny，2020年由腾讯捐赠到开放原子开源基金会进行孵化，2023年正式更名为TobudOS，TobudOS具有低功耗，低资源占用，模块化，安全可靠等特点，可有效提升物联网终端产品开发效率，提供精简的 RTOS 内核，内核组件可裁剪可配置，可快速移植到多种主流 MCU (如 STM32 全系列) 及模组芯片上。而且，基于 RTOS 内核提供了丰富的物联网组件，内部集成主流物联网协议栈（如 CoAP/MQTT/TLS/DTLS/LoRaWAN/NB-IoT 等），可助力物联网终端设备及业务快速接入物联网云平台。</p> 
<h3>源码准备</h3> 
<p>TobudOS 的源码已经开源，GitHub 下载地址为：<a href="https://atomgit.com/OpenAtomFoundation/TobudOS/blob/master/doc" rel="nofollow" title="https://atomgit.com/OpenAtomFoundation/TobudOS/blob/master/doc">https://atomgit.com/OpenAtomFoundation/TobudOS/blob/master/doc</a></p> 
<table><thead><tr><th>一级目录</th><th>二级目录</th><th>说明</th></tr></thead><tbody><tr><td>arch</td><td>arm</td><td>TencentOS tiny 适配的 IP 核架构（含 M 核中断、调度、tick 相关代码）</td></tr><tr><td>board</td><td>NUCLEO_L073RZ</td><td>移植目标芯片的工程文件</td></tr><tr><td>kernel</td><td>core</td><td>TencentOS tiny 内核源码</td></tr><tr><td></td><td>pm</td><td>TencentOS tiny 低功耗模块源码</td></tr><tr><td>osal</td><td>cmsis_os</td><td>TencentOS tiny 提供的 cmsis os 适配</td></tr></tbody></table> 
<p>由于本教程只介绍 TobudOS的内核移植，所以这里只需要用到 arch、board、kernel、osal 四个目录下的源码。</p> 
<h3>TobudOS内核移植</h3> 
<p>如图所示，新建 TobudOS主目录，并在主目录下添加四个子目录，其中 arch、kernel、osal 从代码仓直接拷贝过来即可，而 board 目录下则放入我们前面生成的裸机工程代码，我们移植的开发板取名叫 TobudOS_EVB_AloT_STM32 ，裸机代码全部拷贝到下面即可，如下图所示：</p> 
<p><img alt="" height="219" src="https://images2.imgbox.com/29/e4/leNMnDgm_o.png" width="570"></p> 
<p><img alt="" height="219" src="https://images2.imgbox.com/75/b1/Wgx9UnUX_o.png" width="707"></p> 
<p>接下来进入 TobudOS\board\TobudOS_EVB_AloT_STM32\MDK-ARM 目录，打开 keil 工程，我们开始添加 TobudOS 的内核代码。</p> 
<h4 id="2.-%E6%B7%BB%E5%8A%A0-arch-%E5%B9%B3%E5%8F%B0%E4%BB%A3%E7%A0%81">添加 arch 平台代码</h4> 
<p><img alt="" height="479" src="https://images2.imgbox.com/4e/25/ORKKSr5K_o.png" width="767"></p> 
<p>说明：</p> 
<p>1）tos_cpu.c 是 TencentOS tiny 的 CPU 适配文件，包括堆栈初始化，中断适配等；</p> 
<p>2）port_s.S 文件是 TencentOS tiny 的任务调度汇编代码，主要做弹栈压栈等处理的，</p> 
<p>3）port_c.c 文件是适配 systick 等</p> 
<h4 id="3.-%E6%B7%BB%E5%8A%A0%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81">添加内核源码</h4> 
<p>内核源码 kerne 目录下包含 core 和 pm 两个目录，其中 core 下为基础内核，pm 是内核中的低功耗组件；基础移植的时候可以不添加 pm 目录下的代码，如下图所示：</p> 
<p><img alt="" height="486" src="https://images2.imgbox.com/0c/f8/gulDRAfK_o.png" width="639"></p> 
<p>注：添加全部基本内核源码</p> 
<h4 id="4.-%E6%B7%BB%E5%8A%A0-cmsis-os-%E6%BA%90%E7%A0%81" style="background-color:transparent;">添加 cmsis os 源码</h4> 
<p>cmsis os 是 TencentOS tiny 为了兼容 cmsis 标准而适配的 OS 抽象层，可以简化将业务从其他 RTOS 迁移到 TencentOS tiny 的工作量。</p> 
<p><img alt="" height="477" src="https://images2.imgbox.com/97/b2/PHf0heR0_o.png" width="641"></p> 
<h4 id="5.-%E6%B7%BB%E5%8A%A0-tencentos-tiny-%E5%A4%B4%E6%96%87%E4%BB%B6%E7%9B%AE%E5%BD%95" style="background-color:transparent;">添加 TobudOS 头文件目录</h4> 
<p>添加头文件目录前，我们在要移植的工程目录下新增一个 TOS_CONFIG 文件夹，用于存放 TencentOS tiny 的配置头文件，也就是接下来要新建的 tos_config.h 文件；</p> 
<p>TencentOS tiny 所有要添加的头文件目录如下：</p> 
<p><img alt="" height="476" src="https://images2.imgbox.com/da/cb/WVRTN7Os_o.png" width="639"></p> 
<h4 id="6.-%E6%96%B0%E5%BB%BA-tencentos-tiny-%E7%B3%BB%E7%BB%9F%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-tos_config.h" style="background-color:transparent;">新建 TobudOS 系统配置文件 tos_config.h</h4> 
<pre><code class="language-cpp">#ifndef _TOS_CONFIG_H_
#define  _TOS_CONFIG_H_

#include "stm32h7xx.h"	// 目标芯片头文件，用户需要根据情况更改

#define TOS_CFG_TASK_PRIO_MAX           10u 	// 配置TobudOS默认支持的最大优先级数量

#define TOS_CFG_ROUND_ROBIN_EN          0u		// 配置TobudOS的内核是否开启时间片轮转

#define TOS_CFG_OBJECT_VERIFY_EN           1u	// 配置TobudOS是否校验指针合法

#define TOS_CFG_TASK_DYNAMIC_CREATE_EN  1u		// TobudOS 动态任务创建功能宏

#define TOS_CFG_EVENT_EN                1u		// TobudOS 事件模块功能宏

#define TOS_CFG_MMBLK_EN                1u		//配置TobudOS是否开启内存块管理模块

#define TOS_CFG_MMHEAP_EN               1u		//配置TobudOS是否开启动态内存模块

#define TOS_CFG_MMHEAP_DEFAULT_POOL_EN  1u		// TobudOS 默认动态内存池功能宏

#define TOS_CFG_MMHEAP_DEFAULT_POOL_SIZE        0x100	// 配置TobudOS默认动态内存池大小

#define TOS_CFG_MUTEX_EN                1u		// 配置TobudOS是否开启互斥锁模块

#define TOS_CFG_MESSAGE_QUEUE_EN        1u		// 配置TobudOS是否开启消息队列模块

#define TOS_CFG_MAIL_QUEUE_EN           1u		// 配置TobudOS是否开启消息邮箱模块

#define TOS_CFG_PRIORITY_MESSAGE_QUEUE_EN	1u	// 配置TobudOS是否开启优先级消息队列模块

#define TOS_CFG_PRIORITY_MAIL_QUEUE_EN	1u		// 配置TobudOS是否开启优先级消息邮箱模块

#define TOS_CFG_TIMER_EN                1u		// 配置TobudOS是否开启软件定时器模块

#define TOS_CFG_PWR_MGR_EN              0u		// 配置TobudOS是否开启外设电源管理模块

#define TOS_CFG_TICKLESS_EN             0u		// 配置Tickless 低功耗模块开关

#define TOS_CFG_SEM_EN                  1u		// 配置TobudOS是否开启信号量模块

#define TOS_CFG_TASK_STACK_DRAUGHT_DEPTH_DETACT_EN      1u	// 配置TobudOS是否开启任务栈深度检测

#define TOS_CFG_FAULT_BACKTRACE_EN      0u		// 配置TobudOS是否开启异常栈回溯功能

#define TOS_CFG_IDLE_TASK_STK_SIZE      128u	// 配置TobudOS空闲任务栈大小

#define TOS_CFG_CPU_TICK_PER_SECOND     1000u	// 配置TobudOS的tick频率

#define TOS_CFG_CPU_CLOCK               (SystemCoreClock)	// 配置TobudOS CPU频率

#define TOS_CFG_TIMER_AS_PROC           1u		// 配置是否将TIMER配置成函数模式

#endif

</code></pre> 
<p>按照上面的模板配置好 TencentOS tiny 的各项功能后，将 tos_config.h 文件放入要移植的 board 工程目录下即可。</p> 
<p>这样，TobudOS的源码移植就全部移植完毕了。</p> 
<h3 id="%E4%B8%89%E3%80%81%E5%88%9B%E5%BB%BA-tencentos-tiny-%E4%BB%BB%E5%8A%A1%EF%BC%8C%E6%B5%8B%E8%AF%95%E7%A7%BB%E6%A4%8D%E7%BB%93%E6%9E%9C">创建 TobudOS任务，测试移植结果</h3> 
<h4 id="1.-%E4%BF%AE%E6%94%B9%E9%83%A8%E5%88%86%E4%BB%A3%E7%A0%81">修改部分代码</h4> 
<p>修改 stm32l0xx_it.c 的中断函数，在 stm32l0xx_it.c 文件中包含 tos_k.h 头文件</p> 
<p><img alt="" height="507" src="https://images2.imgbox.com/61/c7/2DzoeMMw_o.png" width="1200"></p> 
<p>在 stm32l0xx_it.c 文件中的 PendSV_Handler 函数前添加___weak 关键字，因为该函数在 TencentOS tiny 的调度汇编中已经重新实现；同时在 SysTick_Handler 函数中添加 TencentOS tiny 的调度处理函数，如下图所示：</p> 
<p><img alt="" height="717" src="https://images2.imgbox.com/a7/54/Bgxxyfkj_o.png" width="790"></p> 
<h4 id="2.-%E7%BC%96%E5%86%99-tencentos-tiny-%E6%B5%8B%E8%AF%95%E4%BB%BB%E5%8A%A1">编写 TobudOS测试任务</h4> 
<p>在 main.c 中添加 TobudOS头文件，编写任务函数</p> 
<pre><code class="language-cpp"> #include "cmsis_os.h"
   //task1
   #define TASK1_STK_SIZE		256
   void task1(void *pdata);
   osThreadDef(task1, osPriorityNormal, 1, TASK1_STK_SIZE);

   //task2
   #define TASK2_STK_SIZE		256
   void task2(void *pdata);
   osThreadDef(task2, osPriorityNormal, 1, TASK2_STK_SIZE);

   void task1(void *pdata)
   {
       int count = 1;
       while(1)
       {
           printf("\r\nHello world!\r\n###This is task1 ,count is %d \r\n", count++);
           HAL_GPIO_TogglePin(LED_GPIO_Port,LED_Pin);
           osDelay(2000);
       }
   }
   void task2(void *pdata)
   {
       int count = 1;
       while(1)
       {
           printf("\r\nHello TencentOS !\r\n***This is task2 ,count is %d \r\n", count++);
           osDelay(1000);
       }
   }

   int fputc(int ch, FILE *f)
   {
     if (ch == '\n')
     {
       HAL_UART_Transmit(&amp;huart2, (void *)"\r", 1,30000);
     }
     HAL_UART_Transmit(&amp;huart2, (uint8_t *)&amp;ch, 1, 0xFFFF);
     return ch;
   }</code></pre> 
<p>继续在 main.c 的 main 函数中硬件外设初始化代码后添加 TencentOS tiny 的初始化代码：</p> 
<pre><code class="language-cpp">osKernelInitialize(); //TOS Tiny kernel initialize
     osThreadCreate(osThread(task1), NULL);// Create task1
     osThreadCreate(osThread(task2), NULL);// Create task2
     osKernelStart();//Start TOS Tiny</code></pre> 
<h4 id="3.-%E7%BC%96%E8%AF%91%E4%B8%8B%E8%BD%BD%E6%B5%8B%E8%AF%95-tencentos-tiny-%E7%A7%BB%E6%A4%8D%E7%BB%93%E6%9E%9C">编译下载测试 TobudOS移植结果</h4> 
<p>进行编译下载到开发板即可完成 TobudOS的测试，如下图所示，可以看到串口交替打印信息，表示两个任务正在进行调度，切换运行。说明成功进行了移植。</p> 
<p><img alt="" height="693" src="https://images2.imgbox.com/e0/bf/30uehUmQ_o.png" width="936"></p> 
<p>以上就是TobudOS内核移植的过程，如果有疑问可以留言一起探讨哈！</p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a6e3cbbddff25e8c99e633ed8ebfb0e3/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">上界通配符（? extends Type）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a09b16c20a3bc4561c3d4b368da7e03a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Java 通配符 ?</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>