<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>MPLS动态协议LDP配置示例 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="MPLS动态协议LDP配置示例" />
<meta property="og:description" content="一、预习： MPLS：Multi-Protocol Label Switching多协议标签交换，是一种根据报文中携带的标签转发的技术；可承载在各种链路层协议之上（如PPP、ATM、帧中继、以太网）；同时它还能承载各种网络层报文，如ipv4、ipv6；采用无连接的控制平面，实现路由信息的传递和标签的分发，采用面向连接的数据平面，实现报文在建立的标签转发路径上传送。LSR之间运行LDP来告知其他LSR本设备上的标签绑定信息，从而实现标签报文的正确转发。
技术创新：摒弃了繁琐的路由查找 ，将具有全局意义的路由表改为简单快速的标签交换；MPLS转发的本质就是将数据归到对应的FEC并按照提前建立好的LSP进行转发
MPLS在二层以太网网络协议号中使用8847或8848，IP协议号为0800，端口号646，BGP端口号179
MPLS实际应用场景： 随着硬件技术的发展，ip转发性能也大大提高，MPLS在这方面并未发挥优势，但由于MPLS结合了IP网络强大的三层路由功能和二层网络高效的转发机制，所以目前MPLS主要应用于VPN技术，TE（Traffic Engineering，流量工程）以及QOS（Quality of Service，服务质量）。
提示：基于MPLS的VPN通过LSP将私有网络的不同分支连接起来，形成一个统一的网络，用户设备无需为VPN配置GRE、L2TP等隧道；网络延时也会被降至最低。
MPLS体系结构 ： 控制平面：负责产生和维护路由以及标签信息；包括IP路由协议和路由信息表，标签分发协议和标签信息表
转发平面：也称数据平面，负责普通IP报文的转及带MPLS标签报文的转发；转发平面包括转发信息表和标签转发信息表
LSR：Label Switching Router，标签交换路由器，由LSR 构成的网络区域称为 MPLS域（MPLS Domain），在 IP 网络内进行传统的 IP 转发，在 MPLS 域内进行标签转发。
LER：Label EdgeRouter位于 MPLS 域边缘、连接其它网络的边缘路由器，进入到MPLS网络的流量由LER分为不同的FEC；
Core LSR：区域内部的 LSR 称为核心 LSR。
LSR分类：
Ingress LSR 入站标签，压入MPLS头部并生成MPLS报文的LSR
Transit LSR 中转LSR，做标签转换操作
Egrss LSR 出站LSR，做剥离MPLS标签操作
LSP：Label Switch Path 标签交换通道
LDP：Label Distribution Protocol，标签分发协议是MPLS的一种控制协议，相当于传统网络中的信令协议，负责FEC的分类、标签的分配及LSP的建立和维护等操作。LDP规定了标签分发过程中的各种消息及相关处理过程。
LSP：Label Switch Path，标签交换路径|通道，是标签报文穿越MPLS网络到达目的地所走的路径，LSP是单向的路径，和数据流的方向一致同一个FEC的报文通常采用相同的LSP穿越MPLS域，所以对同一个FEC，LSR总是用相同的标签转发。
Label Stack：MPLS支持一层或者多层标签头部，这些标签头部的有序集合被称为标签栈
FEC：Forwarding Equivalence Class，转发等价类，是一组具有某些共性的数据流的集合，这些数据流在转发过程中被网络节点以相同方式处理，MPLS基于FEC发放标签；在转发过程中以等价的方式来标识创建FEC，通常的MPLS只是一条路由对应一个FEC
在MPLS网络中，FEC可通过多种方式划分，如基于目的IP及网络掩码、DSCP等特征来划分
数据属于另一个LSP，由数据 进入MPLS域时的Ingress LSR 决定
MPLS标签通常是与FEC相对应的，必须有某种机制使得网络中的LSR获得关于某FEC的标签信息" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/9430f83ac0f727e88a1a79b1152e48d1/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-02T22:14:40+08:00" />
<meta property="article:modified_time" content="2024-01-02T22:14:40+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">MPLS动态协议LDP配置示例</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h6> 一、预习：</h6> 
<p>       <strong> MPLS</strong>：Multi-Protocol Label Switching多协议标签交换，是一种根据报文中携带的标签转发的技术；可承载在各种链路层协议之上（如PPP、ATM、帧中继、以太网）；同时它还能承载各种网络层报文，如ipv4、ipv6；采用无连接的控制平面，实现路由信息的传递和标签的分发，采用面向连接的数据平面，实现报文在建立的标签转发路径上传送。LSR之间运行LDP来告知其他LSR本设备上的标签绑定信息，从而实现标签报文的正确转发。</p> 
<p>        技术创新：摒弃了繁琐的路由查找 ，将具有全局意义的路由表改为简单快速的标签交换；MPLS转发的本质就是将数据归到对应的FEC并按照提前建立好的LSP进行转发</p> 
<p>        MPLS在二层以太网网络协议号中使用8847或8848，IP协议号为0800，端口号646，BGP端口号179</p> 
<h6>        MPLS实际应用场景：</h6> 
<p>　　随着硬件技术的发展，ip转发性能也大大提高，MPLS在这方面并未发挥优势，但由于MPLS结合了IP网络强大的三层路由功能和二层网络高效的转发机制，所以目前MPLS主要应用于VPN技术，TE（Traffic Engineering，流量工程）以及QOS（Quality of Service，服务质量）。</p> 
<p>        提示：基于MPLS的VPN通过LSP将私有网络的不同分支连接起来，形成一个统一的网络，用户设备无需为VPN配置GRE、L2TP等隧道；网络延时也会被降至最低。</p> 
<h6><strong>        MPLS体系结构 ：</strong></h6> 
<p>        控制平面：负责产生和维护路由以及标签信息；包括IP路由协议和路由信息表，标签分发协议和标签信息表<br>         转发平面：也称数据平面，负责普通IP报文的转及带MPLS标签报文的转发；转发平面包括转发信息表和标签转发信息表</p> 
<p>       <strong> LSR</strong>：Label Switching Router，标签交换路由器，由LSR 构成的网络区域称为 MPLS域（MPLS Domain），在 IP 网络内进行传统的 IP 转发，在 MPLS 域内进行标签转发。<br>      <strong>   LER</strong>：Label EdgeRouter位于 MPLS 域边缘、连接其它网络的边缘路由器，进入到MPLS网络的流量由LER分为不同的FEC；<br>         <strong>Core LSR</strong>：区域内部的 LSR 称为核心 LSR。</p> 
<p><strong>        LSR分类：</strong><br> Ingress LSR        入站标签，压入MPLS头部并生成MPLS报文的LSR<br> Transit LSR        中转LSR，做标签转换操作<br> Egrss LSR         出站LSR，做剥离MPLS标签操作</p> 
<p>       <strong> LSP</strong>：Label Switch Path 标签交换通道</p> 
<p>   <strong>     LDP</strong>：Label Distribution Protocol，标签分发协议是MPLS的一种控制协议，相当于传统网络中的信令协议，负责FEC的分类、标签的分配及LSP的建立和维护等操作。LDP规定了标签分发过程中的各种消息及相关处理过程。</p> 
<p>      <strong>  LSP</strong>：Label Switch Path，标签交换路径|通道，是标签报文穿越MPLS网络到达目的地所走的路径，LSP是单向的路径，和数据流的方向一致同一个FEC的报文通常采用相同的LSP穿越MPLS域，所以对同一个FEC，LSR总是用相同的标签转发。</p> 
<p><strong>        Label Stack</strong>：MPLS支持一层或者多层标签头部，这些标签头部的有序集合被称为标签栈</p> 
<p>        <strong>FEC</strong>：Forwarding Equivalence Class，转发等价类，是一组具有某些共性的数据流的集合，这些数据流在转发过程中被网络节点以相同方式处理，MPLS基于FEC发放标签；在转发过程中以等价的方式来标识创建FEC，通常的MPLS只是一条路由对应一个FEC<br>         在MPLS网络中，FEC可通过多种方式划分，如基于目的IP及网络掩码、DSCP等特征来划分<br> 数据属于另一个LSP，由数据 进入MPLS域时的Ingress LSR 决定<br>         MPLS标签通常是与FEC相对应的，必须有某种机制使得网络中的LSR获得关于某FEC的标签信息</p> 
<p>     <strong>   LSR ID与LDP ID</strong><br> 每一台运行LDP的LSR除了必须 配置LSR ID，还必须有LDP ID<br> LDP长度为48bit，由32bit的LSR ID与16 bit的空间标识符（Label Space ID）栬 <br> LDP ID以“LSR ID：标签空间标识 ”的形式呈现，如1.1.1.1:0</p> 
<p>      <strong>  LIB</strong>：Label Information Base，查看用dis mpls ldp lsp</p> 
<p>      <strong>  LFIB</strong>：Label Forwarding Information，来源于LIB表，查看用dis mpls lsp</p> 
<p>        <strong>PHP</strong>： Penultimate Hop Popping，倒数第二跳弹出</p> 
<h6><strong>        LDP的工作过程主要分为两部分：</strong></h6> 
<p>        1、LSR之间建立LDP会话<br>         2、LSR之间基于LDP会话动态交换标签与FEC映射信息，并根据标签信息建立 LSP</p> 
<h6>        LDP会话：        </h6> 
<p>        LSR之间交互标签绑定消息之前必须建立 LDP会话，会话分为：<br>         1、本地LDP会话（Local LDP Session），建立 会话的两个LSP之间是直连的<br>         2、远程LDP会议（Remote LDP Session）：建立 会话的两个LSP可以是直连的，也可以是非直连的。<br>         两台LSR之间交互Hello消息后，即建立 起邻接体（Adjacency）关系；在建立邻接体关系基础上，两台LSR之间交互LDP会话消息，建立LDP会话，两台设备之间形成LDP对等体关系</p> 
<h6>        LDP连接阶段：</h6> 
<p>        1、Discover：<br>         LDP邻居发现，会在链路上周期性地发送hello报文（UDP端口号646）给组播包224.0.0.2，用dis mpls ldp peer | adjacency去看，里面有个Transport地址，包含自己的环回口地址或者说lsr-id地址。设备通过周期性地发送LDP链路Hello报文（LDP Link Hello），实现LDP基本发现机制，收到报文表明该接口存在LDP邻接体</p> 
<p>        2、Session：<br>         TCP连接|会话阶段：Hello报文携带传输地址Transport，双方后续 将使用传输地址建立 LDP会话；经过TCP三次握手之后，由大的Transport地址（lsr-id）向小的Transport地址通过tcp646连接，发送init报文，双方建立连接，用dis mpls ldp sseion去看，这时是NonExistent状态，因为这里没有建立路由连接，建立路由后，就可以看到mpls会话建立起来了，状态为Operational，最终状态。这里看会话也可以用dis tcp status看一下：LAM是标签通告管理，DU表示下游自主。Label Space ID值为0是基于平台的，看LSP时，入接口为<strong> - </strong>说明是基于平台的，基于接口的，入接口为接口值<br>         会话建立过程中，会交互init、keepalive报文<br>         NonExistent --&gt; Initialized --&gt; Opensent --&gt; Openreceive --&gt; Operational<br>                 dis mpls ldp session<br>                 debugging mpls  ldp session<br>                 reset mpls ldp <br>         到Operational状态，已经可以看到lsp了：dis mpls lsp</p> 
<p>        3、Advertisement：</p> 
<p>        通告阶段：用于创建、改变和删除特定FEC-标签绑定</p> 
<p>        4、Notification：</p> 
<p>        通知阶段：如果出错了发的报文</p> 
<h6>        LSR处理报文时主要根据ILM、FTN、NHLFE、</h6> 
<p>        FTN：FEC-to-NHLFE，当LSR收到IP报文并需要进行MPLS转发时使用，只在Ingress存在<br>                     包括：Tunnel ID、FEC到NHLFE的映射信息<br>         NHLFE：Next Hop Label Forwardiing Entry，LSR对报文（MPLS或IP报文）进行MPLS转发时使用，在Ingress和Transit存在<br>                     包括：Tunnel ID、出接口、下一跳、出标签、标签操作类型等<br>         ILM：Incoming Label Map，用于指导MPLS报文的转发（MPLS或IP转发），ILM只在Transit和Egress存在<br>                     包括：Tunnel ID、入标签、入接口、标签操作类型等</p> 
<h6>        !!!        LDP运行过程：</h6> 
<p>        1、比如说去往3的路由，查FIB表，发现里面的TunnelID为0，说明不需要走隧道，进入FIB表转发，如果为非0，则要压入标签：</p> 
<p>              dis fib 3.3.3.3 32</p> 
<p>        2、压标签查标签表：<br>             dis mpls lsp lsp include 3.3.3.3 32 verbose<br>             标签操作：<br>             Ingress    Transit    Egress<br>             Push    Swap    Pop</p> 
<h6>        LSP连接类型：</h6> 
<p>        1、静态LSP是用户通过手工为各个FEC分配标签而建立 的。<br>         静态不使用标签发布协议，不需要交互控制报文，因此消耗资源比较小<br>         通过静态方式建立 的LSP不能根据网络拓朴变化 动态调整，需要管理员干预<br>         适用于拓朴简单且稳定的小型网络<br>         前一节点出标签值=下一节点入标签值<br>         2、动态LSP通过标签发布协议动态建立 ，也称为信令协议，负责FEC的分类、标签分发及LSP的建立 和维护等一系列操作<br>         常用标签分发协议：LDP，Label Distribution Protocol<br>         LDP广泛应用于VPN服务上，具有组网、配置简单、支持基于路由动态建立 LSP、支持大容量LSP等优点</p> 
<h6>        MPLS报文解析：</h6> 
<p>        在二层和三层之间，又称为2.5层，一个标签报文可以包含一个多个MPLS标签</p> 
<p>        Label：20bit，用于携带标签值 ，长度20bit<br>         EXP：Experimental Use，主要用于CoS（Class of Service），长度3bit，（相当于QOS ，如IP的TOS，二层的PRI也都属于QOS标志）<br>         S：（bottom of Stack）栈底位，用于指示该标签头部 是否为最后一层标签，0表示 当前 标签头部 后还有其他标签头部<br>         TTL：Time To Live，用于当网络出现环路时，防止标签报文被无限转发，与IP报文的TTL具有相同的意义</p> 
<h6><strong>        MPLS消息类型：</strong></h6> 
<p><strong>Discovery Message </strong>       Hello             UDP        LDP发现机制中宣告本LSR并发现邻居<br><strong>Session Message  </strong>      Initialization      TCP        在LDP Session建立过程中协商参数    <br>                                      Keepalive          TCP        监控LDP Session的TCP连接的完整性<br><strong>Advertisement Message </strong>   Address     TCP        宣告接口地址<br>                           Address Withdraw        TCP        撤销接口地址<br>                             Label Mapping            TCP        宣告FEC、Label映射信息<br>                             Label Request             TCP       请求FEC的标签映射<br>                             Label Abort Request    TCP       终止未完成的Label Request Message<br>                             Label Withdraw            TCP       撤销FEC/Label映射<br>                             Label Release              TCP       释放标签<br><strong>Notication Message  </strong>      Notification      TCP      通知LDP Peer错误信息</p> 
<h6><strong>        标签的发布和管理：</strong></h6> 
<p>        在MPLS网络中，下游LSR决定标签和FEC的绑定关系，并将这种绑定关系发布给上游LSR<br>         标签发布方式Label Advertisement Mode：<br>         DU模式Downloadstream Unsolicited：下游自主方式<br>             对于一个特定的FEC，LSR无需从上游获得标签请求消息即进行标签分配与分发<br>             LSR会主动将自己为FEC捆绑的标签通告给上游邻居，无需邻居先发起请求再通行<br>         DoD模式Downstream on Demand：下游按需方式<br>             对于一个特定的FEC，LSR获得标签请求消息之后才进行标签分配与分发<br>             一般情况下，对特定FEC的访问需求会触发标签请求消息<br>         标签分配控制方式Label Distribution Control Mode：<br>             Independent独立方式：本地LSR可以自主地分配一个标签绑定到某个FEC，并通告给上游LSR，而无需等待下游的标签<br>             Ordered有序方式：对于LSR上某个FEC的标签映射 ，只有当该LSR已经已经具有此FEC下一跳的标签映射 消息、或者该LSR就是此FEC的出节点时，该LSR才向上游发送此标签的映射 <br>             配置命令：label distribution control-mode {independent | ordered}<br>         标签保持方式Label Retention Mode：<br>             Liberal自由模式：LSR收到的标签映射 可能 来自下一跳，也可能来自非下一跳；对于从邻居LSR收到的标签映射 ，无论邻居LSR是不是自己的下一跳都保留<br>             Conservative保守模式：对于从邻居LSR收到的标签映射 ，只有当邻居LSR是自己的下一跳时才保留</p> 
<h6><strong>        标签操作：</strong></h6> 
<p>        Push：当IP报文进入MPLS域时，LER在报文二层头部和IP头部之间插入一个新标签；或者中间设备根据需要，要标签栈顶增加一个新标签（标签嵌套封装）<br>         Swap：当报文在MPLS域内转发时，根据LFIB表，用下一跳分配的标签，替换MPLS的栈顶标签<br>         Pop：当报文离开MPLS域时，将MPLS报文的标签剥掉</p> 
<h6>        MPLS报文格式：</h6> 
<p>        0-20位    21-23    24    25-32<br>         label    CoS    S    TTL</p> 
<h6><strong>        MPLS报文label字段（0-19位）标签值解析：</strong></h6> 
<p>        0-15：特殊标签<br>          值为0：IPV4 Explicit NULL Label 显式空标签，给QOS用的，LER需要看的空标签，表示里面还有EXP位要看<br>         值为1：Router Alert Label<br>         值为2：IPV6显式空标签<br>         值为3：隐式空标签，LER不需要看的空标签，次末跳，倒数第二跳，PHP（pemultimate hop popping）次末跳弹 出，置换给它一个3标签，让出站的LER直接剥离MPLS头部，即不再查LFIB（Label Forwarding Imformation Base）表，直接剥离LSP，直接进入IP转发或者下一层标签转发（减少最后一跳的负担，减少查表次数）<br>         4~13、15：保留<br>         14：OAM Router Alert Label，Operation Administration &amp;Maintenance，通过发送OAM报文检测和通告LSP故障，使用MPLS承载，对于Transit LSR和Penultimate LSR是透明的<br>         16-1023：静态LSP和静态CR-LSP（Constraint-Based Routed Label Switched Path）共享的标签空间<br>         1024及以上：LDP、RSVP-TE、MP-BGP等动态信令协议的标签空间；动态信令协议的标签空间不是共享的，而是独立且连续的，互不影响</p> 
<h6>二、拓朴图：</h6> 
<p><img alt="" height="309" src="https://images2.imgbox.com/91/2d/g3I9Uu3N_o.png" width="1122"></p> 
<h6>三、主要配置步骤：</h6> 
<ol><li>配置IGP协议，使MPLS域内路由互通</li><li>配置MPLS lsr-id，开启mpls协议，为IGP路由触发建立标签，默认情况下，只为32位路由建立 标签，这里设置为所有非32位的路由都发标签</li><li>接口开启mpls、开启mpls ldp标签分发协议</li></ol> 
<h6>四、主要配置命令：</h6> 
<pre><code>#
mpls lsr-id 2.2.2.2
mpls
 lsp-trigger all 
#
int G0/0/0
 mpls
 mpls ldp
#
dis mpls lsp
dis mpls ldp peer
dis mpls ldp session

</code></pre> 
<h6>五、测试：</h6> 
<p>ping测试中抓包，可以看到mpls是在2层和3层之间的协议：</p> 
<p><img alt="" height="224" src="https://images2.imgbox.com/29/dd/oJZW096A_o.png" width="1043"></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b180a9ef7f443fc3dea89623cb99c9e5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">linux stop_machine 停机机制应用及一次触发 soft lockup 分析</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/505fe471d03e8dabbf23bd6902ce6027/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">ue4-第三人称-教程笔记9AI</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>