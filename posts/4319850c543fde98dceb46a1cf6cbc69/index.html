<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>DMA简单理解和分享 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="DMA简单理解和分享" />
<meta property="og:description" content="一、DMA基本概念 直接存储器访问（Direct Memory Access），简称DMA。DMA是CPU一个用于数据从一个地址空间到另一地址空间“搬运”（拷贝）的组件，数据拷贝过程不需CPU干预，数据拷贝结束则通知CPU处理。因此，大量数据拷贝时，使用DMA可以释放CPU资源。DMA数据拷贝过程，典型的有：
内存—&gt;内存，内存间拷贝外设—&gt;内存，如uart、spi、i2c等总线接收数据过程内存—&gt;外设，如uart、spi、i2c等总线发送数据过程 二、DMA一些应用场景 1、ADC与DMA （1）AD单次启动&#43;软件启动&#43;查询/中断方式 ------------------------------------------------------------------------- var = Get_Adc_Average(ADC_CHANNEL_0, 10); //放大倍数为0.635 Sys.adc1 = var * 3300 / 4096 * 1.574 &#43; 10; ---------------------------------------------------------------------------- u16 Get_Adc(u32 ch) { ADC_ChannelConfTypeDef ADC1_ChanConf; ADC1_ChanConf.Channel=ch; ADC1_ChanConf.Rank=1; ADC1_ChanConf.SamplingTime=ADC_SAMPLETIME_480CYCLES; ADC1_ChanConf.Offset=0; HAL_ADC_ConfigChannel(&amp;hadc1,&amp;ADC1_ChanConf); HAL_ADC_Start(&amp;hadc1); HAL_ADC_PollForConversion(&amp;hadc1,10); return (u16)HAL_ADC_GetValue(&amp;hadc1); } u16 Get_Adc_Average(u32 ch,u8 times) { u32 temp_val=0; u8 t; for(t=0;t&lt;times;t&#43;&#43;) { temp_val&#43;=Get_Adc(ch); osDelay(5); } return temp_val/times; } （2）连续转换&#43;DMA&#43;手动启动/定时器启动 在方法1里面，每次转换完成，需要我们手动去读一下AD值；启动DMA之后，完全省掉了这个过程，只需要等待设定好的值全部转换完成之后触发一个中断，再进行数据处理。
/** * @brief adc01的配置 规则通道并行 扫描和连续转换模式 */ static void bsp_adc01_cfg(void) { /* enable ADC0 and ADC1 clock */ rcu_periph_clock_enable(RCU_ADC0); rcu_periph_clock_enable(RCU_ADC1); /* config ADC clock */ rcu_adc_clock_config(RCU_CKADC_CKAPB2_DIV16); /* ADC continous function enable */ adc_special_function_config(ADC0, ADC_SCAN_MODE, ENABLE); adc_special_function_config(ADC0, ADC_CONTINUOUS_MODE, ENABLE); adc_special_function_config(ADC1, ADC_SCAN_MODE, ENABLE); adc_special_function_config(ADC1, ADC_CONTINUOUS_MODE, ENABLE); /* ADC trigger config */ adc_external_trigger_source_config(ADC0, ADC_REGULAR_CHANNEL, ADC0_1_EXTTRIG_REGULAR_NONE);//ADC0_1_EXTTRIG_REGULAR_NONE adc_external_trigger_source_config(ADC1, ADC_REGULAR_CHANNEL, ADC0_1_EXTTRIG_REGULAR_NONE);//ADC0_1_EXTTRIG_INSERTED_NONE /* ADC data alignment config */ adc_data_alignment_config(ADC0, ADC_DATAALIGN_RIGHT); adc_data_alignment_config(ADC1, ADC_DATAALIGN_RIGHT); /* ADC mode config,使用规则同步模式,ADC0是主,ADC1是从, 同时转换两个通道(同时转换的通道不能相同) */ adc_mode_config(ADC_DAUL_REGULAL_PARALLEL); /* ADC分辨率 12B */ adc_resolution_config(ADC0,ADC_RESOLUTION_12B); adc_resolution_config(ADC1,ADC_RESOLUTION_12B); /* ADC channel length config */ adc_channel_length_config(ADC0, ADC_REGULAR_CHANNEL, 6); adc_channel_length_config(ADC1, ADC_REGULAR_CHANNEL, 0); /* ADC regular channel config,一个通道转换时长是2." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/4319850c543fde98dceb46a1cf6cbc69/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-01T15:51:15+08:00" />
<meta property="article:modified_time" content="2022-12-01T15:51:15+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">DMA简单理解和分享</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="DMA_0"></a>一、DMA基本概念</h2> 
<p>直接存储器访问（Direct Memory Access），简称DMA。DMA是CPU一个用于数据从一个地址空间到另一地址空间“搬运”（拷贝）的组件，数据拷贝过程不需CPU干预，数据拷贝结束则通知CPU处理。因此，大量数据拷贝时，使用DMA可以释放CPU资源。DMA数据拷贝过程，典型的有：</p> 
<ul><li>内存—&gt;内存，内存间拷贝</li><li>外设—&gt;内存，如uart、spi、i2c等总线接收数据过程</li><li>内存—&gt;外设，如uart、spi、i2c等总线发送数据过程</li></ul> 
<h2><a id="DMA_5"></a>二、DMA一些应用场景</h2> 
<h3><a id="1ADCDMA_6"></a>1、ADC与DMA</h3> 
<h4><a id="1AD_7"></a>（1）AD单次启动+软件启动+查询/中断方式</h4> 
<pre><code class="prism language-c"><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
var <span class="token operator">=</span> <span class="token function">Get_Adc_Average</span><span class="token punctuation">(</span>ADC_CHANNEL_0<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//放大倍数为0.635</span>
 Sys<span class="token punctuation">.</span>adc1 <span class="token operator">=</span> var <span class="token operator">*</span> <span class="token number">3300</span> <span class="token operator">/</span> <span class="token number">4096</span> <span class="token operator">*</span> <span class="token number">1.574</span> <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">;</span>
 <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
 u16 <span class="token function">Get_Adc</span><span class="token punctuation">(</span>u32 ch<span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>
 ADC_ChannelConfTypeDef ADC1_ChanConf<span class="token punctuation">;</span>
 ADC1_ChanConf<span class="token punctuation">.</span>Channel<span class="token operator">=</span>ch<span class="token punctuation">;</span> 
 ADC1_ChanConf<span class="token punctuation">.</span>Rank<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> 
 ADC1_ChanConf<span class="token punctuation">.</span>SamplingTime<span class="token operator">=</span>ADC_SAMPLETIME_480CYCLES<span class="token punctuation">;</span> 
 ADC1_ChanConf<span class="token punctuation">.</span>Offset<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
 <span class="token function">HAL_ADC_ConfigChannel</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hadc1<span class="token punctuation">,</span><span class="token operator">&amp;</span>ADC1_ChanConf<span class="token punctuation">)</span><span class="token punctuation">;</span> 
 <span class="token function">HAL_ADC_Start</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hadc1<span class="token punctuation">)</span><span class="token punctuation">;</span> 
 <span class="token function">HAL_ADC_PollForConversion</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hadc1<span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">return</span> <span class="token punctuation">(</span>u16<span class="token punctuation">)</span><span class="token function">HAL_ADC_GetValue</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hadc1<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
u16 <span class="token function">Get_Adc_Average</span><span class="token punctuation">(</span>u32 ch<span class="token punctuation">,</span>u8 times<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  u32 temp_val<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
  u8 t<span class="token punctuation">;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span>t<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>t<span class="token operator">&lt;</span>times<span class="token punctuation">;</span>t<span class="token operator">++</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
  temp_val<span class="token operator">+=</span><span class="token function">Get_Adc</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">osDelay</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> temp_val<span class="token operator">/</span>times<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="2DMA_38"></a>（2）连续转换+DMA+手动启动/定时器启动</h4> 
<p>在方法1里面，每次转换完成，需要我们手动去读一下AD值；启动DMA之后，完全省掉了这个过程，只需要等待设定好的值全部转换完成之后触发一个中断，再进行数据处理。</p> 
<pre><code class="prism language-c"><span class="token comment">/**
 * @brief adc01的配置 规则通道并行   扫描和连续转换模式 
 */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">bsp_adc01_cfg</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>    
    <span class="token comment">/* enable ADC0 and ADC1 clock */</span>
    <span class="token function">rcu_periph_clock_enable</span><span class="token punctuation">(</span>RCU_ADC0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">rcu_periph_clock_enable</span><span class="token punctuation">(</span>RCU_ADC1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* config ADC clock */</span>
    <span class="token function">rcu_adc_clock_config</span><span class="token punctuation">(</span>RCU_CKADC_CKAPB2_DIV16<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* ADC continous function enable */</span>
    <span class="token function">adc_special_function_config</span><span class="token punctuation">(</span>ADC0<span class="token punctuation">,</span> ADC_SCAN_MODE<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">adc_special_function_config</span><span class="token punctuation">(</span>ADC0<span class="token punctuation">,</span> ADC_CONTINUOUS_MODE<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token function">adc_special_function_config</span><span class="token punctuation">(</span>ADC1<span class="token punctuation">,</span> ADC_SCAN_MODE<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">adc_special_function_config</span><span class="token punctuation">(</span>ADC1<span class="token punctuation">,</span> ADC_CONTINUOUS_MODE<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    
    <span class="token comment">/* ADC trigger config */</span>
    <span class="token function">adc_external_trigger_source_config</span><span class="token punctuation">(</span>ADC0<span class="token punctuation">,</span> ADC_REGULAR_CHANNEL<span class="token punctuation">,</span> ADC0_1_EXTTRIG_REGULAR_NONE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ADC0_1_EXTTRIG_REGULAR_NONE</span>
    <span class="token function">adc_external_trigger_source_config</span><span class="token punctuation">(</span>ADC1<span class="token punctuation">,</span> ADC_REGULAR_CHANNEL<span class="token punctuation">,</span> ADC0_1_EXTTRIG_REGULAR_NONE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ADC0_1_EXTTRIG_INSERTED_NONE     </span>
        
    <span class="token comment">/* ADC data alignment config */</span>
    <span class="token function">adc_data_alignment_config</span><span class="token punctuation">(</span>ADC0<span class="token punctuation">,</span> ADC_DATAALIGN_RIGHT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">adc_data_alignment_config</span><span class="token punctuation">(</span>ADC1<span class="token punctuation">,</span> ADC_DATAALIGN_RIGHT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* ADC mode config,使用规则同步模式,ADC0是主,ADC1是从, 同时转换两个通道(同时转换的通道不能相同) */</span>
    <span class="token function">adc_mode_config</span><span class="token punctuation">(</span>ADC_DAUL_REGULAL_PARALLEL<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    
    <span class="token comment">/* ADC分辨率 12B */</span>
    <span class="token function">adc_resolution_config</span><span class="token punctuation">(</span>ADC0<span class="token punctuation">,</span>ADC_RESOLUTION_12B<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">adc_resolution_config</span><span class="token punctuation">(</span>ADC1<span class="token punctuation">,</span>ADC_RESOLUTION_12B<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* ADC channel length config */</span>
    <span class="token function">adc_channel_length_config</span><span class="token punctuation">(</span>ADC0<span class="token punctuation">,</span> ADC_REGULAR_CHANNEL<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">adc_channel_length_config</span><span class="token punctuation">(</span>ADC1<span class="token punctuation">,</span> ADC_REGULAR_CHANNEL<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    
    <span class="token comment">/* ADC regular channel config,一个通道转换时长是2.06us */</span>
    <span class="token function">adc_regular_channel_config</span><span class="token punctuation">(</span>ADC0<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ADC_CHANNEL_6<span class="token punctuation">,</span> ADC_SAMPLETIME_239POINT5<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">adc_regular_channel_config</span><span class="token punctuation">(</span>ADC0<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> ADC_CHANNEL_7<span class="token punctuation">,</span> ADC_SAMPLETIME_239POINT5<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">adc_regular_channel_config</span><span class="token punctuation">(</span>ADC0<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> ADC_CHANNEL_14<span class="token punctuation">,</span> ADC_SAMPLETIME_239POINT5<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//adc_regular_channel_config(ADC0, 3, ADC_CHANNEL_7, ADC_SAMPLETIME_55POINT5);</span>
    <span class="token comment">//adc_regular_channel_config(ADC0, 4, ADC_CHANNEL_8, ADC_SAMPLETIME_55POINT5);</span>
        
    <span class="token function">adc_regular_channel_config</span><span class="token punctuation">(</span>ADC0<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> ADC_CHANNEL_15<span class="token punctuation">,</span> ADC_SAMPLETIME_239POINT5<span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token function">adc_regular_channel_config</span><span class="token punctuation">(</span>ADC0<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> ADC_CHANNEL_8<span class="token punctuation">,</span> ADC_SAMPLETIME_239POINT5<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">adc_regular_channel_config</span><span class="token punctuation">(</span>ADC0<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> ADC_CHANNEL_9<span class="token punctuation">,</span> ADC_SAMPLETIME_239POINT5<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// adc_regular_channel_config(ADC1, 3, ADC_CHANNEL_15, ADC_SAMPLETIME_55POINT5);</span>
    <span class="token comment">//adc_regular_channel_config(ADC1, 4, ADC_CHANNEL_5, ADC_SAMPLETIME_55POINT5);</span>
    
    <span class="token comment">/* ADC external trigger enable */</span>
    <span class="token function">adc_external_trigger_config</span><span class="token punctuation">(</span>ADC0<span class="token punctuation">,</span> ADC_REGULAR_CHANNEL<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token function">adc_external_trigger_config</span><span class="token punctuation">(</span>ADC1<span class="token punctuation">,</span> ADC_REGULAR_CHANNEL<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>    

    <span class="token comment">/* enable ADC0 interface */</span>
    <span class="token function">adc_enable</span><span class="token punctuation">(</span>ADC0<span class="token punctuation">)</span><span class="token punctuation">;</span>      
    <span class="token comment">//delay_ms(0xFFFF);</span>
    <span class="token comment">/* ADC0 calibration and reset calibration */</span>
    <span class="token function">adc_calibration_enable</span><span class="token punctuation">(</span>ADC0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* enable ADC1 interface */</span>
    <span class="token function">adc_enable</span><span class="token punctuation">(</span>ADC1<span class="token punctuation">)</span><span class="token punctuation">;</span>      
    <span class="token comment">//delay_ms(0xFFFF);</span>
    <span class="token comment">/* ADC1 calibration and reset calibration */</span>
    <span class="token function">adc_calibration_enable</span><span class="token punctuation">(</span>ADC1<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* ADC校准复位 */</span>  
    
    <span class="token comment">/* ADC DMA function enable */</span>
    <span class="token function">adc_dma_mode_enable</span><span class="token punctuation">(</span>ADC0<span class="token punctuation">)</span><span class="token punctuation">;</span>        
    
    <span class="token comment">/* ADC0 software trigger enable */</span>
     <span class="token function">adc_software_trigger_enable</span><span class="token punctuation">(</span>ADC0<span class="token punctuation">,</span> ADC_REGULAR_CHANNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">adc_software_trigger_enable</span><span class="token punctuation">(</span>ADC1<span class="token punctuation">,</span> ADC_REGULAR_CHANNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">uint16_t</span> adc01_fifo<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">/**
  * @brief ADC01 DMA配置
  * @retval none
  * @author Mr.W
  * @date 2020-11-10
  */</span>
<span class="token keyword">void</span> <span class="token function">bsp_adc01_dma_cfg</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">/* ADC_DMA_channel configuration */</span>
    dma_parameter_struct dma_data_parameter<span class="token punctuation">;</span>
    <span class="token comment">/* enable DMA0 clock */</span>
    <span class="token function">rcu_periph_clock_enable</span><span class="token punctuation">(</span>RCU_DMA0<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token comment">/* ADC DMA_channel configuration */</span>
    <span class="token function">dma_deinit</span><span class="token punctuation">(</span>DMA0<span class="token punctuation">,</span> DMA_CH0<span class="token punctuation">)</span><span class="token punctuation">;</span>
   
    <span class="token comment">/* initialize DMA data mode */</span>
    dma_data_parameter<span class="token punctuation">.</span>periph_addr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token function">ADC_RDATA</span><span class="token punctuation">(</span>ADC0<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dma_data_parameter<span class="token punctuation">.</span>periph_inc <span class="token operator">=</span> DMA_PERIPH_INCREASE_DISABLE<span class="token punctuation">;</span>
    dma_data_parameter<span class="token punctuation">.</span>memory_addr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>g_sys<span class="token punctuation">.</span>adcs<span class="token punctuation">.</span>fifo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dma_data_parameter<span class="token punctuation">.</span>memory_inc <span class="token operator">=</span> DMA_MEMORY_INCREASE_ENABLE<span class="token punctuation">;</span>
    dma_data_parameter<span class="token punctuation">.</span>periph_width <span class="token operator">=</span> DMA_PERIPHERAL_WIDTH_16BIT<span class="token punctuation">;</span>
    dma_data_parameter<span class="token punctuation">.</span>memory_width <span class="token operator">=</span> DMA_MEMORY_WIDTH_16BIT<span class="token punctuation">;</span>  
    dma_data_parameter<span class="token punctuation">.</span>direction <span class="token operator">=</span> DMA_PERIPHERAL_TO_MEMORY<span class="token punctuation">;</span>
    dma_data_parameter<span class="token punctuation">.</span>number <span class="token operator">=</span> ADCFILTER_NUM<span class="token operator">*</span>ADCCHANNEL_NUM<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>    <span class="token comment">/* 搬运的数据个数，完成后会触发中断*/</span>
    dma_data_parameter<span class="token punctuation">.</span>priority <span class="token operator">=</span> DMA_PRIORITY_HIGH<span class="token punctuation">;</span>
    <span class="token function">dma_init</span><span class="token punctuation">(</span>DMA0<span class="token punctuation">,</span> DMA_CH0<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dma_data_parameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">dma_circulation_enable</span><span class="token punctuation">(</span>DMA0<span class="token punctuation">,</span> DMA_CH0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//设置dma中断优先级</span>
    <span class="token function">nvic_irq_enable</span><span class="token punctuation">(</span>DMA0_Channel0_IRQn<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* enable DMA transfer complete interrupt */</span>
    <span class="token function">dma_interrupt_enable</span><span class="token punctuation">(</span>DMA0<span class="token punctuation">,</span>DMA_CH0<span class="token punctuation">,</span> DMA_INT_HTF<span class="token operator">|</span>DMA_INT_FTF<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//半传输/全传输中断都开启</span>
    <span class="token comment">/* enable DMA channel */</span>
    <span class="token function">dma_channel_enable</span><span class="token punctuation">(</span>DMA0<span class="token punctuation">,</span> DMA_CH0<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">DMA0_Channel0_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">dma_interrupt_flag_get</span><span class="token punctuation">(</span>DMA0<span class="token punctuation">,</span>DMA_CH0<span class="token punctuation">,</span> DMA_INT_HTF<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//半传输完成</span>
    <span class="token punctuation">{<!-- --></span>    
        g_sys<span class="token punctuation">.</span>adcs<span class="token punctuation">.</span>dma_half1<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">dma_interrupt_flag_get</span><span class="token punctuation">(</span>DMA0<span class="token punctuation">,</span>DMA_CH0<span class="token punctuation">,</span> DMA_INT_FTF<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//全部传输完成</span>
    <span class="token punctuation">{<!-- --></span>
        g_sys<span class="token punctuation">.</span>adcs<span class="token punctuation">.</span>dma_half2<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>        
    <span class="token punctuation">}</span> 
    <span class="token comment">//清除全部标志位</span>
    <span class="token function">dma_interrupt_flag_clear</span><span class="token punctuation">(</span>DMA0<span class="token punctuation">,</span>DMA_CH0<span class="token punctuation">,</span> DMA_INT_FLAG_G<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">rt_sem_release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sem_adc_dma<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 释放信号量 */</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">calcaulate_anlog</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
   <span class="token class-name">uint32_t</span> sum_data<span class="token punctuation">[</span>ADCCHANNEL_NUM<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
   <span class="token class-name">uint16_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token class-name">uint16_t</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token comment">// int16_t var1=0;</span>
   <span class="token keyword">static</span> <span class="token class-name">uint8_t</span> cnt_tsk <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token keyword">static</span> <span class="token class-name">uint8_t</span> cnt_cluth <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token keyword">static</span> <span class="token class-name">uint16_t</span> cnt2_cluth <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token keyword">static</span> <span class="token class-name">int16_t</span> judge_cluth_data_before <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token keyword">static</span> <span class="token class-name">int16_t</span> judge_cluth_data_now <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>g_sys<span class="token punctuation">.</span>adcs<span class="token punctuation">.</span>dma_half1 <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
   <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ADCFILTER_NUM<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
      <span class="token punctuation">{<!-- --></span>
         <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> ADCCHANNEL_NUM<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
            sum_data<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">+=</span> g_sys<span class="token punctuation">.</span>adcs<span class="token punctuation">.</span>fifo<span class="token punctuation">[</span>j <span class="token operator">+</span> i <span class="token operator">*</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> ADCCHANNEL_NUM<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
      <span class="token punctuation">{<!-- --></span>
         g_sys<span class="token punctuation">.</span>adcs<span class="token punctuation">.</span>average_adc<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> sum_data<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">/</span> ADCFILTER_NUM<span class="token punctuation">;</span>
         sum_data<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>g_sys<span class="token punctuation">.</span>adcs<span class="token punctuation">.</span>dma_half2 <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// half2数据暂时舍弃</span>
   <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// for(i=0;i&lt;ADCFILTER_NUM;i++)</span>
      <span class="token comment">//   {<!-- --></span>
      <span class="token comment">//       for(j=0;j&lt;ADCCHANNEL_NUM;j++)</span>
      <span class="token comment">//       sum_data[j]+=g_sys.adcs.fifo[j+i*6+ADCCHANNEL_NUM*ADCFILTER_NUM];</span>
      <span class="token comment">//   }</span>
      <span class="token comment">//   for(j=0;j&lt;ADCCHANNEL_NUM;j++)</span>
      <span class="token comment">//   {<!-- --></span>
      <span class="token comment">//     g_sys.adcs.average_adc[j]= sum_data[j]/ADCFILTER_NUM;</span>
      <span class="token comment">//     sum_data[j]=0;</span>
      <span class="token comment">//   }</span>
   <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="2DMA_207"></a>2、串口与DMA</h3> 
<p>串口(uart)是一种低速的串行异步通信，适用于低速通信场景，通常使用的波特率小于或等于115200bps。对于小于或者等于115200bps波特率的，而且数据量不大的通信场景，一般没必要使用DMA，或者说使用DMA并未能充分发挥出DMA的作用。<br> 对于数量大，或者波特率提高时，必须使用DMA以释放CPU资源，因为高波特率可能带来这样的问题：</p> 
<ul><li>对于发送，使用循环发送，可能阻塞线程，需要消耗大量CPU资源“搬运”数据，浪费CPU</li><li>对于发送，使用中断发送，不会阻塞线程，但需浪费大量中断资源，CPU频繁响应中断；以115200bps波特率，1s传输11520字节，大约69us需响应一次中断，如波特率再提高，将消耗更多CPU资源</li><li>对于接收，如仍采用传统的中断模式接收，同样会因为频繁中断导致消耗大量CPU资源<br> 如下为某项目的环形DMA传输；</li></ul> 
<pre><code class="prism language-c"><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>  
      xResult <span class="token operator">=</span> <span class="token function">xSemaphoreTake</span><span class="token punctuation">(</span>g_xSemCntUart1_rxHandle<span class="token punctuation">,</span> portMAX_DELAY<span class="token punctuation">)</span> <span class="token punctuation">;</span>     <span class="token comment">// 任务代码中获取二值信号量  成功</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>xResult <span class="token operator">==</span> pdTRUE<span class="token punctuation">)</span>
      <span class="token punctuation">{<!-- --></span>
          <span class="token function">taskENTER_CRITICAL</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>              
          <span class="token function">memset</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>g_uart1_temp_buf<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>U1_BUFSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>  
          <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"串口1的接收数据位置 :  %d  %d\r\n"</span><span class="token punctuation">,</span>g_uart1_recv<span class="token punctuation">.</span>tail<span class="token punctuation">,</span> g_uart1_recv<span class="token punctuation">.</span>head<span class="token punctuation">)</span><span class="token punctuation">;</span>                 
          size<span class="token operator">=</span> <span class="token function">ring_used_buf_get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>g_uart1_recv<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>g_uart1_temp_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>             
          <span class="token function">taskEXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">;</span> 
          <span class="token comment">//printf("串口1接收数据为 ： %s\r\n",g_uart1_temp_buf);                       </span>
          <span class="token function">uart_send_data</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart3<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>g_uart1_temp_buf<span class="token punctuation">,</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>          
      <span class="token punctuation">}</span> 
      <span class="token keyword">else</span>
      <span class="token punctuation">{<!-- --></span>
           <span class="token function">Error_Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>       
  <span class="token punctuation">}</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
<span class="token comment">/**
串口1相关DMA部分初始化代码
**/</span>
<span class="token keyword">void</span> <span class="token function">init_related_usart1</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">/* USART1 DMA Init */</span>
    <span class="token comment">/* USART1_RX Init */</span>
    hdma_usart1_rx<span class="token punctuation">.</span>Instance <span class="token operator">=</span> DMA2_Stream2<span class="token punctuation">;</span>
    hdma_usart1_rx<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>Channel <span class="token operator">=</span> DMA_CHANNEL_4<span class="token punctuation">;</span>
    hdma_usart1_rx<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>Direction <span class="token operator">=</span> DMA_PERIPH_TO_MEMORY<span class="token punctuation">;</span>
    hdma_usart1_rx<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>PeriphInc <span class="token operator">=</span> DMA_PINC_DISABLE<span class="token punctuation">;</span>
    hdma_usart1_rx<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>MemInc <span class="token operator">=</span> DMA_MINC_ENABLE<span class="token punctuation">;</span>
    hdma_usart1_rx<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>PeriphDataAlignment <span class="token operator">=</span> DMA_PDATAALIGN_BYTE<span class="token punctuation">;</span>
    hdma_usart1_rx<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>MemDataAlignment <span class="token operator">=</span> DMA_MDATAALIGN_BYTE<span class="token punctuation">;</span>
    hdma_usart1_rx<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>Mode <span class="token operator">=</span> DMA_CIRCULAR<span class="token punctuation">;</span>
    hdma_usart1_rx<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>Priority <span class="token operator">=</span> DMA_PRIORITY_MEDIUM<span class="token punctuation">;</span>
    hdma_usart1_rx<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>FIFOMode <span class="token operator">=</span> DMA_FIFOMODE_DISABLE<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">HAL_DMA_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hdma_usart1_rx<span class="token punctuation">)</span> <span class="token operator">!=</span> HAL_OK<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token function">Error_Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">__HAL_LINKDMA</span><span class="token punctuation">(</span>uartHandle<span class="token punctuation">,</span>hdmarx<span class="token punctuation">,</span>hdma_usart1_rx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* USART1_TX Init */</span>
    hdma_usart1_tx<span class="token punctuation">.</span>Instance <span class="token operator">=</span> DMA2_Stream7<span class="token punctuation">;</span>
    hdma_usart1_tx<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>Channel <span class="token operator">=</span> DMA_CHANNEL_4<span class="token punctuation">;</span>
    hdma_usart1_tx<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>Direction <span class="token operator">=</span> DMA_MEMORY_TO_PERIPH<span class="token punctuation">;</span>
    hdma_usart1_tx<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>PeriphInc <span class="token operator">=</span> DMA_PINC_DISABLE<span class="token punctuation">;</span>
    hdma_usart1_tx<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>MemInc <span class="token operator">=</span> DMA_MINC_ENABLE<span class="token punctuation">;</span>
    hdma_usart1_tx<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>PeriphDataAlignment <span class="token operator">=</span> DMA_PDATAALIGN_BYTE<span class="token punctuation">;</span>
    hdma_usart1_tx<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>MemDataAlignment <span class="token operator">=</span> DMA_MDATAALIGN_BYTE<span class="token punctuation">;</span>
    hdma_usart1_tx<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>Mode <span class="token operator">=</span> DMA_NORMAL<span class="token punctuation">;</span>
    hdma_usart1_tx<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>Priority <span class="token operator">=</span> DMA_PRIORITY_MEDIUM<span class="token punctuation">;</span>
    hdma_usart1_tx<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>FIFOMode <span class="token operator">=</span> DMA_FIFOMODE_DISABLE<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">HAL_DMA_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hdma_usart1_tx<span class="token punctuation">)</span> <span class="token operator">!=</span> HAL_OK<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token function">Error_Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 <span class="token function">__HAL_LINKDMA</span><span class="token punctuation">(</span>uartHandle<span class="token punctuation">,</span>hdmatx<span class="token punctuation">,</span>hdma_usart1_tx<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
   <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">UART1_RECV_EN <span class="token operator">==</span> <span class="token number">1</span></span></span>
    g_uart1_recv<span class="token punctuation">.</span>rxbuf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>g_uart1_dma_rxbuf<span class="token punctuation">;</span>            <span class="token comment">/* STM32 串口设备 */</span>
    g_uart1_recv<span class="token punctuation">.</span>totalleng <span class="token operator">=</span>U1_RXSIZE<span class="token punctuation">;</span>
    g_uart1_recv<span class="token punctuation">.</span>head <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    g_uart1_recv<span class="token punctuation">.</span>tail <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    g_uart1_recv<span class="token punctuation">.</span>used <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">HAL_UART_Receive_DMA</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> g_uart1_recv<span class="token punctuation">.</span>rxbuf <span class="token punctuation">,</span> U1_RXSIZE<span class="token punctuation">)</span> <span class="token punctuation">;</span>
    <span class="token function">__HAL_UART_ENABLE_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> UART_IT_IDLE<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token function">__HAL_UART_CLEAR_IDLEFLAG</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">)</span> <span class="token punctuation">;</span>   <span class="token comment">//清除空闲标志 </span>
  <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
 <span class="token punctuation">}</span>
 
 <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
<span class="token keyword">void</span> <span class="token function">USART1_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token function">usart_recv_idle</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>g_uart1_recv<span class="token punctuation">,</span><span class="token operator">&amp;</span>g_xSemCntUart1_rxHandle<span class="token punctuation">)</span> <span class="token punctuation">;</span>
  <span class="token function">HAL_UART_IRQHandler</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/** 
  *********************************************************************************************************
  * 函数功能:   串口1 接收   环形DMA+空闲中断 
  *********************************************************************************************************
  */</span>
 <span class="token keyword">typedef</span> <span class="token keyword">struct</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token class-name">uint8_t</span> <span class="token operator">*</span>rxbuf<span class="token punctuation">;</span> 
  <span class="token class-name">uint16_t</span> totalleng<span class="token punctuation">;</span>      <span class="token comment">//  数据总长</span>
  <span class="token class-name">uint16_t</span> head<span class="token punctuation">;</span>      <span class="token comment">//  这次接收数据 队列头</span>
  <span class="token class-name">uint16_t</span> tail<span class="token punctuation">;</span>      <span class="token comment">//  这次接收数据 队列尾</span>
  <span class="token class-name">uint16_t</span> used<span class="token punctuation">;</span>      <span class="token comment">//   接收数据 解析标志     // </span>
<span class="token comment">//  UART_STATUSE    statuse;</span>
<span class="token punctuation">}</span>USART_RECV<span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">usart_recv_idle</span><span class="token punctuation">(</span>UART_HandleTypeDef <span class="token operator">*</span>huart<span class="token punctuation">,</span>USART_RECV <span class="token operator">*</span>pUart<span class="token punctuation">,</span>  <span class="token class-name">osSemaphoreId_t</span> <span class="token operator">*</span>pSem<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
   BaseType_t xHigherPriorityTaskWoken <span class="token operator">=</span> pdFALSE<span class="token punctuation">;</span>
  
   BaseType_t xSaveIntStatus <span class="token punctuation">;</span>
  
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">__HAL_UART_GET_FLAG</span><span class="token punctuation">(</span>huart<span class="token punctuation">,</span> UART_FLAG_IDLE<span class="token punctuation">)</span> <span class="token operator">!=</span> RESET<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token function">__HAL_UART_CLEAR_IDLEFLAG</span><span class="token punctuation">(</span>huart<span class="token punctuation">)</span> <span class="token punctuation">;</span>   <span class="token comment">//清除空闲标志 </span>
     
      
    xSaveIntStatus <span class="token operator">=</span> <span class="token function">taskENTER_CRITICAL_FROM_ISR</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>      <span class="token comment">/* 进入中断服务程序里面临界区 */</span>
    
     pUart<span class="token operator">-&gt;</span>tail<span class="token operator">=</span>pUart<span class="token operator">-&gt;</span>head<span class="token punctuation">;</span> 
    
     pUart<span class="token operator">-&gt;</span>head<span class="token operator">=</span>pUart<span class="token operator">-&gt;</span>totalleng <span class="token operator">-</span> <span class="token function">__HAL_DMA_GET_COUNTER</span><span class="token punctuation">(</span>huart<span class="token operator">-&gt;</span>hdmarx<span class="token punctuation">)</span><span class="token punctuation">;</span>   
    <span class="token comment">//printf("si is %d\r\n",( pUart-&gt;head));</span>
     <span class="token function">taskEXIT_CRITICAL_FROM_ISR</span><span class="token punctuation">(</span>xSaveIntStatus<span class="token punctuation">)</span> <span class="token punctuation">;</span>     <span class="token comment">/* 退出中断服务程序里面临界区 */</span>   
    
      <span class="token function">xSemaphoreGiveFromISR</span><span class="token punctuation">(</span><span class="token operator">*</span>pSem<span class="token punctuation">,</span> <span class="token operator">&amp;</span>xHigherPriorityTaskWoken<span class="token punctuation">)</span> <span class="token punctuation">;</span>   <span class="token comment">//用于中断服务程序中释放 二值 信号量。</span>
      
    <span class="token keyword">if</span><span class="token punctuation">(</span>xHigherPriorityTaskWoken <span class="token operator">==</span> pdTRUE<span class="token punctuation">)</span>     <span class="token comment">/* 如果 xHigherPriorityTaskWoken = pdTRUE，那么退出中断后切到当前最高优先级任务执行 */</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token function">portYIELD_FROM_ISR</span><span class="token punctuation">(</span>xHigherPriorityTaskWoken<span class="token punctuation">)</span> <span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/**  *********************************************************************************************************
  * 函数功能:   从环形缓冲区中  从used到 head 长度的数据 
  *********************************************************************************************************
  */</span>
<span class="token class-name">uint16_t</span> <span class="token function">ring_used_buf_get</span><span class="token punctuation">(</span>USART_RECV <span class="token operator">*</span>pUart<span class="token punctuation">,</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint16_t</span> lenght<span class="token operator">=</span><span class="token number">0</span> <span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>pUart<span class="token operator">-&gt;</span>used<span class="token operator">!=</span>pUart<span class="token operator">-&gt;</span>head<span class="token punctuation">)</span>
     <span class="token punctuation">{<!-- --></span>         
         <span class="token operator">*</span>buf<span class="token operator">++</span><span class="token operator">=</span> pUart<span class="token operator">-&gt;</span>rxbuf<span class="token punctuation">[</span>pUart<span class="token operator">-&gt;</span>used<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
         lenght<span class="token operator">++</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span>pUart<span class="token operator">-&gt;</span>used<span class="token operator">&gt;=</span>pUart<span class="token operator">-&gt;</span>totalleng<span class="token punctuation">)</span>  
             pUart<span class="token operator">-&gt;</span>used<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span>  lenght <span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/** 
  *********************************************************************************************************
  * 函数功能:   从环形缓冲区中  从tail到 head 长度的数据 
  *********************************************************************************************************
  */</span>
<span class="token class-name">uint16_t</span> <span class="token function">ring_tail_buf_get</span><span class="token punctuation">(</span> USART_RECV <span class="token operator">*</span>pUart<span class="token punctuation">,</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint16_t</span> lenght<span class="token operator">=</span><span class="token number">0</span> <span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>pUart<span class="token operator">-&gt;</span>tail<span class="token operator">!=</span>pUart<span class="token operator">-&gt;</span>head<span class="token punctuation">)</span>
     <span class="token punctuation">{<!-- --></span>         
         <span class="token operator">*</span>buf<span class="token operator">++</span><span class="token operator">=</span> pUart<span class="token operator">-&gt;</span>rxbuf<span class="token punctuation">[</span>pUart<span class="token operator">-&gt;</span>tail<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
          lenght<span class="token operator">++</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span>pUart<span class="token operator">-&gt;</span>tail<span class="token operator">&gt;=</span>pUart<span class="token operator">-&gt;</span>totalleng<span class="token punctuation">)</span>  
             pUart<span class="token operator">-&gt;</span>tail<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span>  lenght <span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="3_368"></a>3、其他</h3> 
<ul><li>如在一些大量数据需要多个算法处理，如摄像头数据需要分别进行二值化处理、几何变换、色度变换，则必须使用到DMA进行数据搬运来提升效率；</li><li>再如越来越多的多核的处理器，xilinx ZYNQ 7000： Cortex-A9 + fpga；Ti TMS320C6678：8核；STM32MP1/iMX7 ： Cortex-A7 和 Cortex-M4 等其核心间通信除了共享的部分空间和外设，大部分的数据量都是要靠DMA进行传送来达到协程。</li><li>DMA与网口。<br> HAL_ETH_DMATxDescListInit();<br> HAL_ETH_DMARxDescListInit();</li><li>DMA与SPI、SDIO<br> 如下图为stm32f4的DMA请求映射</li></ul> 
<p><img src="https://images2.imgbox.com/6f/c8/LytpeLg9_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="DMA_380"></a>三、DMA几个相关误区</h2> 
<h3><a id="1DMAcahe_381"></a>1、DMA与cahe一致性问题</h3> 
<p><img src="https://images2.imgbox.com/6f/52/Badz5KSv_o.png" alt="五">- 高性能的微控制器会在主存储器和 CPU 之间增加高速缓冲存储器（Cache），目的是提高对存储器的平均访问速度，从而提高存储系统的性能。</p> 
<ul><li>CPU在访问内存时，首先判断所要访问的内容是否在Cache中，如果在，就称为“命中（hit）”，此时CPU直接从Cache中调用该内容；否则，就 称为“ 不命中”，CPU只好去内存中调用所需的子程序或指令了。CPU不但可以直接从Cache中读出内容，也可以直接往其中写入内容。由于Cache的存取速 率相当快，使得CPU的利用率大大提高，进而使整个系统的性能得以提升。</li><li>Cache的一致性就是Cache中的数据，与对应的内存中的数据是一致的。 DMA是直接操作总线地址的，这里先当作物理地址来看待吧（系统总线地址和物理地址只是观察内存的角度不同）。如果cache缓存的内存区域不包括DMA分配到的区域，那么就没有一致性的问题。但是如果cache缓存包括了DMA目的地址的话，会出现什么什么问题呢？问题出在，经过DMA操作，cache缓存对应的内存数据已经被修改了，而CPU本身不知道（DMA传输是不通过CPU的），它仍然认为cache中的数 据就是内存中的数据，以后访问Cache映射的内存时，它仍然使用旧的Cache数据。这样就发生Cache与内存的数据“不一致性”错误。</li><li>一般而言要么禁用此项功能，要么在使用过程中注意该段空间是否存在多个host的操作，如有，则实时需要刷新cahe 和memory之间的交互。</li></ul> 
<h3><a id="2DMACCM_387"></a>2、DMA与CCM内存单元</h3> 
<p>相较于F2，F4新加的一个特殊内部SRAM。64 KB CCM （内核耦合存储器）数据 RAM 不属于总线矩阵请参见图 1 ： STM32F405xx/07xx和 STM32F415xx/17xx 器件的系统架构）。<br> <img src="https://images2.imgbox.com/7f/28/4w5Bgudi_o.png" alt="在这里插入图片描述"><br> 因此，如果DMA的源地址或者目标地址分配到的是CCM部分的空间，则无法完成搬运。解决方式是要么禁用该段空间，要么修改分散加载sct文件</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/40b092db3a4b5a58b0e4cebb1775f515/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Android 8.0网络DNS</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/cd402bb2173ded33fe316d27840054d7/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">ROS中生成CameraInfo消息</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>