<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>STM32的以太网外设&#43;PHY（LAN8720）使用详解（5）：MAC及DMA配置 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="STM32的以太网外设&#43;PHY（LAN8720）使用详解（5）：MAC及DMA配置" />
<meta property="og:description" content="0 工具准备 1.野火 stm32f407霸天虎开发板 2.LAN8720数据手册 3.STM32F4xx中文参考手册 1 MAC及DMA配置 1.1 使能ETH时钟 stm32的ETH外设挂载在AHB1总线上，位于RCC_AHB1ENR的bit25-bit27：
相关语句如下：
RCC_AHB1PeriphClockCmd(RCC_AHB1Periph_ETH_MAC | RCC_AHB1Periph_ETH_MAC_Tx | RCC_AHB1Periph_ETH_MAC_Rx, ENABLE); 1.2 复位MAC寄存器 直接调用ETH_DeInit函数来复位ETH外设
void ETH_DeInit(void) { RCC_AHB1PeriphResetCmd(RCC_AHB1Periph_ETH_MAC, ENABLE); RCC_AHB1PeriphResetCmd(RCC_AHB1Periph_ETH_MAC, DISABLE); } 上述语句操作的寄存器如下：
首先设置位25为1复位以太网MAC（复位MAC寄存器到默认值），然后设置为0取消复位。
1.3 复位MAC DMA控制器 首先调用ETH_SoftwareReset函数复位MAC的DMA
void ETH_SoftwareReset(void) { /* Set the SWR bit: resets all MAC subsystem internal registers and logic */ /* After reset all the registers holds their respective reset values */ ETH-&gt;DMABMR |= ETH_DMABMR_SR; } 上述语句操作的寄存器如下：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/e1b1b352a8e23055b3cea79315072d17/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-22T20:08:41+08:00" />
<meta property="article:modified_time" content="2023-12-22T20:08:41+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">STM32的以太网外设&#43;PHY（LAN8720）使用详解（5）：MAC及DMA配置</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="0__0"></a>0 工具准备</h2> 
<pre><code class="prism language-c"><span class="token number">1.</span>野火 stm32f407霸天虎开发板
<span class="token number">2.L</span>AN8720数据手册
<span class="token number">3.</span>STM32F4xx中文参考手册
</code></pre> 
<h2><a id="1_MACDMA_7"></a>1 MAC及DMA配置</h2> 
<h3><a id="11_ETH_8"></a>1.1 使能ETH时钟</h3> 
<p>stm32的ETH外设挂载在AHB1总线上，位于RCC_AHB1ENR的bit25-bit27：<br> <img src="https://images2.imgbox.com/92/f4/wbZdgUtY_o.png" alt="在这里插入图片描述"><br> 相关语句如下：</p> 
<pre><code class="prism language-c"><span class="token function">RCC_AHB1PeriphClockCmd</span><span class="token punctuation">(</span>RCC_AHB1Periph_ETH_MAC <span class="token operator">|</span> RCC_AHB1Periph_ETH_MAC_Tx <span class="token operator">|</span>
                               RCC_AHB1Periph_ETH_MAC_Rx<span class="token punctuation">,</span>
                           ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="12_MAC_19"></a>1.2 复位MAC寄存器</h3> 
<p>直接调用ETH_DeInit函数来复位ETH外设</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">ETH_DeInit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token function">RCC_AHB1PeriphResetCmd</span><span class="token punctuation">(</span>RCC_AHB1Periph_ETH_MAC<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">RCC_AHB1PeriphResetCmd</span><span class="token punctuation">(</span>RCC_AHB1Periph_ETH_MAC<span class="token punctuation">,</span> DISABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上述语句操作的寄存器如下：<br> <img src="https://images2.imgbox.com/ee/94/yojdSmN9_o.png" alt="首先使能"><br> 首先设置位25为1复位以太网MAC（复位MAC寄存器到默认值），然后设置为0取消复位。</p> 
<h3><a id="13_MAC_DMA_31"></a>1.3 复位MAC DMA控制器</h3> 
<p>首先调用ETH_SoftwareReset函数复位MAC的DMA</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">ETH_SoftwareReset</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token comment">/* Set the SWR bit: resets all MAC subsystem internal registers and logic */</span>
  <span class="token comment">/* After reset all the registers holds their respective reset values */</span>
  ETH<span class="token operator">-&gt;</span>DMABMR <span class="token operator">|=</span> ETH_DMABMR_SR<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上述语句操作的寄存器如下：<br> <img src="https://images2.imgbox.com/8b/2f/HoChgKNS_o.png" alt="在这里插入图片描述"><br> 等待MAC DMA控制器软件复位完成：</p> 
<pre><code class="prism language-c"><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">ETH_GetSoftwareResetStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> SET<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>ETH_GetSoftwareResetStatus函数定义如下：</p> 
<pre><code class="prism language-c">FlagStatus <span class="token function">ETH_GetSoftwareResetStatus</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  FlagStatus bitstatus <span class="token operator">=</span> RESET<span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ETH<span class="token operator">-&gt;</span>DMABMR <span class="token operator">&amp;</span> ETH_DMABMR_SR<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>RESET<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    bitstatus <span class="token operator">=</span> SET<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">{<!-- --></span>
    bitstatus <span class="token operator">=</span> RESET<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> bitstatus<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这里轮询位0的状态，当为0值为0时表示复位完成，方可以进行接下来的操作。</p> 
<h3><a id="14_ETH_67"></a>1.4 配置ETH</h3> 
<p>由于需要配置的ETH参数非常多，大部分参数保持默认即可，为了省事首先调用ETH_StructInit函数将ETH参数设置为默认值。语句如下：</p> 
<pre><code class="prism language-c"><span class="token function">ETH_StructInit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ETH_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>ETH_StructInit这个函数实际上就是将ETH_InitStructure这个变量的成员的值全部设置为默认值。<br> 然后我们根据需要修改其中一些参数，比较常见的就是开启混杂模式，也就是将ETH_InitStructure.ETH_ReceiveAll设置为ETH_ReceiveAll_Enable。<br> 本文使用的配置如下：</p> 
<pre><code class="prism language-c"><span class="token comment">/* 开启网络自适应功能 */</span>
ETH_InitStructure<span class="token punctuation">.</span>ETH_AutoNegotiation <span class="token operator">=</span> ETH_AutoNegotiation_Enable<span class="token punctuation">;</span>
<span class="token comment">/* 关闭反馈 */</span>
ETH_InitStructure<span class="token punctuation">.</span>ETH_LoopbackMode <span class="token operator">=</span> ETH_LoopbackMode_Disable<span class="token punctuation">;</span>
<span class="token comment">/* 关闭重传功能 */</span>
ETH_InitStructure<span class="token punctuation">.</span>ETH_RetryTransmission <span class="token operator">=</span> ETH_RetryTransmission_Disable<span class="token punctuation">;</span>
<span class="token comment">/* 关闭自动去除PDA/CRC功能  */</span>
ETH_InitStructure<span class="token punctuation">.</span>ETH_AutomaticPadCRCStrip <span class="token operator">=</span> ETH_AutomaticPadCRCStrip_Disable<span class="token punctuation">;</span>
<span class="token comment">/* 关闭接收所有的帧 */</span>
ETH_InitStructure<span class="token punctuation">.</span>ETH_ReceiveAll <span class="token operator">=</span> ETH_ReceiveAll_Disable<span class="token punctuation">;</span>
<span class="token comment">/* 允许接收所有广播帧 */</span>
ETH_InitStructure<span class="token punctuation">.</span>ETH_BroadcastFramesReception <span class="token operator">=</span> ETH_BroadcastFramesReception_Enable<span class="token punctuation">;</span>
<span class="token comment">/* 关闭混合模式的地址过滤  */</span>
ETH_InitStructure<span class="token punctuation">.</span>ETH_PromiscuousMode <span class="token operator">=</span> ETH_PromiscuousMode_Disable<span class="token punctuation">;</span>
<span class="token comment">/* 对于组播地址使用完美地址过滤    */</span>
ETH_InitStructure<span class="token punctuation">.</span>ETH_MulticastFramesFilter <span class="token operator">=</span> ETH_MulticastFramesFilter_Perfect<span class="token punctuation">;</span>
<span class="token comment">/* 对单播地址使用完美地址过滤  */</span>
ETH_InitStructure<span class="token punctuation">.</span>ETH_UnicastFramesFilter <span class="token operator">=</span> ETH_UnicastFramesFilter_Perfect<span class="token punctuation">;</span>
<span class="token comment">/* 开启ipv4和TCP/UDP/ICMP的帧校验和卸载   */</span>
ETH_InitStructure<span class="token punctuation">.</span>ETH_ChecksumOffload <span class="token operator">=</span> ETH_ChecksumOffload_Enable<span class="token punctuation">;</span>
<span class="token comment">/* 开启丢弃TCP/IP错误帧 */</span>
ETH_InitStructure<span class="token punctuation">.</span>ETH_DropTCPIPChecksumErrorFrame <span class="token operator">=</span> ETH_DropTCPIPChecksumErrorFrame_Enable<span class="token punctuation">;</span>
<span class="token comment">/* 开启接收数据的存储转发模式  */</span>
ETH_InitStructure<span class="token punctuation">.</span>ETH_ReceiveStoreForward <span class="token operator">=</span> ETH_ReceiveStoreForward_Enable<span class="token punctuation">;</span>
<span class="token comment">/* 开启发送数据的存储转发模式   */</span>
ETH_InitStructure<span class="token punctuation">.</span>ETH_TransmitStoreForward <span class="token operator">=</span> ETH_TransmitStoreForward_Enable<span class="token punctuation">;</span>
<span class="token comment">/* 禁止转发错误帧 */</span>
ETH_InitStructure<span class="token punctuation">.</span>ETH_ForwardErrorFrames <span class="token operator">=</span> ETH_ForwardErrorFrames_Disable<span class="token punctuation">;</span>
<span class="token comment">/* 不转发过小的好帧 */</span>
ETH_InitStructure<span class="token punctuation">.</span>ETH_ForwardUndersizedGoodFrames <span class="token operator">=</span> ETH_ForwardUndersizedGoodFrames_Disable<span class="token punctuation">;</span>
<span class="token comment">/* 打开处理第二帧功能 */</span>
ETH_InitStructure<span class="token punctuation">.</span>ETH_SecondFrameOperate <span class="token operator">=</span> ETH_SecondFrameOperate_Enable<span class="token punctuation">;</span>
<span class="token comment">/* 开启DMA传输的地址对齐功能 */</span>
ETH_InitStructure<span class="token punctuation">.</span>ETH_AddressAlignedBeats <span class="token operator">=</span> ETH_AddressAlignedBeats_Enable<span class="token punctuation">;</span>
<span class="token comment">/* 开启固定突发功能 */</span>
ETH_InitStructure<span class="token punctuation">.</span>ETH_FixedBurst <span class="token operator">=</span> ETH_FixedBurst_Enable<span class="token punctuation">;</span>
<span class="token comment">/* DMA发送的最大突发长度为32个节拍 */</span>
ETH_InitStructure<span class="token punctuation">.</span>ETH_RxDMABurstLength <span class="token operator">=</span> ETH_RxDMABurstLength_32Beat<span class="token punctuation">;</span>
<span class="token comment">/*DMA接收的最大突发长度为32个节拍 */</span>
ETH_InitStructure<span class="token punctuation">.</span>ETH_TxDMABurstLength <span class="token operator">=</span> ETH_TxDMABurstLength_32Beat<span class="token punctuation">;</span>
ETH_InitStructure<span class="token punctuation">.</span>ETH_DMAArbitration <span class="token operator">=</span> ETH_DMAArbitration_RoundRobin_RxTx_2_1<span class="token punctuation">;</span>
</code></pre> 
<p>最后调用ETH_Init函数初始化ETH即可：</p> 
<pre><code class="prism language-c">EthStatus <span class="token operator">=</span> <span class="token function">ETH_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ETH_InitStructure<span class="token punctuation">,</span> ETHERNET_PHY_ADDRESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>注意，参数2是PHY的地址，我们使用的PHY地址为0x00。<br> ETH_Init主要工作就是根据我们设置的ETH参数去配置相应的寄存器。</p> 
<h3><a id="15_MAC_126"></a>1.5 配置MAC地址</h3> 
<p>直接使用ETH_MACAddressConfig函数设置MAC地址即可：</p> 
<pre><code class="prism language-c"><span class="token class-name">uint8_t</span> macAddr<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x14</span><span class="token punctuation">,</span> <span class="token number">0x99</span><span class="token punctuation">,</span> <span class="token number">0x30</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">ETH_MACAddressConfig</span><span class="token punctuation">(</span>ETH_MAC_Address0<span class="token punctuation">,</span> macAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>这里要注意，参数1的值为0，会操作如下寄存器：<br> <img src="https://images2.imgbox.com/57/1d/C6aZHI8r_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/0b/6a/OHDnJ82C_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="16_DMA_137"></a>1.6 配置DMA</h3> 
<h4><a id="161_DMA_138"></a>1.6.1 DMA描述符介绍</h4> 
<p>在介绍DMA配置之前，需要了解一下STM32的ETH DMA结构：<br> <img src="https://images2.imgbox.com/03/e4/mRQDvsHN_o.png" alt="在这里插入图片描述"><br> 一般来说我们都选择链接结构，操作起来更方便一些。提到了ETH DMA就绕不开DMA描述符，DMA描述符分为Tx DMA描述符和Rx DMA描述符，DMA描述符是纯软件的概念，STM32的ETH DMA通过DMA描述符来管理接收、发送的以太网数据。STM32默认使用的是增强型的DMA描述符。<br> 增强型Tx DMA描述符如下：<br> <img src="https://images2.imgbox.com/0c/bc/4UxFaIUW_o.png" alt="在这里插入图片描述"><br> 可以看到描述符的大小为48bit，这和STM32定义的DMA结构体是一模一样的：</p> 
<pre><code class="prism language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span>  <span class="token punctuation">{<!-- --></span>
  __IO <span class="token class-name">uint32_t</span>   Status<span class="token punctuation">;</span>                <span class="token comment">/*!&lt; Status */</span>
  <span class="token class-name">uint32_t</span>   ControlBufferSize<span class="token punctuation">;</span>     <span class="token comment">/*!&lt; Control and Buffer1, Buffer2 lengths */</span>
  <span class="token class-name">uint32_t</span>   Buffer1Addr<span class="token punctuation">;</span>           <span class="token comment">/*!&lt; Buffer1 address pointer */</span>
  <span class="token class-name">uint32_t</span>   Buffer2NextDescAddr<span class="token punctuation">;</span>   <span class="token comment">/*!&lt; Buffer2 or next descriptor address pointer */</span>
<span class="token comment">/* Enhanced ETHERNET DMA PTP Descriptors */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">USE_ENHANCED_DMA_DESCRIPTORS</span></span>
  <span class="token class-name">uint32_t</span>   ExtendedStatus<span class="token punctuation">;</span>        <span class="token comment">/* Extended status for PTP receive descriptor */</span>
  <span class="token class-name">uint32_t</span>   Reserved1<span class="token punctuation">;</span>             <span class="token comment">/* Reserved */</span>
  <span class="token class-name">uint32_t</span>   TimeStampLow<span class="token punctuation">;</span>          <span class="token comment">/* Time Stamp Low value for transmit and receive */</span>
  <span class="token class-name">uint32_t</span>   TimeStampHigh<span class="token punctuation">;</span>         <span class="token comment">/* Time Stamp High value for transmit and receive */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* USE_ENHANCED_DMA_DESCRIPTORS */</span></span>
<span class="token punctuation">}</span> ETH_DMADESCTypeDef<span class="token punctuation">;</span>
</code></pre> 
<p>增强型Rx DMA描述符如下：<br> <img src="https://images2.imgbox.com/69/86/Hn9PAJG9_o.png" alt="在这里插入图片描述"><br> 增强型Rx DMA描述符和增强型Tx DMA描述符在组成上是一致的，唯一的区别是bit的含义不同。<br> 有人会好奇，既然DMA描述符是纯软件的概念，那么硬件DMA又是如何找到DMA描述符并使用它完成数据接收、发送操作的呢？这里就要提到DMATDLAR、DMARDLAR这两个寄存器，这两个寄存器会保存DMA描述符首地址到寄存器，这便是联系硬件DMA和软件DMA描述符的桥梁：<br> <img src="https://images2.imgbox.com/e5/9c/dwV1TV9w_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="162_DMA_167"></a>1.6.2 DMA配置过程</h4> 
<p>（1）定义发送、接收DMA描述符及buffer等变量</p> 
<pre><code class="prism language-c"><span class="token function">__align</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> 
ETH_DMADESCTypeDef  DMARxDscrTab<span class="token punctuation">[</span>ETH_RXBUFNB<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">/* Ethernet Rx DMA Descriptor 以太网接收DMA描述符 */</span>
<span class="token function">__align</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> 
ETH_DMADESCTypeDef  DMATxDscrTab<span class="token punctuation">[</span>ETH_TXBUFNB<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">/* Ethernet Tx DMA Descriptor  以太网发送DMA描述符 */</span>
<span class="token function">__align</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> 
<span class="token class-name">uint8_t</span> Rx_Buff<span class="token punctuation">[</span>ETH_RXBUFNB<span class="token punctuation">]</span><span class="token punctuation">[</span>ETH_RX_BUF_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">/* Ethernet Receive Buffer 以太网接收Buffer */</span>
<span class="token function">__align</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> 
<span class="token class-name">uint8_t</span> Tx_Buff<span class="token punctuation">[</span>ETH_TXBUFNB<span class="token punctuation">]</span><span class="token punctuation">[</span>ETH_TX_BUF_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">/* Ethernet Transmit Buffer 以太网发送Buffer */</span>
</code></pre> 
<p>以上是STM32默认配置的DMA描述符和buffer，DMA描述符的数量为4，buffer的大小为1524Byte。需要4字节对齐，方便DMA的搬运。<br> 之所以定义buffer大小为1524Byte，是因为以太网报文最大帧大小为1524Byte，计算方法如下：</p> 
<pre><code class="prism language-c">ETH_HEADER <span class="token operator">+</span> ETH_EXTRA <span class="token operator">+</span> VLAN_TAG <span class="token operator">+</span> MAX_ETH_PAYLOAD <span class="token operator">+</span> ETH_CRC
</code></pre> 
<p>其中，<br> ETH_HEADER表示以太网帧头，大小为14字节，包括6字节目的地址、6字节源地址、2字节帧类型<br> ETH_EXTRA表示某些情况下的额外字节，大小为2字节<br> VLAN_TAG表示VLAN字段，大小为4字节<br> MAX_ETH_PAYLOA表示以太网帧有效载荷，大小为1500字节（范围为46-1500字节）<br> ETH_CRC表示CRC校验，大小为4字节<br> 我们还需要定义2个DMA描述符指针，这个DMA描述符指针主要是给CPU使用的，用来指示当前操作到了哪个DMA描述符，有点类似于环形buffer的头指针，而ETH DMA则是尾指针。定义内容如下：</p> 
<pre><code class="prism language-c">__IO ETH_DMADESCTypeDef  <span class="token operator">*</span>DMATxDescToSet<span class="token punctuation">;</span>
__IO ETH_DMADESCTypeDef  <span class="token operator">*</span>DMARxDescToGet<span class="token punctuation">;</span>
</code></pre> 
<p>（2）初始化Tx DMA和Rx DMA描述符</p> 
<pre><code class="prism language-c"><span class="token comment">/* Initialize Tx Descriptors list: Chain Mode */</span>
  <span class="token function">ETH_DMATxDescChainInit</span><span class="token punctuation">(</span>DMATxDscrTab<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Tx_Buff<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ETH_TXBUFNB<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* Initialize Rx Descriptors list: Chain Mode  */</span>
  <span class="token function">ETH_DMARxDescChainInit</span><span class="token punctuation">(</span>DMARxDscrTab<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Rx_Buff<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ETH_RXBUFNB<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>ETH_DMATxDescChainInit和ETH_DMARxDescChainInit这两个函数实际上就是初始化Tx和RxDMA描述符，具体工作如下：<br> ①设置每个DMA描述符的状态<br> ②设置每个DMA描述符的buffer地址<br> ③设置每个DMA描述符的下一个DMA描述符地址（构成链形）<br> ④设置DMA描述符列表地址寄存器的值为首个DMA描述符地址<br> 这里我们开启硬件发送报文校验和功能，当我们发送TCP/UDP/ICMP报文时无需使用CPU计算校验和，直接让DMA完成即可。语句如下：</p> 
<pre><code class="prism language-c">  <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ETH_TXBUFNB<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token function">ETH_DMATxDescChecksumInsertionConfig</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>DMATxDscrTab<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> ETH_DMATxDesc_ChecksumTCPUDPICMPFull<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>（3）使能ETH<br> 到此为止，MAC和DMA的配置基本完成，接下来只需要使能所有相关的外设即可。直接调用ETH_Start函数即可：</p> 
<pre><code class="prism language-c"><span class="token function">ETH_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>这个函数的主要工作就是将相关的寄存器位使能：</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">ETH_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token comment">/* Enable transmit state machine of the MAC for transmission on the MII */</span>
  <span class="token function">ETH_MACTransmissionCmd</span><span class="token punctuation">(</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Enable receive state machine of the MAC for reception from the MII */</span>
  <span class="token function">ETH_MACReceptionCmd</span><span class="token punctuation">(</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Flush Transmit FIFO */</span>
  <span class="token function">ETH_FlushTransmitFIFO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Start DMA transmission */</span>
  <span class="token function">ETH_DMATransmissionCmd</span><span class="token punctuation">(</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Start DMA reception */</span>
  <span class="token function">ETH_DMAReceptionCmd</span><span class="token punctuation">(</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这里有个非常有用的函数ETH_FlushTransmitFIFO，可以用来清空FIFO。当我们的网口之前残余了一些无用的报文，在我们初始化之前将FIFO清空可以避免这些无用报文的干扰。</p> 
<h2><a id="2__247"></a>2 总结</h2> 
<p>（1）DMA描述符是个纯软件的概念，通过设置DMA描述符地址寄存器来建立DMA和DMA描述符的联系。DMA描述符使用起来和环形buffer类似，且一个报文可能存在多个DMA描述符内，但一个DMA描述符最多只有一个报文。<br> （2）最好将接收、发送buffer大小设置到1524字节，这样可以避免拆包，便于我们对数据的处理。<br> （3）可以使能ETH_InitStructure.ETH_ReceiveAll开启混杂模式，这在开发Ethernet层的协议时非常有用。</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/666e91de1bf4fb61d8e3d0caba300288/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">STM32的以太网外设&#43;PHY（LAN8720）使用详解（2）：硬件设计</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/0bb15558309f617355fc251052eaacbe/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">STM32的以太网外设&#43;PHY（LAN8720）使用详解（6）：以太网数据接收及发送</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>