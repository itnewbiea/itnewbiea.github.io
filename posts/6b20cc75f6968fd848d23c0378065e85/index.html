<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>生产环境内存泄露(Redirect)的问题排查分析过程 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="生产环境内存泄露(Redirect)的问题排查分析过程" />
<meta property="og:description" content="生产环境内存泄露(Redirect)的问题排查分析过程 问题说明 服务升级框架由原来的Spring-4.0.4.RELEASE&#43;SpringMVC-4.0.4.RELEASE升级为SpringBoot-2.0.2.RELEASE服务有原来的外置Tomcat&#43;jsp改成内置Tomcat&#43;jsp 问题分析解决思路 生产环境过一两天出现内存溢出,观察发现,老年代的内存一直在飙高,触发的Full Gc并不会让老年代的内存减少太多,慢慢的积累,最终导致服务挂掉,内存溢出;通过dump生产的堆快照,然后使用MemoryAnalyzer进行堆栈分析,发现问题所在找到大量Redirect的内存占用,并且没有的得到释放,出现一定量的ConnectionException(zipkin中对mq的连接验证)并还在不断的增加发现大部分堆内存占用都是被Redirect所导致的,还有一部分是被ConnectionException导致的修改SpringMvc的Redirect重定向方式,修改zipkin的通信方式(http或者rabbitmq)我修改代码放弃了return &#34;redirect:http://www.baidu.com?param=1&#34;的书写方式改成response.sendRedirect(response.encodeRedirectURL(redirectUrl)); return null;这种方式；然后先去掉了zipkin的依赖引用; 分析过程 查看服务运行情况 查看服务信息（内存占用等情况）
jps -l[v]
查看运行的服务的一些基础信息,进程id确定服务(命令的v可选,查看更想起的服务信息)
使用top 或者top -Hp pid查看内存或者cpu使用情况
top:查看多个服务的基础运行情况,内存,cpu的占用情况【可使用z盖面面板颜色,x进行排序操作,shift&#43;&lt;或者&gt;进行不同属性值排序】top -Hp pid:查看某个服务的线程基础运行情况,内存,cpu的占用情况【可使用z盖面面板颜色,x进行排序操作,shift&#43;&lt;或者&gt;进行不同属性值排序】 使用jmap进行项目内存情况分析(我当时就是根据这个看出老年代内存的不停增加)
jmap -heap:查看命令帮助jmap -heap pid:查看进程的内存情况(新生代老年代的占用使用情况)jmap -histo:live pid|sort -k 3 -g -r |less:(查看现在存活的对象内存占用情况,按照占用内存大小进行排序,-g按照数字排序,r反转倒序)【3是内存大小,2是对象数量大小】jmap -dump:live,file=./web_01_202007110930_dump.hprof pid:查看进程为pid存活的堆内存的快照,后续可以用MemoryAnalyzer进行分析或者jprofiler【这两个需要下载下来来分析】进行分析,当然也可以在线上用jhat进行对堆内存分析 查看服务的gc情况
-jstat -gcutil 25376 1s [次数]:查看gc的汇总情况,1s为1秒输出一次,次数缺省无限输出,1s如果不写s默认为毫秒可写为1000
-jstat -gc 25376 1s [次数]:查看gc的详细情况,1s为1秒输出一次,次数缺省无限输出,1s如果不写s默认为毫秒可写为1000
服务分析过程 首先是通过一段时间( jmap -heap, jmap -histo:live)观察老年代内存的不断增长,查看（jstat ）gc的情况原本以为是修改之后内存占用多,堆内存由原来的1G修改为现在的2G,后来发现依然出现内存溢出进行dump( jmap -dump:live,file=./web_01_202007110930_dump.hprof pid)进行dump线上内存快照,然后使用的是Eclipse的一个插件,这里下载了一个单独版进行分析MemoryAnalyzer,查出问题所在,分析图见下面;找到内存泄露点,分别为Redirect的动态参数如return “redirect /index.jsp?userId=111”,后面的参数是动态的,这样Springmvc中间在解析视图的时候会做一个缓存,也会把后面的参数进行缓存,这样每次缓存的路径大部分都是不一样的,时间久了就可能导致内存泄露的问题,晚上也找到的不同的解决方案,最终采用的是该代码的其中一种方案；这里随便从网上搜了一个连接丢到这了还有一个点就是观察有一个异常ConnectException异常在不停的增加,通过Dump发现是MQ的连接的异常,刚开始项目引进了Rabiitmq但是没有开启Rabbitmq配置,启动还没有报错,但是在Dump中却发现连接Mq的异常不停的增加,（期间使用SpringBoot的排除RabbitMq的自动配置,删除掉Mq的配置,问题重现）,最后通过依赖关系查出猫腻,发现zipkin链路追踪中需要RabbitMq的连接;zipkin可以有选择的http,rabbitnq与zipkin进行通信,这里可以配置通信方式为http，我这边直接把zipkin的依赖暂时去掉了,其他方式自测,这里丢一个链接是解决此方式的方法修改Redirect其他跳转方式之后,去掉zipkin依赖之后,问题解决,老年代内存平稳,不在持续增加到很高,并没有在此出现内存溢出; MemoryAnalyzer内存溢出分析图 查看内存的基本占用情况查看内存占用树情况,观察出问题所在" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/6b20cc75f6968fd848d23c0378065e85/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-07-11T11:53:12+08:00" />
<meta property="article:modified_time" content="2020-07-11T11:53:12+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">生产环境内存泄露(Redirect)的问题排查分析过程</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="Redirect_0"></a>生产环境内存泄露(Redirect)的问题排查分析过程</h3> 
<h3><a id="_2"></a>问题说明</h3> 
<blockquote> 
 <ol><li>服务升级框架由原来的Spring-4.0.4.RELEASE+SpringMVC-4.0.4.RELEASE升级为SpringBoot-2.0.2.RELEASE</li><li>服务有原来的外置Tomcat+jsp改成内置Tomcat+jsp</li></ol> 
</blockquote> 
<h3><a id="_8"></a>问题分析解决思路</h3> 
<blockquote> 
 <ol><li>生产环境过一两天出现内存溢出,观察发现,老年代的内存一直在飙高,触发的Full Gc并不会让老年代的内存减少太多,慢慢的积累,最终导致服务挂掉,内存溢出;</li><li>通过dump生产的堆快照,然后使用<a href="https://www.eclipse.org/mat/downloads.php" rel="nofollow">MemoryAnalyzer</a>进行堆栈分析,发现问题所在</li><li>找到大量Redirect的内存占用,并且没有的得到释放,出现一定量的ConnectionException(zipkin中对mq的连接验证)并还在不断的增加</li><li>发现大部分堆内存占用都是被Redirect所导致的,还有一部分是被ConnectionException导致的</li><li>修改SpringMvc的Redirect重定向方式,修改zipkin的通信方式(http或者rabbitmq)</li><li>我修改代码放弃了return "redirect:http://www.baidu.com?param=1"的书写方式改成response.sendRedirect(response.encodeRedirectURL(redirectUrl)); return null;这种方式；然后先去掉了zipkin的依赖引用;</li></ol> 
</blockquote> 
<h3><a id="_18"></a>分析过程</h3> 
<h4><a id="_19"></a>查看服务运行情况</h4> 
<ol><li> <p>查看服务信息（内存占用等情况）</p> 
  <blockquote> 
   <p>jps -l[v]</p> 
   <blockquote> 
    <p>查看运行的服务的一些基础信息,进程id确定服务(命令的v可选,查看更想起的服务信息)</p> 
   </blockquote> 
  </blockquote> </li><li> <p>使用top 或者top -Hp pid查看内存或者cpu使用情况</p> 
  <blockquote> 
   <ul><li>top:查看多个服务的基础运行情况,内存,cpu的占用情况【可使用z盖面面板颜色,x进行排序操作,shift+&lt;或者&gt;进行不同属性值排序】</li><li>top -Hp pid:查看某个服务的线程基础运行情况,内存,cpu的占用情况【可使用z盖面面板颜色,x进行排序操作,shift+&lt;或者&gt;进行不同属性值排序】</li></ul> 
  </blockquote> </li><li> <p>使用jmap进行项目内存情况分析(我当时就是根据这个看出老年代内存的不停增加)</p> 
  <blockquote> 
   <ul><li>jmap -heap:查看命令帮助</li><li>jmap -heap pid:查看进程的内存情况(新生代老年代的占用使用情况)</li><li>jmap -histo:live pid|sort -k 3 -g -r |less:(查看现在存活的对象内存占用情况,按照占用内存大小进行排序,-g按照数字排序,r反转倒序)【3是内存大小,2是对象数量大小】</li><li>jmap -dump:live,file=./web_01_202007110930_dump.hprof pid:查看进程为pid存活的堆内存的快照,后续可以用<a href="https://www.eclipse.org/mat/downloads.php" rel="nofollow">MemoryAnalyzer</a>进行分析或者<a href="https://www.ej-technologies.com/products/jprofiler/overview.html" rel="nofollow">jprofiler</a>【这两个需要下载下来来分析】进行分析,当然也可以在线上用jhat进行对堆内存分析</li></ul> 
  </blockquote> </li><li> <p>查看服务的gc情况</p> 
  <blockquote> 
   <p>-jstat -gcutil 25376 1s [次数]:查看gc的汇总情况,1s为1秒输出一次,次数缺省无限输出,1s如果不写s默认为毫秒可写为1000<br> -jstat -gc 25376 1s [次数]:查看gc的详细情况,1s为1秒输出一次,次数缺省无限输出,1s如果不写s默认为毫秒可写为1000</p> 
  </blockquote> </li></ol> 
<h4><a id="_37"></a>服务分析过程</h4> 
<ol><li>首先是通过一段时间( jmap -heap, jmap -histo:live)观察老年代内存的不断增长,查看（jstat ）gc的情况</li><li>原本以为是修改之后内存占用多,堆内存由原来的1G修改为现在的2G,后来发现依然出现内存溢出</li><li>进行dump( jmap -dump:live,file=./web_01_202007110930_dump.hprof pid)进行dump线上内存快照,然后使用的是Eclipse的一个插件,这里下载了一个单独版进行分析<a href="https://www.eclipse.org/mat/downloads.php" rel="nofollow">MemoryAnalyzer</a>,查出问题所在,分析图见下面;</li><li>找到内存泄露点,分别为Redirect的动态参数如return “redirect /index.jsp?userId=111”,后面的参数是动态的,这样Springmvc中间在解析视图的时候会做一个缓存,也会把后面的参数进行缓存,这样每次缓存的路径大部分都是不一样的,时间久了就可能导致内存泄露的问题,晚上也找到的不同的解决方案,最终采用的是该代码的其中一种方案；这里随便从网上搜了一个<a href="https://www.jianshu.com/p/fab234574603" rel="nofollow">连接丢到这了</a></li><li>还有一个点就是观察有一个异常ConnectException异常在不停的增加,通过Dump发现是MQ的连接的异常,刚开始项目引进了Rabiitmq但是没有开启Rabbitmq配置,启动还没有报错,但是在Dump中却发现连接Mq的异常不停的增加,（期间使用SpringBoot的排除RabbitMq的自动配置,删除掉Mq的配置,问题重现）,最后通过依赖关系查出猫腻,发现zipkin链路追踪中需要RabbitMq的连接;zipkin可以有选择的http,rabbitnq与zipkin进行通信,这里可以配置通信方式为http，我这边直接把zipkin的依赖暂时去掉了,其他方式自测,<a href="https://blog.csdn.net/volcannon/article/details/83789675">这里丢一个链接是解决此方式的方法</a></li><li>修改Redirect其他跳转方式之后,去掉zipkin依赖之后,问题解决,老年代内存平稳,不在持续增加到很高,并没有在此出现内存溢出;</li></ol> 
<h4><a id="MemoryAnalyzer_46"></a>MemoryAnalyzer内存溢出分析图</h4> 
<ol><li>查看内存的基本占用情况<img src="https://images2.imgbox.com/81/e3/J5XNOFZM_o.png" alt="在这里插入图片描述"></li><li>查看内存占用树情况,观察出问题所在<br> <img src="https://images2.imgbox.com/be/1f/qdOj5dTB_o.png" alt="在这里插入图片描述"></li></ol>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/bbeb3205796eeb9236757fb1ac52168a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">实战简历编写，打造硬核敲门砖</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/305af65222ed3fff91f5c8bcdfe17162/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">SNMP</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>