<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>T31开发笔记：EC200T-CN 4G模块调试 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="T31开发笔记：EC200T-CN 4G模块调试" />
<meta property="og:description" content="若该文为原创文章，转载请注明原文出处 一、硬件和开发环境 1、硬件：T31X&#43;SC5235 &#43; EC200T-CN
2、开发环境： ubuntu16.04-64bit
3、编译器：mips-gcc540-glibc222-32bit-r3.3.0.tar.gz
注：板子和4G模块某淘上淘的，uboot和内核是自己裁剪移植的，没有移植wifi，所以USB接口未使用； EC200T-CN使用的是USB接口，电源外供5V，注意4G模块电源。
二、内核文件修改、配置及编译 1、内核中需要修改的代码
主要修改下面四个文件的代码：
drivers/net/usb/qmi_wwan.c
drivers/usb/serial/option.c
drivers/usb/serial/qcserial.c
drivers/usb/serial/usb_wwan.c
A、 修改drivers/net/usb/qmi_wwan.c代码：
diff --git a/drivers/net/usb/qmi_wwan.c b/drivers/net/usb/qmi_wwan.c index 5645921..f8f0020 100644 --- a/drivers/net/usb/qmi_wwan.c &#43;&#43;&#43; b/drivers/net/usb/qmi_wwan.c @@ -614,7 &#43;614,7 @@ static const struct usb_device_id products[] = { {QMI_GOBI_DEVICE(0x05c6, 0x9225)}, /* Sony Gobi 2000 Modemdevice (N0279, VU730) */ {QMI_GOBI_DEVICE(0x05c6, 0x9245)}, /* Samsung Gobi 2000 Modemdevice (VL176) */ {QMI_GOBI_DEVICE(0x03f0, 0x251d)}, /* HP Gobi 2000 Modemdevice (VP412) */ - {QMI_GOBI_DEVICE(0x05c6, 0x9215)}, /* Acer Gobi 2000 Modemdevice (VP413) */ &#43;// {QMI_GOBI_DEVICE(0x05c6, 0x9215)}, /* Acer Gobi 2000 Modemdevice (VP413) */ {QMI_GOBI_DEVICE(0x05c6, 0x9265)}, /* Asus Gobi 2000 Modemdevice (VR305) */ {QMI_GOBI_DEVICE(0x05c6, 0x9235)}, /* Top Global Gobi 2000Modem device (VR306) */ {QMI_GOBI_DEVICE(0x05c6, 0x9275)}, /* iRex Technologies Gobi2000 Modem device (VR307) *} B、 drivers/usb/serial/option." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/a08eaee0eeb433e852292b0ffa283bd7/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-06T16:25:42+08:00" />
<meta property="article:modified_time" content="2022-04-06T16:25:42+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">T31开发笔记：EC200T-CN 4G模块调试</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>若该文为原创文章，转载请注明原文出处 </p> 
<h4>一、硬件和开发环境</h4> 
<p>1、硬件：T31X+SC5235 + EC200T-CN</p> 
<p>2、开发环境： ubuntu16.04-64bit</p> 
<p>3、编译器：mips-gcc540-glibc222-32bit-r3.3.0.tar.gz</p> 
<p><strong>注：板子和4G模块某淘上淘的，uboot和内核是自己裁剪移植的，没有移植wifi，所以USB接口未使用； EC200T-CN使用的是USB接口，电源外供5V，注意4G模块电源。</strong></p> 
<h3>二、内核文件修改、配置及编译</h3> 
<p><strong>1、内核中需要修改的代码</strong></p> 
<p>主要修改下面四个文件的代码：</p> 
<p>drivers/net/usb/qmi_wwan.c</p> 
<p>drivers/usb/serial/option.c</p> 
<p>drivers/usb/serial/qcserial.c</p> 
<p>drivers/usb/serial/usb_wwan.c</p> 
<p><strong>A、  修改drivers/net/usb/qmi_wwan.c代码：</strong></p> 
<pre><code>diff --git a/drivers/net/usb/qmi_wwan.c b/drivers/net/usb/qmi_wwan.c
index 5645921..f8f0020 100644
--- a/drivers/net/usb/qmi_wwan.c
+++ b/drivers/net/usb/qmi_wwan.c
@@ -614,7 +614,7 @@ static const struct usb_device_id products[] = {
{QMI_GOBI_DEVICE(0x05c6, 0x9225)}, /* Sony Gobi 2000 Modemdevice (N0279, VU730) */
{QMI_GOBI_DEVICE(0x05c6, 0x9245)}, /* Samsung Gobi 2000 Modemdevice (VL176) */
{QMI_GOBI_DEVICE(0x03f0, 0x251d)}, /* HP Gobi 2000 Modemdevice (VP412) */
- {QMI_GOBI_DEVICE(0x05c6, 0x9215)}, /* Acer Gobi 2000 Modemdevice (VP413) */
+// {QMI_GOBI_DEVICE(0x05c6, 0x9215)}, /* Acer Gobi 2000 Modemdevice (VP413) */
{QMI_GOBI_DEVICE(0x05c6, 0x9265)}, /* Asus Gobi 2000 Modemdevice (VR305) */
{QMI_GOBI_DEVICE(0x05c6, 0x9235)}, /* Top Global Gobi 2000Modem device (VR306) */
{QMI_GOBI_DEVICE(0x05c6, 0x9275)}, /* iRex Technologies Gobi2000 Modem device (VR307) *}</code></pre> 
<p><strong>B、 drivers/usb/serial/option.c</strong></p> 
<pre><code>--- a/drivers/usb/serial/option.c
+++ b/drivers/usb/serial/option.c
@@ -530,6 +530,22 @@ static const struct option_blacklist_info
telit_le920_blacklist = {
};
static const struct usb_device_id option_ids[] = {
+#if 1 //Added by Quectel
+ { USB_DEVICE(0x05C6, 0x9090) }, /* Quectel UC15 */
+ { USB_DEVICE(0x05C6, 0x9003) }, /* Quectel UC20 */
+ { USB_DEVICE(0x2C7C, 0x0125) }, /* Quectel EC25 */
+ { USB_DEVICE(0x2C7C, 0x0121) }, /* Quectel EC21 */
+ { USB_DEVICE(0x05C6, 0x9215) }, /* Quectel EC20 */
+ { USB_DEVICE(0x2C7C, 0x0191) }, /* Quectel EG91 */
+ { USB_DEVICE(0x2C7C, 0x0195) }, /* Quectel EG95 */
+ { USB_DEVICE(0x2C7C, 0x0306) }, /* Quectel EG06/EP06/EM06 */
+ { USB_DEVICE(0x2C7C, 0x0296) }, /* Quectel BG96 */
+ { USB_DEVICE(0x2C7C, 0x0435) }, /* Quectel AG35 */
+ { USB_DEVICE(0x2C7C, 0x0512) }, /* Quectel EG12/EG18 */
+ { USB_DEVICE(0x2C7C, 0x6026) }, /* Quectel EC200 */
+ { USB_DEVICE(0x2C7C, 0x6120) }, /* Quectel UC200 */
+ { USB_DEVICE(0x2C7C, 0x6000) }, /* Quectel EC200/UC200 */
+#endif
{ USB_DEVICE(OPTION_VENDOR_ID, OPTION_PRODUCT_COLT) },
{ USB_DEVICE(OPTION_VENDOR_ID, OPTION_PRODUCT_RICOLA) },
{ USB_DEVICE(OPTION_VENDOR_ID, OPTION_PRODUCT_RICOLA_LIGHT) },
@@ -1377,6 +1393,9 @@ static struct usb_serial_driver
option_1port_device = {
#ifdef CONFIG_PM
.suspend = usb_wwan_suspend,
.resume = usb_wwan_resume,
+#if 1 //add by Quectel
+ .reset_resume = usb_wwan_resume,
+#endif
#endif
};
@@ -1421,6 +1440,27 @@ static int option_probe(struct usb_serial
*serial,
&amp;serial-&gt;interface-&gt;cur_altsetting-&gt;desc;
struct usb_device_descriptor *dev_desc =
&amp;serial-&gt;dev-&gt;descriptor;
+#if 1 //Added by Quectel
+ //Quectel UC20's interface 4 can be used as USB Network device
+ if (serial-&gt;dev-&gt;descriptor.idVendor == cpu_to_le16(0x05C6) &amp;&amp;
serial-&gt;dev-&gt;descriptor.idProduct ==
+ cpu_to_le16(0x9003) &amp;&amp;
serial-&gt;interface-&gt;cur_altsetting-&gt;desc.bInterfaceNumber &gt;= 4)
+ return -ENODEV;
+ //Quectel EC20's interface 4 can be used as USB Network device
+ if (serial-&gt;dev-&gt;descriptor.idVendor == cpu_to_le16(0x05C6) &amp;&amp;
serial-&gt;dev-&gt;descriptor.idProduct ==
+ cpu_to_le16(0x9215) &amp;&amp;
serial-&gt;interface-&gt;cur_altsetting-&gt;desc.bInterfaceNumber &gt;= 4)
+ return -ENODEV;
+ if (serial-&gt;dev-&gt;descriptor.idVendor == cpu_to_le16(0x2C7C)) {
+ __u16 idProduct =
le16_to_cpu(serial-&gt;dev-&gt;descriptor.idProduct);
+
+ //Quectel EC200&amp;UC200's interface 0 can be used as USB
Network device (ecm, rndis)
+ if
(serial-&gt;interface-&gt;cur_altsetting-&gt;desc.bInterfaceClass != 0xFF)
+ return -ENODEV;
+ //Quectel
EC25&amp;EC21&amp;EG91&amp;EG95&amp;EG06&amp;EP06&amp;EM06&amp;BG96&amp;AG35&amp;EG12&amp;EG18's interface 4 can be
used as USB network device (qmi,ecm,mbim)
+ if ((idProduct != 0x6026 &amp;&amp; idProduct != 0x6126) &amp;&amp;
serial-&gt;interface-&gt;cur_altsetting-&gt;desc.bInterfaceNumber &gt;= 4)
+ return -ENODEV;
+ }
+#endif
+
/* Never bind to the CD-Rom emulation interface */
if (iface_desc-&gt;bInterfaceClass == 0x08)
return -ENODEV;</code></pre> 
<p><strong>C、 drivers/usb/serial/qcserial.c </strong><br>  </p> 
<pre><code>--- a/drivers/usb/serial/qcserial.c
+++ b/drivers/usb/serial/qcserial.c
@@ -53,7 +53,7 @@ static const struct usb_device_id id_table[] = {
{DEVICE_G1K(0x05c6, 0x9202)}, /* Generic Gobi Modem device */
{DEVICE_G1K(0x05c6, 0x9203)}, /* Generic Gobi Modem device */
{DEVICE_G1K(0x05c6, 0x9222)}, /* Generic Gobi Modem device */
- {DEVICE_G1K(0x05c6, 0x9008)}, /* Generic Gobi QDL device */
+// {DEVICE_G1K(0x05c6, 0x9008)}, /* Generic Gobi QDL device */
{DEVICE_G1K(0x05c6, 0x9009)}, /* Generic Gobi Modem device */
{DEVICE_G1K(0x05c6, 0x9201)}, /* Generic Gobi QDL device */
{DEVICE_G1K(0x05c6, 0x9221)}, /* Generic Gobi QDL device */</code></pre> 
<p><strong>D、 drivers/usb/serial/usb_wwan.c</strong><br>  </p> 
<pre><code>--- a/drivers/usb/serial/usb_wwan.c
+++ b/drivers/usb/serial/usb_wwan.c
@@ -456,8 +456,22 @@ static struct urb *usb_wwan_setup_urb(struct
usb_serial_port *port,
/* Fill URB using supplied data. */
usb_fill_bulk_urb(urb, serial-&gt;dev,
- usb_sndbulkpipe(serial-&gt;dev, endpoint) | dir,
- buf, len, callback, ctx);
+ usb_sndbulkpipe(serial-&gt;dev, endpoint) | dir,
+ buf, len, callback, ctx);
+
+#if 1 //Added by Quectel for Zero Packet
+ if (dir == USB_DIR_OUT) {
+ struct usb_device_descriptor *desc =
&amp;serial-&gt;dev-&gt;descriptor;
+ if (desc-&gt;idVendor == cpu_to_le16(0x05C6) &amp;&amp;
desc-&gt;idProduct == cpu_to_le16(0x9090))
+ urb-&gt;transfer_flags |= URB_ZERO_PACKET;
+ if (desc-&gt;idVendor == cpu_to_le16(0x05C6) &amp;&amp;
desc-&gt;idProduct == cpu_to_le16(0x9003))
+ urb-&gt;transfer_flags |= URB_ZERO_PACKET;
+ if (desc-&gt;idVendor == cpu_to_le16(0x05C6) &amp;&amp;
desc-&gt;idProduct == cpu_to_le16(0x9215))
+ urb-&gt;transfer_flags |= URB_ZERO_PACKET;
+ if (desc-&gt;idVendor == cpu_to_le16(0x2C7C))
+ urb-&gt;transfer_flags |= URB_ZERO_PACKET;
+ }
+#endif
return urb;
}</code></pre> 
<p><strong>2、内核配置</strong></p> 
<p><strong>在终端执行 make menuconfig， 开始配置内核:</strong></p> 
<p><strong>A、 配置 ppp</strong></p> 
<pre><code>配置路径如下：
Device Drivers ---&gt; Network device support ---&gt;
PPP (point-to-point protocol) support
PPP BSD-Compress compression
PPP Deflate compression PPP filtering
PPP MPPE compression (encryption) PPP multilink support
PPP over Ethernet
PPP support for async serial ports
PPP support for sync tty ports</code></pre> 
<p><img alt="" height="205" src="https://images2.imgbox.com/78/85/A7m5Iz9v_o.png" width="818"></p> 
<p><strong>B、配置支持USBNET </strong></p> 
<pre><code>配置路径如下：
Device Drivers ---&gt; Network device support ---&gt;
USB Network Adapters ---&gt;
Multi-purpose USB Networking Framework</code></pre> 
<p><img alt="" height="103" src="https://images2.imgbox.com/90/2a/UPlEhpvP_o.png" width="833"></p> 
<p><strong>C、使能 USB 串口 GSM、CDMA 驱动</strong></p> 
<pre><code>配置路径如下：
Device Drivers ---&gt; USB support ---&gt;
USB Serial Converter support ---&gt;
USB driver for GSM and CDMA modems</code></pre> 
<p><img alt="" height="406" src="https://images2.imgbox.com/27/3c/33z0Srvk_o.png" width="833"></p> 
<p> 配置完成后，重新编译内核，然后使用新的内核启动开发板。如果配置成功开发板启动后会有如下信息打印：</p> 
<p><img alt="" height="122" src="https://images2.imgbox.com/34/14/wNHixgeN_o.png" width="652"></p> 
<h3> 三、PPP  软件包编译</h3> 
<p><strong><span style="color:#333333;">A、ppp-2.4.4.tar.gz编译</span></strong></p> 
<p><span style="color:#333333;">1、拷贝 ppp-2.4.4.tar.gz 到 </span><a href="https://bbs.elecfans.com/" rel="nofollow" title="Ubuntu">Ubuntu</a><span style="color:#333333;"> 下，然后执行下面的命令解压：</span><br><span style="color:#333333;">tar -xvf ppp-2.4.4.tar.gz</span><br><span style="color:#333333;">解压完成得到 ppp-2.4.4 目录，进入 ppp-2.4.4 目录如图 所示：</span></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/cb/f4/RRDSerOI_o.png"></p> 
<p>2、<span style="color:#333333;">使用 configure 进行配置，命令如下：</span><br><span style="color:#333333;">./configure</span><br><span style="color:#333333;">结果如图 所示：</span></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/35/3e/nfBCtZn3_o.png"></p> 
<p><br><span style="color:#333333;">配置完成后，使用下面的命令进行编译：</span><br><span style="color:#333333;">make CC=mips-linux-gnu-gcc</span><br><span style="color:#333333;">“CC=mips-linux-gnu”指定编译器，和开发板内核使用同一个编译器。</span></p> 
<p>编译完成后，分别在 chat、pppd、pppdump、pppstats 四个目录下生成 chat、pppd、pppdump、pppstats可执行文件。</p> 
<p><strong>把可执行文件全部拷贝到开发板的bin目录 下。</strong></p> 
<p><strong>B、自动ppp拨号</strong></p> 
<p><strong>使用文件为linux-ppp-scripts_v1.2.zip，解压后获取的文件如下：</strong></p> 
<p><img alt="" height="172" src="https://images2.imgbox.com/57/d9/MMiRrSGJ_o.png" width="733"></p> 
<p><strong>在开发板下新建/etc/ppp/peers目录： </strong>       </p> 
<p>拷贝 quectel-chat-connect、quectel-chat-disconnect、quectel-ppp、quectel-ppp-kill 到 /etc/ppp/peers 目录下。<br> 拷贝ip-up文到/etc/ppp目录下，<strong>请确保该文件在你的系统里有可执行权限。</strong></p> 
<p><strong>修改串口：</strong></p> 
<p>需要修改串口，修改文件 quectel-ppp 里的串口，默认文件是ttyUSB3,修改成<strong>ttyUSB2</strong>。</p> 
<p>其他文件未修改，<strong>linux-ppp-scripts_v1.2.zip文件是购买EC200T-CN模块厂家给的驱动，</strong>网上可自行下载。</p> 
<p><strong>C、拨号测试：</strong></p> 
<pre><code>启动 ppp 拨号：
quectel-pppd.sh &amp;</code></pre> 
<p>输出信息跟方案一输出一样，同样会生成/etc/ppp/resolv.conf文件，并获得IP地址：</p> 
<p><img alt="" height="306" src="https://images2.imgbox.com/18/d3/EUGBuj4a_o.png" width="682"></p> 
<p><img alt="" height="99" src="https://images2.imgbox.com/80/9a/qdhcXZFq_o.png" width="667"></p> 
<p><strong>D、挂断拨号</strong></p> 
<p>quectel-ppp-kill 用来挂断拨号的，pppd必须被正常的挂断，否则可能会导致你下次ppp拨号失败。</p> 
<p>使用下面方式来调用这个脚本</p> 
<pre><code>./quectel-ppp-kill </code></pre> 
<p><strong>注：</strong><br> 在进行拨号之前一定要确保没有默认网关，如果已经设置了其他网卡的默认网关了，则4G模块没法正常上网，需要删除原来的默认网关，现以网卡eth0为例：</p> 
<pre><code>route del default
route del -host 255.255.255.255 dev eth0</code></pre> 
<p>如果去掉默认网关，可以直接ping www.baidu.com</p> 
<h3>四、上电自启动ppp拨号上网</h3> 
<p>在/etc目录下新建ec200t.sh<br> 内容如下：</p> 
<pre><code>ls /dev/ |grep ttyUSB
if [ "$?" == "0" ]; then
        echo "4g init ..."
        cd /etc/ppp/peers/
        pppd call quectel-ppp &amp;
fi</code></pre> 
<p>修改ec200t.sh权限 </p> 
<pre><code>chmod +x ec200t.sh</code></pre> 
<p>修改/etc/init.d/rcS，增加上电就自启动ppp拨号上网:</p> 
<pre><code>./etc/ec200t.sh</code></pre> 
<h3>五、结束：</h3> 
<p>移植过程还算顺利，在测试的时候卡没有放对，插反了，在此感谢模块厂家，也感谢网友。</p> 
<p>移植所使用的文件及测试下载地址：<a href="https://download.csdn.net/download/weixin_38807927/85083947" title="君正T31EC200T-CN调试-Linux文档类资源-CSDN下载">君正T31EC200T-CN调试-Linux文档类资源-CSDN下载</a></p> 
<p>主要参考的博文：</p> 
<p><a href="https://blog.csdn.net/zhaoxd200808501/article/details/72637695/" title="Linux下EC20实现ppp拨号_Ahren.zhao的博客-CSDN博客_ppp拨号">Linux下EC20实现ppp拨号_Ahren.zhao的博客-CSDN博客_ppp拨号</a></p> 
<p><a href="https://bbs.elecfans.com/jishu_2021356_1_1.html" rel="nofollow" title="如何使用4G模块实现上网功能 - 嵌入式学习小组 - 电子技术论坛  - 广受欢迎的专业电子论坛!">如何使用4G模块实现上网功能 - 嵌入式学习小组 - 电子技术论坛 - 广受欢迎的专业电子论坛!</a></p> 
<p>如有侵权，请及时联系博主删除，VX：18750903063</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/67372f0b89113df6799fef487c707ddc/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">解决vscode上边菜单栏不显示的问题</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f8c0295a51a36f381f19252c2d1baca9/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">el-cascader获取label</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>